<?php
/**
 * Twenty Twenty-Five functions and definitions.
 *
 * @link https://developer.wordpress.org/themes/basics/theme-functions/
 *
 * @package WordPress
 * @subpackage Twenty_Twenty_Five
 * @since Twenty Twenty-Five 1.0
 */
 
 
 
// –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ REST API –¥–ª—è Elementor
add_filter( 'rest_authentication_errors', function( $result ) {
    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫ REST API Elementor, —Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
    $rest_route = $GLOBALS['wp']->query_vars['rest_route'] ?? '';
    if ( strpos( $rest_route, 'elementor/' ) !== false ) {
        // –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ Elementor, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–∞–∑—Ä–µ—à–∞–µ–º
        if ( is_user_logged_in() ) {
            return true;
        }
    }
    return $result;
}, 999 ); 
 
 
 
 
 
 // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è WooCommerce Blocks
add_action('wp_enqueue_scripts', 'add_wc_blocks_nonce');
function add_wc_blocks_nonce() {
    if (is_checkout() || is_cart() || is_product()) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º inline —Å–∫—Ä–∏–ø—Ç–∞
        if (!wp_script_is('wc-blocks-checkout', 'registered')) {
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º nonce –¥–ª—è WooBlocks
        $wc_blocks_nonce = wp_create_nonce('wc_store_api');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        wp_add_inline_script('wc-blocks-checkout', 
            'var wc_store_api_nonce = "' . esc_js($wc_blocks_nonce) . '";',
            'before'
        );
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ localization
        wp_localize_script('wc-blocks-checkout', 'wc_blocks_params', [
            'nonce' => $wc_blocks_nonce,
            'ajax_url' => admin_url('admin-ajax.php'),
            'wc_ajax_url' => WC_AJAX::get_endpoint('%%endpoint%%')
        ]);
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º nonce –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ REST API
add_filter('rest_post_dispatch', 'add_nonce_to_wc_blocks_response', 10, 3);
function add_nonce_to_wc_blocks_response($result, $server, $request) {
    if (strpos($request->get_route(), '/wc/store/') !== false) {
        $nonce = wp_create_nonce('wc_store_api');
        $result->header('Nonce', $nonce);
        $result->header('X-WC-Store-API-Nonce', $nonce);
    }
    return $result;
}
 
 
 

// Adds theme support for post formats.
if ( ! function_exists( 'twentytwentyfive_post_format_setup' ) ) :
	/**
	 * Adds theme support for post formats.
	 *
	 * @since Twenty Twenty-Five 1.0
	 *
	 * @return void
	 */
	function twentytwentyfive_post_format_setup() {
		add_theme_support( 'post-formats', array( 'aside', 'audio', 'chat', 'gallery', 'image', 'link', 'quote', 'status', 'video' ) );
	}
endif;
add_action( 'after_setup_theme', 'twentytwentyfive_post_format_setup' );

// Enqueues editor-style.css in the editors.
if ( ! function_exists( 'twentytwentyfive_editor_style' ) ) :
	/**
	 * Enqueues editor-style.css in the editors.
	 *
	 * @since Twenty Twenty-Five 1.0
	 *
	 * @return void
	 */
	function twentytwentyfive_editor_style() {
		add_editor_style( get_parent_theme_file_uri( 'assets/css/editor-style.css' ) );
	}
endif;
add_action( 'after_setup_theme', 'twentytwentyfive_editor_style' );

// Enqueues style.css on the front.
if ( ! function_exists( 'twentytwentyfive_enqueue_styles' ) ) :
	/**
	 * Enqueues style.css on the front.
	 *
	 * @since Twenty Twenty-Five 1.0
	 *
	 * @return void
	 */
	function twentytwentyfive_enqueue_styles() {
		wp_enqueue_style(
			'twentytwentyfive-style',
			get_parent_theme_file_uri( 'style.css' ),
			array(),
			wp_get_theme()->get( 'Version' )
		);
	}
endif;
add_action( 'wp_enqueue_scripts', 'twentytwentyfive_enqueue_styles' );

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
add_action('wp_head', 'ar_enqueue_profile_cover_styles');
add_action('admin_head', 'ar_enqueue_profile_cover_styles');
function ar_enqueue_profile_cover_styles() {
    ?>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        .ar-profile-cover {
            width: 100%;
            height: 300px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #ar-profile-cover-upload-modal {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        #ar-profile-cover-upload-modal[style*="display: flex"] {
            display: flex !important;
        }
        
        #ar-cover-drop-zone {
            border: 2px dashed #007cba;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        #ar-cover-drop-zone:hover {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        
        #ar-cover-drop-zone.dragover {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        
        .ar-cover-upload-progress {
            margin: 15px 0;
        }
        
        .ar-cover-progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .ar-cover-progress-fill {
            height: 100%;
            background: #007cba;
            width: 0%;
            transition: width 0.3s;
        }
        
        .ar-cover-upload-preview {
            margin: 20px 0;
            text-align: center;
        }
        
        .ar-cover-upload-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        #ar-cover-upload-error {
            color: #d32f2f;
            margin: 10px 0;
            padding: 10px;
            background: #ffebee;
            border-left: 4px solid #d32f2f;
            border-radius: 4px;
            display: none;
        }
        
        .ar-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .ar-modal.show {
            display: flex;
        }
        
        .ar-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: arModalSlideIn 0.3s ease;
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .ar-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .ar-modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .ar-modal-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .ar-modal-content::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        @keyframes arModalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ar-modal-header {
            padding: 25px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px 15px 0 0;
        }
        
        .ar-modal-header h2 {
            margin: 0;
            font-size: 22px;
            color: white;
            font-weight: 700;
        }
        
        .ar-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .ar-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .ar-modal-body {
            padding: 25px;
        }
        
        .ar-photo-upload-instructions {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #007cba;
        }
        
        .ar-photo-upload-instructions ul {
            margin: 10px 0 0 20px;
            padding: 0;
        }
        
        .ar-photo-upload-instructions li {
            margin: 5px 0;
            color: #666;
        }
        
        .ar-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .ar-btn-primary {
            background: #007cba;
            color: white;
        }
        
        .ar-btn-primary:hover:not(:disabled) {
            background: #0056b3;
        }
        
        .ar-btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .ar-btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .ar-btn-secondary:hover {
            background: #e0e0e0;
        }
    </style>
    <?php
}

// Registers custom block styles.
if ( ! function_exists( 'twentytwentyfive_block_styles' ) ) :
	/**
	 * Registers custom block styles.
	 *
	 * @since Twenty Twenty-Five 1.0
	 *
	 * @return void
	 */
	function twentytwentyfive_block_styles() {
		register_block_style(
			'core/list',
			array(
				'name'         => 'checkmark-list',
				'label'        => __( 'Checkmark', 'twentytwentyfive' ),
				'inline_style' => '
				ul.is-style-checkmark-list {
					list-style-type: "\2713";
				}

				ul.is-style-checkmark-list li {
					padding-inline-start: 1ch;
				}',
			)
		);
	}
endif;
add_action( 'init', 'twentytwentyfive_block_styles' );

// Registers pattern categories.
if ( ! function_exists( 'twentytwentyfive_pattern_categories' ) ) :
	/**
	 * Registers pattern categories.
	 *
	 * @since Twenty Twenty-Five 1.0
	 *
	 * @return void
	 */
	function twentytwentyfive_pattern_categories() {

		register_block_pattern_category(
			'twentytwentyfive_page',
			array(
				'label'       => __( 'Pages', 'twentytwentyfive' ),
				'description' => __( 'A collection of full page layouts.', 'twentytwentyfive' ),
			)
		);

		register_block_pattern_category(
			'twentytwentyfive_post-format',
			array(
				'label'       => __( 'Post formats', 'twentytwentyfive' ),
				'description' => __( 'A collection of post format patterns.', 'twentytwentyfive' ),
			)
		);
	}
endif;
add_action( 'init', 'twentytwentyfive_pattern_categories' );

// Registers block binding sources.
if ( ! function_exists( 'twentytwentyfive_register_block_bindings' ) ) :
	/**
	 * Registers the post format block binding source.
	 *
	 * @since Twenty Twenty-Five 1.0
	 *
	 * @return void
	 */
	function twentytwentyfive_register_block_bindings() {
		register_block_bindings_source(
			'twentytwentyfive/format',
			array(
				'label'              => _x( 'Post format name', 'Label for the block binding placeholder in the editor', 'twentytwentyfive' ),
				'get_value_callback' => 'twentytwentyfive_format_binding',
			)
		);
	}
endif;
add_action( 'init', 'twentytwentyfive_register_block_bindings' );

// Registers block binding callback function for the post format name.
if ( ! function_exists( 'twentytwentyfive_format_binding' ) ) :
	/**
	 * Callback function for the post format name block binding source.
	 *
	 * @since Twenty Twenty-Five 1.0
	 *
	 * @return string|void Post format name, or nothing if the format is 'standard'.
	 */
	function twentytwentyfive_format_binding() {
		$post_format_slug = get_post_format();

		if ( $post_format_slug && 'standard' !== $post_format_slug ) {
			return get_post_format_string( $post_format_slug );
		}
	}
endif;

add_action('admin_bar_menu', function ($wp_admin_bar) {
    if (!is_user_logged_in() || !current_user_can('administrator') || is_admin()) return;

    global $template;

    $template_path = wp_normalize_path($template);
    $template_name = basename($template);

    // –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    $post_type = get_post_type() ?: 'N/A';
    $content_type = is_singular() ? 'Single ' . $post_type :
                    (is_archive() ? 'Archive' :
                    (is_home() ? 'Blog Homepage' :
                    (is_search() ? 'Search' : 'Other')));

    // WooCommerce —à–∞–±–ª–æ–Ω
    $woo_template = '';
    if (function_exists('wc_get_template_loader')) {
        $loader = wc_get_template_loader();
        if (method_exists($loader, 'get_template_file')) {
            $woo_template_file = $loader->get_template_file();
            if ($woo_template_file) {
                $woo_template = wp_normalize_path($woo_template_file);
            }
        }
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML
    $label = '<div style="color: black; font-weight: 600;">üß© ' . esc_html($template_path) . '</div>';
    $label .= '<div style="color: black; font-size: 11px;">üì¶ ' . esc_html($content_type) . '</div>';
    if ($woo_template) {
        $label .= '<div style="color: black; font-size: 11px;">üõí ' . esc_html($woo_template) . '</div>';
    }

    // –í—ã–≤–æ–¥–∏–º –≤ –∞–¥–º–∏–Ω–±–∞—Ä
    $wp_admin_bar->add_node([
        'id'    => 'template_info',
        'title' => $label,
        'meta'  => ['class' => 'template-info-node']
    ]);
}, 100);

// ===== –°–ò–°–¢–ï–ú–ê –û–¶–ï–ù–ò–í–ê–ù–ò–Ø –î–ò–ó–ê–ô–ù–ï–†–û–í =====

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ü–µ–Ω–∫—É –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
 */
function ar_save_designer_rating() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_designer_rating_nonce')) {
        wp_send_json_error(['message' => '–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏']);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
    if (!isset($_POST['designer_id']) || !isset($_POST['rating'])) {
        wp_send_json_error(['message' => '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ']);
    }
    
    $designer_id = intval($_POST['designer_id']);
    $rating = floatval($_POST['rating']);
    $client_id = get_current_user_id();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ (1-5 –∑–≤—ë–∑–¥)
    if ($rating < 1 || $rating > 5) {
        wp_send_json_error(['message' => '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5']);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∏–∑–∞–π–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    $designer = get_user_by('ID', $designer_id);
    if (!$designer) {
        wp_send_json_error(['message' => '–î–∏–∑–∞–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω']);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ü–µ–Ω–∫–∏
    $ratings = get_user_meta($designer_id, 'ar_designer_ratings', true);
    if (!is_array($ratings)) {
        $ratings = [];
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞–ª –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –∫–ª–∏–µ–Ω—Ç —ç—Ç–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $client_key = 'client_' . $client_id;
    
    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –æ—Ü–µ–Ω–∫–∞ –æ—Ç —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
    if (isset($ratings[$client_key])) {
        $ratings[$client_key]['rating'] = $rating;
        $ratings[$client_key]['timestamp'] = current_time('mysql');
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –æ—Ü–µ–Ω–∫—É
        $ratings[$client_key] = [
            'rating' => $rating,
            'timestamp' => current_time('mysql'),
            'client_name' => wp_get_current_user()->display_name
        ];
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏
    update_user_meta($designer_id, 'ar_designer_ratings', $ratings);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥
    $average_rating = ar_calculate_average_rating($designer_id);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞ –ø–æ–ª–µ —Å —Å—Ä–µ–¥–Ω–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    update_user_meta($designer_id, 'ar_designer_rating', $average_rating);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    wp_send_json_success([
        'message' => '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!',
        'average_rating' => $average_rating,
        'total_reviews' => count($ratings)
    ]);
}
add_action('wp_ajax_ar_save_designer_rating', 'ar_save_designer_rating');
add_action('wp_ajax_nopriv_ar_save_designer_rating', 'ar_save_designer_rating');

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏–∑ –≤—Å–µ—Ö –æ—Ü–µ–Ω–æ–∫
 */
function ar_calculate_average_rating($designer_id) {
    $ratings = get_user_meta($designer_id, 'ar_designer_ratings', true);
    
    if (!is_array($ratings) || empty($ratings)) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ ar_designer_rating
        return get_user_meta($designer_id, 'ar_designer_rating', true) ?: '5.0';
    }
    
    $sum = 0;
    $count = 0;
    
    foreach ($ratings as $rating_data) {
        if (isset($rating_data['rating'])) {
            $sum += floatval($rating_data['rating']);
            $count++;
        }
    }
    
    if ($count === 0) {
        return '5.0';
    }
    
    return number_format($sum / $count, 1);
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
 */
function ar_get_designer_reviews_count($designer_id) {
    $ratings = get_user_meta($designer_id, 'ar_designer_ratings', true);
    
    if (!is_array($ratings)) {
        return 0;
    }
    
    return count($ratings);
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –æ—Ü–µ–Ω–∫—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
 */
function ar_get_client_designer_rating($designer_id, $client_id = null) {
    if ($client_id === null) {
        $client_id = get_current_user_id();
    }
    
    if (!$client_id) {
        return null;
    }
    
    $ratings = get_user_meta($designer_id, 'ar_designer_ratings', true);
    
    if (!is_array($ratings)) {
        return null;
    }
    
    $client_key = 'client_' . $client_id;
    
    if (isset($ratings[$client_key])) {
        return floatval($ratings[$client_key]['rating']);
    }
    
    return null;
}

// ===== –ö–û–ù–ï–¶ –°–ò–°–¢–ï–ú–´ –û–¶–ï–ù–ò–í–ê–ù–ò–Ø =====

// JavaScript –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤
add_action('wp_footer', function() {
    if (!function_exists('wp_create_nonce')) return;
    $nonce = wp_create_nonce('ar_designer_rating_nonce');
    ?>
    <script>
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–Ω–∏–µ –∑–≤—ë–∑–¥ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    function arHighlightStars(starElement) {
        const rating = parseInt(starElement.getAttribute('data-rating'));
        const container = starElement.parentElement;
        const allStars = container.querySelectorAll('.ar-star-rating');
        
        allStars.forEach((star, index) => {
            if (index < rating) {
                star.style.color = '#ffc107';
                star.style.transform = 'scale(1.2)';
            } else {
                star.style.color = '#ddd';
                star.style.transform = 'scale(1)';
            }
        });
    }
    
    // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–Ω–∏—è –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∫–∏
    function arResetStarHover(container) {
        const allStars = container.querySelectorAll('.ar-star-rating');
        const designerId = container.getAttribute('data-designer-id');
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        const ratingText = container.parentElement.querySelector('.ar-rating-value').textContent;
        const currentRating = parseFloat(ratingText);
        const filledStars = Math.ceil(currentRating);
        
        allStars.forEach((star, index) => {
            if (index < filledStars) {
                star.style.color = '#ffc107';
            } else {
                star.style.color = '#ddd';
            }
            star.style.transform = 'scale(1)';
        });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function arSubmitDesignerRating(designerId, rating, starElement) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (!document.body.classList.contains('logged-in')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É');
            return;
        }
        
        const formData = new FormData();
        formData.append('action', 'ar_save_designer_rating');
        formData.append('designer_id', designerId);
        formData.append('rating', rating);
        formData.append('nonce', '<?php echo $nonce; ?>');
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
                const container = starElement.parentElement;
                const ratingValueEl = container.parentElement.querySelector('.ar-rating-value');
                const ratingCountEl = container.parentElement.querySelector('.ar-rating-count');
                
                ratingValueEl.textContent = data.data.average_rating;
                ratingCountEl.textContent = '(' + data.data.total_reviews + ' –æ—Ü–µ–Ω–æ–∫)';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥
                const newRating = parseFloat(data.data.average_rating);
                const filledStars = Math.ceil(newRating);
                const allStars = container.querySelectorAll('.ar-star-rating');
                
                allStars.forEach((star, index) => {
                    if (index < filledStars) {
                        star.style.color = '#ffc107';
                    } else {
                        star.style.color = '#ddd';
                    }
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                console.log(data.data.message);
            } else {
                console.error(data.data.message);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ' + (data.data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        });
    }
    </script>
    <?php
}, 9); // Priority 9, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è —Ä–∞–Ω—å—à–µ –¥—Ä—É–≥–∏—Ö wp_footer

add_action('wp_footer', function () {
    if (!is_user_logged_in() || !current_user_can('administrator')) return;

    if (function_exists('wc_get_template_loader')) {
        $template = wc_get_template_loader()->get_template_file();
        if ($template) {
            echo "<script>console.log('üõí Woo template: " . esc_js($template) . "');</script>";
        }
    }
});



// –î–æ–±–∞–≤—å—Ç–µ –≤ functions.php –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–∞–º—è—Ç–∏
add_action('wp_footer', 'show_memory_usage');
add_action('admin_footer', 'show_memory_usage');

function show_memory_usage() {
    if (current_user_can('manage_options')) {
        $memory_usage = memory_get_usage(true) / 1024 / 1024;
        $memory_limit = ini_get('memory_limit');
        $memory_peak = memory_get_peak_usage(true) / 1024 / 1024;
        
        echo '<div style="background:#f0f0f0;padding:10px;margin:10px;border:1px solid #ccc;">';
        echo '<strong>Memory Info:</strong><br>';
        echo 'Current: ' . round($memory_usage, 2) . ' MB<br>';
        echo 'Peak: ' . round($memory_peak, 2) . ' MB<br>';
        echo 'Limit: ' . $memory_limit . '<br>';
        echo '</div>';
    }
}

/**
 * –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–≤–∞—Ä —Ç–æ–ª—å–∫–æ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ 1
 * - —É–±–∏—Ä–∞–µ–º –ø–æ–ª–µ qty
 * - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏–º quantity = 1
 */
function artrocket_remove_qty_fields( $return, $product ) {
    return true; // —É–±–∏—Ä–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
}
add_filter( 'woocommerce_is_sold_individually', 'artrocket_remove_qty_fields', 10, 2 );

/**
 * –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É –≤—Å–µ–≥–¥–∞ —Å—Ç–∞–≤–∏–º qty = 1
 */
function artrocket_force_qty_one( $cart_item_data, $product_id ) {
    $cart_item_data['quantity'] = 1;
    return $cart_item_data;
}
add_filter( 'woocommerce_add_cart_item_data', 'artrocket_force_qty_one', 10, 2 );

/**
 * –ï—Å–ª–∏ —é–∑–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ —Ç–æ–≤–∞—Ä —Å–Ω–æ–≤–∞ ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º qty = 1, –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
 */
function artrocket_update_cart_qty_one( $cart_item_data, $product_id ) {
    foreach ( WC()->cart->get_cart() as $cart_item_key => $values ) {
        if ( $values['product_id'] == $product_id ) {
            WC()->cart->set_quantity( $cart_item_key, 1 ); // —Ñ–∏–∫—Å–∏—Ä—É–µ–º 1
            return $cart_item_data;
        }
    }
    return $cart_item_data;
}
add_filter( 'woocommerce_add_cart_item_data', 'artrocket_update_cart_qty_one', 20, 2 );




function arrocket_account_or_google() {
    if ( is_user_logged_in() ) {
        return '<a href="' . esc_url( wc_get_account_endpoint_url( "dashboard" ) ) . '" class="nav-btn"><i class="bi bi-person-circle"></i> Contul meu</a>';
    } else {
        return do_shortcode('[nextend_social_login provider="google" redirect="https://art-rocket.ru/my-account/"]');
    }
}
add_shortcode('account_or_google', 'arrocket_account_or_google');



add_action('wp_enqueue_scripts', 'artrocket_enqueue_cart_style');
function artrocket_enqueue_cart_style() {
    if (is_cart()) {
        $style_path = get_stylesheet_directory() . '/css/cart-style.css';
        $version = file_exists($style_path) ? filemtime($style_path) : '1.0';
        wp_enqueue_style(
            'artrocket-cart-style',
            get_stylesheet_directory_uri() . '/css/cart-style.css',
            [],
            $version,
            'all'
        );
    }
}

add_filter( 'woocommerce_enqueue_block_styles', '__return_false' );


add_action('wp_enqueue_scripts', function () {
    if (function_exists('is_checkout') && is_checkout()) {
        $style_path = get_template_directory() . '/css/checkout-style.css';
        $version = file_exists($style_path) ? filemtime($style_path) : '1.0';
        wp_enqueue_style(
            'artrocket-checkout-style',
            get_template_directory_uri() . '/css/checkout-style.css',
            [],
            $version
        );
    }
}, 99);




add_action('wp_footer', 'add_custom_terms_checkbox_to_checkout');
function add_custom_terms_checkbox_to_checkout() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    if (!is_checkout() || is_wc_endpoint_url()) return;

    ?>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form.wc-block-checkout__form");

        if (!form) return;

        const termsContainer = document.querySelector(".wc-block-checkout__terms");
        if (termsContainer && !document.getElementById("custom-terms-checkbox")) {
            const checkboxWrapper = document.createElement("div");
            checkboxWrapper.style.marginTop = "20px";
            checkboxWrapper.innerHTML = `
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="custom-terms-checkbox" style="transform: scale(1.3);" />
                    <span>–Ø –ø—Ä–∏–Ω–∏–º–∞—é <a href="/terms-and-conditions" target="_blank">–ü—Ä–∞–≤–∏–ª–∞ –∏ —É—Å–ª–æ–≤–∏—è</a> *</span>
                </label>
            `;
            termsContainer.appendChild(checkboxWrapper);
        }

        form.addEventListener("submit", function (e) {
            const checkbox = document.getElementById("custom-terms-checkbox");
            if (checkbox && !checkbox.checked) {
                e.preventDefault();
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏.");
            }
        });
    });
    </script>
    <?php
}






add_action('wp_enqueue_scripts', function() {
    wp_enqueue_script(
        'animejs',
        'https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js',
        [],
        '3.2.1',
        true
    );
});








// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è WooCommerce Blocks
add_action('wp_enqueue_scripts', 'init_wc_blocks_checkout_data', 99);
function init_wc_blocks_checkout_data() {
    if (!is_checkout()) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ WooCommerce
    if (!function_exists('WC') || !WC()->customer) {
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $customer = WC()->customer;
    
    // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —á–µ–∫–∞—É—Ç–∞
    $checkout_data = [
        'billingAddress' => [
            'first_name' => $customer->get_billing_first_name(),
            'last_name' => $customer->get_billing_last_name(),
            'company' => $customer->get_billing_company(),
            'address_1' => $customer->get_billing_address_1(),
            'address_2' => $customer->get_billing_address_2(),
            'city' => $customer->get_billing_city(),
            'state' => $customer->get_billing_state(),
            'postcode' => $customer->get_billing_postcode(),
            'country' => $customer->get_billing_country(),
            'email' => $customer->get_billing_email(),
            'phone' => $customer->get_billing_phone(),
        ],
        'shippingAddress' => [
            'first_name' => $customer->get_shipping_first_name(),
            'last_name' => $customer->get_shipping_last_name(),
            'company' => $customer->get_shipping_company(),
            'address_1' => $customer->get_shipping_address_1(),
            'address_2' => $customer->get_shipping_address_2(),
            'city' => $customer->get_shipping_city(),
            'state' => $customer->get_shipping_state(),
            'postcode' => $customer->get_shipping_postcode(),
            'country' => $customer->get_shipping_country(),
        ],
        'orderNotes' => '',
        'createAccount' => false,
        'paymentMethod' => '',
        'extensions' => new stdClass(),
    ];
    
    // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è JavaScript - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
    if (wp_script_is('wc-blocks-checkout', 'registered')) {
        wp_localize_script('wc-blocks-checkout', 'wc_checkout_params', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'wc_ajax_url' => WC_AJAX::get_endpoint('%%endpoint%%'),
            'checkout_url' => wc_get_checkout_url(),
            'checkout_data' => $checkout_data,
            'nonce' => wp_create_nonce('wc_store_api'),
            'country_locale' => WC()->countries->get_country_locale(),
            'countries' => WC()->countries->get_countries(),
            'states' => WC()->countries->get_states(),
        ]);
    }
}

// –ü–∞—Ç—á –¥–ª—è WooCommerce Blocks - –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
add_filter('woocommerce_blocks_checkout_update_order_review', 'fix_checkout_data', 10, 2);
function fix_checkout_data($result, $data) {
    error_log('Checkout data received: ' . print_r($data, true));
    
    // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    array_walk_recursive($data, function(&$value) {
        if (is_string($value)) {
            // –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã JSON
            $value = preg_replace('/[\x00-\x1F\x7F-\x9F]/u', '', $value);
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏
            $value = str_replace('\\', '\\\\', $value);
        }
    });
    
    return $data;
}










/* ========== –ü–£–¢–ò ========== */
if ( ! defined('AR_LICENSE_PRIVATE_KEY_PATH') ) {
    define('AR_LICENSE_PRIVATE_KEY_PATH', WP_CONTENT_DIR . '/uploads/license/private.pem');
}
if ( ! defined('AR_LICENSE_UPLOAD_SUBDIR') ) {
    define('AR_LICENSE_UPLOAD_SUBDIR', 'licenses');
}

/* ========== –£–¢–ò–õ–ò–¢–´ ========== */
function ar_log($m){ error_log('[AR_LICENSE] '.$m); }
function ar_openssl_log_errors($prefix='OpenSSL'){ while($e=openssl_error_string()){ error_log("[$prefix] $e"); } }

function ar_get_private_key() {
    if (!function_exists('openssl_sign')) {
        ar_log('‚ùå OpenSSL –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        return false;
    }
    $pem = @file_get_contents(AR_LICENSE_PRIVATE_KEY_PATH);
    if (!$pem){
        ar_log('‚ùå –ù–µ —á–∏—Ç–∞–µ—Ç—Å—è private.pem: '.AR_LICENSE_PRIVATE_KEY_PATH);
        return false;
    }
    $key = @openssl_pkey_get_private($pem);
    if (!$key){
        ar_log('‚ùå openssl_pkey_get_private = false');
        ar_openssl_log_errors('get_private');
        return false;
    }
    return $key;
}

/* ========== –ì–ï–ù–ï–†–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò ========== */
function ar_generate_license_json($name, $email, $reg_code, $expires, $pool = 1) {
    $key = ar_get_private_key();
    if (!$key) return false;

    // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Äî –≤—Å–µ–≥–¥–∞ –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è (23:59:59)
    $expiry_ts   = strtotime($expires . ' 23:59:59');
    $expiry_full = date('Y-m-d H:i:s.uO', $expiry_ts); // —Ñ–æ—Ä–º–∞—Ç "2025-09-03 23:59:59.000000+0000"

    $payload = [
        'name'        => $name,
        'email'       => $email,
        'registration_code' => $reg_code,
        'issued_at'   => gmdate('c'),
        'expires'     => $expires,       // –∫–æ—Ä–æ—Ç–∫–∞—è –¥–∞—Ç–∞
        'expiry_date'  => $expiry_full,   // –ø–æ–ª–Ω–∞—è –¥–∞—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ –∑–æ–Ω–æ–π
        'pool'        => (int)$pool
    ];

    $data_json = json_encode($payload, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
    if (!$data_json) {
        ar_log('‚ùå JSON encoding failed');
        return false;
    }

    $sig = '';
    $ok = @openssl_sign($data_json, $sig, $key, OPENSSL_ALGO_SHA256);
    @openssl_free_key($key);

    if (!$ok || !$sig) {
        ar_log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é');
        ar_openssl_log_errors('openssl_sign');
        return false;
    }

    return json_encode([
        'data'       => base64_encode($data_json),
        'signature'  => base64_encode($sig),
        'pool'       => (string)(int)$pool,   // –¥—É–±–ª–∏—Ä—É–µ–º —Å–Ω–∞—Ä—É–∂–∏, –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª
        'expiry_date' => $expiry_full          // –¥—É–±–ª–∏—Ä—É–µ–º –∏ —Å–Ω–∞—Ä—É–∂–∏
    ], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
}




/* ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò –í –§–ê–ô–õ ========== */
function ar_save_license_file($order_id, $license_json) {
    $upload = wp_upload_dir();
    if (!empty($upload['error'])) { ar_log('‚ùå wp_upload_dir: '.$upload['error']); return false; }

    $dir = trailingslashit($upload['basedir']).AR_LICENSE_UPLOAD_SUBDIR;
    $url = trailingslashit($upload['baseurl']).AR_LICENSE_UPLOAD_SUBDIR;
    if (!file_exists($dir)) {
        wp_mkdir_p($dir);
        @file_put_contents("$dir/index.php","<?php // Silence is golden");
    }

    $hash = wp_hash($order_id.'|'.microtime(true).'|'.mt_rand());
    $filename = "license_{$order_id}_{$hash}.lic";
    $abs = "$dir/$filename";
    $u   = "$url/$filename";

    if (@file_put_contents($abs, $license_json) === false) { ar_log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª: $abs"); return false; }
    @chmod($abs, 0640);

    return [$abs,$u,$filename];
}

/* ========== –í–´–î–ê–ß–ê –õ–ò–¶–ï–ù–ó–ò–ò –ü–†–ò COMPLETED ========== */
add_action('woocommerce_order_status_completed', function($order_id){
    $order = wc_get_order($order_id); 
    if ( ! $order ) return;
    
    
    
    
    
    
    
    
    
    
    
    
    // ==== –ü–†–û–î–õ–ï–ù–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò (–µ—Å–ª–∏ –∑–∞–∫–∞–∑ - renewal) ====
    $renew_for_reg = $order->get_meta('_renew_reg_code');
    if ( $renew_for_reg ) {
        // 1) –Ω–∞–π–¥—ë–º –∏—Å—Ö–æ–¥–Ω—ã–π order –ø–æ reg-–∫–æ–¥—É
        global $wpdb;
        $orig_order_id = $wpdb->get_var( $wpdb->prepare(
            "SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key = '_license_reg_code' AND meta_value = %s LIMIT 1",
            $renew_for_reg
        ) );

        if ( $orig_order_id ) {
            // 2) –≤—ã—á–∏—Å–ª–∏–º –Ω–æ–≤—É—é –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
            //    —Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ —É —Ç–µ–±—è –ø—Ä–∏ –≤—ã–¥–∞—á–µ: –ø–æ product/variation id
            $add_interval = '+1 year'; // –¥–µ—Ñ–æ–ª—Ç
            $maybe_new_pool = null;    // –µ—Å–ª–∏ —Ç–∞—Ä–∏—Ñ –∑–∞–¥–∞—ë—Ç –Ω–æ–≤—ã–π pool (–≤–∞—Ä–∏–∞—Ü–∏—è pa_devices)

            foreach ( $order->get_items() as $item ) {
                $product_id   = $item->get_product_id();
                $variation_id = $item->get_variation_id();
                $target_id    = $variation_id ?: $product_id;

                switch ($target_id) {
                    case 2385: $add_interval = '+30 days';  break; // trial (–Ω–∞ –≤—Å—è–∫–∏–π)
                    case 1634: $add_interval = '+2 months'; break;
                    case 1633: $add_interval = '+6 months'; break;
                    case 1629: $add_interval = '+1 year';   break;
                }

                // –ï—Å–ª–∏ –≤–∞—Ä–∏–∞—Ü–∏—è –Ω–µ—Å—ë—Ç –∞—Ç—Ä–∏–±—É—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚Äî –ø–æ–∑–≤–æ–ª—è–µ–º –∞–ø–≥—Ä–µ–π–¥ –ø—É–ª–∞
                if ( $variation_id ) {
                    $p = wc_get_product($variation_id);
                    if ( $p ) {
                        $device_attr = $p->get_attribute('pa_devices');
                        if ( $device_attr && is_numeric($device_attr) ) {
                            $maybe_new_pool = (int) $device_attr;
                        } elseif ( preg_match('/\d+/', $p->get_name(), $m) ) {
                            $maybe_new_pool = (int) $m[0];
                        }
                    }
                }
            }

            // 3) –±–µ—Ä—ë–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–π –ª–∏—Ü–µ–Ω–∑–∏–∏
            $current_expires = get_post_meta($orig_order_id, '_license_expires', true);
            $base_ts = $current_expires ? strtotime($current_expires.' 23:59:59') : time();
            // –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º ¬´—Å –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ä–æ–∫–∞¬ª (–∏–ª–∏ —Å —Å–µ–≥–æ–¥–Ω—è, –µ—Å–ª–∏ —É–∂–µ –∏—Å—Ç—ë–∫)
            $today_ts = time();
            if ( $base_ts < $today_ts ) $base_ts = $today_ts;
            $new_expires = date('Y-m-d', strtotime($add_interval, $base_ts));

            // 4) –µ—Å–ª–∏ –∞–ø–≥—Ä–µ–π–¥ –ø—É–ª–∞ ‚Äî –≤–æ–∑—å–º—ë–º –º–∞–∫—Å–∏–º—É–º –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ
            $json = get_post_meta($orig_order_id,'_license_key_json',true);
            $pool_current = 1;
            if ( $json ) {
                $dec = json_decode($json, true);
                if ( isset($dec['pool']) ) $pool_current = (int)$dec['pool'];
            }
            $final_pool = $pool_current;
            if ( $maybe_new_pool && $maybe_new_pool > $pool_current ) {
                $final_pool = $maybe_new_pool;
            }

            // 5) –ø–µ—Ä–µ—Å–æ–±–µ—Ä—ë–º –ª–∏—Ü–µ–Ω–∑–∏—é –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
            $regen = ar_regenerate_and_save_license_for_order($orig_order_id, $new_expires, $final_pool, true);
            if ( is_wp_error($regen) ) {
                ar_log('‚ùå Renewal failed for reg '.$renew_for_reg.': '.$regen->get_error_message());
            } else {
                ar_log('‚úÖ Renewal OK for reg '.$renew_for_reg.' (order #'.$orig_order_id.') => '.$new_expires.' / pool='.$final_pool);
            }
        } else {
            ar_log('‚ùå Renewal: original order by reg not found: '.$renew_for_reg);
        }

        // –î–ª—è –∑–∞–∫–∞–∑–æ–≤-–ø—Ä–æ–¥–ª–µ–Ω–∏–π –Ω–æ–≤—É—é –ª–∏—Ü–µ–Ω–∑–∏—é –ù–ï –≤—ã–¥–∞—ë–º
        return;
    }
    
    
    
    
    
    
    

    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—è ‚Äî –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
    if ( get_post_meta($order_id, '_license_reg_code', true) ) return;

    $name     = $order->get_formatted_billing_full_name();
    $email    = $order->get_billing_email();
    $reg_code = wp_generate_uuid4();
    $expires  = date('Y-m-d', strtotime('+1 year')); // –¥–µ—Ñ–æ–ª—Ç

    // === –û–ø—Ä–µ–¥–µ–ª—è–µ–º pool (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤) ===
    $pool = 1; // –¥–µ—Ñ–æ–ª—Ç

    foreach ( $order->get_items() as $item ) {
        $product_id   = $item->get_product_id();       // ID —Ç–æ–≤–∞—Ä–∞
        $variation_id = $item->get_variation_id();     // ID –≤–∞—Ä–∏–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        $target_id    = $variation_id ?: $product_id;  // —á—Ç–æ-—Ç–æ –æ–¥–Ω–æ

        // === —Å—Ä–æ–∫ –ª–∏—Ü–µ–Ω–∑–∏–∏ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É ===
        switch ($target_id) {
            case 2385: // Trial License
                $expires = date('Y-m-d', strtotime('+30 days'));
                break;
            case 1634: // 3 –ú–µ—Å—è—á–Ω–∞—è
                $expires = date('Y-m-d', strtotime('+2 month'));
                break;
            case 1633: // 6 –º–µ—Å—è—Ü–µ–≤
                $expires = date('Y-m-d', strtotime('+6 months'));
                break;
            case 1629: // –ì–æ–¥–æ–≤–∞—è
                $expires = date('Y-m-d', strtotime('+1 year'));
                break;
        }

        // === pool (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞) ===
        if ( $variation_id ) {
            $product = wc_get_product($variation_id);

            if ( $product ) {
                $device_attr = $product->get_attribute('pa_devices');
                if ( $device_attr && is_numeric($device_attr) ) {
                    $pool = (int) $device_attr;
                } elseif ( preg_match('/\d+/', $product->get_name(), $m) ) {
                    $pool = (int) $m[0];
                }
            }
        } else {
            $pool = (int) $item->get_quantity();
        }
    }

    // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON –ª–∏—Ü–µ–Ω–∑–∏–∏ ===
    $license_json = ar_generate_license_json($name, $email, $reg_code, $expires, $pool);
    if ( ! $license_json ) {
        ar_log("‚ùå –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å –¥–ª—è #$order_id");
        return;
    }

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞ ===
    update_post_meta($order_id, '_license_reg_code', $reg_code);
    update_post_meta($order_id, '_license_key_json', $license_json);
    update_post_meta($order_id, '_license_expires', $expires);

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª ===
    $file = ar_save_license_file($order_id, $license_json);
    if ( $file ) {
        list($abs, $url, $fn) = $file;
        update_post_meta($order_id, '_license_file_path', $abs);
        update_post_meta($order_id, '_license_file_url', $url);
        update_post_meta($order_id, '_license_file_name', $fn);
    }
});









/* ========================= SAFETY HELPERS (–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è) ========================= */
if ( ! function_exists('ar_parse_license_json') ) {
    function ar_parse_license_json($license_json){
        $out = json_decode($license_json, true);
        if (!is_array($out) || empty($out['data'])) return false;
        $inner = json_decode(base64_decode($out['data'], true), true);
        if (!is_array($inner)) return false;
        return ['outer'=>$out, 'inner'=>$inner];
    }
}
if ( ! function_exists('ar_generate_license_json_with_issued') ) {
    function ar_generate_license_json_with_issued($name, $email, $reg_code, $expires, $pool = 1, $issued_at = null) {
        $key = ar_get_private_key();
        if (!$key) return false;

        $expiry_ts   = strtotime($expires . ' 23:59:59');
        $expiry_full = date('Y-m-d H:i:s.uO', $expiry_ts);

        $payload = [
            'name'              => $name,
            'email'             => $email,
            'registration_code' => $reg_code,
            'issued_at'         => $issued_at ? $issued_at : gmdate('c'),
            'expires'           => $expires,
            'expiry_date'       => $expiry_full,
            'pool'              => (int)$pool,
        ];

        $data_json = json_encode($payload, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
        if (!$data_json) return false;

        $sig = '';
        $ok = @openssl_sign($data_json, $sig, $key, OPENSSL_ALGO_SHA256);
        @openssl_free_key($key);
        if (!$ok || !$sig) { ar_openssl_log_errors('openssl_sign(admin_regen)'); return false; }

        return json_encode([
            'data'        => base64_encode($data_json),
            'signature'   => base64_encode($sig),
            'pool'        => (string)(int)$pool,
            'expiry_date' => $expiry_full
        ], JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
    }
}
if ( ! function_exists('ar_regenerate_and_save_license_for_order') ) {
    function ar_regenerate_and_save_license_for_order($order_id, $new_expires, $new_pool, $preserve_issued = true){
        $order = wc_get_order($order_id);
        if (!$order) return new WP_Error('no_order','Order not found');

        $license_json = get_post_meta($order_id,'_license_key_json',true);
        $reg_code     = get_post_meta($order_id,'_license_reg_code',true);
        if (!$license_json || !$reg_code) return new WP_Error('no_license','License not found');

        $parsed = ar_parse_license_json($license_json);
        if (!$parsed) return new WP_Error('bad_license','License JSON invalid');

        $inner  = $parsed['inner'];
        $name   = !empty($inner['name'])  ? $inner['name']  : $order->get_formatted_billing_full_name();
        $email  = !empty($inner['email']) ? $inner['email'] : $order->get_billing_email();
        $issued = $preserve_issued && !empty($inner['issued_at']) ? $inner['issued_at'] : null;

        $new_pool = max(1, (int)$new_pool);
        if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $new_expires)) {
            return new WP_Error('bad_date','Invalid date format, expected YYYY-MM-DD');
        }

        $new_json = ar_generate_license_json_with_issued($name, $email, $reg_code, $new_expires, $new_pool, $issued);
        if (!$new_json) return new WP_Error('regen_fail','Failed to regenerate license');

        update_post_meta($order_id, '_license_key_json', $new_json);
        update_post_meta($order_id, '_license_expires',  $new_expires);

        $old_path = get_post_meta($order_id, '_license_file_path', true);
        $file = ar_save_license_file($order_id, $new_json);
        if ($file) {
            list($abs, $url, $fn) = $file;
            update_post_meta($order_id, '_license_file_path', $abs);
            update_post_meta($order_id, '_license_file_url',  $url);
            update_post_meta($order_id, '_license_file_name', $fn);
            if ($old_path && file_exists($old_path)) { @unlink($old_path); }
        }
        return true;
    }
}

/* ========================= –í–´–î–ê–ß–ê / –ü–†–û–î–õ–ï–ù–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò ========================= */
add_action('woocommerce_order_status_completed', function($order_id){
    $order = wc_get_order($order_id);
    if ( ! $order ) return;

    // ==== –ü–†–û–î–õ–ï–ù–ò–ï (–µ—Å–ª–∏ –∑–∞–∫–∞–∑ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ renewal) ====
    $renew_for_reg = $order->get_meta('_renew_reg_code');
    if ( $renew_for_reg ) {

        // –Ω–∞–π—Ç–∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–∫–∞–∑ –ø–æ reg (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å HPOS)
        $orig_orders = wc_get_orders([
            'limit'      => 1,
            'return'     => 'objects',
            'meta_query' => [
                [
                    'key'   => '_license_reg_code',
                    'value' => $renew_for_reg,
                ],
            ],
            'orderby'    => 'date',
            'order'      => 'ASC',
            'status'     => array_keys( wc_get_order_statuses() ),
        ]);
        $orig = !empty($orig_orders) ? $orig_orders[0] : null;
        if ( $orig instanceof WC_Order ) {
            $orig_order_id = $orig->get_id();

            // –∏–Ω—Ç–µ—Ä–≤–∞–ª + –≤–æ–∑–º–æ–∂–Ω—ã–π –∞–ø–≥—Ä–µ–π–¥ pool, –∞ —Ç–∞–∫–∂–µ —Ç–µ–∫—É—â–∏–π "–ø–ª–∞–Ω"
            $add_interval   = '+1 year';
            $maybe_new_pool = null;
            $plan_title     = null;
            $plan_pid       = null;

            foreach ( $order->get_items() as $item ) {
                $product_id   = $item->get_product_id();
                $variation_id = $item->get_variation_id();
                $target_id    = $variation_id ?: $product_id;

                switch ($target_id) {
                    case 2385: $add_interval = '+30 days';  break;
                    case 1634: $add_interval = '+2 months'; break;
                    case 1633: $add_interval = '+6 months'; break;
                    case 1629: $add_interval = '+1 year';   break;
                }

                $p = $variation_id ? wc_get_product($variation_id) : wc_get_product($product_id);
                if ( $p ) {
                    $plan_title = $p->is_type('variation') ? get_the_title($p->get_parent_id()) : $p->get_name();
                    $plan_title = wp_strip_all_tags($plan_title);
                    $plan_pid   = $p->is_type('variation') ? $p->get_parent_id() : $p->get_id();
                }

                if ( $variation_id && $p ) {
                    $device_attr = $p->get_attribute('pa_devices');
                    if ( $device_attr && is_numeric($device_attr) ) {
                        $maybe_new_pool = (int) $device_attr;
                    } elseif ( preg_match('/\d+/', $p->get_name(), $m) ) {
                        $maybe_new_pool = (int) $m[0];
                    }
                }
            }

            // –±–∞–∑–æ–≤–∞—è –¥–∞—Ç–∞ ‚Äî –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–≥–æ —Å—Ä–æ–∫–∞, –Ω–æ –Ω–µ —Ä–∞–Ω—å—à–µ —Å–µ–≥–æ–¥–Ω—è
            $current_expires = get_post_meta($orig_order_id, '_license_expires', true);
            $base_ts = $current_expires ? strtotime($current_expires.' 23:59:59') : time();
            $today_ts = time();
            if ( $base_ts < $today_ts ) $base_ts = $today_ts;
            $new_expires = date('Y-m-d', strtotime($add_interval, $base_ts));

            // –∏—Ç–æ–≥–æ–≤—ã–π pool
            $json = get_post_meta($orig_order_id,'_license_key_json',true);
            $pool_current = 1;
            if ( $json ) {
                $dec = json_decode($json, true);
                if ( isset($dec['pool']) ) $pool_current = (int)$dec['pool'];
            }
            $final_pool = ($maybe_new_pool && $maybe_new_pool > $pool_current) ? $maybe_new_pool : $pool_current;

            // –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
            $regen = ar_regenerate_and_save_license_for_order($orig_order_id, $new_expires, $final_pool, true);
            if ( is_wp_error($regen) ) {
                ar_log('‚ùå Renewal failed for reg '.$renew_for_reg.': '.$regen->get_error_message());
            } else {
                if ( $plan_title ) update_post_meta($orig_order_id, '_license_plan_title', $plan_title);
                if ( $plan_pid ) {
                    update_post_meta($orig_order_id, '_license_plan_product_id', (int)$plan_pid);
                    // store plan type / renew PID / download type for faster display
                    $plan_type_map = [1633=>'interior', 1634=>'furniture', 2385=>'trial'];
                    $pt = isset($plan_type_map[$plan_pid]) ? $plan_type_map[$plan_pid] : 'interior';
                    update_post_meta($orig_order_id, '_license_plan_type', $pt);
                    update_post_meta($orig_order_id, '_license_renew_pid', (int)$plan_pid);
                    update_post_meta($orig_order_id, '_license_download_type', $pt);
                }
                ar_log('‚úÖ Renewal OK for reg '.$renew_for_reg.' (order #'.$orig_order_id.') => '.$new_expires.' / pool='.$final_pool);
            }
        } else {
            ar_log('‚ùå Renewal: original order by reg not found: '.$renew_for_reg);
        }

        // –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–æ–≤—É—é –ª–∏—Ü–µ–Ω–∑–∏—é –Ω–µ –≤—ã–¥–∞—ë–º
        return;
    }

    // ==== –ü–ï–†–í–ò–ß–ù–ê–Ø –í–´–î–ê–ß–ê ====
    if ( get_post_meta($order_id, '_license_reg_code', true) ) return;

    $name     = $order->get_formatted_billing_full_name();
    $email    = $order->get_billing_email();
    $reg_code = wp_generate_uuid4();
    $expires  = date('Y-m-d', strtotime('+1 year'));

    $pool = 1;
    foreach ( $order->get_items() as $item ) {
        $product_id   = $item->get_product_id();
        $variation_id = $item->get_variation_id();
        $target_id    = $variation_id ?: $product_id;

        switch ($target_id) {
            case 2385: $expires = date('Y-m-d', strtotime('+30 days')); break;
            case 1634: $expires = date('Y-m-d', strtotime('+2 months')); break;
            case 1633: $expires = date('Y-m-d', strtotime('+6 months')); break;
            case 1629: $expires = date('Y-m-d', strtotime('+1 year'));   break;
        }

        if ( $variation_id ) {
            $product = wc_get_product($variation_id);
            if ( $product ) {
                $device_attr = $product->get_attribute('pa_devices');
                if ( $device_attr && is_numeric($device_attr) ) {
                    $pool = (int) $device_attr;
                } elseif ( preg_match('/\d+/', $product->get_name(), $m) ) {
                    $pool = (int) $m[0];
                }
            }
        } else {
            $pool = (int) $item->get_quantity();
        }
    }

    $license_json = ar_generate_license_json($name, $email, $reg_code, $expires, $pool);
    if ( ! $license_json ) { 
        ar_log("‚ùå –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å –¥–ª—è #$order_id"); 
        return; 
    }

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ ===
    // determine plan info for this order so we persist compact metadata
    $plan_type = 'interior';
    $plan_pid  = 0;
    $plan_title = '';
    foreach ( $order->get_items() as $item ) {
        $product_id   = $item->get_product_id();
        $variation_id = $item->get_variation_id();
        $pid = $variation_id ? $variation_id : $product_id;
        $product = $variation_id ? wc_get_product($variation_id) : wc_get_product($product_id);
        if ( $product ) {
            $plan_pid = $product->is_type('variation') ? $product->get_parent_id() : $product->get_id();
            $plan_title = $product->is_type('variation') ? get_the_title($product->get_parent_id()) : $product->get_name();
            $plan_title = wp_strip_all_tags($plan_title);
            if ( $plan_pid == 1633 ) {
                $plan_type = 'interior';
            } elseif ( $plan_pid == 1634 ) {
                $plan_type = 'furniture';
            } elseif ( $plan_pid == 2385 ) {
                $plan_type = 'trial';
            } else {
                $plan_type = 'interior';
            }
            break;
        }
    }

    update_post_meta($order_id, '_license_reg_code',   $reg_code);
    update_post_meta($order_id, '_license_key_json',   $license_json);
    update_post_meta($order_id, '_license_expires',    $expires);

    // persist compact plan metadata to avoid expensive lookups during display
    if ( $plan_title ) update_post_meta($order_id, '_license_plan_title', $plan_title);
    if ( $plan_pid )   update_post_meta($order_id, '_license_plan_product_id', (int)$plan_pid);
    update_post_meta($order_id, '_license_plan_type', $plan_type);
    update_post_meta($order_id, '_license_renew_pid', (int)$plan_pid);
    update_post_meta($order_id, '_license_download_type', $plan_type);

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    $user_id = $order->get_user_id();
    if ( $user_id ) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        $user_reg_codes = get_user_meta($user_id, '_user_license_reg_codes', true);
        if ( empty($user_reg_codes) || !is_array($user_reg_codes) ) {
            $user_reg_codes = array();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–¥ (–µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç)
        if ( !in_array($reg_code, $user_reg_codes) ) {
            $user_reg_codes[] = $reg_code;
            update_user_meta($user_id, '_user_license_reg_codes', $user_reg_codes);
            ar_log("‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ $reg_code —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: $user_id");
        }
    } else {
        ar_log("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞ #$order_id");
    }

    $file = ar_save_license_file($order_id, $license_json);
    if ( $file ) {
        list($abs, $url, $fn) = $file;
        update_post_meta($order_id, '_license_file_path', $abs);
        update_post_meta($order_id, '_license_file_url',  $url);
        update_post_meta($order_id, '_license_file_name', $fn);
    }
});

/* ========== API endpoint: –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É –∫–æ–¥—É ========== */
add_action('init', function(){
    if (!isset($_GET['ar_find_user_by_reg_code'])) return;

    $reg_code = sanitize_text_field($_GET['ar_find_user_by_reg_code']);

    // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —ç—Ç–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º
    $users = get_users(array(
        'meta_query' => array(
            array(
                'key' => '_user_license_reg_codes',
                'value' => $reg_code,
                'compare' => 'LIKE'
            )
        )
    ));

    if (empty($users)) {
        wp_send_json(['error' => '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω.'], 404);
    }

    $user = $users[0];
    $user_data = array(
        'id' => $user->ID,
        'email' => $user->user_email,
        'display_name' => $user->display_name,
        'first_name' => $user->first_name,
        'last_name' => $user->last_name
    );

    header('Content-Type: application/json; charset=utf-8');
    echo json_encode($user_data);
    exit;
});



/* ========== –û–î–ù–û–†–ê–ó–û–í–´–ô –°–ö–†–ò–ü–¢: –ø—Ä–∏–≤—è–∑–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ========== */
add_action('admin_init', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç
    if (get_option('ar_user_reg_codes_migrated')) {
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
    if (!isset($_GET['ar_migrate_user_reg_codes']) || $_GET['ar_migrate_user_reg_codes'] !== '1') {
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if (!current_user_can('manage_options')) {
        wp_die('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
    }

    ar_log('üîÑ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    $users = get_users([
        'fields' => 'ID',
        'number' => -1,
    ]);

    $migrated_count = 0;
    $error_count = 0;

    foreach ($users as $user_id) {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        $customer_orders = wc_get_orders([
            'customer_id' => $user_id,
            'status' => 'completed',
            'limit' => -1,
            'return' => 'ids',
        ]);

        $user_reg_codes = [];

        foreach ($customer_orders as $order_id) {
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ –∏–∑ –∑–∞–∫–∞–∑–∞
            $reg_code = get_post_meta($order_id, '_license_reg_code', true);
            
            if ($reg_code && !empty($reg_code)) {
                $user_reg_codes[] = $reg_code;
                ar_log("‚úÖ –ù–∞–π–¥–µ–Ω –∫–æ–¥ $reg_code –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $user_id (–∑–∞–∫–∞–∑ #$order_id)");
            }
        }

        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        $user_reg_codes = array_unique($user_reg_codes);

        if (!empty($user_reg_codes)) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥—ã –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $result = update_user_meta($user_id, '_user_license_reg_codes', $user_reg_codes);
            
            if ($result) {
                $migrated_count++;
                ar_log("‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ " . count($user_reg_codes) . " –∫–æ–¥–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $user_id");
            } else {
                $error_count++;
                ar_log("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–¥–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $user_id");
            }
        }
    }

    // –ü–æ–º–µ—á–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
    update_option('ar_user_reg_codes_migrated', true);
    
    ar_log("üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: $migrated_count, –û—à–∏–±–æ–∫: $error_count");

    // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    echo "<div class='notice notice-success'><p>–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: $migrated_count, –û—à–∏–±–æ–∫: $error_count</p></div>";
});

/* ========== –£–¢–ò–õ–ò–¢–ê –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –°–¢–ê–¢–£–°–ê ========== */
add_action('admin_menu', function() {
    add_management_page(
        '–ú–∏–≥—Ä–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤',
        '–ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–æ–≤ –ª–∏—Ü–µ–Ω–∑–∏–π',
        'manage_options',
        'ar-migrate-reg-codes',
        function() {
            $is_migrated = get_option('ar_user_reg_codes_migrated');
            ?>
            <div class="wrap">
                <h1>–ú–∏–≥—Ä–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>
                
                <div class="card">
                    <h2>–°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏</h2>
                    <p>
                        <?php if ($is_migrated): ?>
                            <strong style="color: green;">‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</strong>
                        <?php else: ?>
                            <strong style="color: orange;">‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å</strong>
                        <?php endif; ?>
                    </p>
                    
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
                    <ul>
                        <li>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <?php echo count(get_users(['fields' => 'ID', 'number' => -1])); ?></li>
                        <li>–°—Ç–∞—Ç—É—Å: <?php echo $is_migrated ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'; ?></li>
                    </ul>
                    
                    <?php if (!$is_migrated): ?>
                        <hr>
                        <h3>–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏</h3>
                        <p>–î–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
                        <a href="<?php echo admin_url('?ar_migrate_user_reg_codes=1'); ?>" 
                           class="button button-primary" 
                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é?')">
                            –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
                        </a>
                    <?php else: ?>
                        <hr>
                        <h3>–°–±—Ä–æ—Å –º–∏–≥—Ä–∞—Ü–∏–∏</h3>
                        <p>–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ, —Å–±—Ä–æ—Å—å—Ç–µ —Å—Ç–∞—Ç—É—Å:</p>
                        <a href="<?php echo admin_url('?ar_reset_migration=1'); ?>" 
                           class="button button-secondary" 
                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏?')">
                            –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏
                        </a>
                    <?php endif; ?>
                </div>
            </div>
            <?php
        }
    );
});

/* ========== –°–ë–†–û–° –°–¢–ê–¢–£–°–ê –ú–ò–ì–†–ê–¶–ò–ò ========== */
add_action('admin_init', function() {
    if (isset($_GET['ar_reset_migration']) && $_GET['ar_reset_migration'] === '1' && current_user_can('manage_options')) {
        delete_option('ar_user_reg_codes_migrated');
        wp_redirect(admin_url('tools.php?page=ar-migrate-reg-codes'));
        exit;
    }
});

/* ========== API –î–õ–Ø –ü–û–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ü–û –†–ï–ì–ò–°–¢–†–ê–¶–ò–û–ù–ù–û–ú–£ –ö–û–î–£ ========== */
add_action('init', function(){
    if (!isset($_GET['ar_find_user_by_reg_code'])) return;

    $reg_code = sanitize_text_field($_GET['ar_find_user_by_reg_code']);
    
    if (empty($reg_code)) {
        wp_send_json(['error' => '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'], 400);
    }

    // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    $users = get_users([
        'meta_query' => [
            [
                'key' => '_user_license_reg_codes',
                'value' => $reg_code,
                'compare' => 'LIKE'
            ]
        ],
        'number' => 1
    ]);

    if (!empty($users)) {
        $user = $users[0];
        $user_data = [
            'id' => $user->ID,
            'email' => $user->user_email,
            'display_name' => $user->display_name,
            'first_name' => $user->first_name,
            'last_name' => $user->last_name,
            'user_login' => $user->user_login,
            'found_via' => 'user_meta'
        ];
        
        wp_send_json($user_data);
    }

    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—â–µ–º –≤ –∑–∞–∫–∞–∑–∞—Ö (fallback)
    global $wpdb;
    $order_id = $wpdb->get_var($wpdb->prepare(
        "SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key = '_license_reg_code' AND meta_value = %s LIMIT 1",
        $reg_code
    ));

    if ($order_id) {
        $order = wc_get_order($order_id);
        if ($order) {
            $user_id = $order->get_user_id();
            if ($user_id) {
                $user = get_userdata($user_id);
                $user_data = [
                    'id' => $user->ID,
                    'email' => $user->user_email,
                    'display_name' => $user->display_name,
                    'first_name' => $user->first_name,
                    'last_name' => $user->last_name,
                    'user_login' => $user->user_login,
                    'found_via' => 'order_meta'
                ];
                
                wp_send_json($user_data);
            }
        }
    }

    wp_send_json(['error' => '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'], 404);
});




/* ========== –û–î–ù–û–†–ê–ó–û–í–´–ô –°–ö–†–ò–ü–¢: –ø—Ä–∏–≤—è–∑–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ========== */
add_action('admin_init', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç
    if (get_option('ar_user_reg_codes_migrated')) {
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
    if (!isset($_GET['ar_migrate_user_reg_codes']) || $_GET['ar_migrate_user_reg_codes'] !== '1') {
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if (!current_user_can('manage_options')) {
        wp_die('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏');
    }

    ar_log('üîÑ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    $users = get_users([
        'fields' => 'ID',
        'number' => -1,
    ]);

    $migrated_count = 0;
    $error_count = 0;

    foreach ($users as $user_id) {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        $customer_orders = wc_get_orders([
            'customer_id' => $user_id,
            'status' => 'completed',
            'limit' => -1,
            'return' => 'ids',
        ]);

        $user_reg_codes = [];

        foreach ($customer_orders as $order_id) {
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ –∏–∑ –∑–∞–∫–∞–∑–∞
            $reg_code = get_post_meta($order_id, '_license_reg_code', true);
            
            if ($reg_code && !empty($reg_code)) {
                $user_reg_codes[] = $reg_code;
                ar_log("‚úÖ –ù–∞–π–¥–µ–Ω –∫–æ–¥ $reg_code –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $user_id (–∑–∞–∫–∞–∑ #$order_id)");
            }
        }

        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        $user_reg_codes = array_unique($user_reg_codes);

        if (!empty($user_reg_codes)) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥—ã –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $result = update_user_meta($user_id, '_user_license_reg_codes', $user_reg_codes);
            
            if ($result) {
                $migrated_count++;
                ar_log("‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ " . count($user_reg_codes) . " –∫–æ–¥–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $user_id");
            } else {
                $error_count++;
                ar_log("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–¥–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $user_id");
            }
        }
    }

    // –ü–æ–º–µ—á–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
    update_option('ar_user_reg_codes_migrated', true);
    
    ar_log("üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: $migrated_count, –û—à–∏–±–æ–∫: $error_count");

    // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    echo "<div class='notice notice-success'><p>–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: $migrated_count, –û—à–∏–±–æ–∫: $error_count</p></div>";
});

/* ========== –£–¢–ò–õ–ò–¢–ê –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –°–¢–ê–¢–£–°–ê ========== */
add_action('admin_menu', function() {
    add_management_page(
        '–ú–∏–≥—Ä–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤',
        '–ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–æ–≤ –ª–∏—Ü–µ–Ω–∑–∏–π',
        'manage_options',
        'ar-migrate-reg-codes',
        function() {
            $is_migrated = get_option('ar_user_reg_codes_migrated');
            ?>
            <div class="wrap">
                <h1>–ú–∏–≥—Ä–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>
                
                <div class="card">
                    <h2>–°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏</h2>
                    <p>
                        <?php if ($is_migrated): ?>
                            <strong style="color: green;">‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</strong>
                        <?php else: ?>
                            <strong style="color: orange;">‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å</strong>
                        <?php endif; ?>
                    </p>
                    
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
                    <ul>
                        <li>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <?php echo count(get_users(['fields' => 'ID', 'number' => -1])); ?></li>
                        <li>–°—Ç–∞—Ç—É—Å: <?php echo $is_migrated ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'; ?></li>
                    </ul>
                    
                    <?php if (!$is_migrated): ?>
                        <hr>
                        <h3>–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏</h3>
                        <p>–î–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
                        <a href="<?php echo admin_url('?ar_migrate_user_reg_codes=1'); ?>" 
                           class="button button-primary" 
                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é?')">
                            –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
                        </a>
                    <?php else: ?>
                        <hr>
                        <h3>–°–±—Ä–æ—Å –º–∏–≥—Ä–∞—Ü–∏–∏</h3>
                        <p>–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ, —Å–±—Ä–æ—Å—å—Ç–µ —Å—Ç–∞—Ç—É—Å:</p>
                        <a href="<?php echo admin_url('?ar_reset_migration=1'); ?>" 
                           class="button button-secondary" 
                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏?')">
                            –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏
                        </a>
                    <?php endif; ?>
                </div>
            </div>
            <?php
        }
    );
});

/* ========== –°–ë–†–û–° –°–¢–ê–¢–£–°–ê –ú–ò–ì–†–ê–¶–ò–ò ========== */
add_action('admin_init', function() {
    if (isset($_GET['ar_reset_migration']) && $_GET['ar_reset_migration'] === '1' && current_user_can('manage_options')) {
        delete_option('ar_user_reg_codes_migrated');
        wp_redirect(admin_url('tools.php?page=ar-migrate-reg-codes'));
        exit;
    }
});

/* ========== API –î–õ–Ø –ü–û–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ü–û –†–ï–ì–ò–°–¢–†–ê–¶–ò–û–ù–ù–û–ú–£ –ö–û–î–£ ========== */
add_action('init', function(){
    if (!isset($_GET['ar_find_user_by_reg_code'])) return;

    $reg_code = sanitize_text_field($_GET['ar_find_user_by_reg_code']);
    
    if (empty($reg_code)) {
        wp_send_json(['error' => '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'], 400);
    }

    // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    $users = get_users([
        'meta_query' => [
            [
                'key' => '_user_license_reg_codes',
                'value' => $reg_code,
                'compare' => 'LIKE'
            ]
        ],
        'number' => 1
    ]);

    if (!empty($users)) {
        $user = $users[0];
        $user_data = [
            'id' => $user->ID,
            'email' => $user->user_email,
            'display_name' => $user->display_name,
            'first_name' => $user->first_name,
            'last_name' => $user->last_name,
            'user_login' => $user->user_login,
            'found_via' => 'user_meta'
        ];
        
        wp_send_json($user_data);
    }

    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—â–µ–º –≤ –∑–∞–∫–∞–∑–∞—Ö (fallback)
    global $wpdb;
    $order_id = $wpdb->get_var($wpdb->prepare(
        "SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key = '_license_reg_code' AND meta_value = %s LIMIT 1",
        $reg_code
    ));

    if ($order_id) {
        $order = wc_get_order($order_id);
        if ($order) {
            $user_id = $order->get_user_id();
            if ($user_id) {
                $user = get_userdata($user_id);
                $user_data = [
                    'id' => $user->ID,
                    'email' => $user->user_email,
                    'display_name' => $user->display_name,
                    'first_name' => $user->first_name,
                    'last_name' => $user->last_name,
                    'user_login' => $user->user_login,
                    'found_via' => 'order_meta'
                ];
                
                wp_send_json($user_data);
            }
        }
    }

    wp_send_json(['error' => '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'], 404);
});







/* ========== API endpoint: /?ar_license_api=REGCODE ========== */
add_action('init', function(){
    if (!isset($_GET['ar_license_api'])) return;

    $reg_code = sanitize_text_field($_GET['ar_license_api']);

    global $wpdb;
    $order_id = $wpdb->get_var($wpdb->prepare(
        "SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key = '_license_reg_code' AND meta_value = %s LIMIT 1",
        $reg_code
    ));

    if (!$order_id) {
        wp_send_json(['error'=>'Codul nu existƒÉ sau este invalid.'], 404);
    }

    $license_json = get_post_meta($order_id,'_license_key_json',true);
    if (!$license_json) {
        wp_send_json(['error'=>'Licen»õa nu a fost gƒÉsitƒÉ.'], 404);
    }

    header('Content-Type: application/json; charset=utf-8');
    echo $license_json;
    exit;
});














/* ========================= –ù–ê–°–¢–†–û–ô–ö–ê –°–¢–†–ê–ù–ò–¶–´ –ê–ö–ö–ê–£–ù–¢–ê ========================= */
add_action('init', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É "Cont" –∫–∞–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
    if (!get_option('woocommerce_myaccount_page_id')) {
        $account_page = get_page_by_path('cont');
        if ($account_page) {
            update_option('woocommerce_myaccount_page_id', $account_page->ID);
        }
    }
});

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–∫–∫–∞—É–Ω—Ç–∞
add_filter('woocommerce_account_content', 'custom_woocommerce_account_content');
function custom_woocommerce_account_content() {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
    if (is_user_logged_in()) {
        return do_shortcode('[artrocket_my_account]');
    }
    
    // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–æ—Ä–º—É WooCommerce
    return do_shortcode('[woocommerce_my_account]');
}

// –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ WooCommerce –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–∫–∫–∞—É–Ω—Ç–∞
add_action('wp_enqueue_scripts', function() {
    if (is_account_page()) {
        wp_dequeue_style('woocommerce-general');
        wp_dequeue_style('woocommerce-layout');
        wp_dequeue_style('woocommerce-smallscreen');
    }
}, 100);










/* ========================= –®–û–†–¢–ö–û–î –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê ========================= */
add_shortcode('artrocket_my_account', function($atts) {
    ob_start();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!is_user_logged_in()) {
        echo '<div class="ar-auth-required">';
        echo '<div class="ar-auth-container">';
        
        // –õ–æ–≥–æ—Ç–∏–ø
        echo '<div class="ar-auth-logo">';
        echo '<img src="https://artrocket.ro/wp-content/uploads/2025/07/logo-horizontal-on-white-scaled.png" alt="Art Rocket" class="ar-logo">';
        echo '</div>';
        
        echo '<div class="ar-auth-header">';
        echo '<h2>Acces Restric»õionat</h2>';
        echo '<p>Trebuie sƒÉ fii autentificat pentru a accesa aceastƒÉ paginƒÉ.</p>';
        echo '</div>';
        
        // –¢–æ–ª—å–∫–æ Google –≤—Ö–æ–¥
        echo '<div class="ar-google-only-section">';
        ar_myaccount_google_block();
        echo '</div>';
        
        echo '</div>'; // .ar-auth-container
        echo '</div>'; // .ar-auth-required
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
        echo '<style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
        .ar-auth-required {
            background: transparent;
            color: #000000;
            font-family: "Montserrat", sans-serif;
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ar-auth-container {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
            text-align: center;
        }
        
        .ar-auth-logo {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .ar-logo {
            max-width: 300px;
            height: auto;
            margin: 0 auto;
        }
        
        .ar-auth-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .ar-auth-header h2 {
            color: #e65c00;
            font-size: 32px;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .ar-auth-header p {
            color: #000000;
            font-size: 18px;
            opacity: 0.8;
            line-height: 1.5;
        }
        
        .ar-google-only-section {
            background: #ffffff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Google –±–ª–æ–∫–∞ */
        .ar-glogin-wrap {
            margin: 0;
            padding: 0;
            border: none;
        }
        
        .ar-glogin-wrap h2 {
            color: #000000;
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .ar-glogin-wrap > p {
            color: #000000;
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.8;
            line-height: 1.5;
            font-size: 16px;
        }
        
        .ar-glogin-actions {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .nsl-container-buttons {
            display: flex;
            justify-content: center;
        }
        
        .nsl-button-google {
            background: #ffffff !important;
            border: 2px solid #e0e0e0 !important;
            color: #000000 !important;
            border-radius: 10px !important;
            padding: 15px 25px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
            width: 100%;
            max-width: 300px;
        }
        
        .nsl-button-google:hover {
            border-color: #e65c00 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
            background: #f8f9fa !important;
        }
        
        .nsl-button-label-container {
            color: #000000 !important;
            font-size: 16px !important;
        }
        
        .nsl-button-label-container b {
            color: #e65c00 !important;
        }
        
        .ar-glogin-toggle {
            color: #000000 !important;
            text-align: center;
            line-height: 1.5;
            font-size: 14px;
            opacity: 0.8;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .ar-auth-container {
                padding: 20px 15px;
            }
            
            .ar-auth-header h2 {
                font-size: 28px;
            }
            
            .ar-google-only-section {
                padding: 30px 20px;
            }
            
            .ar-logo {
                max-width: 250px;
            }
        }
        
        @media (max-width: 480px) {
            .ar-logo {
                max-width: 200px;
            }
            
            .ar-auth-header h2 {
                font-size: 24px;
            }
            
            .ar-auth-header p {
                font-size: 16px;
            }
        }
        </style>';
        
        return ob_get_clean();
    }
    
    $uid = get_current_user_id();
    $user = wp_get_current_user();
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤
    $projects_stats = ar_get_user_projects_stats($uid);
    ?>
    
 <div class="artrocket-my-account">
    <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Å –¥–≤—É—Ö—Ä—è–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π -->
    <div class="ar-account-header">
        <!-- –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ - –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏ –∫–Ω–æ–ø–∫–∏ -->
        <div class="ar-header-top">
            <div class="ar-user-info">
                <div class="ar-user-avatar">
                    <?php 
                    $avatar_url = get_user_meta($uid, 'ar_profile_avatar', true);
                    if (!$avatar_url) {
                        $avatar_url = get_avatar_url($uid, ['size' => 40]);
                    }
                    ?>
                    <img src="<?php echo esc_url($avatar_url); ?>" alt="<?php echo esc_attr($user->display_name); ?>" class="ar-avatar">
                </div>
                <div class="ar-user-details">
                    <div class="ar-user-name"><?php echo esc_html($user->display_name); ?></div>
                    <div class="ar-user-role">–ü–∞—Ä—Ç–Ω–µ—Ä-–¥–∏–∑–∞–π–Ω–µ—Ä Art Rocket</div>
                </div>
            </div>
            
            <div class="ar-header-actions">
                <nav class="ar-main-nav">
                    <ul class="ar-nav-list">
                        <li class="ar-nav-item">
                            <a href="https://art-rocket.ru/proiectele/" target="_blank" class="ar-nav-link">
                                <span class="ar-nav-icon">üìÅ</span>
                                –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã
                            </a>
                        </li>
                        <li class="ar-nav-item" id="ar-tech-req-toggle">
                            <a href="#cerinte-tehnice" class="ar-nav-link">
                                <span class="ar-nav-icon">‚öôÔ∏è</span>
                                <span class="ar-nav-text">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                
                    <button class="ar-logout-btn" onclick="arOpenProfileModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                
                
                <a href="<?php echo wc_logout_url(); ?>" class="ar-logout-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    –í—ã–π—Ç–∏
                </a>
            </div>
        </div>
        
        <!-- –ù–∏–∂–Ω–∏–π —Ä—è–¥ - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="ar-header-bottom">
            <div class="ar-stats-overview">
                <div class="ar-stat-item">
                    <span class="ar-stat-number"><?php echo $projects_stats['total_projects']; ?></span>
                    <span class="ar-stat-label">–í–°–ï–ì–û –ü–†–û–ï–ö–¢–û–í</span>
                </div>
                <div class="ar-stat-item">
                    <span class="ar-stat-number"><?php echo number_format($projects_stats['total_value'], 0, ',', '.'); ?> –†–£–ë</span>
                    <span class="ar-stat-label">–û–ë–©–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨</span>
                </div>
                <div class="ar-stat-item">
                    <span class="ar-stat-number"><?php echo number_format($projects_stats['total_income'], 0, ',', '.'); ?> –†–£–ë</span>
                    <span class="ar-stat-label">–û–ë–©–ê–Ø –ö–û–ú–ò–°–°–ò–Ø (10%)</span>
                </div>
                <div class="ar-stat-item">
                    <span class="ar-stat-number"><?php echo $projects_stats['last_update']; ?></span>
                    <span class="ar-stat-label">–ü–û–°–õ–ï–î–ù–ï–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï</span>
                </div>
            </div>
        </div>
    </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="woocommerce-MyAccount-content">
            
            <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
            <section id="licenses" class="ar-section">
                <div class="ar-licenses-container">
                    <!-- –ë–ª–æ–∫ –ª–∏—Ü–µ–Ω–∑–∏–π -->
                    <div class="ar-licenses-main">
                        <h2>–ú–æ–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏</h2>
                        <?php echo ar_display_user_licenses($uid); ?>
                    </div>
                    
                    <!-- –ë–ª–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å–ø—Ä–∞–≤–∞ -->
                    <div class="ar-products-sidebar">
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –ª–∏—Ü–µ–Ω–∑–∏—é</h3>
                        <?php echo ar_display_products(); ?>
                    </div>
                </div>
            </section>
            
            <!-- –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π -->
            <section id="cerinte-tehnice" class="ar-section" style="display: none;">
                <div class="ar-tech-requirements">
                    <h2>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</h2>
                    <div class="ar-platform-notice">
                        <strong>–¢–æ–ª—å–∫–æ –¥–ª—è Windows 10/11</strong>
                    </div>
                    
                    <div class="ar-tech-table-container">
                        <table class="ar-tech-table">
                            <thead>
                                <tr>
                                    <th>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</th>
                                    <th colspan="2">SketchUp</th>
                                    <th colspan="2">Enscape</th>
                                    <th colspan="2">Artrocket</th>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th>–ú–∏–Ω–∏–º—É–º</th>
                                    <th>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</th>
                                    <th>–ú–∏–Ω–∏–º—É–º</th>
                                    <th>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</th>
                                    <th>–ú–∏–Ω–∏–º—É–º</th>
                                    <th>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä -->
                                <tr>
                                    <td class="ar-component-name">–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä (CPU)</td>
                                    <td>2.1+ GHz Intel processor</td>
                                    <td>2.8+ GHz Intel processor</td>
                                    <td>High-performance multi-core CPU (Intel Core i5 / AMD Ryzen 5 or better)</td>
                                    <td>High-performance multi-core CPU (Intel Core i7 / AMD Ryzen 7 or better)</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                
                                <!-- –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å -->
                                <tr>
                                    <td class="ar-component-name">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å</td>
                                    <td>4GB</td>
                                    <td>8GB+</td>
                                    <td>8GB</td>
                                    <td>16GB+</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                
                                <!-- –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ -->
                                <tr>
                                    <td class="ar-component-name">–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ</td>
                                    <td>700MB of available hard-disk space</td>
                                    <td>At least 1GB of available hard-disk space</td>
                                    <td>1GB of available hard-disk space<br>SSD strongly recommended</td>
                                    <td>2GB of available hard-disk space<br>Fast NVMe SSD for faster loading of large scenes</td>
                                    <td>30GB On System hard-drive</td>
                                    <td>30GB+ On System hard-drive</td>
                                </tr>
                                
                                <!-- –í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞ -->
                                <tr>
                                    <td class="ar-component-name">–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞ (GPU)</td>
                                    <td>Intel HD integrated graphics card with at least 512MB video memory</td>
                                    <td>Discrete Graphics card such as AMD Radeon R9 M37X 2048 MB</td>
                                    <td>NVIDIA GeForce GTX 10 series / Quadro P series and newer 4GB VRAM<br>AMD Radeon RX 5000 series / equivalent Radeon Pro series and newer 4GB VRAM</td>
                                    <td>NVIDIA GeForce RTX 3070 Ti or AMD RX 6800 8GB VRAM or better</td>
                                    <td>The latest available drivers or at least our recommended drivers</td>
                                    <td>The latest available drivers or at least our recommended drivers</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="ar-tech-notes">
                        <h3>–í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è:</h3>
                        <ul>
                            <li>–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã</li>
                            <li>SSD —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</li>
                            <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥—Ä–∞–π–≤–µ—Ä—ã –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏</li>
                            <li>Artrocket —Ç—Ä–µ–±—É–µ—Ç –Ω–µ –º–µ–Ω–µ–µ 30GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–º –¥–∏—Å–∫–µ</li>
                        </ul>
                    </div>
                </div>
            </section>
            
        </div>
    </div>
    
    
   <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è - –û–ë–ù–û–í–õ–ï–ù–ù–û–ï –° –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ú–ò –ü–û–õ–Ø–ú–ò -->
<div id="arProfileModal" class="ar-modal" style="display: none;">
    <div class="ar-modal-content" style="max-width: 600px;">
        <div class="ar-modal-header">
            <h2>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <button class="ar-modal-close" onclick="arCloseProfileModal()">√ó</button>
        </div>
        
        <div class="ar-modal-body">
            <form id="arProfileForm" enctype="multipart/form-data">
                <!-- –ê–≤–∞—Ç–∞—Ä –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="ar-profile-compact-header">
                    <!-- –°–µ–∫—Ü–∏—è —Å –∞–≤–∞—Ç–∞—Ä–æ–º –∏ –æ–±–ª–æ–∂–∫–æ–π -->
                    <div class="ar-avatar-section-compact">
                        <!-- –û–±–ª–æ–∂–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
                        <div class="ar-cover-section-compact">
                            <?php 
                            $cover_url = ar_get_user_profile_cover($uid);
                            ?>
                            <div class="ar-cover-preview-compact" onclick="document.getElementById('arCoverUpload').click();" 
                                 style="background-image: url('<?php echo esc_url($cover_url ?: 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 800 200%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22800%22 height=%22200%22/%3E%3C/svg%3E'); ?>'); background-size: cover; background-position: center;">
                                <div class="ar-cover-upload-hint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.5); padding: 10px 15px; border-radius: 4px; color: white; font-size: 12px; cursor: pointer;">
                                    üì∑ –ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É
                                </div>
                            </div>
                            <input type="file" id="arCoverUpload" name="ar_cover_upload" accept="image/jpeg,image/png,image/webp" class="ar-cover-upload" style="display: none;">
                        </div>
                        
                        <!-- –ê–≤–∞—Ç–∞—Ä -->
                        <div class="ar-avatar-preview-compact" onclick="document.getElementById('arAvatarUpload2').click();">
                        <img id="arAvatarPreview2" src="<?php echo esc_url($avatar_url); ?>" 
                             alt="Avatar" class="ar-avatar-img-compact ar-avatar-preview">
                        <input type="file" id="arAvatarUpload2" name="ar_avatar_upload" accept="image/*" class="ar-avatar-upload" style="display: none;">
                    </div>

                    </div>
                    
                    <div class="ar-basic-info-compact">
                        <div class="ar-form-group-compact">
                            <input type="text" class="ar-form-input-compact" name="first_name" 
                                   value="<?php echo esc_attr(get_user_meta($uid, 'first_name', true)); ?>" 
                                   placeholder="–§–∞–º–∏–ª–∏—è" required>
                        </div>
                        <div class="ar-form-group-compact">
                            <input type="text" class="ar-form-input-compact" name="last_name" 
                                   value="<?php echo esc_attr(get_user_meta($uid, 'last_name', true)); ?>" 
                                   placeholder="–ò–º—è" required>
                        </div>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                <div class="ar-form-fields-compact">
                    <div class="ar-form-group-compact">
                        <input type="email" class="ar-form-input-compact" name="email" 
                               value="<?php echo esc_attr(wp_get_current_user()->user_email); ?>" 
                               placeholder="Email" required>
                    </div>
                    
                    <div class="ar-form-group-compact">
                        <input type="tel" class="ar-form-input-compact" name="phone" 
                               value="<?php echo esc_attr(get_user_meta($uid, 'phone', true) ?: get_user_meta($uid, 'billing_phone', true)); ?>" 
                               placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                    </div>
                </div>

                <!-- –ì–æ—Ä–æ–¥ –∏ —Å—Ç—Ä–∞–Ω–∞ -->
                <div class="ar-form-fields-compact">
                    <div class="ar-form-group-compact">
                        <input type="text" class="ar-form-input-compact" name="city" 
                               value="<?php echo esc_attr(get_user_meta($uid, 'city', true)); ?>" 
                               placeholder="–ì–æ—Ä–æ–¥">
                    </div>
                    
                    <div class="ar-form-group-compact">
                        <input type="text" class="ar-form-input-compact" name="country" 
                               value="<?php echo esc_attr(get_user_meta($uid, 'country', true)); ?>" 
                               placeholder="–°—Ç—Ä–∞–Ω–∞">
                    </div>
                </div>

                <!-- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ -->
                <div class="ar-detail-section-compact">
                    <h3>üåê –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</h3>
                    <div class="ar-detail-list-compact">
                        <div class="ar-field-group-compact">
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">LinkedIn</label>
                                <input type="url" class="ar-editable-field-compact" name="linkedin" 
                                       value="<?php echo esc_attr(get_user_meta($uid, 'linkedin', true)); ?>" 
                                       placeholder="https://linkedin.com/in/...">
                            </div>
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">Facebook</label>
                                <input type="url" class="ar-editable-field-compact" name="facebook" 
                                       value="<?php echo esc_attr(get_user_meta($uid, 'facebook', true)); ?>" 
                                       placeholder="https://facebook.com/...">
                            </div>
                        </div>
                        <div class="ar-detail-item-compact">
                            <label class="ar-detail-label-compact">Instagram</label>
                            <input type="url" class="ar-editable-field-compact" name="instagram" 
                                   value="<?php echo esc_attr(get_user_meta($uid, 'instagram', true)); ?>" 
                                   placeholder="https://instagram.com/...">
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ -->
                <div class="ar-detail-section-compact">
                    <h3>üè¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏</h3>
                    <div class="ar-detail-list-compact">
                        <div class="ar-detail-item-compact">
                            <label class="ar-detail-label-compact">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                            <input type="text" class="ar-editable-field-compact" name="company_name" 
                                   value="<?php echo esc_attr(get_user_meta($uid, 'company_name', true)); ?>" 
                                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                        </div>
                        <div class="ar-field-group-compact">
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">–§–ò–°–ö–ê–õ–¨–ù–´–ô –ö–û–î</label>
                                <input type="text" class="ar-editable-field-compact" name="fiscal_code" 
                                       value="<?php echo esc_attr(get_user_meta($uid, 'fiscal_code', true)); ?>" 
                                       placeholder="–§–∏—Å–∫–∞–ª—å–Ω—ã–π –∫–æ–¥">
                            </div>
                            <div class="ar-detail-item-compact">
                                <label class="ar-checkbox-compact">
                                    <input type="checkbox" name="vat_registered" value="1" <?php checked(get_user_meta($uid, 'vat_registered', true), 1); ?>>
                                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ù–î–°
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
                <div class="ar-detail-section-compact">
                    <h3>üè¶ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
                    <div class="ar-detail-list-compact">
                        <div class="ar-detail-item-compact">
                            <label class="ar-detail-label-compact">IBAN</label>
                            <input type="text" class="ar-editable-field-compact" name="iban" 
                                   value="<?php echo esc_attr(get_user_meta($uid, 'iban', true)); ?>" 
                                   placeholder="RO49 AAAA 1B31 0075 9384 0000">
                        </div>
                        <div class="ar-field-group-compact">
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">–ë–∞–Ω–∫</label>
                                <input type="text" class="ar-editable-field-compact" name="bank_name" 
                                       value="<?php echo esc_attr(get_user_meta($uid, 'bank_name', true)); ?>" 
                                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞">
                            </div>
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">–ö–æ–¥ –±–∞–Ω–∫–∞</label>
                                <input type="text" class="ar-editable-field-compact" name="bank_code" 
                                       value="<?php echo esc_attr(get_user_meta($uid, 'bank_code', true)); ?>" 
                                       placeholder="–ö–æ–¥ –±–∞–Ω–∫–∞">
                            </div>
                        </div>
                        <div class="ar-field-group-compact">
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">–ö–æ–¥ –ù–î–°</label>
                                <input type="text" class="ar-editable-field-compact" name="vat_code" 
                                       value="<?php echo esc_attr(get_user_meta($uid, 'vat_code', true)); ?>" 
                                       placeholder="–ù–î–° –∫–æ–¥">
                            </div>
                            <div class="ar-detail-item-compact">
                                <!-- –ü—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–∞—Ä–æ–ª–∏ -->
                <div class="ar-detail-section-compact">
                    <h3>üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                    <div class="ar-password-fields-compact">
                        <div class="ar-form-group-compact">
                            <input type="password" class="ar-form-input-compact" name="new_password" 
                                   placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                        </div>
                        <div class="ar-form-group-compact">
                            <input type="password" class="ar-form-input-compact" name="confirm_password" 
                                   placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                        </div>
                    </div>
                </div>
                
                <div id="arAvatarError" style="color: #dc3545; font-size: 12px; margin-top: 10px; display: none;"></div>
            </form>
        </div>
        
        <div class="ar-modal-footer-compact">
            <button class="ar-btn-compact ar-btn-secondary-compact" onclick="arCloseProfileModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="ar-btn-compact ar-btn-primary-compact" onclick="arSaveProfile()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>
</div>
    
    <style>
    
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ñ–∏–ª—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ */
.ar-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.ar-modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.ar-modal-header {
    padding: 20px 30px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ar-modal-header h2 {
    margin: 0;
    color: #1e293b;
    font-size: 20px;
    font-weight: 600;
}

.ar-modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #64748b;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ar-modal-close:hover {
    color: #dc3545;
}

.ar-modal-body {
    padding: 30px;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ñ–æ—Ä–º—ã */
.ar-profile-compact-header {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    margin-bottom: 25px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}

.ar-avatar-section-compact {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è */
.ar-cover-section-compact {
    margin-bottom: 10px;
}

.ar-cover-preview-compact {
    cursor: pointer;
    position: relative;
    width: 100%;
    height: 120px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e0e0e0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    background-size: cover;
    background-position: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ar-cover-preview-compact:hover {
    border-color: #007cba;
    box-shadow: 0 4px 12px rgba(0, 124, 186, 0.2);
    transform: translateY(-2px);
}

.ar-cover-upload-hint {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    white-space: nowrap;
    transition: all 0.3s ease;
}

.ar-cover-preview-compact:hover .ar-cover-upload-hint {
    background: rgba(0, 124, 186, 0.7);
    transform: translate(-50%, -50%) scale(1.1);
}

.ar-cover-upload {
    display: none;
}

.ar-avatar-preview-compact {
     cursor: pointer; /* –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
}

.ar-avatar-preview-compact:hover {
    transform: scale(1.05);
}

.ar-avatar-img-compact {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.ar-avatar-change-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #e65c00, #ff7a3d);
    border: 3px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 10;
}

.ar-avatar-change-btn:hover {
    background: linear-gradient(135deg, #cc4c00, #e65c00);
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.ar-avatar-change-btn svg {
    width: 16px;
    height: 16px;
    stroke: white;
    stroke-width: 2;
    fill: none;
    transition: all 0.3s ease;
}

.ar-basic-info-compact {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.ar-form-fields-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.ar-password-fields-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.ar-form-group-compact {
    position: relative;
}

.ar-form-input-compact {
    width: 100%;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 12px 16px;
    color: #334155;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
}

.ar-form-input-compact:hover {
    border-color: #cbd5e1;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.04);
}

.ar-form-input-compact:focus {
    outline: none;
    border-color: #e65c00;
    background: white;
    box-shadow: 0 0 0 4px rgba(230, 92, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
}

.ar-form-input-compact::placeholder {
    color: #94a3b8;
    font-weight: 400;
}

/* –°–µ–∫—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏ */
.ar-detail-section-compact {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.ar-detail-section-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.08), 0 4px 6px -1px rgba(0, 0, 0, 0.04);
}

.ar-detail-section-compact h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0 0 18px 0;
    color: #1e293b;
    font-size: 16px;
    font-weight: 600;
}

.ar-detail-list-compact {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ar-field-group-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.ar-detail-item-compact {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.ar-detail-label-compact {
    color: #64748b;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 2px;
}

.ar-editable-field-compact {
    width: 100%;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px 14px;
    color: #334155;
    font-size: 14px;
    transition: all 0.3s ease;
}

.ar-editable-field-compact:hover {
    border-color: #cbd5e1;
    background: white;
}

.ar-editable-field-compact:focus {
    outline: none;
    border-color: #e65c00;
    background: white;
    box-shadow: 0 0 0 3px rgba(230, 92, 0, 0.1);
}

/* –ß–µ–∫–±–æ–∫—Å */
.ar-checkbox-compact {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    cursor: pointer;
    color: #475569;
    font-size: 14px;
    font-weight: 500;
}

.ar-checkbox-compact input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 2px solid #cbd5e1;
    cursor: pointer;
    transition: all 0.3s ease;
}

.ar-checkbox-compact input[type="checkbox"]:checked {
    background-color: #e65c00;
    border-color: #e65c00;
}

/* –§—É—Ç–µ—Ä –∏ –∫–Ω–æ–ø–∫–∏ */
.ar-modal-footer-compact {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 30px;
    border-top: 1px solid #f1f5f9;
}

.ar-btn-compact {
    padding: 11px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 100px;
    letter-spacing: 0.3px;
}

.ar-btn-primary-compact {
    background: linear-gradient(135deg, #e65c00, #ff7a3d);
    color: white;
    box-shadow: 0 4px 12px rgba(230, 92, 0, 0.2);
}

.ar-btn-primary-compact:hover {
    background: linear-gradient(135deg, #cc4c00, #e65c00);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(230, 92, 0, 0.3);
}

.ar-btn-primary-compact:active {
    transform: translateY(0);
}

.ar-btn-secondary-compact {
    background: white;
    color: #475569;
    border: 2px solid #e2e8f0;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

.ar-btn-secondary-compact:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ */
#arAvatarError {
    background: #fee2e2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    margin-top: 16px;
    display: none;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .ar-profile-compact-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .ar-basic-info-compact,
    .ar-form-fields-compact,
    .ar-password-fields-compact,
    .ar-field-group-compact {
        grid-template-columns: 1fr;
    }
    
    .ar-modal-footer-compact {
        flex-direction: column-reverse;
    }
    
    .ar-btn-compact {
        width: 100%;
    }
    
    .ar-avatar-preview-compact {
        width: 70px;
        height: 70px;
    }
    
    .ar-avatar-change-btn {
        width: 28px;
        height: 28px;
    }
}
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
.ar-action-buttons {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è */
.ar-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(8px);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    animation: arModalFadeIn 0.3s ease;
}

@keyframes arModalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.ar-modal-content {
    background: #ffffff;
    border-radius: 20px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    animation: arModalSlideIn 0.3s ease;
}

@keyframes arModalSlideIn {
    from { 
        transform: scale(0.9) translateY(-20px);
        opacity: 0;
    }
    to { 
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

.ar-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid #f1f5f9;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 20px 20px 0 0;
}

.ar-modal-header h2 {
    margin: 0;
    color: #1e293b;
    font-size: 24px;
    font-weight: 700;
}

.ar-modal-close {
    background: #f1f5f9;
    border: none;
    color: #64748b;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.ar-modal-close:hover {
    background: #e2e8f0;
    color: #475569;
}

.ar-modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
    scrollbar-gutter: stable;
    padding-right: 20px;
}

.ar-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 24px;
    border-top: 1px solid #f1f5f9;
    background: #f8fafc;
    border-radius: 0 0 20px 20px;
}

.ar-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.ar-btn-primary {
    background: #e65c00;
    color: #fff;
    box-shadow: 0 2px 8px rgba(230, 92, 0, 0.3);
}

.ar-btn-primary:hover {
    background: #cc4c00;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(230, 92, 0, 0.4);
}

.ar-btn-secondary {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
}

.ar-btn-secondary:hover {
    background: #e2e8f0;
    color: #374151;
}

/* –§–æ—Ä–º—ã */
.ar-form-group {
    margin-bottom: 24px;
}

.ar-form-label {
    display: block;
    color: #374151;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.ar-form-input {
    width: 100%;
    background: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px 16px;
    color: #1f2937;
    font-size: 14px;
    transition: all 0.3s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.ar-form-input:focus {
    outline: none;
    border-color: #e65c00;
    box-shadow: 0 0 0 3px rgba(230, 92, 0, 0.1);
    background: #fafbfc;
}

.ar-form-input::placeholder {
    color: #9ca3af;
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
.ar-modal-body::-webkit-scrollbar {
    width: 6px;
}

.ar-modal-body::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 3px;
}

.ar-modal-body::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.ar-modal-body {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f8fafc;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ö–µ–¥–µ—Ä–µ */
@media (max-width: 768px) {
    .ar-action-buttons {
        flex-direction: column;
        width: 100%;
    }
    
    .ar-logout-btn {
        width: 100%;
        justify-content: center;
    }
}
    
    
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .ar-main-nav {
        margin-right: 20px;
    }

    .ar-nav-list {
        display: flex;
        gap: 8px;
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .ar-nav-item {
        margin: 0;
    }

    .ar-nav-link {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #64748b;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .ar-nav-link:hover {
        background: #ffffff;
        border-color: #e65c00;
        color: #e65c00;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.1);
    }

    .ar-nav-item.is-active .ar-nav-link {
        background: #e65c00;
        border-color: #e65c00;
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.2);
    }

    .ar-nav-icon {
        font-size: 16px;
        opacity: 0.8;
    }

    .ar-nav-item.is-active .ar-nav-icon {
        opacity: 1;
    }

    /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏–π */
    .ar-header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-shrink: 0;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π */
    .ar-tech-requirements {
        max-width: 100%;
        overflow-x: auto;
    }

    .ar-platform-notice {
    background: #e65c00 !important;
    color: white !important;
    padding: 15px 20px !important;
    border-radius: 8px !important;
    text-align: center !important;
    margin-bottom: 25px !important;
    font-weight: 600 !important;
    font-size: 18px !important;
}

.ar-tech-table-container {
    background: #ffffff !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
    margin-bottom: 25px !important;
    border: 1px solid #e0e0e0 !important;
}

.ar-tech-table {
    width: 100% !important;
    border-collapse: collapse !important;
    font-size: 14px !important;
    line-height: 1.4 !important;
    background: #ffffff !important;
    color: #333333 !important;
}

.ar-tech-table th {
    background: #f8f9fa !important;
    padding: 12px 8px !important;
    text-align: center !important;
    font-weight: 600 !important;
    color: #e65c00 !important;
    border: 1px solid #dee2e6 !important;
}

.ar-tech-table td {
    padding: 10px 8px !important;
    border: 1px solid #dee2e6 !important;
    vertical-align: top !important;
    color: #333333 !important;
    background: #ffffff !important;
}

.ar-component-name {
    background: #f8f9fa !important;
    font-weight: 600 !important;
    color: #333333 !important;
    text-align: center !important;
    vertical-align: middle !important;
}

.ar-tech-table tbody tr:nth-child(even) {
    background: #fafafa !important;
}

.ar-tech-table tbody tr:nth-child(even) td {
    background: #fafafa !important;
}

.ar-tech-table tbody tr:hover {
    background: #fff3e0 !important;
}

.ar-tech-table tbody tr:hover td {
    background: #fff3e0 !important;
}

.ar-tech-notes {
    background: #e3f2fd !important;
    padding: 20px !important;
    border-radius: 8px !important;
    border-left: 4px solid #2196f3 !important;
    color: #333333 !important;
}

.ar-tech-notes h3 {
    color: #1976d2 !important;
    margin-bottom: 12px !important;
    font-size: 16px !important;
}

.ar-tech-notes ul {
    margin: 0 !important;
    padding-left: 20px !important;
    color: #333333 !important;
}

.ar-tech-notes li {
    margin-bottom: 8px !important;
    line-height: 1.5 !important;
    color: #333333 !important;
}`

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    @media (max-width: 1200px) {
        .ar-header-actions {
            flex-direction: column;
            gap: 12px;
        }
        
        .ar-main-nav {
            margin-right: 0;
            width: 100%;
        }
        
        .ar-nav-list {
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .ar-nav-list {
            flex-direction: column;
            width: 100%;
        }
        
        .ar-nav-link {
            justify-content: center;
            padding: 12px 16px;
        }

        .ar-tech-table {
            font-size: 12px;
        }

        .ar-tech-table th,
        .ar-tech-table td {
            padding: 8px 6px;
        }
    }

    @media (max-width: 480px) {
        .ar-nav-link {
            font-size: 13px;
            padding: 10px 12px;
        }
        
        .ar-nav-icon {
            font-size: 14px;
        }

        .ar-tech-table {
            font-size: 11px;
        }

        .ar-platform-notice {
            font-size: 16px;
            padding: 12px 15px;
        }
    }

    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .artrocket-my-account {
        width: 100%;
        font-family: 'Montserrat', sans-serif;
        background: transparent;
    }
    
    /* –ù–æ–≤–∞—è —à–∞–ø–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ */
     .ar-account-header {
        background: #ffffff;
        border-radius: 16px;
        padding: 0;
        margin-bottom: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
        overflow: hidden;
    }

    .ar-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid #f1f5f9;
        background: #ffffff;
    }

    .ar-header-bottom {
        padding: 20px 30px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }
    .ar-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }
    
    .ar-user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
    }
    
    .ar-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .ar-user-details {
        display: flex;
        flex-direction: column;
    }
    
    .ar-user-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 16px;
        line-height: 1.2;
    }
    
    .ar-user-role {
        color: #64748b;
        font-size: 12px;
        font-weight: 500;
        margin-top: 2px;
    }
    
   /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    .ar-stats-overview {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        align-items: center;
    }

    .ar-stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .ar-stat-number {
        font-size: 18px;
        font-weight: 700;
        color: #e65c00;
        line-height: 1;
    }

    .ar-stat-label {
        font-size: 11px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1;
    }
    
    .ar-header-actions {
        flex-shrink: 0;
    }
    
    .ar-logout-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: transparent;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .ar-logout-btn:hover {
        background: #f8fafc;
        color: #dc2626;
        border-color: #fecaca;
    }
    
    .ar-logout-btn svg {
        width: 14px;
        height: 14px;
    }
    
    /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª–∏ WooCommerce */
    .artrocket-my-account .woocommerce-MyAccount-content {
        flex: 1;
        background: transparent !important;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
        color: #333;
    }
    
    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    .woocommerce-MyAccount-navigation ul {
        list-style: none;
        padding: 0;
        margin: 0 0 40px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 20px;
    }
    
    .woocommerce-MyAccount-navigation ul li {
        margin: 0;
    }
    
    .woocommerce-MyAccount-navigation ul li a {
        display: block;
        text-align: center;
        padding: 15px 25px;
        border-radius: 25px;
        font-weight: 300;
        font-size: 14px;
        text-decoration: none;
        background: transparent;
        border: 1px solid #e65c00;
        color: #000000 !important;
        transition: all 0.3s ease;
        min-width: 160px;
    }
    
    .woocommerce-MyAccount-navigation ul li a:hover {
        background: #e65c00;
        color: #000000;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(230, 92, 0, 0.3);
    }
    
    .woocommerce-MyAccount-navigation ul li.is-active a {
        background: #e65c00;
        color: #fff;
    }
    
    /* –°–µ–∫—Ü–∏–∏ */
    .ar-section {
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
        color: #333;
    }
    
    .ar-section h2 {
        color: #e65c00;
        font-size: 24px;
        margin-bottom: 25px;
        text-align: center;
        font-weight: 600;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ª–∏—Ü–µ–Ω–∑–∏–π –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ */
    .ar-licenses-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 40px;
        align-items: start;
    }
    
    .ar-licenses-main {
        width: 100%;
    }
    
    .ar-products-sidebar {
        /*background: #f8f9fa;*/
        /*border-radius: 12px;*/
        /*padding: 25px;*/
        /*border: 1px solid #e0e0e0;*/
    }
    
    .ar-products-sidebar h3 {
        color: #e65c00;
        font-size: 20px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–∏—Ü–µ–Ω–∑–∏–π */
    .ar-license-card {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 24px;
        margin: 20px 0;
        color: #333333;
        font-size: 15px;
        line-height: 1.6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .ar-license-card strong {
        color: #e65c00;
        font-weight: 600;
    }
    
    .ar-license-card > div {
        margin-bottom: 8px;
    }
    
    .ar-license-card .reg-code {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: monospace;
        font-size: 14px;
        background: #ffffff;
        padding: 8px 12px;
        border-radius: 8px;
        color: #198754;
        flex-wrap: wrap;
        word-break: break-all;
        border: 1px solid #e9ecef;
    }
    
    .ar-license-card .copy-btn {
        cursor: pointer;
        background: #6c757d;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 13px;
        color: #ffffff;
        transition: background 0.2s, transform 0.2s;
    }
    
    .ar-license-card .copy-btn:hover {
        background: #e65c00;
        transform: translateY(-1px);
    }
    
    /* Alerts */
    .ar-alert {
        padding: 12px 14px;
        border-radius: 10px;
        margin: 14px 0;
        font-size: 14px;
        line-height: 1.5;
        border: 1px solid transparent;
    }
    
    .ar-alert--danger {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .ar-alert--warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è */
    .ar-renew-row {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        align-items: stretch;
    }
    
    .ar-renew-card2 {
        flex: 1 1 0%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 56px;
        padding: 0 16px;
        border-radius: 12px;
        text-decoration: none !important;
        font-weight: 800;
        font-size: 18px;
        letter-spacing: .2px;
        color: #333333 !important;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .ar-renew-card2:hover {
        transform: translateY(-2px);
        border-color: #adb5bd;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        background: #e9ecef;
    }
    
    .ar-renew-card2--primary {
        background: #e65c00;
        color: #ffffff !important;
        border-color: #e65c00;
    }
    
    .ar-renew-card2--primary:hover {
        background: #cc4c00;
        border-color: #cc4c00;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è */
    .ar-download-wrap {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        align-items: stretch;
    }
    
    .ar-download-btn {
        flex: 1 1 0%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 56px;
        padding: 0 16px;
        border-radius: 12px;
        text-decoration: none !important;
        font-weight: 800;
        font-size: 16px;
        letter-spacing: .2px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .ar-download-btn {
        background: #e65c00;
        color: #ffffff !important;
        border: 1px solid #e65c00;
    }
    
    .ar-download-btn:hover {
        background: #cc4c00;
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(230, 92, 0, 0.3);
    }
    
    .ar-download-btn--disabled {
        opacity: .55;
        pointer-events: none;
        filter: grayscale(65%);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    .ar-products-sidebar .my-account-products {
        text-align: center;
    }
    
    .ar-products-sidebar .my-account-products ul.products {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px !important;
        list-style: none;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .ar-products-sidebar .my-account-products ul.products li.product {
        text-align: center;
        box-sizing: border-box;
        transition: transform 0.3s ease;
        margin: 0 !important;
        padding: 15px;
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
    }
    
    .ar-products-sidebar .my-account-products ul.products li.product:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .ar-products-sidebar .my-account-products ul.products li.product img {
        width: 100%;
        max-width: 80px;
        height: auto;
        margin: 0 auto 10px;
        display: block;
        border-radius: 6px;
    }
    
    .ar-products-sidebar .my-account-products ul.products li.product h3 {
        font-size: 14px;
        margin: 8px 0;
        color: #333;
        font-weight: 600;
        line-height: 1.3;
    }
    
    .ar-products-sidebar .my-account-products ul.products li.product .price {
        display: block;
        font-size: 14px;
        font-weight: 700;
        color: #e65c00;
        margin: 8px 0 12px;
    }
    
    .ar-products-sidebar .my-account-products ul.products li.product .button {
        display: inline-block;
        background: transparent;
        border: 2px solid #e65c00;
        color: #e65c00;
        border-radius: 20px;
        padding: 8px 15px;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .ar-products-sidebar .my-account-products ul.products li.product .button:hover {
        background: #e65c00;
        color: #fff;
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(230, 92, 0, 0.3);
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1200px) {
        .ar-account-header {
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }
        
        .ar-stats-overview {
            order: -1;
            width: 100%;
        }
        
        .ar-user-info {
            justify-content: center;
        }
    }
    
    @media (max-width: 1024px) {
        .ar-licenses-container {
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .ar-products-sidebar {
            order: -1;
        }
        
        .ar-stats-overview {
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .ar-stat-item {
            min-width: calc(50% - 20px);
        }
    }
    
    @media (max-width: 768px) {
        .woocommerce-MyAccount-navigation ul {
            flex-direction: column;
            align-items: center;
        }
        
        .woocommerce-MyAccount-navigation ul li {
            width: 100%;
            max-width: 300px;
        }
        
        .ar-section {
            padding: 20px 15px;
        }
        
        .ar-renew-row {
            flex-direction: column;
        }
        
        .ar-products-sidebar .my-account-products ul.products {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .ar-download-wrap {
            flex-direction: column;
        }
        
        .ar-account-header {
            padding: 15px 20px;
        }
        
        .ar-stats-overview {
            gap: 15px;
        }
        
        .ar-stat-item {
            min-width: calc(50% - 15px);
        }
    }
    
    @media (max-width: 480px) {
        .ar-license-card {
            padding: 15px;
        }
        
        .ar-license-card .reg-code {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .ar-license-card .copy-btn {
            align-self: stretch;
            text-align: center;
        }
        
        .ar-products-sidebar .my-account-products ul.products {
            grid-template-columns: 1fr;
        }
        
        .ar-products-sidebar {
            padding: 20px;
        }
        
        .ar-stat-item {
            min-width: 100%;
        }
        
        .ar-stat-number {
            font-size: 16px;
        }
        
        .ar-stat-label {
            font-size: 10px;
        }
    }
    
    
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π */
.ar-tech-req-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: 56px;
    padding: 0 20px;
    border-radius: 12px;
    text-decoration: none !important;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.2px;
    text-align: center;
    transition: all 0.3s ease;
    background: #2e96ff;
    border: 1px solid #e2e8f0;
    color: #ffffff;
    flex: 0 0 auto;
    white-space: nowrap;
}

.ar-tech-req-btn:hover {
    background: #ffffff;
    border-color: #e65c00;
    color: #e65c00;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(230, 92, 0, 0.1);
}

.ar-btn-icon {
    font-size: 16px;
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–Ω–æ–ø–æ–∫ */
.ar-download-wrap {
    margin-top: 15px;
    display: flex;
    gap: 12px;
    align-items: stretch;
}

.ar-download-btn {
    flex: 1 1 0%;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 56px;
    padding: 0 16px;
    border-radius: 12px;
    text-decoration: none !important;
    font-weight: 600;
    font-size: 16px;
    letter-spacing: .2px;
    text-align: center;
    transition: all 0.3s ease;
    background: #e65c00;
    color: #ffffff !important;
    border: 1px solid #e65c00;
}

.ar-download-btn:hover {
    background: #cc4c00;
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(230, 92, 0, 0.3);
}

.ar-download-btn--disabled {
    opacity: .55;
    pointer-events: none;
    filter: grayscale(65%);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
@media (max-width: 768px) {
    .ar-download-wrap {
        flex-direction: column;
    }
    
    .ar-tech-req-btn {
        order: 2;
        min-height: 48px;
    }
    
    .ar-download-btn {
        order: 1;
        min-height: 48px;
    }
}

@media (max-width: 480px) {
    .ar-tech-req-btn,
    .ar-download-btn {
        font-size: 14px;
        padding: 0 12px;
    }
}
    
    
    </style>
    
    <script>
        
        
        
        
        
        
        
        
        
        
        
        
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–§–ò–õ–ï–ú
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–§–ò–õ–ï–ú
let currentAvatarFile = null;
let currentCoverFile = null;
let currentCoverFile1 = null;

function arOpenProfileModal() {
    document.getElementById('arProfileModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function arCloseProfileModal() {
    document.getElementById('arProfileModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    currentAvatarFile = null;
    currentCoverFile = null;
    currentCoverFile1 = null;
    document.getElementById('arAvatarError').style.display = 'none';
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
document.addEventListener('DOMContentLoaded', function() {
    const coverUpload = document.getElementById('arCoverUpload');
    if (coverUpload) {
        coverUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];

            if (!allowedTypes.includes(file.type)) {
                arShowNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ–±–ª–æ–∂–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ JPG, PNG –∏–ª–∏ WebP.', 'error');
                coverUpload.value = '';
                return;
            }

            if (file.size > maxSize) {
                arShowNotification('–§–∞–π–ª –æ–±–ª–æ–∂–∫–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB.', 'error');
                coverUpload.value = '';
                return;
            }

            // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–ª–æ–∂–∫–∏
            const reader = new FileReader();
            reader.onload = function(e) {
                const coverPreview = document.querySelector('.ar-cover-preview-compact');
                if (coverPreview) {
                    coverPreview.style.backgroundImage = 'url(' + e.target.result + ')';
                    coverPreview.style.backgroundSize = 'cover';
                    coverPreview.style.backgroundPosition = 'center';
                }
                currentCoverFile = file;
                arShowNotification('üì∑ –û–±–ª–æ–∂–∫–∞ –≤—ã–±—Ä–∞–Ω–∞. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å.', 'info');
            }
            reader.readAsDataURL(file);
        });
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è (–≤—Ç–æ—Ä–æ–π –ø–æ–ø–∞–ø - arCoverUpload1)
document.addEventListener('DOMContentLoaded', function() {
    const coverUpload1 = document.getElementById('arCoverUpload1');
    if (coverUpload1) {
        coverUpload1.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];

            if (!allowedTypes.includes(file.type)) {
                arShowNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ–±–ª–æ–∂–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ JPG, PNG –∏–ª–∏ WebP.', 'error');
                coverUpload1.value = '';
                return;
            }

            if (file.size > maxSize) {
                arShowNotification('–§–∞–π–ª –æ–±–ª–æ–∂–∫–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB.', 'error');
                coverUpload1.value = '';
                return;
            }

            // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–ª–æ–∂–∫–∏
            const reader = new FileReader();
            reader.onload = function(e) {
                // –î–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ø–∞–ø–∞ –∏—â–µ–º cover-preview –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ø–∞–ø–∞
                const profileModal = document.getElementById('arProfileModal');
                let coverPreview = null;
                
                if (profileModal) {
                    // –ò—â–µ–º –≤—Å–µ .ar-cover-preview-compact –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                    const previews = profileModal.querySelectorAll('.ar-cover-preview-compact');
                    if (previews.length > 1) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π
                        coverPreview = previews[previews.length - 1];
                    } else if (previews.length === 1) {
                        coverPreview = previews[0];
                    }
                }
                
                if (coverPreview) {
                    coverPreview.style.backgroundImage = 'url(' + e.target.result + ')';
                    coverPreview.style.backgroundSize = 'cover';
                    coverPreview.style.backgroundPosition = 'center';
                }
                currentCoverFile1 = file;
                arShowNotification('üì∑ –û–±–ª–æ–∂–∫–∞ –≤—ã–±—Ä–∞–Ω–∞. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å.', 'info');
            }
            reader.readAsDataURL(file);
        });
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ ‚Äî —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback –µ—Å–ª–∏ –Ω–µ—Ç –∫–ª–∞—Å—Å–∞ .ar-avatar-upload
if (!document.querySelectorAll('.ar-avatar-upload').length) {
    document.addEventListener('DOMContentLoaded', function() {
        const avatarUpload = document.getElementById('arAvatarUpload');
        if (avatarUpload) {
            avatarUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞
                const maxSize = 2 * 1024 * 1024; // 2MB
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

                if (!allowedTypes.includes(file.type)) {
                    showAvatarError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ JPEG, PNG, GIF –∏–ª–∏ WebP.');
                    return;
                }

                if (file.size > maxSize) {
                    showAvatarError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2MB.');
                    return;
                }

                // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('arAvatarPreview');
                    if (preview) preview.src = e.target.result;
                    currentAvatarFile = file;
                    const err = document.getElementById('arAvatarError');
                    if (err) err.style.display = 'none';
                }
                reader.readAsDataURL(file);
            });
        }
    });
}

function showAvatarError(message) {
    const errorEl = document.getElementById('arAvatarError');
    if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
    }
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ input'—ã (–∏–¥/–∫–ª–∞—Å—Å)
    const old = document.getElementById('arAvatarUpload');
    if (old) old.value = '';
    document.querySelectorAll('.ar-avatar-upload').forEach(function(i){ i.value = ''; });
}

function arSaveProfile() {
    const form = document.getElementById('arProfileForm');
    const formData = new FormData(form);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        arShowNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
        return;
    }
    
    if (newPassword && newPassword.length < 6) {
        arShowNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentAvatarFile) {
        formData.append('avatar_file', currentAvatarFile);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentCoverFile) {
        formData.append('cover_file', currentCoverFile);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ø–∞–ø–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentCoverFile1) {
        formData.append('cover_file', currentCoverFile1);
    }
    
    formData.append('action', 'ar_save_profile');
    formData.append('nonce', '<?php echo wp_create_nonce("ar_save_profile"); ?>');
    
    const btn = document.querySelector('#arProfileModal .ar-btn-primary-compact');
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...';
    btn.disabled = true;
    
    fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
        method: 'POST',
        body: formData,
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            arShowNotification('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ —Ö–µ–¥–µ—Ä–µ –∏ –≤—Å–µ –ø—Ä–µ–≤—å—é (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
            if (data.data.avatar_url) {
                const url = data.data.avatar_url;
                const headerImg = document.querySelector('.ar-user-avatar img');
                if (headerImg) headerImg.src = url;

                // –æ–±–Ω–æ–≤–ª—è–µ–º –ª—é–±—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–µ–≤—å—é –ø–æ –∫–ª–∞—Å—Å—É
                document.querySelectorAll('.ar-avatar-preview, .ar-avatar-img-compact').forEach(function(img){
                    if (img) img.src = url;
                });
                // –∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–æ ID (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
                ['arAvatarPreview','arAvatarPreview1','arAvatarPreview2'].forEach(function(id){
                    const el = document.getElementById(id);
                    if (el) el.src = url;
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–æ–∂–∫—É –ø—Ä–æ—Ñ–∏–ª—è –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
            if (data.data.cover_url) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–≤—å—é –æ–±–ª–æ–∂–µ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const coverPreviews = document.querySelectorAll('.ar-cover-preview-compact');
                coverPreviews.forEach(function(coverPreview) {
                    coverPreview.style.backgroundImage = 'url(' + data.data.cover_url + ')';
                });
            }
            
            setTimeout(() => {
                arCloseProfileModal();
            }, 1500);
        } else {
            arShowNotification('–û—à–∏–±–∫–∞: ' + (data.data || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'), 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        arShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('arProfileModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                arCloseProfileModal();
            }
        });
    }
});

function arShowNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `ar-notification ar-notification-${type}`;
    notification.innerHTML = `
        <div class="ar-notification-content">
            <span class="ar-notification-message">${message}</span>
            <button class="ar-notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
    `;
    
    if (!document.querySelector('#ar-notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'ar-notification-styles';
        styles.textContent = `
            .ar-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10001;
                min-width: 300px;
                max-width: 500px;
                animation: arSlideIn 0.3s ease;
            }
            .ar-notification-success {
                background: #22c55e;
                color: white;
            }
            .ar-notification-error {
                background: #dc3545;
                color: white;
            }
            .ar-notification-info {
                background: #3b82f6;
                color: white;
            }
            .ar-notification-content {
                padding: 15px 20px;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .ar-notification-close {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                margin-left: 15px;
            }
            @keyframes arSlideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
function toggleTechRequirements() {
    const toggleBtn = document.getElementById('ar-tech-req-toggle');
    if (toggleBtn) {
        toggleBtn.click();
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å–µ–∫—Ü–∏–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
    const techSection = document.getElementById('cerinte-tehnice');
    if (techSection && techSection.style.display !== 'none') {
        techSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏
document.addEventListener('DOMContentLoaded', function() {
    // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('button.copy-btn');
        if (!btn) return;
        const code = btn.getAttribute('data-code') || '';
        if (!code) return;
        navigator.clipboard.writeText(code).then(function() {
            const old = btn.textContent;
            btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(function() { 
                btn.textContent = old; 
            }, 1500);
        });
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏
    const toggleBtn = document.getElementById('ar-tech-req-toggle');
    const licensesSection = document.getElementById('licenses');
    const techReqSection = document.getElementById('cerinte-tehnice');
    const navLink = toggleBtn.querySelector('.ar-nav-link');
    const navIcon = toggleBtn.querySelector('.ar-nav-icon');
    const navText = toggleBtn.querySelector('.ar-nav-text');

    if (toggleBtn) {
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (licensesSection.style.display === 'none') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏, —Å–∫—Ä—ã–≤–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
                licensesSection.style.display = 'block';
                techReqSection.style.display = 'none';
                navIcon.textContent = '‚öôÔ∏è';
                navText.textContent = '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è';
                toggleBtn.classList.remove('is-active');
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, —Å–∫—Ä—ã–≤–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏
                licensesSection.style.display = 'none';
                techReqSection.style.display = 'block';
                navIcon.textContent = 'üìÑ';
                navText.textContent = '–ú–æ–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏';
                toggleBtn.classList.add('is-active');
            }
        });
    }
});
    
    
    
    
    </script>
    
    <?php
    return ob_get_clean();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function ar_get_user_projects_stats($user_id) {
    $projects = AR_Project_Cache::get_user_projects($user_id);
    
    $total_projects = count($projects);
    $total_value = 0;
    $total_income = 0;
    
    foreach ($projects as $project) {
        $project_value = floatval($project['value']);
        $designer_income = floatval($project['designer_income']);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é 10% –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ —Ä–∞–≤–Ω–∞ 0
        if (($designer_income == 0 || empty($designer_income)) && $project_value > 0) {
            $designer_income = $project_value * 0.1;
        }
        
        $total_value += $project_value;
        $total_income += $designer_income;
    }
    
    $last_update = AR_Project_Cache::get_last_cache_time($user_id);
    
    return [
        'total_projects' => $total_projects,
        'total_value' => $total_value,
        'total_income' => $total_income,
        'last_update' => $last_update
    ];
}

/* ========================= –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ========================= */

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function ar_display_user_licenses($uid) {
    ob_start();
    
    $orders = wc_get_orders([
        'customer_id' => $uid,
        'status'      => ['completed'],
        'limit'       => -1,
        'return'      => 'objects',
    ]);
    
    if (!$orders) { 
        echo '<p>–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–∏—Ü–µ–Ω–∑–∏–π.</p>'; 
        return ob_get_clean();
    }

    $found_any = false;

    foreach ($orders as $order) {
        $order_id = $order->get_id();
        $json     = get_post_meta($order_id,'_license_key_json',true);
        $reg_code = get_post_meta($order_id,'_license_reg_code',true);
        $expires  = get_post_meta($order_id,'_license_expires',true);
        if (!$json || !$reg_code) continue;
        $found_any = true;

        $decoded = json_decode($json, true) ?: [];
        $pool_from_json        = isset($decoded['pool']) ? (int)$decoded['pool'] : null;
        $expiry_full_from_json = !empty($decoded['expiry_date']) ? $decoded['expiry_date'] : null;
        $data_arr = [];
        if (!empty($decoded['data'])) {
            $inner = json_decode(base64_decode($decoded['data'], true), true);
            if (is_array($inner)) $data_arr = $inner;
        }

        // devices fallback
        $pool_fallback = 0;
        foreach ($order->get_items() as $it) { $pool_fallback += (int)$it->get_quantity(); }
        $pool_to_show = $pool_from_json !== null ? $pool_from_json : $pool_fallback;

        echo '<div class="ar-license-card">';

        // === FAST PATH: Try new metadata keys first (set during issuance/renewal) ===
        $product_type = get_post_meta($order_id, '_license_plan_type', true);
        $current_plan_pid = get_post_meta($order_id, '_license_renew_pid', true);
        $current_plan_title = get_post_meta($order_id, '_license_plan_title', true);
        
        // === FALLBACK PATH 1: Read from order items (for older orders without new metadata) ===
        if (empty($product_type) || empty($current_plan_pid)) {
            $product_type = 'interior';
            $product_found = false;
            
            foreach ($order->get_items() as $item) {
                $product = $item->get_product();
                if ($product) {
                    $pid = $product->is_type('variation') ? $product->get_parent_id() : $product->get_id();
                    $current_plan_pid = $pid;
                    $product_found = true;
                    
                    // Determine type by product ID
                    if ($pid == 1633) {
                        $product_type = 'interior';
                        if (empty($current_plan_title)) $current_plan_title = '–î–∏–∑–∞–π–Ω–µ—Ä –ò–Ω—Ç–µ—Ä—å–µ—Ä–∞';
                    } elseif ($pid == 1634) {
                        $product_type = 'furniture';
                        if (empty($current_plan_title)) $current_plan_title = '–î–∏–∑–∞–π–Ω–µ—Ä –ú–µ–±–µ–ª–∏';
                    } elseif ($pid == 2385) {
                        $product_type = 'trial';
                        if (empty($current_plan_title)) $current_plan_title = 'Trial –≤–µ—Ä—Å–∏—è';
                    } else {
                        $product_type = 'interior';
                    }
                    
                    if (empty($current_plan_title)) {
                        $current_plan_title = $product->is_type('variation') ? 
                            get_the_title($product->get_parent_id()) : 
                            $product->get_name();
                        $current_plan_title = wp_strip_all_tags($current_plan_title);
                    }
                    
                    // Cache the result for next time
                    update_post_meta($order_id, '_license_plan_type', $product_type);
                    update_post_meta($order_id, '_license_renew_pid', (int)$current_plan_pid);
                    update_post_meta($order_id, '_license_download_type', $product_type);
                    break;
                }
            }
            
            // === FALLBACK PATH 2: Check renewal orders only if still not found ===
            if (empty($current_plan_title) && $reg_code) {
                $renew_orders = wc_get_orders([
                    'limit'      => 1,
                    'orderby'    => 'date',
                    'order'      => 'DESC',
                    'return'     => 'objects',
                    'meta_query' => [[ 'key'=>'_renew_reg_code','value'=>$reg_code ]],
                    'status'     => array_keys(wc_get_order_statuses()),
                ]);
                
                if (!empty($renew_orders)) {
                    $ro = $renew_orders[0];
                    foreach ($ro->get_items() as $r_item) {
                        $rp = $r_item->get_product();
                        if ($rp) {
                            $current_plan_title = $rp->is_type('variation') ? 
                                get_the_title($rp->get_parent_id()) : 
                                $rp->get_name();
                            $current_plan_title = wp_strip_all_tags($current_plan_title);
                            $current_plan_pid   = $rp->is_type('variation') ? 
                                $rp->get_parent_id() : 
                                $rp->get_id();
                            
                            if ($current_plan_pid == 1633) {
                                $product_type = 'interior';
                            } elseif ($current_plan_pid == 1634) {
                                $product_type = 'furniture';
                            } elseif ($current_plan_pid == 2385) {
                                $product_type = 'trial';
                            }
                            
                            // Cache the result for next time
                            update_post_meta($order_id, '_license_plan_title', $current_plan_title);
                            update_post_meta($order_id, '_license_plan_product_id', (int)$current_plan_pid);
                            update_post_meta($order_id, '_license_plan_type', $product_type);
                            update_post_meta($order_id, '_license_renew_pid', (int)$current_plan_pid);
                            update_post_meta($order_id, '_license_download_type', $product_type);
                            break;
                        }
                    }
                }
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ
        if ($current_plan_title) {
            echo '<div><strong>–ü—Ä–æ–¥—É–∫—Ç:</strong> ' . esc_html($current_plan_title);
            if ($current_plan_pid) {
                echo ' (ID: ' . esc_html((string)$current_plan_pid) . ')';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
                $type_icons = [
                    'interior' => 'üè†',
                    'furniture' => 'ü™ë',
                    'trial' => 'üî¨'
                ];
                $icon = $type_icons[$product_type] ?? '';
                if ($icon) {
                    echo ' <span style="margin-left: 5px;">' . $icon . '</span>';
                }
            }
            echo '</div>';
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∑–∞–∫–∞–∑–∞
            $order_items = $order->get_items();
            if (!empty($order_items)) {
                echo '<div><strong>–ü—Ä–æ–¥—É–∫—Ç—ã –≤ –∑–∞–∫–∞–∑–µ:</strong></div>';
                foreach ($order_items as $item) {
                    $product = $item->get_product();
                    $name = $product ? $product->get_name() : $item->get_name();
                    $qty = $item->get_quantity();
                    $pid = $product ? $product->get_id() : 0;
                    echo '<div>- ' . esc_html($name) . ' √ó ' . esc_html($qty);
                    if ($pid) echo ' (ID: ' . esc_html($pid) . ')';
                    echo '</div>';
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    if ($pid == 1633 || $pid == 1629) {
                        $product_type = 'interior';
                    } elseif ($pid == 1634) {
                        $product_type = 'furniture';
                    } elseif ($pid == 2385) {
                        $product_type = 'trial';
                    }
                }
            }
        }

        echo '<div><strong>–ó–∞–∫–∞–∑ #:</strong> '.esc_html($order_id).'</div>';
        if (!empty($data_arr['name']))  echo '<div><strong>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:</strong> '.esc_html($data_arr['name']).'</div>';
        if (!empty($data_arr['email'])) echo '<div><strong>Email:</strong> '.esc_html($data_arr['email']).'</div>';
        echo '<div><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:</strong> '.esc_html($pool_to_show).'</div>';

        echo '<div><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥:</strong></div>';
        echo '<div class="reg-code">'.esc_html($reg_code).'
                <button class="copy-btn" data-code="'.esc_attr($reg_code).'">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>';

        if (!empty($data_arr['issued_at'])) {
            echo '<div><strong>–í—ã–¥–∞–Ω–æ:</strong> '.date_i18n('j F Y H:i', strtotime($data_arr['issued_at'])).'</div>';
        }
        if (!empty($expires)) {
            echo '<div><strong>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ:</strong> '.date_i18n('j F Y', strtotime($expires)).'</div>';
        }

        // –°—Ç–∞—Ç—É—Å –ª–∏—Ü–µ–Ω–∑–∏–∏
        $tz  = wp_timezone();
        $now = new DateTimeImmutable('now', $tz);
        $exp_dt = null;
        if ($expiry_full_from_json) {
            try { $exp_dt = (new DateTimeImmutable($expiry_full_from_json))->setTimezone($tz); } catch (\Throwable $e) { $exp_dt = null; }
        }
        if (!$exp_dt && !empty($expires)) { $exp_dt = new DateTimeImmutable($expires.' 23:59:59', $tz); }

        $is_expired = $exp_dt ? ($now > $exp_dt) : false;
        $days_left  = $exp_dt ? (int) floor(($exp_dt->getTimestamp() - $now->getTimestamp()) / DAY_IN_SECONDS) : null;
        $exp_human  = $exp_dt ? date_i18n('j F Y', $exp_dt->getTimestamp()) : '‚Äî';

        if ($is_expired) {
            echo '<div class="ar-alert ar-alert--danger"><strong>–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞.</strong> –ò—Å—Ç–µ–∫–ª–∞ <u>'.esc_html($exp_human).'</u>. –ü—Ä–æ–¥–ª–∏—Ç–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.</div>';
        } elseif ($days_left !== null && $days_left <= 7) {
            $text_days = ($days_left === 0) ? '—Å–µ–≥–æ–¥–Ω—è' : ('—á–µ—Ä–µ–∑ '.intval($days_left).' –¥–Ω–µ–π');
            echo '<div class="ar-alert ar-alert--warning"><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –õ–∏—Ü–µ–Ω–∑–∏—è –∏—Å—Ç–µ–∫–∞–µ—Ç '.$text_days.' ('.esc_html($exp_human).'). –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–¥–ª–∏—Ç—å.</div>';
        }

        // –ü—Ä–æ–¥–ª–µ–Ω–∏–µ - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–¥—É–∫—Ç
        if ($is_expired || ($days_left !== null && $days_left <= 7)) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞
            $renew_product_ids = [
                'interior' => 1633,  // –î–∏–∑–∞–π–Ω–µ—Ä –ò–Ω—Ç–µ—Ä—å–µ—Ä–∞
                'furniture' => 1634, // –î–∏–∑–∞–π–Ω–µ—Ä –ú–µ–±–µ–ª–∏
                'trial' => 2385      // Trial –≤–µ—Ä—Å–∏—è
            ];
            
            $renew_pid = $renew_product_ids[$product_type] ?? 1633; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–Ω—Ç–µ—Ä—å–µ—Ä
            
            $nonce = wp_create_nonce('ar_renew_'.$reg_code);
            $renew_url = home_url("/ar-renew/{$reg_code}/{$renew_pid}/?_arn={$nonce}");
            
            echo '<div class="ar-renew-row" role="group" aria-label="–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏">
                    <a class="ar-renew-card2 ar-renew-card2--primary" href="'.esc_url($renew_url).'">–ü—Ä–æ–¥–ª–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</a>
                  </div>';
        }
        
        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
        echo '<div class="ar-download-wrap">';
        
        // –ö–Ω–æ–ø–∫–∞ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
        echo '<a href="#cerinte-tehnice" class="ar-tech-req-btn" onclick="toggleTechRequirements()">
                <span class="ar-btn-icon">‚öôÔ∏è</span>
                –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
              </a>';

        // –ö–Ω–æ–ø–∫–∞ –°–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        echo '<a href="https://art-rocket.ru/wp-content/uploads/2025/10/instructiune-ro.pdf" 
                class="ar-tech-req-btn" target="_blank" rel="noopener noreferrer">
                <span class="ar-btn-icon">üìã</span>
                –°–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
              </a>';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
        $upload_dir = wp_upload_dir();
        $base_dir = $upload_dir['basedir'] . '/software-releases/current/';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
        $file_paths = [
            'interior' => $base_dir . 'interior/software.rbz',
            'furniture' => $base_dir . 'furniture/software.rbz',
            'trial' => $base_dir . 'trial/software.rbz'
        ];
        
        $current_file_path = $file_paths[$product_type] ?? $file_paths['interior'];
        $file_exists = file_exists($current_file_path);
        
        // // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        // $debug_info = '';
        // if (current_user_can('administrator')) {
        //     $debug_info = '<div style="font-size: 11px; color: #666; margin: 5px 0;">–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É: ' . esc_html($current_file_path) . '</div>';
        // }
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
        $version_option_key = 'software_current_version_' . $product_type;
        $version_info = get_option($version_option_key, array());
        $current_version = !empty($version_info['version_number']) ? $version_info['version_number'] : 'Trial';
        
        // –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å —Ç–∏–ø–æ–º –ø—Ä–æ–¥—É–∫—Ç–∞
        $product_names = [
            'interior' => '–î–∏–∑–∞–π–Ω–µ—Ä –ò–Ω—Ç–µ—Ä—å–µ—Ä–∞',
            'furniture' => '–î–∏–∑–∞–π–Ω–µ—Ä –ú–µ–±–µ–ª–∏',
            'trial' => 'Trial –≤–µ—Ä—Å–∏—è'
        ];
        
        $product_name = $product_names[$product_type] ?? 'Art Rocket';
        $download_button_text = '–°–∫–∞—á–∞—Ç—å ' . $product_name;
        if ($current_version && $current_version != 'Trial') {
            $download_button_text .= ' v.' . $current_version;
        }
        
        $download_classes = 'ar-download-btn';
        $download_extra = 'download';
        
        if ($is_expired) { 
            $download_classes .= ' ar-download-btn--disabled'; 
            $download_extra = 'tabindex="-1" aria-disabled="true"'; 
        }
        
        if ($file_exists && !$is_expired) {
            // –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
            $download_url = add_query_arg(array(
                'license' => $reg_code,
                'type' => $product_type,
                'nonce' => wp_create_nonce('download_artrocket_' . $reg_code)
            ), home_url('/download.php'));
            
            echo '<a class="'.esc_attr($download_classes).'" href="'.esc_url($download_url).'" '.$download_extra.'>
                  '.esc_html($download_button_text).'
                </a>';
        } else {
            // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
            if (!$file_exists && !$is_expired) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã –≤ –¥—Ä—É–≥–∏—Ö –≤–µ—Ä—Å–∏—è—Ö
                $alternative_found = false;
                foreach ($file_paths as $type => $path) {
                    if ($type != $product_type && file_exists($path)) {
                        $download_url = add_query_arg(array(
                            'license' => $reg_code,
                            'type' => $type,
                            'nonce' => wp_create_nonce('download_artrocket_' . $reg_code)
                        ), home_url('/download.php'));
                        
                        echo '<a class="ar-download-btn" href="'.esc_url($download_url).'">
                              –°–∫–∞—á–∞—Ç—å ' . esc_html($product_names[$type] ?? $type) . ' (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
                            </a>';
                        $alternative_found = true;
                        break;
                    }
                }
                
                if (!$alternative_found) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    echo '<div class="ar-alert ar-alert--warning">
                            <strong>–§–∞–π–ª –¥–ª—è ' . esc_html($product_name) . ' –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</strong><br>
                            <small>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</small>
                          </div>';
                    echo '<a class="ar-download-btn ar-download-btn--disabled" href="#" tabindex="-1" aria-disabled="true">
                          '.esc_html($download_button_text).'
                        </a>';
                }
            } elseif ($is_expired) {
                echo '<a class="'.esc_attr($download_classes).'" href="#" '.$download_extra.'>
                      '.esc_html($download_button_text).'
                    </a>';
            }
        }
        
        // // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        // if (current_user_can('administrator')) {
        //     echo $debug_info;
            
        //     // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
        //     $files_info = '<div style="font-size: 11px; color: #666; margin: 5px 0;">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:<br>';
        //     foreach ($file_paths as $type => $path) {
        //         $exists = file_exists($path) ? '‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        //         $files_info .= '- ' . $type . ': ' . $exists . '<br>';
        //     }
        //     $files_info .= '</div>';
        //     echo $files_info;
        // }
        
        echo '</div>';

        echo '</div>'; // .ar-license-card
    }

    if (!$found_any) echo '<p>–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–∏—Ü–µ–Ω–∑–∏–π.</p>';
    
    return ob_get_clean();
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
function ar_display_products() {
    ob_start();
    ?>
    <div class="my-account-products">
        <ul class="products">
            <li class="product">
                <a href="https://art-rocket.ru/shop/trial-license/">
                    <img src="https://artrocket.ro/wp-content/uploads/2025/09/30-ile-1.png" alt="Trial License">
                    <h3>–ü—Ä–æ–±–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è</h3>
                    <span class="price">30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                </a>
                <a href="https://art-rocket.ru/shop/trial-license/" class="button">–í—ã–±—Ä–∞—Ç—å</a>
            </li>

            <li class="product">
                <a href="https://art-rocket.ru/shop/start-license/">
                    <img src="https://artrocket.ro/wp-content/uploads/2025/09/l2.png" alt="Business License">
                    <h3>–°—Ç–∞—Ä—Ç–æ–≤–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è 2 –º–µ—Å—è—Ü–∞</h3>
                    <span class="price">‚Ç¨99,00</span>
                </a>
                <a href="https://art-rocket.ru/shop/start-license/" class="button">–í—ã–±—Ä–∞—Ç—å</a>
            </li>

            <li class="product">
                <a href="https://art-rocket.ru/shop/pro-license/">
                    <img src="https://artrocket.ro/wp-content/uploads/2025/09/l3.png" alt="Pro License">
                    <h3>Pro –ª–∏—Ü–µ–Ω–∑–∏—è 6 –º–µ—Å—è—Ü–µ–≤</h3>
                    <span class="price">‚Ç¨1.794,00</span>
                </a>
                <a href="?add-to-cart=1633" class="button">–í—ã–±—Ä–∞—Ç—å</a>
            </li>

            <li class="product">
                <a href="https://art-rocket.ru/shop/business-license/">
                    <img src="https://artrocket.ro/wp-content/uploads/2025/09/l4.png" alt="Business License">
                    <h3>–ë–∏–∑–Ω–µ—Å –ª–∏—Ü–µ–Ω–∑–∏—è 12 –º–µ—Å—è—Ü–µ–≤</h3>
                    <span class="price">‚Ç¨1.188,00</span>
                </a>
                <a href="?add-to-cart=1629" class="button">–í—ã–±—Ä–∞—Ç—å</a>
            </li>
        </ul>
    </div>
    <?php
    return ob_get_clean();
}



// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö
function artrocket_show_file_status() {
    if (!current_user_can('administrator')) return;
    
    $upload_dir = wp_upload_dir();
    $base_path = $upload_dir['basedir'] . '/software-releases/';
    
    $versions = ['interior', 'furniture', 'trial'];
    $types = ['current', 'updates', 'prerelease'];
    
    echo '<div class="notice notice-info"><p><strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ Art Rocket:</strong></p>';
    
    foreach ($versions as $version) {
        echo '<p><strong>' . ucfirst($version) . ' –≤–µ—Ä—Å–∏—è:</strong><br>';
        
        foreach ($types as $type) {
            $file_path = '';
            $file_name = '';
            
            if ($type == 'current') {
                $file_path = $base_path . $type . '/' . $version . '/software.rbz';
                $file_name = 'software.rbz';
            } else {
                $file_path = $base_path . $type . '/' . $version . '/artrocket.tar.gz';
                $file_name = 'artrocket.tar.gz';
            }
            
            $exists = file_exists($file_path);
            $size = $exists ? size_format(filesize($file_path)) : '0 KB';
            $date = $exists ? date('Y-m-d H:i', filemtime($file_path)) : '‚Äî';
            
            $status = $exists ? '‚úÖ' : '‚ùå';
            
            echo $status . ' ' . $type . ': ' . $file_name . ' (' . $size . ', ' . $date . ')<br>';
        }
        
        echo '</p>';
    }
    
    echo '<p><a href="' . admin_url('admin.php?page=software-upload') . '">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–∞–Ω–µ–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏</a></p>';
    echo '</div>';
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ
add_action('admin_notices', 'artrocket_show_file_status');



function override_checkout_input_styles() {
    if (is_checkout()) {
        ?>
        <style type="text/css">
            /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å—ã body –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç–∏ */
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 input[type="text"],
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 input[type="email"],
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 input[type="tel"],
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 input[type="password"],
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 textarea,
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 select,
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 .wc-block-components-text-input input,
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 .wc-block-components-textarea textarea,
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 .wc-block-components-select select,
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 .wc-blocks-components-select .wc-blocks-components-select__select {
                background-color: #ffffff !important;
                color: #000000 !important;
                border: 1px solid #cccccc !important;
            }

            body.woocommerce-checkout.page-id-1578.elementor-page-1578 ::placeholder {
                color: #666666 !important;
            }

            body.woocommerce-checkout.page-id-1578.elementor-page-1578 select option {
                background-color: #ffffff !important;
                color: #000000 !important;
            }

            body.woocommerce-checkout.page-id-1578.elementor-page-1578 input:-webkit-autofill {
                -webkit-box-shadow: 0 0 0 1000px #ffffff inset !important;
                -webkit-text-fill-color: #000000 !important;
            }

            body.woocommerce-checkout.page-id-1578.elementor-page-1578 input:focus,
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 textarea:focus,
            body.woocommerce-checkout.page-id-1578.elementor-page-1578 select:focus {
                border-color: #ff9800 !important;
                outline: none !important;
            }
        </style>
        <?php
    }
}
add_action('wp_footer', 'override_checkout_input_styles');







/* ========== –õ–ò–¶–ï–ù–ó–ò–ò: –ê–î–ú–ò–ù + –§–ò–õ–¨–¢–†–´/–°–û–†–¢ + –®–û–†–¢–ö–û–î (SQL classic+HPOS + fallback) ========== */

/* ========== –õ–ò–¶–ï–ù–ó–ò–ò: –ê–î–ú–ò–ù + –§–ò–õ–¨–¢–†–´/–°–û–†–¢ + –®–û–†–¢–ö–û–î (—Ç–æ–ª—å–∫–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥) ========== */

/** –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ –º–µ–Ω—é */
add_action('admin_menu', function () {
    add_menu_page(
        '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏',
        '–õ–∏—Ü–µ–Ω–∑–∏–∏',
        'manage_options',
        'ar-license-manager',
        'ar_license_manager_page',
        'dashicons-lock',
        30
    );
});

/* ========================= –ë–ê–ó–ê: –ü–û–ò–°–ö –ò –•–ï–õ–ü–ï–†–´ ========================= */

/** –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã–¥–∞–Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏—è (–ö–õ–ê–°–°–ò–ß–ï–°–ö–ò–ô –ú–ï–¢–û–î) */
function ar_get_licensed_orders() {
    global $wpdb;

    // –ò—â–µ–º —Ç–æ–ª—å–∫–æ –≤ wp_postmeta
    $order_ids = (array) $wpdb->get_col("
        SELECT DISTINCT post_id
        FROM {$wpdb->postmeta}
        WHERE meta_key = '_license_reg_code'
          AND meta_value <> ''
    ");

    if (empty($order_ids)) return [];

    // –ë–µ—Ä—ë–º –∑–∞–∫–∞–∑—ã –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ post__in –∏ —Ç–æ–ª—å–∫–æ —Å —ç—Ç–∏–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
    $orders = wc_get_orders([
        'post__in' => array_map('intval', $order_ids),
        'status'   => ['completed','processing','on-hold'],
        'limit'    => -1,
        'orderby'  => 'date',
        'order'    => 'DESC',
        'return'   => 'objects',
    ]);

    return is_array($orders) ? $orders : [];
}

/** –ê–∫—Ç—É–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ (–∫—ç—à–∏—Ä—É–µ–º –≤ –º–µ—Ç—É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞) */
function ar_get_current_license_title_for_order($order){
    if (is_numeric($order)) $order = wc_get_order($order);
    if (!$order instanceof WC_Order) return '';

    $order_id = $order->get_id();

    // –∫–µ—à
    $title = get_post_meta($order_id, '_license_plan_title', true);
    if ($title) return wp_strip_all_tags($title);

    // –ø–æ–ø—ã—Ç–∫–∞ –≤–∑—è—Ç—å –∏–∑ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
    $reg = get_post_meta($order_id, '_license_reg_code', true);
    if ($reg) {
        $renew_orders = wc_get_orders([
            'limit'      => 1,
            'orderby'    => 'date',
            'order'      => 'DESC',
            'return'     => 'objects',
            'meta_query' => [[ 'key'=>'_renew_reg_code', 'value'=>$reg ]],
            'status'     => array_keys( wc_get_order_statuses() ),
        ]);
        if (!empty($renew_orders)) {
            $ro = $renew_orders[0];
            foreach ($ro->get_items() as $it) {
                $p = $it->get_product();
                if ($p) {
                    $t = $p->is_type('variation') ? get_the_title($p->get_parent_id()) : $p->get_name();
                    $t = wp_strip_all_tags($t);
                    if ($t) {
                        update_post_meta($order_id, '_license_plan_title', $t);
                        update_post_meta(
                            $order_id, '_license_plan_product_id',
                            $p->is_type('variation') ? $p->get_parent_id() : $p->get_id()
                        );
                        return $t;
                    }
                }
            }
        }
    }

    // fallback ‚Äî –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
    foreach ($order->get_items() as $it) {
        $p = $it->get_product();
        if ($p) {
            $t = $p->is_type('variation') ? get_the_title($p->get_parent_id()) : $p->get_name();
            if ($t) return wp_strip_all_tags($t);
        }
    }
    return '';
}

/** –°—Ç–∞—Ç—É—Å –ø–æ –¥–∞—Ç–µ */
function ar_license_status_from_expiry($expires_ymd){
    if (!$expires_ymd) return ['label'=>'‚Äî','code'=>'none'];
    $ts = strtotime($expires_ymd.' 23:59:59');
    if ($ts === false) return ['label'=>'‚Äî','code'=>'none'];
    if ($ts < time()) return ['label'=>'–ò—Å—Ç–µ–∫–ª–∞','code'=>'expired'];
    if ($ts < time()+30*DAY_IN_SECONDS) return ['label'=>'–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç','code'=>'soon'];
    return ['label'=>'–ê–∫—Ç–∏–≤–Ω–∞','code'=>'active'];
}

/** –°–æ–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */
function ar_collect_license_rows($orders){
    $rows = [];
    foreach ($orders as $order) {
        if (!$order instanceof WC_Order) continue;

        $order_id     = $order->get_id();
        $order_date   = $order->get_date_created();
        $reg_code     = (string) get_post_meta($order_id, '_license_reg_code', true);
        if ($reg_code === '') continue;

        $license_json = get_post_meta($order_id, '_license_key_json', true);
        $expires      = get_post_meta($order_id, '_license_expires', true);
        $pool         = 1;
        $email        = $order->get_billing_email();
        $name         = $order->get_formatted_billing_full_name();

        if ($license_json && ($decoded = json_decode($license_json, true))) {
            if (isset($decoded['pool'])) $pool = (int)$decoded['pool'];
            if (!empty($decoded['data'])) {
                $inner = json_decode(base64_decode($decoded['data']), true);
                if (is_array($inner)) {
                    $email   = $inner['email']   ?? $email;
                    $name    = $inner['name']    ?? $name;
                    $expires = $inner['expires'] ?? $expires;
                }
            }
        } else {
            $q=0; foreach($order->get_items() as $it){ $q += (int)$it->get_quantity(); }
            if ($q>0) $pool=$q;
        }

        $title  = ar_get_current_license_title_for_order($order);
        $status = ar_license_status_from_expiry($expires);

        $rows[] = [
            'order_id'   => $order_id,
            'name'       => (string)$name,
            'email'      => (string)$email,
            'title'      => (string)$title,
            'reg'        => (string)$reg_code,
            'pool'       => (int)$pool,
            'expires'    => $expires ?: '',
            'status_lbl' => $status['label'],
            'status'     => $status['code'],
            'order_dt'   => $order_date ? $order_date->getTimestamp() : 0,
            'order_dt_h' => $order_date ? $order_date->date('d.m.Y H:i') : '‚Äî',
        ];
    }
    return $rows;
}

/** –§–∏–ª—å—Ç—Ä—ã/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */
function ar_filter_sort_license_rows(array $rows, array $q){
    $title_like = isset($q['flt_title'])    ? trim((string)$q['flt_title']) : '';
    $pool_min   = (isset($q['flt_pool_min']) && $q['flt_pool_min']!=='') ? (int)$q['flt_pool_min'] : null;
    $pool_max   = (isset($q['flt_pool_max']) && $q['flt_pool_max']!=='') ? (int)$q['flt_pool_max'] : null;
    $status_in  = isset($q['flt_status'])   ? (string)$q['flt_status'] : '';
    $od_from    = isset($q['flt_od_from'])  ? (string)$q['flt_od_from'] : '';
    $od_to      = isset($q['flt_od_to'])    ? (string)$q['flt_od_to']   : '';
    $ex_from    = isset($q['flt_ex_from'])  ? (string)$q['flt_ex_from'] : '';
    $ex_to      = isset($q['flt_ex_to'])    ? (string)$q['flt_ex_to']   : '';

    $od_from_ts = $od_from ? strtotime($od_from.' 00:00:00') : null;
    $od_to_ts   = $od_to   ? strtotime($od_to  .' 23:59:59') : null;
    $ex_from_ts = $ex_from ? strtotime($ex_from.' 00:00:00') : null;
    $ex_to_ts   = $ex_to   ? strtotime($ex_to  .' 23:59:59') : null;

    $rows = array_values(array_filter($rows, function($r) use ($title_like,$pool_min,$pool_max,$status_in,$od_from_ts,$od_to_ts,$ex_from_ts,$ex_to_ts){
        if ($title_like !== '' && stripos((string)$r['title'], $title_like) === false) return false;
        if ($pool_min !== null && (int)$r['pool'] < $pool_min) return false;
        if ($pool_max !== null && (int)$r['pool'] > $pool_max) return false;
        if ($status_in !== '' && (string)$r['status'] !== $status_in) return false;

        if ($od_from_ts !== null && (int)$r['order_dt'] < $od_from_ts) return false;
        if ($od_to_ts   !== null && (int)$r['order_dt'] > $od_to_ts)   return false;

        $ex_ts = $r['expires'] ? strtotime($r['expires'].' 12:00:00') : null;
        if ($ex_from_ts !== null && ($ex_ts === null || $ex_ts < $ex_from_ts)) return false;
        if ($ex_to_ts   !== null && ($ex_ts === null || $ex_ts > $ex_to_ts))   return false;

        return true;
    }));

    $sort = $q['sort'] ?? 'order_dt';
    $dir  = strtolower($q['dir'] ?? 'desc');
    $dirm = ($dir==='asc') ? 1 : -1;

    $keymap = ['title'=>'title','pool'=>'pool','status'=>'status','order_dt'=>'order_dt','expires'=>'expires','order_id'=>'order_id'];
    $k = $keymap[$sort] ?? 'order_dt';

    usort($rows, function($a,$b) use ($k,$dirm){
        $va=$a[$k]??null; $vb=$b[$k]??null;
        if (in_array($k, ['order_dt','pool','order_id'], true)) return $dirm * ((int)$va <=> (int)$vb);
        return $dirm * strnatcasecmp((string)$va,(string)$vb);
    });
    return $rows;
}

/** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–± –∑–∞–ø–∏—Å–∏ –º–µ—Ç–∞) */
function ar_update_license($order_id, $new_pool, $new_expires) {
    $order = wc_get_order($order_id);
    if (!$order) return false;

    $reg_code     = get_post_meta($order_id, '_license_reg_code', true);
    $current_json = get_post_meta($order_id, '_license_key_json', true);
    if (!$reg_code || !$current_json) return false;

    $decoded = json_decode($current_json, true);
    if (!$decoded || empty($decoded['data'])) return false;

    $inner = json_decode(base64_decode($decoded['data']), true);
    if (!is_array($inner)) return false;

    $name  = $inner['name']  ?? $order->get_formatted_billing_full_name();
    $email = $inner['email'] ?? $order->get_billing_email();

    // —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É —Å–µ–±—è
    $new_json = ar_generate_license_json($name, $email, $reg_code, $new_expires, (int)$new_pool);
    if (!$new_json) return false;

    update_post_meta($order_id, '_license_key_json', $new_json);
    update_post_meta($order_id, '_license_expires',  $new_expires);

    $file = ar_save_license_file($order_id, $new_json);
    if ($file) {
        list($abs,$url,$fn) = $file;
        update_post_meta($order_id,'_license_file_path',$abs);
        update_post_meta($order_id,'_license_file_url', $url);
        update_post_meta($order_id,'_license_file_name',$fn);
    }

    return true;
}

/* ========================= –†–ï–ù–î–ï–† –ü–ê–ù–ï–õ–ò ========================= */

function ar_render_license_panel($context = 'admin', $can_edit = false) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    $update_message = '';
    if (isset($_POST['ar_update_license_submit']) && $can_edit) {
        $nonce_ok = isset($_POST['_ar_lic_nonce']) && wp_verify_nonce($_POST['_ar_lic_nonce'], 'ar_lic_edit');
        if ($nonce_ok) {
            $order_id    = (int) $_POST['order_id'];
            $new_pool    = max(1, (int) $_POST['pool']);
            $new_expires = sanitize_text_field($_POST['expires']);

            if ($order_id && preg_match('/^\d{4}-\d{2}-\d{2}$/', $new_expires)) {
                $update_message = ar_update_license($order_id, $new_pool, $new_expires)
                    ? '<div class="notice notice-success" style="margin:12px 0"><p>‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.</p></div>'
                    : '<div class="notice notice-error" style="margin:12px 0"><p>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏.</p></div>';
            } else {
                $update_message = '<div class="notice notice-error" style="margin:12px 0"><p>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã.</p></div>';
            }
        } else {
            $update_message = '<div class="notice notice-error" style="margin:12px 0"><p>‚ùå –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p></div>';
        }
    }

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    $q = [
        'flt_title'   => isset($_GET['flt_title'])    ? sanitize_text_field($_GET['flt_title'])    : '',
        'flt_pool_min'=> isset($_GET['flt_pool_min']) ? sanitize_text_field($_GET['flt_pool_min']) : '',
        'flt_pool_max'=> isset($_GET['flt_pool_max']) ? sanitize_text_field($_GET['flt_pool_max']) : '',
        'flt_status'  => isset($_GET['flt_status'])   ? sanitize_text_field($_GET['flt_status'])   : '',
        'flt_od_from' => isset($_GET['flt_od_from'])  ? sanitize_text_field($_GET['flt_od_from'])  : '',
        'flt_od_to'   => isset($_GET['flt_od_to'])    ? sanitize_text_field($_GET['flt_od_to'])    : '',
        'flt_ex_from' => isset($_GET['flt_ex_from'])  ? sanitize_text_field($_GET['flt_ex_from'])  : '',
        'flt_ex_to'   => isset($_GET['flt_ex_to'])    ? sanitize_text_field($_GET['flt_ex_to'])    : '',
        'sort'        => isset($_GET['sort'])         ? sanitize_text_field($_GET['sort'])         : 'order_dt',
        'dir'         => isset($_GET['dir'])          ? sanitize_text_field($_GET['dir'])          : 'desc',
    ];

    $orders = ar_get_licensed_orders();
    $rows   = ar_filter_sort_license_rows(ar_collect_license_rows($orders), $q);

    // CSS
// CSS
echo '<style>
/* –ë–ê–ó–ê */
.ar-lic-wrap{position:relative;width:100%;max-width:100%;box-sizing:border-box}
.ar-lic-wrap *{box-sizing:border-box}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π */
.ar-instructiuni-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: 56px;
    padding: 0 20px;
    border-radius: 12px;
    text-decoration: none !important;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.2px;
    text-align: center;
    transition: all 0.3s ease;
    background: #10b981;
    border: 1px solid #10b981;
    color: #ffffff;
    flex: 0 0 auto;
    white-space: nowrap;
}

.ar-instructiuni-btn:hover {
    background: #0da271;
    border-color: #0da271;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–Ω–æ–ø–æ–∫ */
.ar-download-wrap {
    margin-top: 15px;
    display: flex;
    gap: 12px;
    align-items: stretch;
}

.ar-download-btn {
    flex: 1 1 0%;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 56px;
    padding: 0 16px;
    border-radius: 12px;
    text-decoration: none !important;
    font-weight: 600;
    font-size: 16px;
    letter-spacing: .2px;
    text-align: center;
    transition: all 0.3s ease;
    background: #e65c00;
    color: #ffffff !important;
    border: 1px solid #e65c00;
}

.ar-download-btn:hover {
    background: #cc4c00;
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(230, 92, 0, 0.3);
}

.ar-download-btn--disabled {
    opacity: .55;
    pointer-events: none;
    filter: grayscale(65%);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
@media (max-width: 768px) {
    .ar-download-wrap {
        flex-direction: column;
    }
    
    .ar-tech-req-btn,
    .ar-instructiuni-btn {
        order: 2;
        min-height: 48px;
    }
    
    .ar-download-btn {
        order: 1;
        min-height: 48px;
    }
}

@media (max-width: 480px) {
    .ar-tech-req-btn,
    .ar-instructiuni-btn,
    .ar-download-btn {
        font-size: 14px;
        padding: 0 12px;
    }
}

/* –õ–æ–≥–∏–Ω-–ø–∞–Ω–µ–ª—å: —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
.ar-panel-login,
.ar-panel-login * { color:#111827 !important; }

.ar-panel-login input[type="password"]{
  color:#333333 !important;
  background:#c3c3c3 !important;
  border-color:#d1d5db !important;
}

.ar-panel-login ::placeholder{ color:#6b7280 !important; } /* –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å–µ—Ä—ã–º */


/* ===== –§–ò–õ–¨–¢–†–´ ===== */
.ar-lic-filters{
  margin:20px 0;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
  align-items:end
}
.ar-lic-filters label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
  font-size:13px;
  color:#fff !important;             /* –±–µ–ª—ã–µ –ø–æ–¥–ø–∏—Å–∏ ‚Äî –≤–∏–¥–Ω–æ –≤ —Ç–µ–º–Ω—ã—Ö —Ç–µ–º–∞—Ö */
}
.ar-lic-filters input[type="text"],
.ar-lic-filters input[type="date"],
.ar-lic-filters input[type="number"],
.ar-lic-filters select{
  width:100%;
  padding:8px 10px;
  border:1px solid #d1d5db;
  border-radius:6px;
  background:#fff !important;        /* –ø–æ–ª—è –Ω–∞ –±–µ–ª–æ–º */
  color:#111827 !important;          /* —Ç—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
}
.ar-lic-filters ::placeholder{color:#6b7280}
@media (max-width:768px){
  .ar-lic-filters{grid-template-columns:1fr}
}

/* ===== –¢–ê–ë–õ–ò–¶–ê ===== */
.ar-lic-table-container{
  width:100%;
  overflow-x:auto;
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#fff !important;
  margin:20px 0
}
.ar-lic-table{
  width:100%;
  min-width:1200px;
  border-collapse:separate;
  border-spacing:0;
  font-size:13px;
  line-height:1.45;
  color:#111827 !important;
}
.ar-lic-table th{
  position:sticky;top:0;z-index:1;
  background:#2d2f33 !important;     /* –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è —à–∞–ø–∫–∞ */
  color:#fff !important;
  padding:12px 10px;
  text-align:left;
  font-weight:600;
  border-bottom:1px solid #1f2124
}
.ar-lic-table td{
  padding:10px 10px;
  border-bottom:1px solid #f1f5f9;
  vertical-align:middle;
  background:#ffffff;
  color:#111827 !important
}
.ar-lic-table tr:hover td{background:#f8fafc}
/* –∑–µ–±—Ä–∞ */
.ar-lic-table tbody tr:nth-child(odd) td{background:#fcfdff}

/* –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è */
.ar-lic-table td:nth-child(2), /* –ö–ª–∏–µ–Ω—Ç */
.ar-lic-table td:nth-child(3){ /* Email  */
  max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}

/* Registration Code */
.ar-lic-table code{
  display:inline-block;
  background:#eef2f7;
  border:1px solid #dbe2ea;
  color:#0f172a !important;
  padding:3px 7px;
  border-radius:6px;
  font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
  font-size:11px;
  max-width:180px;
  overflow:hidden;
  text-overflow:ellipsis
}

/* ===== –°–¢–ê–¢–£–°–´ ===== */
.status-active,.status-soon,.status-expired{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-weight:700;
  line-height:1
}
.status-active{color:#065f46;background:#d1fae5;border:1px solid #34d399}
.status-soon{color:#92400e;background:#fef3c7;border:1px solid #f59e0b}
.status-expired{color:#7f1d1d;background:#fee2e2;border:1px solid #ef4444}

/* ===== –ö–ù–û–ü–ö–ò ===== */
.button{
  display:inline-block;
  padding:8px 16px;
  background:#2271b1;
  color:#fff !important;
  text-decoration:none;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-size:13px
}
.button:hover{background:#135e96}
.button-primary{background:#007cba}.button-primary:hover{background:#006ba1}
.button-small{padding:6px 10px;font-size:12px;border-radius:7px}

/* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
.notice{padding:12px;margin:12px 0;border-left:4px solid;border-radius:8px}
.notice-success{background:#ecfdf5;border-color:#10b981;color:#064e3b}
.notice-error{background:#fef2f2;border-color:#ef4444;color:#7f1d1d}
.notice-info{background:#eff6ff;border-color:#3b82f6;color:#1e3a8a}

/* ===== MODAL: –ø—Ä–∞–≤–∫–∞ ===== */
.ar-lic-modal{
  position:fixed;
  inset:0;
  display:none;                    /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞ */
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
  z-index:999999;                  /* –≤—ã—à–µ sticky/–∞–¥–º–∏–Ω-–±–∞—Ä–æ–≤ */
}

/* –ø–æ–∫–∞–∂–∏ –º–æ–¥–∞–ª–∫—É –ª–∏–±–æ —á–µ—Ä–µ–∑ inline style "display:flex", –ª–∏–±–æ –∫–ª–∞—Å—Å–æ–º .is-open */
.ar-lic-modal[style*="display: flex"],
.ar-lic-modal.is-open{ display:flex !important; }

.ar-lic-modal-content{
  background:#fff;
  color:#111827;
  width:min(560px,94vw);
  max-height:85vh;
  overflow:auto;
  padding:24px 24px 16px;
  border-radius:12px;
  box-shadow:0 20px 60px rgba(0,0,0,.35);
  border:1px solid #e5e7eb;
}

.ar-lic-modal h3{margin:0 0 12px;font-size:18px;line-height:1.25;color:#111827}

/* —Ç–∞–±–ª–∏—Ü–∞ —Ñ–æ—Ä–º—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
.ar-lic-modal .form-table{width:100%;border-collapse:separate;border-spacing:0}
.ar-lic-modal .form-table th{width:42%;padding:8px 12px;text-align:left;color:#111827}
.ar-lic-modal .form-table td{padding:8px 12px}

.ar-lic-modal input[type="number"],
.ar-lic-modal input[type="date"]{
  width:100%;
  padding:8px 10px;
  border:1px solid #d1d5db;
  border-radius:6px;
  background:#fff;
  color:#111827;
}

.ar-lic-modal .description{margin:.25rem 0 0;color:#6b7280;font-size:12px}

.ar-lic-modal .submit{margin-top:14px;text-align:right}
.ar-lic-modal .button{border-radius:8px}
.ar-lic-modal .button.button-primary{background:#ff7a00}         /* –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ */
.ar-lic-modal .button.button-primary:hover{background:#e56e00}








</style>';


    // –í—ã–≤–æ–¥
    echo '<div class="ar-lic-wrap">';

    if ($update_message) echo $update_message;

    // –§–∏–ª—å—Ç—Ä—ã
    echo '<form method="get" class="ar-lic-filters">';
    if ($context === 'admin') {
        echo '<input type="hidden" name="page" value="ar-license-manager">';
    } else {
        echo '<input type="hidden" name="p" value="' . get_the_ID() . '">';
    }

    echo '
        <div>
            <label>–¢–∏–ø –ª–∏—Ü–µ–Ω–∑–∏–∏</label>
            <input type="text" name="flt_title" value="'.esc_attr($q['flt_title']).'" placeholder="Pro / Trial">
        </div>
        <div>
            <label>Pool min</label>
            <input type="number" name="flt_pool_min" value="'.esc_attr($q['flt_pool_min']).'" min="1" step="1" placeholder="–ú–∏–Ω–∏–º—É–º">
        </div>
        <div>
            <label>Pool max</label>
            <input type="number" name="flt_pool_max" value="'.esc_attr($q['flt_pool_max']).'" min="1" step="1" placeholder="–ú–∞–∫—Å–∏–º—É–º">
        </div>
        <div>
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select name="flt_status">
                <option value="" '.selected($q['flt_status'],'',false).'>‚Äî –ª—é–±–æ–π ‚Äî</option>
                <option value="active" '.selected($q['flt_status'],'active',false).'>–ê–∫—Ç–∏–≤–Ω–∞</option>
                <option value="soon"   '.selected($q['flt_status'],'soon',false).'>–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç</option>
                <option value="expired"'.selected($q['flt_status'],'expired',false).'>–ò—Å—Ç–µ–∫–ª–∞</option>
            </select>
        </div>
        <div>
            <label>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ –æ—Ç</label>
            <input type="date" name="flt_od_from" value="'.esc_attr($q['flt_od_from']).'">
        </div>
        <div>
            <label>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ –¥–æ</label>
            <input type="date" name="flt_od_to" value="'.esc_attr($q['flt_od_to']).'">
        </div>
        <div>
            <label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç</label>
            <input type="date" name="flt_ex_from" value="'.esc_attr($q['flt_ex_from']).'">
        </div>
        <div>
            <label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ</label>
            <input type="date" name="flt_ex_to" value="'.esc_attr($q['flt_ex_to']).'">
        </div>
        <div style="display:flex;gap:8px;align-items:end;">
            <button class="button button-primary" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <a class="button" href="'.esc_url(remove_query_arg(['flt_title','flt_pool_min','flt_pool_max','flt_status','flt_od_from','flt_od_to','flt_ex_from','flt_ex_to','sort','dir'])).'">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
        <div style="display:flex;gap:8px;align-items:end;">
            <label style="min-width:80px;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select name="sort" style="flex:1;">
                <option value="order_id" '.selected($q['sort'],'order_id',false).'>ID –∑–∞–∫–∞–∑–∞</option>
                <option value="order_dt" '.selected($q['sort'],'order_dt',false).'>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</option>
                <option value="title"    '.selected($q['sort'],'title',false).'>–¢–∏–ø –ª–∏—Ü–µ–Ω–∑–∏–∏</option>
                <option value="pool"     '.selected($q['sort'],'pool',false).'>Pool</option>
                <option value="status"   '.selected($q['sort'],'status',false).'>–°—Ç–∞—Ç—É—Å</option>
                <option value="expires"  '.selected($q['sort'],'expires',false).'>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</option>
            </select>
            <select name="dir" style="width:120px;">
                <option value="asc"  '.selected($q['dir'],'asc',false).'>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                <option value="desc" '.selected($q['dir'],'desc',false).'>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
            </select>
        </div>
    </form>';

    echo '<div style="margin:20px 0;padding:12px;background:#333333;border-radius:4px;">';
    echo '<strong>–ù–∞–π–¥–µ–Ω–æ –ª–∏—Ü–µ–Ω–∑–∏–π: ' . count($rows) . '</strong>';
   
    echo '</div>';

    // –¢–∞–±–ª–∏—Ü–∞
    if (!empty($rows)) {
        echo '<div class="ar-lic-table-container"><table class="ar-lic-table"><thead><tr>';
        $headers = [
            'order_id' => 'ID –∑–∞–∫–∞–∑–∞',
            'name'     => '–ö–ª–∏–µ–Ω—Ç',
            'email'    => 'Email',
            'title'    => '–õ–∏—Ü–µ–Ω–∑–∏—è',
            'reg'      => 'Registration Code',
            'pool'     => 'Pool',
            'expires'  => '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è',
            'status'   => '–°—Ç–∞—Ç—É—Å',
            'order_dt' => '–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞',
        ];
        if ($can_edit) $headers['actions'] = '–î–µ–π—Å—Ç–≤–∏—è';
        foreach ($headers as $key => $label) {
            $class = in_array($key, ['name','email'], true) ? 'style="min-width:200px;"' : '';
            echo '<th '.$class.'>'.esc_html($label).'</th>';
        }
        echo '</tr></thead><tbody>';

        foreach ($rows as $r) {
            $status_class = 'status-' . $r['status'];
            echo '<tr>';
            echo '<td>#' . esc_html($r['order_id']) . '</td>';
            echo '<td>' . esc_html($r['name']) . '</td>';
            echo '<td>' . esc_html($r['email']) . '</td>';
            echo '<td>' . esc_html($r['title'] ?: '‚Äî') . '</td>';
            echo '<td><code title="' . esc_attr($r['reg']) . '">' . esc_html($r['reg']) . '</code></td>';
            echo '<td>' . esc_html($r['pool']) . '</td>';
            echo '<td>' . ($r['expires'] ? esc_html(date('d.m.Y', strtotime($r['expires']))) : '‚Äî') . '</td>';
            echo '<td><span class="' . esc_attr($status_class) . '">' . esc_html($r['status_lbl']) . '</span></td>';
            echo '<td>' . esc_html($r['order_dt_h']) . '</td>';
            if ($can_edit) {
                echo '<td><button type="button" class="button button-small ar-edit-license" 
                        data-order="' . esc_attr($r['order_id']) . '"
                        data-pool="' . esc_attr($r['pool']) . '"
                        data-expires="' . esc_attr($r['expires']) . '">–ò–∑–º–µ–Ω–∏—Ç—å</button></td>';
            }
            echo '</tr>';
        }

        echo '</tbody></table></div>';
    } else {
        echo '<div class="notice notice-info"><p>–õ–∏—Ü–µ–Ω–∑–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p></div>';
    }

    // –ú–æ–¥–∞–ª–∫–∞
    if ($can_edit) {
        echo '
        <div id="ar-license-edit-modal" class="ar-lic-modal">
            <div class="ar-lic-modal-content">
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏</h3>
                <form method="post">
                    ' . wp_nonce_field('ar_lic_edit', '_ar_lic_nonce', true, false) . '
                    <input type="hidden" name="order_id" id="ar-edit-order-id">
                    <table class="form-table">
                        <tr>
                            <th scope="row"><label for="ar-edit-pool">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:</label></th>
                            <td>
                                <input type="number" id="ar-edit-pool" name="pool" min="1" max="100" value="1" class="regular-text" required>
                                <p class="description">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π</p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="ar-edit-expires">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</label></th>
                            <td>
                                <input type="date" id="ar-edit-expires" name="expires" class="regular-text" required>
                                <p class="description">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏</p>
                            </td>
                        </tr>
                    </table>
                    <p class="submit">
                        <button type="submit" name="ar_update_license_submit" class="button button-primary">–û–±–Ω–æ–≤–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</button>
                        <button type="button" class="button ar-cancel-edit">–û—Ç–º–µ–Ω–∞</button>
                    </p>
                </form>
            </div>
        </div>';
    }

    // JS
    echo '<script>
    document.addEventListener("DOMContentLoaded", function() {
        var editButtons = document.querySelectorAll(".ar-edit-license");
        var modal = document.getElementById("ar-license-edit-modal");
        var cancelBtn = document.querySelector(".ar-cancel-edit");
        if (editButtons.length && modal) {
            editButtons.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    var orderId = this.getAttribute("data-order");
                    var pool = this.getAttribute("data-pool");
                    var expires = this.getAttribute("data-expires");
                    document.getElementById("ar-edit-order-id").value = orderId;
                    document.getElementById("ar-edit-pool").value = pool || 1;
                    document.getElementById("ar-edit-expires").value = expires || "";
                    modal.style.display = "flex";
                });
            });
            if (cancelBtn) cancelBtn.addEventListener("click", function(){ modal.style.display = "none"; });
            modal.addEventListener("click", function(e){ if (e.target === modal) modal.style.display = "none"; });
        }
        var tableContainer = document.querySelector(".ar-lic-table-container");
        if (tableContainer) tableContainer.style.overflowX = "auto";
    });
    </script>';

    echo '</div>'; // .ar-lic-wrap
}

/** –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–¥–º–∏–Ω–∫–∏ */
function ar_license_manager_page() {
    if (!current_user_can('manage_options')) wp_die('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    echo '<div class="wrap"><h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏</h1>';
    ar_render_license_panel('admin', true);
    echo '</div>';
}

/** –®–æ—Ä—Ç–∫–æ–¥: [ar_license_panel edit="yes" password="..."] */
add_shortcode('ar_license_panel', function($atts) {
    $atts = shortcode_atts(['edit' => 'no', 'password' => ''], $atts, 'ar_license_panel');

    // ---- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cookie
    $page_id   = get_queried_object_id() ?: 0;
    $cookie_key = 'ar_panel_auth_' . $page_id;
    $cookie_path   = defined('COOKIEPATH') && COOKIEPATH ? COOKIEPATH : '/';
    $cookie_domain = defined('COOKIE_DOMAIN') ? COOKIE_DOMAIN : '';
    $expected_hash = $atts['password'] !== '' ? hash_hmac('sha256', (string)$atts['password'], wp_salt('auth')) : '';

    // helper –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookie —Å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é
    $set_auth_cookie = function($value, $ttl_seconds) use ($cookie_key,$cookie_path,$cookie_domain){
        if (PHP_VERSION_ID >= 70300) {
            setcookie($cookie_key, $value, [
                'expires'  => time() + (int)$ttl_seconds,
                'path'     => $cookie_path,
                'domain'   => $cookie_domain ?: '',
                'secure'   => is_ssl(),
                'httponly' => true,
                'samesite' => 'Lax',
            ]);
        } else {
            // –§–æ–ª–±—ç–∫ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ PHP
            setcookie($cookie_key, $value, time() + (int)$ttl_seconds, $cookie_path . '; samesite=Lax', $cookie_domain ?: '', is_ssl(), true);
        }
        $_COOKIE[$cookie_key] = $value; // –¥–æ—Å—Ç—É–ø —Å—Ä–∞–∑—É –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
    };
    $delete_auth_cookie = function() use ($cookie_key,$cookie_path,$cookie_domain){
        if (PHP_VERSION_ID >= 70300) {
            setcookie($cookie_key, '', [
                'expires'  => time() - 3600,
                'path'     => $cookie_path,
                'domain'   => $cookie_domain ?: '',
                'secure'   => is_ssl(),
                'httponly' => true,
                'samesite' => 'Lax',
            ]);
        } else {
            setcookie($cookie_key, '', time() - 3600, $cookie_path . '; samesite=Lax', $cookie_domain ?: '', is_ssl(), true);
        }
        unset($_COOKIE[$cookie_key]);
    };

    // ---- –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    $is_admin   = current_user_can('manage_options');
    $has_pass   = ($atts['password'] !== ''); // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º empty(), —á—Ç–æ–±—ã '0' –Ω–µ —Å—á–∏—Ç–∞–ª–∞—Å—å –ø—É—Å—Ç–æ–π
    $cookie_ok  = ($has_pass && isset($_COOKIE[$cookie_key]) && hash_equals($_COOKIE[$cookie_key], $expected_hash));

    // –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è
    if ($has_pass && isset($_POST['ar_panel_password'])) {
        $input = (string) $_POST['ar_panel_password'];
        if (hash_equals($input, (string)$atts['password'])) {
            $cookie_ok = true;
            $set_auth_cookie($expected_hash, 3600); // 1 —á–∞—Å
        }
    }

    // –ª–æ–≥–∞—É—Ç
    if (isset($_POST['ar_panel_logout'])) {
        $delete_auth_cookie();
        // –º—è–≥–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç: —É–±–∏—Ä–∞–µ–º GET-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        echo '<script>location.href = location.href.split("?")[0];</script>';
        return ''; // –¥–∞–ª—å—à–µ –Ω–µ —Ä–∏—Å—É–µ–º
    }

    // —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    // –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å –¥–∞–∂–µ –æ—Ç –∞–¥–º–∏–Ω–∞ ‚Äî —É–±–µ—Ä–∏—Ç–µ "$is_admin ||" –∏–∑ —Å—Ç—Ä–æ–∫–∏ –Ω–∏–∂–µ
    $can_edit = false;
    if ($atts['edit'] === 'yes') {
        if ($has_pass) {
            $can_edit = ($is_admin || $cookie_ok);
        } else {
            $can_edit = $is_admin;
        }
    }

    ob_start();

    // —ç–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è (—Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞)
if ($atts['edit'] === 'yes' && $has_pass && !$can_edit) {
    echo '<div class="ar-login-overlay" style="
        position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
        background:rgba(0,0,0,.6);z-index:999999;">
        <div class="ar-panel-login" style="
            width:min(420px,90vw);margin:0;padding:24px;border:1px solid #ddd;
            border-radius:25px;background:#000000;color:#ffffff;">
            <h3 style="text-align:center;margin:0 0 20px;">–î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
            <form method="post">
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" name="ar_panel_password" required
                        style="width:100%;padding:10px;border:1px solid #ddd;border-radius:25px;
                               background:#ffffff;color:#111827;">
                </div>
                <button type="submit" class="button button-primary" style="width:100%;">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>
    <script>
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞, –ø–æ–∫–∞ –æ—Ç–∫—Ä—ã—Ç –æ–≤–µ—Ä–ª–µ–π
      (function(){ try{ document.body.style.overflow = "hidden"; }catch(e){} })();
    </script>';
} else {
    // —Å–∞–º–∞ –ø–∞–Ω–µ–ª—å
    ar_render_license_panel('frontend', $can_edit);

    // –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞, –µ—Å–ª–∏ –≤–æ—à–ª–∏ –ø–æ –ø–∞—Ä–æ–ª—é (–∏ –Ω–µ –∞–¥–º–∏–Ω –±–µ–∑ –ø–∞—Ä–æ–ª—è)
    if ($atts['edit'] === 'yes' && $has_pass && $cookie_ok && !$is_admin) {
        echo '<div style="text-align:center;margin-top:20px;">
                <form method="post"><input type="hidden" name="ar_panel_logout" value="1">
                    <button type="submit" class="button" style="background:#dc3545;">–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                </form>
              </div>';
    }
}


    return ob_get_clean();
});


/* ========= –ö–æ–ª–æ–Ω–∫–∏ –≤ —Å–ø–∏—Å–∫–∞—Ö –∑–∞–∫–∞–∑–æ–≤ ========= */
add_filter('manage_edit-shop_order_columns', function($columns){
    $new=[]; foreach($columns as $k=>$v){ $new[$k]=$v; if($k==='order_status'){ $new['ar_license']=__('–õ–∏—Ü–µ–Ω–∑–∏—è','ar'); } }
    return $new;
});
add_action('manage_shop_order_posts_custom_column', function($column){
    if($column!=='ar_license') return;
    $order = wc_get_order(get_the_ID());
    if(!$order){ echo '‚Äî'; return; }
    if(!(string)get_post_meta($order->get_id(), '_license_reg_code', true)){ echo '‚Äî'; return; }
    $expires = get_post_meta($order->get_id(), '_license_expires', true);
    $title   = ar_get_current_license_title_for_order($order);
    $icon='‚úÖ'; $tip='–ê–∫—Ç–∏–≤–Ω–∞';
    if($expires){
        $ts=strtotime($expires.' 23:59:59');
        if($ts<time()){ $icon='‚ùå'; $tip='–ò—Å—Ç–µ–∫–ª–∞: '.date('d.m.Y',$ts); }
        elseif($ts<time()+30*DAY_IN_SECONDS){ $icon='‚ö†Ô∏è'; $tip='–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç: '.date('d.m.Y',$ts); }
        else{ $tip='–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: '.date('d.m.Y',$ts); }
    }
    echo '<span title="'.esc_attr($tip).'">'.$icon.'</span> '.esc_html($title ?: '‚Äî');
},10);

add_filter('manage_woocommerce_page_wc-orders_columns', function($columns){
    $new=[]; foreach($columns as $k=>$v){ $new[$k]=$v; if($k==='order_status'){ $new['ar_license']=__('–õ–∏—Ü–µ–Ω–∑–∏—è','ar'); } }
    return $new;
});
add_action('manage_woocommerce_page_wc-orders_custom_column', function($column,$order){
    if($column!=='ar_license' || !$order instanceof WC_Order) return;
    if(!(string)$order->get_meta('_license_reg_code')){ echo '‚Äî'; return; }
    $expires = $order->get_meta('_license_expires');
    $title   = ar_get_current_license_title_for_order($order);
    $icon='‚úÖ'; $tip='–ê–∫—Ç–∏–≤–Ω–∞';
    if($expires){
        $ts=strtotime($expires.' 23:59:59');
        if($ts<time()){ $icon='‚ùå'; $tip='–ò—Å—Ç–µ–∫–ª–∞: '.date('d.m.Y',$ts); }
        elseif($ts<time()+30*DAY_IN_SECONDS){ $icon='‚ö†Ô∏è'; $tip='–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç: '.date('d.m.Y',$ts); }
        else{ $tip='–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: '.date('d.m.Y',$ts); }
    }
    echo '<span title="'.esc_attr($tip).'">'.$icon.'</span> '.esc_html($title ?: '‚Äî');
},10,2);






















































/* ========= DESIGNER CABINET SYSTEM START ========= */

/**
 * –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –û–ë–õ–û–ñ–ö–ò –ü–†–û–§–ò–õ–Ø
 */

// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –≤ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
add_action('user_new_form', 'ar_add_profile_cover_upload_field');
add_action('show_user_profile', 'ar_add_profile_cover_upload_field');
function ar_add_profile_cover_upload_field($user) {
    $cover_image_id = get_user_meta($user->ID, 'ar_profile_cover_image_id', true);
    $cover_image_url = $cover_image_id ? wp_get_attachment_url($cover_image_id) : '';
    ?>
    <table class="form-table">
        <tr>
            <th><label for="ar_profile_cover_image">üì∑ –û–±–ª–æ–∂–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</label></th>
            <td>
                <div id="ar-cover-preview" style="margin-bottom: 15px;">
                    <?php if ($cover_image_url): ?>
                        <img src="<?php echo esc_url($cover_image_url); ?>" 
                             alt="Cover Image" 
                             style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                        <br>
                        <button type="button" class="button button-secondary" onclick="arRemoveProfileCover()" style="margin-top: 10px;">
                            ‚úï –£–¥–∞–ª–∏—Ç—å –æ–±–ª–æ–∂–∫—É
                        </button>
                    <?php else: ?>
                        <div style="width: 100%; height: 150px; background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">
                            –û–±–ª–æ–∂–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                        </div>
                    <?php endif; ?>
                </div>
                
                <input type="hidden" id="ar_profile_cover_image_id" name="ar_profile_cover_image_id" value="<?php echo esc_attr($cover_image_id); ?>">
                
                <button type="button" class="button button-primary" id="ar-upload-cover-btn" onclick="arOpenProfileCoverUploadModal()">
                    üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É –ø—Ä–æ—Ñ–∏–ª—è
                </button>
                
                <p class="description">
                    –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 1200x300 px.<br>
                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 5 –ú–ë.<br>
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, WebP.
                </p>
            </td>
        </tr>
    </table>
    
    <!-- –°–∫—Ä—ã—Ç—ã–π –º–æ–¥–∞–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ -->
    <div id="ar-profile-cover-upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0;">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É –ø—Ä–æ—Ñ–∏–ª—è</h3>
            
            <div style="border: 2px dashed #007cba; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9fa;" 
                 onclick="document.getElementById('ar-profile-cover-file').click();"
                 id="ar-cover-drop-zone">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#007cba" stroke-width="2" style="margin: 0 auto 10px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p style="margin: 10px 0; color: #666;">
                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –æ–±–ª–æ–∂–∫—É —Å—é–¥–∞ –∏–ª–∏<br>
                    <strong style="color: #007cba; text-decoration: underline;">–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</strong>
                </p>
            </div>
            
            <input type="file" 
                   id="ar-profile-cover-file" 
                   accept="image/jpeg,image/png,image/webp" 
                   style="display: none;"
                   onchange="arHandleProfileCoverSelection()">
            
            <div id="ar-cover-upload-preview" style="margin: 20px 0;"></div>
            <div id="ar-cover-upload-error" style="color: #d32f2f; margin: 10px 0; display: none;"></div>
            <div id="ar-cover-upload-progress" style="display: none; margin: 15px 0;">
                <div style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                    <div id="ar-cover-progress-bar" style="height: 100%; background: #007cba; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p style="text-align: center; margin: 5px 0; font-size: 12px;" id="ar-cover-progress-text">0%</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="button button-secondary" onclick="arCloseProfileCoverUploadModal()" style="flex: 1;">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="button button-primary" id="ar-upload-cover-submit-btn" onclick="arUploadProfileCover()" disabled style="flex: 1;">
                    üíæ –ó–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
    
    <script>
    let arProfileCoverFile = null;
    
    function arOpenProfileCoverUploadModal() {
        document.getElementById('ar-profile-cover-upload-modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    function arCloseProfileCoverUploadModal() {
        document.getElementById('ar-profile-cover-upload-modal').style.display = 'none';
        document.body.style.overflow = 'auto';
        arProfileCoverFile = null;
        document.getElementById('ar-cover-upload-preview').innerHTML = '';
        document.getElementById('ar-cover-upload-error').style.display = 'none';
        document.getElementById('ar-profile-cover-file').value = '';
    }
    
    function arHandleProfileCoverSelection() {
        const fileInput = document.getElementById('ar-profile-cover-file');
        const file = fileInput.files[0];
        const previewContainer = document.getElementById('ar-cover-upload-preview');
        const errorContainer = document.getElementById('ar-cover-upload-error');
        const submitBtn = document.getElementById('ar-upload-cover-submit-btn');
        
        previewContainer.innerHTML = '';
        errorContainer.style.display = 'none';
        errorContainer.innerHTML = '';
        
        if (!file) return;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (5 –ú–ë)
        if (file.size > 5 * 1024 * 1024) {
            arShowCoverError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5 –ú–ë (—Ç–µ–∫—É—â–∏–π: ' + (file.size / (1024*1024)).toFixed(2) + ' –ú–ë)');
            fileInput.value = '';
            submitBtn.disabled = true;
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            arShowCoverError('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: JPG, PNG, WebP');
            fileInput.value = '';
            submitBtn.disabled = true;
            return;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.cssText = 'max-width: 100%; max-height: 150px; border-radius: 4px; margin-bottom: 10px;';
            previewContainer.appendChild(img);
            
            const info = document.createElement('p');
            info.style.cssText = 'margin: 0; font-size: 12px; color: #666;';
            info.innerHTML = `<strong>${file.name}</strong><br>–†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)} –ö–ë`;
            previewContainer.appendChild(info);
        };
        reader.readAsDataURL(file);
        
        arProfileCoverFile = file;
        submitBtn.disabled = false;
    }
    
    function arShowCoverError(message) {
        const errorContainer = document.getElementById('ar-cover-upload-error');
        errorContainer.innerHTML = '‚ö†Ô∏è ' + message;
        errorContainer.style.display = 'block';
    }
    
    function arUploadProfileCover() {
        if (!arProfileCoverFile) {
            arShowCoverError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
            return;
        }
        
        const submitBtn = document.getElementById('ar-upload-cover-submit-btn');
        const progressContainer = document.getElementById('ar-cover-upload-progress');
        const progressBar = document.getElementById('ar-cover-progress-bar');
        const progressText = document.getElementById('ar-cover-progress-text');
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...';
        progressContainer.style.display = 'block';
        
        const formData = new FormData();
        formData.append('action', 'ar_upload_profile_cover');
        formData.append('nonce', '<?php echo wp_create_nonce('ar_upload_profile_cover'); ?>');
        formData.append('profile_cover', arProfileCoverFile);
        
        const xhr = new XMLHttpRequest();
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressText.innerHTML = Math.round(percentComplete) + '%';
            }
        });
        
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (response.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        document.getElementById('ar_profile_cover_image_id').value = response.data.attachment_id;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                        const coverPreview = document.getElementById('ar-cover-preview');
                        coverPreview.innerHTML = '<img src="' + response.data.url + '" alt="Cover Image" style="max-width: 100%; max-height: 200px; border-radius: 8px;"><br><button type="button" class="button button-secondary" onclick="arRemoveProfileCover()" style="margin-top: 10px;">‚úï –£–¥–∞–ª–∏—Ç—å –æ–±–ª–æ–∂–∫—É</button>';
                        
                        arCloseProfileCoverUploadModal();
                        alert('‚úÖ –û–±–ª–æ–∂–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
                    } else {
                        arShowCoverError(response.data || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'üíæ –ó–∞–≥—Ä—É–∑–∏—Ç—å';
                    }
                } catch (e) {
                    arShowCoverError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞: ' + e.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'üíæ –ó–∞–≥—Ä—É–∑–∏—Ç—å';
                }
            } else {
                arShowCoverError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–∫–æ–¥ ' + xhr.status + ')');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üíæ –ó–∞–≥—Ä—É–∑–∏—Ç—å';
            }
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.innerHTML = '0%';
        });
        
        xhr.addEventListener('error', function() {
            arShowCoverError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üíæ –ó–∞–≥—Ä—É–∑–∏—Ç—å';
            progressContainer.style.display = 'none';
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /wp-admin/admin-ajax.php
        xhr.open('POST', '<?php echo admin_url('admin-ajax.php'); ?>', true);
        xhr.send(formData);
    }
    
    function arRemoveProfileCover() {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–±–ª–æ–∂–∫—É –ø—Ä–æ—Ñ–∏–ª—è?')) {
            document.getElementById('ar_profile_cover_image_id').value = '';
            document.getElementById('ar-cover-preview').innerHTML = '<div style="width: 100%; height: 150px; background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">–û–±–ª–æ–∂–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>';
        }
    }
    
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
    const dropZone = document.getElementById('ar-cover-drop-zone');
    if (dropZone) {
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.background = '#e3f2fd';
            this.style.borderColor = '#1976d2';
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.background = '#f8f9fa';
            this.style.borderColor = '#ccc';
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.background = '#f8f9fa';
            this.style.borderColor = '#ccc';
            
            if (e.dataTransfer.files.length > 0) {
                document.getElementById('ar-profile-cover-file').files = e.dataTransfer.files;
                arHandleProfileCoverSelection();
            }
        });
    }
    </script>
    <?php
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–ª–æ–∂–∫—É –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
add_action('personal_options_update', 'ar_save_profile_cover_image');
add_action('edit_user_profile_update', 'ar_save_profile_cover_image');
function ar_save_profile_cover_image($user_id) {
    if (isset($_POST['ar_profile_cover_image_id'])) {
        $cover_image_id = sanitize_text_field($_POST['ar_profile_cover_image_id']);
        if (!empty($cover_image_id)) {
            update_user_meta($user_id, 'ar_profile_cover_image_id', $cover_image_id);
        } else {
            delete_user_meta($user_id, 'ar_profile_cover_image_id');
        }
    }
}

// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
add_action('wp_ajax_ar_upload_profile_cover', 'ar_handle_profile_cover_upload');
function ar_handle_profile_cover_upload() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º nonce
    if (!isset($_REQUEST['nonce']) || !wp_verify_nonce($_REQUEST['nonce'], 'ar_upload_profile_cover')) {
        wp_send_json_error('Invalid nonce');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!is_user_logged_in()) {
        wp_send_json_error('Unauthorized');
    }
    
    $user_id = get_current_user_id();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º
    if ($user_id !== (int)$_REQUEST['user_id'] && !current_user_can('edit_users')) {
        wp_send_json_error('Permission denied');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
    if (!isset($_FILES['profile_cover']) || empty($_FILES['profile_cover']['name'])) {
        wp_send_json_error('No file provided');
    }
    
    $file = $_FILES['profile_cover'];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (5 –ú–ë –º–∞–∫—Å–∏–º—É–º)
    if ($file['size'] > 5 * 1024 * 1024) {
        wp_send_json_error('File is too large. Maximum size: 5 MB');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø MIME
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mime_type = finfo_file($finfo, $file['tmp_name']);
    finfo_close($finfo);
    
    $allowed_mimes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!in_array($mime_type, $allowed_mimes)) {
        wp_send_json_error('Invalid file format. Allowed: JPG, PNG, WebP');
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ –º–µ–¥–∏–∞-–±–∏–±–ª–∏–æ—Ç–µ–∫—É
    require_once(ABSPATH . 'wp-admin/includes/image.php');
    require_once(ABSPATH . 'wp-admin/includes/file.php');
    require_once(ABSPATH . 'wp-admin/includes/media.php');
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    $attachment_id = media_handle_upload('profile_cover', 0);
    
    if (is_wp_error($attachment_id)) {
        wp_send_json_error($attachment_id->get_error_message());
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    update_user_meta($user_id, 'ar_profile_cover_image_id', $attachment_id);
    
    // –ü–æ–ª—É—á–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    $attachment_url = wp_get_attachment_url($attachment_id);
    
    wp_send_json_success([
        'attachment_id' => $attachment_id,
        'url' => $attachment_url,
        'message' => 'Profile cover uploaded successfully'
    ]);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
function ar_get_user_profile_cover($user_id) {
    $cover_image_id = get_user_meta($user_id, 'ar_profile_cover_image_id', true);
    if ($cover_image_id) {
        return wp_get_attachment_url($cover_image_id);
    }
    return '';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ–±–ª–æ–∂–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
function ar_display_user_profile_cover($user_id, $height = 300) {
    $cover_url = ar_get_user_profile_cover($user_id);
    if ($cover_url) {
        echo '<div class="ar-profile-cover" style="width: 100%; height: ' . esc_attr($height) . 'px; background-image: url(\'' . esc_url($cover_url) . '\'); background-size: cover; background-position: center; border-radius: 8px; margin-bottom: 20px;"></div>';
    }
}

/**
 * –ö–ª–∞—Å—Å –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤
 */
class AR_Project_Cache {
    public static function clear_user_projects_cache($user_id) {
        delete_transient('ar_user_projects_' . $user_id);
        wp_cache_delete('ar_user_projects_' . $user_id, 'artrocket');
        error_log("ARTROCKET CACHE: Cleared cache for user {$user_id}");
    }
    
    public static function get_user_projects($user_id) {
        $cache_key = 'ar_user_projects_' . $user_id;
        $projects = wp_cache_get($cache_key, 'artrocket');
        
        if ($projects === false) {
            $projects = ar_get_user_projects($user_id);
            wp_cache_set($cache_key, $projects, 'artrocket', 15 * MINUTE_IN_SECONDS);
        }
        
        return $projects;
    }
    
    public static function get_last_cache_time($user_id) {
        $cache_time = get_user_meta($user_id, 'ar_last_cache_refresh', true);
        if ($cache_time) {
            return date('H:i', strtotime($cache_time));
        }
        return date('H:i');
    }
}



/**
 * –ì–ª–æ–±–∞–ª—å–Ω—ã–π JavaScript –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–ó–ê–ì–†–£–ñ–ê–ï–¢–°–Ø –í FOOTER)
 */
add_action('wp_footer', 'ar_add_global_save_handler');
function ar_add_global_save_handler() {
    if (!is_user_logged_in()) return;
    ?>
    <script>
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ event delegation
    document.addEventListener('click', function(e) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if (e.target && e.target.classList.contains('ar-save-project-btn')) {
            e.preventDefault();
            console.log('üî• ARTROCKET: Save button clicked via event delegation!');
            
            const btn = e.target;
            const projectId = btn.getAttribute('data-project-id');
            const ajaxUrl = btn.getAttribute('data-ajax-url');
            const nonce = btn.getAttribute('data-nonce');
            
            console.log('Project ID:', projectId);
            console.log('AJAX URL:', ajaxUrl);
            console.log('Nonce:', nonce);
            
            if (!projectId || !ajaxUrl || !nonce) {
                console.error('‚ùå Missing required data attributes');
                return;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π
            const fields = document.querySelectorAll('.ar-editable-field');
            const formData = new FormData();
            
            formData.append('action', 'ar_save_project_changes');
            formData.append('project_id', projectId);
            formData.append('nonce', nonce);
            
            fields.forEach(function(field) {
                const fieldName = field.getAttribute('name');
                const fieldValue = field.value;
                console.log('Field:', fieldName, '=', fieldValue);
                formData.append(fieldName, fieldValue);
            });
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            btn.disabled = true;
            btn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX
            fetch(ajaxUrl, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Response received:', data);
                
                if (data.success) {
                    btn.innerHTML = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                    if (typeof arShowNotification === 'function') {
                        arShowNotification('–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    } else {
                        alert('–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    }
                    
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    console.error('‚ùå Save failed:', data.data);
                    btn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                    btn.disabled = false;
                    
                    if (typeof arShowNotification === 'function') {
                        arShowNotification('–û—à–∏–±–∫–∞: ' + (data.data || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'), 'error');
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (data.data || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'));
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå AJAX error:', error);
                btn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                btn.disabled = false;
                
                if (typeof arShowNotification === 'function') {
                    arShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
                }
            });
        }
    });
    
    console.log('‚úÖ ARTROCKET: Global save handler initialized');
    </script>
    <?php
}



/**
 * –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
 */

function ar_create_projects_tables() {
    global $wpdb;
    
    $charset_collate = $wpdb->get_charset_collate();
    
    $projects_table = $wpdb->prefix . 'designer_projects';
    $sql_projects = "CREATE TABLE $projects_table (
    id bigint(20) NOT NULL AUTO_INCREMENT,
    project_id varchar(100) NOT NULL UNIQUE,
    designer_key varchar(100) NOT NULL,
    user_id bigint(20) DEFAULT NULL,
    title text NOT NULL,
    currency varchar(10) DEFAULT '–†–£–ë',
    value decimal(15,2) DEFAULT 0,
    designer_income decimal(15,2) DEFAULT 0,
    status varchar(50) DEFAULT 'in_progress',
    client_name varchar(255) DEFAULT '',
    client_email varchar(255) DEFAULT '',
    client_address text DEFAULT '',
    client_phone varchar(50) DEFAULT '',
    project_deadline date DEFAULT NULL,
    is_commercial tinyint(1) DEFAULT 0,
    project_description text DEFAULT '',
    project_comment text DEFAULT '',
    designer_name varchar(255) DEFAULT '',
    designer_phone varchar(50) DEFAULT '',
    designer_email varchar(255) DEFAULT '',
    created_at datetime DEFAULT CURRENT_TIMESTAMP,
    updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    metadata text,
    PRIMARY KEY (id),
    KEY designer_key (designer_key),
    KEY user_id (user_id),
    KEY status (status),
    KEY created_at (created_at),
    KEY project_deadline (project_deadline),
    KEY is_commercial (is_commercial)
) $charset_collate;";
    
    $products_table = $wpdb->prefix . 'project_products';
    $sql_products = "CREATE TABLE $products_table (
        id bigint(20) NOT NULL AUTO_INCREMENT,
        project_id varchar(100) NOT NULL,
        product_name text NOT NULL,
        quantity decimal(10,3) DEFAULT 0,
        unit varchar(50) DEFAULT '',
        unit_price decimal(15,2) DEFAULT 0,
        total_price decimal(15,2) DEFAULT 0,
        manufacturer_id varchar(100) DEFAULT '',
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        KEY project_id (project_id),
        KEY manufacturer_id (manufacturer_id)
    ) $charset_collate;";
    
    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql_projects);
    dbDelta($sql_products);
    
    error_log("ARTROCKET: Tables created/updated successfully");
}

add_action('init', 'ar_check_tables_structure');
// Check and initialize tables on init (schema version already handled at activation)
function ar_check_tables_structure() {
    global $wpdb;
    
    static $checked = false;
    if ($checked) return;
    $checked = true;
    
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    // Only create tables if they don't exist; migrations are handled at activation via ar_run_migrations()
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$projects_table'") === $projects_table;
    if (!$table_exists) {
        error_log("ARTROCKET: Tables don't exist, creating...");
        ar_create_projects_tables();
    }
}

/**
 * Run database migrations based on schema_version option
 * Called only on plugin activation or when version changes
 */
function ar_run_migrations() {
    global $wpdb;
    
    $current_version = get_option('ar_schema_version', 0);
    $latest_version = 2; // Bump this when adding new migrations
    
    if ($current_version >= $latest_version) {
        return; // No migrations needed
    }
    
    // Migration 1: Add missing columns to projects table
    if ($current_version < 1) {
        $projects_table = $wpdb->prefix . 'designer_projects';
        if ($wpdb->get_var("SHOW TABLES LIKE '$projects_table'") === $projects_table) {
            $columns_to_check = [
                'user_id' => "bigint(20) DEFAULT NULL",
                'designer_name' => "varchar(255) DEFAULT ''",
                'designer_phone' => "varchar(50) DEFAULT ''",
                'designer_email' => "varchar(255) DEFAULT ''",
                'client_address' => "text DEFAULT ''",
                'client_phone' => "varchar(50) DEFAULT ''",
                'project_deadline' => "date DEFAULT NULL",
                'is_commercial' => "tinyint(1) DEFAULT 0",
                'project_description' => "text DEFAULT ''",
                'project_comment' => "text DEFAULT ''",
                'photos' => "text DEFAULT ''"
            ];
            
            foreach ($columns_to_check as $column => $definition) {
                $column_exists = $wpdb->get_var("SHOW COLUMNS FROM $projects_table LIKE '$column'");
                if (!$column_exists) {
                    error_log("ARTROCKET: Adding missing column: $column");
                    $wpdb->query("ALTER TABLE $projects_table ADD COLUMN $column $definition");
                }
            }
            
            $indexes_to_check = ['user_id', 'project_deadline', 'is_commercial'];
            foreach ($indexes_to_check as $index) {
                $index_exists = $wpdb->get_var("SHOW INDEX FROM $projects_table WHERE Key_name = '$index'");
                if (!$index_exists && $wpdb->get_var("SHOW COLUMNS FROM $projects_table LIKE '$index'")) {
                    error_log("ARTROCKET: Adding index for: $index");
                    $wpdb->query("ALTER TABLE $projects_table ADD INDEX $index ($index)");
                }
            }
        }
    }
    
    // Migration 2: Add license metadata columns (reserved for future use)
    if ($current_version < 2) {
        error_log("ARTROCKET: Migration 2 - checking license metadata tables...");
        // Metadata is stored in post/user meta, no schema changes needed
    }
    
    // Update schema version
    update_option('ar_schema_version', $latest_version);
    error_log("ARTROCKET: Schema updated to version " . $latest_version);
}

function ar_get_designer_data($user_id) {
    if (!$user_id) {
        return ['name' => '', 'phone' => '', 'email' => ''];
    }
    
    $user = get_userdata($user_id);
    if (!$user) {
        return ['name' => '', 'phone' => '', 'email' => ''];
    }
    
    $designer_name = '';
    $first_name = get_user_meta($user_id, 'first_name', true);
    $last_name = get_user_meta($user_id, 'last_name', true);
    
    if (!empty($first_name) || !empty($last_name)) {
        $designer_name = trim($first_name . ' ' . $last_name);
    }
    
    if (empty($designer_name)) {
        $designer_name = $user->display_name ?: $user->user_login;
    }
    
    $designer_phone = get_user_meta($user_id, 'phone', true);
    if (empty($designer_phone)) {
        $designer_phone = get_user_meta($user_id, 'billing_phone', true);
    }
    
    $designer_email = $user->user_email;
    
    return [
        'name' => $designer_name,
        'phone' => $designer_phone ?: '',
        'email' => $designer_email ?: ''
    ];
}

add_action('rest_api_init', 'ar_register_all_endpoints');
function ar_register_all_endpoints() {
    error_log('ARTROCKET: Registering REST API endpoints');
    
    register_rest_route('ar/v1', '/debug', array(
        'methods' => 'GET',
        'callback' => 'ar_debug_endpoint',
        'permission_callback' => function() {
            return current_user_can('manage_options');
        }
    ));
    
    register_rest_route('ar/v1', '/projects', array(
        'methods' => 'POST',
        'callback' => 'ar_projects_endpoint',
        'permission_callback' => 'ar_verify_api_key'
    ));
    
    register_rest_route('ar/v1', '/find-user', array(
        'methods' => 'POST',
        'callback' => 'ar_find_user_endpoint',
        'permission_callback' => 'ar_verify_api_key'
    ));
    
    register_rest_route('ar/v1', '/my-projects', array(
        'methods' => 'GET',
        'callback' => 'ar_get_my_projects_endpoint',
        'permission_callback' => function() {
            return is_user_logged_in();
        }
    ));
    
    error_log('ARTROCKET: Endpoints registered successfully');
}

function ar_debug_endpoint($request) {
    global $wpdb;
    
    $projects_table = $wpdb->prefix . 'designer_projects';
    $products_table = $wpdb->prefix . 'project_products';
    
    $projects_count = $wpdb->get_var("SELECT COUNT(*) FROM $projects_table");
    $products_count = $wpdb->get_var("SELECT COUNT(*) FROM $products_table");
    
    $table_structure = $wpdb->get_results("DESCRIBE $projects_table", ARRAY_A);
    
    return new WP_REST_Response([
        'success' => true,
        'message' => 'AR Rocket API v1 is working!',
        'tables' => [
            'projects' => [
                'exists' => $wpdb->get_var("SHOW TABLES LIKE '$projects_table'") === $projects_table,
                'count' => $projects_count,
                'structure' => $table_structure
            ],
            'products' => [
                'exists' => $wpdb->get_var("SHOW TABLES LIKE '$products_table'") === $products_table,
                'count' => $products_count
            ]
        ],
        'api_key_configured' => !empty(get_option('ar_designer_software_api_key', '')),
        'timestamp' => current_time('mysql'),
        'php_version' => PHP_VERSION,
        'wordpress_version' => get_bloginfo('version')
    ], 200);
}

function ar_transform_app_data_to_standard($app_data) {
    error_log('ARTROCKET TRANSFORM: Starting transformation');
    
    $transformed = [
        'project_id' => $app_data['project_id'] ?? '',
        'registration_code' => $app_data['registration_code'] ?? $app_data['designer_key'] ?? '',
        'title' => $app_data['title'] ?? 'No Title',
        'currency' => '–†–£–ë',
        'value' => 0,
        'products' => []
    ];
    
    error_log('ARTROCKET TRANSFORM: Basic data extracted - project_id: ' . $transformed['project_id'] . ', registration_code: ' . $transformed['registration_code']);
    
    if (empty($app_data['data']) || !is_array($app_data['data'])) {
        error_log('ARTROCKET TRANSFORM: No data field found');
        return $transformed;
    }
    
    try {
        if (isset($app_data['data'][0][0][1]) && is_array($app_data['data'][0][0][1])) {
            $products_array = $app_data['data'][0][0][1];
            error_log('ARTROCKET TRANSFORM: Found products array with ' . count($products_array) . ' items');
            
            $products_found = 0;
            $total_value = 0;
            
            foreach ($products_array as $line) {
                if (!is_string($line)) continue;
                
                if (strpos($line, '‚Ññ\tprovider') !== false || 
                    strpos($line, 'Total') !== false ||
                    strpos($line, '\tTest\n') !== false ||
                    strpos($line, '\ttest\n') !== false) {
                    continue;
                }
                
                if (preg_match('/^\d+\t/', $line)) {
                    $parts = explode("\t", $line);
                    $clean_parts = array_values(array_filter(array_map('trim', $parts)));
                    
                    if (count($clean_parts) >= 6) {
                        $product = [
                            'name' => $clean_parts[2] ?? 'Unknown',
                            'manufacturer_id' => $clean_parts[1] ?? 'unknown',
                            'quantity' => (float) str_replace(',', '.', $clean_parts[3] ?? '0'),
                            'unit' => $clean_parts[4] ?? 'pcs',
                            'total_price' => (float) str_replace([' ', ',', '–†–£–ë'], ['', '.', ''], $clean_parts[5] ?? '0')
                        ];
                        
                        $product['unit_price'] = $product['quantity'] > 0 ? 
                            $product['total_price'] / $product['quantity'] : 
                            $product['total_price'];
                        
                        $transformed['products'][] = $product;
                        $total_value += $product['total_price'];
                        $products_found++;
                        
                        error_log("ARTROCKET TRANSFORM: ‚úÖ Added product: " . $product['name']);
                    }
                }
            }
            
            $transformed['value'] = $total_value;
            error_log("ARTROCKET TRANSFORM: üéâ Transformation complete! Found {$products_found} products, total value: {$total_value} –†–£–ë");
        } else {
            error_log('ARTROCKET TRANSFORM: Could not find products in data[0][0][1]');
        }
        
    } catch (Exception $e) {
        error_log("ARTROCKET TRANSFORM: üí• ERROR: " . $e->getMessage());
    }
    
    return $transformed;
}

function ar_projects_endpoint($request) {
    global $wpdb;
    
    // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –≤—ã–≤–æ–¥–∞
    while (ob_get_level()) {
        ob_end_clean();
    }
    ob_start();
    
    try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ API
        if (!ar_verify_api_key($request)) {
            throw new Exception('Autorizare e»ôuatƒÉ', 401);
        }

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        $data = $request->get_json_params();
        
        if (empty($data)) {
            throw new Exception('Datele nu au fost primite corect');
        }

        error_log('ARTROCKET ENDPOINT: Received request with keys: ' . implode(', ', array_keys($data)));

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
        $is_app_format = isset($data['data']) && is_array($data['data']);
        error_log("ARTROCKET ENDPOINT: Format detection - is_app_format: " . ($is_app_format ? 'YES' : 'NO'));

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        if ($is_app_format) {
            error_log('ARTROCKET ENDPOINT: Detected app format, transforming...');
            $original_data = $data;
            $data = ar_transform_app_data_to_standard($data);
            
            if (empty($data['registration_code'])) {
                $data['registration_code'] = $original_data['registration_code'] ?? $original_data['designer_key'] ?? '';
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        $required_fields = ['project_id', 'registration_code', 'title'];
        foreach ($required_fields as $field) {
            if (empty($data[$field])) {
                throw new Exception("Lipseste $field");
            }
        }
        
        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ registration code
        $user_id = ar_find_user_by_registration_code($data['registration_code']);
        if (!$user_id) {
            error_log("ARTROCKET ENDPOINT: User not found for registration_code: {$data['registration_code']}");
            throw new Exception('Utilizatorul nu a fost gƒÉsit pentru codul: ' . $data['registration_code']);
        }
        
        error_log("ARTROCKET ENDPOINT: Found user ID: {$user_id} for registration_code: {$data['registration_code']}");
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã
        $designer_data = ar_get_designer_data($user_id);
        $projects_table = $wpdb->prefix . 'designer_projects';
        $products_table = $wpdb->prefix . 'project_products';
        
        $action_type = 'updated';
        $project_id_to_use = $data['project_id'];
        $status_changed = false;
        $project_found_by = 'not_found';
        
        // 1. –°–ù–ê–ß–ê–õ–ê –ò–©–ï–ú –ü–†–û–ï–ö–¢ –ü–û project_id –ò user_id
        $existing_project = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $projects_table 
             WHERE project_id = %s AND user_id = %d 
             LIMIT 1", 
            $data['project_id'], 
            $user_id
        ), ARRAY_A);
        
        if ($existing_project) {
            $project_found_by = 'project_id';
            error_log("ARTROCKET ENDPOINT: Found project by project_id: {$data['project_id']} with status: {$existing_project['status']}");
        } else {
            // 2. –ï–°–õ–ò –ù–ï –ù–ê–®–õ–ò –ü–û project_id, –ò–©–ï–ú –ü–û –ù–ê–ó–í–ê–ù–ò–Æ –í–û –í–°–ï–• –°–¢–ê–¢–£–°–ê–•
            error_log("ARTROCKET ENDPOINT: Project not found by project_id, searching by title in all statuses");
            
            $existing_project_by_title = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $projects_table 
                 WHERE user_id = %d AND title = %s 
                 LIMIT 1", 
                $user_id, 
                sanitize_text_field($data['title'])
            ), ARRAY_A);
            
            if ($existing_project_by_title) {
                $project_id_to_use = $existing_project_by_title['project_id'];
                $existing_project = $existing_project_by_title;
                $project_found_by = 'title';
                
                error_log("ARTROCKET ENDPOINT: Found project by title: {$existing_project_by_title['project_id']} with status: {$existing_project_by_title['status']}");
            }
        }
        
        // –†–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ 10%
        $project_value = !empty($data['value']) ? floatval($data['value']) : 0;
        $designer_income = !empty($data['designer_income']) ? floatval($data['designer_income']) : 0;
        
        if ($designer_income == 0 && $project_value > 0) {
            $designer_income = $project_value * 0.1;
            error_log("ARTROCKET ENDPOINT: Auto-calculated designer income: {$designer_income} (10% of {$project_value})");
        }
        
        // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –°–¢–ê–¢–£–° –ü–†–û–ï–ö–¢–ê - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê
        if ($existing_project) {
            // –ï–°–õ–ò –ü–†–û–ï–ö–¢ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢
            if ($project_found_by === 'title' && $existing_project['status'] === 'new') {
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –ø—Ä–æ–µ–∫—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ "new" - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "in_progress"
                $project_status = 'in_progress';
                $status_changed = true;
                error_log("ARTROCKET ENDPOINT: Project found by title in 'new' status, moving to 'in_progress'");
            } else {
                // –í–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞
                $project_status = $existing_project['status'];
                error_log("ARTROCKET ENDPOINT: Keeping existing project status: {$existing_project['status']}");
            }
        } else {
            // –ï–°–õ–ò –ü–†–û–ï–ö–¢ –ù–û–í–´–ô - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "in_progress"
            $project_status = !empty($data['status']) ? sanitize_text_field($data['status']) : 'in_progress';
            error_log("ARTROCKET ENDPOINT: New project, using status: {$project_status}");
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
        $project_data = [
            'project_id' => $project_id_to_use,
            'designer_key' => sanitize_text_field($data['registration_code']),
            'title' => sanitize_text_field($data['title']),
            'currency' => !empty($data['currency']) ? sanitize_text_field($data['currency']) : '–†–£–ë',
            'value' => $project_value,
            'designer_income' => $designer_income,
            'status' => $project_status,
            'client_name' => !empty($data['client_name']) ? sanitize_text_field($data['client_name']) : '',
            'client_email' => !empty($data['client_email']) ? sanitize_email($data['client_email']) : '',
            'client_address' => !empty($data['client_address']) ? sanitize_textarea_field($data['client_address']) : '',
            'client_phone' => !empty($data['client_phone']) ? sanitize_text_field($data['client_phone']) : '',
            'project_deadline' => !empty($data['project_deadline']) ? sanitize_text_field($data['project_deadline']) : NULL,
            'is_commercial' => !empty($data['is_commercial']) ? intval($data['is_commercial']) : 0,
            'project_description' => !empty($data['project_description']) ? sanitize_textarea_field($data['project_description']) : '',
            'project_comment' => !empty($data['project_comment']) ? sanitize_textarea_field($data['project_comment']) : '',
            'designer_name' => $designer_data['name'],
            'designer_phone' => $designer_data['phone'],
            'designer_email' => $designer_data['email'],
            'metadata' => !empty($data['metadata']) ? wp_json_encode($data['metadata']) : '',
            'updated_at' => current_time('mysql'),
            'user_id' => $user_id
        ];
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        $wpdb->query('START TRANSACTION');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç
        if ($existing_project) {
            error_log("ARTROCKET ENDPOINT: Updating existing project: {$project_id_to_use}");
            
            $result = $wpdb->update(
                $projects_table, 
                $project_data, 
                ['project_id' => $project_id_to_use]
            );
            
            if ($result === false) {
                $error = $wpdb->last_error ?: 'Eroare necunoscutƒÉ';
                error_log("ARTROCKET ENDPOINT: Update failed: {$error}");
                throw new Exception($error);
            }
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
            $wpdb->delete($products_table, ['project_id' => $project_id_to_use]);
            error_log("ARTROCKET ENDPOINT: Deleted old products for project: {$project_id_to_use}");
            
        } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
            $project_data['created_at'] = current_time('mysql');
            $result = $wpdb->insert($projects_table, $project_data);
            
            if ($result === false) {
                $error = $wpdb->last_error ?: 'Eroare necunoscutƒÉ';
                error_log("ARTROCKET ENDPOINT: Insert failed: {$error}");
                throw new Exception($error);
            }
            
            $action_type = 'created';
            error_log("ARTROCKET ENDPOINT: Created new project: {$project_id_to_use}");
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
        $products_added = 0;
        $product_errors = [];
        
        if (!empty($data['products']) && is_array($data['products'])) {
            error_log('ARTROCKET ENDPOINT: Starting to insert ' . count($data['products']) . ' products');
            
            foreach ($data['products'] as $index => $product) {
                $product_data = [
                    'project_id' => $project_id_to_use,
                    'product_name' => !empty($product['name']) ? sanitize_text_field($product['name']) : 'Unknown Product',
                    'quantity' => !empty($product['quantity']) ? floatval($product['quantity']) : 0,
                    'unit' => !empty($product['unit']) ? sanitize_text_field($product['unit']) : 'pcs',
                    'unit_price' => !empty($product['unit_price']) ? floatval($product['unit_price']) : 0,
                    'total_price' => !empty($product['total_price']) ? floatval($product['total_price']) : 0,
                    'manufacturer_id' => !empty($product['manufacturer_id']) ? sanitize_text_field($product['manufacturer_id']) : 'unknown'
                ];
                
                $insert_result = $wpdb->insert($products_table, $product_data);
                
                if ($insert_result === false) {
                    $error_msg = $wpdb->last_error ?: 'Unknown database error';
                    $product_errors[] = "Product {$index}: {$error_msg}";
                    error_log("ARTROCKET ENDPOINT: ‚ùå Failed to insert product {$index}: {$error_msg}");
                } else {
                    $products_added++;
                }
            }
            
            error_log("ARTROCKET ENDPOINT: Products inserted: {$products_added}");
        }
        
        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        $wpdb->query('COMMIT');
        
        // –û—á–∏—â–∞–µ–º –∫—ç—à
        if (class_exists('AR_Project_Cache')) {
            AR_Project_Cache::clear_user_projects_cache($user_id);
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        $user_info = get_userdata($user_id);
        
        $response_data = [
            'success' => true,
            'message' => 'Proiect ' . ($action_type === 'created' ? 'creat' : 'actualizat') . ' cu succes',
            'project_id' => $project_id_to_use,
            'user_id' => $user_id,
            'user_email' => $user_info ? $user_info->user_email : '',
            'designer_data' => $designer_data,
            'action' => $action_type,
            'status_changed' => $status_changed,
            'products_added' => $products_added,
            'product_errors' => $product_errors,
            'project_found_by' => $project_found_by,
            'final_status' => $project_status
        ];
        
        ob_end_clean();
        return new WP_REST_Response($response_data, 200);
        
    } catch (Exception $e) {
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        $wpdb->query('ROLLBACK');
        ob_end_clean();
        
        $error_message = $e->getMessage();
        $status_code = $e->getCode() ?: 400;
        
        error_log("ARTROCKET ENDPOINT: ERROR - " . $error_message);
        
        return new WP_REST_Response([
            'success' => false,
            'message' => $error_message
        ], $status_code);
    }
}

function ar_find_user_endpoint($request) {
    $data = $request->get_json_params();
    
    if (empty($data['registration_code'])) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'Registration code is required'
        ], 400);
    }
    
    $user_id = ar_find_user_by_registration_code($data['registration_code']);
    
    if (!$user_id) {
        return new WP_REST_Response([
            'success' => false,
            'message' => 'User not found'
        ], 404);
    }
    
    $user = get_userdata($user_id);
    
    return new WP_REST_Response([
        'success' => true,
        'user_id' => $user_id,
        'user_email' => $user->user_email,
        'user_name' => $user->display_name
    ], 200);
}

/**
 * –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É –∫–æ–¥—É
 */
function ar_find_user_by_registration_code($registration_code) {
    if (empty($registration_code)) {
        return false;
    }
    
    global $wpdb;
    
    // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    $users = get_users([
        'meta_query' => [
            [
                'key' => '_user_license_reg_codes',
                'value' => $registration_code,
                'compare' => 'LIKE'
            ]
        ],
        'fields' => 'ID',
        'number' => 1
    ]);
    
    if (!empty($users)) {
        return $users[0];
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—â–µ–º –≤ –∑–∞–∫–∞–∑–∞—Ö
    $order_id = $wpdb->get_var($wpdb->prepare(
        "SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key = '_license_reg_code' AND meta_value = %s LIMIT 1",
        $registration_code
    ));
    
    if ($order_id) {
        $order = wc_get_order($order_id);
        if ($order) {
            return $order->get_user_id();
        }
    }
    
    return false;
}

/**
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á–µ—Ç–æ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
 */
function ar_get_user_projects($user_id = null) {
    global $wpdb;

    if (!$user_id) {
        $user_id = get_current_user_id();
    }

    if (!$user_id) {
        return [];
    }

    $projects_table = $wpdb->prefix . 'designer_projects';
    $products_table = $wpdb->prefix . 'project_products';

    // –ü–æ–ª—É—á–∞–µ–º registration codes –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $registration_codes = [];
    $orders = wc_get_orders([
        'customer_id' => $user_id,
        'status'      => ['completed', 'processing', 'on-hold'],
        'limit'       => -1,
    ]);

    foreach ($orders as $order) {
        $reg_code = $order->get_meta('_license_reg_code');
        if (!empty($reg_code)) {
            $registration_codes[] = sanitize_text_field($reg_code);
        }
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º SQL –∑–∞–ø—Ä–æ—Å
    if (empty($registration_codes)) {
        $projects = $wpdb->get_results(
            $wpdb->prepare(
                "SELECT * FROM $projects_table WHERE user_id = %d ORDER BY 
                 CASE 
                    WHEN status = 'new' THEN 1
                    WHEN status = 'in_progress' THEN 2  
                    WHEN status = 'pending' THEN 3
                    WHEN status = 'completed' THEN 4
                    WHEN status = 'abandoned' THEN 5
                 END, created_at DESC",
                $user_id
            ),
            ARRAY_A
        );
    } else {
        $placeholders = implode(',', array_fill(0, count($registration_codes), '%s'));
        $sql = $wpdb->prepare(
            "SELECT * FROM $projects_table WHERE user_id = %d OR designer_key IN ($placeholders) ORDER BY 
             CASE 
                WHEN status = 'new' THEN 1
                WHEN status = 'in_progress' THEN 2  
                WHEN status = 'pending' THEN 3
                WHEN status = 'completed' THEN 4
                WHEN status = 'abandoned' THEN 5
             END, created_at DESC",
            array_merge([$user_id], $registration_codes)
        );
        $projects = $wpdb->get_results($sql, ARRAY_A);
    }

    if (empty($projects)) {
        return [];
    }

    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
    $project_ids = array_column($projects, 'project_id');
    $product_placeholders = implode(',', array_fill(0, count($project_ids), '%s'));

    $products = $wpdb->get_results(
        $wpdb->prepare(
            "SELECT * FROM $products_table WHERE project_id IN ($product_placeholders) ORDER BY id ASC",
            $project_ids
        ),
        ARRAY_A
    );

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
    $products_by_project = [];
    foreach ($products as $product) {
        $pid = $product['project_id'];
        $products_by_project[$pid][] = [
            'name'            => $product['product_name'],
            'quantity'        => $product['quantity'],
            'unit'            => $product['unit'],
            'unit_price'      => $product['unit_price'],
            'total_price'     => $product['total_price'],
            'manufacturer_id' => $product['manufacturer_id'],
        ];
    }

    // –û–±–æ–≥–∞—â–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –∏ –ø–∞—Ä—Å–∏–º metadata
    foreach ($projects as &$project) {
        $pid = $project['project_id'];
        $project['products'] = $products_by_project[$pid] ?? [];

        $project['metadata'] = !empty($project['metadata']) && is_string($project['metadata'])
            ? (json_decode($project['metadata'], true) ?: [])
            : [];
            
        // –î–û–ë–ê–í–õ–Ø–ï–ú –ü–ê–†–°–ò–ù–ì –§–û–¢–û–ì–†–ê–§–ò–ô
        $project['photos'] = !empty($project['photos']) && is_string($project['photos'])
            ? (json_decode($project['photos'], true) ?: [])
            : [];

        $project['date'] = $project['created_at'];
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å)
        if (empty($project['designer_name']) && !empty($project['user_id'])) {
            $designer_data = ar_get_designer_data($project['user_id']);
            $project['designer_name'] = $designer_data['name'];
            $project['designer_phone'] = $designer_data['phone'];
            $project['designer_email'] = $designer_data['email'];
        }
    }

    return $projects;
}











/**
 * –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */
function ar_create_demo_project($user_id) {
    global $wpdb;
    
    $projects_table = $wpdb->prefix . 'designer_projects';
    $products_table = $wpdb->prefix . 'project_products';
    
    // –ü–†–û–í–ï–†–Ø–ï–ú, –ù–ï –£–î–ê–õ–Ø–õ –õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –î–ï–ú–û-–ü–†–û–ï–ö–¢ –†–ê–ù–ï–ï
    $demo_deleted = get_user_meta($user_id, 'ar_demo_project_deleted', true);
    if ($demo_deleted) {
        error_log("ARTROCKET DEMO: User {$user_id} has deleted demo project previously, skipping creation");
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $existing_demo = $wpdb->get_var($wpdb->prepare(
        "SELECT COUNT(*) FROM $projects_table WHERE user_id = %d AND project_id LIKE 'demo_%'",
        $user_id
    ));
    
    if ($existing_demo > 0) {
        error_log("ARTROCKET DEMO: Demo project already exists for user {$user_id}");
        return false; // –î–µ–º–æ-–ø—Ä–æ–µ–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç–∞
    $demo_project_id = 'demo_' . $user_id . '_' . time();
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $designer_data = ar_get_designer_data($user_id);
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç–∞
    $project_data = [
        'project_id' => $demo_project_id,
        'designer_key' => 'demo',
        'user_id' => $user_id,
        'title' => '–î–µ–º–æ-–ø—Ä–æ–µ–∫—Ç - –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã Residence',
        'currency' => '–†–£–ë',
        'value' => 45750.00,
        'designer_income' => 4575.00, // 10%
        'status' => 'in_progress',
        'client_name' => '–ú–∞—Ä–∏—è –ü–æ–ø–µ—Å–∫—É',
        'client_email' => 'maria.popescu@example.com',
        'client_address' => 'Strada Primaverii nr. 15, Bucure»ôti, Sector 1',
        'client_phone' => '+40 721 123 456',
        'project_deadline' => date('Y-m-d', strtotime('+2 months')),
        'is_commercial' => 0,
        'project_description' => '–ü—Ä–æ–µ–∫—Ç –∏–Ω—Ç–µ—Ä—å–µ—Ä–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ –¥–ª—è –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤ —Å 3 –∫–æ–º–Ω–∞—Ç–∞–º–∏. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Å –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–º–∏ –∞–∫—Ü–µ–Ω—Ç–∞–º–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º.',
        'project_comment' => '–ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Å–≤–µ—Ç–ª—ã–µ —Ü–≤–µ—Ç–∞ –∏ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã. –ì–∏–±–∫–∏–π –±—é–¥–∂–µ—Ç –¥–ª—è –æ—Å–≤–µ—â–µ–Ω–∏—è.',
        'designer_name' => $designer_data['name'],
        'designer_phone' => $designer_data['phone'],
        'designer_email' => $designer_data['email'],
        'created_at' => current_time('mysql'),
        'updated_at' => current_time('mysql'),
        'metadata' => wp_json_encode([
            'is_demo' => true, 
            'created_via' => 'auto_demo',
            'demo_version' => '1.0',
            'created_timestamp' => time()
        ])
    ];
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç
    $result = $wpdb->insert($projects_table, $project_data);
    
    if ($result === false) {
        error_log("ARTROCKET DEMO: Database error creating demo project for user {$user_id}: " . $wpdb->last_error);
        return false;
    }
    
     // –î–µ–º–æ-–ø—Ä–æ–¥—É–∫—Ç—ã
    $demo_products = [
        [
            'project_id' => $demo_project_id,
            'product_name' => '–õ–∞–º–∏–Ω–∞—Ç Premium Class',
            'quantity' => 85.5,
            'unit' => '–º¬≤',
            'unit_price' => 120.00,
            'total_price' => 10260.00,
            'manufacturer_id' => 'kaindl'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–ú–æ—é—â–∞—è—Å—è –º–∞—Ç–æ–≤–∞—è –∫—Ä–∞—Å–∫–∞',
            'quantity' => 45.0,
            'unit' => '–º¬≤',
            'unit_price' => 25.00,
            'total_price' => 1125.00,
            'manufacturer_id' => 'kober'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–ü–ª–∏—Ç–∫–∞ –¥–ª—è –≤–∞–Ω–Ω–æ–π 30x60 —Å–º',
            'quantity' => 28.0,
            'unit' => '–º¬≤',
            'unit_price' => 95.00,
            'total_price' => 2660.00,
            'manufacturer_id' => 'keraben'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–£–≥–ª–æ–≤–∞—è –∫—É—Ö–Ω—è',
            'quantity' => 1.0,
            'unit' => '—à—Ç',
            'unit_price' => 2450.00,
            'total_price' => 2450.00,
            'manufacturer_id' => 'blum'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–õ—é—Å—Ç—Ä–∞ –¥–ª—è –≥–æ—Å—Ç–∏–Ω–æ–π —Ö—Ä—É—Å—Ç–∞–ª—å–Ω–∞—è',
            'quantity' => 1.0,
            'unit' => '—à—Ç',
            'unit_price' => 850.00,
            'total_price' => 850.00,
            'manufacturer_id' => 'nolte'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–°–º–µ—Å–∏—Ç–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π —Ö—Ä–æ–º',
            'quantity' => 2.0,
            'unit' => '—à—Ç',
            'unit_price' => 320.00,
            'total_price' => 640.00,
            'manufacturer_id' => 'grohe'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–ú–µ–∂–∫–æ–º–Ω–∞—Ç–Ω–∞—è –¥–≤–µ—Ä—å –¥—É–±',
            'quantity' => 5.0,
            'unit' => '—à—Ç',
            'unit_price' => 450.00,
            'total_price' => 2250.00,
            'manufacturer_id' => 'massiv'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–£–≥–ª–æ–≤–∞—è —Å–ø–∞–ª—å–Ω—è',
            'quantity' => 1.0,
            'unit' => '—à—Ç',
            'unit_price' => 1850.00,
            'total_price' => 1850.00,
            'manufacturer_id' => 'ikea'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–ü–µ—Ä—Å–∏–¥—Å–∫–∏–π –∫–æ–≤–µ—Ä 3x4 –º',
            'quantity' => 1.0,
            'unit' => '—à—Ç',
            'unit_price' => 1200.00,
            'total_price' => 1200.00,
            'manufacturer_id' => 'orient'
        ],
        [
            'project_id' => $demo_project_id,
            'product_name' => '–ö–æ–º–ø–ª–µ–∫—Ç —Ä–æ–∑–µ—Ç–æ–∫ –∏ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–µ–π',
            'quantity' => 25.0,
            'unit' => '—à—Ç',
            'unit_price' => 18.50,
            'total_price' => 462.50,
            'manufacturer_id' => 'legrand'
        ]
    ];
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
    $products_created = 0;
    foreach ($demo_products as $product) {
        $insert_result = $wpdb->insert($products_table, $product);
        if ($insert_result !== false) {
            $products_created++;
        }
    }
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à
    AR_Project_Cache::clear_user_projects_cache($user_id);
    
    // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω
    update_user_meta($user_id, 'ar_demo_project_created', current_time('mysql'));
    
    error_log("ARTROCKET DEMO: Successfully created demo project for user {$user_id} with {$products_created} products");
    return true;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç–æ–º
 */
function ar_is_demo_project($project_id, $user_id = null) {
    if (!$user_id) {
        $user_id = get_current_user_id();
    }
    
    // –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ ID –ø—Ä–æ–µ–∫—Ç–∞
    if (strpos($project_id, 'demo_') === 0) {
        return true;
    }
    
    // –°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º –≤ –±–∞–∑–µ
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    $project_metadata = $wpdb->get_var($wpdb->prepare(
        "SELECT metadata FROM $projects_table WHERE project_id = %s AND user_id = %d",
        $project_id, $user_id
    ));
    
    if ($project_metadata) {
        $metadata = json_decode($project_metadata, true);
        if (isset($metadata['is_demo']) && $metadata['is_demo'] === true) {
            return true;
        }
    }
    
    return false;
}

/**
 * –û—Ç–º–µ—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–∏–ª –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç
 */
function ar_track_demo_project_deletion($project_id, $user_id) {
    if (ar_is_demo_project($project_id, $user_id)) {
        update_user_meta($user_id, 'ar_demo_project_deleted', current_time('mysql'));
        update_user_meta($user_id, 'ar_last_demo_deletion', $project_id);
        
        error_log("ARTROCKET DEMO: User {$user_id} deleted demo project {$project_id}");
        return true;
    }
    return false;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function ar_should_create_demo_project($user_id) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–¥–∞–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç —Ä–∞–Ω–µ–µ
    $demo_deleted = get_user_meta($user_id, 'ar_demo_project_deleted', true);
    if ($demo_deleted) {
        error_log("ARTROCKET DEMO: Skipping demo creation - user {$user_id} deleted demo previously");
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–µ–∫—Ç—ã
    $projects = AR_Project_Cache::get_user_projects($user_id);
    
    if (empty($projects)) {
        // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–µ—Ç –∏ –¥–µ–º–æ –Ω–µ —É–¥–∞–ª—è–ª–æ—Å—å - —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ
        error_log("ARTROCKET DEMO: No projects found for user {$user_id}, demo should be created");
        return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ä–µ–¥–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç
    foreach ($projects as $project) {
        if (ar_is_demo_project($project['project_id'], $user_id)) {
            error_log("ARTROCKET DEMO: User {$user_id} already has demo project");
            return false;
        }
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã, –Ω–µ —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ
    error_log("ARTROCKET DEMO: User {$user_id} has other projects, skipping demo");
    return false;
}

















/**
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –∫–∞–Ω–±–∞–Ω–µ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞—è–≤–∫–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º
 */
function ar_create_project_from_order($order_id, $designer_id) {
    global $wpdb;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
    $orders_table = $wpdb->prefix . 'client_orders';
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $orders_table WHERE id = %d",
        $order_id
    ));
    
    if (!$order) {
        error_log("ARTROCKET CREATE FROM ORDER: Order {$order_id} not found");
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–∑–¥–∞–Ω –ª–∏ —É–∂–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —ç—Ç–æ–π –∑–∞—è–≤–∫–∏
    // Using JSON functions for more robust detection (MySQL 5.7+)
    $projects_table = $wpdb->prefix . 'designer_projects';
    $existing_project = $wpdb->get_var($wpdb->prepare(
        "SELECT COUNT(*) FROM $projects_table 
         WHERE (metadata LIKE %s OR metadata LIKE %s)",
        '%\"order_id\":' . (int)$order_id . '%',
        '%\"order_id\":\"' . (int)$order_id . '\"%'
    ));
    
    if ($existing_project > 0) {
        error_log("ARTROCKET CREATE FROM ORDER: Project already exists for order {$order_id}");
        return false;
    }
    
    // === START TRANSACTION ===
    $wpdb->query('START TRANSACTION');
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $designer_data = ar_get_designer_data($designer_id);
    $designer = get_userdata($designer_id);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–µ–∫—Ç–∞
    $project_id = 'order_' . $order_id . '_' . $designer_id . '_' . time();
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ –∑–∞—è–≤–∫–µ)
    $project_value = !empty($order->budget) ? floatval($order->budget) : 0;
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–ª–æ—â–∞–¥—å –∏ —Ü–µ–Ω–∞ –∑–∞ –º¬≤ —É –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    if (!empty($order->area) && empty($project_value)) {
        $price_per_sqm = get_user_meta($designer_id, 'price_per_sqm', true);
        if (!empty($price_per_sqm) && is_numeric($price_per_sqm)) {
            $project_value = floatval($order->area) * floatval($price_per_sqm);
        }
    }
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é 10%
    $designer_income = $project_value * 0.1;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    $project_title = !empty($order->project_name) 
        ? $order->project_name 
        : '–ü—Ä–æ–µ–∫—Ç –∏–∑ –∑–∞—è–≤–∫–∏ #' . $order_id;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    $metadata = [
        'order_id' => $order_id,
        'created_from_order' => true,
        'original_order_data' => [
            'client_name' => $order->client_name,
            'client_email' => $order->client_email,
            'client_phone' => $order->client_phone,
            'service_type' => $order->service_type,
            'area' => $order->area,
            'city' => $order->city,
            'country' => $order->country,
            'additional_info' => $order->additional_info,
            'object_type' => $order->object_type,
            'object_status' => $order->object_status,
            'style' => $order->style,
            'completion_date' => $order->completion_date
        ],
        'created_at' => current_time('mysql')
    ];
    
    // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
    $project_data = [
        'project_id' => $project_id,
        'designer_key' => 'manual', // –î–ª—è —Ä—É—á–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
        'user_id' => $designer_id,
        'title' => $project_title,
        'currency' => !empty($order->currency) ? $order->currency : '–†–£–ë',
        'value' => $project_value,
        'designer_income' => $designer_income,
        'status' => 'new', // –í–∞–∂–Ω–æ: —Å–æ–∑–¥–∞–µ–º –≤ –ø–µ—Ä–≤–æ–º —Å—Ç–æ–ª–±—Ü–µ –∫–∞–Ω–±–∞–Ω–∞!
        'client_name' => $order->client_name,
        'client_email' => $order->client_email,
        'client_phone' => $order->client_phone,
        'client_address' => $order->city . ', ' . $order->country,
        'project_description' => $order->additional_info,
        'project_deadline' => !empty($order->completion_date) ? $order->completion_date : NULL,
        'designer_name' => $designer_data['name'],
        'designer_phone' => $designer_data['phone'],
        'designer_email' => $designer_data['email'],
        'created_at' => current_time('mysql'),
        'updated_at' => current_time('mysql'),
        'metadata' => wp_json_encode($metadata)
    ];
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç
    $result = $wpdb->insert($projects_table, $project_data);
    
    if ($result === false) {
        error_log("ARTROCKET CREATE FROM ORDER: Database error creating project: " . $wpdb->last_error);
        $wpdb->query('ROLLBACK');
        return false;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫—É - –æ—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω
    $update_result = $wpdb->update(
        $orders_table,
        [
            'project_created' => 1,
            'project_id' => $project_id,
            'updated_at' => current_time('mysql')
        ],
        ['id' => $order_id]
    );
    
    if ($update_result === false) {
        error_log("ARTROCKET CREATE FROM ORDER: Database error updating order: " . $wpdb->last_error);
        $wpdb->query('ROLLBACK');
        return false;
    }
    
    // === COMMIT TRANSACTION ===
    $wpdb->query('COMMIT');
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    if (class_exists('AR_Project_Cache')) {
        AR_Project_Cache::clear_user_projects_cache($designer_id);
    }
    
    error_log("ARTROCKET CREATE FROM ORDER: Successfully created project {$project_id} from order {$order_id} for designer {$designer_id}");
    
    return $project_id;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –¥–ª—è –∑–∞—è–≤–∫–∏
 */
function ar_should_create_project_for_order($order_id) {
    global $wpdb;
    
    $orders_table = $wpdb->prefix . 'client_orders';
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT project_created, status FROM $orders_table WHERE id = %d",
        $order_id
    ));
    
    if (!$order) {
        return false;
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
    // 1. –ü—Ä–æ–µ–∫—Ç –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω (project_created = 0)
    // 2. –ó–∞—è–≤–∫–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ
    return ($order->project_created == 0 && $order->status == 'active');
}























add_shortcode('ar_my_projects', 'ar_render_my_projects');
function ar_render_my_projects() {
    if (!is_user_logged_in()) {
        return '<p>Trebuie sƒÉ fi»õi autentificat pentru a vedea proiectele.</p>';
    }
    
    $user_id = get_current_user_id();
    
    // –£–ú–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –î–ï–ú–û-–ü–†–û–ï–ö–¢–ê
    if (ar_should_create_demo_project($user_id)) {
        error_log("ARTROCKET DEMO: Creating demo project for new user {$user_id}");
        ar_create_demo_project($user_id);
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç–æ–≤ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö
    ar_auto_remove_demo_on_real_project($user_id);
    
    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã
    $projects = AR_Project_Cache::get_user_projects($user_id);
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º - –î–û–ë–ê–í–õ–Ø–ï–ú ABANDONED
    $grouped_projects = [
        'new' => ['title' => '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç', 'icon' => 'üìã', 'projects' => []],
        'in_progress' => ['title' => '–ó–∞–ø—É—â–µ–Ω –≤ —Ä–∞–±–æ—Ç—É', 'icon' => 'üî®', 'projects' => []],
        'pending' => ['title' => '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏', 'icon' => '‚è≥', 'projects' => []],
        'completed' => ['title' => '–ó–∞–≤–µ—Ä—à–µ–Ω', 'icon' => '‚úÖ', 'projects' => []],
        'abandoned' => ['title' => '–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ', 'icon' => 'üóëÔ∏è', 'projects' => []]
    ];
    
    // –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ï–ú –ö–û–ú–ò–°–°–ò–Æ –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ü–†–û–ï–ö–¢–ê
    foreach ($projects as &$project) {
        $project_value = floatval($project['value']);
        $designer_income = floatval($project['designer_income']);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é 10% –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ —Ä–∞–≤–Ω–∞ 0
        if (($designer_income == 0 || empty($designer_income)) && $project_value > 0) {
            $project['designer_income'] = $project_value * 0.1;
        }
        
        $status = $project['status'] ?? 'in_progress';
        if (isset($grouped_projects[$status])) {
            $grouped_projects[$status]['projects'][] = $project;
        }
    }
    unset($project); // –≤–∞–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Å—ã–ª–∫—É
    
    // –†–ê–°–ß–ï–¢ –û–ë–©–ï–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò
    $total_projects = count($projects);
    $total_value = array_sum(array_column($projects, 'value'));
    $total_income = array_sum(array_column($projects, 'designer_income'));
    
    ob_start();
    ?>
    <div class="ar-crm-container">
        <!-- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô HEADER –° –ö–ù–û–ü–ö–û–ô –ü–†–û–§–ò–õ–Ø -->
        <div class="ar-account-header">
    <!-- –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ - –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏ –∫–Ω–æ–ø–∫–∏ -->
    <div class="ar-header-top">
        <div class="ar-user-info">
            <div class="ar-user-avatar">
                <?php 
                $avatar_url = get_user_meta($user_id, 'ar_profile_avatar', true);
                if (!$avatar_url) {
                    $avatar_url = get_avatar_url($user_id, ['size' => 40]);
                }
                ?>
                <img src="<?php echo esc_url($avatar_url); ?>" alt="<?php echo esc_attr(wp_get_current_user()->display_name); ?>" class="ar-avatar">
            </div>
            <div class="ar-user-details">
                <div class="ar-user-name"><?php echo esc_html(wp_get_current_user()->display_name); ?></div>
                <div class="ar-user-role">–ü–∞—Ä—Ç–Ω–µ—Ä-–¥–∏–∑–∞–π–Ω–µ—Ä Art Rocket</div>
            </div>
        </div>
        
        <div class="ar-header-actions">
            <nav class="ar-main-nav">
                <ul class="ar-nav-list">
                    
                    <li class="ar-nav-item">
                        <a href="https://art-rocket.ru/cont/" class="ar-nav-link">
                            <span class="ar-nav-icon">‚¨ÖÔ∏è</span>
                            –ù–∞–∑–∞–¥
                        </a>
                    </li>
                    
                    
                    <li class="ar-nav-item is-active">
                        <a href="https://art-rocket.ru/proiectele/" class="ar-nav-link">
                            <span class="ar-nav-icon">üìÅ</span>
                            –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã
                        </a>
                    </li>
                    <li class="ar-nav-item">
                        <a href="https://art-rocket.ru/designer-tascuri/" class="ar-nav-link">
                            <span class="ar-nav-icon">üìã</span>
                            –ó–∞–¥–∞—á–∏
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="ar-action-buttons">
                <button class="ar-btn-refresh" onclick="arRefreshCRM()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                        <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                    </svg>
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                
                <button class="ar-logout-btn" onclick="arOpenProfileModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ù–∏–∂–Ω–∏–π —Ä—è–¥ - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
 <div class="ar-header-bottom">
    <div class="ar-stats-overview">
        <div class="ar-stat-item">
            <span class="ar-stat-number"><?php echo $total_projects; ?></span>
            <span class="ar-stat-label">–í–°–ï–ì–û –ü–†–û–ï–ö–¢–û–í</span>
        </div>
        <div class="ar-stat-item">
            <span class="ar-stat-number"><?php echo number_format($total_value, 0, ',', '.'); ?> –†–£–ë</span>
            <span class="ar-stat-label">–û–ë–©–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨</span>
        </div>
        <div class="ar-stat-item">
            <span class="ar-stat-number"><?php echo number_format($total_income, 0, ',', '.'); ?> –†–£–ë</span>
            <span class="ar-stat-label">–û–ë–©–ê–Ø –ö–û–ú–ò–°–°–ò–Ø (10%)</span>
        </div>
        <div class="ar-stat-item">
            <span class="ar-stat-number"><?php echo AR_Project_Cache::get_last_cache_time($user_id); ?></span>
            <span class="ar-stat-label">–ü–û–°–õ–ï–î–ù–ï–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï</span>
        </div>
    </div>
</div>

</div>
        
        <?php if (empty($projects)): ?>
        <div class="ar-empty-state">
            <div class="ar-empty-icon">üì≠</div>
            <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
            <p>–í–∞—à–∏ –ø—Ä–æ–µ–∫—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –¥–ª—è –¥–∏–∑–∞–π–Ω–∞.</p>
        </div>
        <?php else: ?>
        <div class="ar-kanban-board">
        <?php foreach ($grouped_projects as $status => $group): ?>
        <div class="ar-kanban-column" data-status="<?php echo esc_attr($status); ?>">
            <div class="ar-column-header">
                <span class="ar-column-icon"><?php echo $group['icon']; ?></span>
                <h3><?php echo $group['title']; ?></h3>
                <span class="ar-column-count"><?php echo count($group['projects']); ?></span>
            </div>
            
            <div class="ar-projects-list" id="ar-projects-<?php echo esc_attr($status); ?>">
                <?php if ($status === 'new'): ?>
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ -->
                <div class="ar-new-project-card">
                    <button class="ar-btn-new-project" onclick="arCreateNewProject()">
                        <span class="ar-plus-icon">‚ûï</span>
                        <span class="ar-new-project-text">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</span>
                    </button>
                </div>
                <?php endif; ?>
                
                <?php foreach ($group['projects'] as $project): ?>
                <div class="ar-project-card" draggable="true" data-project-id="<?php echo esc_attr($project['project_id']); ?>">
    <div class="ar-project-card-header">
        <h4><?php echo esc_html($project['title']); ?></h4>
        <div class="ar-project-actions">
    
    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø -->
    <button class="ar-btn-icon-no-bg" onclick="arDeleteProject('<?php echo esc_js($project['project_id']); ?>')" title="–£–¥–∞–ª–∏—Ç—å">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3,6 5,6 21,6"></polyline>
            <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
    </button>
</div>
    </div>
    
    <div class="ar-project-card-body">
        <?php if (!empty($project['client_name'])): ?>
        <div class="ar-project-field">
            <span class="ar-field-label">–ö–ª–∏–µ–Ω—Ç:</span>
            <span class="ar-field-value"><?php echo esc_html($project['client_name']); ?></span>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($project['client_address'])): ?>
        <div class="ar-project-field">
            <span class="ar-field-label">–ê–¥—Ä–µ—Å:</span>
            <span class="ar-field-value"><?php echo esc_html($project['client_address']); ?></span>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($project['client_phone']) || !empty($project['client_email'])): ?>
        <div class="ar-project-field">
            <span class="ar-field-label">–ö–æ–Ω—Ç–∞–∫—Ç:</span>
            <span class="ar-field-value">
                <?php 
                $contacts = [];
                if (!empty($project['client_phone'])) $contacts[] = esc_html($project['client_phone']);
                if (!empty($project['client_email'])) $contacts[] = esc_html($project['client_email']);
                echo implode(' ‚Ä¢ ', $contacts);
                ?>
            </span>
        </div>
        <?php endif; ?>
        
        <div class="ar-project-field">
            <span class="ar-field-label">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
            <span class="ar-field-value"><?php echo number_format($project['value'], 0, ',', '.'); ?> <?php echo $project['currency']; ?></span>
        </div>
        
        <?php 
        $display_income = floatval($project['designer_income']);
        if ($display_income == 0 && $project['value'] > 0) {
            $display_income = $project['value'] * 0.1;
        }
        ?>
        <div class="ar-project-field">
            <span class="ar-field-label">–ö–æ–º–∏—Å—Å–∏—è:</span>
            <span class="ar-field-value"><?php echo number_format($display_income, 0, ',', '.'); ?> <?php echo $project['currency']; ?></span>
        </div>
        
        <div class="ar-project-field">
            <span class="ar-field-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</span>
            <span class="ar-field-value"><?php echo date('d.m.Y', strtotime($project['created_at'])); ?></span>
        </div>
        
        <?php if (!empty($project['project_deadline'])): ?>
        <div class="ar-project-field">
            <span class="ar-field-label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</span>
            <span class="ar-field-value"><?php echo date('d.m.Y', strtotime($project['project_deadline'])); ?></span>
        </div>
        <?php endif; ?>
    </div>
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="ar-project-card-footer">
                        <?php if ($status === 'abandoned'): ?>
                        <!-- –î–ª—è abandoned –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è -->
                        <button class="ar-btn-restore" onclick="arRestoreProject('<?php echo esc_attr($project['project_id']); ?>')">
                            üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        <?php else: ?>
                        <button class="ar-btn-details" onclick="arShowProjectDetails('<?php echo esc_attr($project['project_id']); ?>')">
                            üëÅÔ∏è –î–µ—Ç–∞–ª–∏
                        </button>
                        <?php endif; ?>
                    </div>
</div>
<?php endforeach; ?>
                    
                    <?php if (empty($group['projects']) && $status !== 'new'): ?>
                    <div class="ar-empty-column">
                        <div class="ar-empty-icon">üìù</div>
                        <p>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
        <?php endif; ?>
    </div>





<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è - –û–ë–ù–û–í–õ–ï–ù–ù–û–ï –° –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ú–ò –ü–û–õ–Ø–ú–ò -->
<div id="arProfileModal" class="ar-modal" style="display: none;">
    <div class="ar-modal-content" style="max-width: 600px;">
        <div class="ar-modal-header">
            <h2>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <button class="ar-modal-close" onclick="arCloseProfileModal()">√ó</button>
        </div>
        
        <div class="ar-modal-body">
            <form id="arProfileForm" enctype="multipart/form-data">
                <!-- –ê–≤–∞—Ç–∞—Ä –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="ar-profile-compact-header">
                    <div class="ar-avatar-section-compact">
                        <!-- –û–±–ª–æ–∂–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
                        <div class="ar-cover-section-compact">
                            <?php 
                            $cover_url = ar_get_user_profile_cover($user_id);
                            ?>
                            <div class="ar-cover-preview-compact" onclick="document.getElementById('arCoverUpload1').click();" 
                                 style="background-image: url('<?php echo esc_url($cover_url ?: 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 800 200%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22800%22 height=%22200%22/%3E%3C/svg%3E'); ?>'); background-size: cover; background-position: center;">
                                <div class="ar-cover-upload-hint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.5); padding: 10px 15px; border-radius: 4px; color: white; font-size: 12px; cursor: pointer;">
                                    üì∑ –ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É
                                </div>
                            </div>
                            <input type="file" id="arCoverUpload1" name="ar_cover_upload" accept="image/jpeg,image/png,image/webp" class="ar-cover-upload" style="display: none;">
                        </div>
                        
                        <!-- –ê–≤–∞—Ç–∞—Ä -->
                            <div class="ar-avatar-preview-compact" onclick="document.getElementById('arAvatarUpload1').click();">
            <img id="arAvatarPreview1" src="<?php echo esc_url($avatar_url); ?>" 
                alt="Avatar" class="ar-avatar-img-compact ar-avatar-preview">
            <input type="file" id="arAvatarUpload1" name="ar_avatar_upload" accept="image/*" class="ar-avatar-upload" style="display: none;">
        </div>
                    </div>
                    
                    <div class="ar-basic-info-compact">
                        <div class="ar-form-group-compact">
                            <input type="text" class="ar-form-input-compact" name="first_name" 
                                   value="<?php echo esc_attr(get_user_meta($user_id, 'first_name', true)); ?>" 
                                   placeholder="–§–∞–º–∏–ª–∏—è" required>
                        </div>
                        <div class="ar-form-group-compact">
                            <input type="text" class="ar-form-input-compact" name="last_name" 
                                   value="<?php echo esc_attr(get_user_meta($user_id, 'last_name', true)); ?>" 
                                   placeholder="–ò–º—è" required>
                        </div>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                <div class="ar-form-fields-compact">
                    <div class="ar-form-group-compact">
                        <input type="email" class="ar-form-input-compact" name="email" 
                               value="<?php echo esc_attr(wp_get_current_user()->user_email); ?>" 
                               placeholder="Email" required>
                    </div>
                    
                    <div class="ar-form-group-compact">
                        <input type="tel" class="ar-form-input-compact" name="phone" 
                               value="<?php echo esc_attr(get_user_meta($user_id, 'phone', true) ?: get_user_meta($user_id, 'billing_phone', true)); ?>" 
                               placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                    </div>
                </div>

                <!-- –ì–æ—Ä–æ–¥ –∏ —Å—Ç—Ä–∞–Ω–∞ -->
                <div class="ar-form-fields-compact">
                    <div class="ar-form-group-compact">
                        <input type="text" class="ar-form-input-compact" name="city" 
                               value="<?php echo esc_attr(get_user_meta($user_id, 'city', true)); ?>" 
                               placeholder="–ì–æ—Ä–æ–¥">
                    </div>
                    
                    <div class="ar-form-group-compact">
                        <input type="text" class="ar-form-input-compact" name="country" 
                               value="<?php echo esc_attr(get_user_meta($user_id, 'country', true)); ?>" 
                               placeholder="–°—Ç—Ä–∞–Ω–∞">
                    </div>
                </div>

                <!-- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ -->
                <div class="ar-detail-section-compact">
                    <h3>üåê –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</h3>
                    <div class="ar-detail-list-compact">
                        <div class="ar-field-group-compact">
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">LinkedIn</label>
                                <input type="url" class="ar-editable-field-compact" name="linkedin" 
                                       value="<?php echo esc_attr(get_user_meta($user_id, 'linkedin', true)); ?>" 
                                       placeholder="https://linkedin.com/in/...">
                            </div>
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">Facebook</label>
                                <input type="url" class="ar-editable-field-compact" name="facebook" 
                                       value="<?php echo esc_attr(get_user_meta($user_id, 'facebook', true)); ?>" 
                                       placeholder="https://facebook.com/...">
                            </div>
                        </div>
                        <div class="ar-detail-item-compact">
                            <label class="ar-detail-label-compact">Instagram</label>
                            <input type="url" class="ar-editable-field-compact" name="instagram" 
                                   value="<?php echo esc_attr(get_user_meta($user_id, 'instagram', true)); ?>" 
                                   placeholder="https://instagram.com/...">
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ -->
                <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏ —Å –ø–æ–ª–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –º–µ—Ç—Ä–∞ -->
<div class="ar-detail-section-compact">
    <h3>üè¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏</h3>
    <div class="ar-detail-list-compact">
        <div class="ar-detail-item-compact">
            <label class="ar-detail-label-compact">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
            <input type="text" class="ar-editable-field-compact" name="company_name" 
                   value="<?php echo esc_attr(get_user_meta($user_id, 'company_name', true)); ?>" 
                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
        </div>
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–æ–ª–µ: –°—Ç–æ–∏–º–æ—Å—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –º–µ—Ç—Ä–∞ -->
        <div class="ar-detail-item-compact">
            <label class="ar-detail-label-compact">–°—Ç–æ–∏–º–æ—Å—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –º–µ—Ç—Ä–∞ (‚Ç¨)</label>
            <input type="number" class="ar-editable-field-compact" name="price_per_sqm" 
                   value="<?php echo esc_attr(get_user_meta($user_id, 'price_per_sqm', true)); ?>" 
                   placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="ar-field-group-compact">
            <div class="ar-detail-item-compact">
                <label class="ar-detail-label-compact">–§–ò–°–ö–ê–õ–¨–ù–´–ô –ö–û–î</label>
                <input type="text" class="ar-editable-field-compact" name="fiscal_code" 
                       value="<?php echo esc_attr(get_user_meta($user_id, 'fiscal_code', true)); ?>" 
                       placeholder="–§–∏—Å–∫–∞–ª—å–Ω—ã–π –∫–æ–¥">
            </div>
            <div class="ar-detail-item-compact">
                <label class="ar-checkbox-compact">
                    <input type="checkbox" name="vat_registered" value="1" <?php checked(get_user_meta($user_id, 'vat_registered', true), 1); ?>>
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ù–î–°
                </label>
            </div>
        </div>
    </div>
</div>

                <!-- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
                <div class="ar-detail-section-compact">
                    <h3>üè¶ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
                    <div class="ar-detail-list-compact">
                        <div class="ar-detail-item-compact">
                            <label class="ar-detail-label-compact">IBAN</label>
                            <input type="text" class="ar-editable-field-compact" name="iban" 
                                   value="<?php echo esc_attr(get_user_meta($user_id, 'iban', true)); ?>" 
                                   placeholder="RO49 AAAA 1B31 0075 9384 0000">
                        </div>
                        <div class="ar-field-group-compact">
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">–ë–∞–Ω–∫</label>
                                <input type="text" class="ar-editable-field-compact" name="bank_name" 
                                       value="<?php echo esc_attr(get_user_meta($user_id, 'bank_name', true)); ?>" 
                                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞">
                            </div>
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">–ö–æ–¥ –±–∞–Ω–∫–∞</label>
                                <input type="text" class="ar-editable-field-compact" name="bank_code" 
                                       value="<?php echo esc_attr(get_user_meta($user_id, 'bank_code', true)); ?>" 
                                       placeholder="–ö–æ–¥ –±–∞–Ω–∫–∞">
                            </div>
                        </div>
                        <div class="ar-field-group-compact">
                            <div class="ar-detail-item-compact">
                                <label class="ar-detail-label-compact">–ö–æ–¥ –ù–î–°</label>
                                <input type="text" class="ar-editable-field-compact" name="vat_code" 
                                       value="<?php echo esc_attr(get_user_meta($user_id, 'vat_code', true)); ?>" 
                                       placeholder="–ù–î–° –∫–æ–¥">
                            </div>
                            <div class="ar-detail-item-compact">
                                <!-- –ü—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–∞—Ä–æ–ª–∏ -->
                <div class="ar-detail-section-compact">
                    <h3>üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                    <div class="ar-password-fields-compact">
                        <div class="ar-form-group-compact">
                            <input type="password" class="ar-form-input-compact" name="new_password" 
                                   placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                        </div>
                        <div class="ar-form-group-compact">
                            <input type="password" class="ar-form-input-compact" name="confirm_password" 
                                   placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                        </div>
                    </div>
                </div>
                
                <div id="arAvatarError" style="color: #dc3545; font-size: 12px; margin-top: 10px; display: none;"></div>
            </form>
        </div>
        
        <div class="ar-modal-footer-compact">
            <button class="ar-btn-compact ar-btn-secondary-compact" onclick="arCloseProfileModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="ar-btn-compact ar-btn-primary-compact" onclick="arSaveProfile()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>
</div>







   <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div id="arNewProjectModal" class="ar-modal">
        <div class="ar-modal-content">
            <div class="ar-modal-header">
                <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>
                <button class="ar-modal-close" onclick="arCloseNewProjectModal()">√ó</button>
            </div>
            
            <div class="ar-modal-body">
                <form id="arNewProjectForm">
                    <div class="ar-form-group">
                        <label class="ar-form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                        <input type="text" class="ar-form-input" name="project_title" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
                    </div>
                    
                    <div class="ar-form-group">
                        <label class="ar-form-label">–ö–ª–∏–µ–Ω—Ç</label>
                        <input type="text" class="ar-form-input" name="client_name" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
                    </div>
                    
                    <div class="ar-form-group">
                        <label class="ar-form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ (–†–£–ë)</label>
                        <input type="number" class="ar-form-input" name="project_value" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="ar-form-group">
                        <label class="ar-form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="ar-form-input" name="project_description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="ar-modal-footer">
                <button class="ar-btn ar-btn-secondary" onclick="arCloseNewProjectModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ar-btn ar-btn-primary" onclick="arSaveNewProject()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
            </div>
        </div>
    </div>

    <div id="arProjectModal" class="ar-modal">
        <div class="ar-modal-content">
            <div class="ar-modal-header">
                <h2 id="arModalTitle">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</h2>
                <button class="ar-modal-close" onclick="arCloseModal()">√ó</button>
            </div>
            
            <div class="ar-modal-body" id="arModalBody">
            </div>
            
            <div class="ar-modal-footer">
                <button class="ar-btn ar-btn-secondary" onclick="arCloseModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="ar-btn ar-btn-primary" onclick="arExportFullEstimate()">üìä –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–π —Å–º–µ—Ç—ã</button>
            </div>
        </div>
    </div>

   <style>
   
   /* ===== –§–û–¢–û –ü–†–û–ï–ö–¢–ê –í –ú–û–î–ê–õ–¨–ù–û–ú –û–ö–ù–ï ===== */

.ar-project-photos-section-compact {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #edf2f7;
}

.ar-project-photos-section-compact h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
    color: #1f2933;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–∞–ª–µ—Ä–µ–∏ */
.ar-project-photos-gallery {
    background: #f8fafc;
    border-radius: 10px;
    padding: 12px;
    border: 1px solid #e2e8f0;
}

/* –°–µ—Ç–∫–∞ –ø—Ä–µ–≤—å—é */
.ar-photos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
}

/* –û–¥–Ω–∞ —è—á–µ–π–∫–∞ —Å —Ñ–æ—Ç–æ */
.ar-photo-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    background: #e5ecf5;
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.ar-photo-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.18);
}

/* –°–∞–º–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
.ar-photo-gallery-img {
    width: 100%;
    height: 110px;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease, filter 0.3s ease;
}

.ar-photo-item:hover .ar-photo-gallery-img {
    transform: scale(1.05);
    filter: brightness(1.05);
}

/* –ï—Å–ª–∏ —Ä–µ—à–∏—à—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∏ –ø–æ–≤–µ—Ä—Ö ‚Äì –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ */
.ar-photo-info-overlay {
    position: absolute;
    inset: auto 0 0 0;
    padding: 5px 8px;
    background: linear-gradient(to top, rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0));
    color: #fff;
    font-size: 11px;
    line-height: 1.3;
}

/* –ö–Ω–æ–ø–∫–∏ –ø–æ–¥ –≥–∞–ª–µ—Ä–µ–µ–π */
.ar-photos-actions {
    margin-top: 10px;
    text-align: right;
}

.ar-btn-upload-more,
.ar-btn-upload-photos {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 12px;
    font-size: 13px;
    font-weight: 500;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    background: #4f46e5;
    color: #fff;
    box-shadow: 0 2px 6px rgba(79, 70, 229, 0.4);
    transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
}

.ar-btn-upload-more:hover,
.ar-btn-upload-photos:hover {
    background: #4338ca;
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(67, 56, 202, 0.5);
}

.ar-btn-upload-more:active,
.ar-btn-upload-photos:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.4);
}

/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π) */
.ar-no-photos {
    background: #f9fafb;
    border-radius: 10px;
    padding: 16px 14px;
    border: 1px dashed #cbd5e1;
    text-align: center;
    color: #6b7280;
    font-size: 13px;
}

.ar-no-photos p {
    margin: 0 0 10px 0;
}

/* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 480px) {
    .ar-photos-grid {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    }

    .ar-photo-gallery-img {
        height: 90px;
    }
}

   
   
   /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–µ–∫—Ü–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
.ar-detail-section-compact {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin: 0 0 16px 0;
}

.ar-detail-section-compact h3 {
    margin: 0 0 12px 0;
    color: #1e293b;
    font-size: 13px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
}

.ar-detail-list-compact {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.ar-detail-item-compact {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.ar-detail-label-compact {
    color: #64748b;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ–ª–µ–π –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
.ar-field-group-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

/* –ß–µ–∫–±–æ–∫—Å –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Å—Ç–∏–ª–µ */
.ar-checkbox-compact {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: #1e293b;
    cursor: pointer;
    margin-top: 8px;
}

.ar-checkbox-compact input[type="checkbox"] {
    width: 14px;
    height: 14px;
    accent-color: #e65c00;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π */
@media (max-width: 480px) {
    .ar-field-group-compact {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .ar-detail-section-compact {
        padding: 12px;
    }
    
    .ar-detail-section-compact h3 {
        font-size: 12px;
    }
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
.ar-editable-field-compact:focus {
    border-color: #e65c00;
    box-shadow: 0 0 0 2px rgba(230, 92, 0, 0.1);
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è URL –ø–æ–ª–µ–π */
input[type="url"].ar-editable-field-compact {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 14px;
    padding-right: 30px;
}

/* ========= –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò CRM ========= */
.ar-crm-container {
    width: 100%;
    margin: 0 auto;
    min-height: 100vh;
    color: #334155;
    font-family: 'Montserrat', sans-serif;
    background: transparent;
    overflow-x: hidden;
}

.ar-crm-container * {
    box-sizing: border-box;
}

/* ========= –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ========= */
.ar-account-header {
    background: #ffffff;
    border-radius: 12px;
    padding: 0;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
}

.ar-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #f1f5f9;
    background: #ffffff;
    flex-wrap: wrap;
    gap: 12px;
    border-radius: 35px;
}

.ar-header-bottom {
    padding: 16px 20px;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
.ar-user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

.ar-user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
}

.ar-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.ar-user-details {
    display: flex;
    flex-direction: column;
}

.ar-user-name {
    font-weight: 600;
    color: #1e293b;
    font-size: 14px;
    line-height: 1.2;
}

.ar-user-role {
    color: #64748b;
    font-size: 11px;
    font-weight: 500;
    margin-top: 1px;
}

/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
.ar-header-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
}

.ar-main-nav {
    margin-right: 0;
}

.ar-nav-list {
    display: flex;
    gap: 6px;
    list-style: none;
    margin: 0;
    padding: 0;
}

.ar-nav-item {
    margin: 0;
}

.ar-nav-item.is-active .ar-nav-link {
    background: #e65c00;
    border-color: #e65c00;
    color: #ffffff;
    box-shadow: 0 1px 4px rgba(230, 92, 0, 0.2);
}

.ar-nav-link {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    color: #64748b;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.ar-nav-link:hover {
    background: #ffffff;
    border-color: #e65c00;
    color: #e65c00;
    transform: translateY(-1px);
    box-shadow: 0 1px 4px rgba(230, 92, 0, 0.1);
}

.ar-nav-icon {
    font-size: 14px;
    opacity: 0.8;
}

.ar-nav-item.is-active .ar-nav-icon {
    opacity: 1;
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.ar-action-buttons {
    display: flex;
    align-items: center;
    gap: 8px;
}

.ar-btn-refresh {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #f8f9fa;
    color: #64748b;
    border: 1px solid #e2e8f0;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
}

.ar-btn-refresh:hover {
    background: #ffffff;
    border-color: #e65c00;
    color: #e65c00;
    transform: translateY(-1px);
    box-shadow: 0 1px 4px rgba(230, 92, 0, 0.1);
}

.ar-logout-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: transparent;
    color: #64748b;
    border: 1px solid #e2e8f0;
    padding: 8px 12px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
    cursor: pointer;
}

.ar-logout-btn:hover {
    background: #f8fafc;
    color: #e65c00;
    border-color: #e65c00;
}

.ar-logout-btn svg {
    width: 14px;
    height: 14px;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.ar-stats-overview {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    align-items: center;
}

.ar-stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}

.ar-stat-number {
    font-size: 16px;
    font-weight: 700;
    color: #e65c00;
    line-height: 1;
}

.ar-stat-label {
    font-size: 10px;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    line-height: 1;
}

/* ========= –ö–ê–ù–ë–ê–ù –î–û–°–ö–ê - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–ï–¢–ö–ê ========= */
.ar-kanban-board {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    align-items: start;
    width: 100%;
    min-width: 0;
}

/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–ª–æ–Ω–æ–∫ */
.ar-kanban-column {
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    min-height: 500px;
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: hidden;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    width: 100%;
}

.ar-kanban-column::-webkit-scrollbar {
    width: 3px;
}

.ar-kanban-column::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.ar-kanban-column::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 1.5px;
}

.ar-kanban-column {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–ª–æ–Ω–∫–∏ */
.ar-column-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 12px;
    border-bottom: 1px solid #f1f5f9;
    position: sticky;
    top: 0;
    background: #ffffff;
    z-index: 1;
    border-radius: 10px 10px 0 0;
}

.ar-column-icon {
    font-size: 14px;
}

.ar-column-count {
    background: #e65c00;
    color: #fff;
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    min-width: 16px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(230, 92, 0, 0.3);
}

/* –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ */
.ar-projects-list {
    padding: 8px;
    min-height: 400px;
    padding-right: 4px;
}

/* –ö–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ */
.ar-new-project-card {
    margin-bottom: 10px;
}

.ar-btn-new-project {
    width: 100% !important;
    background: #f8f9fa !important;
    color: #64748b !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 8px !important;
    padding: 12px 10px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    gap: 4px !important;
    font-size: 11px !important;
    font-weight: 600 !important;
    box-shadow: none !important;
}

.ar-btn-new-project:hover {
    background: #ffffff !important;
    border-color: #e65c00 !important;
    color: #e65c00 !important;
    transform: translateY(-1px);
    box-shadow: 0 1px 4px rgba(230, 92, 0, 0.1);
}

.ar-plus-icon {
    font-size: 16px !important;
}

.ar-new-project-text {
    font-size: 10px !important;
    white-space: nowrap !important;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ */
.ar-project-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: move;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    position: relative;
    overflow: hidden;
    width: 100%;
}

.ar-project-card:hover {
    border-color: #e65c00;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(230, 92, 0, 0.1);
}

.ar-project-card.dragging {
    opacity: 0.6;
    transform: rotate(3deg);
    box-shadow: 0 4px 12px rgba(230, 92, 0, 0.15);
}

/* –®–∞–ø–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.ar-project-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f8fafc;
    width: 100%;
}

.ar-project-card-header h4 {
    margin: 0;
    color: #1e293b;
    font-size: 10px;
    line-height: 1.2;
    flex: 1;
    margin-right: 6px;
    font-weight: 500;
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 130px;
}

.ar-project-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}

.ar-btn-icon {
    background: #f8fafc !important;
    border: 1px solid #e2e8f0 !important;
    color: #64748b;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.15s ease;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.ar-btn-icon:hover {
    background: #ffffff !important;
    border-color: #e65c00 !important;
    color: #e65c00;
    transform: scale(1.05);
}

.ar-btn-icon svg {
    width: 10px;
    height: 10px;
}

/* –¢–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.ar-project-card-body {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
    width: 100%;
}

.ar-project-field {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    align-items: flex-start;
    line-height: 1.1;
    width: 100%;
    gap: 4px;
}

.ar-field-label {
    color: #64748b;
    font-weight: 600;
    flex-shrink: 0;
    min-width: 45px;
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.2px;
}

.ar-field-value {
    color: #1e293b;
    font-weight: 400;
    text-align: right;
    flex: 1;
    line-height: 1.1;
    font-size: 9px;
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 100px;
}

/* –§—É—Ç–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ */
.ar-project-card-footer {
    text-align: center;
    padding-top: 8px;
    border-top: 1px solid #f8fafc;
    width: 100%;
}

.ar-btn-details {
    background: #f8f9fa !important;
    color: #64748b !important;
    border: 1px solid #e2e8f0 !important;
    padding: 5px 8px !important;
    border-radius: 5px !important;
    font-size: 9px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    width: 100% !important;
    white-space: nowrap !important;
    font-weight: 500 !important;
    box-shadow: none !important;
}

.ar-btn-details:hover {
    background: #ffffff !important;
    border-color: #e65c00 !important;
    color: #e65c00 !important;
    transform: translateY(-1px);
    box-shadow: 0 1px 3px rgba(230, 92, 0, 0.1);
}

/* –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è */
.ar-btn-restore {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    color: white !important;
    border: none !important;
    padding: 5px 8px !important;
    border-radius: 5px !important;
    font-size: 9px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    width: 100% !important;
    font-weight: 600 !important;
    box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3) !important;
}

.ar-btn-restore:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(16, 185, 129, 0.4) !important;
}

/* –ü—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.ar-empty-state {
    text-align: center;
    padding: 40px 20px;
    background: #ffffff;
    border-radius: 10px;
    border: 2px dashed #e2e8f0;
    margin: 20px 0;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}

.ar-empty-column {
    text-align: center;
    padding: 30px 15px;
    color: #94a3b8;
    font-size: 10px;
}

.ar-empty-icon {
    font-size: 20px;
    margin-bottom: 8px;
    opacity: 0.5;
}

.ar-empty-state .ar-empty-icon {
    font-size: 32px;
    margin-bottom: 12px;
    opacity: 0.6;
    color: #64748b;
}

.ar-empty-state h3 {
    color: #1e293b;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
}

.ar-empty-state p,
.ar-empty-column p {
    color: #64748b;
    font-size: 11px;
    line-height: 1.4;
    max-width: 300px;
    margin: 0 auto;
}

/* ========= –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ========= */
.ar-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(4px);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    animation: arModalFadeIn 0.2s ease;
}

@keyframes arModalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.ar-modal-content {
    background: #ffffff;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    border: 1px solid #e2e8f0;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    animation: arModalSlideIn 0.2s ease;
}

@keyframes arModalSlideIn {
    from { 
        transform: scale(0.95) translateY(-10px);
        opacity: 0;
    }
    to { 
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

.ar-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #f1f5f9;
    background: #f8fafc;
    border-radius: 12px 12px 0 0;
}

.ar-modal-header h2 {
    margin: 0;
    color: #1e293b;
    font-size: 16px;
    font-weight: 700;
}

.ar-modal-close {
    background: #f1f5f9;
    border: none;
    color: #64748b;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.15s ease;
}

.ar-modal-close:hover {
    background: #e2e8f0;
    color: #475569;
}

.ar-modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
    scrollbar-gutter: stable;
}

.ar-modal-body::-webkit-scrollbar {
    width: 4px;
}

.ar-modal-body::-webkit-scrollbar-track {
    background: #f8fafc;
}

.ar-modal-body::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

.ar-modal-body {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f8fafc;
}

.ar-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 16px 20px;
    border-top: 1px solid #f1f5f9;
    background: #f8fafc;
    border-radius: 0 0 12px 12px;
}

/* –ö–Ω–æ–ø–∫–∏ */
.ar-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.ar-btn-primary {
    background: #e65c00;
    color: #fff;
    box-shadow: 0 1px 3px rgba(230, 92, 0, 0.3);
}

.ar-btn-primary:hover {
    background: #cc4c00;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(230, 92, 0, 0.4);
}

.ar-btn-secondary {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
}

.ar-btn-secondary:hover {
    background: #e2e8f0;
    color: #374151;
}

/* ========= –ö–û–ú–ü–ê–ö–¢–ù–´–ô –ü–†–û–§–ò–õ–¨ ========= */
.ar-profile-compact-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f1f5f9;
}

.ar-avatar-section-compact {
    flex-shrink: 0;
}

.ar-avatar-preview-compact {
     cursor: pointer; /* –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    position: relative;
    width: 60px;
    height: 60px;
}

.ar-avatar-img-compact {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e65c00;
}

.ar-avatar-change-btn {
    position: absolute;
    bottom: -4px;
    right: -4px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #e65c00 !important;
    color: white !important;
    border: none !important;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
    z-index: 1; /* –ß—Ç–æ–±—ã –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –∞–≤–∞—Ç–∞—Ä–∞ */
}
.ar-avatar-change-btn:hover {
    background: #cc4c00;
    transform: scale(1.1);
}

.ar-basic-info-compact {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ar-form-fields-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ar-password-fields-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.ar-form-group-compact {
    margin: 0;
}
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ñ–æ—Ä–º—ã */
.ar-modal-body {
    padding: 20px;
   
}

.ar-profile-compact-header {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    margin-bottom: 25px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}

/* –ê–≤–∞—Ç–∞—Ä */
.ar-avatar-section-compact {
    position: relative;
}

.ar-avatar-preview-compact {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.ar-avatar-preview-compact:hover {
    transform: scale(1.05);
}

.ar-avatar-img-compact {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.ar-avatar-change-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #e65c00, #ff7a3d);
    border: 3px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 10;
}

.ar-avatar-change-btn:hover {
    background: linear-gradient(135deg, #cc4c00, #e65c00);
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.ar-avatar-change-btn:active {
    transform: scale(1.05) translateY(0);
}

.ar-avatar-change-btn img.emoji {
    width: 16px !important;
    height: 16px !important;
    margin: 0 !important;
    padding: 0 !important;
    display: block;
    filter: brightness(0) invert(1);
    -webkit-user-drag: none;
    user-select: none;
}

/* –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
.ar-basic-info-compact {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.ar-form-fields-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.ar-password-fields-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.ar-form-group-compact {
    position: relative;
}

.ar-form-input-compact {
    width: 100%;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 12px 16px;
    color: #334155;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
}

.ar-form-input-compact:hover {
    border-color: #cbd5e1;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.04);
}

.ar-form-input-compact:focus {
    outline: none;
    border-color: #e65c00;
    background: white;
    box-shadow: 0 0 0 4px rgba(230, 92, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
}

.ar-form-input-compact::placeholder {
    color: #94a3b8;
    font-weight: 400;
}

/* –°–µ–∫—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏ */
.ar-detail-section-compact {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.ar-detail-section-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.08), 0 4px 6px -1px rgba(0, 0, 0, 0.04);
}

.ar-detail-section-compact h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0 0 18px 0;
    color: #1e293b;
    font-size: 16px;
    font-weight: 600;
}

.ar-detail-section-compact h3 img {
    width: 20px;
    height: 20px;
}

.ar-detail-list-compact {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ar-field-group-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.ar-detail-item-compact {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.ar-detail-label-compact {
    color: #64748b;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 2px;
}

.ar-editable-field-compact {
    width: 100%;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px 14px;
    color: #334155;
    font-size: 14px;
    transition: all 0.3s ease;
}

.ar-editable-field-compact:hover {
    border-color: #cbd5e1;
    background: white;
}

.ar-editable-field-compact:focus {
    outline: none;
    border-color: #e65c00;
    background: white;
    box-shadow: 0 0 0 3px rgba(230, 92, 0, 0.1);
}

/* –ß–µ–∫–±–æ–∫—Å */
.ar-checkbox-compact {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    cursor: pointer;
    color: #475569;
    font-size: 14px;
    font-weight: 500;
}

.ar-checkbox-compact input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 2px solid #cbd5e1;
    cursor: pointer;
    transition: all 0.3s ease;
}

.ar-checkbox-compact input[type="checkbox"]:checked {
    background-color: #e65c00;
    border-color: #e65c00;
}

/* –§—É—Ç–µ—Ä –∏ –∫–Ω–æ–ø–∫–∏ */
.ar-modal-footer-compact {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 20px 20px 20px;
    margin-top: 20px;
    border-top: 1px solid #f1f5f9;
}

.ar-btn-compact {
    padding: 11px 24px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 100px;
    letter-spacing: 0.3px;
}

.ar-btn-primary-compact {
    background: linear-gradient(135deg, #e65c00, #ff7a3d);
    color: white;
    box-shadow: 0 4px 12px rgba(230, 92, 0, 0.2);
}

.ar-btn-primary-compact:hover {
    background: linear-gradient(135deg, #cc4c00, #e65c00);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(230, 92, 0, 0.3);
}

.ar-btn-primary-compact:active {
    transform: translateY(0);
}

.ar-btn-secondary-compact {
    background: white;
    color: #475569;
    border: 2px solid #e2e8f0;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

.ar-btn-secondary-compact:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ */
#arAvatarError {
    background: #fee2e2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    margin-top: 16px;
    display: none;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .ar-profile-compact-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .ar-basic-info-compact,
    .ar-form-fields-compact,
    .ar-password-fields-compact,
    .ar-field-group-compact {
        grid-template-columns: 1fr;
    }
    
    .ar-modal-footer-compact {
        flex-direction: column-reverse;
    }
    
    .ar-btn-compact {
        width: 100%;
    }
}

/* ========= –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ========= */

/* –ë–æ–ª—å—à–∏–µ —ç–∫—Ä–∞–Ω—ã */
@media (max-width: 1920px) {
    .ar-kanban-board {
        grid-template-columns: repeat(5, minmax(180px, 1fr));
        gap: 10px;
    }
}

@media (max-width: 1680px) {
    .ar-kanban-board {
        grid-template-columns: repeat(4, minmax(170px, 1fr));
        gap: 10px;
    }
}

@media (max-width: 1440px) {
    .ar-kanban-board {
        grid-template-columns: repeat(4, minmax(160px, 1fr));
        gap: 8px;
    }
    
    .ar-stats-overview {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
}

@media (max-width: 1280px) {
    .ar-kanban-board {
        grid-template-columns: repeat(3, minmax(150px, 1fr));
        gap: 8px;
    }
    
    .ar-kanban-column {
        min-height: 450px;
    }
}

/* –ü–ª–∞–Ω—à–µ—Ç—ã */
@media (max-width: 1024px) {
    .ar-kanban-board {
        grid-template-columns: repeat(2, minmax(140px, 1fr));
        gap: 10px;
    }
    
    .ar-header-top {
        flex-direction: column;
        gap: 12px;
        text-align: center;
    }
    
    .ar-user-info {
        justify-content: center;
    }
    
    .ar-header-actions {
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }
    
    .ar-action-buttons {
        justify-content: center;
        width: 100%;
    }
}

/* –ú–æ–±–∏–ª—å–Ω—ã–µ */
@media (max-width: 768px) {
    .ar-kanban-board {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .ar-nav-list {
        flex-direction: column;
        width: 100%;
    }
    
    .ar-nav-link {
        justify-content: center;
        padding: 10px 12px;
    }
    
    .ar-action-buttons {
        flex-direction: column;
        width: 100%;
    }
    
    .ar-btn-refresh,
    .ar-logout-btn {
        width: 100%;
        justify-content: center;
    }
    
    .ar-stats-overview {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .ar-project-field {
        flex-direction: column;
        gap: 2px;
        align-items: flex-start;
    }
    
    .ar-field-value {
        text-align: left;
    }
}

/* –ú–∞–ª–µ–Ω—å–∫–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ */
@media (max-width: 480px) {
    .ar-crm-container {
        padding: 8px;
    }
    
    .ar-header-top,
    .ar-header-bottom {
        padding: 12px 15px;
    }
    
    .ar-stat-number {
        font-size: 14px;
    }
    
    .ar-stat-label {
        font-size: 9px;
    }
    
    .ar-user-name {
        font-size: 13px;
    }
    
    .ar-user-role {
        font-size: 10px;
    }
    
    .ar-modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .ar-modal-footer {
        flex-direction: column;
    }
    
    .ar-btn {
        width: 100%;
    }
    
    .ar-profile-compact-header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .ar-password-fields-compact {
        grid-template-columns: 1fr;
    }
    
    .ar-modal-footer-compact {
        flex-direction: column;
    }
    
    .ar-btn-compact {
        width: 100%;
    }
}

/* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
@media (max-width: 360px) {
    .ar-crm-container {
        padding: 6px;
    }
    
    .ar-kanban-board {
        gap: 8px;
    }
    
    .ar-project-card {
        padding: 10px;
    }
    
    .ar-column-header {
        padding: 10px;
    }
    
    .ar-projects-list {
        padding: 6px;
    }
    
    .ar-field-label {
        min-width: 40px;
        font-size: 7px;
    }
    
    .ar-field-value {
        font-size: 8px;
    }
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ Necompletate */
.ar-kanban-column[data-status="abandoned"] .ar-project-card {
    border-left: 2px solid #94a3b8;
    background: #f8fafc;
}

.ar-kanban-column[data-status="abandoned"] .ar-field-value {
    color: #64748b;
}
</style>






    <script>
        
        
        
        
        
        
        
        
        
       (function() {
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏-–ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞ —Ñ–æ—Ç–æ
     */
    function ensurePhotoViewer() {
        let viewer = document.getElementById('arPhotoViewerModal');
        if (!viewer) {
            viewer = document.createElement('div');
            viewer.id = 'arPhotoViewerModal';
            viewer.className = 'ar-modal ar-photo-viewer-modal';
            viewer.style.display = 'none';
            viewer.innerHTML = `
                <div class="ar-modal-content ar-photo-viewer-content">
                    <button class="ar-modal-close" type="button" onclick="arClosePhotoViewer()">√ó</button>
                    <img id="arPhotoViewerImage" src="" alt="–§–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞">
                </div>
            `;
            document.body.appendChild(viewer);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            viewer.addEventListener('click', function(e) {
                if (e.target === this) {
                    closePhotoViewer();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Esc
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && viewer.style.display === 'flex') {
                    closePhotoViewer();
                }
            });
        }
        return viewer;
    }

    /**
     * –û–¢–ö–†–´–¢–¨ –ë–û–õ–¨–®–û–ï –§–û–¢–û
     * triggerEl ‚Äî —ç—Ç–æ this –∏–∑ onclick –≤ .ar-photo-item
     */
    function viewProjectPhoto(triggerEl, index) {
        if (!triggerEl) return;

        const viewer = ensurePhotoViewer();

        // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–¥–∞–ª–∫–∏, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ñ–æ—Ç–æ
        const container =
            triggerEl.closest('.ar-project-details-modal') ||  // –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–π –∫–ª–∞—Å—Å
            triggerEl.closest('.modal-backdrop') ||            // –∫–∞–∫ —É –º–æ–¥–∞–ª–∫–∏ –∑–∞—è–≤–æ–∫
            triggerEl.closest('.ar-modal') ||                  // –æ–±—â–∏–π –∫–ª–∞—Å—Å –º–æ–¥–∞–ª—å–Ω—ã—Ö
            document;                                          // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç

        const images = container.querySelectorAll('.ar-photo-gallery-img');
        if (!images || !images.length) {
            console.warn('arViewProjectPhoto: no images found inside modal');
            return;
        }
        if (index < 0 || index >= images.length) {
            console.warn('arViewProjectPhoto: image index out of range', index);
            return;
        }

        const imgEl = images[index];
        const fullUrl = imgEl.getAttribute('data-full') || imgEl.src;

        const viewerImg = document.getElementById('arPhotoViewerImage');
        viewerImg.src = fullUrl;

        viewer.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    /**
     * –ó–ê–ö–†–´–¢–¨ –ü–†–û–°–ú–û–¢–†–©–ò–ö –§–û–¢–û
     */
    function closePhotoViewer() {
        const viewer = document.getElementById('arPhotoViewerModal');
        if (viewer) {
            viewer.style.display = 'none';
        }
        document.body.style.overflow = '';
    }

    /**
     * üì§ –î–û–ë–ê–í–ò–¢–¨ –ï–©–Å –§–û–¢–û
     * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ø–∞–ø –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ (arShowPhotoUploadModal)
     */
    function uploadMorePhotos(projectId) {
        if (!projectId) return;

        // –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
        let title = '–ü—Ä–æ–µ–∫—Ç';
        const card = document.querySelector('.ar-project-card[data-project-id="' + projectId + '"]');
        if (card) {
            const h4 = card.querySelector('h4');
            if (h4) title = h4.textContent.trim();
        }

        if (typeof arShowPhotoUploadModal === 'function') {
            // —Ç—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä originalColumn –Ω–∞–º –Ω–µ –≤–∞–∂–µ–Ω –∑–¥–µ—Å—å
            arShowPhotoUploadModal(projectId, title, null);
        } else {
            console.error('arUploadMorePhotos: arShowPhotoUploadModal is not defined');
        }
    }

    /**
     * üì§ –ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û–ì–†–ê–§–ò–ò (–∫–æ–≥–¥–∞ —Ñ–æ—Ç–æ –µ—â—ë –Ω–µ—Ç)
     * –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç uploadMorePhotos
     */
    function uploadProjectPhotosFromDetails(projectId) {
        uploadMorePhotos(projectId);
    }

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
    window.arViewProjectPhoto = viewProjectPhoto;
    window.arClosePhotoViewer = closePhotoViewer;
    window.arUploadMorePhotos = uploadMorePhotos;
    window.arUploadProjectPhotosFromDetails = uploadProjectPhotosFromDetails;
})();
        
        
        
        
        
        
        
        
        
  
   // –§–£–ù–ö–¶–ò–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ü–†–û–ï–ö–¢–ê –ò–ó ABANDONED
    function arRestoreProject(projectId) {
        if (!confirm('Sigur dori»õi sƒÉ restaura»õi acest proiect?')) {
            return;
        }
        
        const data = new FormData();
        data.append('action', 'ar_restore_project');
        data.append('project_id', projectId);
        data.append('nonce', '<?php echo wp_create_nonce("ar_restore_project"); ?>');
        
        const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
        if (projectCard) {
            projectCard.style.opacity = '0.5';
        }
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            body: data,
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                arShowNotification('Proiectul a fost restaurat cu succes!', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                if (projectCard) {
                    projectCard.style.opacity = '1';
                }
                arShowNotification('Eroare: ' + (data.data || 'Nu s-a putut restaura proiectul'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (projectCard) {
                projectCard.style.opacity = '1';
            }
            arShowNotification('Eroare de conexiune', 'error');
        });
    }
  
        
        
   // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–§–ò–õ–ï–ú
    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–§–ò–õ–ï–ú - –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –î–õ–Ø –ö–û–ú–ü–ê–ö–¢–ù–û–ì–û –î–ò–ó–ê–ô–ù–ê
let currentAvatarFile = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö input –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    document.querySelectorAll('.ar-avatar-upload').forEach(function(uploadInput) {
        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞
            const maxSize = 2 * 1024 * 1024; // 2MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            
            if (!allowedTypes.includes(file.type)) {
                showAvatarError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ JPEG, PNG, GIF –∏–ª–∏ WebP.');
                return;
            }
            
            if (file.size > maxSize) {
                showAvatarError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2MB.');
                return;
            }
            
            // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const reader = new FileReader();
            reader.onload = function(e) {
                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
                const avatarContainer = uploadInput.closest('.ar-avatar-preview-compact');
                if (avatarContainer) {
                    const avatarImg = avatarContainer.querySelector('.ar-avatar-img-compact');
                    if (avatarImg) {
                        avatarImg.src = e.target.result;
                    }
                }
                currentAvatarFile = file;
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –±—ã–ª–æ
                const errorEl = document.getElementById('arAvatarError');
                if (errorEl) {
                    errorEl.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        });
    });
});

function showAvatarError(message) {
    const errorEl = document.getElementById('arAvatarError');
    if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
    } else {
        alert(message); // Fallback –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –æ—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Å–µ—Ö input –∑–∞–≥—Ä—É–∑–∫–∏
    document.querySelectorAll('.ar-avatar-upload').forEach(function(input) {
        input.value = '';
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function arOpenProfileModal() {
    // –°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    currentAvatarFile = null;
    
    // –°–±—Ä–æ—Å input –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    document.querySelectorAll('.ar-avatar-upload').forEach(function(input) {
        input.value = '';
    });
    
    // –°–∫—Ä—ã—Ç–∏–µ –æ—à–∏–±–æ–∫
    const errorEl = document.getElementById('arAvatarError');
    if (errorEl) {
        errorEl.style.display = 'none';
    }
    
    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('arProfileModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function arCloseProfileModal() {
    document.getElementById('arProfileModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    currentAvatarFile = null;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è input –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    document.querySelectorAll('.ar-avatar-upload').forEach(function(input) {
        input.value = '';
    });
    
    // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    const errorEl = document.getElementById('arAvatarError');
    if (errorEl) {
        errorEl.style.display = 'none';
    }
}

function arSaveProfile() {
    const form = document.getElementById('arProfileForm');
    if (!form) {
        console.error('–§–æ—Ä–º–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }
    
    const formData = new FormData(form);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword && newPassword !== confirmPassword) {
        arShowNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
        return;
    }
    
    if (newPassword && newPassword.length < 6) {
        arShowNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentAvatarFile) {
        formData.append('avatar_file', currentAvatarFile);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentCoverFile) {
        formData.append('cover_file', currentCoverFile);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ø–∞–ø–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentCoverFile1) {
        formData.append('cover_file', currentCoverFile1);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º action –∏ nonce
    formData.append('action', 'ar_save_profile');
    formData.append('nonce', '<?php echo wp_create_nonce("ar_save_profile"); ?>');
    
    const btn = document.querySelector('#arProfileModal .ar-btn-primary-compact');
    if (!btn) {
        console.error('–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...';
    btn.disabled = true;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
    fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
        method: 'POST',
        body: formData,
        credentials: 'include',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            arShowNotification('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if (data.data && data.data.avatar_url) {
                document.querySelectorAll('.ar-avatar-img-compact').forEach(function(img) {
                    img.src = data.data.avatar_url;
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ —Ö–µ–¥–µ—Ä–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                const headerAvatar = document.querySelector('.ar-user-avatar img, .ar-user-info img');
                if (headerAvatar) {
                    headerAvatar.src = data.data.avatar_url;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–æ–∂–∫—É –ø—Ä–æ—Ñ–∏–ª—è –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
            if (data.data && data.data.cover_url) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–≤—å—é –æ–±–ª–æ–∂–µ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const coverPreviews = document.querySelectorAll('.ar-cover-preview-compact');
                coverPreviews.forEach(function(coverPreview) {
                    coverPreview.style.backgroundImage = 'url(' + data.data.cover_url + ')';
                });
            }
            
            setTimeout(() => {
                arCloseProfileModal();
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            }, 1500);
        } else {
            arShowNotification('–û—à–∏–±–∫–∞: ' + (data.data || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'), 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        arShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç ‚Äì –æ—Å—Ç–∞–≤—å)
function arShowNotification(message, type = 'info') {
    const old = document.querySelectorAll('.ar-notification');
    old.forEach(n => n.remove());

    const n = document.createElement('div');
    n.className = `ar-notification ar-notification-${type}`;
    n.innerHTML = `
        <div class="ar-notification-content">
            <span class="ar-notification-message">${message}</span>
            <button class="ar-notification-close" onclick="this.closest('.ar-notification').remove()">√ó</button>
        </div>
    `;

    if (!document.querySelector('#ar-notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'ar-notification-styles';
        styles.textContent = `
            .ar-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 99999;
                min-width: 300px;
                max-width: 500px;
                animation: arSlideIn 0.3s ease;
            }
            .ar-notification-success { background: #22c55e; color: #fff; }
            .ar-notification-error   { background: #dc3545; color: #fff; }
            .ar-notification-info    { background: #3b82f6; color: #fff; }
            .ar-notification-content {
                padding: 15px 20px;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .ar-notification-close {
                background: none;
                border: none;
                color: inherit;
                font-size: 18px;
                cursor: pointer;
                margin-left: 15px;
            }
            @keyframes arSlideIn {
                from { transform: translateX(100%); opacity: 0; }
                to   { transform: translateX(0);   opacity: 1; }
            }
        `;
        document.head.appendChild(styles);
    }

    document.body.appendChild(n);

    setTimeout(() => { if (n.parentElement) n.remove(); }, 5000);
}

// –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞
function arUpdateProjectStatusDirectly(projectId, newStatus) {
    console.log('üîÑ Direct status update:', projectId, newStatus);

    const data = new FormData();
    data.append('action', 'ar_update_project_status');
    data.append('project_id', projectId);
    data.append('status', newStatus);
    data.append('nonce', '<?php echo wp_create_nonce("ar_update_project_status"); ?>');

    const projectCard = document.querySelector('[data-project-id="' + projectId + '"]');
    const projectTitle = projectCard?.querySelector('h4')?.textContent || '–ü—Ä–æ–µ–∫—Ç';

    if (projectCard) {
        projectCard.classList.add('status-updating');
    }

    fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
        method: 'POST',
        body: data
    })
    .then(r => r.json())
    .then(result => {
        console.log('ar_update_project_status result:', result);

        if (!result.success) {
            arShowNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + (result.data || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            if (projectCard) projectCard.classList.remove('status-updating');
            return;
        }

        const d = (typeof result.data === 'object') ? result.data : {};

        // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –Ω—É–∂–Ω—ã —Ñ–æ—Ç–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—ë —Å—Ä–∞–∑—É
        if (d.requires_photos) {
            console.log('üì∏ Backend requires photos for project', projectId);
            if (typeof arShowPhotoUploadModal === 'function') {
                arShowPhotoUploadModal(projectId, d.project_title || projectTitle, projectCard?.parentNode || null);
            }
            if (projectCard) projectCard.classList.remove('status-updating');
            return;
        }

        // –û–±—ã—á–Ω—ã–π —É—Å–ø–µ—à–Ω—ã–π –∞–ø–¥–µ–π—Ç
        arShowNotification(d.message || '–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
        if (projectCard) projectCard.classList.remove('status-updating');
        // –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ ‚Äì –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å:
        // setTimeout(() => location.reload(), 800);
    })
    .catch(error => {
        console.error('‚ùå Network error:', error);
        arShowNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞', 'error');
        if (projectCard) projectCard.classList.remove('status-updating');
    });
}

// –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
function arUpdateProjectStatus(projectId, newStatus) {
    arUpdateProjectStatusDirectly(projectId, newStatus);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('arProfileModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                arCloseProfileModal();
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                arCloseProfileModal();
            }
        });
    }
});     
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–º–æ–¥–∑–∏ –≤ –∫–Ω–æ–ø–∫–∞—Ö
    const editButtons = document.querySelectorAll('.ar-btn-edit');
    const deleteButtons = document.querySelectorAll('.ar-btn-delete');
    
    editButtons.forEach(btn => {
        btn.innerHTML = '‚úèÔ∏è';
    });
    
    deleteButtons.forEach(btn => {
        btn.innerHTML = 'üóëÔ∏è';
    });
});
        
     // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ù–û–í–û–ì–û –ü–†–û–ï–ö–¢–ê
    function arCreateNewProject() {
        document.getElementById('arNewProjectModal').style.display = 'flex';
        document.getElementById('arNewProjectForm').reset();
    }
    
    function arCloseNewProjectModal() {
        document.getElementById('arNewProjectModal').style.display = 'none';
    }
    
    function arSaveNewProject() {
        const form = document.getElementById('arNewProjectForm');
        const formData = new FormData(form);
        const projectTitle = formData.get('project_title');
        
        if (!projectTitle.trim()) {
            arShowNotification('VƒÉ rugƒÉm introduce»õi titlul proiectului', 'error');
            return;
        }
        
        const data = new FormData();
        data.append('action', 'ar_create_new_project');
        data.append('title', projectTitle);
        data.append('client_name', formData.get('client_name'));
        data.append('value', formData.get('project_value') || 0);
        data.append('project_description', formData.get('project_description'));
        data.append('nonce', '<?php echo wp_create_nonce("ar_create_new_project"); ?>');
        
        const btn = document.querySelector('#arNewProjectModal .ar-btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ Se creeazƒÉ...';
        btn.disabled = true;
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            body: data
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                arShowNotification('Proiectul a fost creat cu succes! Se re√ÆncarcƒÉ pagina...', 'success');
                arCloseNewProjectModal();
                
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                arShowNotification('Eroare la crearea proiectului: ' + (data.data || 'Eroare necunoscutƒÉ'), 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error creating project:', error);
            arShowNotification('Eroare de conexiune la crearea proiectului', 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø –° –£–ß–ï–¢–û–ú –ù–û–í–û–ì–û –°–¢–ê–¢–£–°–ê
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.ar-project-card');
        const columns = document.querySelectorAll('.ar-projects-list');
        
        let draggedCard = null;
        let originalColumn = null;
        
        cards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                draggedCard = this;
                originalColumn = this.parentNode;
                setTimeout(() => {
                    this.classList.add('dragging');
                }, 0);
            });
            
            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
            });
        });
        
        columns.forEach(column => {
            column.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.background = 'rgba(102, 126, 234, 0.1)';
            });
            
            column.addEventListener('dragleave', function() {
                this.style.background = '';
            });
            
            column.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.background = '';
                
                if (draggedCard) {
                    const newColumn = this;
                    const columnId = newColumn.id;
                    const newStatus = columnId.replace('ar-projects-', '');
                    const projectId = draggedCard.getAttribute('data-project-id');
                    const projectTitle = draggedCard.querySelector('h4').textContent;
                    
                    // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫—É "Proiect Nou"
                    if (newStatus === 'new') {
                        arShowNotification('Nu pute»õi muta proiecte √Æn coloana "Proiect Nou"', 'error');
                        return;
                    }
                    
                    if (newStatus === 'completed') {
                        if (!confirm(`Sigur dori»õi sƒÉ marca»õi proiectul "${projectTitle}" ca finalizat?`)) {
                            return;
                        }
                    }
                    
                    newColumn.appendChild(draggedCard);
                    
                    arUpdateProjectStatus(projectId, newStatus, draggedCard, originalColumn);
                }
            });
        });
    });

    // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê
    let updateInProgress = false;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ CRM
// –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä—è–º–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ê)
function arUpdateProjectStatusDirectly(projectId, newStatus) {
    console.log('üîÑ Direct status update:', projectId, newStatus);
    
    const data = new FormData();
    data.append('action', 'ar_update_project_status');
    data.append('project_id', projectId);
    data.append('status', newStatus);
    data.append('nonce', '<?php echo wp_create_nonce("ar_update_project_status"); ?>');
    
    // –°–ù–ê–ß–ê–õ–ê –Ω–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É, –ø–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "Cannot access before initialization")
    const projectCard = document.querySelector('[data-project-id="' + projectId + '"]');
    if (projectCard) {
        projectCard.classList.add('status-updating');
    }

    fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
        method: 'POST',
        body: data
    })
    .then(response => response.json())
    .then(result => {
        console.log('ar_update_project_status result:', result);

        if (result.success) {
            // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –≤–µ—Ä–Ω—É–ª, —á—Ç–æ –Ω—É–∂–Ω—ã —Ñ–æ—Ç–æ ‚Äî –ù–ò–ß–ï–ì–û –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, —Ñ—Ä–æ–Ω—Ç —É–∂–µ –ø–æ–∫–∞–∑–∞–ª –º–æ–¥–∞–ª–∫—É
            if (typeof result.data === 'object' && result.data.requires_photos) {
                console.log('üì∏ Backend says: photos required, leave status change to upload flow');
                if (projectCard) {
                    projectCard.classList.remove('status-updating');
                }
                return;
            }

            // –û–±—ã—á–Ω—ã–π —É—Å–ø–µ—à–Ω—ã–π –∞–ø–¥–µ–π—Ç
            console.log('‚úÖ Project status updated successfully');
            arShowNotification(
                (typeof result.data === 'object' && result.data.message)
                    ? result.data.message
                    : '–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª—ë–Ω',
                'success'
            );

            // –ú–æ–∂–µ—à—å –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–Ω—è—Ç—å –∫–ª–∞—Å—Å
            setTimeout(() => {
                // location.reload(); // –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∂—ë—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                if (projectCard) {
                    projectCard.classList.remove('status-updating');
                }
            }, 800);
        } else {
            console.error('‚ùå Status update failed:', result.data);
            arShowNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞: ' + (result.data || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');

            if (projectCard) {
                projectCard.classList.remove('status-updating');
            }
        }
    })
    .catch(error => {
        console.error('‚ùå Network error:', error);
        arShowNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞', 'error');

        if (projectCard) {
            projectCard.classList.remove('status-updating');
        }
    });
}

// –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
// –ï—Å–ª–∏ –≥–¥–µ-—Ç–æ –µ—â—ë –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è arUpdateProjectStatus(projectId, status),
// –æ–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç –≤—ã–∑–æ–≤ –≤ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
function arUpdateProjectStatus(projectId, newStatus) {
    arUpdateProjectStatusDirectly(projectId, newStatus);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
function arHighlightUpdatedCard(projectId) {
    const projectCard = document.querySelector(`[data-project-id="${projectId}"]`) || 
                        document.querySelector(`[data-id="${projectId}"]`);
    
    if (projectCard) {
        projectCard.classList.add('status-updated');
        setTimeout(() => {
            projectCard.classList.remove('status-updated');
        }, 2000);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —á–∞—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
function arSendStatusUpdateToChat(projectId, newStatus) {
    // –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–∫–∞–∑–∞ –∏–∑ projectId
    const orderId = arExtractOrderIdFromProjectId(projectId);
    
    if (!orderId) return;
    
    // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
    const statusMap = {
        'new': { text: '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç', icon: 'üìã', color: '#667eea' },
        'in_progress': { text: '–í —Ä–∞–±–æ—Ç–µ', icon: 'üî®', color: '#28a745' },
        'pending': { text: '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏', icon: '‚è≥', color: '#ffc107' },
        'completed': { text: '–ó–∞–≤–µ—Ä—à–µ–Ω', icon: '‚úÖ', color: '#17a2b8' },
        'abandoned': { text: '–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', icon: 'üóëÔ∏è', color: '#dc3545' }
    };
    
    const statusInfo = statusMap[newStatus] || { text: newStatus, icon: 'üìå', color: '#6c757d' };
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    const chatData = {
        action: 'ar_send_status_update',
        order_id: orderId,
        status: newStatus,
        status_text: statusInfo.text,
        status_icon: statusInfo.icon,
        nonce: window.ar_chat_nonce || '<?php echo wp_create_nonce("ar_chat_nonce"); ?>'
    };
    
    fetch(window.ar_ajax_url || '/wp-admin/admin-ajax.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(chatData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è order_id –∏–∑ project_id
function arExtractOrderIdFromProjectId(projectId) {
    // –§–æ—Ä–º–∞—Ç project_id: "order_{order_id}_{designer_id}_{timestamp}"
    const parts = projectId.split('_');
    if (parts.length >= 2 && parts[0] === 'order') {
        return parts[1];
    }
    return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function arShowStatusNotification(message, type = 'success') {
    // –£–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    document.querySelectorAll('.ar-status-notification').forEach(notification => {
        notification.remove();
    });
    
    const notification = document.createElement('div');
    notification.className = `ar-status-notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10001;
        max-width: 300px;
        animation: arSlideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2em;">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.animation = 'arSlideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏–∏
if (!document.querySelector('#ar-kanban-animations')) {
    const style = document.createElement('style');
    style.id = 'ar-kanban-animations';
    style.textContent = `
        @keyframes arSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes arSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .status-updating {
            position: relative;
            opacity: 0.7;
            pointer-events: none;
        }
        
        .status-updating:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
            animation: pulse 1.5s infinite;
        }
        
        .status-updating:before {
            content: 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 0.9; }
            100% { opacity: 0.7; }
        }
        
        /* –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .status-updated {
            animation: highlightUpdate 2s ease;
        }
        
        @keyframes highlightUpdate {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
    `;
    document.head.appendChild(style);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–Ω–±–∞–Ω–∞
document.addEventListener('DOMContentLoaded', function() {
    // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Sortable.js –¥–ª—è –∫–∞–Ω–±–∞–Ω–∞
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Sortable.js
if (typeof Sortable !== 'undefined') {
    const kanbanColumns = document.querySelectorAll('.kanban-column');
    
    kanbanColumns.forEach(column => {
        new Sortable(column, {
            group: 'shared',
            animation: 150,
            delay: 100, // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–π
            delayOnTouchOnly: true,
            onStart: function(evt) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                evt.item.classList.add('dragging');
            },
            onEnd: function(evt) {
                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                evt.item.classList.remove('dragging');
                
                const projectId = evt.item.dataset.projectId || evt.item.dataset.id;
                const newStatus = evt.to.dataset.status || column.dataset.status;
                
                if (projectId && newStatus) {
                    arUpdateProjectStatus(projectId, newStatus);
                } else {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å projectId –∏–ª–∏ status:', { 
                        projectId, 
                        newStatus, 
                        item: evt.item,
                        to: evt.to 
                    });
                }
            },
            onMove: function(evt) {
                // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
                return evt.from !== evt.to;
            }
        });
    });
}
    
    // –ò–ª–∏ –µ—Å–ª–∏ —É –≤–∞—Å —Å–≤–æ–∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    document.querySelectorAll('.status-change-btn').forEach(button => {
        button.addEventListener('click', function() {
            const projectId = this.dataset.projectId;
            const newStatus = this.dataset.status;
            
            if (projectId && newStatus) {
                arUpdateProjectStatus(projectId, newStatus);
            }
        });
    });
});
    function arRefreshCRM() {
        const btn = document.querySelector('.ar-btn-refresh');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = 'üîÑ Se actualizeazƒÉ...';
        btn.disabled = true;
        
        arShowNotification('Se actualizeazƒÉ datele CRM...', 'info');
        
        const data = new FormData();
        data.append('action', 'ar_refresh_crm');
        data.append('nonce', '<?php echo wp_create_nonce("ar_refresh_crm"); ?>');
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            body: data
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                arShowNotification('CRM a fost actualizat cu succes! Se re√ÆncarcƒÉ pagina...', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 1500);
                
            } else {
                arShowNotification('Eroare la actualizare: ' + (data.data || 'Eroare necunoscutƒÉ'), 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error refreshing CRM:', error);
            arShowNotification('Eroare de conexiune la actualizare.', 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    function arUpdateColumnCounts() {
        const columns = ['in_progress', 'pending', 'completed'];
        
        columns.forEach(status => {
            const column = document.getElementById(`ar-projects-${status}`);
            const countElement = document.querySelector(`[data-status="${status}"] .ar-column-count`);
            
            if (column && countElement) {
                const projectCount = column.querySelectorAll('.ar-project-card').length;
                countElement.textContent = projectCount;
            }
        });
    }

    function arShowNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `ar-notification ar-notification-${type}`;
        notification.innerHTML = `
            <div class="ar-notification-content">
                <span class="ar-notification-message">${message}</span>
                <button class="ar-notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
            </div>
        `;
        
        if (!document.querySelector('#ar-notification-styles')) {
            const styles = document.createElement('style');
            styles.id = 'ar-notification-styles';
            styles.textContent = `
                .ar-notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10001;
                    min-width: 300px;
                    max-width: 500px;
                    animation: arSlideIn 0.3s ease;
                }
                .ar-notification-success {
                    background: #22c55e;
                    color: white;
                }
                .ar-notification-error {
                    background: #dc3545;
                    color: white;
                }
                .ar-notification-info {
                    background: #3b82f6;
                    color: white;
                }
                .ar-notification-content {
                    padding: 15px 20px;
                    border-radius: 8px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                }
                .ar-notification-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    margin-left: 15px;
                }
                @keyframes arSlideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(styles);
        }
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    
    function arShowProjectDetails(projectId) {
        document.getElementById('arModalBody').innerHTML = '<div style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        document.getElementById('arProjectModal').style.display = 'flex';
        
        const data = new FormData();
        data.append('action', 'ar_get_project_details');
        data.append('project_id', projectId);
        data.append('nonce', '<?php echo wp_create_nonce("ar_get_project_details"); ?>');
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            body: data
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('arModalTitle').textContent = data.data.title;
                document.getElementById('arModalBody').innerHTML = data.data.html;
                
                window.currentProjectId = projectId;
            } else {
                document.getElementById('arModalBody').innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Eroare la √ÆncƒÉrcarea detaliilor proiectului.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('arModalBody').innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Eroare de conexiune.</div>';
        });
    }

    function arCloseModal() {
        document.getElementById('arProjectModal').style.display = 'none';
        window.currentProjectId = null;
    }

    function arExportManufacturerEstimate(manufacturerId) {
        if (!window.currentProjectId) return;
        
        const url = `<?php echo rest_url('ar/v1/export-manufacturer'); ?>?project_id=${window.currentProjectId}&manufacturer_id=${manufacturerId}&_wpnonce=<?php echo wp_create_nonce('wp_rest'); ?>`;
        window.open(url, '_blank');
    }

    function arExportFullEstimate() {
        if (!window.currentProjectId) return;
        
        const url = `<?php echo rest_url('ar/v1/export-full-estimate'); ?>?project_id=${window.currentProjectId}&_wpnonce=<?php echo wp_create_nonce('wp_rest'); ?>`;
        window.open(url, '_blank');
    }

    function arEditProject(projectId) {
        arShowProjectDetails(projectId);
    }

    function arDeleteProject(projectId) {
    if (!confirm('Sigur dori»õi sƒÉ »ôterge»õi acest proiect? AceastƒÉ ac»õiune este ireversibilƒÉ.')) {
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
    if (projectCard) {
        projectCard.style.opacity = '0.5';
        projectCard.style.pointerEvents = 'none';
    }
    
    const data = new FormData();
    data.append('action', 'ar_delete_project');
    data.append('project_id', projectId);
    data.append('nonce', '<?php echo wp_create_nonce("ar_delete_project"); ?>');
    
    fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
        method: 'POST',
        body: data
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            arShowNotification('Proiectul a fost »ôters cu succes! Se re√ÆncarcƒÉ pagina...', 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
            if (projectCard) {
                projectCard.style.opacity = '1';
                projectCard.style.pointerEvents = 'auto';
            }
            arShowNotification('Eroare: ' + (data.data || 'Nu s-a putut »ôterge proiectul'), 'error');
            console.error('Delete error:', data.data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏
        if (projectCard) {
            projectCard.style.opacity = '1';
            projectCard.style.pointerEvents = 'auto';
        }
        arShowNotification('Eroare de conexiune la »ôtergerea proiectului', 'error');
    });
}
    </script>
    <?php
    return ob_get_clean();
}








/**
 * AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ abandoned
 */
add_action('wp_ajax_ar_restore_project', 'ar_ajax_restore_project');
function ar_ajax_restore_project() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_restore_project')) {
        wp_send_json_error('Eroare de securitate');
    }
    
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }
    
    $project_id = sanitize_text_field($_POST['project_id']);
    $user_id = get_current_user_id();
    
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    $user_project = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM $projects_table WHERE project_id = %s AND user_id = %d AND status = 'abandoned'",
        $project_id, $user_id
    ));
    
    if (!$user_project) {
        wp_send_json_error('Proiectul nu a fost gƒÉsit sau nu este √Æn starea abandonatƒÉ');
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ —Å—Ç–∞—Ç—É—Å "in_progress"
    $result = $wpdb->update(
        $projects_table,
        array(
            'status' => 'in_progress',
            'updated_at' => current_time('mysql')
        ),
        array('project_id' => $project_id),
        array('%s', '%s'),
        array('%s')
    );
    
    if ($result === false) {
        $error = $wpdb->last_error ?: 'Eroare necunoscutƒÉ la baza de date';
        wp_send_json_error('Eroare la restaurarea proiectului: ' . $error);
    }
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à
    AR_Project_Cache::clear_user_projects_cache($user_id);
    
    wp_send_json_success('Proiectul a fost restaurat cu succes');
}



// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ –≤ —á–∞—Ç
// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ –≤ —á–∞—Ç
add_action('wp_ajax_ar_send_status_update', 'ar_ajax_send_status_update');
add_action('wp_ajax_nopriv_ar_send_status_update', 'ar_ajax_send_status_update');

function ar_ajax_send_status_update() {
    if (!isset($_POST['order_id']) || empty($_POST['order_id'])) {
        wp_send_json_error('Order ID is required');
    }
    
    if (!isset($_POST['status']) || empty($_POST['status'])) {
        wp_send_json_error('Status is required');
    }
    
    $order_id = intval($_POST['order_id']);
    $status = sanitize_text_field($_POST['status']);
    $status_text = isset($_POST['status_text']) ? sanitize_text_field($_POST['status_text']) : $status;
    $status_icon = isset($_POST['status_icon']) ? sanitize_text_field($_POST['status_icon']) : 'üìå';
    
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    $chat_table = $wpdb->prefix . 'designer_chat_messages';
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $orders_table WHERE id = %d",
        $order_id
    ));
    
    if (!$order) {
        wp_send_json_error('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    $message_data = [
        'order_id' => $order_id,
        'sender_id' => $order->selected_designer_id,
        'receiver_id' => $order->client_id,
        'message' => "{$status_icon} –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {$status_text}",
        'is_system' => 1, // –≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        'created_at' => current_time('mysql')
    ];
    
    $result = $wpdb->insert($chat_table, $message_data);
    
    if ($result === false) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' . $wpdb->last_error);
    }
    
    wp_send_json_success('–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç');
}


/**
 * AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
 */
add_action('wp_ajax_ar_create_new_project', 'ar_ajax_create_new_project');
function ar_ajax_create_new_project() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_create_new_project')) {
        wp_send_json_error('Eroare de securitate');
    }
    
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }
    
    $user_id = get_current_user_id();
    $title = isset($_POST['title']) ? sanitize_text_field($_POST['title']) : 'Proiect Nou';
    $client_name = isset($_POST['client_name']) ? sanitize_text_field($_POST['client_name']) : '';
    $value = isset($_POST['value']) ? floatval($_POST['value']) : 0;
    $project_description = isset($_POST['project_description']) ? sanitize_textarea_field($_POST['project_description']) : '';
    
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–µ–∫—Ç–∞
    $project_id = 'manual_' . $user_id . '_' . time() . '_' . wp_generate_password(6, false);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $designer_data = ar_get_designer_data($user_id);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é 10%
    $designer_income = $value * 0.1;
    
    $project_data = [
        'project_id' => $project_id,
        'designer_key' => 'manual',
        'user_id' => $user_id,
        'title' => $title,
        'currency' => '–†–£–ë',
        'value' => $value,
        'designer_income' => $designer_income,
        'status' => 'new',
        'client_name' => $client_name,
        'project_description' => $project_description,
        'designer_name' => $designer_data['name'],
        'designer_phone' => $designer_data['phone'],
        'designer_email' => $designer_data['email'],
        'created_at' => current_time('mysql'),
        'updated_at' => current_time('mysql')
    ];
    
    $result = $wpdb->insert($projects_table, $project_data);
    
    if ($result === false) {
        $db_error = $wpdb->last_error;
        error_log("ARTROCKET CREATE: Database insert failed: {$db_error}");
        wp_send_json_error('Eroare la crearea proiectului √Æn baza de date: ' . $db_error);
    }
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à
    AR_Project_Cache::clear_user_projects_cache($user_id);
    
    error_log("ARTROCKET CREATE: Successfully created new project: {$project_id} for user {$user_id}");
    
    wp_send_json_success('Proiectul a fost creat cu succes');
}

// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –∫–∞–Ω–±–∞–Ω–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
// REMOVED DUPLICATE: See ar_ajax_update_project_status_with_photos below for current handler

add_action('wp_ajax_ar_get_project_details', 'ar_ajax_get_project_details');
function ar_ajax_get_project_details() {
    error_log("ARTROCKET: ar_get_project_details called");
    
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_get_project_details')) {
        error_log("ARTROCKET: Nonce verification failed");
        wp_send_json_error('Eroare de securitate');
        return;
    }
    
    if (!is_user_logged_in()) {
        error_log("ARTROCKET: User not logged in");
        wp_send_json_error('Utilizatorul nu este autentificat');
        return;
    }
    
    $project_id = isset($_POST['project_id']) ? sanitize_text_field($_POST['project_id']) : '';
    
    if (empty($project_id)) {
        error_log("ARTROCKET: Empty project_id");
        wp_send_json_error('ID-ul proiectului este necesar');
        return;
    }
    
    $user_id = get_current_user_id();
    $projects = ar_get_user_projects($user_id);
    $project = null;
    
    foreach ($projects as $proj) {
        if ($proj['project_id'] === $project_id) {
            $project = $proj;
            break;
        }
    }
    
    if (!$project) {
        error_log("ARTROCKET: Project not found: {$project_id}");
        wp_send_json_error('Proiectul nu a fost gƒÉsit');
        return;
    }
    
    // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ê–°–ß–ï–¢ –ö–û–ú–ò–°–°–ò–ò 10% –ï–°–õ–ò –û–ù–ê –†–ê–í–ù–ê 0
    $project_value = floatval($project['value']);
    $designer_income = floatval($project['designer_income']);
    
    if ($designer_income == 0 && $project_value > 0) {
        $designer_income = $project_value * 0.1;
        error_log("ARTROCKET DETAILS: Auto-calculated designer income: {$designer_income} (10% of {$project_value})");
    }
    
    $manufacturers = [];
    foreach ($project['products'] as $product) {
        $manuf_id = !empty($product['manufacturer_id']) ? $product['manufacturer_id'] : 'other';
        $manuf_name = !empty($product['manufacturer_id']) ? $product['manufacturer_id'] : 'Altele';
        
        if (!isset($manufacturers[$manuf_id])) {
            $manufacturers[$manuf_id] = [
                'name' => $manuf_name,
                'products' => [],
                'total' => 0
            ];
        }
        
        $manufacturers[$manuf_id]['products'][] = $product;
        $manufacturers[$manuf_id]['total'] += $product['total_price'];
    }
    
    ob_start();
    ?>
    <div class="ar-project-details">
    <div class="ar-details-grid-compact">
       <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ -->
        <div class="ar-detail-section-compact">
            <h3>üìã –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="ar-detail-list-compact">
                <div class="ar-detail-item-compact">
                    <label class="ar-detail-label-compact">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="ar-editable-field-compact" name="title" value="<?php echo esc_attr($project['title']); ?>">
                </div>
                
                <div class="ar-field-group-compact">
                    <div class="ar-detail-item-compact">
                        <label class="ar-detail-label-compact">–°—Ç–∞—Ç—É—Å</label>
                        <select class="ar-editable-field-compact" name="status">
                            <option value="in_progress" <?php selected($project['status'], 'in_progress'); ?>>–ó–∞–ø—É—â–µ–Ω –≤ —Ä–∞–±–æ—Ç—É</option>
                            <option value="pending" <?php selected($project['status'], 'pending'); ?>>–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</option>
                            <option value="completed" <?php selected($project['status'], 'completed'); ?>>–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                        </select>
                    </div>
                    
                    <div class="ar-detail-item-compact">
                        <label class="ar-detail-label-compact">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                        <input type="number" class="ar-editable-field-compact ar-currency-field" name="value" value="<?php echo esc_attr($project_value); ?>" step="0.01">
                    </div>
                </div>
                
                <div class="ar-detail-item-compact">
                    <label class="ar-detail-label-compact">–ö–æ–º–∏—Å—Å–∏—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞</label>
                    <input type="number" class="ar-editable-field-compact ar-currency-field" name="designer_income" value="<?php echo esc_attr($designer_income); ?>" step="0.01">
                    <div class="ar-commission-calc">–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ 10% –æ—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏</div>
                </div>
                
                <div class="ar-field-group-compact">
                    <div class="ar-detail-item-compact">
                        <label class="ar-detail-label-compact">–î–∞—Ç–∞ —Å–¥–∞—á–∏</label>
                        <input type="date" class="ar-editable-field-compact" name="project_deadline" value="<?php echo esc_attr($project['project_deadline']); ?>">
                    </div>
                    
                    <div class="ar-detail-item-compact">
                        <label class="ar-checkbox-compact">
                            <input type="checkbox" class="ar-editable-field-compact" name="is_commercial" value="1" <?php checked($project['is_commercial'], 1); ?>>
                            –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –æ–±—ä–µ–∫—Ç
                        </label>
                    </div>
                </div>
                
                <div class="ar-detail-item-compact">
                    <label class="ar-detail-label-compact">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                    <div class="ar-detail-value-compact"><?php echo date('d.m.Y H:i', strtotime($project['created_at'])); ?></div>
                </div>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
        <div class="ar-detail-section-compact">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
            <div class="ar-detail-list-compact">
                <div class="ar-detail-item-compact">
                    <label class="ar-detail-label-compact">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" class="ar-editable-field-compact" name="client_name" value="<?php echo esc_attr($project['client_name']); ?>">
                </div>
                
                <div class="ar-field-group-compact">
                    <div class="ar-detail-item-compact">
                        <label class="ar-detail-label-compact">Email –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <input type="email" class="ar-editable-field-compact" name="client_email" value="<?php echo esc_attr($project['client_email']); ?>">
                    </div>
                    
                    <div class="ar-detail-item-compact">
                        <label class="ar-detail-label-compact">–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <input type="text" class="ar-editable-field-compact" name="client_phone" value="<?php echo esc_attr($project['client_phone']); ?>">
                    </div>
                </div>
                
                <div class="ar-detail-item-compact">
                    <label class="ar-detail-label-compact">–ê–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <textarea class="ar-editable-field-compact" name="client_address" rows="2"><?php echo esc_textarea($project['client_address']); ?></textarea>
                </div>
            </div>
        </div>
        
        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="ar-detail-section-compact">
            <h3>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <div class="ar-detail-list-compact">
                <div class="ar-detail-item-compact">
                    <label class="ar-detail-label-compact">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                    <textarea class="ar-editable-field-compact" name="project_description" rows="3"><?php echo esc_textarea($project['project_description']); ?></textarea>
                </div>
                
                <div class="ar-detail-item-compact">
                    <label class="ar-detail-label-compact">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label>
                    <textarea class="ar-editable-field-compact" name="project_comment" rows="2"><?php echo esc_textarea($project['project_comment']); ?></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
    <div class="ar-save-section-compact">
        <button class="ar-save-project-btn-compact" 
                data-project-id="<?php echo esc_attr($project['project_id']); ?>"
                data-ajax-url="<?php echo admin_url('admin-ajax.php'); ?>"
                data-nonce="<?php echo wp_create_nonce('ar_save_project_changes'); ?>">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
    </div>
    
    <!-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã -->
    <div class="ar-manufacturers-section-compact">
        <h3>üè≠ –ü—Ä–æ–¥—É–∫—Ç—ã —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è–º</h3>
        
        <?php if (empty($manufacturers)): ?>
            <div class="ar-empty-manufacturers">
                <div class="ar-empty-icon">üì¶</div>
                <p>–í —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</p>
            </div>
        <?php else: ?>
            <?php foreach ($manufacturers as $manuf_id => $manufacturer): ?>
            <div class="ar-manufacturer-card-compact">
                <div class="ar-manufacturer-header-compact">
                    <h4><?php echo esc_html($manufacturer['name']); ?></h4>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="ar-manufacturer-total-compact">
                            –ò—Ç–æ–≥–æ: <?php echo number_format($manufacturer['total'], 0, ',', '.'); ?> –†–£–ë
                        </div>
                        <button class="ar-btn-export-compact" onclick="arExportManufacturerEstimate('<?php echo esc_attr($manuf_id); ?>')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            –≠–∫—Å–ø–æ—Ä—Ç
                        </button>
                    </div>
                </div>
                
                <?php if (!empty($manufacturer['products'])): ?>
                <div class="ar-products-table-compact">
                    <table>
                        <thead>
                            <tr>
                                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</th>
                                <th>–ò—Ç–æ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($manufacturer['products'] as $product): ?>
                            <tr>
                                <td><?php echo esc_html($product['product_name'] ?? $product['name'] ?? 'N/A'); ?></td>
                                <td><?php echo $product['quantity']; ?> <?php echo $product['unit']; ?></td>
                                <td><?php echo number_format($product['unit_price'], 0, ',', '.'); ?> –†–£–ë</td>
                                <td><?php echo number_format($product['total_price'], 0, ',', '.'); ?> –†–£–ë</td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
                <?php endif; ?>
            </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
    
    
    
    <?php
// –ì–æ—Ç–æ–≤–∏–º –º–∞—Å—Å–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
$photos = [];

if (!empty($project['photos'])) {
    // –ï—Å–ª–∏ –ø—Ä–∏—à—ë–ª JSON ‚Äî –¥–µ–∫–æ–¥–∏—Ä—É–µ–º
    if (is_string($project['photos'])) {
        $decoded = json_decode($project['photos'], true);
        if (is_array($decoded)) {
            $photos = $decoded;
        }
    } elseif (is_array($project['photos'])) {
        $photos = $project['photos'];
    }
}
?>

<div class="ar-project-photos-section-compact">
    <h3>üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>
    
    <?php if (!empty($photos)): ?>
        <div class="ar-project-photos-gallery">
            <div class="ar-photos-grid">
                <?php foreach ($photos as $index => $photo): ?>
                    <?php
                    $thumb = !empty($photo['thumbnail'])
                        ? $photo['thumbnail']
                        : (!empty($photo['url']) ? $photo['url'] : '');
                    
                    if (!$thumb) {
                        continue; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –≤–æ–æ–±—â–µ URL
                    }

                    $photo_name = !empty($photo['name'])
                        ? $photo['name']
                        : ('–§–æ—Ç–æ ' . ($index + 1));
                    ?>
                    
                    <div class="ar-photo-item"
     onclick="arViewProjectPhoto(this, <?php echo $index; ?>)">
    <img src="<?php echo esc_url($photo['thumbnail'] ?: $photo['url']); ?>" 
         data-full="<?php echo esc_url($photo['large'] ?: $photo['url']); ?>"
         alt="–§–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞" 
         class="ar-photo-gallery-img">
</div>
                <?php endforeach; ?>
            </div>

            <div class="ar-photos-actions">
                <button class="ar-btn-upload-more"
                        type="button"
                        onclick="arUploadMorePhotos('<?php echo esc_js($project['project_id']); ?>')">
                    üì§ –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ
                </button>
            </div>
        </div>
    <?php else: ?>
        <div class="ar-no-photos">
            <p>–í –ø—Ä–æ–µ–∫—Ç–µ –µ—â–µ –Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
            <button class="ar-btn-upload-photos"
                    type="button"
                    onclick="arUploadProjectPhotosFromDetails('<?php echo esc_js($project['project_id']); ?>')">
                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            </button>
        </div>
    <?php endif; ?>
</div>
    
    
    
</div>

    <style>
    
    /* –õ–∞–π—Ç–±–æ–∫—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞ */
.ar-photo-viewer-modal {
    justify-content: center;
    align-items: center;
    background: rgba(15, 23, 42, 0.75);
    z-index: 99999;
}

.ar-photo-viewer-content {
    max-width: 90vw;
    max-height: 90vh;
    padding: 0;
    background: #0f172a;
    border-radius: 12px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

#arPhotoViewerImage {
    max-width: 90vw;
    max-height: 90vh;
    display: block;
    border-radius: 10px;
}

.ar-photo-viewer-content .ar-modal-close {
    position: absolute;
    top: 8px;
    right: 10px;
    background: rgba(15, 23, 42, 0.7);
    color: #e5e7eb;
    border-radius: 999px;
    width: 28px;
    height: 28px;
    border: none;
    font-size: 18px;
    cursor: pointer;
}
    
    
    /* ========= –ö–û–ú–ü–ê–ö–¢–ù–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–ï–¢–ê–õ–ï–ô –ü–†–û–ï–ö–¢–ê ========= */
.ar-project-details {
    padding: 0;
    max-height: 70vh;
    overflow-y: auto;
}

.ar-project-details::-webkit-scrollbar {
    width: 3px;
}

.ar-project-details::-webkit-scrollbar-track {
    background: #f8fafc;
}

.ar-project-details::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 1.5px;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ - –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ */
.ar-details-grid-compact {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 16px;
}

/* –°–µ–∫—Ü–∏–∏ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Å—Ç–∏–ª–µ */
.ar-detail-section-compact {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin: 0;
}

.ar-detail-section-compact h3 {
    margin: 0 0 12px 0;
    color: #1e293b;
    font-size: 13px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* –°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.ar-detail-list-compact {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.ar-detail-item-compact {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.ar-detail-label-compact {
    color: #64748b;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.ar-detail-value-compact {
    color: #1e293b;
    font-weight: 400;
    font-size: 11px;
    line-height: 1.3;
}

/* –ü–æ–ª—è –≤–≤–æ–¥–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ */
.ar-editable-field-compact {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 8px 10px;
    color: #1e293b;
    font-size: 11px;
    width: 100%;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
}

.ar-editable-field-compact:focus {
    outline: none;
    border-color: #e65c00;
    background: #ffffff;
    box-shadow: 0 0 0 2px rgba(230, 92, 0, 0.1);
}

.ar-editable-field-compact::placeholder {
    color: #94a3b8;
}

/* –ß–µ–∫–±–æ–∫—Å –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Å—Ç–∏–ª–µ */
.ar-checkbox-compact {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: #1e293b;
    cursor: pointer;
}

.ar-checkbox-compact input[type="checkbox"] {
    width: 14px;
    height: 14px;
    accent-color: #e65c00;
}

/* –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ */
textarea.ar-editable-field-compact {
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
    line-height: 1.4;
}

/* –°–µ–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
.ar-save-section-compact {
    margin: 16px 0;
    text-align: center;
    padding: 16px;
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.ar-save-project-btn-compact {
    background: #e65c00 !important;
    color: #fff !important;
    border: none !important;
    padding: 10px 20px !important;
    border-radius: 6px !important;
    font-size: 11px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    font-weight: 600 !important;
    box-shadow: 0 1px 3px rgba(230, 92, 0, 0.3) !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.ar-save-project-btn-compact:hover {
    background: #cc4c00 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(230, 92, 0, 0.4) !important;
}

/* –°–µ–∫—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
.ar-manufacturers-section-compact {
    margin-top: 16px;
}

.ar-manufacturers-section-compact h3 {
    color: #1e293b;
    margin-bottom: 16px;
    font-size: 13px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
.ar-manufacturer-card-compact {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
}

.ar-manufacturer-header-compact {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f1f5f9;
}

.ar-manufacturer-header-compact h4 {
    margin: 0;
    color: #1e293b;
    font-size: 11px;
    font-weight: 600;
}

.ar-manufacturer-total-compact {
    color: #10b981;
    font-weight: 700;
    font-size: 11px;
    background: rgba(16, 185, 129, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
}

/* –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
.ar-products-table-compact {
    margin-bottom: 10px;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.ar-products-table-compact table {
    width: 100%;
    border-collapse: collapse;
    background: #ffffff;
    font-size: 10px;
}

.ar-products-table-compact th {
    background: #f8fafc;
    color: #374151;
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    border-bottom: 1px solid #e2e8f0;
}

.ar-products-table-compact td {
    padding: 6px 10px;
    border-bottom: 1px solid #f1f5f9;
    color: #4b5563;
    transition: background-color 0.15s ease;
}

.ar-products-table-compact tr:hover td {
    background: #f8fafc;
}

.ar-products-table-compact tr:last-child td {
    border-bottom: none;
}

/* –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
.ar-btn-export-compact {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 9px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
    box-shadow: 0 1px 2px rgba(16, 185, 129, 0.3);
}

.ar-btn-export-compact:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4);
}

/* –ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ */
.ar-commission-calc {
    font-size: 9px;
    color: #64748b;
    margin-top: 2px;
    font-style: italic;
}

/* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ–ª–µ–π –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ */
.ar-field-group-compact {
    display: flex;
    gap: 12px;
    margin-bottom: 8px;
}

.ar-field-group-compact .ar-detail-item-compact {
    flex: 1;
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–∞–ª—é—Ç—ã */
.ar-currency-field {
    position: relative;
}

.ar-currency-field::after {
    content: "–†–£–ë";
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: #64748b;
    background: #f8fafc;
    padding: 2px 6px;
    border-radius: 3px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
@media (max-width: 768px) {
    .ar-detail-section-compact {
        padding: 12px;
    }
    
    .ar-manufacturer-header-compact {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }
    
    .ar-products-table-compact {
        overflow-x: auto;
    }
    
    .ar-products-table-compact table {
        min-width: 400px;
    }
    
    .ar-field-group-compact {
        flex-direction: column;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .ar-project-details {
        max-height: 65vh;
    }
    
    .ar-details-grid-compact {
        gap: 12px;
    }
    
    .ar-detail-section-compact {
        padding: 10px;
    }
    
    .ar-save-section-compact {
        padding: 12px;
        margin: 12px 0;
    }
    
    .ar-manufacturer-card-compact {
        padding: 10px;
    }
    
    .ar-products-table-compact th,
    .ar-products-table-compact td {
        padding: 4px 6px;
        font-size: 9px;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è */
.ar-detail-section-compact,
.ar-manufacturer-card-compact {
    animation: fadeInUpCompact 0.3s ease-out;
}

@keyframes fadeInUpCompact {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è select –∏ date inputs */
select.ar-editable-field-compact {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 12px;
    padding-right: 30px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π */
.ar-empty-manufacturers {
    text-align: center;
    padding: 30px 20px;
    color: #94a3b8;
    font-size: 11px;
}

.ar-empty-manufacturers .ar-empty-icon {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
}
    
    .ar-btn-export {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.ar-btn-export:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
}
    
   .ar-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.ar-detail-section-full {
    background: #ffffff;
    padding: 24px;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 0.3s ease;
}

.ar-detail-section-full:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
}

.ar-detail-section-full h3 {
    margin: 0 0 20px 0;
    color: #1e293b;
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.ar-detail-section {
    background: #ffffff;
    padding: 24px;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 0.3s ease;
}

.ar-detail-section:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
}

.ar-detail-section h3 {
    margin: 0 0 20px 0;
    color: #1e293b;
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.ar-detail-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ar-detail-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ar-detail-label {
    color: #64748b;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ar-detail-value {
    color: #1e293b;
    font-weight: 200;
    font-size: 12px;
    line-height: 1.4;
}

.ar-editable-field {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px 16px;
    color: #1e293b;
    font-size: 14px;
    width: 100%;
    transition: all 0.3s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.ar-editable-field:focus {
    outline: none;
    border-color: #667eea;
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.ar-editable-field:hover {
    border-color: #cbd5e1;
    background: #ffffff;
}

input[type="checkbox"].ar-editable-field {
    width: auto;
    margin-right: 8px;
    transform: scale(1.2);
}

.ar-save-section {
    margin: 24px 0;
    text-align: center;
    padding: 24px;
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.ar-manufacturers-section {
    margin-top: 24px;
}

.ar-manufacturers-section h3 {
    color: #1e293b;
    margin-bottom: 24px;
    font-size: 20px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.ar-manufacturer-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 0.3s ease;
}

.ar-manufacturer-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.ar-manufacturer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f1f5f9;
}

.ar-manufacturer-header h4 {
    margin: 0;
    color: #1e293b;
    font-size: 18px;
    font-weight: 600;
}

.ar-manufacturer-total {
    color: #10b981;
    font-weight: 700;
    font-size: 16px;
    background: rgba(16, 185, 129, 0.1);
    padding: 8px 16px;
    border-radius: 8px;
}

.ar-products-table {
    margin-bottom: 20px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.ar-products-table table {
    width: 100%;
    border-collapse: collapse;
    background: #ffffff;
}

.ar-products-table th {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    color: #374151;
    padding: 12px 16px;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #e2e8f0;
}

.ar-products-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f5f9;
    color: #4b5563;
    font-size: 14px;
    transition: background-color 0.2s ease;
}

.ar-products-table tr:hover td {
    background: #f8fafc;
}

.ar-products-table tr:last-child td {
    border-bottom: none;
}

@media (max-width: 768px) {
    .ar-details-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .ar-detail-section-full,
    .ar-detail-section {
        padding: 20px;
    }
    
    .ar-manufacturer-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .ar-manufacturer-total {
        align-self: flex-start;
    }
    
    .ar-products-table {
        overflow-x: auto;
    }
    
    .ar-products-table table {
        min-width: 500px;
    }
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
.ar-detail-item:last-child {
    margin-bottom: 0;
}

.ar-editable-field::placeholder {
    color: #9ca3af;
}

.ar-manufacturer-card:last-child {
    margin-bottom: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ */
.ar-editable-field[type="date"],
.ar-editable-field[type="email"],
.ar-editable-field[type="text"],
.ar-editable-field[type="number"],
.ar-editable-field[type="tel"],
select.ar-editable-field {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π */
textarea.ar-editable-field {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
    line-height: 1.5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ */
input[type="checkbox"].ar-editable-field {
    accent-color: #667eea;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è */
.ar-detail-section,
.ar-detail-section-full,
.ar-manufacturer-card {
    animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
    </style>

    <script>
        
        
        
        
        
        /**
 * –õ–Å–ì–ö–ò–ô –õ–ê–ô–¢–ë–û–ö–° –î–õ–Ø –§–û–¢–û –ü–†–û–ï–ö–¢–ê
 */
function arEnsurePhotoViewer() {
    let viewer = document.getElementById('arPhotoViewerModal');
    if (!viewer) {
        viewer = document.createElement('div');
        viewer.id = 'arPhotoViewerModal';
        viewer.className = 'ar-modal ar-photo-viewer-modal';
        viewer.style.display = 'none';
        viewer.innerHTML = `
            <div class="ar-modal-content ar-photo-viewer-content">
                <button class="ar-modal-close" type="button" onclick="arClosePhotoViewer()">√ó</button>
                <img id="arPhotoViewerImage" src="" alt="–§–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞">
            </div>
        `;
        document.body.appendChild(viewer);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        viewer.addEventListener('click', function(e) {
            if (e.target === this) {
                arClosePhotoViewer();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Esc
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && viewer.style.display === 'flex') {
                arClosePhotoViewer();
            }
        });
    }
    return viewer;
}

// REMOVED DUPLICATE: Use arViewProjectPhoto(triggerEl, index) from IIFE above instead

function arClosePhotoViewer() {
    const viewer = document.getElementById('arPhotoViewerModal');
    if (viewer) {
        viewer.style.display = 'none';
    }
    document.body.style.overflow = '';
}

/**
 * –ö–ù–û–ü–ö–ê "üì§ –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ"
 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ø–∞–ø –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
 */
function arUploadMorePhotos(projectId) {
    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∫–∞–Ω–±–∞–Ω–µ
    const card = document.querySelector('.ar-project-card[data-project-id="' + projectId + '"]');
    let title = '–ü—Ä–æ–µ–∫—Ç';

    if (card) {
        const h4 = card.querySelector('h4');
        if (h4) {
            title = h4.textContent.trim();
        }
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    if (typeof arShowPhotoUploadModal === 'function') {
        // —Ç—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä originalColumn –Ω–∞–º —Ç—É—Ç –Ω–µ –Ω—É–∂–µ–Ω, –ø–µ—Ä–µ–¥–∞—ë–º null
        arShowPhotoUploadModal(projectId, title, null);
    } else {
        console.error('arUploadMorePhotos: arShowPhotoUploadModal is not defined');
    }
}

/**
 * –ö–ù–û–ü–ö–ê "üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" (–∫–æ–≥–¥–∞ –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–æ—Ç–æ)
 * –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ arUploadMorePhotos
 */
function arUploadProjectPhotosFromDetails(projectId) {
    arUploadMorePhotos(projectId);
}
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ 10% –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É–º–º—ã –ø—Ä–æ–µ–∫—Ç–∞
    document.addEventListener('DOMContentLoaded', function() {
        const valueField = document.querySelector('.ar-value-field');
        const commissionField = document.querySelector('.ar-commission-field');
        
        function calculateCommission() {
            if (valueField && commissionField) {
                const value = parseFloat(valueField.value) || 0;
                const commission = value * 0.1;
                commissionField.value = commission.toFixed(2);
            }
        }
        
        // –†–∞—Å—á–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        calculateCommission();
        
        // –†–∞—Å—á–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è
        if (valueField) {
            valueField.addEventListener('input', calculateCommission);
        }
    });
    </script>
    <?php
    $html = ob_get_clean();
    
    error_log("ARTROCKET: Sending project details for {$project['project_id']}");
    
    wp_send_json_success(array(
        'title' => $project['title'],
        'html' => $html
    ));
}








/**
 * –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
 */
add_action('wp_ajax_ar_save_profile', 'ar_ajax_save_profile');
function ar_ajax_save_profile() {
    error_log("ARTROCKET PROFILE: ar_save_profile called");
    
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_save_profile')) {
        wp_send_json_error('Eroare de securitate');
    }
    
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }
    
    $user_id = get_current_user_id();
    $response_data = [];
    
    try {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
        if (!empty($_FILES['avatar_file'])) {
            error_log("ARTROCKET PROFILE: Processing avatar upload");
            
            require_once(ABSPATH . 'wp-admin/includes/file.php');
            require_once(ABSPATH . 'wp-admin/includes/image.php');
            
            $upload = wp_handle_upload($_FILES['avatar_file'], array(
                'test_form' => false,
                'mimes' => array(
                    'jpg|jpeg' => 'image/jpeg',
                    'png' => 'image/png',
                    'gif' => 'image/gif',
                    'webp' => 'image/webp'
                )
            ));
            
            if (isset($upload['error'])) {
                throw new Exception('Eroare la √ÆncƒÉrcarea imaginii: ' . $upload['error']);
            }
            
            // –°–æ–∑–¥–∞–µ–º attachment
            $attachment_id = wp_insert_attachment(array(
                'post_mime_type' => $upload['type'],
                'post_title' => preg_replace('/\.[^.]+$/', '', basename($upload['file'])),
                'post_content' => '',
                'post_status' => 'inherit'
            ), $upload['file']);
            
            if (is_wp_error($attachment_id)) {
                throw new Exception('Eroare la crearea attachment-ului');
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            $attach_data = wp_generate_attachment_metadata($attachment_id, $upload['file']);
            wp_update_attachment_metadata($attachment_id, $attach_data);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∞–≤–∞—Ç–∞—Ä–∞ –≤ user meta
            update_user_meta($user_id, 'ar_profile_avatar', $upload['url']);
            $response_data['avatar_url'] = $upload['url'];
            
            error_log("ARTROCKET PROFILE: Avatar uploaded successfully: " . $upload['url']);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è (–ù–û–í–û–ï)
        if (!empty($_FILES['cover_file'])) {
            error_log("ARTROCKET PROFILE: Processing cover upload");
            
            require_once(ABSPATH . 'wp-admin/includes/file.php');
            require_once(ABSPATH . 'wp-admin/includes/image.php');
            
            $upload = wp_handle_upload($_FILES['cover_file'], array(
                'test_form' => false,
                'mimes' => array(
                    'jpg|jpeg' => 'image/jpeg',
                    'png' => 'image/png',
                    'webp' => 'image/webp'
                )
            ));
            
            if (isset($upload['error'])) {
                throw new Exception('Eroare la √ÆncƒÉrcarea capriciul: ' . $upload['error']);
            }
            
            // –°–æ–∑–¥–∞–µ–º attachment –¥–ª—è –æ–±–ª–æ–∂–∫–∏
            $attachment_id = wp_insert_attachment(array(
                'post_mime_type' => $upload['type'],
                'post_title' => preg_replace('/\.[^.]+$/', '', basename($upload['file'])),
                'post_content' => '',
                'post_status' => 'inherit'
            ), $upload['file']);
            
            if (is_wp_error($attachment_id)) {
                throw new Exception('Eroare la crearea attachment-ului pentru capriciul');
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–ª–æ–∂–∫–∏
            $attach_data = wp_generate_attachment_metadata($attachment_id, $upload['file']);
            wp_update_attachment_metadata($attachment_id, $attach_data);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ–±–ª–æ–∂–∫–∏ –≤ user meta (—Å –ø–æ–º–æ—â—å—é —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏)
            update_user_meta($user_id, 'ar_profile_cover_image_id', $attachment_id);
            $response_data['cover_url'] = $upload['url'];
            
            error_log("ARTROCKET PROFILE: Cover uploaded successfully: " . $upload['url']);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        $basic_fields = ['first_name', 'last_name', 'phone', 'city', 'country'];
        foreach ($basic_fields as $field) {
            if (isset($_POST[$field])) {
                update_user_meta($user_id, $field, sanitize_text_field($_POST[$field]));
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ email
        if (isset($_POST['email'])) {
            $new_email = sanitize_email($_POST['email']);
            $current_user = wp_get_current_user();
            
            if ($new_email !== $current_user->user_email) {
                if (email_exists($new_email) && email_exists($new_email) !== $user_id) {
                    throw new Exception('Acest email este deja utilizat de alt utilizator');
                }
                
                wp_update_user(array(
                    'ID' => $user_id,
                    'user_email' => $new_email
                ));
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
        $social_fields = ['linkedin', 'facebook', 'instagram'];
        foreach ($social_fields as $field) {
            if (isset($_POST[$field])) {
                update_user_meta($user_id, $field, esc_url_raw($_POST[$field]));
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏
$company_fields = ['company_name', 'fiscal_code', 'price_per_sqm'];
foreach ($company_fields as $field) {
    if (isset($_POST[$field])) {
        // –î–ª—è –ø–æ–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –º–µ—Ç—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ float
        if ($field === 'price_per_sqm') {
            $value = floatval($_POST[$field]);
        } else {
            $value = sanitize_text_field($_POST[$field]);
        }
        update_user_meta($user_id, $field, $value);
    }
}
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏ –∫–æ–¥–∞ –ù–î–°
        $bank_fields = ['iban', 'bank_name', 'bank_code', 'vat_code'];
        foreach ($bank_fields as $field) {
            if (isset($_POST[$field])) {
                update_user_meta($user_id, $field, sanitize_text_field($_POST[$field]));
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ TVA
        $vat_registered = isset($_POST['vat_registered']) ? 1 : 0;
        update_user_meta($user_id, 'vat_registered', $vat_registered);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
        if (!empty($_POST['new_password'])) {
            if ($_POST['new_password'] !== $_POST['confirm_password']) {
                throw new Exception('Parolele nu coincid');
            }
            
            if (strlen($_POST['new_password']) < 6) {
                throw new Exception('Parola trebuie sƒÉ aibƒÉ minim 6 caractere');
            }
            
            wp_set_password(sanitize_text_field($_POST['new_password']), $user_id);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–Ω–æ–≤–æ –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
            wp_set_auth_cookie($user_id);
        }
        
        // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–æ–µ–∫—Ç–æ–≤
        if (class_exists('AR_Project_Cache')) {
            AR_Project_Cache::clear_user_projects_cache($user_id);
        }
        
        error_log("ARTROCKET PROFILE: Profile updated successfully for user {$user_id}");
        
        wp_send_json_success($response_data);
        
    } catch (Exception $e) {
        error_log("ARTROCKET PROFILE: Error - " . $e->getMessage());
        wp_send_json_error($e->getMessage());
    }
}

/**
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
 */
function ar_auto_remove_demo_on_real_project($user_id) {
    if (!ar_has_real_projects($user_id)) {
        return false;
    }
    
    // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, —É–¥–∞–ª—è–µ–º –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç—ã
    $demo_removed = ar_remove_all_demo_projects($user_id);
    
    if ($demo_removed) {
        error_log("ARTROCKET DEMO: Auto-removed demo projects for user {$user_id} - real projects detected");
        update_user_meta($user_id, 'ar_demo_auto_removed', current_time('mysql'));
    }
    
    return $demo_removed;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã (–Ω–µ –¥–µ–º–æ)
 */
function ar_has_real_projects($user_id) {
    $projects = AR_Project_Cache::get_user_projects($user_id);
    
    foreach ($projects as $project) {
        if (!ar_is_demo_project($project['project_id'], $user_id)) {
            return true;
        }
    }
    
    return false;
}

/**
 * –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function ar_remove_all_demo_projects($user_id) {
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    $products_table = $wpdb->prefix . 'project_products';
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $demo_projects = $wpdb->get_results($wpdb->prepare(
        "SELECT project_id FROM $projects_table 
         WHERE user_id = %d AND (project_id LIKE 'demo_%' OR metadata LIKE '%\"is_demo\":true%' OR metadata LIKE '%\"is_demo\": true%' OR metadata LIKE '%\"is_demo\"%:%true%')",
        $user_id
    ));
    
    if (empty($demo_projects)) {
        return false;
    }
    
    $removed_count = 0;
    
    foreach ($demo_projects as $demo_project) {
        // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –≤ abandoned –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è
        $result = $wpdb->update(
            $projects_table,
            array('status' => 'abandoned'),
            array('project_id' => $demo_project->project_id)
        );
        
        if ($result !== false) {
            $removed_count++;
            error_log("ARTROCKET DEMO: Moved demo project {$demo_project->project_id} to abandoned status");
        }
    }
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à
    AR_Project_Cache::clear_user_projects_cache($user_id);
    
    return $removed_count > 0;
}

/**
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –ü–†–û–ï–ö–¢–ê - –ø–µ—Ä–µ–Ω–æ—Å –≤ abandoned –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è
 */
add_action('wp_ajax_ar_delete_project', 'ar_ajax_move_project_to_abandoned');
function ar_ajax_move_project_to_abandoned() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_delete_project')) {
        wp_send_json_error('Eroare de securitate');
    }
    
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }
    
    $project_id = sanitize_text_field($_POST['project_id']);
    $user_id = get_current_user_id();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç–æ–º –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    ar_track_demo_project_deletion($project_id, $user_id);
    
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    $user_project = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM $projects_table WHERE project_id = %s AND user_id = %d",
        $project_id, $user_id
    ));
    
    if (!$user_project) {
        wp_send_json_error('Proiectul nu a fost gƒÉsit sau nu ave»õi acces la el');
    }
    
    // –ü–ï–†–ï–ù–û–°–ò–ú –ü–†–û–ï–ö–¢ –í –°–¢–ê–¢–£–° ABANDONED –í–ú–ï–°–¢–û –£–î–ê–õ–ï–ù–ò–Ø
    $result = $wpdb->update(
        $projects_table,
        array(
            'status' => 'abandoned',
            'updated_at' => current_time('mysql')
        ),
        array('project_id' => $project_id),
        array('%s', '%s'),
        array('%s')
    );
    
    if ($result === false) {
        $error = $wpdb->last_error ?: 'Eroare necunoscutƒÉ la baza de date';
        error_log("ARTROCKET ABANDONED: Database error moving to abandoned: {$error}");
        wp_send_json_error('Eroare la mutarea proiectului √Æn sec»õiunea abandonatƒÉ');
    }
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à
    AR_Project_Cache::clear_user_projects_cache($user_id);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º –¥–µ–º–æ-–ø—Ä–æ–µ–∫—Ç—ã –µ—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å —Ä–µ–∞–ª—å–Ω—ã–µ
    ar_auto_remove_demo_on_real_project($user_id);
    
    error_log("ARTROCKET ABANDONED: Successfully moved project {$project_id} to abandoned status for user {$user_id}");
    
    wp_send_json_success('Proiectul a fost mutat √Æn sec»õiunea proiectelor abandonate');
}





/**
 * AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞ - –û–ë–ù–û–í–õ–ï–ù –° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ú –†–ê–°–ß–ï–¢–û–ú –ö–û–ú–ò–°–°–ò–ò
 */
add_action('wp_ajax_ar_save_project_changes', 'ar_ajax_save_project_changes');
function ar_ajax_save_project_changes() {
    error_log("ARTROCKET SAVE: ar_save_project_changes called");
    error_log("ARTROCKET SAVE: POST data: " . print_r($_POST, true));
    
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_save_project_changes')) {
        error_log("ARTROCKET SAVE: Nonce verification failed");
        wp_send_json_error('Eroare de securitate');
        return;
    }
    
    if (!is_user_logged_in()) {
        error_log("ARTROCKET SAVE: User not logged in");
        wp_send_json_error('Utilizatorul nu este autentificat');
        return;
    }
    
    $project_id = isset($_POST['project_id']) ? sanitize_text_field($_POST['project_id']) : '';
    
    if (empty($project_id)) {
        error_log("ARTROCKET SAVE: Empty project_id");
        wp_send_json_error('ID-ul proiectului este necesar');
        return;
    }
    
    $user_id = get_current_user_id();
    
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    $user_project = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM $projects_table WHERE project_id = %s AND user_id = %d",
        $project_id, $user_id
    ));
    
    if (!$user_project) {
        error_log("ARTROCKET SAVE: Project not found or access denied for project_id={$project_id}, user_id={$user_id}");
        wp_send_json_error('Proiectul nu a fost gƒÉsit sau nu ave»õi acces la el');
        return;
    }
    
    $update_data = array();
    
    // –û–°–ù–û–í–ù–´–ï –ü–û–õ–Ø
    if (isset($_POST['title'])) {
        $update_data['title'] = sanitize_text_field($_POST['title']);
    }
    
    if (isset($_POST['status'])) {
        $status = sanitize_text_field($_POST['status']);
        if (in_array($status, ['in_progress', 'pending', 'completed'])) {
            $update_data['status'] = $status;
        }
    }
    
    if (isset($_POST['value'])) {
        $update_data['value'] = floatval($_POST['value']);
        
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ê–°–ß–ï–¢ –ö–û–ú–ò–°–°–ò–ò 10% –ï–°–õ–ò –û–ù–ê –ù–ï –£–ö–ê–ó–ê–ù–ê
        if (!isset($_POST['designer_income']) || empty($_POST['designer_income'])) {
            $update_data['designer_income'] = floatval($_POST['value']) * 0.1;
            error_log("ARTROCKET SAVE: Auto-calculated commission: {$update_data['designer_income']}");
        }
    }
    
    if (isset($_POST['designer_income'])) {
        $update_data['designer_income'] = floatval($_POST['designer_income']);
    }
    
    // –ù–û–í–´–ï –ü–û–õ–Ø –ü–†–û–ï–ö–¢–ê
    if (isset($_POST['project_deadline'])) {
        $update_data['project_deadline'] = sanitize_text_field($_POST['project_deadline']);
    }
    
    if (isset($_POST['is_commercial'])) {
        $update_data['is_commercial'] = intval($_POST['is_commercial']);
    } else {
        $update_data['is_commercial'] = 0;
    }
    
    if (isset($_POST['project_description'])) {
        $update_data['project_description'] = sanitize_textarea_field($_POST['project_description']);
    }
    
    if (isset($_POST['project_comment'])) {
        $update_data['project_comment'] = sanitize_textarea_field($_POST['project_comment']);
    }
    
    // –ü–û–õ–Ø –ö–õ–ò–ï–ù–¢–ê
    if (isset($_POST['client_name'])) {
        $update_data['client_name'] = sanitize_text_field($_POST['client_name']);
    }
    
    if (isset($_POST['client_email'])) {
        $update_data['client_email'] = sanitize_email($_POST['client_email']);
    }
    
    if (isset($_POST['client_phone'])) {
        $update_data['client_phone'] = sanitize_text_field($_POST['client_phone']);
    }
    
    if (isset($_POST['client_address'])) {
        $update_data['client_address'] = sanitize_textarea_field($_POST['client_address']);
    }
    
    $update_data['updated_at'] = current_time('mysql');
    
    error_log("ARTROCKET SAVE: Update data: " . print_r($update_data, true));
    
    $result = $wpdb->update(
        $projects_table,
        $update_data,
        array('project_id' => $project_id),
        array_fill(0, count($update_data), '%s'),
        array('%s')
    );
    
    if ($result === false) {
        $db_error = $wpdb->last_error;
        error_log("ARTROCKET SAVE: Database update failed: {$db_error}");
        wp_send_json_error('Eroare la salvarea √Æn baza de date: ' . $db_error);
        return;
    }
    
    error_log("ARTROCKET SAVE: Database update result: {$result}");
    
    AR_Project_Cache::clear_user_projects_cache($user_id);
    
    error_log("ARTROCKET SAVE: Successfully updated project {$project_id} by user {$user_id}");
    
    wp_send_json_success('Proiectul a fost actualizat cu succes');
}

add_action('wp_ajax_ar_refresh_crm', 'ar_ajax_refresh_crm');
function ar_ajax_refresh_crm() {
    if (!wp_verify_nonce($_POST['nonce'], 'ar_refresh_crm')) {
        wp_send_json_error('Eroare de securitate');
    }
    
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }
    
    $user_id = get_current_user_id();
    
    AR_Project_Cache::clear_user_projects_cache($user_id);
    
    wp_cache_flush();
    
    update_user_meta($user_id, 'ar_last_cache_refresh', current_time('mysql'));
    
    error_log("ARTROCKET CRM: Manual cache refresh for user {$user_id}");
    
    wp_send_json_success('Cache-ul CRM a fost actualizat cu succes');
}

/**
 * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
 */
add_action('wp_ajax_ar_delete_project', 'ar_ajax_delete_project');
function ar_ajax_delete_project() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_delete_project')) {
        wp_send_json_error('Eroare de securitate');
    }
    
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }
    
    $project_id = sanitize_text_field($_POST['project_id']);
    $user_id = get_current_user_id();
    
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    $products_table = $wpdb->prefix . 'project_products';
    
    // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê - –∏—â–µ–º –ø—Ä–æ–µ–∫—Ç –ø–æ user_id –ò–õ–ò –ø–æ registration codes –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $user_project = $wpdb->get_row($wpdb->prepare(
        "SELECT p.* FROM $projects_table p 
         WHERE p.project_id = %s 
         AND (p.user_id = %d OR p.designer_key IN (
             SELECT meta_value FROM {$wpdb->usermeta} 
             WHERE user_id = %d AND meta_key = '_user_license_reg_codes'
             UNION
             SELECT meta_value FROM {$wpdb->postmeta} 
             WHERE post_id IN (
                 SELECT ID FROM {$wpdb->posts} 
                 WHERE post_type = 'shop_order' AND post_author = %d
             ) AND meta_key = '_license_reg_code'
         ))",
        $project_id, $user_id, $user_id, $user_id
    ));
    
    if (!$user_project) {
        error_log("ARTROCKET DELETE: Project not found or access denied for project_id={$project_id}, user_id={$user_id}");
        wp_send_json_error('Proiectul nu a fost gƒÉsit sau nu ave»õi acces la el');
        return;
    }
    
    // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
    $wpdb->query('START TRANSACTION');
    
    try {
        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
        $products_deleted = $wpdb->delete($products_table, array('project_id' => $project_id));
        error_log("ARTROCKET DELETE: Deleted {$products_deleted} products for project {$project_id}");
        
        // –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º —Å–∞–º –ø—Ä–æ–µ–∫—Ç
        $project_deleted = $wpdb->delete($projects_table, array('project_id' => $project_id));
        
        if ($project_deleted === false) {
            throw new Exception('Eroare la »ôtergerea proiectului din baza de date');
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        $wpdb->query('COMMIT');
        
        // –û—á–∏—â–∞–µ–º –∫—ç—à
        AR_Project_Cache::clear_user_projects_cache($user_id);
        
        error_log("ARTROCKET DELETE: Successfully deleted project {$project_id} for user {$user_id}");
        
        wp_send_json_success('Proiectul a fost »ôters cu succes');
        
    } catch (Exception $e) {
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        $wpdb->query('ROLLBACK');
        error_log("ARTROCKET DELETE ERROR: " . $e->getMessage());
        wp_send_json_error('Eroare la »ôtergerea proiectului: ' . $e->getMessage());
    }
}

add_action('rest_api_init', function() {
    register_rest_route('ar/v1', '/export-manufacturer', array(
        'methods' => 'GET',
        'callback' => 'ar_export_manufacturer_products',
        'permission_callback' => function() {
            return is_user_logged_in();
        }
    ));
    
    register_rest_route('ar/v1', '/export-full-estimate', array(
        'methods' => 'GET',
        'callback' => 'ar_export_full_estimate',
        'permission_callback' => function() {
            return is_user_logged_in();
        }
    ));
});

function ar_export_manufacturer_products($request) {
    $project_id = $request->get_param('project_id');
    $manufacturer_id = $request->get_param('manufacturer_id');
    $user_id = get_current_user_id();
    
    $projects = ar_get_user_projects($user_id);
    $project = null;
    
    foreach ($projects as $proj) {
        if ($proj['project_id'] === $project_id) {
            $project = $proj;
            break;
        }
    }
    
    if (!$project) {
        return new WP_REST_Response(['error' => 'Proiectul nu a fost gƒÉsit'], 404);
    }
    
    $manufacturer_products = array_filter($project['products'], function($product) use ($manufacturer_id) {
        $product_manuf = !empty($product['manufacturer_id']) ? $product['manufacturer_id'] : 'other';
        return $product_manuf === $manufacturer_id;
    });
    
    if (empty($manufacturer_products)) {
        return new WP_REST_Response(['error' => 'Nu s-au gƒÉsit produse pentru acest producƒÉtor'], 404);
    }
    
    $filename = "estimare-{$project_id}-{$manufacturer_id}.csv";
    
    header('Content-Type: text/csv; charset=utf-8');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    
    $output = fopen('php://output', 'w');
    
    fputcsv($output, ['Produs', 'Cantitate', 'Unitate', 'Pre»õ unitar', 'Pre»õ total'], ';');
    
    foreach ($manufacturer_products as $product) {
        fputcsv($output, [
            $product['product_name'],
            $product['quantity'],
            $product['unit'],
            $product['unit_price'],
            $product['total_price']
        ], ';');
    }
    
    fclose($output);
    exit;
}

function ar_export_full_estimate($request) {
    $project_id = $request->get_param('project_id');
    $user_id = get_current_user_id();
    
    $projects = ar_get_user_projects($user_id);
    $project = null;
    
    foreach ($projects as $proj) {
        if ($proj['project_id'] === $project_id) {
            $project = $proj;
            break;
        }
    }
    
    if (!$project) {
        return new WP_REST_Response(['error' => 'Proiectul nu a fost gƒÉsit'], 404);
    }
    
    if (empty($project['products'])) {
        return new WP_REST_Response(['error' => 'Nu existƒÉ produse √Æn acest proiect'], 404);
    }
    
    $filename = "estimare-completa-{$project_id}.csv";
    
    header('Content-Type: text/csv; charset=utf-8');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    
    $output = fopen('php://output', 'w');
    
    fputcsv($output, ['ProducƒÉtor', 'Produs', 'Cantitate', 'Unitate', 'Pre»õ unitar', 'Pre»õ total'], ';');
    
    foreach ($project['products'] as $product) {
        $manufacturer = !empty($product['manufacturer_id']) ? $product['manufacturer_id'] : 'Altele';
        
        fputcsv($output, [
            $manufacturer,
            $product['product_name'],
            $product['quantity'],
            $product['unit'],
            $product['unit_price'],
            $product['total_price']
        ], ';');
    }
    
    fclose($output);
    exit;
}

function ar_create_projects_page() {
    $page_title = 'Proiectele mele';
    $page_content = '[ar_my_projects]';
    
    $page = get_page_by_title($page_title);
    
    if (!$page) {
        $page_data = array(
            'post_title'    => $page_title,
            'post_content'  => $page_content,
            'post_status'   => 'publish',
            'post_type'     => 'page',
            'post_author'   => 1,
            'post_name'     => 'proiectele'
        );
        
        $page_id = wp_insert_post($page_data);
        
        if ($page_id) {
            error_log("ARTROCKET: Successfully created projects page with ID: " . $page_id);
            return $page_id;
        } else {
            error_log("ARTROCKET: Failed to create projects page");
            return false;
        }
    } else {
        error_log("ARTROCKET: Projects page already exists with ID: " . $page->ID);
        return $page->ID;
    }
}

register_activation_hook(__FILE__, 'ar_create_projects_page');
register_activation_hook(__FILE__, 'ar_run_migrations');

add_action('admin_menu', 'ar_add_api_settings_page');
function ar_add_api_settings_page() {
    add_options_page(
        'ArtRocket API Settings',
        'ArtRocket API', 
        'manage_options',
        'ar-api-settings',
        'ar_render_api_settings_page'
    );
}

function ar_render_api_settings_page() {
    if (isset($_POST['ar_regenerate_api_key']) && check_admin_referer('ar_api_regenerate')) {
        $new_key = wp_generate_password(64, false);
        update_option('ar_designer_software_api_key', $new_key);
        echo '<div class="updated"><p>‚úÖ API key regenerated successfully.</p></div>';
    }
    
    if (isset($_POST['ar_set_api_key']) && check_admin_referer('ar_api_set')) {
        $manual_key = sanitize_text_field($_POST['ar_manual_api_key']);
        if (!empty($manual_key)) {
            update_option('ar_designer_software_api_key', $manual_key);
            echo '<div class="updated"><p>‚úÖ API key set successfully.</p></div>';
        }
    }
    
    $api_key = get_option('ar_designer_software_api_key', '');
    
    if (empty($api_key)) {
        $api_key = wp_generate_password(64, false);
        update_option('ar_designer_software_api_key', $api_key);
    }
    ?>
    <div class="wrap">
        <h1>ArtRocket API Settings</h1>
        
        <div class="card" style="max-width: 800px; padding: 20px; background: #fff; border: 1px solid #ccd0d4; margin: 20px 0;">
            <h2>API Configuration</h2>
            
            <p><strong>Current API Key:</strong></p>
            <code style="display: block; padding: 15px; background: #f1f1f1; margin: 10px 0; word-break: break-all; font-size: 14px; border: 1px solid #ddd;">
                <?php echo esc_html($api_key); ?>
            </code>
            
            <p><strong>How to use:</strong></p>
            <pre style="background: #f7f7f7; padding: 15px; border: 1px solid #ddd; overflow: auto;">
Authorization: Bearer <?php echo esc_html($api_key); ?></pre>

            <form method="post" style="margin-top: 20px;">
                <?php wp_nonce_field('ar_api_regenerate'); ?>
                <button type="submit" name="ar_regenerate_api_key" class="button button-primary">
                    üîÑ Regenerate API Key
                </button>
                <p class="description">Generate a new API key (this will invalidate the old one)</p>
            </form>

            <hr style="margin: 30px 0;">

            <h3>Set Custom API Key</h3>
            <form method="post">
                <?php wp_nonce_field('ar_api_set'); ?>
                <input type="text" name="ar_manual_api_key" value="<?php echo esc_attr($api_key); ?>" 
                       style="width: 100%; padding: 10px; margin: 10px 0;" 
                       placeholder="Enter your custom API key">
                <button type="submit" name="ar_set_api_key" class="button button-secondary">
                    üíæ Save Custom Key
                </button>
            </form>
        </div>
    </div>
    <?php
}

function ar_verify_api_key($request) {
    $api_key = get_option('ar_designer_software_api_key', '');
    $auth_header = $request->get_header('Authorization');
    
    if (!$auth_header || !$api_key) {
        return false;
    }
    
    if (strpos($auth_header, 'Bearer ') === 0) {
        $token = substr($auth_header, 7);
        return hash_equals($api_key, $token);
    }
    
    return false;
}

add_action('ar_project_created', 'ar_clear_cache_on_project_change', 10, 2);
add_action('ar_project_updated', 'ar_clear_cache_on_project_change', 10, 2);
add_action('ar_project_deleted', 'ar_clear_cache_on_project_change', 10, 2);

function ar_clear_cache_on_project_change($project_id, $user_id) {
    AR_Project_Cache::clear_user_projects_cache($user_id);
    error_log("ARTROCKET CACHE: Auto-cleared cache for user {$user_id} due to project change");
}

add_action('woocommerce_update_order', 'ar_clear_cache_on_order_update', 10, 2);
function ar_clear_cache_on_order_update($order_id, $order) {
    $user_id = $order->get_user_id();
    if ($user_id) {
        AR_Project_Cache::clear_user_projects_cache($user_id);
        error_log("ARTROCKET CACHE: Auto-cleared cache for user {$user_id} due to order update");
    }
}

add_action('profile_update', 'ar_clear_cache_on_user_update', 10, 2);
function ar_clear_cache_on_user_update($user_id, $old_user_data) {
    AR_Project_Cache::clear_user_projects_cache($user_id);
    error_log("ARTROCKET CACHE: Auto-cleared cache for user {$user_id} due to profile update");
}

/* ========= DESIGNER CABINET SYSTEM END ========= */


/* ========= DESIGNER CABINET SYSTEM - PHOTO UPLOAD FUNCTIONALITY ========= */

/**
 * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
 */
function ar_add_photo_upload_modal() {
    if (!is_user_logged_in()) return;
    ?>
    <div id="arPhotoUploadModal" class="ar-modal" style="display: none;">
        <div class="ar-modal-content" style="max-width: 700px;">
            <div class="ar-modal-header">
                <h2 id="arPhotoUploadTitle">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞</h2>
                <button class="ar-modal-close" onclick="arClosePhotoUploadModal()">√ó</button>
            </div>
            
            <div class="ar-modal-body">
                <form id="arPhotoUploadForm" enctype="multipart/form-data">
                    <input type="hidden" id="arPhotoUploadProjectId" name="project_id" value="">
                    <input type="hidden" id="arPhotoUploadProjectTitle" name="project_title" value="">
                    
                    <div class="ar-photo-upload-instructions">
                        <p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</strong></p>
                        <p>–í—ã –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.</p>
                        <ul>
                            <li>–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 10 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</li>
                            <li>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: 2 –ú–ë</li>
                            <li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP</li>
                            <li>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤–∞–º –∏ –∫–ª–∏–µ–Ω—Ç—É</li>
                        </ul>
                    </div>
                    
                    <div class="ar-photo-upload-area" onclick="document.getElementById('arPhotoFiles').click();">
                        <input type="file" 
                               id="arPhotoFiles" 
                               name="project_photos[]" 
                               multiple 
                               accept="image/*" 
                               style="display: none;"
                               onchange="arHandlePhotoSelection()">
                        
                        <div class="ar-upload-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</span>
                        </div>
                        
                        <div class="ar-upload-hint">
                            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
                        </div>
                    </div>
                    
                    <div id="arPhotoPreview" class="ar-photo-preview-container" style="margin-top: 20px;"></div>
                    
                    <div class="ar-upload-progress" id="arUploadProgress" style="display: none;">
                        <div class="ar-progress-bar">
                            <div class="ar-progress-fill" id="arProgressFill"></div>
                        </div>
                        <div class="ar-progress-text" id="arProgressText">0%</div>
                    </div>
                    
                    <div id="arPhotoUploadErrors" class="ar-error-message" style="display: none;"></div>
                    
                    <div class="ar-upload-options" style="margin-top: 20px; display: flex; gap: 10px; justify-content: space-between;">
                        <button type="button" class="ar-btn ar-btn-secondary" onclick="arSkipPhotoUpload()">
                            –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                        <button type="button" class="ar-btn ar-btn-primary" id="arUploadPhotosBtn" onclick="arUploadProjectPhotos()" disabled>
                            üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
    let selectedPhotos = [];
    let currentProjectForPhotoUpload = null;
    let originalProjectColumn = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –≤ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
    function arShowPhotoUploadModal(projectId, projectTitle, originalColumn) {
        console.log('üì∏ Opening photo upload modal for project:', projectId, projectTitle);
        
        currentProjectForPhotoUpload = {
            id: projectId,
            title: projectTitle
        };
        
        originalProjectColumn = originalColumn;
        
        document.getElementById('arPhotoUploadProjectId').value = projectId;
        document.getElementById('arPhotoUploadProjectTitle').value = projectTitle;
        document.getElementById('arPhotoUploadTitle').textContent = `üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: ${projectTitle}`;
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∞–π–ª—ã
        selectedPhotos = [];
        document.getElementById('arPhotoPreview').innerHTML = '';
        document.getElementById('arPhotoUploadErrors').style.display = 'none';
        document.getElementById('arPhotoUploadErrors').innerHTML = '';
        document.getElementById('arUploadProgress').style.display = 'none';
        document.getElementById('arProgressFill').style.width = '0%';
        document.getElementById('arProgressText').textContent = '0%';
        document.getElementById('arUploadPhotosBtn').disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('arPhotoUploadModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function arClosePhotoUploadModal() {
        document.getElementById('arPhotoUploadModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        selectedPhotos = [];
        currentProjectForPhotoUpload = null;
        originalProjectColumn = null;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
    function arHandlePhotoSelection() {
        const fileInput = document.getElementById('arPhotoFiles');
        const files = Array.from(fileInput.files);
        const previewContainer = document.getElementById('arPhotoPreview');
        const uploadBtn = document.getElementById('arUploadPhotosBtn');
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–µ–≤—å—é
        previewContainer.innerHTML = '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
        if (selectedPhotos.length + files.length > 10) {
            arShowPhotoError('–ù–µ–ª—å–∑—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–æ–ª—å—à–µ 10 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π');
            fileInput.value = '';
            return;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
        const validFiles = [];
        const errors = [];
        
        files.forEach((file, index) => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (2 –ú–ë = 2 * 1024 * 1024 –±–∞–π—Ç)
            if (file.size > 2 * 1024 * 1024) {
                errors.push(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size / (1024*1024)).toFixed(2)} –ú–ë). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2 –ú–ë`);
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                errors.push(`–§–∞–π–ª "${file.name}" –∏–º–µ–µ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç. –†–∞–∑—Ä–µ—à–µ–Ω—ã: JPG, PNG, GIF, WebP`);
                return;
            }
            
            validFiles.push(file);
        });
        
        if (errors.length > 0) {
            arShowPhotoError(errors.join('<br>'));
            fileInput.value = '';
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        selectedPhotos.push(...validFiles);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
        validFiles.forEach(file => {
            arCreatePhotoPreview(file);
        });
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
        uploadBtn.disabled = selectedPhotos.length === 0;
        
        // –û—á–∏—â–∞–µ–º input
        fileInput.value = '';
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    function arCreatePhotoPreview(file) {
        const previewContainer = document.getElementById('arPhotoPreview');
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const fileId = 'preview_' + Date.now() + Math.random().toString(36).substr(2, 9);
            
            const previewItem = document.createElement('div');
            previewItem.className = 'ar-photo-preview-item';
            previewItem.id = fileId;
            previewItem.dataset.fileName = file.name;
            
            previewItem.innerHTML = `
                <img src="${e.target.result}" class="ar-photo-preview-img" alt="Preview">
                <button type="button" class="ar-photo-preview-remove" onclick="arRemovePhotoPreview('${fileId}')">√ó</button>
                <div class="ar-photo-preview-info">
                    ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}<br>
                    ${(file.size / 1024).toFixed(1)} –ö–ë
                </div>
            `;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ —ç–ª–µ–º–µ–Ω—Ç–µ
            previewItem.fileData = file;
            previewContainer.appendChild(previewItem);
        };
        
        reader.readAsDataURL(file);
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    function arRemovePhotoPreview(fileId) {
        const previewItem = document.getElementById(fileId);
        if (previewItem) {
            // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏–∑ –º–∞—Å—Å–∏–≤–∞ selectedPhotos
            const fileName = previewItem.dataset.fileName;
            selectedPhotos = selectedPhotos.filter(file => file.name !== fileName);
            
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
            previewItem.remove();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        const uploadBtn = document.getElementById('arUploadPhotosBtn');
        uploadBtn.disabled = selectedPhotos.length === 0;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
    function arShowPhotoError(message) {
        const errorContainer = document.getElementById('arPhotoUploadErrors');
        errorContainer.innerHTML = '<strong>–û—à–∏–±–∫–∞:</strong> ' + message;
        errorContainer.style.display = 'block';
        
        setTimeout(() => {
            errorContainer.style.display = 'none';
            errorContainer.innerHTML = '';
        }, 5000);
    }
    
    // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
    function arSkipPhotoUpload() {
        if (!currentProjectForPhotoUpload) return;
        
        if (!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –±–µ–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π?')) {
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ "completed" –±–µ–∑ —Ñ–æ—Ç–æ
        arUpdateProjectStatusDirectly(
            currentProjectForPhotoUpload.id, 
            'completed'
        );
        
        arClosePhotoUploadModal();
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ —Ñ–æ—Ç–æ)
    function arUpdateProjectStatusDirectly(projectId, newStatus) {
        console.log('üîÑ Direct status update:', projectId, newStatus);
        
        const data = new FormData();
        data.append('action', 'ar_update_project_status');
        data.append('project_id', projectId);
        data.append('status', newStatus);
        data.append('nonce', '<?php echo wp_create_nonce("ar_update_project_status"); ?>');
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ–µ–∫—Ç–∞
        const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
        if (projectCard) {
            projectCard.classList.add('status-updating');
        }
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            body: data
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Project status updated successfully');
                arShowNotification('–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–Ω–±–∞–Ω —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                console.error('‚ùå Status update failed:', data.data);
                arShowNotification('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ' + data.data, 'error');
                
                if (projectCard) {
                    projectCard.classList.remove('status-updating');
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Network error:', error);
            arShowNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞', 'error');
            
            if (projectCard) {
                projectCard.classList.remove('status-updating');
            }
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function arUploadProjectPhotos() {
        if (!currentProjectForPhotoUpload || selectedPhotos.length === 0) {
            arShowPhotoError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
            return;
        }
        
        const projectId = currentProjectForPhotoUpload.id;
        const projectTitle = currentProjectForPhotoUpload.title;
        
        const formData = new FormData();
        formData.append('action', 'ar_upload_project_photos');
        formData.append('project_id', projectId);
        formData.append('nonce', '<?php echo wp_create_nonce("ar_upload_project_photos"); ?>');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ FormData - –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
        selectedPhotos.forEach((file, index) => {
            // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è PHP: project_photos[]
            formData.append('project_photos[]', file, file.name);
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
        const progressBar = document.getElementById('arProgressFill');
        const progressText = document.getElementById('arProgressText');
        const progressContainer = document.getElementById('arUploadProgress');
        const uploadBtn = document.getElementById('arUploadPhotosBtn');
        const skipBtn = document.querySelector('.ar-upload-options .ar-btn-secondary');
        
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        uploadBtn.disabled = true;
        skipBtn.disabled = true;
        uploadBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...';
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = Math.round(percentComplete) + '%';
            }
        });
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (response.success) {
                        arShowNotification('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–µ–∫—Ç...', 'success');
                        
                        // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ "completed"
                        setTimeout(() => {
                            arUpdateProjectStatusDirectly(projectId, 'completed');
                            arClosePhotoUploadModal();
                        }, 1500);
                        
                    } else {
                        arShowPhotoError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (response.data || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                        uploadBtn.disabled = false;
                        skipBtn.disabled = false;
                        uploadBtn.innerHTML = 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å';
                    }
                } catch (error) {
                    console.error('Error parsing response:', error);
                    arShowPhotoError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                    uploadBtn.disabled = false;
                    skipBtn.disabled = false;
                    uploadBtn.innerHTML = 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å';
                }
            }
        };
        
        xhr.open('POST', '<?php echo admin_url("admin-ajax.php"); ?>');
        xhr.send(formData);
    }
    
    // Drag & Drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.querySelector('.ar-photo-upload-area');
        const fileInput = document.getElementById('arPhotoFiles');
        
        if (uploadArea && fileInput) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.background = 'rgba(102, 126, 234, 0.15)';
                this.style.borderColor = '#4f66d6';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.background = 'rgba(102, 126, 234, 0.05)';
                this.style.borderColor = '#667eea';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.background = 'rgba(102, 126, 234, 0.05)';
                this.style.borderColor = '#667eea';
                
                const files = Array.from(e.dataTransfer.files);
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FileList
                const dataTransfer = new DataTransfer();
                files.forEach(file => dataTransfer.items.add(file));
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –≤ input
                fileInput.files = dataTransfer.files;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
                arHandlePhotoSelection();
            });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        const photoModal = document.getElementById('arPhotoUploadModal');
        if (photoModal) {
            photoModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    arClosePhotoUploadModal();
                }
            });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && photoModal.style.display === 'flex') {
                arClosePhotoUploadModal();
            }
        });
    });
    </script>
    
    <style>
    .ar-photo-upload-area {
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: rgba(102, 126, 234, 0.05);
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .ar-photo-upload-area:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: #4f66d6;
    }
    
    .ar-upload-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: #667eea;
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s ease;
    }
    
    .ar-upload-btn:hover {
        background: #4f66d6;
    }
    
    .ar-upload-hint {
        margin-top: 10px;
        color: #666;
        font-size: 14px;
    }
    
    .ar-photo-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .ar-photo-preview-item {
        position: relative;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: white;
    }
    
    .ar-photo-preview-img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        display: block;
    }
    
    .ar-photo-preview-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        z-index: 2;
    }
    
    .ar-photo-preview-info {
        padding: 8px;
        background: white;
        font-size: 11px;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        border-top: 1px solid #eee;
    }
    
    .ar-upload-progress {
        margin: 20px 0;
    }
    
    .ar-progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
    }
    
    .ar-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #4f66d6);
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .ar-progress-text {
        text-align: center;
        font-weight: 600;
        color: #667eea;
    }
    
    .ar-error-message {
        background: #fee;
        color: #c33;
        padding: 12px 15px;
        border-radius: 6px;
        border: 1px solid #fcc;
        margin: 15px 0;
        display: none;
    }
    
    .ar-photo-upload-instructions {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .ar-photo-upload-instructions ul {
        margin: 10px 0 0 20px;
        padding: 0;
    }
    
    .ar-photo-upload-instructions li {
        margin-bottom: 5px;
        font-size: 14px;
        color: #666;
    }
    
    .ar-upload-options {
        padding-top: 20px;
        border-top: 1px solid #eee;
        margin-top: 20px;
    }
    </style>
    <?php
}
add_action('wp_footer', 'ar_add_photo_upload_modal');

// –û–ë–ù–û–í–õ–ï–ù–ù–´–ô AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø—Ä–æ–µ–∫—Ç–∞
add_action('wp_ajax_ar_upload_project_photos', 'ar_ajax_upload_project_photos');

function ar_ajax_upload_project_photos() {
    error_log("ARTROCKET PHOTOS: ar_upload_project_photos called");
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (required for all photo uploads)
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    $nonce = isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : '';
    if (!wp_verify_nonce($nonce, 'ar_upload_project_photos')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π nonce');
    }
    
    $project_id = isset($_POST['project_id']) ? sanitize_text_field($_POST['project_id']) : '';
    $user_id = get_current_user_id();
    
    if (empty($project_id)) {
        wp_send_json_error('ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
    }
    
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ–µ–∫—Ç –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ –æ–Ω —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    $project = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $projects_table WHERE project_id = %s AND user_id = %d",
        $project_id, $user_id
    ));
    
    if (!$project) {
        wp_send_json_error('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞–º');
    }
    
    if (empty($_FILES['project_photos'])) {
        wp_send_json_error('–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤');
    }
    
    $file_count = is_array($_FILES['project_photos']['name']) ? 
                  count($_FILES['project_photos']['name']) : 0;
    
    if ($file_count > 10) {
        wp_send_json_error('–ù–µ–ª—å–∑—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–æ–ª—å—à–µ 10 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π');
    }
    
    $upload_dir = wp_upload_dir();
    $project_photos_dir = $upload_dir['basedir'] . '/project-photos/' . $project_id;
    
    // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    if (!file_exists($project_photos_dir)) {
        wp_mkdir_p($project_photos_dir);
        error_log("ARTROCKET PHOTOS: Created directory: $project_photos_dir");
    }
    
    $uploaded_files = [];
    $errors = [];
    
    require_once(ABSPATH . 'wp-admin/includes/file.php');
    require_once(ABSPATH . 'wp-admin/includes/image.php');
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    for ($i = 0; $i < $file_count; $i++) {
        if ($_FILES['project_photos']['error'][$i] === 0) {
            $file = array(
                'name'     => sanitize_file_name($_FILES['project_photos']['name'][$i]),
                'type'     => $_FILES['project_photos']['type'][$i],
                'tmp_name' => $_FILES['project_photos']['tmp_name'][$i],
                'error'    => $_FILES['project_photos']['error'][$i],
                'size'     => $_FILES['project_photos']['size'][$i]
            );
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (2 –ú–ë)
            if ($file['size'] > 2 * 1024 * 1024) {
                $errors[] = "–§–∞–π–ª {$file['name']} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π";
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            $allowed_types = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!in_array($file['type'], $allowed_types)) {
                $errors[] = "–§–∞–π–ª {$file['name']} –∏–º–µ–µ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç";
                continue;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
            $filename = wp_unique_filename($project_photos_dir, $file['name']);
            $destination = $project_photos_dir . '/' . $filename;
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–∞–π–ª
            if (move_uploaded_file($file['tmp_name'], $destination)) {
                // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É
                $image = wp_get_image_editor($destination);
                if (!is_wp_error($image)) {
                    $image->resize(150, 150, true);
                    $thumbnail_path = $project_photos_dir . '/thumb_' . $filename;
                    $image->save($thumbnail_path);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                $uploaded_files[] = array(
                    'name' => $file['name'],
                    'path' => $destination,
                    'url' => $upload_dir['baseurl'] . '/project-photos/' . $project_id . '/' . $filename,
                    'thumbnail' => $upload_dir['baseurl'] . '/project-photos/' . $project_id . '/thumb_' . $filename,
                    'size' => $file['size'],
                    'type' => $file['type'],
                    'uploaded_at' => current_time('mysql')
                );
                
                error_log("ARTROCKET PHOTOS: Successfully uploaded: {$file['name']}");
            } else {
                $errors[] = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª {$file['name']}";
            }
        }
    }
    
    if (!empty($errors)) {
        error_log("ARTROCKET PHOTOS: Upload errors: " . implode(', ', $errors));
        wp_send_json_error('–û—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ' . implode(', ', $errors));
    }
    
    if (empty($uploaded_files)) {
        wp_send_json_error('–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤');
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
    $existing_photos = array();
    if (!empty($project->photos)) {
        $existing_photos = json_decode($project->photos, true);
        if (!is_array($existing_photos)) {
            $existing_photos = array();
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
    $all_photos = array_merge($existing_photos, $uploaded_files);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –ø—Ä–æ–µ–∫—Ç–∞ —Å –Ω–æ–≤—ã–º–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
    $result = $wpdb->update(
        $projects_table,
        array(
            'photos' => json_encode($all_photos),
            'updated_at' => current_time('mysql')
        ),
        array('project_id' => $project_id, 'user_id' => $user_id),
        array('%s', '%s'),
        array('%s', '%d')
    );
    
    if ($result === false) {
        error_log("ARTROCKET PHOTOS: Failed to update project photos: " . $wpdb->last_error);
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–æ—Ç–æ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö');
    }
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à
    if (class_exists('AR_Project_Cache')) {
        AR_Project_Cache::clear_user_projects_cache($user_id);
    }
    
    error_log("ARTROCKET PHOTOS: Successfully uploaded " . count($uploaded_files) . " photos for project {$project_id}");
    
    wp_send_json_success(array(
        'message' => '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã',
        'uploaded_count' => count($uploaded_files),
        'total_photos' => count($all_photos),
        'photos' => $all_photos
    ));
}

/**
 * –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –∫–∞–Ω–±–∞–Ω–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)
 * CONSOLIDATED: Handles project status updates with photo validation
 */
add_action('wp_ajax_ar_update_project_status', 'ar_ajax_update_project_status_with_photos');
add_action('wp_ajax_nopriv_ar_update_project_status', 'ar_ajax_update_project_status_with_photos');
function ar_ajax_update_project_status_with_photos() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    $user_id = get_current_user_id();
    
    if (empty($_POST['project_id'])) {
        wp_send_json_error('ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
    }
    
    if (empty($_POST['status'])) {
        wp_send_json_error('–°—Ç–∞—Ç—É—Å –Ω–µ —É–∫–∞–∑–∞–Ω');
    }
    
    $project_id = sanitize_text_field($_POST['project_id']);
    $new_status = sanitize_text_field($_POST['status']);
    
    global $wpdb;
    $projects_table = $wpdb->prefix . 'designer_projects';
    
    // –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ designer_id, –∞ –Ω–µ user_id
    $project = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $projects_table WHERE project_id = %s AND designer_id = %d",
        $project_id,
        $user_id
    ));
    
    if (!$project) {
        wp_send_json_error('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞–º');
    }
    
    // –ï—Å–ª–∏ —Ö–æ—Ç–∏–º –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
    if ($new_status === 'completed') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        $has_photos = false;
        if (!empty($project->photos)) {
            $existing_photos = json_decode($project->photos, true);
            if (is_array($existing_photos) && count($existing_photos) > 0) {
                $has_photos = true;
            }
        }
        
        // –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ –µ—Å—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        if ($has_photos) {
            $result = $wpdb->update(
                $projects_table,
                [
                    'status'     => $new_status,
                    'updated_at' => current_time('mysql'),
                ],
                [
                    'project_id'   => $project_id,
                    'user_id'  => $user_id,
                ]
            );
            
            if ($result === false) {
                wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞: ' . $wpdb->last_error);
            }
            
            if (class_exists('AR_Project_Cache')) {
                AR_Project_Cache::clear_user_projects_cache($user_id);
            }
            
            wp_send_json_success([
                'message'      => '–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª—ë–Ω',
                'has_photos'   => true,
                'photo_count'  => count($existing_photos),
                'requires_photos' => false,
            ]);
        }
        
        // –§–æ—Ç–æ –Ω–µ—Ç ‚Üí —Ñ—Ä–æ–Ω—Ç—É –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
        wp_send_json_success([
            'message'         => '–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏',
            'requires_photos' => true,
            'project_id'      => $project_id,
            'project_title'   => $project->title,
        ]);
    }
    
    // –õ—é–±–æ–π –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º
    $result = $wpdb->update(
        $projects_table,
        [
            'status'     => $new_status,
            'updated_at' => current_time('mysql'),
        ],
        [
            'project_id'  => $project_id,
            'designer_id' => $user_id,
        ]
    );
    
    if ($result === false) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞: ' . $wpdb->last_error);
    }
    
    if (class_exists('AR_Project_Cache')) {
        AR_Project_Cache::clear_user_projects_cache($user_id);
    }
    
    wp_send_json_success([
        'message'         => '–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª—ë–Ω',
        'requires_photos' => false,
    ]);
}


/**
 * –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ drag&drop –≤ –∫–∞–Ω–±–∞–Ω–µ
 */
add_action('wp_footer', function() {
    ?>
    <script>
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ drop –≤ –∫–∞–Ω–±–∞–Ω–µ
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.ar-project-card');
        const columns = document.querySelectorAll('.ar-projects-list');
        
        let draggedCard = null;
        let originalColumn = null;
        let originalStatus = null;
        
        cards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                draggedCard = this;
                originalColumn = this.parentNode;
                originalStatus = originalColumn.id.replace('ar-projects-', '');
                
                setTimeout(() => {
                    this.classList.add('dragging');
                }, 0);
            });
            
            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedCard = null;
                originalColumn = null;
                originalStatus = null;
            });
        });
        
        columns.forEach(column => {
            column.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.background = 'rgba(102, 126, 234, 0.1)';
            });
            
            column.addEventListener('dragleave', function() {
                this.style.background = '';
            });
            
            column.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.background = '';
                
                if (!draggedCard) return;
                
                const newColumn = this;
                const columnId = newColumn.id;
                const newStatus = columnId.replace('ar-projects-', '');
                const projectId = draggedCard.getAttribute('data-project-id');
                const projectTitle = draggedCard.querySelector('h4').textContent;
                
                console.log('üì¶ Drop event:', {
                    projectId,
                    projectTitle,
                    originalStatus,
                    newStatus
                });
                
                // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫—É "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"
                if (newStatus === 'new') {
                    arShowNotification('–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –≤ –∫–æ–ª–æ–Ω–∫—É "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"', 'error');
                    return;
                }
                
                // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ"
                if (newStatus === 'completed') {
                    console.log('üéØ Moving to completed, showing photo upload modal');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                    if (confirm(`–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç "${projectTitle}"? –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.`)) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
                        arShowPhotoUploadModal(projectId, projectTitle, originalColumn);
                    } else {
                        // –û—Ç–º–µ–Ω–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –æ–±—Ä–∞—Ç–Ω–æ
                        if (originalColumn) {
                            originalColumn.appendChild(draggedCard);
                        }
                    }
                } else {
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É
                    arUpdateProjectStatusDirectly(projectId, newStatus);
                }
            });
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function arShowNotification(message, type = 'info') {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const oldNotifications = document.querySelectorAll('.ar-notification');
        oldNotifications.forEach(notification => notification.remove());
        
        const notification = document.createElement('div');
        notification.className = `ar-notification ar-notification-${type}`;
        notification.innerHTML = `
            <div class="ar-notification-content">
                <span class="ar-notification-message">${message}</span>
                <button class="ar-notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        if (!document.querySelector('#ar-notification-styles')) {
            const styles = document.createElement('style');
            styles.id = 'ar-notification-styles';
            styles.textContent = `
                .ar-notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 99999;
                    min-width: 300px;
                    max-width: 500px;
                    animation: arSlideIn 0.3s ease;
                }
                .ar-notification-success {
                    background: #22c55e;
                    color: white;
                }
                .ar-notification-error {
                    background: #dc3545;
                    color: white;
                }
                .ar-notification-info {
                    background: #3b82f6;
                    color: white;
                }
                .ar-notification-content {
                    padding: 15px 20px;
                    border-radius: 8px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                }
                .ar-notification-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    margin-left: 15px;
                }
                @keyframes arSlideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(styles);
        }
        
        document.body.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    </script>
    <?php
});















/* ========================= –ó–ê–©–ò–¢–ê –°–¢–†–ê–ù–ò–¶–´ /CONT/ –î–õ–Ø –ö–õ–ò–ï–ù–¢–û–í ========================= */

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /cont/
function ar_protect_cont_page() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /cont/
    if (is_page('cont') || strpos($_SERVER['REQUEST_URI'], '/cont/') !== false) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if (is_user_logged_in()) {
            $user = wp_get_current_user();
            
            // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ä–æ–ª—å client - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
            if (in_array('client', (array) $user->roles)) {
                // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É https://art-rocket.ru/zakazdizain/
                wp_redirect('https://art-rocket.ru/zakazdizain/');
                exit;
            }
            // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏ (designer, administrator, editor –∏ —Ç.–¥.) - –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
        }
        // –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–≥–æ—Å—Ç–∏) - –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
        // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Ö
    }
}

// –•—É–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
add_action('template_redirect', 'ar_protect_cont_page');

// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
add_action('wp_ajax_ar_check_page_access', 'ar_check_page_access');
add_action('wp_ajax_nopriv_ar_check_page_access', 'ar_check_page_access');
function ar_check_page_access() {
    $response = array('success' => false, 'access' => true);
    
    if (is_user_logged_in()) {
        $user = wp_get_current_user();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–µ–Ω—Ç–æ–º
        if (in_array('client', (array) $user->roles)) {
            $response['access'] = false;
            $response['role'] = 'client';
            $response['redirect_url'] = 'https://art-rocket.ru/zakazdizain/';
        } else {
            $response['role'] = !empty($user->roles) ? $user->roles[0] : 'none';
        }
        
        $response['success'] = true;
    } else {
        $response['success'] = true;
        $response['role'] = 'guest';
        $response['access'] = true; // –ì–æ—Å—Ç—è–º —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
    }
    
    wp_send_json($response);
}

// JavaScript –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
add_action('wp_footer', 'ar_add_page_protection_js');
function ar_add_page_protection_js() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /cont/
    $current_url = $_SERVER['REQUEST_URI'];
    $is_cont_page = is_page('cont') || strpos($current_url, '/cont/') !== false;
    
    if ($is_cont_page) {
        ?>
        <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
        document.addEventListener('DOMContentLoaded', function() {
            // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
            fetch('<?php echo admin_url('admin-ajax.php'); ?>?action=ar_check_page_access')
                .then(response => response.json())
                .then(data => {
                    if (data.success && !data.access) {
                        // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è client), –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                        window.location.href = data.redirect_url || 'https://art-rocket.ru/zakazdizain/';
                    }
                    // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö (–≤–∫–ª—é—á–∞—è –≥–æ—Å—Ç–µ–π) –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–∞:', error);
                });
        });
        </script>
        <?php
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è CSS —Å—Ç–∏–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
add_action('wp_head', 'ar_add_access_denied_styles');
function ar_add_access_denied_styles() {
    if (isset($_GET['access_denied']) && $_GET['access_denied'] === 'client') {
        ?>
        <style>
        .access-denied-notice {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 99999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .access-denied-notice h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .access-denied-notice p {
            margin: 0;
            font-size: 14px;
        }
        </style>
        <?php
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ
add_action('wp_footer', 'ar_show_access_denied_message');
function ar_show_access_denied_message() {
    if (isset($_GET['access_denied']) && $_GET['access_denied'] === 'client') {
        ?>
        <div class="access-denied-notice">
            <h4>‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h4>
            <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>
        </div>
        <script>
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(function() {
            var notice = document.querySelector('.access-denied-notice');
            if (notice) {
                notice.style.animation = 'slideInRight 0.3s ease reverse';
                notice.style.opacity = '0';
                setTimeout(function() {
                    if (notice.parentNode) {
                        notice.parentNode.removeChild(notice);
                    }
                }, 300);
            }
        }, 5000);
        </script>
        <?php
    }
}

// Shortcode –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
add_shortcode('client_restricted', 'ar_client_restricted_shortcode');
function ar_client_restricted_shortcode($atts, $content = null) {
    // –ê—Ç—Ä–∏–±—É—Ç—ã shortcode
    $atts = shortcode_atts(array(
        'message' => '–≠—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.',
        'redirect' => 'https://art-rocket.ru/zakazdizain/'
    ), $atts);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    if (is_user_logged_in()) {
        $user = wp_get_current_user();
        
        if (in_array('client', (array) $user->roles)) {
            return '<div class="client-restricted-content" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 5px; margin: 20px 0;">
                        <div style="color: #856404;">
                            <h4 style="margin-top: 0;">‚ö†Ô∏è –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h4>
                            <p>' . esc_html($atts['message']) . '</p>
                            <p><a href="' . esc_url($atts['redirect']) . '" style="color: #856404; text-decoration: underline;">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a></p>
                        </div>
                    </div>';
        }
    }
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º
    return do_shortcode($content);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞—â–∏—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç–∞–ø–æ–ª–µ–π
function ar_protect_page_by_meta() {
    global $post;
    
    if (is_page() && $post) {
        $restrict_clients = get_post_meta($post->ID, '_ar_restrict_clients', true);
        
        if ($restrict_clients === '1' && is_user_logged_in()) {
            $user = wp_get_current_user();
            
            if (in_array('client', (array) $user->roles)) {
                // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É https://art-rocket.ru/zakazdizain/
                wp_redirect('https://art-rocket.ru/zakazdizain/');
                exit;
            }
        }
    }
}

// –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞—â–∏—Ç—ã —á–µ—Ä–µ–∑ –º–µ—Ç–∞–ø–æ–ª—è
// add_action('template_redirect', 'ar_protect_page_by_meta');

/* ========================= –ö–û–ù–ï–¶ –ó–ê–©–ò–¢–´ –°–¢–†–ê–ù–ò–¶–´ /CONT/ ========================= */


// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
add_action('wp_footer', 'ar_add_update_auth_buttons_script');
function ar_add_update_auth_buttons_script() {
    ?>
    <script>
    // // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    // function arUpdateAuthButtons() {
    //     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—É–∫–∏ wordpress_logged_in
    //     const cookies = document.cookie.split(';');
    //     let hasCookie = false;
    //     for (let i = 0; i < cookies.length; i++) {
    //         if (cookies[i].trim().startsWith('wordpress_logged_in_')) {
    //             hasCookie = true;
    //             break;
    //         }
    //     }

    //     if (!hasCookie) {
    //         // –ï—Å–ª–∏ –Ω–µ—Ç –∫—É–∫–∏, —Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    //         return;
    //     }

    //     // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    //     fetch('<?php echo admin_url('admin-ajax.php'); ?>?action=ar_check_auth_status')
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.success && data.data.logged_in) {
    //                 const user = data.data;

    //                 // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –∫–Ω–æ–ø–∫—É
    //                 const desktopAuthButton = document.getElementById('desktopAuthButton');
    //                 if (desktopAuthButton) {
    //                     desktopAuthButton.innerHTML = `
    //                         <span style="margin-right: 10px; color: white;">–ü—Ä–∏–≤–µ—Ç, ${user.display_name}</span>
    //                         <a href="${user.logout_url}" class="custom-auth-btn">–í—ã–π—Ç–∏</a>
    //                     `;
    //                 }

    //                 // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
    //                 const mobileAuthButton = document.getElementById('mobileAuthButton');
    //                 if (mobileAuthButton) {
    //                     mobileAuthButton.innerHTML = `
    //                         <div style="text-align: center; padding: 10px 0;">
    //                             <div style="color: white; margin-bottom: 10px; font-size: 14px;">–ü—Ä–∏–≤–µ—Ç, ${user.display_name}</div>
    //                             <a href="${user.logout_url}" class="custom-auth-btn">–í—ã–π—Ç–∏</a>
    //                         </div>
    //                     `;
    //                 }
    //             }
    //         })
    //         .catch(error => {
    //             console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    //         });
    // }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        arUpdateAuthButtons();
    });
    </script>
    <?php
}

// –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –≤—ã—Ö–æ–¥–∞
add_filter('logout_url', 'ar_fix_logout_url', 9999, 2);
function ar_fix_logout_url($logout_url, $redirect) {
    // –í—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º redirect –Ω–∞ zakazdizain
    $redirect = 'https://art-rocket.ru/zakazdizain/';
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É —Å nonce
    $args = array(
        'action' => 'logout',
        'redirect_to' => urlencode($redirect),
        '_wpnonce' => wp_create_nonce('log-out')
    );
    
    $logout_url = add_query_arg($args, site_url('wp-login.php', 'login'));
    
    return $logout_url;
}

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π redirect –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞
add_action('wp_logout', 'ar_force_logout_redirect', 9999);
function ar_force_logout_redirect() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω redirect
    if (!headers_sent()) {
        wp_safe_redirect('https://art-rocket.ru/zakazdizain/');
        exit;
    }
    
    // Fallback –¥–ª—è JavaScript
    echo '<script>window.location.href = "https://art-rocket.ru/zakazdizain/";</script>';
    exit;
}

/* ========= ORDER SYSTEM START ========= */

/* ========= ORDER SYSTEM START ========= */

/* ========= ORDER SYSTEM START ========= */

/* ========= CUSTOM AUTH + ORDER SYSTEM START ========= */

/* ========================= –ù–ê–°–¢–†–û–ô–ö–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ========================= */
add_action('admin_init', 'ar_auth_settings_init');
function ar_auth_settings_init() {
    register_setting('ar_auth', 'ar_auth_options');
    
    add_settings_section(
        'ar_auth_section',
        '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤',
        'ar_auth_section_callback',
        'ar_auth'
    );

    add_settings_field(
        'ar_require_phone_verification',
        '–¢—Ä–µ–±–æ–≤–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
        'ar_require_phone_verification_callback',
        'ar_auth',
        'ar_auth_section'
    );

    add_settings_field(
        'ar_require_email_verification',
        '–¢—Ä–µ–±–æ–≤–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é email',
        'ar_require_email_verification_callback',
        'ar_auth',
        'ar_auth_section'
    );
}

function ar_auth_section_callback() {
    echo '<p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>';
}

function ar_require_phone_verification_callback() {
    $options = get_option('ar_auth_options');
    $checked = isset($options['require_phone_verification']) ? $options['require_phone_verification'] : false;
    echo '<input type="checkbox" name="ar_auth_options[require_phone_verification]" value="1" ' . checked(1, $checked, false) . ' />';
    echo '<p class="description">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –∫–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—É–¥—É—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ SMS</p>';
}

function ar_require_email_verification_callback() {
    $options = get_option('ar_auth_options');
    $checked = isset($options['require_email_verification']) ? $options['require_email_verification'] : false;
    echo '<input type="checkbox" name="ar_auth_options[require_email_verification]" value="1" ' . checked(1, $checked, false) . ' />';
    echo '<p class="description">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –∫–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—É–¥—É—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É</p>';
}

add_action('admin_menu', 'ar_auth_add_admin_menu');
function ar_auth_add_admin_menu() {
    add_options_page(
        '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
        '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤',
        'manage_options',
        'ar_auth',
        'ar_auth_options_page'
    );
}

function ar_auth_options_page() {
    ?>
    <div class="wrap">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h1>
        <form action="options.php" method="post">
            <?php
            settings_fields('ar_auth');
            do_settings_sections('ar_auth');
            submit_button();
            ?>
        </form>
    </div>
    <?php
}

/* ========================= –§–£–ù–ö–¶–ò–û–ù–ê–õ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ========================= */

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è HTML —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è HTML —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function ar_get_auth_form_html($action = 'login', $redirect_url = '') {
    if (empty($redirect_url)) {
        $redirect_url = home_url($_SERVER['REQUEST_URI']);
    }
    
    ob_start();
    ?>
    <div class="ar-auth-modal" id="arAuthModal">
        <div class="ar-auth-modal-overlay" onclick="arCloseAuthModal()"></div>
        <div class="ar-auth-modal-content">
            <button class="ar-auth-modal-close" onclick="arCloseAuthModal()">&times;</button>
            
            <div class="auth-container">
                <div class="auth-header">
                    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
                    <p>–ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ –¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ —É –ª—É—á—à–∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤</p>
                </div>
                
                <div class="auth-tabs <?php echo $action === 'login' ? 'login-active' : 'register-active'; ?>">
                    <button type="button" class="auth-tab <?php echo $action === 'login' ? 'active' : ''; ?>" onclick="arSwitchTab('login')">
                        –í—Ö–æ–¥
                    </button>
                    <button type="button" class="auth-tab <?php echo $action === 'register' ? 'active' : ''; ?>" onclick="arSwitchTab('register')">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </button>
                </div>
                
                <div class="auth-content">
                    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
                    <form id="loginForm" class="auth-form <?php echo $action === 'login' ? 'active' : ''; ?>" onsubmit="return arProcessLogin(event)">
                        <div class="error-message" id="loginError"></div>
                        <div class="success-message" id="loginSuccess"></div>
                        
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" class="form-control" required placeholder="–≤–∞—à@email.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                            <div class="password-wrapper">
                                <input type="password" id="loginPassword" class="form-control" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                                <button type="button" class="password-toggle" onclick="arTogglePassword('loginPassword')">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="loginBtn">
                            –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
                        </button>
                        
                        <div class="auth-footer">
                            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="arSwitchTab('register'); return false;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>
                        </div>
                    </form>
                    
                    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                    <form id="registerForm" class="auth-form <?php echo $action === 'register' ? 'active' : ''; ?>" onsubmit="return arProcessRegistration(event)">
                        <div class="error-message" id="registerError"></div>
                        <div class="success-message" id="registerSuccess"></div>
                        
                        <div class="form-group form-row">
                            <div>
                                <label for="firstName">–ò–º—è *</label>
                                <input type="text" id="firstName" class="form-control" required placeholder="–ò–≤–∞–Ω">
                            </div>
                            <div>
                                <label for="lastName">–§–∞–º–∏–ª–∏—è *</label>
                                <input type="text" id="lastName" class="form-control" required placeholder="–ò–≤–∞–Ω–æ–≤">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerEmail">Email *</label>
                            <input type="email" id="registerEmail" class="form-control" required placeholder="–≤–∞—à@email.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                            <div class="phone-input-group">
                                <select id="phoneCode" class="form-control phone-code">
                                    <option value="+373">üá≤üá© +373 (–ú–æ–ª–¥–æ–≤–∞)</option>
                                    <option value="+40">üá∑üá¥ +40 (–†—É–º—ã–Ω–∏—è)</option>
                                    <option value="+7">üá∑üá∫ +7 (–†–æ—Å—Å–∏—è)</option>
                                    <option value="+380">üá∫üá¶ +380 (–£–∫—Ä–∞–∏–Ω–∞)</option>
                                    <option value="+1">üá∫üá∏ +1 (–°–®–ê)</option>
                                </select>
                                <input type="tel" id="phone" class="form-control phone-number" required placeholder="123 456 789">
                            </div>
                        </div>
                        
                        <div class="form-group form-row">
                            <div>
                                <label for="country">–°—Ç—Ä–∞–Ω–∞ *</label>
                                <select id="country" class="form-control" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>
                                    <option value="romania">–†—É–º—ã–Ω–∏—è</option>
                                    <option value="moldova">–ú–æ–ª–¥–æ–≤–∞</option>
                                    <option value="russia">–†–æ—Å—Å–∏—è</option>
                                    <option value="ukraine">–£–∫—Ä–∞–∏–Ω–∞</option>
                                    <option value="other">–î—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞</option>
                                </select>
                            </div>
                            <div>
                                <label for="city">–ì–æ—Ä–æ–¥ *</label>
                                <select id="city" class="form-control" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                    <option value="bucuresti">–ë—É—Ö–∞—Ä–µ—Å—Ç</option>
                                    <option value="chisinau">–ö–∏—à–∏–Ω–µ–≤</option>
                                    <option value="cluj">–ö–ª—É–∂-–ù–∞–ø–æ–∫–∞</option>
                                    <option value="timisoara">–¢–∏–º–∏—à–æ–∞—Ä–∞</option>
                                    <option value="other">–î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerPassword">–ü–∞—Ä–æ–ª—å *</label>
                            <div class="password-wrapper">
                                <input type="password" id="registerPassword" class="form-control" required 
                                       placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤" minlength="8">
                                <button type="button" class="password-toggle" onclick="arTogglePassword('registerPassword')">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                            <div class="password-hint">
                                –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label>
                            <div class="password-wrapper">
                                <input type="password" id="confirmPassword" class="form-control" required 
                                       placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                                <button type="button" class="password-toggle" onclick="arTogglePassword('confirmPassword')">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="ar-checkbox-label">
                                <input type="checkbox" id="agreeTerms" required>
                                <span>
                                    –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <a href="/terms-and-conditions" target="_blank">—É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a> 
                                    –∏ <a href="/privacy-policy" target="_blank">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                                </span>
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="registerBtn">
                            –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                        </button>
                        
                        <div class="auth-footer">
                            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="arSwitchTab('login'); return false;">–í–æ–π–¥–∏—Ç–µ</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <?php
    return ob_get_clean();
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
add_action('wp_footer', 'ar_add_auth_modal_assets');
function ar_add_auth_modal_assets() {
    // –£–ë–ò–†–ê–ï–ú –£–°–õ–û–í–ò–ï, —á—Ç–æ–±—ã –º–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
    ?>
    <style>
       /* ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===== */

/* ===== –ú–ò–ù–ò–ú–ê–õ–ò–°–¢–ò–ß–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–ö–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===== */

/* –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
:root {
    --primary-color: #667eea;
    --primary-light: #a5b4fc;
    --primary-dark: #5a6fd8;
    --secondary-color: #764ba2;
    --success-color: #10b981;
    --error-color: #ef4444;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-light: #9ca3af;
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9ff;
    --bg-overlay: rgba(0, 0, 0, 0.7);
    --border-color: #e5e7eb;
    --border-light: #f1f5f9;
    --radius: 18px;
    --transition: 200ms ease;
}








/* ===== –ö–†–ê–°–ò–í–´–ô –ö–ê–°–¢–û–ú–ù–´–ô –°–ö–†–û–õ–õ–ë–ê–† ===== */

/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
.ar-auth-modal-content {
    scrollbar-width: thin !important;
    scrollbar-color: #ff9800 transparent !important;
    scroll-behavior: smooth !important;
}

/* –î–ª—è WebKit –±—Ä–∞—É–∑–µ—Ä–æ–≤ (Chrome, Safari, Edge) */
.ar-auth-modal-content::-webkit-scrollbar {
    width: 8px !important;
    height: 8px !important;
    background: transparent !important;
}

.ar-auth-modal-content::-webkit-scrollbar-track {
    background: rgba(255, 152, 0, 0.05) !important;
    border-radius: 10px !important;
    margin: 4px 0 !important;
}

.ar-auth-modal-content::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #ff9800, #ff6d00) !important;
    border-radius: 10px !important;
    border: 2px solid transparent !important;
    background-clip: content-box !important;
    min-height: 40px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.ar-auth-modal-content::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #e68900, #ff5722) !important;
    background-clip: content-box !important;
    border: 2px solid transparent !important;
}

.ar-auth-modal-content::-webkit-scrollbar-thumb:active {
    background: linear-gradient(135deg, #cc7a00, #e65100) !important;
    background-clip: content-box !important;
}

.ar-auth-modal-content::-webkit-scrollbar-corner {
    background: transparent !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.ar-auth-modal-content::-webkit-scrollbar-thumb {
    opacity: 0.7 !important;
}

.ar-auth-modal-content:hover::-webkit-scrollbar-thumb {
    opacity: 1 !important;
}

/* –î–ª—è Firefox */
.ar-auth-modal-content {
    scrollbar-width: thin !important;
    scrollbar-color: #ff9800 transparent !important;
}

/* –î–ª—è Internet Explorer */
.ar-auth-modal-content {
    -ms-overflow-style: -ms-autohiding-scrollbar !important;
}

/* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
.ar-auth-modal-content {
    scroll-behavior: smooth !important;
    -webkit-overflow-scrolling: touch !important;
}

/* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä —É body –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –º–æ–¥–∞–ª–∫–µ */
body.ar-modal-open {
    overflow: hidden !important;
    padding-right: 0 !important;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX */
.ar-auth-modal-content {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    will-change: transform !important;
    backface-visibility: hidden !important;
    -webkit-font-smoothing: subpixel-antialiased !important;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ —Å–∫—Ä–æ–ª–ª–∞ */
.ar-auth-modal-content::before,
.ar-auth-modal-content::after {
    content: '' !important;
    position: absolute !important;
    left: 0 !important;
    right: 0 !important;
    height: 20px !important;
    pointer-events: none !important;
    z-index: 1 !important;
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
}

.ar-auth-modal-content::before {
    top: 0 !important;
    background: linear-gradient(to bottom, var(--bg-primary) 0%, transparent 100%) !important;
}

.ar-auth-modal-content::after {
    bottom: 0 !important;
    background: linear-gradient(to top, var(--bg-primary) 0%, transparent 100%) !important;
}

.ar-auth-modal-content.scroll-top::before,
.ar-auth-modal-content.scroll-bottom::after {
    opacity: 1 !important;
}

/* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
.ar-auth-modal-content::-webkit-scrollbar-thumb {
    min-height: 50px !important;
}

/* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ –¥–µ–ª–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä —Ç–æ–Ω—å—à–µ */
@media (max-width: 480px) {
    .ar-auth-modal-content::-webkit-scrollbar {
        width: 6px !important;
    }
    
    .ar-auth-modal-content::-webkit-scrollbar-thumb {
        min-height: 30px !important;
    }
}

/* –î–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è) */
@media (prefers-color-scheme: dark) {
    .ar-auth-modal-content::-webkit-scrollbar-track {
        background: rgba(255, 152, 0, 0.1) !important;
    }
    
    .ar-auth-modal-content::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #ff9800, #ff8a00) !important;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
@keyframes scrollbarPulse {
    0% { opacity: 0.7; }
    50% { opacity: 1; }
    100% { opacity: 0.7; }
}

.ar-auth-modal-content.scrolling::-webkit-scrollbar-thumb {
    animation: scrollbarPulse 2s infinite !important;
}











/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.ar-auth-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 999999;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition), visibility var(--transition);

    background: var(--bg-overlay);
}

.ar-auth-modal.active {
    display: flex;
    opacity: 1;
    visibility: visible;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–¥–∞–ª–∫–∏ */
.ar-auth-modal-content {
    position: relative;
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    margin: 0 auto;
    background: var(--bg-primary);
    border-radius: var(--radius);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
}

/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
.ar-auth-modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: all var(--transition);
    padding: 0;
    line-height: 1;
}

.ar-auth-modal-close:hover {
    background: #f8fafc;
    border-color: var(--primary-color);
    color: var(--primary-color);
}

/* –®–∞–ø–∫–∞ */
.auth-header {
    background: var(--primary-color);
    color: white;
    padding: 32px 24px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.auth-header h1 {
    font-size: 22px;
    font-weight: 600;
    margin: 0 0 8px 0;
    line-height: 1.3;
}

.auth-header p {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.9;
    margin: 0;
    line-height: 1.5;
}

/* –í–∫–ª–∞–¥–∫–∏ - –ü–†–Ø–ú–û–£–ì–û–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò –≤ —Å—Ç–∏–ª–µ WooCommerce */
.auth-tabs {
    display: flex !important;
    border-bottom: 1px solid var(--border-color) !important;
    background: var(--bg-primary) !important;
}

.auth-tab {
    flex: 1 !important;
    padding: 16px !important;
    text-align: center !important;
    cursor: pointer !important;
    font-weight: 600 !important;
    font-size: 14px !important;
    color: #fff !important;
    transition: background 0.3s ease, transform 0.2s ease !important;
    background: #ff9800 !important;
    border: none !important;
    border-radius: 0 !important;
    position: relative !important;
    border-right: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.auth-tab:last-child {
    border-right: none !important;
}

.auth-tab:hover {
    background: #e68900 !important;
    transform: translateY(-1px) !important;
}

.auth-tab.active {
    background: #cc7a00 !important;
    position: relative !important;
}

/* –ö–æ–Ω—Ç–µ–Ω—Ç —Ñ–æ—Ä–º */
.auth-content {
    padding: 32px !important;
    background: var(--bg-primary) !important;
}

/* –§–æ—Ä–º—ã */
.auth-form {
    display: none !important;
}

.auth-form.active {
    display: block !important;
}

/* –ì—Ä—É–ø–ø—ã –ø–æ–ª–µ–π */
.form-group {
    margin-bottom: 20px !important;
}

.form-group label {
    display: block !important;
    margin-bottom: 8px !important;
    font-weight: 500 !important;
    font-size: 13px !important;
    color: var(--text-primary) !important;
}

/* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
.form-control {
    width: 100% !important;
    padding: 12px 16px !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 4px !important;
    font-size: 14px !important;
    transition: all var(--transition) !important;
    background: var(--bg-primary) !important;
    color: var(--text-primary) !important;
    font-family: inherit !important;
    box-sizing: border-box !important;
}

.form-control:focus {
    outline: none !important;
    border-color: #ff9800 !important;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1) !important;
}

.form-control::placeholder {
    color: var(--text-light) !important;
}

/* –°—Ç—Ä–æ–∫–∞ —Å –¥–≤—É–º—è –ø–æ–ª—è–º–∏ */
.form-row {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 16px !important;
}

/* –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
.btn {
    width: 100% !important;
    padding: 14px !important;
    border: 1px solid transparent !important;
    border-radius: 4px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all var(--transition) !important;
    font-family: inherit !important;
    text-align: center !important;
    box-sizing: border-box !important;
}

.btn-primary {
    background: #ff9800 !important;
    color: white !important;
    border-color: #ff9800 !important;
}

.btn-primary:hover {
    background: #e68900 !important;
    border-color: #e68900 !important;
    transform: translateY(-1px) !important;
}

.btn:disabled {
    opacity: 0.6 !important;
    cursor: not-allowed !important;
}

/* –§—É—Ç–µ—Ä —Ñ–æ—Ä–º—ã */
.auth-footer {
    text-align: center !important;
    margin-top: 24px !important;
    padding-top: 16px !important;
    border-top: 1px solid var(--border-light) !important;
    font-size: 13px !important;
    color: var(--text-secondary) !important;
}

.auth-footer a {
    color: #ff9800 !important;
    text-decoration: none !important;
    font-weight: 500 !important;
}

.auth-footer a:hover {
    text-decoration: underline !important;
}

/* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö/—É—Å–ø–µ—Ö–µ */
.error-message {
    background: #fee;
    color: var(--error-color);
    padding: 12px 16px;
    border-radius: 4px;
    margin-bottom: 16px;
    font-size: 13px;
    font-weight: 500;
    border: 1px solid #fcc;
    display: none;
}

.success-message {
    background: #f0fdf4;
    color: #166534;
    padding: 12px 16px;
    border-radius: 4px;
    margin-bottom: 16px;
    font-size: 13px;
    font-weight: 500;
    border: 1px solid #bbf7d0;
    display: none;
}

/* –ì—Ä—É–ø–ø–∞ –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
.phone-input-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.phone-code {
    flex: 0 0 100px;
    min-width: 0;
}

.phone-number {
    flex: 1;
    min-width: 0;
}

/* –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–∞—Ä–æ–ª—è */
.password-wrapper {
    position: relative;
}

.password-toggle {
    position: absolute !important;
    right: 12px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: none !important;
    border: none !important;
    color: var(--text-light) !important;
    cursor: pointer !important;
    font-size: 16px !important;
    padding: 4px !important;
    transition: color var(--transition) !important;
    line-height: 1 !important;
}

.password-toggle:hover {
    color: var(--text-secondary) !important;
}

/* –ß–µ–∫–±–æ–∫—Å —Å–æ–≥–ª–∞—Å–∏—è */
.ar-checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 20px;
    user-select: none;
}

.ar-checkbox-label input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    background: var(--bg-primary);
    cursor: pointer;
    position: relative;
    transition: all var(--transition);
    flex-shrink: 0;
    margin-top: 2px;
}

.ar-checkbox-label input[type="checkbox"]:checked {
    background: #ff9800;
    border-color: #ff9800;
}

.ar-checkbox-label input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    color: white;
    font-size: 12px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.ar-checkbox-label a {
    color: #ff9800;
    text-decoration: none;
    font-weight: 500;
}

.ar-checkbox-label a:hover {
    text-decoration: underline;
}

/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø–∞—Ä–æ–ª—è */
.password-hint {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 6px;
    display: block;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 18px;
    height: 18px;
    margin: -9px 0 0 -9px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: button-spinner 0.8s linear infinite;
}

@keyframes button-spinner {
    to {
        transform: rotate(360deg);
    }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 480px) {
   
    
    .ar-auth-modal-content {
        max-width: 90%;
    }
    
    .auth-header {
        padding: 24px 20px;
    }
    
    .auth-header h1 {
        font-size: 20px;
    }
    
    .auth-content {
        padding: 24px;
    }
    
    .auth-tab {
        padding: 14px;
        font-size: 13px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .phone-input-group {
        flex-direction: column;
        gap: 12px;
    }
    
    .phone-code,
    .phone-number {
        width: 100%;
    }
}

@media (max-width: 360px) {
    .auth-content {
        padding: 20px;
    }
    
    .auth-header {
        padding: 20px;
    }
    
    .auth-tab {
        padding: 12px 10px;
        font-size: 12px;
    }
    
    .form-control {
        padding: 10px 14px;
        font-size: 13px;
    }
    
    .btn {
        padding: 12px;
        font-size: 13px;
    }
}

/* –î–ª—è touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (hover: none) and (pointer: coarse) {
    .auth-tab:hover {
        transform: none;
    }
    
    .auth-tab.active:hover {
        transform: none;
    }
    
    .btn-primary:hover {
        transform: none;
    }
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
.ar-auth-modal-content::-webkit-scrollbar {
    width: 4px;
}

.ar-auth-modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.ar-auth-modal-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

.ar-auth-modal-content::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}


        /* –°—Ç–∏–ª–∏ —Ñ–æ—Ä–º—ã (—É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ ar_show_auth_modal) */
        </style>
        
        
        
        
        
        
         <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
    var arAuthModal = null;
    var arCurrentRedirect = '';
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function arOpenAuthModal(action = 'login', redirect = '') {
        if (redirect) {
            arCurrentRedirect = redirect;
        } else {
            arCurrentRedirect = window.location.href;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.getElementById('arAuthModal');
        if (!modal) {
            console.error('Auth modal not found');
            return;
        }
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        if (action === 'register' || action === 'login') {
            arSwitchTab(action);
        }
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
        setTimeout(() => {
            const activeForm = modal.querySelector('.auth-form.active');
            if (activeForm) {
                const firstInput = activeForm.querySelector('input:not([type="hidden"]), select');
                if (firstInput) firstInput.focus();
            }
        }, 100);
    }
    
    function arCloseAuthModal() {
        if (arAuthModal) {
            arAuthModal.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    function arSwitchTab(tabName) {
        const modal = document.getElementById('arAuthModal');
        if (!modal) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤–∫–ª–∞–¥–æ–∫
        const tabsContainer = modal.querySelector('.auth-tabs');
        if (tabsContainer) {
            tabsContainer.classList.remove('login-active', 'register-active');
            tabsContainer.classList.add(tabName === 'login' ? 'login-active' : 'register-active');
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
        modal.querySelectorAll('.auth-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        modal.querySelectorAll('.auth-form').forEach(form => {
            form.classList.remove('active');
        });
        
        const activeTab = modal.querySelector(`.auth-tab[onclick*="${tabName}"]`);
        const activeForm = document.getElementById(tabName + 'Form');
        
        if (activeTab) activeTab.classList.add('active');
        if (activeForm) {
            activeForm.classList.add('active');
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
            setTimeout(() => {
                const firstInput = activeForm.querySelector('input:not([type="hidden"]), select');
                if (firstInput) firstInput.focus();
            }, 10);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª—è
    function arTogglePassword(inputId) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        const toggle = input.parentElement.querySelector('.password-toggle');
        if (!toggle) return;
        
        const eyeIcon = toggle.querySelector('.eye-icon');
        if (!eyeIcon) return;
        
        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.textContent = 'üôà';
        } else {
            input.type = 'password';
            eyeIcon.textContent = 'üëÅÔ∏è';
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
    function arShowError(formId, message) {
        const modal = document.getElementById('arAuthModal');
        if (!modal) return;
        
        const errorDiv = document.getElementById(formId + 'Error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            const successDiv = document.getElementById(formId + 'Success');
            if (successDiv) successDiv.style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—Ö–∞
    function arShowSuccess(formId, message) {
        const modal = document.getElementById('arAuthModal');
        if (!modal) return;
        
        const successDiv = document.getElementById(formId + 'Success');
        if (successDiv) {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            const errorDiv = document.getElementById(formId + 'Error');
            if (errorDiv) errorDiv.style.display = 'none';
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    async function arProcessRegistration(event) {
        event.preventDefault();
        
        const modal = document.getElementById('arAuthModal');
        if (!modal) return false;
        
        const btn = document.getElementById('registerBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º...';
        btn.disabled = true;
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = {
            action: 'ar_process_registration',
            first_name: document.getElementById('firstName').value.trim(),
            last_name: document.getElementById('lastName').value.trim(),
            email: document.getElementById('registerEmail').value.trim(),
            phone_code: document.getElementById('phoneCode').value,
            phone: document.getElementById('phone').value.trim(),
            country: document.getElementById('country').value,
            city: document.getElementById('city').value,
            password: document.getElementById('registerPassword').value,
            confirm_password: document.getElementById('confirmPassword').value,
            agree_terms: document.getElementById('agreeTerms').checked,
            redirect: arCurrentRedirect
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        if (!formData.first_name || !formData.last_name) {
            arShowError('register', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
            arShowError('register', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        const phoneDigits = formData.phone.replace(/\D/g, '');
        if (phoneDigits.length < 9) {
            arShowError('register', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        if (!formData.country || !formData.city) {
            arShowError('register', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏ –≥–æ—Ä–æ–¥');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        if (formData.password.length < 8) {
            arShowError('register', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        if (formData.password !== formData.confirm_password) {
            arShowError('register', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        if (!formData.agree_terms) {
            arShowError('register', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        try {
            const response = await fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Server returned non-JSON:', text.substring(0, 200));
                throw new Error('Server returned non-JSON response');
            }
            
            const result = await response.json();
            
            if (result.success) {
                arShowSuccess('register', result.data.message || '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                if (typeof arUpdateAuthButtons === 'function') {
                    arUpdateAuthButtons();
                }
                
                if (result.data.requires_email_verification) {
                    arShowSuccess('register', '–ù–∞ –≤–∞—à email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.');
                    setTimeout(() => {
                        arCloseAuthModal();
                        if (result.data.redirect_url) {
                            window.location.reload();
                        }
                    }, 3000);
                } else {
                    setTimeout(() => {
                        arCloseAuthModal();
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                        window.location.reload();
                    }, 1500);
                }
            } else {
                arShowError('register', result.data || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        } catch (error) {
            if (error.message === 'Server returned non-JSON response') {
                arShowError('register', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
            } else {
                arShowError('register', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
            console.error('Registration error:', error);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        return false;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥–∞
    async function arProcessLogin(event) {
        event.preventDefault();
        
        const modal = document.getElementById('arAuthModal');
        if (!modal) return false;
        
        const btn = document.getElementById('loginBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ –í—Ö–æ–¥–∏–º...';
        btn.disabled = true;
        
        const formData = {
            action: 'ar_process_login',
            email: document.getElementById('loginEmail').value.trim(),
            password: document.getElementById('loginPassword').value,
            redirect: arCurrentRedirect
        };
        
        if (!formData.email || !formData.password) {
            arShowError('login', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            btn.innerHTML = originalText;
            btn.disabled = false;
            return false;
        }
        
        try {
            const response = await fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Server returned non-JSON:', text.substring(0, 200));
                throw new Error('Server returned non-JSON response');
            }
            
            const result = await response.json();
            
            if (result.success) {
                arShowSuccess('login', '–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
                if (typeof arUpdateAuthButtons === 'function') {
                    arUpdateAuthButtons();
                }
                
                setTimeout(() => {
                    arCloseAuthModal();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                    window.location.reload();
                }, 1000);
            } else {
                arShowError('login', result.data || '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        } catch (error) {
            if (error.message === 'Server returned non-JSON response') {
                arShowError('login', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
            } else {
                arShowError('login', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
            console.error('Login error:', error);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        return false;
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Esc
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            arCloseAuthModal();
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('ar-auth-modal-overlay')) {
            arCloseAuthModal();
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –î–æ–±–∞–≤–ª—è–µ–º HTML –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤ body
        const authModalHTML = `<?php echo str_replace(["\n", "\r"], '', ar_get_auth_form_html('login')); ?>`;
        document.body.insertAdjacentHTML('beforeend', authModalHTML);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        arAuthModal = document.getElementById('arAuthModal');
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä restore_form –≤ URL, –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('restore_form')) {
            setTimeout(() => {
                arOpenAuthModal('login');
            }, 500);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (typeof arUpdateAuthButtons === 'function') {
            arUpdateAuthButtons();
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function arUpdateAuthButtons() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—É–∫–∏ wordpress_logged_in
        const cookies = document.cookie.split(';');
        let hasCookie = false;
        for (let i = 0; i < cookies.length; i++) {
            if (cookies[i].trim().startsWith('wordpress_logged_in_')) {
                hasCookie = true;
                break;
            }
        }

        if (!hasCookie) {
            // –ï—Å–ª–∏ –Ω–µ—Ç –∫—É–∫–∏, —Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
            return;
        }

        // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        fetch('<?php echo admin_url('admin-ajax.php'); ?>?action=ar_check_auth_status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.logged_in) {
                    const user = data.data;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –∫–Ω–æ–ø–∫—É
                    const desktopAuthButton = document.getElementById('desktopAuthButton');
                    if (desktopAuthButton) {
                        desktopAuthButton.innerHTML = `
                            <span style="margin-right: 10px; color: white;">–ü—Ä–∏–≤–µ—Ç, ${user.display_name}</span>
                            <a href="${user.logout_url}" class="custom-auth-btn">–í—ã–π—Ç–∏</a>
                        `;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
                    const mobileAuthButton = document.getElementById('mobileAuthButton');
                    if (mobileAuthButton) {
                        mobileAuthButton.innerHTML = `
                            <div style="text-align: center; padding: 10px 0;">
                                <div style="color: white; margin-bottom: 10px; font-size: 14px;">–ü—Ä–∏–≤–µ—Ç, ${user.display_name}</div>
                                <a href="${user.logout_url}" class="custom-auth-btn">–í—ã–π—Ç–∏</a>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            });
    }
    </script>
    <?php
}

// –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é ar_add_global_js, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –≤—Å–µ –≤ ar_add_auth_modal_assets
remove_action('wp_footer', 'ar_add_global_js');

// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ar_show_auth_modal –∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –Ω–æ–≤—ã–π
remove_action('wp_ajax_ar_show_auth_modal', 'ar_show_auth_modal');
remove_action('wp_ajax_nopriv_ar_show_auth_modal', 'ar_show_auth_modal');

// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
add_action('wp_ajax_ar_process_registration', 'ar_process_registration');
add_action('wp_ajax_nopriv_ar_process_registration', 'ar_process_registration');
function ar_process_registration() {
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –±—É—Ñ–µ—Ä—ã –≤—ã–≤–æ–¥–∞
    while (ob_get_level()) {
        ob_end_clean();
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º nonce –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    $nonce = isset($_POST['_wpnonce']) ? sanitize_text_field($_POST['_wpnonce']) : '';
    if (!wp_verify_nonce($nonce, 'ar_registration_nonce')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        wp_die();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    $first_name = sanitize_text_field($_POST['first_name'] ?? '');
    $last_name = sanitize_text_field($_POST['last_name'] ?? '');
    $email = sanitize_email($_POST['email'] ?? '');
    $phone_code = sanitize_text_field($_POST['phone_code'] ?? '');
    $phone = sanitize_text_field($_POST['phone'] ?? '');
    $country = sanitize_text_field($_POST['country'] ?? '');
    $city = sanitize_text_field($_POST['city'] ?? '');
    $password = $_POST['password'] ?? '';
    $confirm_password = $_POST['confirm_password'] ?? '';
    $agree_terms = isset($_POST['agree_terms']) && ($_POST['agree_terms'] === 'true' || $_POST['agree_terms'] === true);
    $redirect = isset($_POST['redirect']) ? esc_url_raw(urldecode($_POST['redirect'])) : home_url('/zakazdizain');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    $errors = [];
    
    if (empty($first_name) || empty($last_name)) {
        $errors[] = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é';
    }
    
    if (!is_email($email)) {
        $errors[] = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
    }
    
    if (email_exists($email)) {
        $errors[] = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    $phone_digits = preg_replace('/\D/', '', $phone);
    if (strlen($phone_digits) < 9) {
        $errors[] = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    $phone_full = $phone_code . $phone_digits;
    if (ar_phone_exists($phone_full)) {
        $errors[] = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
    }
    
    if (empty($country) || empty($city)) {
        $errors[] = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏ –≥–æ—Ä–æ–¥';
    }
    
    if (strlen($password) < 8) {
        $errors[] = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤';
    }
    
    if ($password !== $confirm_password) {
        $errors[] = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
    }
    
    if (!$agree_terms) {
        $errors[] = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è';
    }
    
    if (!empty($errors)) {
        wp_send_json_error(implode('<br>', $errors));
        wp_die();
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $username = ar_generate_username_from_email($email);
    $user_data = [
        'user_login' => $username,
        'user_email' => $email,
        'user_pass' => $password,
        'first_name' => $first_name,
        'last_name' => $last_name,
        'display_name' => $first_name . ' ' . $last_name,
        'role' => 'client'
    ];
    
    $user_id = wp_insert_user($user_data);
    
    if (is_wp_error($user_id)) {
        wp_send_json_error($user_id->get_error_message());
        wp_die();
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    update_user_meta($user_id, 'phone_code', $phone_code);
    update_user_meta($user_id, 'phone_number', $phone);
    update_user_meta($user_id, 'phone_full', $phone_full);
    update_user_meta($user_id, 'country', $country);
    update_user_meta($user_id, 'city', $city);
    update_user_meta($user_id, 'registration_date', current_time('mysql'));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    $options = get_option('ar_auth_options');
    $requires_email_verification = isset($options['require_email_verification']) ? $options['require_email_verification'] : false;
    
    if ($requires_email_verification) {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        $verification_code = wp_rand(100000, 999999);
        update_user_meta($user_id, 'email_verification_code', $verification_code);
        update_user_meta($user_id, 'email_verified', false);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email —Å –∫–æ–¥–æ–º
        ar_send_verification_email($email, $verification_code, $first_name);
        
        // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        wp_set_current_user($user_id);
        wp_set_auth_cookie($user_id, true);
        
        $response = [
            'message' => '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ù–∞ –≤–∞—à email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
            'requires_email_verification' => true,
            'redirect_url' => add_query_arg('verify_email', '1', home_url('/my-account'))
        ];
        
        wp_send_json_success($response);
        wp_die();
    }
    
    // –ï—Å–ª–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Å—Ä–∞–∑—É –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º
    update_user_meta($user_id, 'email_verified', true);
    
    wp_set_current_user($user_id);
    wp_set_auth_cookie($user_id, true);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞
    $saved_form_data = get_user_meta($user_id, 'ar_pending_order_data', true);
    if (!empty($saved_form_data)) {
        delete_user_meta($user_id, 'ar_pending_order_data');
        $redirect = add_query_arg('restore_form', '1', $redirect);
    }
    
    $response = [
        'message' => '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!',
        'redirect_url' => $redirect
    ];
    
    wp_send_json_success($response);
    wp_die();
}

// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞
add_action('wp_ajax_ar_process_login', 'ar_process_login');
add_action('wp_ajax_nopriv_ar_process_login', 'ar_process_login');
function ar_process_login() {
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –±—É—Ñ–µ—Ä—ã –≤—ã–≤–æ–¥–∞
    while (ob_get_level()) {
        ob_end_clean();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    $email = sanitize_email($_POST['email'] ?? '');
    $password = $_POST['password'] ?? '';
    $redirect = isset($_POST['redirect']) ? esc_url_raw(urldecode($_POST['redirect'])) : home_url('/zakazdizain');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (empty($email) || empty($password)) {
        wp_send_json_error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        wp_die();
    }
    
    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
    $user = get_user_by('email', $email);
    
    if (!$user) {
        $user = get_user_by('login', $email);
    }
    
    if (!$user) {
        wp_send_json_error('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
        wp_die();
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    if (!wp_check_password($password, $user->user_pass, $user->ID)) {
        wp_send_json_error('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
        wp_die();
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ª–∏ email (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
    $options = get_option('ar_auth_options');
    $requires_email_verification = isset($options['require_email_verification']) ? $options['require_email_verification'] : false;
    
    if ($requires_email_verification) {
        $email_verified = get_user_meta($user->ID, 'email_verified', true);
        if (!$email_verified) {
            wp_send_json_error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.');
            wp_die();
        }
    }
    
    // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    wp_set_current_user($user->ID);
    wp_set_auth_cookie($user->ID, true);
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ä–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞
    ar_ensure_client_role($user->ID);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞
    $saved_form_data = get_user_meta($user->ID, 'ar_pending_order_data', true);
    if (!empty($saved_form_data)) {
        delete_user_meta($user->ID, 'ar_pending_order_data');
        $redirect = add_query_arg('restore_form', '1', $redirect);
    }
    
    $response = [
        'message' => '–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!',
        'redirect_url' => $redirect
    ];
    
    wp_send_json_success($response);
    wp_die();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function ar_generate_username_from_email($email) {
    $base = sanitize_user(current(explode('@', $email)), true);
    if (empty($base)) {
        $base = 'user';
    }

    $username = $base;
    $i = 1;
    while (username_exists($username)) {
        $username = $base . $i;
        $i++;
    }

    return $username;
}

function ar_ensure_client_role($user_id) {
    $user = get_userdata($user_id);
    if (!$user) return;

    if (!in_array('client', (array) $user->roles, true)) {
        $user->set_role('client');
    }
}

function ar_phone_exists($phone_full) {
    global $wpdb;
    
    $users = $wpdb->get_var($wpdb->prepare(
        "SELECT COUNT(*) FROM {$wpdb->usermeta} WHERE meta_key = 'phone_full' AND meta_value = %s",
        $phone_full
    ));
    
    return $users > 0;
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
function ar_send_verification_email($email, $code, $first_name) {
    $subject = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email - Art Rocket';
    $verification_link = add_query_arg([
        'action' => 'verify_email',
        'code' => $code,
        'email' => urlencode($email)
    ], home_url('/wp-admin/admin-ajax.php'));
    
    $message = "
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; color: white; border-radius: 10px 10px 0 0; }
            .content { background: white; padding: 30px; border: 1px solid #eaeaea; border-top: none; border-radius: 0 0 10px 10px; }
            .code { background: #f8f9fa; padding: 20px; text-align: center; font-size: 32px; font-weight: bold; letter-spacing: 5px; margin: 20px 0; border-radius: 8px; color: #667eea; }
            .button { display: inline-block; padding: 15px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; }
            .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eaeaea; font-size: 12px; color: #666; text-align: center; }
        </style>
    </head>
    <body>
        <div class='container'>
            <div class='header'>
                <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                <p>Art Rocket - –î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞</p>
            </div>
            <div class='content'>
                <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {$first_name}!</h2>
                <p>–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –≤–∞—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ Art Rocket. –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email –∞–¥—Ä–µ—Å.</p>
                
                <p>–í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</p>
                <div class='code'>{$code}</div>
                
                <p style='text-align: center;'>
                    <a href='{$verification_link}' class='button'>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email</a>
                </p>
                
                <p>–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä:</p>
                <p style='background: #f8f9fa; padding: 10px; border-radius: 5px; word-break: break-all; font-size: 12px;'>
                    {$verification_link}
                </p>
                
                <p>–ï—Å–ª–∏ –≤—ã –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –Ω–∞ Art Rocket, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.</p>
            </div>
            <div class='footer'>
                <p>&copy; " . date('Y') . " Art Rocket. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </body>
    </html>
    ";
    
    $headers = ['Content-Type: text/html; charset=UTF-8'];
    
    return wp_mail($email, $subject, $message, $headers);
}

// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email
add_action('wp_ajax_verify_email', 'ar_verify_email');
add_action('wp_ajax_nopriv_verify_email', 'ar_verify_email');
function ar_verify_email() {
    $code = sanitize_text_field($_GET['code'] ?? '');
    $email = sanitize_email($_GET['email'] ?? '');
    
    if (empty($code) || empty($email)) {
        wp_die('–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏');
    }
    
    $user = get_user_by('email', $email);
    
    if (!$user) {
        wp_die('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    $saved_code = get_user_meta($user->ID, 'email_verification_code', true);
    
    if ($saved_code != $code) {
        wp_die('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    update_user_meta($user->ID, 'email_verified', true);
    delete_user_meta($user->ID, 'email_verification_code');
    
    // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    wp_set_current_user($user->ID);
    wp_set_auth_cookie($user->ID, true);
    
    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–∫–∞–∑–æ–≤
    wp_redirect(add_query_arg('email_verified', '1', home_url('/zakazdizain')));
    exit;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–≤—Ö–æ–¥–∞
function ar_get_auth_button($type = 'register', $redirect_url = '') {
    if (empty($redirect_url)) {
        $redirect_url = home_url($_SERVER['REQUEST_URI']);
    }
    
    $button_text = $type === 'register' ? 'üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : 'üîê –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç';
    
    ob_start();
    ?>
    <div style="text-align: center; margin: 20px 0;">
        <button type="button" 
                class="ar-auth-btn"
                onclick="arOpenAuthModal('<?php echo $type; ?>', '<?php echo esc_js($redirect_url); ?>')"
                style="display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; background: <?php echo $type === 'register' ? '#667eea' : '#6c757d'; ?>; color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;">
            <?php echo $button_text; ?>
        </button>
    </div>
    <?php
    return ob_get_clean();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function ar_get_auth_form_button($redirect_url = '') {
    if (empty($redirect_url)) {
        $redirect_url = home_url($_SERVER['REQUEST_URI']);
    }
    
    ob_start();
    ?>
    <div style="text-align: center; margin: 20px 0;">
        <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
            <button type="button" 
                    onclick="arOpenAuthModal('register', '<?php echo esc_js($redirect_url); ?>')"
                    style="display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; min-width: 200px;">
                üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
            </button>
            
            <div style="font-size: 12px; color: #666;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</div>
            
            <button type="button" 
                    onclick="arOpenAuthModal('login', '<?php echo esc_js($redirect_url); ?>')"
                    style="display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; min-width: 200px;">
                üîê –í–æ–π—Ç–∏
            </button>
        </div>
    </div>
    <?php
    return ob_get_clean();
}

// –î–æ–±–∞–≤–ª—è–µ–º nonce –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
// –î–æ–±–∞–≤–ª—è–µ–º nonce –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤




// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
add_action('wp_ajax_ar_check_auth_status', 'ar_check_auth_status');
add_action('wp_ajax_nopriv_ar_check_auth_status', 'ar_check_auth_status');

function ar_check_auth_status() {
    $response = array(
        'success' => false,
        'data' => array(
            'logged_in' => false,
        )
    );
    
    if (is_user_logged_in()) {
        $user = wp_get_current_user();
        
        // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–¥–µ—Å—å —Ç–æ–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
        $redirect_url = 'https://art-rocket.ru/zakazdizain/';
        $logout_url = wp_logout_url($redirect_url);
        
        $response['success'] = true;
        $response['data'] = array(
            'logged_in' => true,
            'user_id' => $user->ID,
            'display_name' => $user->display_name,
            'logout_url' => $logout_url
        );
    }
    
    wp_send_json($response);
}




// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è nonce –≤—ã—Ö–æ–¥–∞
add_action('wp_ajax_ar_get_logout_nonce', 'ar_get_logout_nonce');
add_action('wp_ajax_nopriv_ar_get_logout_nonce', 'ar_get_logout_nonce');

function ar_get_logout_nonce() {
    nocache_headers();
    
    $response = array(
        'success' => false,
        'nonce' => ''
    );
    
    if (is_user_logged_in()) {
        $response = array(
            'success' => true,
            'nonce' => wp_create_nonce('log-out')
        );
    }
    
    wp_send_json($response);
    wp_die();
}

// –û–±–Ω–æ–≤–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ar_check_user_role:
add_action('wp_ajax_ar_check_user_role', 'ar_check_user_role');
add_action('wp_ajax_nopriv_ar_check_user_role', 'ar_check_user_role');

function ar_check_user_role() {
    nocache_headers();
    
    $response = array(
        'success' => false,
        'logged_in' => false
    );
    
    if (is_user_logged_in()) {
        $user = wp_get_current_user();
        
        // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π redirect URL
        $redirect_url = 'https://art-rocket.ru/zakazdizain/';
        
        // // –°–ø–æ—Å–æ–± 1: –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É —Å nonce –≤—Ä—É—á–Ω—É—é
        // $logout_nonce = wp_create_nonce('log-out');
        // $logout_url = site_url("wp-login.php?action=logout&_wpnonce={$logout_nonce}&redirect_to=" . urlencode($redirect_url));
        
        // –ò–õ–ò –°–ø–æ—Å–æ–± 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é WordPress
         $logout_url = wp_logout_url($redirect_url);
        
        $response = array(
            'success' => true,
            'logged_in' => true,
            'user_id' => $user->ID,
            'display_name' => $user->display_name,
            'roles' => (array) $user->roles,
            'logout_url' => $logout_url,
            'logout_nonce' => $logout_nonce
        );
    } else {
        $response = array(
            'success' => true,
            'logged_in' => false
        );
    }
    
    wp_send_json($response);
    wp_die();
}

// –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π JavaScript –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
function ar_add_global_js() {
    ?>
    <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º
    if (typeof arOpenAuthModal === 'undefined') {
        function arOpenAuthModal(action = 'login', redirect = '') {
            // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ (—Ñ–æ—Ä–º–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞),
            // –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—ë —á–µ—Ä–µ–∑ AJAX
            fetch('<?php echo admin_url('admin-ajax.php'); ?>?action=ar_get_auth_form&auth_action=' + action + '&redirect=' + encodeURIComponent(redirect || window.location.href))
                .then(response => response.text())
                .then(html => {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–æ–¥–∞–ª–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
                    const oldModal = document.getElementById('arAuthModal');
                    if (oldModal) oldModal.remove();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –º–æ–¥–∞–ª–∫—É –≤ body
                    document.body.insertAdjacentHTML('beforeend', html);
                    
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    document.body.style.overflow = 'hidden';
                })
                .catch(error => {
                    console.error('Error loading auth form:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                });
        }
    }
    
    if (typeof arCloseAuthModal === 'undefined') {
        function arCloseAuthModal() {
            const modal = document.getElementById('arAuthModal');
            if (modal) {
                modal.remove();
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
                document.body.style.overflow = '';
            }
        }
    }

    // // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    // function arUpdateAuthButtons() {
    //     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—É–∫–∏ wordpress_logged_in
    //     const cookies = document.cookie.split(';');
    //     let hasCookie = false;
    //     for (let i = 0; i < cookies.length; i++) {
    //         if (cookies[i].trim().startsWith('wordpress_logged_in_')) {
    //             hasCookie = true;
    //             break;
    //         }
    //     }

    //     if (!hasCookie) {
    //         // –ï—Å–ª–∏ –Ω–µ—Ç –∫—É–∫–∏, —Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    //         return;
    //     }

    //     // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    //     fetch('<?php echo admin_url('admin-ajax.php'); ?>?action=ar_check_auth_status')
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.success && data.data.logged_in) {
    //                 const user = data.data;

    //                 // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –∫–Ω–æ–ø–∫—É
    //                 const desktopAuthButton = document.getElementById('desktopAuthButton');
    //                 if (desktopAuthButton) {
    //                     desktopAuthButton.innerHTML = `
    //                         <span style="margin-right: 10px; color: white;">–ü—Ä–∏–≤–µ—Ç, ${user.display_name}</span>
    //                         <a href="${user.logout_url}" class="custom-auth-btn">–í—ã–π—Ç–∏</a>
    //                     `;
    //                 }

    //                 // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
    //                 const mobileAuthButton = document.getElementById('mobileAuthButton');
    //                 if (mobileAuthButton) {
    //                     mobileAuthButton.innerHTML = `
    //                         <div style="text-align: center; padding: 10px 0;">
    //                             <div style="color: white; margin-bottom: 10px; font-size: 14px;">–ü—Ä–∏–≤–µ—Ç, ${user.display_name}</div>
    //                             <a href="${user.logout_url}" class="custom-auth-btn">–í—ã–π—Ç–∏</a>
    //                         </div>
    //                     `;
    //                 }
    //             }
    //         })
    //         .catch(error => {
    //             console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    //         });
    // }

    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
    if (typeof arUpdateAuthButtons === 'function') {
        arUpdateAuthButtons();
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Esc
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            arCloseAuthModal();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('ar-auth-modal-overlay')) {
            arCloseAuthModal();
        }
    });
    </script>
    <?php
}
/* ========================= –ö–ê–ë–ò–ù–ï–¢ –ö–õ–ò–ï–ù–¢–ê –° –ß–ê–¢–û–ú ========================= */

if (!function_exists('ar_client_orders_shortcode')) {
    add_shortcode('ar_client_orders', 'ar_client_orders_shortcode');
    
    function ar_client_orders_shortcode($atts) {
        
        if (!ar_check_client_tables()) {
            return '<div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>Eroare de sistem</h3>
                        <p>VƒÉ rugƒÉm √Æncerca»õi mai t√¢rziu.</p>
                    </div>';
        }
        
        ob_start();
        
        $current_url = home_url($_SERVER['REQUEST_URI']);
        $is_user_logged_in = is_user_logged_in();
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        $my_orders_count = 0;
        $total_unread = 0;
        
        if ($is_user_logged_in) {
            $current_user = wp_get_current_user();
            $my_orders_count = ar_get_client_orders_count($current_user->ID);
            $total_unread = ar_client_get_unread_messages_count($current_user->ID);
        }
        
        ?>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div id="arChatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; height: 80vh; max-height: 700px; display: flex; flex-direction: column;">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                <div style="padding: 20px; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: #333; font-size: 1.2em;" id="arChatTitle">–ß–∞—Ç –ø–æ –∑–∞—è–≤–∫–µ</h3>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;" id="arChatSubtitle"></p>
                    </div>
                    <button type="button" onclick="arCloseChat()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">√ó</button>
                </div>
                
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div id="arChatMessages" style="flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
                    </div>
                </div>
                
                <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div style="padding: 20px; border-top: 1px solid #eaeaea;">
                    <form id="arChatForm" onsubmit="return arSendChatMessage(event)">
                        <div style="display: flex; gap: 10px; flex-direction: column;">
                            <div style="position: relative;">
                                <input type="text" id="arChatMessageInput" 
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                       style="width: 100%; padding: 12px; padding-right: 80px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                                       maxlength="1000"
                                       oninput="arUpdateClientCharCounter()"
                                       required>
                                <span id="arCharCounter" 
                                      style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #95a5a6; pointer-events: none;">
                                    0/1000
                                </span>
                            </div>
                            <button type="submit" 
                                    style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s;">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </form>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ -->
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.8em; color: #666;">
                        <div style="display: flex; justify-content: space-between;">
                            <span id="arChatInfo">–ß–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</span>
                            <span id="arChatStatus"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
        /* –°—Ç–∏–ª–∏ —á–∞—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ */
        .ar-chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
        }

        .ar-chat-message.sent {
            background: #667eea;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ar-chat-message.received {
            background: #f1f3f4;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .ar-chat-message-time {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .ar-chat-message.received .ar-chat-message-time {
            text-align: left;
        }

        .ar-chat-status-online {
            color: #28a745;
            font-weight: 600;
        }

        .ar-chat-status-offline {
            color: #6c757d;
        }

        #arChatMessages {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 transparent;
        }

        #arChatMessages::-webkit-scrollbar {
            width: 6px;
        }

        #arChatMessages::-webkit-scrollbar-track {
            background: transparent;
        }

        #arChatMessages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .ar-client-content {
                grid-template-columns: 350px 1fr !important;
                gap: 25px !important;
            }
            .ar-designers-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }
        }

        @media (max-width: 768px) {
            .ar-client-orders {
                padding: 10px !important;
            }
            .ar-client-content {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            .ar-order-form-container {
                position: static !important;
                margin-bottom: 20px;
            }
            .ar-designers-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
        }

        .ar-radio-label:hover, .ar-checkbox-label:hover {
            background: #f8f9fa;
        }

        .ar-form-input:focus {
            outline: none;
            border-color: #667eea !important;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .designer-card-selected {
            border: 3px solid #667eea !important;
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.3) !important;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .ar-btn-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
        </style>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div id="arChatBadgeClient" style="display: none; position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
            üí¨ <span id="arUnreadCountClient">0</span> –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        </div>
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="arAuthRequiredModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="font-size: 48px; margin-bottom: 20px;">üîí</div>
                <h3 style="color: #333; margin-bottom: 15px; font-size: 1.4em;">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
                    –î–ª—è –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.<br>
                    –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.
                </p>
                
                <div style="margin-bottom: 20px;">
    <div style="text-align: center; margin: 20px 0;">
        <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
            <a href="#" onclick="openAuthForm('register', '<?php echo esc_js($current_url); ?>'); return false;" 
               class="ar-auth-btn"
               style="display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 200px;"
               target="_blank">
                üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
            </a>
            
            <div style="font-size: 12px; color: #666;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</div>
            
            <a href="#" onclick="openAuthForm('login', '<?php echo esc_js($current_url); ?>'); return false;" 
               class="ar-auth-btn"
               style="display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.3s ease; min-width: 200px;"
               target="_blank">
                üîê –í–æ–π—Ç–∏
            </a>
        </div>
    </div>
</div>
                
                <div style="border-top: 1px solid #eaeaea; padding-top: 20px;">
                    <button type="button" onclick="document.getElementById('arAuthRequiredModal').style.display = 'none'" 
                            style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    </button>
                </div>
            </div>
        </div>

        <div class="ar-client-orders" style="max-width: 1600px; margin: 0 auto; padding: 15px;">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="ar-client-content" style="display: grid; grid-template-columns: 400px 1fr; gap: 30px; align-items: start;">
                
                <!-- –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ -->
                <section class="ar-order-form-section">
                    <div class="ar-order-form-container" style="background: white; border-radius: 12px; padding: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid #eaeaea; position: sticky; top: 15px; overflow: hidden;">
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
                        <div style="padding: 15px 20px; background: <?php echo $is_user_logged_in ? '#d4edda' : '#fff3cd'; ?>; border-bottom: 1px solid <?php echo $is_user_logged_in ? '#c3e6cb' : '#ffeaa7'; ?>;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.2em;"><?php echo $is_user_logged_in ? '‚úÖ' : '‚ö†Ô∏è'; ?></span>
                                <div>
                                    <strong style="color: <?php echo $is_user_logged_in ? '#155724' : '#856404'; ?>;">
                                        <?php echo $is_user_logged_in ? '–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã' : '–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º'; ?>
                                    </strong>
                                    <div style="font-size: 0.8em; color: <?php echo $is_user_logged_in ? '#155724' : '#856404'; ?>;">
                                        <?php echo $is_user_logged_in ? '–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞—è–≤–∫–∏' : '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–æ–∫'; ?>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form id="arOrderForm" enctype="multipart/form-data">
                            <input type="hidden" id="selected_designer_id" name="selected_designer_id" value="">
                            
                            <!-- –ë–ª–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ -->
                            <div id="selectedDesignerInfo" style="display: none; padding: 15px; background: #e7f3ff; border-radius: 8px; margin: 15px; border-left: 4px solid #667eea;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.2em;">üéØ</span>
                                    <strong style="color: #333;">–í—ã–±—Ä–∞–Ω –¥–∏–∑–∞–π–Ω–µ—Ä:</strong>
                                </div>
                                <div id="selectedDesignerDetails" style="font-size: 0.9em; color: #555;"></div>
                                <button type="button" onclick="arClearDesignerSelection()" style="margin-top: 8px; padding: 4px 8px; background: none; border: 1px solid #dc3545; color: #dc3545; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                    –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä
                                </button>
                            </div>

                            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ -->
                            <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                                <h3 style="color: #333; margin: 0 0 12px 0; font-size: 1.2em; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</h3>
                                <input type="text" class="ar-form-input" name="project_name" required placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #f8f9fa;">
                                <p style="font-size: 0.75em; color: #666; margin: 8px 0 0 0; font-style: italic;">–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤</p>
                            </div>

                            <!-- –ü—Ä–æ–¥—É–∫—Ç -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 12px 0; font-size: 1.2em; font-weight: 600;">–ü—Ä–æ–¥—É–∫—Ç *</h3>
                            <div class="ar-radio-group" style="display: flex; flex-direction: column; gap: 10px;">
                                <label class="ar-radio-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9em; padding: 10px 12px; border-radius: 8px; transition: background 0.2s; border: 1px solid #eaeaea;">
                                    <input type="radio" name="product_type" value="design" checked style="margin: 0; width: 18px; height: 18px;">
                                    <span>–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞</span>
                                </label>
                                <label class="ar-radio-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9em; padding: 10px 12px; border-radius: 8px; transition: background 0.2s; border: 1px solid #eaeaea;">
                                    <input type="radio" name="product_type" value="furniture" style="margin: 0; width: 18px; height: 18px;">
                                    <span>–ú–µ–±–µ–ª—å –Ω–∞ –∑–∞–∫–∞–∑</span>
                                </label>
                            </div>
                        </div>

                        <!-- –í–∏–¥ —É—Å–ª—É–≥–∏ -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 12px 0; font-size: 1.2em; font-weight: 600;">–¢–∏–ø —É—Å–ª—É–≥–∏ *</h3>
                            <div class="ar-checkbox-group" style="display: flex; flex-direction: column; gap: 10px;">
                                <label class="ar-checkbox-label" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 0.85em; padding: 10px 12px; border-radius: 8px; transition: background 0.2s; border: 1px solid #eaeaea;">
                                    <input type="radio" name="service_type" value="design_project" required style="margin-top: 2px; width: 18px; height: 18px;">
                                    <span>–î–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç</span>
                                </label>
                                <label class="ar-checkbox-label" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 0.85em; padding: 10px 12px; border-radius: 8px; transition: background 0.2s; border: 1px solid #eaeaea;">
                                    <input type="radio" name="service_type" value="design_materials" style="margin-top: 2px; width: 18px; height: 18px;">
                                    <span>–î–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç –∏ –ø–æ–¥–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</span>
                                </label>
                                <label class="ar-checkbox-label" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 0.85em; padding: 10px 12px; border-radius: 8px; transition: background 0.2s; border: 1px solid #eaeaea;">
                                    <input type="radio" name="service_type" value="full_service" style="margin-top: 2px; width: 18px; height: 18px;">
                                    <span>–î–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç, –ø–æ–¥–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏</span>
                                </label>
                            </div>
                        </div>

                        <!-- –°—Ç—Ä–∞–Ω–∞ –∏ –ì–æ—Ä–æ–¥ -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="ar-form-group">
                                    <label class="ar-form-label" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.85em;">–°—Ç—Ä–∞–Ω–∞ *</label>
                                    <select class="ar-form-input" name="country" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>
                                        <option value="romania">–†—É–º—ã–Ω–∏—è</option>
                                        <option value="moldova">–ú–æ–ª–¥–æ–≤–∞</option>
                                        <option value="other">–î—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞</option>
                                    </select>
                                </div>
                                
                                <div class="ar-form-group">
                                    <label class="ar-form-label" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.85em;">–ì–æ—Ä–æ–¥ *</label>
                                    <select class="ar-form-input" name="city" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                        <option value="bucuresti">–ë—É—Ö–∞—Ä–µ—Å—Ç</option>
                                        <option value="cluj">–ö–ª—É–∂-–ù–∞–ø–æ–∫–∞</option>
                                        <option value="timisoara">–¢–∏–º–∏—à–æ–∞—Ä–∞</option>
                                        <option value="iasi">–Ø—Å—Å—ã</option>
                                        <option value="constanta">–ö–æ–Ω—Å—Ç–∞–Ω—Ü–∞</option>
                                        <option value="other">–î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <label class="ar-form-label" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.85em;">–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ *</label>
                            <select class="ar-form-input" name="object_type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                <option value="apartment">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
                                <option value="house">–î–æ–º</option>
                                <option value="office">–û—Ñ–∏—Å</option>
                                <option value="restaurant">–†–µ—Å—Ç–æ—Ä–∞–Ω</option>
                                <option value="shop">–ú–∞–≥–∞–∑–∏–Ω</option>
                            </select>
                        </div>

                        <!-- –ñ–µ–ª–∞–µ–º—ã–π —Å—Ç–∏–ª—å -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <label class="ar-form-label" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.85em;">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Å—Ç–∏–ª—å</label>
                            <select class="ar-form-input" name="style" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</option>
                                <option value="modern">–ú–æ–¥–µ—Ä–Ω</option>
                                <option value="minimalist">–ú–∏–Ω–∏–º–∞–ª–∏–∑–º</option>
                                <option value="scandinavian">–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π</option>
                                <option value="loft">–õ–æ—Ñ—Ç</option>
                                <option value="hi-tech">–•–∞–π-—Ç–µ–∫</option>
                            </select>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å –æ–±—ä–µ–∫—Ç–∞ -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <label class="ar-form-label" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.85em;">–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ *</label>
                            <select class="ar-form-input" name="object_status" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</option>
                                <option value="ready">–ì–æ—Ç–æ–≤ –¥–ª—è –∑–∞–º–µ—Ä–æ–≤</option>
                                <option value="renovation">–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–º–æ–Ω—Ç–∞</option>
                                <option value="rough">–ß–µ—Ä–Ω–æ–≤–∞—è –æ—Ç–¥–µ–ª–∫–∞</option>
                            </select>
                        </div>

                        <!-- –ü–ª–æ—â–∞–¥—å -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <label class="ar-form-label" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.85em;">–ü–ª–æ—â–∞–¥—å (–º¬≤) *</label>
                            <input type="number" class="ar-form-input" name="area" min="1" max="1000" required placeholder="–Ω–∞–ø—Ä: 75" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                        </div>

                        <!-- –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 10px 0; font-size: 1.2em; font-weight: 600;">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</h3>
                            <div style="position: relative;">
                                <input type="date" class="ar-form-input" name="completion_date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                    <span style="font-size: 0.75em; color: #666;">–í–≤–µ–¥–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é –¥–∞—Ç—É</span>
                                    <button type="button" onclick="document.querySelector('input[name=\'completion_date\']').value = ''" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 0.75em; text-decoration: underline;">
                                        –°–±—Ä–æ—Å–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –ë—é–¥–∂–µ—Ç -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 10px 0; font-size: 1.2em; font-weight: 600;">–ñ–µ–ª–∞–µ–º—ã–π –±—é–¥–∂–µ—Ç</h3>
                            <div style="position: relative;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" class="ar-form-input" name="budget" min="0" placeholder="1000" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                                    <select name="currency" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa; min-width: 70px;">
                                        <option value="RON">RON</option>
                                        <option value="EUR">‚Ç¨</option>
                                        <option value="USD">$</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- –§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ –æ–±—ä–µ–∫—Ç–∞ -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 10px 0; font-size: 1.2em; font-weight: 600;">–§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ –æ–±—ä–µ–∫—Ç–∞</h3>
                            <div class="ar-file-upload-area" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; background: #f8f9fa; position: relative; cursor: pointer; transition: border-color 0.2s;">
                                <input type="file" class="ar-form-input" name="photos[]" multiple accept="image/*,video/*" style="width: 100%; height: 100%; opacity: 0; position: absolute; top: 0; left: 0; cursor: pointer;">
                                <div style="pointer-events: none;">
                                    <div style="font-size: 2em; margin-bottom: 8px;">üìé</div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</div>
                                    <div style="font-size: 0.75em; color: #666;">–¥–æ 10 —Ñ–∞–π–ª–æ–≤, –º–∞–∫—Å. 100MB</div>
                                </div>
                            </div>
                            <div id="photos-preview" style="margin-top: 10px;"></div>
                        </div>

                        <!-- –†–∞–∑–º–µ—Ä—ã –∏ —á–µ—Ä—Ç–µ–∂–∏ -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 10px 0; font-size: 1.2em; font-weight: 600;">–†–∞–∑–º–µ—Ä—ã –∏ –ø–ª–∞–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
                            <div class="ar-file-upload-area" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; background: #f8f9fa; position: relative; cursor: pointer; transition: border-color 0.2s;">
                                <input type="file" class="ar-form-input" name="drawings[]" multiple accept=".pdf,.dwg,.jpg,.png" style="width: 100%; height: 100%; opacity: 0; position: absolute; top: 0; left: 0; cursor: pointer;">
                                <div style="pointer-events: none;">
                                    <div style="font-size: 2em; margin-bottom: 8px;">üìé</div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</div>
                                    <div style="font-size: 0.75em; color: #666;">–¥–æ 10 —Ñ–∞–π–ª–æ–≤, –º–∞–∫—Å. 100MB</div>
                                </div>
                            </div>
                            <div id="drawings-preview" style="margin-top: 10px;"></div>
                        </div>

                        <!-- –§–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω—Ä–∞–≤–∏—Ç—Å—è -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 10px 0; font-size: 1.2em; font-weight: 600;">–§–æ—Ç–æ, –ø—Ä–æ–µ–∫—Ç –∫–æ—Ç–æ—Ä—ã–π –Ω—Ä–∞–≤–∏—Ç—Å—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
                            <div class="ar-file-upload-area" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; background: #f8f9fa; position: relative; cursor: pointer; transition: border-color 0.2s;">
                                <input type="file" class="ar-form-input" name="inspiration_photos[]" multiple accept="image/*" style="width: 100%; height: 100%; opacity: 0; position: absolute; top: 0; left: 0; cursor: pointer;">
                                <div style="pointer-events: none; text-align: center;">
                                    <div style="font-size: 2em; margin-bottom: 8px;">üñºÔ∏è</div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                                    <div style="font-size: 0.75em; color: #666;">–¥–æ 10 —Ñ–∞–π–ª–æ–≤, –º–∞–∫—Å. 100MB</div>
                                </div>
                            </div>
                            <div id="inspiration-preview" style="margin-top: 10px;"></div>
                        </div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div style="padding: 20px; border-bottom: 1px solid #eaeaea;">
                            <h3 style="color: #333; margin: 0 0 10px 0; font-size: 1.2em; font-weight: 600;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                            <textarea class="ar-form-input" name="additional_info" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f9fa; resize: vertical;"></textarea>
                        </div>

                        <!-- –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
<div style="padding: 20px;">
    <label class="ar-checkbox-label" style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; font-size: 0.8em; margin-bottom: 15px; padding: 8px 0;">
        <input type="checkbox" name="agree_terms" required style="margin-top: 2px; width: 16px; height: 16px;">
        <span>–Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Å <a href="/terms-and-conditions" target="_blank" style="color: #667eea;">–£—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è–º–∏</a></span>
    </label>

    <?php if (is_user_logged_in()): ?>
        <!-- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ -->
        <button type="submit" class="ar-btn ar-btn-primary" id="arSubmitOrderBtn" style="width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600;">
            üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
        </button>
    <?php else: ?>
        <!-- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <button type="button" 
                class="ar-btn ar-btn-primary" 
                onclick="arOpenAuthModal('register', '<?php echo esc_js(home_url($_SERVER['REQUEST_URI'])); ?>')" 
                style="width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600;">
            üîê –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        </button>
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ (–¥–ª—è —Ç–µ—Ö, —É –∫–æ–≥–æ —É–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç) -->
        <div style="text-align: center; margin-top: 10px; font-size: 0.85em; color: #666;">
            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? 
            <a href="javascript:void(0)" 
               onclick="arOpenAuthModal('login', '<?php echo esc_js(home_url($_SERVER['REQUEST_URI'])); ?>')" 
               style="color: #667eea; text-decoration: none; font-weight: 500;">
                –í–æ–π–¥–∏—Ç–µ
            </a>
        </div>
    <?php endif; ?>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
function arSaveFormData() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const form = document.querySelector('form[action*="zakazdizain"]');
        if (!form) return;
        
        const formData = new FormData(form);
        const formObject = {};
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º FormData –≤ –æ–±—ä–µ–∫—Ç
        for (let [key, value] of formData.entries()) {
            if (formObject[key]) {
                // –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞—Å—Å–∏–≤)
                if (Array.isArray(formObject[key])) {
                    formObject[key].push(value);
                } else {
                    formObject[key] = [formObject[key], value];
                }
            } else {
                formObject[key] = value;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('ar_pending_form_data', JSON.stringify(formObject));
        console.log('Form data saved for restoration');
    } catch (error) {
        console.error('Error saving form data:', error);
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function arRestoreFormData() {
    try {
        const savedData = localStorage.getItem('ar_pending_form_data');
        if (!savedData) return;
        
        const formObject = JSON.parse(savedData);
        const form = document.querySelector('form[action*="zakazdizain"]');
        if (!form) return;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        for (const [key, value] of Object.entries(formObject)) {
            const elements = form.querySelectorAll(`[name="${key}"]`);
            
            if (elements.length > 0) {
                elements.forEach(element => {
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        if (Array.isArray(value)) {
                            element.checked = value.includes(element.value);
                        } else {
                            element.checked = element.value === value;
                        }
                    } else if (element.tagName === 'SELECT') {
                        element.value = value;
                    } else {
                        element.value = value;
                    }
                });
            }
        }
        
        // –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        localStorage.removeItem('ar_pending_form_data');
        console.log('Form data restored');
    } catch (error) {
        console.error('Error restoring form data:', error);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é arOpenAuthModal –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
function arOpenAuthModalWithSave(action = 'login', redirect = '') {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª–∫–∏
    arSaveFormData();
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    if (typeof arOpenAuthModal === 'function') {
        arOpenAuthModal(action, redirect);
    } else {
        // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ
        const authUrl = '<?php echo admin_url("admin-ajax.php"); ?>?action=ar_show_auth_modal&auth_action=' + action + '&redirect=' + encodeURIComponent(redirect || window.location.href) + '&force_html=1';
        window.open(authUrl, '_blank', 'width=500,height=700');
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä URL –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('restore_form')) {
        // –î–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        setTimeout(arRestoreFormData, 300);
    }
});

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é arOpenAuthModal –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
window.arOpenAuthModal = function(action, redirect) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    arSaveFormData();
    
    // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    if (window.arOriginalOpenAuthModal) {
        return window.arOriginalOpenAuthModal(action, redirect);
    }
    
    // –ï—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    alert('–§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
};

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
window.arOriginalOpenAuthModal = window.arOpenAuthModal;
</script>
                    </form>
                </div>
            </section>

                <!-- –°–ø–∏—Å–æ–∫ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤ -->
                <section class="ar-designers-section">
                    <div class="ar-designers-header" style="margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 8px; font-size: 1.5em;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä—ã</h2>
                        <p class="ar-section-description" style="color: #666; font-size: 1em; margin: 0;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–µ–≥–æ—Å—è –Ω–∞ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ</p>
                    </div>
                    
                    <div class="ar-designers-grid" id="arDesignersGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <?php 
                        $current_page = isset($_GET['designer_page']) ? max(1, intval($_GET['designer_page'])) : 1;
                        $per_page = 21;
                        echo ar_get_designers_cards($current_page, $per_page); 
                        ?>
                    </div>

                    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                    <div class="ar-pagination" style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
                        <?php echo ar_get_designers_pagination($current_page, $per_page); ?>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –º–æ–∏–º –∑–∞–∫–∞–∑–∞–º -->
                    <?php if ($is_user_logged_in && $my_orders_count > 0): ?>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" 
        onclick="arShowMyOrders()" 
        style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
    üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏ (<?php echo $my_orders_count; ?>)
    <?php if ($total_unread > 0): ?>
        <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; font-weight: 600;">
            <?php echo $total_unread; ?> –Ω–æ–≤—ã—Ö
        </span>
    <?php endif; ?>
</button>
                    </div>
                    <?php endif; ?>
                </section>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –º–æ–∏—Ö –∑–∞–∫–∞–∑–æ–≤ -->
            <?php if ($is_user_logged_in): ?>
            <section class="ar-my-orders-section" id="arMyOrdersSection" style="display: none; margin-top: 40px;">
                <div class="ar-orders-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #eaeaea;">
                    <h2 style="color: #333; margin: 0; font-size: 1.4em;">–ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h2>
                    <button type="button" class="ar-btn ar-btn-secondary" id="arBackToDesignersBtn" onclick="arBackToDesigners()" style="padding: 10px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
    ‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º
</button>
                </div>
                <div class="ar-orders-list" id="arOrdersList">
                    <?php 
                    $current_user = wp_get_current_user();
                    echo ar_get_client_orders_list($current_user->ID); 
                    ?>
                </div>
            </section>
            <?php endif; ?>
        </div>

        <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let selectedDesigner = null;
let isUserLoggedIn = <?php echo $is_user_logged_in ? 'true' : 'false'; ?>;
let arCurrentChat = {
    orderId: null,
    otherUserId: null,
    otherUserName: null,
    refreshInterval: null
};

/* ========================= –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ========================= */

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function openAuthForm(action = 'login', redirectUrl = '') {
    if (!redirectUrl) {
        redirectUrl = window.location.href;
    }
    
    fetch('/wp-admin/admin-ajax.php?action=ar_show_auth_modal&auth_action=' + action + '&redirect=' + encodeURIComponent(redirectUrl))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                window.open(data.data.auth_url, 'auth_form', 'width=500,height=700,scrollbars=no');
            }
        })
        .catch(error => {
            console.error('Error opening auth form:', error);
            // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
            const fallbackUrl = '/wp-admin/admin-ajax.php?action=ar_show_auth_modal&force_html=1&auth_action=' + action + '&redirect=' + encodeURIComponent(redirectUrl);
            window.open(fallbackUrl, 'auth_form', 'width=500,height=700,scrollbars=no');
        });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function arShowAuthModal() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–∏
    openAuthForm('register', window.location.href);
}

        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã (–±–µ–∑ —Ñ–∞–π–ª–æ–≤)
        function arSaveFormData() {
            const form = document.getElementById('arOrderForm');
            const formData = new FormData(form);
            const data = {};
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            for (let [key, value] of formData.entries()) {
                const element = form.querySelector(`[name="${key}"]`);
                if (element && element.type !== 'file') {
                    data[key] = value;
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
            if (selectedDesigner) {
                data.selectedDesigner = selectedDesigner;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('arOrderFormData', JSON.stringify(data));
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã (–±–µ–∑ —Ñ–∞–π–ª–æ–≤)
        function arLoadFormData() {
            const saved = localStorage.getItem('arOrderFormData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    const form = document.getElementById('arOrderForm');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—è
                    for (let key in data) {
                        if (key === 'selectedDesigner') {
                            selectedDesigner = data.selectedDesigner;
                            arUpdateSelectedDesignerDisplay();
                        } else {
                            const element = form.querySelector(`[name="${key}"]`);
                            if (!element) continue;
                            
                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–∞–π–ª–æ–≤—ã–µ –ø–æ–ª—è
                            if (element.type === 'file') continue;
                            
                            if (element.type === 'checkbox' || element.type === 'radio') {
                                element.checked = element.value === data[key];
                            } else {
                                element.value = data[key] || '';
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error restoring form data:', e);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function arClearFormData() {
            localStorage.removeItem('arOrderFormData');
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        function arSelectDesigner(designerId, designerName, designerSpecialty, designerPrice) {
            if (!isUserLoggedIn) {
                arSaveFormData();
                
                selectedDesigner = {
                    id: designerId,
                    name: designerName,
                    specialty: designerSpecialty,
                    price: designerPrice
                };
                arSaveFormData();
                
                arShowAuthModal();
                return;
            }
            
            selectedDesigner = {
                id: designerId,
                name: designerName,
                specialty: designerSpecialty,
                price: designerPrice
            };
            
            document.getElementById('selected_designer_id').value = designerId;
            arUpdateSelectedDesignerDisplay();
            
            alert(`üéØ –í—ã –≤—ã–±—Ä–∞–ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–∞: ${designerName}\n\n–¢–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∑–∞—è–≤–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë —ç—Ç–æ–º—É –¥–∏–∑–∞–π–Ω–µ—Ä—É.`);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        function arClearDesignerSelection() {
            selectedDesigner = null;
            document.getElementById('selected_designer_id').value = '';
            document.getElementById('selectedDesignerInfo').style.display = 'none';
            
            document.querySelectorAll('.ar-designer-card').forEach(card => {
                card.classList.remove('designer-card-selected');
            });
            
            alert('‚ùå –í—ã–±–æ—Ä –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω. –ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º.');
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        function arUpdateSelectedDesignerDisplay() {
            if (selectedDesigner) {
                document.getElementById('selected_designer_id').value = selectedDesigner.id;
                const designerInfo = document.getElementById('selectedDesignerInfo');
                const designerDetails = document.getElementById('selectedDesignerDetails');
                
                designerDetails.innerHTML = `
                    <strong>${selectedDesigner.name}</strong><br>
                    <span style="color: #667eea;">${selectedDesigner.specialty}</span><br>
                    <span style="color: #666;">–¶–µ–Ω–∞: ${selectedDesigner.price}</span>
                `;
                
                designerInfo.style.display = 'block';
                
                document.querySelectorAll('.ar-designer-card').forEach(card => {
                    card.classList.remove('designer-card-selected');
                });
                
                const selectedCard = document.querySelector(`.ar-select-designer[data-designer-id="${selectedDesigner.id}"]`)?.closest('.ar-designer-card');
                if (selectedCard) {
                    selectedCard.classList.add('designer-card-selected');
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞
        function arSubmitOrder() {
            if (!isUserLoggedIn) {
                arSaveFormData();
                arShowAuthModal();
                return;
            }
            
            const form = document.getElementById('arOrderForm');
            const formData = new FormData(form);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            const requiredFields = ['project_name', 'service_type', 'country', 'city', 'object_type', 'object_status', 'area'];
            let hasErrors = false;
            
            for (let field of requiredFields) {
                const value = formData.get(field);
                if (!value || value.toString().trim() === '') {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                    hasErrors = true;
                    break;
                }
            }

            const projectName = formData.get('project_name');
            if (projectName && projectName.length < 10) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤!');
                hasErrors = true;
            }
            
            if (!form.querySelector('input[name="agree_terms"]').checked) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è–º–∏!');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
            if (selectedDesigner) {
                formData.append('selected_designer_name', selectedDesigner.name);
                formData.append('selected_designer_specialty', selectedDesigner.specialty);
                formData.append('selected_designer_price', selectedDesigner.price);
            }
            
            formData.append('action', 'ar_submit_client_order');
            formData.append('nonce', '<?php echo wp_create_nonce("ar_client_order_nonce"); ?>');
            
            const btn = document.getElementById('arSubmitOrderBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...';
            btn.disabled = true;
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–∞
            fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let successMessage = '‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!';
                    
                    if (selectedDesigner) {
                        successMessage += `\n\nüéØ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–∏–∑–∞–π–Ω–µ—Ä—É: ${selectedDesigner.name}`;
                        successMessage += `\nüíº –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ${selectedDesigner.specialty}`;
                        successMessage += `\nüí∞ –¶–µ–Ω–∞: ${selectedDesigner.price}`;
                    } else {
                        successMessage += '\n\nüì¢ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º.';
                    }
                    
                    alert(successMessage);
                    form.reset();
                    arClearDesignerSelection();
                    arClearFormData();
                    
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤
                    document.querySelectorAll('[id$="-preview"]').forEach(preview => {
                        preview.innerHTML = '';
                    });
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.data || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        /* ========================= –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê –î–õ–Ø –ö–õ–ò–ï–ù–¢–ê ========================= */

        // –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
        function arOpenClientChat(orderId, designerId, designerName) {
            arCurrentChat.orderId = orderId;
            arCurrentChat.otherUserId = designerId;
            arCurrentChat.otherUserName = designerName;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('arChatTitle').textContent = `–ß–∞—Ç –ø–æ –∑–∞—è–≤–∫–µ #${orderId}`;
            document.getElementById('arChatSubtitle').textContent = `–° –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º ${designerName}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('arChatModal').style.display = 'flex';
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body
            document.body.style.overflow = 'hidden';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            arLoadChatMessages();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            arStartChatAutoRefresh();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –±–µ–π–¥–∂ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
            arCheckNewMessagesClient();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
        function arCloseChat() {
            document.getElementById('arChatModal').style.display = 'none';
            document.body.style.overflow = '';
            arStopChatAutoRefresh();
            arCurrentChat = { orderId: null, otherUserId: null, otherUserName: null, refreshInterval: null };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
            setTimeout(arCheckNewMessagesClient, 1000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function arLoadChatMessages(retryCount = 0) {
            if (!arCurrentChat.orderId || !arCurrentChat.otherUserId) return;
            
            const data = {
                action: 'ar_get_chat_messages',
                order_id: arCurrentChat.orderId,
                other_user_id: arCurrentChat.otherUserId,
                nonce: '<?php echo wp_create_nonce("ar_chat_nonce"); ?>'
            };
            
            fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    arDisplayChatMessages(result.data.messages, result.data.current_user_id);
                    arUpdateChatInfo(result.data.other_user);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', result.data);
                    if (retryCount < 3) {
                        setTimeout(() => arLoadChatMessages(retryCount + 1), 2000 * (retryCount + 1));
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–æ 3 —Ä–∞–∑
                if (retryCount < 3) {
                    console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}/3...`);
                    setTimeout(() => arLoadChatMessages(retryCount + 1), 2000 * (retryCount + 1));
                } else {
                    const messagesContainer = document.getElementById('arChatMessages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; color: #e74c3c; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                                <button onclick="arLoadChatMessages(0)" 
                                        style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                                </button>
                            </div>
                        `;
                    }
                }
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function arDisplayChatMessages(messages, currentUserId) {
            const messagesContainer = document.getElementById('arChatMessages');
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>
                        <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                        <p style="font-size: 0.9em;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `ar-chat-message ${message.is_sent ? 'sent' : 'received'}`;
                
                // Create message content safely (prevent XSS)
                const messageText = document.createElement('div');
                messageText.textContent = message.message;
                
                const timeEl = document.createElement('div');
                timeEl.className = 'ar-chat-message-time';
                timeEl.textContent = message.formatted_time;
                
                messageElement.appendChild(messageText);
                messageElement.appendChild(timeEl);
                
                messagesContainer.appendChild(messageElement);
            });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ
        function arUpdateChatInfo(otherUser) {
            const statusElement = document.getElementById('arChatStatus');
            const infoElement = document.getElementById('arChatInfo');
            
            const statusClass = otherUser.is_online ? 'ar-chat-status-online' : 'ar-chat-status-offline';
            const statusText = otherUser.is_online ? 'üü¢ –í —Å–µ—Ç–∏' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏';
            
            statusElement.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
            infoElement.textContent = `–ß–∞—Ç —Å ${otherUser.name}`;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function arSendChatMessage(event) {
            event.preventDefault();
            
            const messageInput = document.getElementById('arChatMessageInput');
            const sendButton = document.querySelector('#arChatForm button[type="submit"]');
            const message = messageInput.value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!message) {
                arShowClientMessageError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return false;
            }
            
            if (message.length > 1000) {
                arShowClientMessageError('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤)');
                return false;
            }
            
            if (!arCurrentChat.orderId || !arCurrentChat.otherUserId) {
                arShowClientMessageError('–û—à–∏–±–∫–∞: —á–∞—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return false;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            if (sendButton) {
                sendButton.disabled = true;
                sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            }
            
            const data = {
                action: 'ar_send_chat_message',
                order_id: arCurrentChat.orderId,
                receiver_id: arCurrentChat.otherUserId,
                message: message,
                nonce: '<?php echo wp_create_nonce("ar_chat_nonce"); ?>'
            };
            
            fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.status);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    messageInput.value = '';
                    arUpdateClientCharCounter();
                    arLoadChatMessages();
                    arShowClientMessageSuccess('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                } else {
                    arShowClientMessageError('–û—à–∏–±–∫–∞: ' + (result.data || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                arShowClientMessageError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            })
            .finally(() => {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                }
            });
            
            return false;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
        function arUpdateClientCharCounter() {
            const messageInput = document.getElementById('arChatMessageInput');
            const counter = document.getElementById('arCharCounter');
            
            if (messageInput && counter) {
                const length = messageInput.value.length;
                const maxLength = 1000;
                counter.textContent = `${length}/${maxLength}`;
                
                if (length > maxLength) {
                    counter.style.color = '#e74c3c';
                } else if (length > maxLength * 0.9) {
                    counter.style.color = '#f39c12';
                } else {
                    counter.style.color = '#95a5a6';
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö –∏ —É—Å–ø–µ—Ö–µ
        function arShowClientMessageError(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #e74c3c;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10002;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function arShowClientMessageSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10002;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
        function arStartChatAutoRefresh() {
            arCurrentChat.refreshInterval = setInterval(arLoadChatMessages, 3000);
        }

        function arStopChatAutoRefresh() {
            if (arCurrentChat.refreshInterval) {
                clearInterval(arCurrentChat.refreshInterval);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
        function arCheckNewMessagesClient() {
            if (!isUserLoggedIn) return;
            
            const data = {
                action: 'ar_check_new_messages',
                nonce: '<?php echo wp_create_nonce("ar_chat_nonce"); ?>'
            };
            
            fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const unreadCount = result.data.unread_count;
                    const badge = document.getElementById('arChatBadgeClient');
                    const countElement = document.getElementById('arUnreadCountClient');
                    
                    if (unreadCount > 0) {
                        countElement.textContent = unreadCount;
                        badge.style.display = 'block';
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —á–∞—Ç–µ
                        if (unreadCount > 0 && document.getElementById('arChatModal').style.display !== 'flex') {
                            arShowNotification(`–£ –≤–∞—Å ${unreadCount} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤!`);
                        }
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function arShowNotification(message) {
            // –£–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existingNotifications = document.querySelectorAll('.ar-notification');
            existingNotifications.forEach(notification => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = 'ar-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #667eea;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10001;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">üí¨</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞—è–≤–∫–∏
        function arViewOrderDetails(orderId) {
            document.getElementById('order-details-' + orderId).style.display = 'flex';
        }

        /* ========================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ========================= */

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', function() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            arLoadFormData();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            const form = document.getElementById('arOrderForm');
            if (form && !isUserLoggedIn) {
                form.addEventListener('input', arSaveFormData);
                form.addEventListener('change', arSaveFormData);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('ar-select-designer')) {
                    const designerId = e.target.getAttribute('data-designer-id');
                    const designerCard = e.target.closest('.ar-designer-card');
                    const designerName = designerCard?.querySelector('h3')?.textContent;
                    const designerSpecialty = designerCard?.querySelector('.ar-designer-specialty')?.textContent;
                    const designerPrice = designerCard?.querySelector('.ar-price-amount')?.textContent;
                    
                    if (designerId && designerName) {
                        arSelectDesigner(designerId, designerName, designerSpecialty, designerPrice);
                    }
                }
            });
            
            const submitBtn = document.getElementById('arSubmitOrderBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', arSubmitOrder);
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('arChatModal').style.display === 'flex') {
                    arCloseChat();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
            document.getElementById('arChatModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    arCloseChat();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    e.target.style.display = 'none';
                }
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Enter –≤ —á–∞—Ç–µ (Ctrl+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
            document.addEventListener('keydown', function(e) {
                const chatInput = document.getElementById('arChatMessageInput');
                if (e.key === 'Enter' && chatInput && document.activeElement === chatInput) {
                    if (e.ctrlKey) {
                        // Ctrl+Enter - –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
                        const start = chatInput.selectionStart;
                        const end = chatInput.selectionEnd;
                        chatInput.value = chatInput.value.substring(0, start) + '\n' + chatInput.value.substring(end);
                        chatInput.selectionStart = chatInput.selectionEnd = start + 1;
                        e.preventDefault();
                    } else {
                        // Enter - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                        e.preventDefault();
                        document.getElementById('arChatForm').dispatchEvent(new Event('submit'));
                    }
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –º–æ–∏—Ö –∑–∞–∫–∞–∑–æ–≤
            const myOrdersSection = document.getElementById('arMyOrdersSection');
            const backToDesignersBtn = document.getElementById('arBackToDesignersBtn');
            
            if (backToDesignersBtn && myOrdersSection) {
                backToDesignersBtn.addEventListener('click', function() {
                    myOrdersSection.style.display = 'none';
                    document.querySelector('.ar-designers-section').style.display = 'block';
                });
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            setInterval(arCheckNewMessagesClient, 10000);
            arCheckNewMessagesClient(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∑–∞—è–≤–∫–∏
        function arToggleOrderForm(showForm) {
            const formSection = document.querySelector('.ar-order-form-section');
            const designersSection = document.querySelector('.ar-designers-section');
            const myOrdersSection = document.getElementById('arMyOrdersSection');
            
            if (showForm) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤, —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞—è–≤–∫–∏
                if (formSection) formSection.style.display = 'block';
                if (designersSection) designersSection.style.display = 'block';
                if (myOrdersSection) myOrdersSection.style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const newUrl = window.location.pathname + window.location.search.replace(/&?tab=orders/, '');
                window.history.replaceState({}, '', newUrl);
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—è–≤–∫–∏
                if (formSection) formSection.style.display = 'none';
                if (designersSection) designersSection.style.display = 'none';
                if (myOrdersSection) myOrdersSection.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL
                const separator = window.location.search ? '&' : '?';
                const newUrl = window.location.href + separator + 'tab=orders';
                window.history.replaceState({}, '', newUrl);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∑–∞—è–≤–æ–∫
        function arShowMyOrders() {
            arToggleOrderForm(false);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º
        function arBackToDesigners() {
            arToggleOrderForm(true);
        }  
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏ –∑–∞—è–≤–æ–∫ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('tab') === 'orders') {
            arShowMyOrders();
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        window.arShowMyOrders = arShowMyOrders;
        window.arBackToDesigners = arBackToDesigners;
        </script>

        <?php
        return ob_get_clean();
    }
}

/* ========================= –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ========================= */




/**
 * –î–æ–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
 */
function ar_get_designer_package_status_enhanced($user_id) {
    $status = ar_get_designer_package_status($user_id);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if ($status['has_package'] && $status['order_id']) {
        $order = wc_get_order($status['order_id']);
        if ($order) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–º–µ–Ω–µ–Ω –ª–∏ –∑–∞–∫–∞–∑
            if ($order->get_status() == 'cancelled' || $order->get_status() == 'refunded') {
                $status['active'] = false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∞–º–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑–µ
            $has_package_product = false;
            foreach ($order->get_items() as $item) {
                if ($item->get_product_id() == 1634 || $item->get_variation_id() == 1634) {
                    $has_package_product = true;
                    break;
                }
            }
            
            if (!$has_package_product) {
                $status['has_package'] = false;
                $status['active'] = false;
            }
        }
    }
    
    return $status;
}



// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ —Ä–∞–∑–¥–µ–ª —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
if (!function_exists('ar_create_designer_projects_table')) {
    function ar_create_designer_projects_table() {
        global $wpdb;
        
        $charset_collate = $wpdb->get_charset_collate();
        $projects_table = $wpdb->prefix . 'designer_projects';
        
        $sql = "CREATE TABLE IF NOT EXISTS $projects_table (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            project_id varchar(100) NOT NULL,
            designer_id bigint(20) NOT NULL,
            title varchar(255) NOT NULL,
            description text,
            status varchar(50) DEFAULT 'in_progress',
            photos text, -- JSON encoded array of photo URLs
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY project_id (project_id),
            KEY designer_id (designer_id),
            KEY status (status)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);
    }
}

// –î–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
add_action('init', 'ar_create_designer_projects_table');



// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
if (!function_exists('ar_check_client_tables')) {
    function ar_check_client_tables() {
        global $wpdb;
        $orders_table = $wpdb->prefix . 'client_orders';
        
        $table_exists = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) === $orders_table;
        
        if (!$table_exists) {
            return ar_create_client_orders_table();
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        $columns_check = $wpdb->get_results("DESCRIBE $orders_table");
        $existing_columns = [];
        foreach ($columns_check as $column) {
            $existing_columns[] = $column->Field;
        }
        
        $required_columns = [
            'project_name', 'product_type', 'service_type', 'country', 
            'city', 'object_type', 'object_status', 'area'
        ];
        
        $missing_columns = [];
        foreach ($required_columns as $column) {
            if (!in_array($column, $existing_columns)) {
                $missing_columns[] = $column;
            }
        }
        
        if (!empty($missing_columns)) {
            // –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            $wpdb->query("DROP TABLE IF EXISTS $orders_table");
            return ar_create_client_orders_table();
        }
        
        return true;
    }
}



// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —Å–∏—Å—Ç–µ–º—É
if (!function_exists('ar_create_unified_designer_projects_table')) {
    function ar_create_unified_designer_projects_table() {
        global $wpdb;
        
        $charset_collate = $wpdb->get_charset_collate();
        $projects_table = $wpdb->prefix . 'designer_projects';
        
        $sql = "CREATE TABLE IF NOT EXISTS $projects_table (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            project_id varchar(100) NOT NULL,
            designer_id bigint(20) NOT NULL,
            title varchar(255) NOT NULL,
            description text,
            status varchar(50) DEFAULT 'in_progress',
            photos text DEFAULT NULL, -- JSON encoded array of photo URLs
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY project_id (project_id),
            KEY designer_id (designer_id),
            KEY status (status)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        $result = dbDelta($sql);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
        $columns = $wpdb->get_results("DESCRIBE $projects_table");
        $existing_columns = [];
        foreach ($columns as $column) {
            $existing_columns[] = $column->Field;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É photos –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        if (!in_array('photos', $existing_columns)) {
            $wpdb->query("ALTER TABLE $projects_table ADD COLUMN photos text DEFAULT NULL");
        }
        
        return true;
    }
}


// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤
if (!function_exists('ar_create_client_orders_table')) {
    function ar_create_client_orders_table() {
        global $wpdb;
        
        $charset_collate = $wpdb->get_charset_collate();
        $orders_table = $wpdb->prefix . 'client_orders';
        
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –µ—Å—Ç—å
        $wpdb->query("DROP TABLE IF EXISTS $orders_table");
        
        $sql = "CREATE TABLE $orders_table (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            client_id bigint(20) NOT NULL,
            client_name varchar(255) NOT NULL,
            client_email varchar(255) NOT NULL,
            project_name varchar(255) NOT NULL,
            product_type varchar(50) NOT NULL,
            service_type varchar(50) NOT NULL,
            country varchar(100) NOT NULL,
            city varchar(100) NOT NULL,
            object_type varchar(50) NOT NULL,
            style varchar(50) DEFAULT NULL,
            object_status varchar(50) NOT NULL,
            area decimal(10,2) NOT NULL,
            budget decimal(15,2) DEFAULT NULL,
            currency varchar(10) DEFAULT 'RON',
            completion_date date DEFAULT NULL,
            additional_info text,
            selected_designer_id bigint(20) DEFAULT NULL,
            selected_designer_name varchar(255) DEFAULT NULL,
            selected_designer_specialty varchar(255) DEFAULT NULL,
            selected_designer_price varchar(50) DEFAULT NULL,
            status varchar(50) DEFAULT 'pending',
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY client_id (client_id),
            KEY status (status),
            KEY selected_designer_id (selected_designer_id)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        $result = dbDelta($sql);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        $table_created = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) === $orders_table;
        
        if (!$table_created) {
            error_log('Failed to create client_orders table: ' . $wpdb->last_error);
            return false;
        }
        
        return true;
    }
}


/* ========================= –§–£–ù–ö–¶–ò–ò –î–õ–Ø CRM ========================= */

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ CRM –ø–æ ID –∑–∞–∫–∞–∑–∞
// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ CRM
if (!function_exists('ar_get_project_status_by_order_id')) {
    function ar_get_project_status_by_order_id($order_id) {
        global $wpdb;
        
        $crm_table = $wpdb->prefix . 'crm_projects';
        $orders_table = $wpdb->prefix . 'client_orders';
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        $table_exists = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $crm_table));
        
        if (!$table_exists || $table_exists != $crm_table) {
            ar_create_crm_projects_table();
            return false;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç –∏–∑ CRM
        $project = $wpdb->get_row($wpdb->prepare(
            "SELECT p.*, u.display_name as designer_name 
             FROM $crm_table p 
             LEFT JOIN {$wpdb->users} u ON p.designer_id = u.ID 
             WHERE p.order_id = %d 
             LIMIT 1",
            $order_id
        ));
        
        if (!$project) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ —Å –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º
            $order = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $orders_table WHERE id = %d AND status = 'active' AND selected_designer_id IS NOT NULL",
                $order_id
            ));
            
            if ($order) {
                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ CRM –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
                ar_auto_create_crm_project($order_id);
                
                // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                $project = $wpdb->get_row($wpdb->prepare(
                    "SELECT p.*, u.display_name as designer_name 
                     FROM $crm_table p 
                     LEFT JOIN {$wpdb->users} u ON p.designer_id = u.ID 
                     WHERE p.order_id = %d 
                     LIMIT 1",
                    $order_id
                ));
                
                if (!$project) {
                    return false;
                }
            } else {
                return false;
            }
        }
        
        // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤
        $status_map = [
            'new' => ['text' => '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç', 'icon' => 'üìã', 'color' => '#667eea'],
            'in_progress' => ['text' => '–í —Ä–∞–±–æ—Ç–µ', 'icon' => 'üî®', 'color' => '#28a745'],
            'pending' => ['text' => '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏', 'icon' => '‚è≥', 'color' => '#ffc107'],
            'completed' => ['text' => '–ó–∞–≤–µ—Ä—à–µ–Ω', 'icon' => '‚úÖ', 'color' => '#17a2b8'],
            'abandoned' => ['text' => '–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', 'icon' => 'üóëÔ∏è', 'color' => '#dc3545']
        ];
        
        $status_key = $project->status;
        $status_info = isset($status_map[$status_key]) ? $status_map[$status_key] : 
                      ['text' => $status_key, 'icon' => 'üìå', 'color' => '#6c757d'];
        
        return [
            'status_key' => $status_key,
            'status_text' => $status_info['text'],
            'status_icon' => $status_info['icon'],
            'status_color' => $status_info['color'],
            'project_title' => $project->title,
            'designer_name' => $project->designer_name,
            'created_at' => $project->created_at,
            'updated_at' => $project->updated_at
        ];
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã CRM –ø—Ä–æ–µ–∫—Ç–æ–≤
function ar_create_crm_projects_table() {
    global $wpdb;
    
    $charset_collate = $wpdb->get_charset_collate();
    $crm_table = $wpdb->prefix . 'crm_projects';
    
    $sql = "CREATE TABLE IF NOT EXISTS $crm_table (
        id bigint(20) NOT NULL AUTO_INCREMENT,
        order_id bigint(20) NOT NULL,
        project_id varchar(100) DEFAULT '' , 
        title varchar(255) NOT NULL,
        client_id bigint(20) NOT NULL,
        designer_id bigint(20) DEFAULT NULL,
        status varchar(50) DEFAULT 'new',
        description text,
        budget decimal(15,2) DEFAULT NULL,
        currency varchar(10) DEFAULT 'EUR',
        deadline date DEFAULT NULL,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        UNIQUE KEY order_id (order_id),
        KEY project_id (project_id),
        KEY client_id (client_id),
        KEY designer_id (designer_id),
        KEY status (status)
    ) $charset_collate;";
    
    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

// —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ —Å–æ–∑–¥–∞–ª–æ—Å—å / –æ–±–Ω–æ–≤–∏–ª–æ—Å—å
add_action('init', 'ar_create_crm_projects_table');

/* ========================= –ö–û–ù–ï–¶ –í–°–¢–ê–í–ö–ò ========================= */




// –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ä–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞
if (!function_exists('ar_ensure_client_role')) {
    function ar_ensure_client_role($user_id) {
        $user = get_userdata($user_id);
        
        if (!$user) {
            return false;
        }
        
        $roles = $user->roles;
        
        // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ä–æ–ª–µ–π –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Ä–æ–ª—å subscriber
        if (empty($roles) || (count($roles) === 1 && in_array('subscriber', $roles))) {
            $user->set_role('client');
            return true;
        }
        
        // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ä–æ–ª–∏ client, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
        if (!in_array('client', $roles)) {
            $user->add_role('client');
            return true;
        }
        
        return true;
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞
if (!function_exists('ar_create_client_role')) {
    function ar_create_client_role() {
        if (!get_role('client')) {
            add_role('client', 'Client', [
                'read' => true,
                'edit_posts' => false,
                'delete_posts' => false,
                'upload_files' => true
            ]);
        }
    }
}

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
if (!function_exists('ar_get_client_orders_count')) {
    function ar_get_client_orders_count($user_id) {
        global $wpdb;
        $orders_table = $wpdb->prefix . 'client_orders';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
            return 0;
        }
        
        return $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $orders_table WHERE client_id = %d",
            $user_id
        ));
    }
}

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏)
if (!function_exists('ar_client_get_unread_messages_count')) {
    function ar_client_get_unread_messages_count($user_id = null) {
        if (!$user_id) {
            $user_id = get_current_user_id();
        }
        
        if (!$user_id) return 0;
        
        global $wpdb;
        $chat_table = $wpdb->prefix . 'designer_chat_messages';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $chat_table)) != $chat_table) {
            return 0;
        }
        
        $count = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $chat_table WHERE receiver_id = %d AND is_read = 0",
            $user_id
        ));
        
        if ($count === null) {
            error_log('AR_CHAT: Failed to get client unread messages count for user ' . $user_id);
            return 0;
        }
        
        return intval($count);
    }
}

// –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
if (!function_exists('ar_get_designers_cards')) {
    function ar_get_designers_cards($current_page = 1, $per_page = 21) {
        $offset = ($current_page - 1) * $per_page;
        
        $designers = get_users([
            'role__in' => ['administrator', 'editor', 'author', 'contributor', 'subscriber'],
            'number' => $per_page,
            'offset' => $offset,
            'orderby' => 'display_name',
            'order' => 'ASC'
        ]);
        
        if (empty($designers)) {
            return '<div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üé®</div>
                        <h3 style="margin-bottom: 10px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</h3>
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–∑–∂–µ.</p>
                    </div>';
        }
        
        ob_start();
        
        foreach ($designers as $designer) {
            $specialty = get_user_meta($designer->ID, 'ar_designer_specialty', true) ?: '–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞';
            $location = get_user_meta($designer->ID, 'ar_designer_location', true) ?: '–†—É–º—ã–Ω–∏—è';
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ (–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ –≤—Å–µ—Ö –æ—Ü–µ–Ω–æ–∫)
            $rating = ar_calculate_average_rating($designer->ID);
            $reviews = ar_get_designer_reviews_count($designer->ID);
            if ($reviews === 0) {
                $reviews = '52'; // Fallback –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            }
            
            // –ü–û–õ–£–ß–ê–ï–ú –°–¢–û–ò–ú–û–°–¢–¨ –ö–í–ê–î–†–ê–¢–ù–û–ì–û –ú–ï–¢–†–ê –ò–ó –ü–†–û–§–ò–õ–Ø
            $price_per_sqm = get_user_meta($designer->ID, 'price_per_sqm', true);
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (!$price_per_sqm || empty($price_per_sqm)) {
                $old_price = get_user_meta($designer->ID, 'ar_designer_price', true);
                $price_per_sqm = $old_price ?: '10';
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å (–¥–æ–±–∞–≤–ª—è–µ–º –¥–≤–∞ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π)
            if (is_numeric($price_per_sqm)) {
                $formatted_price = number_format(floatval($price_per_sqm), 2, '.', '');
            } else {
                $formatted_price = $price_per_sqm;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            $company_name = get_user_meta($designer->ID, 'company_name', true);
            $city = get_user_meta($designer->ID, 'city', true);
            $country = get_user_meta($designer->ID, 'country', true);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            $full_location = '';
            if ($city && $country) {
                $full_location = $city . ', ' . $country;
            } elseif ($city) {
                $full_location = $city;
            } elseif ($country) {
                $full_location = $country;
            } else {
                $full_location = $location;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
            $phone = get_user_meta($designer->ID, 'phone', true) ?: get_user_meta($designer->ID, 'billing_phone', true);
            
            $avatar_url = get_avatar_url($designer->ID, ['size' => 150]);
            
            // –ü–æ–ª—É—á–∞–µ–º –æ–±–ª–æ–∂–∫—É –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
            $cover_url = ar_get_user_profile_cover($designer->ID);
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
            $designer_data = [
                'id' => $designer->ID,
                'full_name' => $designer->display_name,
                'specialty' => $specialty,
                'price' => $formatted_price,
                'company' => $company_name,
                'location' => $full_location,
                'phone' => $phone
            ];
            ?>
            <div class="ar-designer-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: all 0.3s ease; border: 1px solid #eaeaea;">
                <div class="ar-designer-cover" style="height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%), url('<?php echo esc_url($cover_url); ?>') center/cover no-repeat; position: relative; background-blend-mode: overlay;">
                    <div class="ar-designer-avatar" style="position: absolute; bottom: -30px; left: 20px; width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); background: white;">
                        <img src="<?php echo esc_url($avatar_url); ?>" alt="<?php echo esc_attr($designer->display_name); ?>" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    
                    <!-- –ë–µ–π–¥–∂ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ -->
                    <?php if ($company_name): ?>
                    <div class="ar-company-badge" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.95); padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 600; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        üè¢ <?php echo esc_html($company_name); ?>
                    </div>
                    <?php endif; ?>
                </div>
                
                <div class="ar-designer-content" style="padding: 40px 20px 20px 20px;">
                    <div class="ar-designer-info" style="margin-bottom: 15px;">
                        <h3 style="margin: 0 0 5px 0; font-size: 1.1em; color: #333; font-weight: 700;"><?php echo esc_html($designer->display_name); ?></h3>
                        <p class="ar-designer-specialty" style="color: #667eea; font-weight: 600; margin: 0 0 5px 0; font-size: 0.9em;"><?php echo esc_html($specialty); ?></p>
                        <p class="ar-designer-location" style="color: #666; margin: 0; font-size: 0.8em; display: flex; align-items: center; gap: 4px;">
                            <span>üìç</span>
                            <?php echo esc_html($full_location); ?>
                        </p>
                        
                        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
                        <?php if ($phone): ?>
                        <p class="ar-designer-phone" style="color: #666; margin: 5px 0 0 0; font-size: 0.8em; display: flex; align-items: center; gap: 4px;">
                            <span>üì±</span>
                            <?php echo esc_html($phone); ?>
                        </p>
                        <?php endif; ?>
                    </div>
                    
                    <div class="ar-designer-stats" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px 0; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0;">
                        <div class="ar-designer-price" style="text-align: center;">
                            <span class="ar-price-amount" style="display: block; font-size: 0.9em; font-weight: 700; color: #333;">
                                <?php echo esc_html($formatted_price); ?>‚Ç¨/–º¬≤
                            </span>
                            <span class="ar-price-label" style="font-size: 0.75em; color: #666;">–°—Ç–æ–∏–º–æ—Å—Ç—å –º¬≤</span>
                        </div>
                        
                        <div class="ar-designer-rating" style="text-align: center;">
                            <div class="ar-rating-stars" style="display: flex; align-items: center; justify-content: center; gap: 2px; margin-bottom: 3px; cursor: pointer;" 
                                 data-designer-id="<?php echo $designer->ID; ?>"
                                 onmouseleave="arResetStarHover(this)">
                                <?php 
                                // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–≤—ë–∑–¥—ã –¥–ª—è –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è
                                $current_user_rating = ar_get_client_designer_rating($designer->ID);
                                for ($i = 1; $i <= 5; $i++): 
                                    $is_filled = $i <= floatval($rating);
                                    $is_hoverable = !is_null($current_user_rating) || get_current_user_id();
                                ?>
                                    <span class="ar-star-rating" 
                                          data-rating="<?php echo $i; ?>" 
                                          data-designer-id="<?php echo $designer->ID; ?>"
                                          style="
                                              color: <?php echo $is_filled ? '#ffc107' : '#ddd'; ?>; 
                                              font-size: 1.1em; 
                                              cursor: pointer; 
                                              transition: color 0.2s ease, transform 0.2s ease;
                                          "
                                          onmouseover="arHighlightStars(this)"
                                          onclick="arSubmitDesignerRating(<?php echo $designer->ID; ?>, <?php echo $i; ?>, this)">‚òÖ</span>
                                <?php endfor; ?>
                            </div>
                            <span class="ar-rating-value" style="font-size: 0.9em; font-weight: 700; color: #333;"><?php echo esc_html($rating); ?></span>
                            <span class="ar-rating-count" style="font-size: 0.7em; color: #666;">(<?php echo esc_html($reviews); ?> –æ—Ü–µ–Ω–æ–∫)</span>
                        </div>
                    </div>
                    
                    <div class="ar-designer-actions" style="display: flex; gap: 8px;">
                        <button type="button" class="ar-btn ar-btn-compact ar-btn-primary ar-select-designer" 
                                data-designer-id="<?php echo $designer->ID; ?>" 
                                style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; flex: 1;"
                                onclick="arSelectDesigner(<?php echo $designer->ID; ?>, '<?php echo esc_js($designer_data['full_name']); ?>', '<?php echo esc_js($designer_data['specialty']); ?>', '<?php echo esc_js($designer_data['price']); ?>')">
                            üí¨ –í—ã–±—Ä–∞—Ç—å
                        </button>
                        
                        <button type="button" 
                                class="ar-btn ar-btn-compact ar-btn-secondary ar-view-profile-btn" 
                                onclick="arOpenDesignerProfileModal(<?php echo $designer->ID; ?>)"
                                style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; flex: 1;">
                            üëÅÔ∏è –ü—Ä–æ—Ñ–∏–ª—å
                        </button>
                    </div>
                </div>
            </div>
            <?php
        }
        
        return ob_get_clean();
    }
}

// –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤
if (!function_exists('ar_get_designers_pagination')) {
    function ar_get_designers_pagination($current_page = 1, $per_page = 21) {
        $total_designers = count(get_users([
            'role__in' => ['administrator', 'editor', 'author', 'contributor', 'subscriber']
        ]));
        
        $total_pages = ceil($total_designers / $per_page);
        
        if ($total_pages <= 1) {
            return '';
        }
        
        ob_start();
        
        $start_item = (($current_page - 1) * $per_page) + 1;
        $end_item = min($current_page * $per_page, $total_designers);
        
        echo '<div class="ar-pagination-stats" style="font-size: 0.9em; color: #666;">';
        echo '–ü–æ–∫–∞–∑–∞–Ω–æ ' . $start_item . '-' . $end_item . ' –∏–∑ ' . $total_designers . ' –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤';
        echo '</div>';
        
        echo '<div style="display: flex; gap: 5px; align-items: center;">';
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        if ($current_page > 1) {
            echo '<a href="' . esc_url(add_query_arg('designer_page', $current_page - 1)) . '" class="ar-pagination-item" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; font-size: 0.9em;">‚Äπ</a>';
        }
        
        // –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        $start_page = max(1, $current_page - 2);
        $end_page = min($total_pages, $current_page + 2);
        
        for ($i = $start_page; $i <= $end_page; $i++) {
            $active_class = $i == $current_page ? ' style="background: #667eea; color: white; border-color: #667eea;"' : '';
            echo '<a href="' . esc_url(add_query_arg('designer_page', $i)) . '" class="ar-pagination-item" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; font-size: 0.9em;"' . $active_class . '>' . $i . '</a>';
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
        if ($current_page < $total_pages) {
            echo '<a href="' . esc_url(add_query_arg('designer_page', $current_page + 1)) . '" class="ar-pagination-item" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; font-size: 0.9em;">‚Ä∫</a>';
        }
        
        echo '</div>';
        
        return ob_get_clean();
    }
}

// –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞ —Å —á–∞—Ç–æ–º
// –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞ —Å —á–∞—Ç–æ–º
if (!function_exists('ar_get_client_orders_list')) {
    function ar_get_client_orders_list($user_id) {
        global $wpdb;
        $orders_table = $wpdb->prefix . 'client_orders';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
            return '<div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
                        <h3 style="margin-bottom: 10px;">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</h3>
                        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞.</p>
                    </div>';
        }
        
        $orders = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM $orders_table WHERE client_id = %d ORDER BY created_at DESC",
            $user_id
        ));
        
        if (empty($orders)) {
            return '<div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
                        <h3 style="margin-bottom: 10px;">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</h3>
                        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞.</p>
                    </div>';
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–∏
        $unread_counts = ar_client_get_unread_counts_by_orders($user_id, $orders);
        
        ob_start();
        
        foreach ($orders as $order) {
            $status_text = '–í –æ–∂–∏–¥–∞–Ω–∏–∏';
            $status_color = '#fff3cd';
            $text_color = '#856404';
            
            switch ($order->status) {
                case 'active':
                    $status_text = '–î–∏–∑–∞–π–Ω–µ—Ä –≤–∑—è–ª –≤ —Ä–∞–±–æ—Ç—É';
                    $status_color = '#d4edda';
                    $text_color = '#155724';
                    break;
                case 'completed':
                    $status_text = '–ó–∞–≤–µ—Ä—à–µ–Ω–∞';
                    $status_color = '#d1ecf1';
                    $text_color = '#0c5460';
                    break;
                case 'cancelled':
                    $status_text = '–û—Ç–º–µ–Ω–µ–Ω–∞';
                    $status_color = '#f8d7da';
                    $text_color = '#721c24';
                    break;
            }
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–π –∑–∞—è–≤–∫–∏
            $unread_count = isset($unread_counts[$order->id]) ? $unread_counts[$order->id] : 0;
            
            $designer_info = '';
            if (!empty($order->selected_designer_name)) {
                $designer_info = '<div style="margin-top: 10px; padding: 12px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">üéØ</span>
                                        <strong style="color: #333;">–í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä:</strong>
                                    </div>
                                    <div style="margin-left: 30px;">
                                        <div style="font-weight: 600; color: #667eea;">' . esc_html($order->selected_designer_name) . '</div>' . 
                                        (!empty($order->selected_designer_specialty) ? '<div style="font-size: 0.9em; color: #666; margin-top: 2px;"><em>' . esc_html($order->selected_designer_specialty) . '</em></div>' : '') .
                                    '</div>
                                 </div>';
            } else {
                $designer_info = '<div style="margin-top: 10px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.2em;">üì¢</span>
                                        <strong style="color: #856404;">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º</strong>
                                    </div>
                                    <div style="margin-left: 30px; font-size: 0.9em; color: #856404;">
                                        –û–∂–∏–¥–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –¥–∏–∑–∞–π–Ω–µ—Ä –≤—ã–±–µ—Ä–µ—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É
                                    </div>
                                 </div>';
            }
            ?>
            <div class="ar-order-card" style="background: white; border-radius: 12px; padding: 25px; border: 1px solid #eaeaea; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; transition: all 0.3s ease;">
                <div class="ar-order-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <h3 style="font-size: 1.3em; font-weight: 700; margin: 0 0 5px 0; color: #333;"><?php echo esc_html($order->project_name); ?></h3>
                        <p style="margin: 0; color: #666; font-size: 0.9em;">
                            üìÖ <?php echo date('d.m.Y H:i', strtotime($order->created_at)); ?>
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <?php if ($unread_count > 0 && !empty($order->selected_designer_id)): ?>
                            <span class="ar-unread-badge" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">
                                üí¨ <?php echo $unread_count; ?>
                            </span>
                        <?php endif; ?>
                        <span style="padding: 6px 16px; border-radius: 20px; font-size: 0.8em; font-weight: 600; background: <?php echo $status_color; ?>; color: <?php echo $text_color; ?>;">
                            <?php echo $status_text; ?>
                        </span>
                    </div>
                </div>
                
                <?php echo $designer_info; ?>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">üé® –£—Å–ª—É–≥–∞</div>
                        <div style="font-weight: 600; color: #333; font-size: 0.95em;">
                            <?php 
                            $service_types = [
                                'design_project' => '–î–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç',
                                'design_materials' => '–î–∏–∑–∞–π–Ω + –º–∞—Ç–µ—Ä–∏–∞–ª—ã',
                                'full_service' => '–ü–æ–ª–Ω—ã–π —Å–µ—Ä–≤–∏—Å'
                            ];
                            echo esc_html($service_types[$order->service_type] ?? ucfirst(str_replace('_', ' ', $order->service_type))); 
                            ?>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">üìç –õ–æ–∫–∞—Ü–∏—è</div>
                        <div style="font-weight: 600; color: #333; font-size: 0.95em;">
                            <?php echo esc_html($order->city); ?>, <?php echo esc_html($order->country); ?>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">üìê –ü–ª–æ—â–∞–¥—å</div>
                        <div style="font-weight: 600; color: #333; font-size: 0.95em;"><?php echo esc_html($order->area); ?> –º¬≤</div>
                    </div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">üí∞ –ë—é–¥–∂–µ—Ç</div>
                        <div style="font-weight: 600; color: #333; font-size: 0.95em;">
                            <?php if ($order->budget): ?>
                                <?php echo number_format($order->budget, 0, ',', '.'); ?> <?php echo esc_html($order->currency); ?>
                            <?php else: ?>
                                –ù–µ —É–∫–∞–∑–∞–Ω
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
                
                <?php if ($order->additional_info): ?>
                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px; font-weight: 600;">üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</div>
                    <p style="margin: 0; color: #333; line-height: 1.5; font-size: 0.9em;"><?php echo esc_html($order->additional_info); ?></p>
                </div>
                <?php endif; ?>
                
                <?php
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ CRM
                $project_status = ar_get_project_status_by_order_id($order->id);

                if ($project_status): ?>
                <div style="margin-top: 15px; padding: 12px; background: <?php echo $project_status['status_color']; ?>10; border-radius: 8px; border-left: 4px solid <?php echo $project_status['status_color']; ?>;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <span style="font-size: 1.2em;"><?php echo $project_status['status_icon']; ?></span>
                        <div>
                            <strong style="color: #333;">–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –≤ CRM:</strong>
                            <span style="color: <?php echo $project_status['status_color']; ?>; font-weight: 600; margin-left: 5px;">
                                <?php echo $project_status['status_text']; ?>
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-left: 30px; font-size: 0.9em; color: #555;">
                        <?php if ($project_status['project_title']): ?>
                            <div style="margin-bottom: 3px;">
                                <strong>–ü—Ä–æ–µ–∫—Ç:</strong> <?php echo esc_html($project_status['project_title']); ?>
                            </div>
                        <?php endif; ?>
                        
                        <?php if ($project_status['designer_name']): ?>
                            <div style="margin-bottom: 3px;">
                                <strong>–î–∏–∑–∞–π–Ω–µ—Ä CRM:</strong> <?php echo esc_html($project_status['designer_name']); ?>
                            </div>
                        <?php endif; ?>
                        
                        <?php if ($project_status['created_at']): ?>
                            <div>
                                <strong>–°–æ–∑–¥–∞–Ω:</strong> <?php echo date('d.m.Y H:i', strtotime($project_status['created_at'])); ?>
                            </div>
                        <?php endif; ?>
                    </div>
                </div>
                <?php endif; ?>

                <!-- –ë–ª–æ–∫ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
                <!-- –ó–∞–º–µ–Ω–∏—Ç–µ –±–ª–æ–∫ —Å —Ñ–æ—Ç–æ –Ω–∞ —ç—Ç–æ—Ç: -->
<div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <span style="font-size: 1.2em;">üì∏</span>
        <strong style="color: #333;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç:</strong>
    </div>
    <div style="margin-left: 30px;">
        <?php
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç CRM
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç CRM
$crm_project = ar_get_crm_project_by_order_id($order->id);

if ($crm_project && !empty($crm_project->project_id)) {
    // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ designer_projects
    $project_photos = ar_get_project_photos_for_client($crm_project->project_id);
    
    if (!empty($project_photos) && is_array($project_photos)): ?>
        <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <span style="font-size: 1.2em;">üì∏</span>
                <strong style="color: #333;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç:</strong>
                <span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600;">
                    <?php echo count($project_photos); ?> —Ñ–æ—Ç–æ
                </span>
            </div>
            <div style="margin-left: 30px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                    <?php foreach ($project_photos as $index => $photo): ?>
                        <?php if (!empty($photo['url'])): ?>
                        <div style="position: relative; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <a href="<?php echo esc_url($photo['large'] ?: $photo['url']); ?>" 
                               target="_blank" 
                               style="display: block;"
                               title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ">
                                <img src="<?php echo esc_url($photo['thumbnail'] ?: $photo['url']); ?>" 
                                     alt="–§–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞ <?php echo $index + 1; ?>" 
                                     style="width: 100%; height: 120px; object-fit: cover; display: block;">
                                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0); transition: background 0.3s ease;">
                                </div>
                            </a>
                            <div style="padding: 8px; background: white; font-size: 11px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                <?php echo esc_html($photo['name'] ?? '–§–æ—Ç–æ ' . ($index + 1)); ?>
                            </div>
                        </div>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top: 10px;">
                    <em>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ</em>
                </div>
            </div>
        </div>
    <?php else: ?>
        <div style="margin-top: 15px; padding: 12px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #6c757d;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <span style="font-size: 1.2em;">üì∑</span>
                <div>
                    <strong style="color: #333;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞:</strong>
                    <div style="font-size: 0.9em; color: #666;">
                        –î–∏–∑–∞–π–Ω–µ—Ä –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
                    </div>
                </div>
            </div>
        </div>
    <?php endif;
} else { ?>
    <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2em;">üîÑ</span>
            <div>
                <strong style="color: #856404;">–ü—Ä–æ–µ–∫—Ç –≤ —Ä–∞–±–æ—Ç–µ</strong>
                <div style="font-size: 0.9em; color: #856404;">
                    –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º
                </div>
            </div>
        </div>
    </div>
<?php } ?>
    </div>
</div>
                
                <!-- –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="ar-order-actions" style="display: flex; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eaeaea; flex-wrap: wrap;">
                    <?php if (!empty($order->selected_designer_id)): ?>
                        <button type="button" 
                                class="ar-btn-chat" 
                                onclick="arOpenClientChat(<?php echo $order->id; ?>, <?php echo $order->selected_designer_id; ?>, '<?php echo esc_js($order->selected_designer_name); ?>')"
                                style="padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; position: relative;">
                            üí¨ –ß–∞—Ç —Å –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º
                            <?php if ($unread_count > 0): ?>
                                <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; margin-left: 8px; min-width: 20px; text-align: center;">
                                    <?php echo $unread_count; ?>
                                </span>
                            <?php endif; ?>
                        </button>
                        
                        <button type="button" onclick="arViewOrderDetails(<?php echo $order->id; ?>)" 
                                style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
                            üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        
                    <?php else: ?>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button type="button" 
                                    disabled
                                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-weight: 600; display: flex; align-items: center; gap: 8px; opacity: 0.6;">
                                üí¨ –ß–∞—Ç (–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞)
                            </button>
                            
                            <button type="button" onclick="arViewOrderDetails(<?php echo $order->id; ?>)" 
                                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                        </div>
                    <?php endif; ?>
                </div>
                
                <!-- –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) -->
                <div id="order-details-<?php echo $order->id; ?>" class="modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #333; font-size: 1.4em;">–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ #<?php echo $order->id; ?></h3>
                            <button type="button" onclick="document.getElementById('order-details-<?php echo $order->id; ?>').style.display = 'none'" 
                                    style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">√ó</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                            <div>
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em; border-bottom: 2px solid #667eea; padding-bottom: 5px;">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <p style="margin: 0;"><strong>üë§ –ö–ª–∏–µ–Ω—Ç:</strong> <?php echo esc_html($order->client_name); ?></p>
                                    <p style="margin: 0;"><strong>üìß Email:</strong> <?php echo esc_html($order->client_email); ?></p>
                                    <p style="margin: 0;"><strong>üìã –ü—Ä–æ–µ–∫—Ç:</strong> <?php echo esc_html($order->project_name); ?></p>
                                    <p style="margin: 0;"><strong>üéØ –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞:</strong> <?php echo $order->product_type === 'design' ? '–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞' : '–ú–µ–±–µ–ª—å –Ω–∞ –∑–∞–∫–∞–∑'; ?></p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em; border-bottom: 2px solid #667eea; padding-bottom: 5px;">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <p style="margin: 0;"><strong>üè† –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</strong> <?php echo esc_html(ucfirst($order->object_type)); ?></p>
                                    <p style="margin: 0;"><strong>üîß –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞:</strong> <?php echo esc_html(ucfirst($order->object_status)); ?></p>
                                    <p style="margin: 0;"><strong>üé® –°—Ç–∏–ª—å:</strong> <?php echo $order->style ? esc_html(ucfirst($order->style)) : '–ù–µ —É–∫–∞–∑–∞–Ω'; ?></p>
                                    <p style="margin: 0;"><strong>üìÖ –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:</strong> <?php echo $order->completion_date ? date('d.m.Y', strtotime($order->completion_date)) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'; ?></p>
                                </div>
                            </div>
                        </div>
                        
                        <?php if ($order->additional_info): ?>
                        <div>
                            <h4 style="color: #333; margin-bottom: 10px; font-size: 1.1em; border-bottom: 2px solid #667eea; padding-bottom: 5px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                            <p style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.5; margin: 0;"><?php echo nl2br(esc_html($order->additional_info)); ?></p>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            <?php
        }
        
        return ob_get_clean();
    }
}



/**
 * –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–µ–∫—Ç CRM –ø–æ ID –∑–∞–∫–∞–∑–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ project_id)
 */
if (!function_exists('ar_get_crm_project_by_order_id')) {
    function ar_get_crm_project_by_order_id($order_id) {
        global $wpdb;
        $crm_table = $wpdb->prefix . 'crm_projects';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        $table_exists = $wpdb->get_var($wpdb->prepare(
            "SHOW TABLES LIKE %s",
            $crm_table
        )) === $crm_table;
        
        if (!$table_exists) {
            ar_create_crm_projects_table();
            return false;
        }
        
        $project = $wpdb->get_row($wpdb->prepare(
            "SELECT p.*, u.display_name as designer_name 
             FROM $crm_table p 
             LEFT JOIN {$wpdb->users} u ON p.designer_id = u.ID 
             WHERE p.order_id = %d 
             LIMIT 1",
            $order_id
        ));
        
        if (!$project) {
            return false;
        }
        
        // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –µ—Å—Ç—å, –Ω–æ –ø—É—Å—Ç–∞—è, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å id
        if (empty($project->project_id) && isset($project->id)) {
            $project->project_id = $project->id;
        }
        
        // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤
        $status_map = [
            'new'         => ['text' => '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',        'icon' => 'üìã', 'color' => '#667eea'],
            'in_progress' => ['text' => '–í —Ä–∞–±–æ—Ç–µ',            'icon' => 'üî®', 'color' => '#28a745'],
            'pending'     => ['text' => '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏',     'icon' => '‚è≥', 'color' => '#ffc107'],
            'completed'   => ['text' => '–ó–∞–≤–µ—Ä—à–µ–Ω',            'icon' => '‚úÖ', 'color' => '#17a2b8'],
            'abandoned'   => ['text' => '–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π',       'icon' => 'üóëÔ∏è', 'color' => '#dc3545'],
        ];
        
        $status_key  = $project->status;
        $status_info = isset($status_map[$status_key]) ? $status_map[$status_key] :
            ['text' => $status_key, 'icon' => 'üìå', 'color' => '#6c757d'];
        
        return [
            'status_key'    => $status_key,
            'status_text'   => $status_info['text'],
            'status_icon'   => $status_info['icon'],
            'status_color'  => $status_info['color'],
            'project_title' => $project->title,
            'designer_name' => $project->designer_name,
            'created_at'    => $project->created_at,
            'updated_at'    => $project->updated_at,
            'project_id'    => $project->project_id, // —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
        ];
    }
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
 */
if (!function_exists('ar_get_project_photos_for_client')) {
    function ar_get_project_photos_for_client($project_id) {
        global $wpdb;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã designer_projects
        $projects_table = $wpdb->prefix . 'designer_projects';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            "SHOW TABLES LIKE %s",
            $projects_table
        )) === $projects_table;
        
        if (!$table_exists) {
            // –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ—ë
            ar_create_unified_designer_projects_table();
            return [];
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ designer_projects
        $project = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $projects_table WHERE project_id = %s",
            $project_id
        ));
        
        if (!$project) {
            return [];
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ –ø–æ–ª—è photos (JSON encoded)
        $photos = [];
        if (!empty($project->photos)) {
            $photos_data = json_decode($project->photos, true);
            if (is_array($photos_data)) {
                $photos = $photos_data;
            }
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ –¥–ª—è –≤—ã–≤–æ–¥–∞
        $formatted_photos = [];
        foreach ($photos as $photo) {
            if (is_array($photo)) {
                // –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –º–∞—Å—Å–∏–≤–∞
                $formatted_photos[] = [
                    'url' => $photo['url'] ?? '',
                    'thumbnail' => $photo['thumbnail'] ?? $photo['url'] ?? '',
                    'large' => $photo['large'] ?? $photo['url'] ?? '',
                    'name' => $photo['name'] ?? basename($photo['url'] ?? '')
                ];
            } elseif (is_string($photo)) {
                // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å URL
                $formatted_photos[] = [
                    'url' => $photo,
                    'thumbnail' => $photo,
                    'large' => $photo,
                    'name' => basename($photo)
                ];
            }
        }
        
        return $formatted_photos;
    }
}


// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∑–∞—è–≤–∫–∞–º
if (!function_exists('ar_client_get_unread_counts_by_orders')) {
    function ar_client_get_unread_counts_by_orders($user_id, $orders) {
        global $wpdb;
        $chat_table = $wpdb->prefix . 'designer_chat_messages';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $chat_table)) != $chat_table) {
            return [];
        }
        
        $order_ids = array_map(function($order) {
            return $order->id;
        }, $orders);
        
        if (empty($order_ids)) {
            return [];
        }
        
        $placeholders = implode(',', array_fill(0, count($order_ids), '%d'));
        $query = $wpdb->prepare(
            "SELECT order_id, COUNT(*) as unread_count 
             FROM $chat_table 
             WHERE receiver_id = %d AND is_read = 0 AND order_id IN ($placeholders)
             GROUP BY order_id",
            array_merge([$user_id], $order_ids)
        );
        
        $results = $wpdb->get_results($query, OBJECT_K);
        
        $unread_counts = [];
        foreach ($orders as $order) {
            $unread_counts[$order->id] = isset($results[$order->id]) ? $results[$order->id]->unread_count : 0;
        }
        
        return $unread_counts;
    }
}

/**
 * –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
 */
function ar_add_designer_profile_modal() {
    ?>
    <div id="arDesignerProfileModal" class="ar-modal" style="display: none;">
        <div class="ar-modal-content" style="max-width: 90%; max-height: 90vh; width: 1200px;">
            <div class="ar-modal-header">
                <h2>üë®‚Äçüé® –ü—Ä–æ—Ñ–∏–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞</h2>
                <button class="ar-modal-close" onclick="arCloseDesignerProfileModal()">√ó</button>
            </div>
            <div class="ar-modal-body" id="arDesignerProfileContent" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ AJAX -->
            </div>
        </div>
    </div>



<script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    let currentDesignerProfileId = null;
    
    function arOpenDesignerProfileModal(designerId) {
        currentDesignerProfileId = designerId;
        const modal = document.getElementById('arDesignerProfileModal');
        const content = document.getElementById('arDesignerProfileContent');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        content.innerHTML = '<div style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ AJAX
        fetch('<?php echo admin_url("admin-ajax.php"); ?>?action=ar_get_designer_profile_ajax&designer_id=' + designerId)
            .then(response => response.text())
            .then(html => {
                content.innerHTML = html;
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –∏ –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                arInitDesignerProfileModal();
            })
            .catch(error => {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</div>';
            });
    }
    
    function arCloseDesignerProfileModal() {
        document.getElementById('arDesignerProfileModal').style.display = 'none';
        document.body.style.overflow = '';
        currentDesignerProfileId = null;
    }
    
    function arInitDesignerProfileModal() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è
        const modal = document.getElementById('arDesignerProfileModal');
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                arCloseDesignerProfileModal();
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        const selectBtn = document.querySelector('#arDesignerProfileContent .ar-select-designer-btn');
        if (selectBtn) {
            selectBtn.addEventListener('click', function() {
                const designerId = currentDesignerProfileId;
                const designerName = this.getAttribute('data-designer-name');
                const designerSpecialty = this.getAttribute('data-designer-specialty');
                const designerPrice = this.getAttribute('data-designer-price');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('ar_selected_designer', JSON.stringify({
                    id: designerId,
                    name: designerName,
                    specialty: designerSpecialty,
                    price: designerPrice
                }));
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                arCloseDesignerProfileModal();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                alert('üéØ –î–∏–∑–∞–π–Ω–µ—Ä ' + designerName + ' –≤—ã–±—Ä–∞–Ω! –¢–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∑–∞—è–≤–∫–∏.');
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ –∑–∞—è–≤–∫–∏
                const orderForm = document.querySelector('.ar-order-form-section');
                if (orderForm) {
                    orderForm.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            arCloseDesignerProfileModal();
        }
    });
    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    
    </script>
    <?php
}
add_action('wp_footer', 'ar_add_designer_profile_modal');



















// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞
add_action('wp_ajax_ar_check_project_status', 'ar_check_project_status');
add_action('wp_ajax_nopriv_ar_check_project_status', 'ar_check_project_status');

function ar_check_project_status() {
    if (!isset($_GET['order_id']) || empty($_GET['order_id'])) {
        wp_send_json_error('Order ID is required');
    }
    
    $order_id = intval($_GET['order_id']);
    $project_status = ar_get_project_status_by_order_id($order_id);
    
    if ($project_status) {
        wp_send_json_success([
            'status' => $project_status['status_key'],
            'status_text' => $project_status['status_text'],
            'status_icon' => $project_status['status_icon'],
            'status_color' => $project_status['status_color'],
            'project_title' => $project_status['project_title'],
            'designer_name' => $project_status['designer_name'],
            'created_at' => $project_status['created_at']
        ]);
    } else {
        wp_send_json_success([
            'status' => 'not_created',
            'status_text' => '–ü—Ä–æ–µ–∫—Ç –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω –≤ CRM',
            'status_icon' => '‚è≥',
            'status_color' => '#6c757d'
        ]);
    }
}






/**
 * AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
 */
add_action('wp_ajax_ar_get_designer_profile_ajax', 'ar_ajax_get_designer_profile');
add_action('wp_ajax_nopriv_ar_get_designer_profile_ajax', 'ar_ajax_get_designer_profile');
function ar_ajax_get_designer_profile() {
    $designer_id = isset($_GET['designer_id']) ? intval($_GET['designer_id']) : 0;
    
    if (!$designer_id) {
        echo '<div class="ar-error-message">–î–∏–∑–∞–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
        wp_die();
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π —à–æ—Ä—Ç–∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    echo do_shortcode('[ar_designer_full_profile designer_id="' . $designer_id . '"]');
    
    wp_die();
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–µ –∑–∞–∫–∞–∑–∞
 */
function ar_update_order_form_script() {
    ?>
    <script>
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    function arSelectDesignerUpdated(designerId, designerName, designerSpecialty, designerPrice) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        selectedDesigner = {
            id: designerId,
            name: designerName,
            specialty: designerSpecialty,
            price: designerPrice
        };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('selected_designer_id').value = designerId;
        arUpdateSelectedDesignerDisplay();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è
        const confirmed = confirm(
            `üéØ –í—ã –≤—ã–±—Ä–∞–ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–∞: ${designerName}\n\n` +
            `üíº –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ${designerSpecialty}\n` +
            `üí∞ –¶–µ–Ω–∞: ${designerPrice}\n\n` +
            `–•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞—è–≤–∫–∏?`
        );
        
        if (confirmed) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è
            if (typeof arOpenDesignerProfileModal === 'function') {
                arOpenDesignerProfileModal(designerId);
            }
        }
    }
    
    // –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    window.arSelectDesigner = arSelectDesignerUpdated;
    </script>
    <?php
}
add_action('wp_footer', 'ar_update_order_form_script');

/* ========================= AJAX –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ========================= */

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞
add_action('wp_ajax_ar_submit_client_order', 'ar_ajax_submit_client_order');
add_action('wp_ajax_nopriv_ar_submit_client_order', 'ar_ajax_submit_client_order');
function ar_ajax_submit_client_order() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_client_order_nonce')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
        wp_die(); // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    $user_id = get_current_user_id();
    $current_user = wp_get_current_user();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    $required_fields = [
        'project_name' => '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞',
        'service_type' => '–¢–∏–ø —É—Å–ª—É–≥–∏',
        'country' => '–°—Ç—Ä–∞–Ω–∞',
        'city' => '–ì–æ—Ä–æ–¥',
        'object_type' => '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞',
        'object_status' => '–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞',
        'area' => '–ü–ª–æ—â–∞–¥—å'
    ];
    
    foreach ($required_fields as $field => $label) {
        if (empty($_POST[$field])) {
            wp_send_json_error('–ü–æ–ª–µ "' . $label . '" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.');
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è —Å —É—Å–ª–æ–≤–∏—è–º–∏
    if (!isset($_POST['agree_terms'])) {
        wp_send_json_error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è–º–∏.');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
    $project_name = sanitize_text_field($_POST['project_name']);
    if (strlen($project_name) < 10) {
        wp_send_json_error('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤.');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–æ—â–∞–¥–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏ –±–æ–ª—å—à–µ 0)
    $area = floatval($_POST['area']);
    if ($area <= 0 || $area > 10000) {
        wp_send_json_error('–ü–ª–æ—â–∞–¥—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 10000 –º¬≤.');
    }
    
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
    $order_data = [
        'client_id' => $user_id,
        'client_name' => $current_user->display_name,
        'client_email' => $current_user->user_email,
        'project_name' => $project_name,
        'product_type' => sanitize_text_field($_POST['product_type'] ?? 'design'),
        'service_type' => sanitize_text_field($_POST['service_type']),
        'country' => sanitize_text_field($_POST['country']),
        'city' => sanitize_text_field($_POST['city']),
        'object_type' => sanitize_text_field($_POST['object_type']),
        'style' => !empty($_POST['style']) ? sanitize_text_field($_POST['style']) : null,
        'object_status' => sanitize_text_field($_POST['object_status']),
        'area' => $area,
        'budget' => !empty($_POST['budget']) ? floatval($_POST['budget']) : null,
        'currency' => !empty($_POST['currency']) ? sanitize_text_field($_POST['currency']) : 'RON',
        'completion_date' => !empty($_POST['completion_date']) ? sanitize_text_field($_POST['completion_date']) : null,
        'additional_info' => !empty($_POST['additional_info']) ? sanitize_textarea_field($_POST['additional_info']) : null,
        'status' => 'pending'
    ];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∑–∞–π–Ω–µ—Ä–µ
    if (!empty($_POST['selected_designer_id'])) {
        $designer_id = intval($_POST['selected_designer_id']);
        $designer = get_userdata($designer_id);
        
        if ($designer) {
            $order_data['selected_designer_id'] = $designer_id;
            $order_data['selected_designer_name'] = !empty($_POST['selected_designer_name']) ? 
                sanitize_text_field($_POST['selected_designer_name']) : $designer->display_name;
            $order_data['selected_designer_specialty'] = !empty($_POST['selected_designer_specialty']) ? 
                sanitize_text_field($_POST['selected_designer_specialty']) : '–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞';
            $order_data['selected_designer_price'] = !empty($_POST['selected_designer_price']) ? 
                sanitize_text_field($_POST['selected_designer_price']) : '10';
        }
    }
    
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    $result = $wpdb->insert($orders_table, $order_data);
    
    if ($result === false) {
        error_log('Database error: ' . $wpdb->last_error);
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: ' . $wpdb->last_error);
    }
    
    $order_id = $wpdb->insert_id;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    ar_handle_order_files($order_id);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    ar_send_order_notifications($order_id, $order_data);
    
    wp_send_json_success('–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
    wp_die(); // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω—Ü–µ
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞
if (!function_exists('ar_handle_order_files')) {
    function ar_handle_order_files($order_id) {
        if (!function_exists('wp_handle_upload')) {
            require_once(ABSPATH . 'wp-admin/includes/file.php');
        }
        
        $file_types = [
            'photos' => 'photos',
            'drawings' => 'drawings', 
            'inspiration_photos' => 'inspiration_photos'
        ];
        
        foreach ($file_types as $file_type => $field_name) {
            if (!empty($_FILES[$field_name]) && is_array($_FILES[$field_name]['name'])) {
                $files = $_FILES[$field_name];
                
                foreach ($files['name'] as $key => $value) {
                    if ($files['error'][$key] === 0) {
                        $file = [
                            'name' => $files['name'][$key],
                            'type' => $files['type'][$key],
                            'tmp_name' => $files['tmp_name'][$key],
                            'error' => $files['error'][$key],
                            'size' => $files['size'][$key]
                        ];
                        
                        $upload = wp_handle_upload($file, ['test_form' => false]);
                        
                        if (!isset($upload['error'])) {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                            add_post_meta($order_id, '_order_' . $file_type, $upload['url']);
                        }
                    }
                }
            }
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
if (!function_exists('ar_send_order_notifications')) {
    function ar_send_order_notifications($order_id, $order_data) {
        $admin_email = get_option('admin_email');
        $subject = '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –¥–∏–∑–∞–π–Ω - Art Rocket';
        
        $message = "
        <h2>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –¥–∏–∑–∞–π–Ω</h2>
        <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> {$order_data['client_name']} ({$order_data['client_email']})</p>
        <p><strong>–ü—Ä–æ–µ–∫—Ç:</strong> {$order_data['project_name']}</p>
        ";
        
        if (!empty($order_data['selected_designer_name'])) {
            $message .= "<p><strong>üéØ –í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä:</strong> {$order_data['selected_designer_name']}";
            if (!empty($order_data['selected_designer_specialty'])) {
                $message .= " ({$order_data['selected_designer_specialty']})";
            }
            $message .= "</p>";
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –¥–∏–∑–∞–π–Ω–µ—Ä—É
            if (!empty($order_data['selected_designer_id'])) {
                $designer = get_userdata($order_data['selected_designer_id']);
                if ($designer && !empty($designer->user_email)) {
                    $designer_subject = '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –≤—ã–±—Ä–∞–ª–∞ –≤–∞—Å - Art Rocket';
                    $designer_message = "
                    <h2>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –≤—ã–±—Ä–∞–ª–∞ –≤–∞—Å</h2>
                    <p>–ö–ª–∏–µ–Ω—Ç <strong>{$order_data['client_name']}</strong> –≤—ã–±—Ä–∞–ª –≤–∞—Å –¥–ª—è —Å–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.</p>
                    <p><strong>–ü—Ä–æ–µ–∫—Ç:</strong> {$order_data['project_name']}</p>
                    <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π email:</strong> {$order_data['client_email']}</p>
                    <p><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {$order_data['city']}, {$order_data['country']}</p>
                    <p><strong>–ü–ª–æ—â–∞–¥—å:</strong> {$order_data['area']} –º¬≤</p>
                    ";
                    
                    if (!empty($order_data['additional_info'])) {
                        $designer_message .= "<p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> {$order_data['additional_info']}</p>";
                    }
                    
                    $designer_message .= "<p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>";
                    
                    $headers = ['Content-Type: text/html; charset=UTF-8'];
                    wp_mail($designer->user_email, $designer_subject, $designer_message, $headers);
                }
            }
        } else {
            $message .= "<p><strong>üì¢ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º</strong></p>";
        }
        
        $message .= "
        <p><strong>–£—Å–ª—É–≥–∞:</strong> " . ucfirst(str_replace('_', ' ', $order_data['service_type'])) . "</p>
        <p><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {$order_data['city']}, {$order_data['country']}</p>
        <p><strong>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</strong> " . ucfirst($order_data['object_type']) . "</p>
        <p><strong>–ü–ª–æ—â–∞–¥—å:</strong> {$order_data['area']} –º¬≤</p>
        <p><strong>–ë—é–¥–∂–µ—Ç:</strong> " . ($order_data['budget'] ? number_format($order_data['budget'], 0, ',', '.') . ' ' . $order_data['currency'] : '–ù–µ —É–∫–∞–∑–∞–Ω') . "</p>
        <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> " . date('d.m.Y H:i') . "</p>
        ";
        
        if (!empty($order_data['additional_info'])) {
            $message .= "<p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> {$order_data['additional_info']}</p>";
        }
        
        $headers = ['Content-Type: text/html; charset=UTF-8'];
        wp_mail($admin_email, $subject, $message, $headers);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
        $client_subject = '–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ - Art Rocket';
        $client_message = "
        <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É!</h2>
        <p>–ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à—É –∑–∞—è–≤–∫—É –Ω–∞ –¥–∏–∑–∞–π–Ω –∏ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
        <p><strong>–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏:</strong></p>
        <ul>
            <li><strong>–ü—Ä–æ–µ–∫—Ç:</strong> {$order_data['project_name']}</li>
            <li><strong>–£—Å–ª—É–≥–∞:</strong> " . ucfirst(str_replace('_', ' ', $order_data['service_type'])) . "</li>
            <li><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {$order_data['city']}, {$order_data['country']}</li>
            <li><strong>–ü–ª–æ—â–∞–¥—å:</strong> {$order_data['area']} –º¬≤</li>
        </ul>
        ";
        
        if (!empty($order_data['selected_designer_name'])) {
            $client_message .= "<p><strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä:</strong> {$order_data['selected_designer_name']}</p>";
        }
        
        $client_message .= "<p>–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏.</p>";
        
        wp_mail($order_data['client_email'], $client_subject, $client_message, $headers);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤
if (!function_exists('ar_create_client_orders_page')) {
    function ar_create_client_orders_page() {
        $page_title = 'ComandƒÉ Design';
        $page_content = '[ar_client_orders]';
        
        $page = get_page_by_title($page_title);
        
        if (!$page) {
            $page_data = array(
                'post_title'    => $page_title,
                'post_content'  => $page_content,
                'post_status'   => 'publish',
                'post_type'     => 'page',
                'post_author'   => 1,
                'post_name'     => 'zakazdizain'
            );
            
            $page_id = wp_insert_post($page_data);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞-–ø–æ–ª–µ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤
            if ($page_id && !is_wp_error($page_id)) {
                update_post_meta($page_id, '_ar_client_orders_page', 'true');
            }
        } else {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            $page_data = array(
                'ID'           => $page->ID,
                'post_content' => $page_content,
                'post_status'  => 'publish'
            );
            wp_update_post($page_data);
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
function ar_order_system_activation() {
    ar_create_client_role();
    ar_create_client_orders_table();
    ar_create_client_orders_page();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    flush_rewrite_rules();
}

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü (–≤—ã–∑–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –æ–¥–∏–Ω —Ä–∞–∑ —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É)
add_action('init', 'ar_check_and_fix_tables');
function ar_check_and_fix_tables() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
    ar_check_client_tables();
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö—É–∫–æ–≤ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
register_activation_hook(__FILE__, 'ar_order_system_activation');

/* ========= CUSTOM AUTH + ORDER SYSTEM END ========= */













/* ========= –ü–†–û–§–ò–õ–ò –î–ò–ó–ê–ô–ù–ï–†–û–í ========= */

// –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
function ar_create_designer_profile_page() {
    $page_title = '–ü—Ä–æ—Ñ–∏–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞';
    $page_content = '[ar_designer_profile]';
    
    $page = get_page_by_title($page_title);
    
    if (!$page) {
        $page_data = array(
            'post_title'    => $page_title,
            'post_content'  => $page_content,
            'post_status'   => 'publish',
            'post_type'     => 'page',
            'post_author'   => 1,
            'post_name'     => 'designer'
        );
        
        $page_id = wp_insert_post($page_data);
        
        if ($page_id) {
            error_log("ARTROCKET: Successfully created designer profile page with ID: " . $page_id);
            return $page_id;
        }
    }
    
    return $page ? $page->ID : false;
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∞–∫—Ç–∏–≤–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã
add_action('init', function() {
    if (is_admin() && get_option('ar_designer_profile_page_created') !== 'yes') {
        ar_create_designer_profile_page();
        update_option('ar_designer_profile_page_created', 'yes');
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–∏–∑–∞–π–Ω–µ—Ä–∞
/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–∏–∑–∞–π–Ω–µ—Ä–∞ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
 */
function ar_get_designer_full_profile($user_id) {
    if (!$user_id) {
        return false;
    }
    
    $user = get_userdata($user_id);
    if (!$user) {
        return false;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $designer_data = array(
        'id' => $user_id,
        'user_login' => $user->user_login,
        'user_email' => $user->user_email,
        'display_name' => $user->display_name,
        'registered' => $user->user_registered,
        'role' => !empty($user->roles[0]) ? $user->roles[0] : 'client',
    );
    
    // === –õ–ò–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===
    $designer_data['personal'] = array(
        'first_name' => get_user_meta($user_id, 'first_name', true),
        'last_name' => get_user_meta($user_id, 'last_name', true),
        'full_name' => '',
        'phone' => '',
        'phone_code' => get_user_meta($user_id, 'phone_code', true),
        'phone_number' => get_user_meta($user_id, 'phone_number', true),
        'phone_full' => get_user_meta($user_id, 'phone_full', true),
        'city' => get_user_meta($user_id, 'city', true),
        'country' => get_user_meta($user_id, 'country', true),
        'address' => get_user_meta($user_id, 'address', true),
        'birth_date' => get_user_meta($user_id, 'birth_date', true),
    );
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è
    if (!empty($designer_data['personal']['first_name']) || !empty($designer_data['personal']['last_name'])) {
        $designer_data['personal']['full_name'] = trim($designer_data['personal']['first_name'] . ' ' . $designer_data['personal']['last_name']);
    } else {
        $designer_data['personal']['full_name'] = $designer_data['display_name'];
    }
    
    // –¢–µ–ª–µ—Ñ–æ–Ω (–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è)
    $phone_fields = ['phone', 'billing_phone', 'user_phone', 'mobile', 'mobile_phone'];
    foreach ($phone_fields as $field) {
        $phone = get_user_meta($user_id, $field, true);
        if (!empty($phone) && empty($designer_data['personal']['phone'])) {
            $designer_data['personal']['phone'] = $phone;
        }
    }
    
    // === –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===
    $designer_data['professional'] = array(
        'specialty' => get_user_meta($user_id, 'ar_designer_specialty', true) ?: 
                      get_user_meta($user_id, 'specialty', true) ?: '–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞',
        'experience' => get_user_meta($user_id, 'ar_designer_experience', true) ?: 
                       get_user_meta($user_id, 'experience', true) ?: '5+ –ª–µ—Ç',
        'education' => get_user_meta($user_id, 'ar_designer_education', true) ?: 
                      get_user_meta($user_id, 'education', true),
        'certifications' => get_user_meta($user_id, 'ar_designer_certifications', true) ?: 
                          get_user_meta($user_id, 'certifications', true),
        'about' => get_user_meta($user_id, 'ar_designer_about', true) ?: 
                  get_user_meta($user_id, 'description', true) ?: 
                  get_user_meta($user_id, 'bio', true),
        'styles' => array(),
        'services' => array(),
        'portfolio_count' => get_user_meta($user_id, 'ar_projects_completed', true) ?: 
                           get_user_meta($user_id, 'projects_completed', true) ?: 0,
    );
    
    // –°—Ç–∏–ª–∏ —Ä–∞–±–æ—Ç—ã
    $styles = get_user_meta($user_id, 'ar_designer_styles', true);
    if (!empty($styles)) {
        if (is_string($styles)) {
            $designer_data['professional']['styles'] = array_map('trim', explode(',', $styles));
        } elseif (is_array($styles)) {
            $designer_data['professional']['styles'] = $styles;
        }
    }
    
    // –£—Å–ª—É–≥–∏
    $services = get_user_meta($user_id, 'ar_designer_services', true);
    if (!empty($services)) {
        if (is_string($services)) {
            $designer_data['professional']['services'] = array_map('trim', explode(',', $services));
        } elseif (is_array($services)) {
            $designer_data['professional']['services'] = $services;
        }
    }
    
    // === –¶–ï–ù–´ –ò –¢–ê–†–ò–§–´ ===
    $designer_data['pricing'] = array(
        'price_per_sqm' => get_user_meta($user_id, 'ar_designer_price', true) ?: 
                          get_user_meta($user_id, 'price_per_sqm', true) ?: '10',
        'currency' => '‚Ç¨',
        'hourly_rate' => get_user_meta($user_id, 'hourly_rate', true),
        'project_min_price' => get_user_meta($user_id, 'project_min_price', true),
        'package_prices' => get_user_meta($user_id, 'package_prices', true),
    );
    
    // === –†–ï–ô–¢–ò–ù–ì –ò –û–¢–ó–´–í–´ ===
    $designer_data['rating'] = array(
        'average' => get_user_meta($user_id, 'ar_designer_rating', true) ?: 
                    get_user_meta($user_id, 'rating', true) ?: '5.0',
        'reviews_count' => get_user_meta($user_id, 'ar_designer_reviews', true) ?: 
                          get_user_meta($user_id, 'reviews_count', true) ?: 0,
        'projects_completed' => get_user_meta($user_id, 'ar_projects_completed', true) ?: 
                              get_user_meta($user_id, 'projects_completed', true) ?: 0,
        'active_projects' => get_user_meta($user_id, 'ar_active_projects', true) ?: 
                            get_user_meta($user_id, 'active_projects', true) ?: 0,
    );
    
    // === –°–û–¶–ò–ê–õ–¨–ù–´–ï –°–ï–¢–ò ===
    $designer_data['social'] = array(
        'linkedin' => get_user_meta($user_id, 'linkedin', true),
        'facebook' => get_user_meta($user_id, 'facebook', true),
        'instagram' => get_user_meta($user_id, 'instagram', true),
        'pinterest' => get_user_meta($user_id, 'pinterest', true),
        'behance' => get_user_meta($user_id, 'behance', true),
        'website' => get_user_meta($user_id, 'website', true),
    );
    
    // === –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–û–ú–ü–ê–ù–ò–ò ===
    $designer_data['company'] = array(
        'company_name' => get_user_meta($user_id, 'company_name', true),
        'fiscal_code' => get_user_meta($user_id, 'fiscal_code', true),
        'vat_registered' => get_user_meta($user_id, 'vat_registered', true),
        'vat_code' => get_user_meta($user_id, 'vat_code', true),
        'registration_number' => get_user_meta($user_id, 'registration_number', true),
        'company_address' => get_user_meta($user_id, 'company_address', true),
    );
    
    // === –ë–ê–ù–ö–û–í–°–ö–ò–ï –†–ï–ö–í–ò–ó–ò–¢–´ ===
    $designer_data['banking'] = array(
        'iban' => get_user_meta($user_id, 'iban', true),
        'bank_name' => get_user_meta($user_id, 'bank_name', true),
        'bank_code' => get_user_meta($user_id, 'bank_code', true),
        'account_holder' => get_user_meta($user_id, 'account_holder', true),
        'bank_address' => get_user_meta($user_id, 'bank_address', true),
        'swift_code' => get_user_meta($user_id, 'swift_code', true),
    );
    
    // === –ü–û–†–¢–§–û–õ–ò–û –ò –ì–ê–õ–ï–†–ï–Ø ===
    $designer_data['portfolio'] = array(
        'images' => array(),
        'projects' => array(),
        'total_images' => 0,
    );
    
    // –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    $portfolio_images = get_user_meta($user_id, 'ar_portfolio_images', true);
    if (!empty($portfolio_images)) {
        if (is_string($portfolio_images)) {
            $designer_data['portfolio']['images'] = array_map('trim', explode(',', $portfolio_images));
        } elseif (is_array($portfolio_images)) {
            $designer_data['portfolio']['images'] = $portfolio_images;
        }
    }
    $designer_data['portfolio']['total_images'] = count($designer_data['portfolio']['images']);
    
    // –ü—Ä–æ–µ–∫—Ç—ã –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
    $portfolio_projects = get_user_meta($user_id, 'ar_portfolio_projects', true);
    if (!empty($portfolio_projects)) {
        if (is_string($portfolio_projects)) {
            $designer_data['portfolio']['projects'] = json_decode($portfolio_projects, true);
        } elseif (is_array($portfolio_projects)) {
            $designer_data['portfolio']['projects'] = $portfolio_projects;
        }
    }
    
    // === –ê–í–ê–¢–ê–† ===
    $avatar_url = get_avatar_url($user_id, array('size' => 300));
    if (empty($avatar_url) || strpos($avatar_url, 'gravatar.com/avatar/') !== false) {
        $custom_avatar = get_user_meta($user_id, 'ar_profile_avatar', true);
        if (!empty($custom_avatar)) {
            $avatar_url = $custom_avatar;
        } else {
            $avatar_url = 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-1.2.1&auto=format&fit=crop&w=300&q=80';
        }
    }
    $designer_data['avatar_url'] = $avatar_url;
    
    // === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–ê–î–ê–ù–ù–´–ï ===
    $designer_data['metadata'] = array(
        'registration_date' => get_user_meta($user_id, 'registration_date', true),
        'last_login' => get_user_meta($user_id, 'last_login', true),
        'email_verified' => get_user_meta($user_id, 'email_verified', true),
        'phone_verified' => get_user_meta($user_id, 'phone_verified', true),
        'profile_completion' => get_user_meta($user_id, 'profile_completion', true),
        'is_online' => (get_user_meta($user_id, 'is_online', true) == '1') ? true : false,
    );
    
    // === –ö–û–ù–¢–ê–ö–¢–´ –î–õ–Ø –ö–õ–ò–ï–ù–¢–û–í ===
    $designer_data['contacts'] = array(
        'email_for_clients' => get_user_meta($user_id, 'email_for_clients', true) ?: $designer_data['user_email'],
        'phone_for_clients' => get_user_meta($user_id, 'phone_for_clients', true) ?: $designer_data['personal']['phone'],
        'telegram' => get_user_meta($user_id, 'telegram', true),
        'whatsapp' => get_user_meta($user_id, 'whatsapp', true),
        'viber' => get_user_meta($user_id, 'viber', true),
        'skype' => get_user_meta($user_id, 'skype', true),
    );
    
    // === –†–ê–ë–û–ß–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ ===
    $designer_data['work_params'] = array(
        'min_project_size' => get_user_meta($user_id, 'min_project_size', true),
        'max_project_size' => get_user_meta($user_id, 'max_project_size', true),
        'work_regions' => get_user_meta($user_id, 'work_regions', true),
        'languages' => get_user_meta($user_id, 'languages', true),
        'response_time' => get_user_meta($user_id, 'response_time', true),
        'availability' => get_user_meta($user_id, 'availability', true),
    );
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    $filled_fields = 0;
    $total_fields = 0;
    
    foreach ($designer_data as $section => $fields) {
        if (is_array($fields)) {
            foreach ($fields as $field => $value) {
                $total_fields++;
                if (!empty($value)) {
                    $filled_fields++;
                }
            }
        }
    }
    
    $designer_data['profile_completion_percentage'] = $total_fields > 0 ? round(($filled_fields / $total_fields) * 100) : 0;
    
    return $designer_data;
}

/**
 * –®–æ—Ä—Ç–∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
 */
add_shortcode('ar_designer_full_profile', 'ar_render_designer_full_profile');
function ar_render_designer_full_profile($atts) {
    $atts = shortcode_atts(array(
        'designer_id' => 0,
        'show_private' => false, // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        'compact' => false, // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
    ), $atts);
    
    $designer_id = intval($atts['designer_id']);
    if (!$designer_id && isset($_GET['designer_id'])) {
        $designer_id = intval($_GET['designer_id']);
    }
    
    if (!$designer_id) {
        return '<div class="ar-error-message">–î–∏–∑–∞–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–∫–∞–∂–∏—Ç–µ ID –¥–∏–∑–∞–π–Ω–µ—Ä–∞.</div>';
    }
    
    $designer_data = ar_get_designer_full_profile($designer_id);
    if (!$designer_data) {
        return '<div class="ar-error-message">–î–∏–∑–∞–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>';
    }
    
    $is_admin = current_user_can('manage_options');
    $is_designer_self = (get_current_user_id() == $designer_id);
    $show_private = $atts['show_private'] || $is_admin || $is_designer_self;
    
    ob_start();
    ?>
    
    <style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞ */
    .ar-full-profile {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
    }
    
    .ar-profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 50px 40px;
        border-radius: 15px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    }
    
    .ar-profile-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        z-index: 0;
    }
    
    .ar-profile-header-content {
        display: flex;
        align-items: center;
        gap: 40px;
        position: relative;
        z-index: 2;
    }
    
    .ar-profile-avatar-large {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        border: 6px solid rgba(255, 255, 255, 0.4);
        overflow: hidden;
        flex-shrink: 0;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        transition: transform 0.3s ease;
    }
    
    .ar-profile-avatar-large:hover {
        transform: scale(1.05);
    }
    
    .ar-profile-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .ar-profile-header-info {
        flex: 1;
    }
    
    .ar-profile-name {
        font-size: 2.8em;
        margin: 0 0 10px 0;
        font-weight: 700;
        letter-spacing: -0.5px;
    }
    
    .ar-profile-specialty {
        font-size: 1.3em;
        opacity: 0.95;
        margin-bottom: 20px;
        font-weight: 500;
    }
    
    .ar-profile-stats-row {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    
    .ar-stat-item-large {
        text-align: center;
    }
    
    .ar-stat-value-large {
        display: block;
        font-size: 2.2em;
        font-weight: 700;
        line-height: 1;
        letter-spacing: -1px;
    }
    
    .ar-stat-label-large {
        font-size: 0.95em;
        opacity: 0.85;
        margin-top: 8px;
        font-weight: 500;
    }
    
    .ar-profile-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }
    
    .ar-profile-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #eaeaea;
        transition: all 0.3s ease;
    }
    
    .ar-profile-section:hover {
        box-shadow: 0 8px 35px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }
    
    .ar-profile-section h3 {
        color: #333;
        margin-top: 0;
        margin-bottom: 22px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        font-size: 1.4em;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
    }
    
    .ar-profile-section h3 span {
        font-size: 1.3em;
    }
    
    .ar-field-group {
        margin-bottom: 22px;
    }
    
    .ar-field-group:last-child {
        margin-bottom: 0;
    }
    
    .ar-field-label {
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
        display: block;
        font-size: 0.95em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.85em;
    }
    
    .ar-field-value {
        color: #333;
        padding: 12px 16px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        word-break: break-word;
        line-height: 1.6;
    }
    
    .ar-field-value.empty {
        color: #999;
        font-style: italic;
    }
    
    .ar-styles-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
    }
    
    .ar-style-tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .ar-style-tag:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .ar-social-links {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .ar-social-link {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 1.2em;
    }
    
    .ar-social-link:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .ar-social-link.linkedin { background: linear-gradient(135deg, #0077B5 0%, #005885 100%); }
    .ar-social-link.facebook { background: linear-gradient(135deg, #1877F2 0%, #0A66C2 100%); }
    .ar-social-link.instagram { background: linear-gradient(135deg, #E4405F 0%, #D81B60 100%); }
    .ar-social-link.pinterest { background: linear-gradient(135deg, #BD081C 0%, #A30019 100%); }
    .ar-social-link.behance { background: linear-gradient(135deg, #0057FF 0%, #0041CC 100%); }
    .ar-social-link.website { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
    
    .ar-portfolio-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }
    
    .ar-portfolio-item {
        border-radius: 10px;
        overflow: hidden;
        aspect-ratio: 4/3;
        border: 1px solid #eaeaea;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    
    .ar-portfolio-item:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        transform: translateY(-4px);
    }
    
    .ar-portfolio-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
    }
    
    .ar-portfolio-item:hover img {
        transform: scale(1.08);
    }
    
    .ar-private-info {
        background: linear-gradient(135deg, #fff3cd 0%, #fffbeb 100%);
        border: 2px solid #ffeaa7;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        border-left: 5px solid #ff9800;
    }
    
    .ar-private-info h4 {
        color: #856404;
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
    }
    
    .ar-contact-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    
    .ar-contact-btn {
        padding: 14px 28px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 1em;
    }
    
    .ar-contact-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .ar-contact-btn.primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
    }
    
    .ar-contact-btn.secondary {
        background: #6c757d;
        color: white;
    }
    
    .ar-contact-btn.secondary:hover {
        background: #5a6268;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .ar-contact-btn:hover {
        transform: translateY(-3px);
    }
    
    .ar-online-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.9em;
        font-weight: 600;
        margin-left: 15px;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
    }
    
    .ar-online-status.online {
        background: rgba(40, 167, 69, 0.25);
        color: #e6ffe6;
    }
    
    .ar-online-status.offline {
        background: rgba(108, 117, 125, 0.25);
        color: #d4d4d8;
    }
    
    .ar-profile-completion {
        background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }
    
    .ar-completion-bar {
        height: 12px;
        background: #e9ecef;
        border-radius: 6px;
        margin-top: 12px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .ar-completion-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
        transition: width 0.5s ease;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.4);
    }
    
    @media (max-width: 1024px) {
        .ar-profile-sections {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .ar-profile-header {
            padding: 30px 20px;
        }
        
        .ar-profile-header-content {
            flex-direction: column;
            text-align: center;
            gap: 25px;
        }
        
        .ar-profile-name {
            font-size: 2em;
        }
        
        .ar-profile-specialty {
            font-size: 1.1em;
        }
        
        .ar-profile-stats-row {
            justify-content: center;
            gap: 25px;
        }
        
        .ar-profile-sections {
            grid-template-columns: 1fr;
        }
        
        .ar-contact-buttons {
            flex-direction: column;
        }
        
        .ar-contact-btn {
            width: 100%;
        }
        
        .ar-portfolio-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
        
        .ar-full-profile {
            padding: 15px;
        }
    }
    
    @media (max-width: 480px) {
        .ar-profile-header {
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .ar-profile-avatar-large {
            width: 120px;
            height: 120px;
        }
        
        .ar-profile-name {
            font-size: 1.6em;
            margin-bottom: 8px;
        }
        
        .ar-profile-specialty {
            font-size: 0.95em;
            margin-bottom: 15px;
        }
        
        .ar-stat-value-large {
            font-size: 1.6em;
        }
        
        .ar-stat-label-large {
            font-size: 0.8em;
        }
        
        .ar-profile-sections {
            gap: 15px;
        }
        
        .ar-profile-section {
            padding: 20px;
        }
        
        .ar-profile-section h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .ar-contact-btn {
            padding: 12px 20px;
            font-size: 0.9em;
        }
    }
    </style>
    
    <div class="ar-full-profile">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="ar-profile-header">
            <div class="ar-profile-header-content">
                <div class="ar-profile-avatar-large">
                    <img src="<?php echo esc_url($designer_data['avatar_url']); ?>" 
                         alt="<?php echo esc_attr($designer_data['personal']['full_name']); ?>">
                </div>
                
                <div class="ar-profile-header-info">
                    <h1 class="ar-profile-name">
                        <?php echo esc_html($designer_data['personal']['full_name']); ?>
                        <?php if ($designer_data['metadata']['is_online']): ?>
                            <span class="ar-online-status online">üü¢ –í —Å–µ—Ç–∏</span>
                        <?php else: ?>
                            <span class="ar-online-status offline">‚ö´ –ù–µ –≤ —Å–µ—Ç–∏</span>
                        <?php endif; ?>
                    </h1>
                    
                    <div class="ar-profile-specialty">
                        üé® <?php echo esc_html($designer_data['professional']['specialty']); ?>
                    </div>
                    
                    <div class="ar-profile-stats-row">
                        <div class="ar-stat-item-large">
                            <span class="ar-stat-value-large"><?php echo esc_html($designer_data['rating']['average']); ?>‚òÖ</span>
                            <span class="ar-stat-label-large">–†–µ–π—Ç–∏–Ω–≥</span>
                        </div>
                        
                        <div class="ar-stat-item-large">
                            <span class="ar-stat-value-large"><?php echo esc_html($designer_data['rating']['reviews_count']); ?></span>
                            <span class="ar-stat-label-large">–û—Ç–∑—ã–≤–æ–≤</span>
                        </div>
                        
                        <div class="ar-stat-item-large">
                            <span class="ar-stat-value-large"><?php echo esc_html($designer_data['rating']['projects_completed']); ?>+</span>
                            <span class="ar-stat-label-large">–ü—Ä–æ–µ–∫—Ç–æ–≤</span>
                        </div>
                        
                        <div class="ar-stat-item-large">
                            <span class="ar-stat-value-large"><?php echo esc_html($designer_data['professional']['experience']); ?></span>
                            <span class="ar-stat-label-large">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="ar-profile-completion">
            <strong>–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ <?php echo $designer_data['profile_completion_percentage']; ?>%</strong>
            <div class="ar-completion-bar">
                <div class="ar-completion-fill" style="width: <?php echo $designer_data['profile_completion_percentage']; ?>%"></div>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è -->
<div class="ar-profile-sections">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <section class="ar-profile-section">
        <h3><span>üë§</span> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        
        <div class="ar-field-group">
            <span class="ar-field-label">–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['personal']['full_name']); ?>
            </div>
        </div>
        
        <div class="ar-field-group">
            <span class="ar-field-label">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['professional']['specialty']); ?>
            </div>
        </div>
        
        <div class="ar-field-group">
            <span class="ar-field-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['professional']['experience']); ?>
            </div>
        </div>
        
        <div class="ar-field-group">
            <span class="ar-field-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
            <div class="ar-field-value">
                <?php 
                $location_parts = [];
                if (!empty($designer_data['personal']['city'])) $location_parts[] = $designer_data['personal']['city'];
                if (!empty($designer_data['personal']['country'])) $location_parts[] = $designer_data['personal']['country'];
                echo esc_html(implode(', ', $location_parts) ?: '–ù–µ —É–∫–∞–∑–∞–Ω–æ'); 
                ?>
            </div>
        </div>
        
        <?php if (!empty($designer_data['work_params']['work_regions'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–†–µ–≥–∏–æ–Ω—ã —Ä–∞–±–æ—Ç—ã</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['work_params']['work_regions']); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['work_params']['languages'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–Ø–∑—ã–∫–∏</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['work_params']['languages']); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['professional']['styles'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–°—Ç–∏–ª–∏ —Ä–∞–±–æ—Ç—ã</span>
            <div class="ar-styles-list">
                <?php foreach ($designer_data['professional']['styles'] as $style): ?>
                    <?php if (!empty($style)): ?>
                        <span class="ar-style-tag"><?php echo esc_html($style); ?></span>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        </div>
        <?php endif; ?>
    </section>
    
    <!-- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã -->
    <section class="ar-profile-section">
        <h3><span>üéì</span> –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
        
        <?php if (!empty($designer_data['professional']['education'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</span>
            <div class="ar-field-value">
                <?php echo nl2br(esc_html($designer_data['professional']['education'])); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['professional']['certifications'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</span>
            <div class="ar-field-value">
                <?php echo nl2br(esc_html($designer_data['professional']['certifications'])); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['professional']['about'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–û —Å–µ–±–µ</span>
            <div class="ar-field-value">
                <?php echo nl2br(esc_html($designer_data['professional']['about'])); ?>
            </div>
        </div>
        <?php endif; ?>
    </section>
    
    <!-- –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã -->
    <section class="ar-profile-section">
        <h3><span>üí∞</span> –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã</h3>
        
        <?php if (!empty($designer_data['professional']['services'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ —É—Å–ª—É–≥–∏</span>
            <div class="ar-field-value">
                <ul style="margin: 0; padding-left: 20px;">
                    <?php foreach ($designer_data['professional']['services'] as $service): ?>
                        <?php if (!empty($service)): ?>
                            <li><?php echo esc_html($service); ?></li>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </ul>
            </div>
        </div>
        <?php endif; ?>
        
        <div class="ar-field-group">
            <span class="ar-field-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥</span>
            <div class="ar-field-value">
                <strong><?php echo esc_html($designer_data['pricing']['price_per_sqm']); ?><?php echo esc_html($designer_data['pricing']['currency']); ?></strong> –∑–∞ –º¬≤
            </div>
        </div>
        
        <?php if (!empty($designer_data['pricing']['hourly_rate'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['pricing']['hourly_rate']); ?><?php echo esc_html($designer_data['pricing']['currency']); ?> / —á–∞—Å
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['pricing']['project_min_price'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['pricing']['project_min_price']); ?><?php echo esc_html($designer_data['pricing']['currency']); ?>
            </div>
        </div>
        <?php endif; ?>
    </section>
    
    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <section class="ar-profile-section">
        <h3><span>üìû</span> –ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
        
        <div class="ar-field-group">
            <span class="ar-field-label">Email –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
            <div class="ar-field-value">
                <a href="mailto:<?php echo esc_attr($designer_data['contacts']['email_for_clients']); ?>">
                    <?php echo esc_html($designer_data['contacts']['email_for_clients']); ?>
                </a>
            </div>
        </div>
        
        <?php if (!empty($designer_data['contacts']['phone_for_clients'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏</span>
            <div class="ar-field-value">
                <a href="tel:<?php echo esc_attr(preg_replace('/[^0-9+]/', '', $designer_data['contacts']['phone_for_clients'])); ?>">
                    <?php echo esc_html($designer_data['contacts']['phone_for_clients']); ?>
                </a>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['contacts']['whatsapp'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">WhatsApp</span>
            <div class="ar-field-value">
                <a href="https://wa.me/<?php echo esc_attr(preg_replace('/[^0-9]/', '', $designer_data['contacts']['whatsapp'])); ?>" target="_blank">
                    <?php echo esc_html($designer_data['contacts']['whatsapp']); ?>
                </a>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['contacts']['telegram'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">Telegram</span>
            <div class="ar-field-value">
                <a href="https://t.me/<?php echo esc_attr(ltrim($designer_data['contacts']['telegram'], '@')); ?>" target="_blank">
                    @<?php echo esc_html(ltrim($designer_data['contacts']['telegram'], '@')); ?>
                </a>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['contacts']['viber'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">Viber</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['contacts']['viber']); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['contacts']['skype'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">Skype</span>
            <div class="ar-field-value">
                <a href="skype:<?php echo esc_attr($designer_data['contacts']['skype']); ?>?call">
                    <?php echo esc_html($designer_data['contacts']['skype']); ?>
                </a>
            </div>
        </div>
        <?php endif; ?>
        
        <div class="ar-field-group">
            <span class="ar-field-label">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</span>
            <div class="ar-social-links">
                <?php if (!empty($designer_data['social']['linkedin'])): ?>
                    <a href="<?php echo esc_url($designer_data['social']['linkedin']); ?>" 
                       target="_blank" 
                       class="ar-social-link linkedin" 
                       title="LinkedIn">
                        in
                    </a>
                <?php endif; ?>
                
                <?php if (!empty($designer_data['social']['facebook'])): ?>
                    <a href="<?php echo esc_url($designer_data['social']['facebook']); ?>" 
                       target="_blank" 
                       class="ar-social-link facebook" 
                       title="Facebook">
                        f
                    </a>
                <?php endif; ?>
                
                <?php if (!empty($designer_data['social']['instagram'])): ?>
                    <a href="<?php echo esc_url($designer_data['social']['instagram']); ?>" 
                       target="_blank" 
                       class="ar-social-link instagram" 
                       title="Instagram">
                        üì∑
                    </a>
                <?php endif; ?>
                
                <?php if (!empty($designer_data['social']['pinterest'])): ?>
                    <a href="<?php echo esc_url($designer_data['social']['pinterest']); ?>" 
                       target="_blank" 
                       class="ar-social-link pinterest" 
                       title="Pinterest">
                        P
                    </a>
                <?php endif; ?>
                
                <?php if (!empty($designer_data['social']['behance'])): ?>
                    <a href="<?php echo esc_url($designer_data['social']['behance']); ?>" 
                       target="_blank" 
                       class="ar-social-link behance" 
                       title="Behance">
                        B
                    </a>
                <?php endif; ?>
                
                <?php if (!empty($designer_data['social']['website'])): ?>
                    <a href="<?php echo esc_url($designer_data['social']['website']); ?>" 
                       target="_blank" 
                       class="ar-social-link website" 
                       title="–í–µ–±-—Å–∞–π—Ç">
                        üåê
                    </a>
                <?php endif; ?>
            </div>
        </div>
    </section>
    
    <!-- –ë–∏–∑–Ω–µ—Å-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <?php if (!empty($designer_data['company']['company_name']) || !empty($designer_data['banking']['iban'])): ?>
    <section class="ar-profile-section">
        <h3><span>üè¢</span> –ë–∏–∑–Ω–µ—Å-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        
        <?php if (!empty($designer_data['company']['company_name'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–ö–æ–º–ø–∞–Ω–∏—è</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['company']['company_name']); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['company']['fiscal_code'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–§–∏—Å–∫–∞–ª—å–Ω—ã–π –∫–æ–¥</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['company']['fiscal_code']); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['company']['vat_code'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–ö–æ–¥ –ù–î–°</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['company']['vat_code']); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['company']['registration_number'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['company']['registration_number']); ?>
            </div>
        </div>
        <?php endif; ?>
        
        <?php if (!empty($designer_data['banking']['iban'])): ?>
        <div class="ar-field-group">
            <span class="ar-field-label">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</span>
            <div class="ar-field-value">
                <?php echo esc_html($designer_data['banking']['iban']); ?>
                <?php if (!empty($designer_data['banking']['bank_name'])): ?>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        –ë–∞–Ω–∫: <?php echo esc_html($designer_data['banking']['bank_name']); ?>
                        <?php if (!empty($designer_data['banking']['account_holder'])): ?>
                            <br>–í–ª–∞–¥–µ–ª–µ—Ü: <?php echo esc_html($designer_data['banking']['account_holder']); ?>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>
            </div>
        </div>
        <?php endif; ?>
    </section>
    <?php endif; ?>
</div>

<!-- –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
<?php if (!empty($designer_data['portfolio']['images'])): ?>
<section class="ar-profile-section" style="grid-column: 1 / -1;">
    <h3><span>üì∏</span> –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ (<?php echo $designer_data['portfolio']['total_images']; ?> —Ä–∞–±–æ—Ç)</h3>
    <div class="ar-portfolio-grid">
        <?php 
        $portfolio_images = array_slice($designer_data['portfolio']['images'], 0, 12);
        foreach ($portfolio_images as $image_url): 
            if (filter_var($image_url, FILTER_VALIDATE_URL)):
        ?>
        <div class="ar-portfolio-item">
            <img src="<?php echo esc_url($image_url); ?>" 
                 alt="–†–∞–±–æ—Ç–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ <?php echo esc_attr($designer_data['personal']['full_name']); ?>"
                 loading="lazy">
        </div>
        <?php 
            endif;
        endforeach; 
        ?>
    </div>
    
    <?php if (count($designer_data['portfolio']['images']) > 12): ?>
    <div style="text-align: center; margin-top: 20px;">
        <button type="button" 
                onclick="alert('–í –ø–æ–ª–Ω–æ–º –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ ' + <?php echo count($designer_data['portfolio']['images']); ?> + ' —Ä–∞–±–æ—Ç')"
                style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–∞–±–æ—Ç—ã (<?php echo count($designer_data['portfolio']['images']); ?>)
        </button>
    </div>
    <?php endif; ?>
</section>
<?php endif; ?>

<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="ar-contact-buttons">
    <a href="/zakazdizain/?select_designer=<?php echo $designer_id; ?>" 
       class="ar-contact-btn primary">
        üéØ –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    </a>
    
    <a href="mailto:<?php echo esc_attr($designer_data['contacts']['email_for_clients']); ?>" 
       class="ar-contact-btn secondary">
        ‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞ email
    </a>
    
    <?php if (!empty($designer_data['contacts']['phone_for_clients'])): ?>
    <a href="tel:<?php echo esc_attr(preg_replace('/[^0-9+]/', '', $designer_data['contacts']['phone_for_clients'])); ?>" 
       class="ar-contact-btn secondary">
        üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å
    </a>
    <?php endif; ?>
    
    <?php if (!empty($designer_data['contacts']['whatsapp'])): ?>
    <a href="https://wa.me/<?php echo esc_attr(preg_replace('/[^0-9]/', '', $designer_data['contacts']['whatsapp'])); ?>" 
       target="_blank" 
       class="ar-contact-btn secondary">
        üí¨ WhatsApp
    </a>
    <?php endif; ?>
</div>
    
    <script>
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –≤ localStorage
    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤—ã–±—Ä–∞—Ç—å —ç—Ç–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('select_designer')) {
            const designerId = <?php echo $designer_id; ?>;
            const designerName = '<?php echo esc_js($designer_data['personal']['full_name']); ?>';
            const designerSpecialty = '<?php echo esc_js($designer_data['professional']['specialty']); ?>';
            const designerPrice = '<?php echo esc_js($designer_data['pricing']['price_per_sqm'] . $designer_data['pricing']['currency']); ?>/–º¬≤';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('ar_selected_designer', JSON.stringify({
                id: designerId,
                name: designerName,
                specialty: designerSpecialty,
                price: designerPrice
            }));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            setTimeout(function() {
                alert('üéØ –î–∏–∑–∞–π–Ω–µ—Ä ' + designerName + ' –≤—ã–±—Ä–∞–Ω! –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–∫–∞–∑–∞.');
                window.location.href = '/zakazdizain/';
            }, 500);
        }
    });
    </script>
    
    <?php
    
    return ob_get_clean();
}




// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
function ar_check_designer_fields($user_id) {
    $fields = [
        'phone' => '–¢–µ–ª–µ—Ñ–æ–Ω',
        'specialty' => '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å',
        'experience' => '–û–ø—ã—Ç',
        'location' => '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
        'price' => '–¶–µ–Ω–∞',
        'rating' => '–†–µ–π—Ç–∏–Ω–≥',
        'reviews' => '–û—Ç–∑—ã–≤—ã',
        'about' => '–û–ø–∏—Å–∞–Ω–∏–µ',
        'education' => '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
        'certifications' => '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã',
        'styles' => '–°—Ç–∏–ª–∏'
    ];
    
    $missing = [];
    $designer = ar_get_designer_extended_data($user_id);
    
    foreach ($fields as $key => $label) {
        if (empty($designer[$key])) {
            $missing[] = $label;
        }
    }
    
    return $missing;
}

// Shortcode –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∏–∑–∞–π–Ω–µ—Ä–∞
add_shortcode('ar_check_designer', function($atts) {
    if (!current_user_can('manage_options')) {
        return '';
    }
    
    $atts = shortcode_atts(['id' => 0], $atts);
    $designer_id = intval($atts['id']);
    
    if (!$designer_id) {
        return '–£–∫–∞–∂–∏—Ç–µ ID –¥–∏–∑–∞–π–Ω–µ—Ä–∞: [ar_check_designer id="1"]';
    }
    
    $designer = ar_get_designer_extended_data($designer_id);
    $missing = ar_check_designer_fields($designer_id);
    
    ob_start();
    ?>
    <div style="background: #f8f9fa; padding: 20px; border-radius: 5px;">
        <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∏–∑–∞–π–Ω–µ—Ä–∞ ID: <?php echo $designer_id; ?></h3>
        
        <?php if (!empty($missing)): ?>
        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <h4>–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è:</h4>
            <ul>
                <?php foreach ($missing as $field): ?>
                <li><?php echo $field; ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
        <?php endif; ?>
        
        <h4>–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:</h4>
        <table style="width: 100%; border-collapse: collapse;">
            <?php foreach ($designer as $key => $value): ?>
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd; background: #e9ecef; font-weight: bold;"><?php echo $key; ?></td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <?php 
                    if (is_array($value)) {
                        echo implode(', ', $value);
                    } else {
                        echo $value;
                    }
                    ?>
                </td>
            </tr>
            <?php endforeach; ?>
        </table>
        
        <p style="margin-top: 20px;">
            <a href="?designer_id=<?php echo $designer_id; ?>&debug=1" target="_blank" style="color: #007bff;">
                –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å –æ—Ç–ª–∞–¥–∫–æ–π
            </a>
        </p>
    </div>
    <?php
    return ob_get_clean();
});























































/* ========================= –®–û–†–¢–ö–û–î –ö–ù–û–ü–ö–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò/–í–´–•–û–î–ê ========================= */
add_shortcode('ar_auth_button', function($atts) {
    if (!is_user_logged_in()) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Google –≤—Ö–æ–¥–∞ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
        if (function_exists('ar_is_social_provider_available') && ar_is_social_provider_available('google')) {
            $current_url = home_url($_SERVER['REQUEST_URI']);
            return do_shortcode('[nextend_social_login provider="google" redirect="' . esc_url($current_url) . '"]');
        } else {
            return '<a href="' . esc_url(wp_login_url(home_url($_SERVER['REQUEST_URI']))) . '" class="custom-auth-btn">–í–æ–π—Ç–∏ —Å Google</a>';
        }
    } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
        $user = wp_get_current_user();
        $display_name = $user->display_name ?: $user->user_login;
        
        $logout_url = wp_logout_url(home_url($_SERVER['REQUEST_URI']));
        $logout_url = wp_nonce_url($logout_url, 'log-out');
        
        return '<a href="' . esc_url($logout_url) . '" class="custom-auth-btn" onclick="return confirm(\'Sunte»õi sigur cƒÉ dori»õi sƒÉ vƒÉ deconecta»õi?\')">–í—ã–π—Ç–∏ (' . esc_html($display_name) . ')</a>';
    }
});


/* ========================= –®–û–†–¢–ö–û–î –ö–ù–û–ü–ö–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò/–í–´–•–û–î–ê END ========================= */


/* ========================= –®–û–†–¢–ö–û–î –î–õ–Ø –î–ò–ó–ê–ô–ù–ï–†–û–í –° –ß–ê–¢–û–ú –ò –ü–†–û–í–ï–†–ö–û–ô –ü–ê–ö–ï–¢–ê ========================= */

add_shortcode('ar_designer_orders', 'ar_designer_orders_shortcode');

function ar_designer_orders_shortcode($atts) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
    if (!ar_check_client_tables() || !ar_check_chat_table()) {
        return '<div style="text-align: center; padding: 40px; color: #dc3545;">
                    <h3>–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞</h3>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                </div>';
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!is_user_logged_in()) {
        return '<div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîí</div>
                    <h3 style="margin-bottom: 10px;">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–æ–∫.</p>
                    ' . wp_login_form(array('echo' => false)) . '
                </div>';
    }
    
    $current_user = wp_get_current_user();
    $user_id = $current_user->ID;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º
    $is_designer = in_array('administrator', $current_user->roles) || 
                   in_array('editor', $current_user->roles) || 
                   in_array('author', $current_user->roles) ||
                   in_array('contributor', $current_user->roles) ||
                   in_array('designer', $current_user->roles);
    
    if (!$is_designer) {
        return '<div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üö´</div>
                    <h3 style="margin-bottom: 10px;">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h3>
                    <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤.</p>
                    <p style="font-size: 0.9em; color: #888;">–í–∞—à–∏ —Ä–æ–ª–∏: ' . implode(', ', $current_user->roles) . '</p>
                </div>';
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–∞–∫–µ—Ç–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $package_status = ar_get_designer_package_status($user_id);
    $has_package = $package_status['has_package'];
    $package_active = $package_status['active'];
    
    ob_start();
    ?>
    
    <div class="ar-designer-orders" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
        <div class="ar-designer-header" style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #333; margin-bottom: 10px;">–ü–∞–Ω–µ–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞</h1>
            <p style="color: #666; font-size: 1.1em;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <?php echo esc_html($current_user->display_name); ?>!</p>
            
            <!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ –ø–∞–∫–µ—Ç–∞ -->
            <div class="ar-package-status" style="max-width: 600px; margin: 20px auto;">
                <?php if ($has_package): ?>
                    <?php if ($package_active): ?>
                        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600;">
                                <span style="font-size: 1.2em;">‚úÖ</span>
                                <span>–í–∞—à –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∞–∫—Ç–∏–≤–µ–Ω</span>
                            </div>
                            <?php if ($package_status['expiry_date']): ?>
                                <div style="margin-top: 8px; font-size: 0.9em;">
                                    –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: <?php echo date('d.m.Y', strtotime($package_status['expiry_date'])); ?>
                                </div>
                            <?php endif; ?>
                            <?php if ($package_status['remaining_orders'] !== false && $package_status['remaining_orders'] > 0): ?>
                                <div style="margin-top: 8px; font-size: 0.9em;">
                                    –û—Å—Ç–∞–ª–æ—Å—å –∑–∞—è–≤–æ–∫: <?php echo $package_status['remaining_orders']; ?>
                                </div>
                            <?php endif; ?>
                        </div>
                    <?php else: ?>
                        <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600;">
                                <span style="font-size: 1.2em;">‚ö†Ô∏è</span>
                                <span>–ü–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.9em;">
                                –î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞
                            </div>
                        </div>
                    <?php endif; ?>
                <?php else: ?>
                    <div style="background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; padding: 20px; border-radius: 8px; border: 1px solid #f5c6cb; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; margin-bottom: 10px;">
                            <span style="font-size: 1.2em;">üö´</span>
                            <span>–ü–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –Ω–µ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω</span>
                        </div>
                        <p style="margin-bottom: 15px;">–î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞.</p>
                        <div>
                            <a href="<?php echo esc_url(get_permalink(1634)); ?>" 
                               style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: background 0.3s ease;"
                               onmouseover="this.style.background='#218838'" 
                               onmouseout="this.style.background='#28a745'">
                                üõí –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞
                            </a>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                            –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø–∞–∫–µ—Ç–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞—è–≤–∫–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
                        </p>
                    </div>
                <?php endif; ?>
            </div>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="arChatBadge" style="display: none; position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                üí¨ <span id="arUnreadCount">0</span> –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="ar-designer-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <?php
            $my_orders_count = ar_get_designer_orders_count($user_id, 'my');
            $common_orders_count = ar_get_designer_orders_count($user_id, 'common');
            $unread_messages_count = ar_get_unread_messages_count($user_id);
            $total_orders_count = $my_orders_count + $common_orders_count;
            ?>
            
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;"><?php echo $total_orders_count; ?></div>
                <div style="font-size: 1.1em;">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;"><?php echo $my_orders_count; ?></div>
                <div style="font-size: 1.1em;">–ú–æ–∏ –∑–∞—è–≤–∫–∏</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;"><?php echo $common_orders_count; ?></div>
                <div style="font-size: 1.1em;">–û–±—â–∏–µ –∑–∞—è–≤–∫–∏</div>
            </div>
            
            <div style="background: linear-gradient(135deg, #ffd89b, #19547b); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;"><?php echo $unread_messages_count; ?></div>
                <div style="font-size: 1.1em;">–ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="ar-designer-nav" style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #eaeaea;">
            <button type="button" class="ar-nav-btn active" data-tab="my-orders" 
                    style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">
                üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏ (<?php echo $my_orders_count; ?>)
            </button>
            <button type="button" class="ar-nav-btn" data-tab="common-orders" 
                    style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">
                üåê –û–±—â–∏–µ –∑–∞—è–≤–∫–∏ (<?php echo $common_orders_count; ?>)
            </button>
        </div>

        <!-- –ú–æ–∏ –∑–∞—è–≤–∫–∏ -->
        <div class="ar-orders-tab active" id="my-orders-tab">
            <h2 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                –ó–∞—è–≤–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –º–Ω–µ
            </h2>
            <div class="ar-orders-list">
                <?php echo ar_get_designer_orders_list_with_chat($user_id, 'my', $has_package, $package_active); ?>
            </div>
        </div>

        <!-- –û–±—â–∏–µ –∑–∞—è–≤–∫–∏ -->
        <div class="ar-orders-tab" id="common-orders-tab" style="display: none;">
            <h2 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span>üåê</span> –û–±—â–∏–µ –∑–∞—è–≤–∫–∏ (–¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º)
            </h2>
            <div class="ar-orders-list">
                <?php echo ar_get_designer_orders_list_with_chat($user_id, 'common', $has_package, $package_active); ?>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
    <div id="arChatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; height: 80vh; max-height: 700px; display: flex; flex-direction: column;">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div style="padding: 20px; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; color: #333; font-size: 1.2em;" id="arChatTitle">–ß–∞—Ç –ø–æ –∑–∞—è–≤–∫–µ</h3>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;" id="arChatSubtitle"></p>
                </div>
                <button type="button" onclick="arCloseChat()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">√ó</button>
            </div>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="arChatMessages" style="flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
                <div style="text-align: center; color: #666; padding: 20px;">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div style="padding: 20px; border-top: 1px solid #eaeaea;">
                <form id="arChatForm" onsubmit="return arSendChatMessage(event)">
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <div style="position: relative;">
                            <input type="text" id="arChatMessageInput" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                   style="width: 100%; padding: 12px; padding-right: 80px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                                   maxlength="1000"
                                   oninput="arUpdateCharCounter()"
                                   required>
                            <span id="arCharCounter" 
                                  style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #95a5a6; pointer-events: none;">
                                0/1000
                            </span>
                        </div>
                        <button type="submit" 
                                style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s;">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </form>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ -->
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.8em; color: #666;">
                    <div style="display: flex; justify-content: space-between;">
                        <span id="arChatInfo">–ß–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</span>
                        <span id="arChatStatus"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    .ar-orders-tab {
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .ar-nav-btn.active {
        position: relative;
    }
    
    .ar-nav-btn.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 3px;
        background: white;
    }
    
    .ar-order-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid #eaeaea;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .ar-order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    }
    
    .ar-order-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eaeaea;
        flex-wrap: wrap;
    }
    
    .ar-btn-take {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .ar-btn-take:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .ar-btn-release {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .ar-btn-release:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .ar-btn-chat {
        background: #007cba;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .ar-btn-chat:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .ar-status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending { background: #fff3cd; color: #856404; }
    .status-active { background: #d4edda; color: #155724; }
    .status-completed { background: #d1ecf1; color: #0c5460; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    
    /* –°—Ç–∏–ª–∏ —á–∞—Ç–∞ */
    .ar-chat-message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 12px;
        position: relative;
        word-wrap: break-word;
    }
    
    .ar-chat-message.sent {
        background: #667eea;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }
    
    .ar-chat-message.received {
        background: #f1f3f4;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    
    .ar-chat-message-time {
        font-size: 0.7em;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
    }
    
    .ar-chat-message.received .ar-chat-message-time {
        text-align: left;
    }
    
    .ar-chat-status-online {
        color: #28a745;
        font-weight: 600;
    }
    
    .ar-chat-status-offline {
        color: #6c757d;
    }
    
    #arChatMessages {
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 transparent;
    }
    
    #arChatMessages::-webkit-scrollbar {
        width: 6px;
    }
    
    #arChatMessages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #arChatMessages::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    </style>

    <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–∞—Ç–∞
    let arCurrentChat = {
        orderId: null,
        otherUserId: null,
        otherUserName: null,
        refreshInterval: null
    };
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–∫–µ—Ç–∞
    let arDesignerHasPackage = <?php echo $has_package ? 'true' : 'false'; ?>;
    let arPackageActive = <?php echo $package_active ? 'true' : 'false'; ?>;

    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å DOM
    const DOMUtils = {
        getElement: (selector) => {
            const element = document.querySelector(selector);
            if (!element) {
                console.warn(`Element ${selector} not found`);
            }
            return element;
        },
        
        getElementById: (id) => {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element #${id} not found`);
            }
            return element;
        },
        
        setStyle: (element, styles) => {
            if (element && element.style) {
                Object.assign(element.style, styles);
                return true;
            }
            return false;
        }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    function initDesignerPanel() {
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
        const navButtons = document.querySelectorAll('.ar-nav-btn');
        const tabs = document.querySelectorAll('.ar-orders-tab');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if (navButtons.length === 0 || tabs.length === 0) {
            console.warn('–ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
            return;
        }
        
        navButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');
                const targetElement = document.getElementById(targetTab + '-tab');
                
                // –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–Ø
                if (!targetElement) {
                    console.error(`Tab element #${targetTab}-tab not found`);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                navButtons.forEach(btn => {
                    if (btn) {
                        btn.style.background = '#6c757d';
                        btn.classList.remove('active');
                    }
                });
                
                if (this) {
                    this.style.background = '#667eea';
                    this.classList.add('active');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
                tabs.forEach(tab => {
                    if (tab) {
                        tab.style.display = 'none';
                    }
                });
                
                targetElement.style.display = 'block';
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π —Å –∑–∞—è–≤–∫–∞–º–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        document.addEventListener('click', function(e) {
            if (!e.target) return;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const takeBtn = e.target.closest('.ar-btn-take');
            const releaseBtn = e.target.closest('.ar-btn-release');
            
            if (takeBtn && !takeBtn.disabled) {
                const orderId = takeBtn.getAttribute('data-order-id');
                if (orderId) {
                    arTakeOrder(orderId);
                }
            }
            
            if (releaseBtn && !releaseBtn.disabled) {
                const orderId = releaseBtn.getAttribute('data-order-id');
                if (orderId) {
                    arReleaseOrder(orderId);
                }
            }
        });

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        // Clear any existing interval to prevent duplication
        if (window.arCheckNewMessagesInterval) {
            clearInterval(window.arCheckNewMessagesInterval);
        }
        arCheckNewMessages();
        window.arCheckNewMessagesInterval = setInterval(arCheckNewMessages, 10000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (window.arCheckNewMessagesInterval) {
            clearInterval(window.arCheckNewMessagesInterval);
        }
    });
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDesignerPanel);
    } else {
        initDesignerPanel();
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º –∑–∞—è–≤–∫–∏
    function arCheckPackageBeforeTake() {
        if (!arDesignerHasPackage) {
            alert('‚ùå –î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞.');
            window.location.href = '<?php echo esc_url(get_permalink(1634)); ?>';
            return false;
        }
        
        if (!arPackageActive) {
            alert('‚ùå –í–∞—à –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø–∞–∫–µ—Ç.');
            return false;
        }
        
        return true;
    }
    
    function arTakeOrder(orderId) {
        if (!arCheckPackageBeforeTake()) {
            return;
        }
        
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É –≤ —Ä–∞–±–æ—Ç—É?')) {
            return;
        }
        
        const data = {
            action: 'ar_take_order',
            order_id: orderId,
            nonce: '<?php echo wp_create_nonce("ar_designer_order_nonce"); ?>'
        };
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É!');
                location.reload();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        });
    }
    
    function arReleaseOrder(orderId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–π –∑–∞—è–≤–∫–∏?')) {
            return;
        }
        
        const data = {
            action: 'ar_release_order',
            order_id: orderId,
            nonce: '<?php echo wp_create_nonce("ar_designer_order_nonce"); ?>'
        };
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('‚úÖ –í—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç –∑–∞—è–≤–∫–∏');
                location.reload();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞—è–≤–∫–∏
    function arViewOrderDetails(orderId) {
        const modal = document.getElementById('order-details-' + orderId);
        if (modal) {
            modal.style.display = 'flex';
        } else {
            console.error(`Modal #order-details-${orderId} not found`);
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('modal-backdrop')) {
            const modal = e.target;
            if (modal && modal.style) {
                modal.style.display = 'none';
            }
        }
    });

    /* ========================= –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê ========================= */
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
    function arOpenChat(orderId, otherUserId, otherUserName) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —á–∞—Ç
        if (!arDesignerHasPackage || !arPackageActive) {
            alert('üí¨ –ß–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–∞–∫–µ—Ç–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞');
            return;
        }
        
        // –ü–†–û–í–ï–†–Ø–ï–ú –ü–ê–†–ê–ú–ï–¢–†–´
        if (!orderId || !otherUserId || !otherUserName) {
            console.error('Invalid parameters for chat');
            return;
        }
        
        arCurrentChat.orderId = orderId;
        arCurrentChat.otherUserId = otherUserId;
        arCurrentChat.otherUserName = otherUserName;
        
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        const chatTitle = document.getElementById('arChatTitle');
        const chatSubtitle = document.getElementById('arChatSubtitle');
        const chatModal = document.getElementById('arChatModal');
        
        if (!chatTitle || !chatSubtitle || !chatModal) {
            console.error('Chat elements not found');
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        chatTitle.textContent = `–ß–∞—Ç –ø–æ –∑–∞—è–≤–∫–µ #${orderId}`;
        chatSubtitle.textContent = `–° ${otherUserName}`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        chatModal.style.display = 'flex';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        arLoadChatMessages();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        arStartChatAutoRefresh();
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
    function arCloseChat() {
        const chatModal = document.getElementById('arChatModal');
        if (chatModal) {
            chatModal.style.display = 'none';
        }
        arStopChatAutoRefresh();
        arCurrentChat = { orderId: null, otherUserId: null, otherUserName: null, refreshInterval: null };
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function arLoadChatMessages(retryCount = 0) {
        if (!arCurrentChat.orderId || !arCurrentChat.otherUserId) return;
        
        const data = {
            action: 'ar_get_chat_messages',
            order_id: arCurrentChat.orderId,
            other_user_id: arCurrentChat.otherUserId,
            nonce: '<?php echo wp_create_nonce("ar_chat_nonce"); ?>'
        };
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                arDisplayChatMessages(result.data.messages, result.data.current_user_id);
                arUpdateChatInfo(result.data.other_user);
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', result.data);
                if (retryCount < 3) {
                    setTimeout(() => arLoadChatMessages(retryCount + 1), 2000 * (retryCount + 1));
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–æ 3 —Ä–∞–∑
            if (retryCount < 3) {
                console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}/3...`);
                setTimeout(() => arLoadChatMessages(retryCount + 1), 2000 * (retryCount + 1));
            } else {
                const messagesContainer = document.getElementById('arChatMessages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; color: #e74c3c; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                            <button onclick="arLoadChatMessages(0)" 
                                    style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                            </button>
                        </div>
                    `;
                }
            }
        });
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    function arDisplayChatMessages(messages, currentUserId) {
        const messagesContainer = document.getElementById('arChatMessages');
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
            messagesContainer.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>
                    <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                    <p style="font-size: 0.9em;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                </div>
            `;
            return;
        }
        
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.className = `ar-chat-message ${message.is_sent ? 'sent' : 'received'}`;
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS
            const messageText = document.createElement('div');
            messageText.textContent = message.message;
            
            const timeEl = document.createElement('div');
            timeEl.className = 'ar-chat-message-time';
            timeEl.textContent = message.formatted_time;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (message.is_sent) {
                const statusEl = document.createElement('span');
                statusEl.className = 'ar-message-status';
                statusEl.textContent = message.is_read ? ' ‚úì‚úì' : ' ‚úì';
                statusEl.style.cssText = 'opacity: 0.7; font-size: 0.85em; margin-left: 5px;';
                timeEl.appendChild(statusEl);
            }
            
            messageElement.appendChild(messageText);
            messageElement.appendChild(timeEl);
            
            messagesContainer.appendChild(messageElement);
        });
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ
    function arUpdateChatInfo(otherUser) {
        const statusElement = document.getElementById('arChatStatus');
        const infoElement = document.getElementById('arChatInfo');
        
        if (!statusElement || !infoElement) return;
        
        const statusClass = otherUser.is_online ? 'ar-chat-status-online' : 'ar-chat-status-offline';
        const statusText = otherUser.is_online ? 'üü¢ –í —Å–µ—Ç–∏' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏';
        const lastSeen = otherUser.last_seen ? ` (–±—ã–ª(–∞) ${otherUser.last_seen})` : '';
        
        statusElement.innerHTML = `<span class="${statusClass}">${statusText}${lastSeen}</span>`;
        infoElement.textContent = `–ß–∞—Ç —Å ${otherUser.name}`;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function arSendChatMessage(event) {
        event.preventDefault();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞–∫–µ—Ç–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (!arDesignerHasPackage || !arPackageActive) {
            arShowMessageError('‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–∞–∫–µ—Ç–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞');
            return false;
        }
        
        const messageInput = document.getElementById('arChatMessageInput');
        const sendButton = document.querySelector('#arChatForm button[type="submit"]');
        const message = messageInput.value.trim();
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!message) {
            arShowMessageError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return false;
        }
        
        if (message.length > 1000) {
            arShowMessageError('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤)');
            return false;
        }
        
        if (!arCurrentChat.orderId || !arCurrentChat.otherUserId) {
            arShowMessageError('–û—à–∏–±–∫–∞: —á–∞—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            return false;
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        if (sendButton) {
            sendButton.disabled = true;
            sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        }
        
        const data = {
            action: 'ar_send_chat_message',
            order_id: arCurrentChat.orderId,
            receiver_id: arCurrentChat.otherUserId,
            message: message,
            nonce: '<?php echo wp_create_nonce("ar_chat_nonce"); ?>'
        };
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.status);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                messageInput.value = '';
                arUpdateCharCounter();
                arLoadChatMessages();
                arShowMessageSuccess('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            } else {
                arShowMessageError('–û—à–∏–±–∫–∞: ' + (result.data || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            arShowMessageError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        })
        .finally(() => {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            if (sendButton) {
                sendButton.disabled = false;
                sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        });
        
        return false;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
    function arUpdateCharCounter() {
        const messageInput = document.getElementById('arChatMessageInput');
        const counter = document.getElementById('arCharCounter');
        
        if (messageInput && counter) {
            const length = messageInput.value.length;
            const maxLength = 1000;
            counter.textContent = `${length}/${maxLength}`;
            
            if (length > maxLength) {
                counter.style.color = '#e74c3c';
            } else if (length > maxLength * 0.9) {
                counter.style.color = '#f39c12';
            } else {
                counter.style.color = '#95a5a6';
            }
        }
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö –∏ —É—Å–ø–µ—Ö–µ
    function arShowMessageError(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10002;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    function arShowMessageSuccess(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10002;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
    function arStartChatAutoRefresh() {
        arCurrentChat.refreshInterval = setInterval(arLoadChatMessages, 3000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    }
    
    function arStopChatAutoRefresh() {
        if (arCurrentChat.refreshInterval) {
            clearInterval(arCurrentChat.refreshInterval);
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –ø–æ–∫–∞–∑–∞ –±–µ–π–¥–∂–µ–π)
    function arCheckNewMessages() {
        const data = {
            action: 'ar_check_new_messages',
            nonce: '<?php echo wp_create_nonce("ar_chat_nonce"); ?>'
        };
        
        fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const unreadCount = result.data.unread_count;
                const badge = document.getElementById('arChatBadge');
                const countElement = document.getElementById('arUnreadCount');
                
                if (badge && countElement) {
                    if (unreadCount > 0) {
                        countElement.textContent = unreadCount;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        });
    }
    </script>
    
    <?php
    return ob_get_clean();
}

/* ========================= –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã) ========================= */

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞—è–≤–æ–∫
 */
function ar_check_client_tables() {
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    
    $table_exists = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) === $orders_table;
    
    if (!$table_exists) {
        // –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∑–¥–µ—Å—å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å false
        return false;
    }
    
    return true;
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
 */
function ar_get_designer_orders_count($user_id, $type = 'my') {
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
        return 0;
    }
    
    if ($type === 'my') {
        // –ó–∞—è–≤–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –¥–∏–∑–∞–π–Ω–µ—Ä—É
        return $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $orders_table WHERE selected_designer_id = %d",
            $user_id
        ));
    } else {
        // –û–±—â–∏–µ –∑–∞—è–≤–∫–∏ (–±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞)
        return $wpdb->get_var(
            "SELECT COUNT(*) FROM $orders_table WHERE (selected_designer_id IS NULL OR selected_designer_id = 0) AND status = 'pending'"
        );
    }
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–æ–∫ —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
 */
function ar_can_take_order($user_id) {
    $result = [
        'can_take' => false,
        'reason' => '',
        'remaining' => null
    ];
    
    if (user_can($user_id, 'manage_options')) {
        $result['can_take'] = true;
        $result['reason'] = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
        return $result;
    }
    
    $package_status = ar_get_designer_package_status($user_id);
    
    if (!$package_status['has_package']) {
        $result['reason'] = '–ü–∞–∫–µ—Ç –Ω–µ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω';
        return $result;
    }
    
    if (!$package_status['active']) {
        $result['reason'] = '–ü–∞–∫–µ—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω';
        return $result;
    }
    
    if ($package_status['expiry_date'] && strtotime($package_status['expiry_date']) < time()) {
        $result['reason'] = '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–∞–∫–µ—Ç–∞ –∏—Å—Ç–µ–∫';
        return $result;
    }
    
    if ($package_status['remaining_orders'] !== false) {
        if ($package_status['remaining_orders'] <= 0) {
            $result['reason'] = '–õ–∏–º–∏—Ç –∑–∞—è–≤–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω';
            return $result;
        }
        $result['remaining'] = $package_status['remaining_orders'];
    }
    
    $result['can_take'] = true;
    $result['reason'] = '–î–æ—Å—Ç—É–ø–Ω–æ';
    return $result;
}

/**
 * –£–º–µ–Ω—å—à–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –≤ –ø–∞–∫–µ—Ç–µ (–¥–ª—è –æ—Ç–∫–∞—Ç–∞)
 */
function ar_decrement_package_orders_used($order_id) {
    $order = wc_get_order($order_id);
    if (!$order) return false;
    
    $current_used = $order->get_meta('_designer_package_orders_used');
    $new_used = max(0, intval($current_used ?: 0) - 1);
    
    $order->update_meta_data('_designer_package_orders_used', $new_used);
    $order->save();
    
    return $new_used;
}

/**
 * –õ–æ–≥–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
 */
function ar_log_package_usage($user_id, $order_id, $action) {
    global $wpdb;
    
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    $logs_table = $wpdb->prefix . 'designer_package_logs';
    
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $logs_table)) != $logs_table) {
        $charset_collate = $wpdb->get_charset_collate();
        $sql = "CREATE TABLE $logs_table (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            user_id bigint(20) NOT NULL,
            order_id bigint(20) NOT NULL,
            action varchar(50) NOT NULL,
            package_order_id bigint(20),
            remaining_orders int(11),
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY user_id (user_id),
            KEY order_id (order_id),
            KEY action (action)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–∞–∫–µ—Ç–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    $package_status = ar_get_designer_package_status($user_id);
    
    $wpdb->insert($logs_table, [
        'user_id' => $user_id,
        'order_id' => $order_id,
        'action' => $action,
        'package_order_id' => $package_status['order_id'],
        'remaining_orders' => $package_status['remaining_orders'],
        'created_at' => current_time('mysql')
    ]);
}

// ========================= –§–£–ù–ö–¶–ò–ò –ü–†–û–í–ï–†–ö–ò –ü–ê–ö–ï–¢–ê –î–ò–ó–ê–ô–ù–ï–†–ê =========================

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä –∞–∫—Ç–∏–≤–Ω—ã–π –ø–∞–∫–µ—Ç (—Ç–æ–≤–∞—Ä ID 1634)
 * 
 * @param int $user_id ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @return array –°—Ç–∞—Ç—É—Å –ø–∞–∫–µ—Ç–∞
 */
function ar_get_designer_package_status($user_id) {
    $status = [
        'has_package' => false,
        'active' => false,
        'expiry_date' => null,
        'remaining_orders' => false,
        'order_id' => null,
        'purchase_date' => null
    ];
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä - –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø
    if (user_can($user_id, 'manage_options')) {
        $status['has_package'] = true;
        $status['active'] = true;
        return $status;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ WooCommerce
    if (!class_exists('WooCommerce')) {
        return $status;
    }
    
    // –ò—â–µ–º –∑–∞–∫–∞–∑—ã —Å —Ç–æ–≤–∞—Ä–æ–º ID 1634
    $orders = wc_get_orders([
        'customer_id' => $user_id,
        'status' => ['completed', 'processing'],
        'limit' => -1,
    ]);
    
    $package_product_id = 1634;
    
    foreach ($orders as $order) {
        foreach ($order->get_items() as $item) {
            if ($item->get_product_id() == $package_product_id || 
                $item->get_variation_id() == $package_product_id) {
                
                $status['has_package'] = true;
                $status['order_id'] = $order->get_id();
                $status['purchase_date'] = $order->get_date_created()->date('Y-m-d H:i:s');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
                if ($order->get_status() == 'completed') {
                    $status['active'] = true;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–∞–∫–µ—Ç–∞
                $package_expiry = $order->get_meta('_designer_package_expiry');
                if ($package_expiry) {
                    $expiry_timestamp = strtotime($package_expiry);
                    $status['expiry_date'] = $package_expiry;
                    $status['active'] = $status['active'] && (time() < $expiry_timestamp);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∑–∞—è–≤–æ–∫
                $orders_limit = $order->get_meta('_designer_package_orders_limit');
                $orders_used = $order->get_meta('_designer_package_orders_used');
                if ($orders_limit) {
                    $orders_used = intval($orders_used ?: 0);
                    $status['remaining_orders'] = max(0, intval($orders_limit) - $orders_used);
                    $status['active'] = $status['active'] && ($status['remaining_orders'] > 0);
                }
                
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–∞–∫–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
                if ($status['active']) {
                    return $status;
                }
            }
        }
    }
    
    return $status;
}

/**
 * –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –≤ –ø–∞–∫–µ—Ç–µ
 */
function ar_increment_package_orders_used($order_id) {
    $order = wc_get_order($order_id);
    if (!$order) return false;
    
    $current_used = $order->get_meta('_designer_package_orders_used');
    $new_used = intval($current_used ?: 0) + 1;
    
    $order->update_meta_data('_designer_package_orders_used', $new_used);
    $order->save();
    
    return $new_used;
}

/* ========================= –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –°–ü–ò–°–ö–ê –ó–ê–Ø–í–û–ö ========================= */

function ar_get_designer_orders_list_with_chat($designer_id, $type = 'my', $has_package = false, $package_active = false) {
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
        return '<div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
                    <h3 style="margin-bottom: 10px;">–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞</h3>
                    <p>–¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>
                </div>';
    }
    
    if ($type === 'my') {
        // –ó–∞—è–≤–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –¥–∏–∑–∞–π–Ω–µ—Ä—É
        $orders = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM $orders_table WHERE selected_designer_id = %d ORDER BY created_at DESC",
            $designer_id
        ));
    } else {
        // –û–±—â–∏–µ –∑–∞—è–≤–∫–∏ (–±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –ò–õ–ò —Å selected_designer_id = 0)
        $orders = $wpdb->get_results(
            "SELECT * FROM $orders_table WHERE (selected_designer_id IS NULL OR selected_designer_id = 0) AND status = 'pending' ORDER BY created_at DESC"
        );
    }
    
    if (empty($orders)) {
        $message = $type === 'my' 
            ? '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –≤ —Ä–∞–±–æ—Ç–µ.'
            : '–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±—â–∏—Ö –∑–∞—è–≤–æ–∫.';
            
        return '<div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
                    <h3 style="margin-bottom: 10px;">' . $message . '</h3>
                </div>';
    }
    
    ob_start();
    
    foreach ($orders as $order) {
        $status_text = '–í –æ–∂–∏–¥–∞–Ω–∏–∏';
        $status_class = 'status-pending';
        
         // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        $access_check = ar_can_take_order($designer_id);
        $can_take_order = $access_check['can_take'];
        $take_disabled_reason = $access_check['reason'];
        
        switch ($order->status) {
            case 'active':
                $status_text = '–í —Ä–∞–±–æ—Ç–µ';
                $status_class = 'status-active';
                break;
            case 'completed':
                $status_text = '–ó–∞–≤–µ—Ä—à–µ–Ω–∞';
                $status_class = 'status-completed';
                break;
            case 'cancelled':
                $status_text = '–û—Ç–º–µ–Ω–µ–Ω–∞';
                $status_class = 'status-cancelled';
                break;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏ –∏–º—è
        $current_user_id = get_current_user_id();
        if ($type === 'my') {
            // –î–ª—è –º–æ–∏—Ö –∑–∞—è–≤–æ–∫ - —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç
            $other_user_id = $order->client_id;
            $other_user_name = $order->client_name;
        } else {
            // –î–ª—è –æ–±—â–∏—Ö –∑–∞—è–≤–æ–∫ - —á–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            $other_user_id = null;
            $other_user_name = null;
        }
        
        ?>
        <div class="ar-order-card">
            <div class="ar-order-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <div>
                    <h3 style="margin: 0 0 5px 0; color: #333; font-size: 1.3em;"><?php echo esc_html($order->project_name); ?></h3>
                    <p style="margin: 0; color: #666; font-size: 0.9em;">
                        –æ—Ç <?php echo esc_html($order->client_name); ?> ‚Ä¢ 
                        <?php echo date('d.m.Y H:i', strtotime($order->created_at)); ?>
                    </p>
                </div>
                <span class="ar-status-badge <?php echo $status_class; ?>"><?php echo $status_text; ?></span>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <strong style="color: #666; font-size: 0.85em;">–£—Å–ª—É–≥–∞:</strong>
                    <div style="font-weight: 600; color: #333;">
                        <?php 
                        $service_types = [
                            'design_project' => '–î–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç',
                            'design_materials' => '–î–∏–∑–∞–π–Ω + –º–∞—Ç–µ—Ä–∏–∞–ª—ã',
                            'full_service' => '–ü–æ–ª–Ω—ã–π —Å–µ—Ä–≤–∏—Å'
                        ];
                        echo esc_html($service_types[$order->service_type] ?? $order->service_type); 
                        ?>
                    </div>
                </div>
                
                <div>
                    <strong style="color: #666; font-size: 0.85em;">–õ–æ–∫–∞—Ü–∏—è:</strong>
                    <div style="font-weight: 600; color: #333;">
                        <?php echo esc_html($order->city); ?>, <?php echo esc_html($order->country); ?>
                    </div>
                </div>
                
                <div>
                    <strong style="color: #666; font-size: 0.85em;">–ü–ª–æ—â–∞–¥—å:</strong>
                    <div style="font-weight: 600; color: #333;"><?php echo esc_html($order->area); ?> –º¬≤</div>
                </div>
                
                <div>
                    <strong style="color: #666; font-size: 0.85em;">–ë—é–¥–∂–µ—Ç:</strong>
                    <div style="font-weight: 600; color: #333;">
                        <?php if ($order->budget): ?>
                            <?php echo number_format($order->budget, 0, ',', '.'); ?> <?php echo esc_html($order->currency); ?>
                        <?php else: ?>
                            –ù–µ —É–∫–∞–∑–∞–Ω
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            
            <?php if ($order->additional_info): ?>
            <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong style="color: #666; font-size: 0.85em;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
                <p style="margin: 8px 0 0 0; color: #333; line-height: 1.5;"><?php echo esc_html($order->additional_info); ?></p>
            </div>
            <?php endif; ?>
            
            <?php if (!empty($order->project_created) && $order->project_created == 1): ?>
                <div style="margin-top: 10px; padding: 8px 12px; background: #d4edda; color: #155724; border-radius: 4px; display: inline-flex; align-items: center; gap: 5px; font-size: 0.85em;">
                    ‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –≤ CRM
                </div>
            <?php endif; ?>
            
            <div class="ar-order-actions">
                <?php if ($type === 'common'): ?>
            <?php if ($can_take_order): ?>
                <button type="button" 
                        class="ar-btn-take" 
                        data-order-id="<?php echo $order->id; ?>"
                        style="...">
                    ‚úÖ –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
                    <?php if ($access_check['remaining'] !== null): ?>
                        <span style="font-size: 0.8em; opacity: 0.8;">
                            (–æ—Å—Ç–∞–ª–æ—Å—å: <?php echo $access_check['remaining']; ?>)
                        </span>
                    <?php endif; ?>
                </button>
            <?php else: ?>
                <button type="button" 
                        disabled
                        title="<?php echo esc_attr($take_disabled_reason); ?>"
                        style="...">
                    ‚úÖ –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
                    <span style="font-size: 0.8em; opacity: 0.8;">
                        (<?php echo esc_html($take_disabled_reason); ?>)
                    </span>
                </button>
            <?php endif; ?>
                    
                    <button type="button" 
                            disabled
                            style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: not-allowed; font-weight: 600; display: flex; align-items: center; gap: 8px; opacity: 0.6;">
                        üí¨ –ß–∞—Ç (–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏)
                    </button>
                    
                <?php else: ?>
                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –õ–ò–ß–ù–´–• –∑–∞—è–≤–æ–∫ -->
                    <?php if ($has_package && $package_active): ?>
                        <?php if ($order->status == 'active'): ?>
                            <button type="button" 
                                    class="ar-btn-release" 
                                    data-order-id="<?php echo $order->id; ?>"
                                    style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                ‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è
                            </button>
                        <?php endif; ?>
                        
                        <button type="button" 
                                class="ar-btn-chat" 
                                onclick="arOpenChat(<?php echo $order->id; ?>, <?php echo $other_user_id; ?>, '<?php echo esc_js($other_user_name); ?>')"
                                style="padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                        </button>
                    <?php else: ?>
                        <?php if ($order->status == 'active'): ?>
                            <button type="button" 
                                    disabled
                                    title="<?php echo $has_package ? '–ü–∞–∫–µ—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω' : '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞'; ?>"
                                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: not-allowed; font-weight: 600; display: flex; align-items: center; gap: 8px; opacity: 0.6;">
                                ‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è
                            </button>
                        <?php endif; ?>
                        
                        <button type="button" 
                                disabled
                                title="<?php echo $has_package ? '–ü–∞–∫–µ—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω' : '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞'; ?>"
                                style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: not-allowed; font-weight: 600; display: flex; align-items: center; gap: 8px; opacity: 0.6;">
                            üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                        </button>
                    <?php endif; ?>
                <?php endif; ?>
                
                <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" - –æ–±—â–∞—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∑–∞—è–≤–æ–∫ -->
                <button type="button" 
                        onclick="arViewOrderDetails(<?php echo $order->id; ?>)" 
                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </button>
            </div>
            
            <!-- –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) -->
            <div id="order-details-<?php echo $order->id; ?>" class="modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #333;">–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ #<?php echo $order->id; ?></h3>
                        <button type="button" onclick="document.getElementById('order-details-<?php echo $order->id; ?>').style.display = 'none'" 
                                style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4 style="color: #333; margin-bottom: 10px;">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                            <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> <?php echo esc_html($order->client_name); ?></p>
                            <p><strong>Email:</strong> <?php echo esc_html($order->client_email); ?></p>
                            <p><strong>–ü—Ä–æ–µ–∫—Ç:</strong> <?php echo esc_html($order->project_name); ?></p>
                            <p><strong>–¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞:</strong> <?php echo $order->product_type === 'design' ? '–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞' : '–ú–µ–±–µ–ª—å –Ω–∞ –∑–∞–∫–∞–∑'; ?></p>
                        </div>
                        
                        <div>
                            <h4 style="color: #333; margin-bottom: 10px;">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</h4>
                            <p><strong>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</strong> <?php echo esc_html(ucfirst($order->object_type)); ?></p>
                            <p><strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞:</strong> <?php echo esc_html(ucfirst($order->object_status)); ?></p>
                            <p><strong>–°—Ç–∏–ª—å:</strong> <?php echo $order->style ? esc_html(ucfirst($order->style)) : '–ù–µ —É–∫–∞–∑–∞–Ω'; ?></p>
                            <p><strong>–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:</strong> <?php echo $order->completion_date ? date('d.m.Y', strtotime($order->completion_date)) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'; ?></p>
                        </div>
                    </div>
                    
                    <?php if ($order->additional_info): ?>
                    <div>
                        <h4 style="color: #333; margin-bottom: 10px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <p style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.5;"><?php echo nl2br(esc_html($order->additional_info)); ?></p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <?php
    }
    
    return ob_get_clean();
}

/* ========================= AJAX –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –î–ò–ó–ê–ô–ù–ï–†–û–í ========================= */









// AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞—è–≤–∫–∏
add_action('wp_ajax_ar_quick_order', 'ar_ajax_quick_order');
add_action('wp_ajax_nopriv_ar_quick_order', 'ar_ajax_quick_order');
function ar_ajax_quick_order() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_quick_order')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    }
    
    $designer_id = isset($_POST['designer_id']) ? intval($_POST['designer_id']) : 0;
    $client_name = isset($_POST['client_name']) ? sanitize_text_field($_POST['client_name']) : '';
    $client_phone = isset($_POST['client_phone']) ? sanitize_text_field($_POST['client_phone']) : '';
    $client_email = isset($_POST['client_email']) ? sanitize_email($_POST['client_email']) : '';
    $project_type = isset($_POST['project_type']) ? sanitize_text_field($_POST['project_type']) : '';
    
    if (!$designer_id || !$client_name || !$client_phone) {
        wp_send_json_error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $designer = get_userdata($designer_id);
    if (!$designer) {
        wp_send_json_error('–î–∏–∑–∞–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–∏–∑–∞–π–Ω–µ—Ä—É
    $subject = '–ù–æ–≤–∞—è –±—ã—Å—Ç—Ä–∞—è –∑–∞—è–≤–∫–∞ - Art Rocket';
    $message = "
    <h2>–ù–æ–≤–∞—è –±—ã—Å—Ç—Ä–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞</h2>
    <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> {$client_name}</p>
    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {$client_phone}</p>
    <p><strong>Email:</strong> {$client_email}</p>
    <p><strong>–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞:</strong> {$project_type}</p>
    <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> " . date('d.m.Y H:i') . "</p>
    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
    ";
    
    $headers = ['Content-Type: text/html; charset=UTF-8'];
    wp_mail($designer->user_email, $subject, $message, $headers);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    $admin_email = get_option('admin_email');
    wp_mail($admin_email, '–ù–æ–≤–∞—è –±—ã—Å—Ç—Ä–∞—è –∑–∞—è–≤–∫–∞ –¥–∏–∑–∞–π–Ω–µ—Ä—É', $message, $headers);
    
    wp_send_json_success('–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –î–∏–∑–∞–π–Ω–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.');
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è –≤ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
add_filter('wp_nav_menu_items', 'ar_add_designer_profile_menu_link', 10, 2);
function ar_add_designer_profile_menu_link($items, $args) {
    if ($args->theme_location == 'primary' && is_user_logged_in()) {
        $user_id = get_current_user_id();
        $profile_link = home_url('/designer/?designer_id=' . $user_id);
        
        $items .= '<li class="menu-item"><a href="' . esc_url($profile_link) . '" target="_blank">üë®‚Äçüé® –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a></li>';
    }
    return $items;
}

// –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∞–±–æ–∫—Å—ã –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
add_action('add_meta_boxes', 'ar_add_designer_profile_metabox');
function ar_add_designer_profile_metabox() {
    add_meta_box(
        'ar_designer_profile',
        '–ü—Ä–æ—Ñ–∏–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞',
        'ar_render_designer_profile_metabox',
        'user',
        'normal',
        'high'
    );
}

function ar_render_designer_profile_metabox($user) {
    if (!current_user_can('edit_users')) {
        return;
    }
    
    $specialty = get_user_meta($user->ID, 'ar_designer_specialty', true);
    $experience = get_user_meta($user->ID, 'ar_designer_experience', true);
    $location = get_user_meta($user->ID, 'ar_designer_location', true);
    $price = get_user_meta($user->ID, 'ar_designer_price', true);
    $rating = get_user_meta($user->ID, 'ar_designer_rating', true);
    $reviews = get_user_meta($user->ID, 'ar_designer_reviews', true);
    $about = get_user_meta($user->ID, 'ar_designer_about', true);
    $education = get_user_meta($user->ID, 'ar_designer_education', true);
    $certifications = get_user_meta($user->ID, 'ar_designer_certifications', true);
    $styles = get_user_meta($user->ID, 'ar_designer_styles', true);
    $portfolio_images = get_user_meta($user->ID, 'ar_portfolio_images', true);
    $projects_completed = get_user_meta($user->ID, 'ar_projects_completed', true);
    $active_projects = get_user_meta($user->ID, 'ar_active_projects', true);
    ?>
    <div class="ar-designer-profile-admin">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</h3>
        
        <table class="form-table">
            <tr>
                <th><label for="ar_designer_specialty">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</label></th>
                <td>
                    <input type="text" name="ar_designer_specialty" id="ar_designer_specialty" 
                           value="<?php echo esc_attr($specialty); ?>" class="regular-text">
                    <p class="description">–ù–∞–ø—Ä–∏–º–µ—Ä: "–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞", "–ú–µ–±–µ–ª—å –Ω–∞ –∑–∞–∫–∞–∑"</p>
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_designer_experience">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</label></th>
                <td>
                    <input type="text" name="ar_designer_experience" id="ar_designer_experience" 
                           value="<?php echo esc_attr($experience); ?>" class="regular-text">
                    <p class="description">–ù–∞–ø—Ä–∏–º–µ—Ä: "5+ –ª–µ—Ç", "10 –ª–µ—Ç –≤ –¥–∏–∑–∞–π–Ω–µ"</p>
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_designer_location">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label></th>
                <td>
                    <input type="text" name="ar_designer_location" id="ar_designer_location" 
                           value="<?php echo esc_attr($location); ?>" class="regular-text">
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_designer_price">–¶–µ–Ω–∞ –∑–∞ –º¬≤ (‚Ç¨)</label></th>
                <td>
                    <input type="number" name="ar_designer_price" id="ar_designer_price" 
                           value="<?php echo esc_attr($price); ?>" class="small-text" step="0.1">
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_designer_rating">–†–µ–π—Ç–∏–Ω–≥ (0-5)</label></th>
                <td>
                    <input type="number" name="ar_designer_rating" id="ar_designer_rating" 
                           value="<?php echo esc_attr($rating); ?>" class="small-text" min="0" max="5" step="0.1">
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_designer_reviews">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤</label></th>
                <td>
                    <input type="number" name="ar_designer_reviews" id="ar_designer_reviews" 
                           value="<?php echo esc_attr($reviews); ?>" class="small-text">
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_designer_about">–û –¥–∏–∑–∞–π–Ω–µ—Ä–µ</label></th>
                <td>
                    <textarea name="ar_designer_about" id="ar_designer_about" rows="5" class="large-text"><?php echo esc_textarea($about); ?></textarea>
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_designer_styles">–°—Ç–∏–ª–∏ —Ä–∞–±–æ—Ç—ã</label></th>
                <td>
                    <input type="text" name="ar_designer_styles" id="ar_designer_styles" 
                           value="<?php echo esc_attr($styles); ?>" class="regular-text">
                    <p class="description">–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: modern,minimalist,scandinavian</p>
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_portfolio_images">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</label></th>
                <td>
                    <textarea name="ar_portfolio_images" id="ar_portfolio_images" rows="3" class="large-text"><?php echo esc_textarea($portfolio_images); ?></textarea>
                    <p class="description">–ü–æ –æ–¥–Ω–æ–º—É URL –Ω–∞ —Å—Ç—Ä–æ–∫—É</p>
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_projects_completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</label></th>
                <td>
                    <input type="number" name="ar_projects_completed" id="ar_projects_completed" 
                           value="<?php echo esc_attr($projects_completed); ?>" class="small-text">
                </td>
            </tr>
            
            <tr>
                <th><label for="ar_active_projects">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</label></th>
                <td>
                    <input type="number" name="ar_active_projects" id="ar_active_projects" 
                           value="<?php echo esc_attr($active_projects); ?>" class="small-text">
                </td>
            </tr>
        </table>
    </div>
    <?php
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
add_action('personal_options_update', 'ar_save_designer_profile_meta');
add_action('edit_user_profile_update', 'ar_save_designer_profile_meta');
function ar_save_designer_profile_meta($user_id) {
    if (!current_user_can('edit_user', $user_id)) {
        return false;
    }
    
    $fields = [
        'ar_designer_specialty',
        'ar_designer_experience',
        'ar_designer_location',
        'ar_designer_price',
        'ar_designer_rating',
        'ar_designer_reviews',
        'ar_designer_about',
        'ar_designer_education',
        'ar_designer_certifications',
        'ar_designer_styles',
        'ar_portfolio_images',
        'ar_projects_completed',
        'ar_active_projects'
    ];
    
    foreach ($fields as $field) {
        if (isset($_POST[$field])) {
            update_user_meta($user_id, $field, sanitize_text_field($_POST[$field]));
        }
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É "–ü—Ä–æ—Ñ–∏–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞" –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
add_filter('manage_users_columns', 'ar_add_designer_profile_column');
function ar_add_designer_profile_column($columns) {
    $columns['designer_profile'] = '–ü—Ä–æ—Ñ–∏–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞';
    return $columns;
}

add_action('manage_users_custom_column', 'ar_show_designer_profile_column', 10, 3);
function ar_show_designer_profile_column($value, $column_name, $user_id) {
    if ($column_name == 'designer_profile') {
        $profile_url = home_url('/designer/?designer_id=' . $user_id);
        return '<a href="' . esc_url($profile_url) . '" target="_blank">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a>';
    }
    return $value;
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å" –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
add_action('ar_after_designer_cabinet_header', 'ar_add_my_profile_button');
function ar_add_my_profile_button() {
    if (!is_user_logged_in()) return;
    
    $user_id = get_current_user_id();
    $profile_url = home_url('/designer/?designer_id=' . $user_id);
    ?>
    <div style="text-align: center; margin: 20px 0;">
        <a href="<?php echo esc_url($profile_url); ?>" target="_blank" class="ar-btn" 
           style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
            üë®‚Äçüé® –ú–æ–π –ø—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        </a>
        <p style="color: #666; font-size: 0.9em; margin-top: 8px;">–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫ –≤–∏–¥—è—Ç –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç—ã</p>
    </div>
    <?php
}














/**
 * –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –≤ CRM –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏–∑ –∑–∞—è–≤–∫–∏
 */
function ar_create_crm_project_from_order($order, $designer_id) {
    global $wpdb;
    
    $projects_table = $wpdb->prefix . 'designer_projects';
    $products_table = $wpdb->prefix . 'project_products';
    $crm_table = $wpdb->prefix . 'crm_projects'; // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏
    
    // –°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ crm_projects —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $crm_table)) != $crm_table) {
        // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        ar_create_crm_projects_table();
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–µ–∫—Ç–∞
    $project_id = 'order_' . $order->id . '_' . $designer_id . '_' . time();
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $designer_data = ar_get_designer_data($designer_id);
    $user_info = get_userdata($designer_id);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±—é–¥–∂–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    $project_value = $order->budget ? floatval($order->budget) : 0;
    $designer_income = $project_value * 0.1; // 10% –∫–æ–º–∏—Å—Å–∏—è
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
    $client_address = '';
    if ($order->city && $order->country) {
        $client_address = $order->city . ', ' . $order->country;
    }
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
    $project_data = [
        'project_id' => $project_id,
        'designer_key' => 'website_order',
        'user_id' => $designer_id,
        'title' => $order->project_name ?: '–ü—Ä–æ–µ–∫—Ç –∏–∑ –∑–∞—è–≤–∫–∏ #' . $order->id,
        'currency' => $order->currency ?: '–†–£–ë',
        'value' => $project_value,
        'designer_income' => $designer_income,
        'status' => 'new',
        'client_name' => $order->client_name,
        'client_email' => $order->client_email,
        'client_address' => $client_address,
        'client_phone' => $order->client_phone ?: '',
        'project_deadline' => $order->completion_date ?: NULL,
        'is_commercial' => 0,
        'project_description' => $order->additional_info ?: '',
        'project_comment' => '–°–æ–∑–¥–∞–Ω–æ –∏–∑ –∑–∞—è–≤–∫–∏ #' . $order->id,
        'designer_name' => $designer_data['name'],
        'designer_phone' => $designer_data['phone'],
        'designer_email' => $designer_data['email'],
        'created_at' => current_time('mysql'),
        'updated_at' => current_time('mysql'),
        'metadata' => wp_json_encode([
            'source' => 'website_order',
            'order_id' => $order->id,
            'service_type' => $order->service_type,
            'area' => $order->area,
            'object_type' => $order->object_type,
            'object_status' => $order->object_status,
            'style' => $order->style,
            'created_via' => 'designer_panel',
            'created_timestamp' => time()
        ])
    ];
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç –≤ designer_projects
    $result = $wpdb->insert($projects_table, $project_data);
    
    if ($result === false) {
        error_log("ARTROCKET CRM: –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –∑–∞—è–≤–∫–∏: " . $wpdb->last_error);
        return false;
    }
    
    // –°–û–ó–î–ê–ï–ú –ó–ê–ü–ò–°–¨ –í CRM_PROJECTS –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–£
    $crm_project_data = [
        'order_id' => $order->id,
        'title' => $order->project_name,
        'client_id' => $order->client_id,
        'designer_id' => $designer_id,
        'status' => 'in_progress', // –°—Ç–∞—Ç—É—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É
        'description' => $order->additional_info,
        'budget' => $order->budget,
        'currency' => $order->currency,
        'deadline' => $order->completion_date,
        'created_at' => current_time('mysql'),
        'updated_at' => current_time('mysql')
    ];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
    $existing_crm_project = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM $crm_table WHERE order_id = %d",
        $order->id
    ));
    
    if ($existing_crm_project) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        $wpdb->update(
            $crm_table,
            $crm_project_data,
            ['order_id' => $order->id]
        );
    } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        $wpdb->insert($crm_table, $crm_project_data);
    }
    
    // –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
    $demo_products = [
        [
            'project_id' => $project_id,
            'product_name' => '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞',
            'quantity' => 1,
            'unit' => '—á–∞—Å',
            'unit_price' => 5000,
            'total_price' => 5000,
            'manufacturer_id' => 'service'
        ],
        [
            'project_id' => $project_id,
            'product_name' => '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —ç—Å–∫–∏–∑–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞',
            'quantity' => 1,
            'unit' => '–ø—Ä–æ–µ–∫—Ç',
            'unit_price' => $project_value * 0.3,
            'total_price' => $project_value * 0.3,
            'manufacturer_id' => 'design'
        ]
    ];
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
    foreach ($demo_products as $product) {
        if ($product['unit_price'] > 0) {
            $wpdb->insert($products_table, $product);
        }
    }
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    if (class_exists('AR_Project_Cache')) {
        AR_Project_Cache::clear_user_projects_cache($designer_id);
    }
    
    error_log("ARTROCKET CRM: –°–æ–∑–¥–∞–Ω –ø—Ä–æ–µ–∫—Ç {$project_id} –∏–∑ –∑–∞—è–≤–∫–∏ #{$order->id} –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞ {$designer_id}");
    
    return $project_id;
}


// –î–æ–±–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ CRM –¥–∏–∑–∞–π–Ω–µ—Ä–∞
if (!function_exists('ar_sync_crm_project_status')) {
    function ar_sync_crm_project_status($project_id, $new_status, $designer_id) {
        global $wpdb;
        
        $projects_table = $wpdb->prefix . 'designer_projects';
        $crm_table = $wpdb->prefix . 'crm_projects';
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç –∏–∑ designer_projects
        $project = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $projects_table WHERE project_id = %s AND user_id = %d",
            $project_id, $designer_id
        ));
        
        if (!$project) {
            return false;
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º order_id –∏–∑ metadata
        $metadata = json_decode($project->metadata, true);
        $order_id = isset($metadata['order_id']) ? $metadata['order_id'] : 0;
        
        if (!$order_id) {
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ order_id –ø–æ project_id (–ø—Ä–æ–µ–∫—Ç –º–æ–≥ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –∏–∑ –∑–∞—è–≤–∫–∏)
            $project_id_parts = explode('_', $project_id);
            if (isset($project_id_parts[1]) && is_numeric($project_id_parts[1])) {
                $order_id = $project_id_parts[1];
            }
        }
        
        if (!$order_id) {
            error_log("ARTROCKET CRM: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ order_id –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ {$project_id}");
            return false;
        }
        
        // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–∑ CRM –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –≤ —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
        $status_mapping = [
            'new' => 'new',              // –ù–æ–≤—ã–π
            'in_progress' => 'in_progress', // –í —Ä–∞–±–æ—Ç–µ
            'pending' => 'pending',      // –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏
            'completed' => 'completed',  // –ó–∞–≤–µ—Ä—à–µ–Ω
            'abandoned' => 'abandoned',  // –ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
            // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ç—É—Å—ã –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        ];
        
        $client_status = isset($status_mapping[$new_status]) ? $status_mapping[$new_status] : 'in_progress';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ crm_projects
        $result = $wpdb->update(
            $crm_table,
            [
                'status' => $client_status,
                'updated_at' => current_time('mysql')
            ],
            ['order_id' => $order_id]
        );
        
        if ($result === false) {
            error_log("ARTROCKET CRM: –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∑–∞—è–≤–∫–∏ #{$order_id}: " . $wpdb->last_error);
            return false;
        }
        
        error_log("ARTROCKET CRM: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ #{$order_id} -> {$client_status}");
        return true;
    }
}


// –í–∑—è—Ç—å –∑–∞—è–≤–∫—É –≤ —Ä–∞–±–æ—Ç—É
// –í–∑—è—Ç—å –∑–∞—è–≤–∫—É –≤ —Ä–∞–±–æ—Ç—É
// –í–∑—è—Ç—å –∑–∞—è–≤–∫—É –≤ —Ä–∞–±–æ—Ç—É
// –í–∑—è—Ç—å –∑–∞—è–≤–∫—É –≤ —Ä–∞–±–æ—Ç—É
add_action('wp_ajax_ar_take_order', 'ar_ajax_take_order');
function ar_ajax_take_order() {
    // ======================== –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ========================
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_designer_order_nonce')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ ID –∑–∞—è–≤–∫–∏
    if (!isset($_POST['order_id']) || empty($_POST['order_id'])) {
        wp_send_json_error('ID –∑–∞—è–≤–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω');
    }
    
    $user_id = get_current_user_id();
    $current_user = wp_get_current_user();
    $order_id = intval($_POST['order_id']);
    
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    
    // ======================== –ü–†–û–í–ï–†–ö–ê –¢–ê–ë–õ–ò–¶ ========================
    
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
        wp_send_json_error('–¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
    
    // ======================== –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê –ö –ó–ê–Ø–í–ö–ï ========================
    
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $orders_table WHERE id = %d",
        $order_id
    ));
    
    if (!$order) {
        wp_send_json_error('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ª–∏ —É–∂–µ –¥—Ä—É–≥–æ–º—É –¥–∏–∑–∞–π–Ω–µ—Ä—É
    if ($order->selected_designer_id && $order->selected_designer_id != $user_id) {
        wp_send_json_error('–≠—Ç–∞ –∑–∞—è–≤–∫–∞ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥—Ä—É–≥–æ–º—É –¥–∏–∑–∞–π–Ω–µ—Ä—É');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤–∑—è—Ç–∞ –ª–∏ —É–∂–µ —Ç–µ–∫—É—â–∏–º –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º
    if ($order->selected_designer_id == $user_id && $order->status == 'active') {
        wp_send_json_error('–í—ã —É–∂–µ –≤–∑—è–ª–∏ —ç—Ç—É –∑–∞—è–≤–∫—É –≤ —Ä–∞–±–æ—Ç—É');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞—è–≤–∫–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ pending (–¥–ª—è –æ–±—â–∏—Ö –∑–∞—è–≤–æ–∫)
    if ($order->status != 'pending') {
        wp_send_json_error('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
    }
    
    // ======================== –ü–†–û–í–ï–†–ö–ê –ü–ê–ö–ï–¢–ê –î–ò–ó–ê–ô–ù–ï–†–ê ========================
    
    // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–∞–∫–µ—Ç–∞
    if (!user_can($user_id, 'administrator')) {
        $package_status = ar_get_designer_package_status($user_id);
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–∞–∫–µ—Ç–∞
        if (!$package_status['has_package']) {
            wp_send_json_error('–î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞');
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞–∫–µ—Ç–∞
        if (!$package_status['active']) {
            wp_send_json_error('–í–∞—à –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        if ($package_status['expiry_date'] && strtotime($package_status['expiry_date']) < time()) {
            wp_send_json_error('–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤–∞—à–µ–≥–æ –ø–∞–∫–µ—Ç–∞ –∏—Å—Ç–µ–∫');
        }
        
        // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∑–∞—è–≤–æ–∫ (–µ—Å–ª–∏ –ª–∏–º–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
        if ($package_status['remaining_orders'] !== false) {
            if ($package_status['remaining_orders'] <= 0) {
                wp_send_json_error('–õ–∏–º–∏—Ç –∑–∞—è–≤–æ–∫ –≤ –≤–∞—à–µ–º –ø–∞–∫–µ—Ç–µ –∏—Å—á–µ—Ä–ø–∞–Ω');
            }
            
            // 5. –†–ï–ó–ï–†–í–ò–†–£–ï–ú –ú–ï–°–¢–û: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
            if ($package_status['order_id']) {
                $new_used = ar_increment_package_orders_used($package_status['order_id']);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –ø–æ—Å–ª–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è
                $updated_status = ar_get_designer_package_status($user_id);
                if ($updated_status['remaining_orders'] !== false && $updated_status['remaining_orders'] < 0) {
                    // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —É–≤–µ–ª–∏—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—Å–∏–ª–∏
                    ar_decrement_package_orders_used($package_status['order_id']);
                    wp_send_json_error('–õ–∏–º–∏—Ç –∑–∞—è–≤–æ–∫ –≤ –≤–∞—à–µ–º –ø–∞–∫–µ—Ç–µ –∏—Å—á–µ—Ä–ø–∞–Ω');
                }
            }
        }
    }
    
    // ======================== –°–û–ó–î–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê –í CRM ========================
    
    $project_created = ar_create_crm_project_from_order($order, $user_id);
    
    if ($project_created === false) {
        // –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
        if (!user_can($user_id, 'administrator') && isset($package_status['order_id'])) {
            ar_decrement_package_orders_used($package_status['order_id']);
        }
        wp_send_json_error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ CRM –¥–∏–∑–∞–π–Ω–µ—Ä–∞');
    }
    
    // ======================== –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –ó–ê–Ø–í–ö–ò –î–ò–ó–ê–ô–ù–ï–†–£ ========================
    
    $result = $wpdb->update(
    $orders_table,
    [
        'selected_designer_id' => $user_id,
        'selected_designer_name' => $current_user->display_name,
        'selected_designer_specialty' => get_user_meta($user_id, 'ar_designer_specialty', true) ?: '–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞',
        'selected_designer_price' => get_user_meta($user_id, 'ar_designer_price', true) ?: '10',
        'status' => 'active',
        'updated_at' => current_time('mysql')
    ],
    ['id' => $order_id],
    ['%d', '%s', '%s', '%s', '%s', '%s'],
    ['%d']
);
    
    if ($result === false) {
        // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
        if (!user_can($user_id, 'administrator') && isset($package_status['order_id'])) {
            ar_decrement_package_orders_used($package_status['order_id']);
        }
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' . $wpdb->last_error);
    }
    
    // ======================== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ========================
    
    // –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
    if (!user_can($user_id, 'administrator') && isset($package_status['order_id'])) {
        ar_log_package_usage($user_id, $order_id, 'take_order');
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
    ar_send_designer_assigned_notification($order_id, $user_id);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    update_user_meta($user_id, 'ar_active_projects', 
        intval(get_user_meta($user_id, 'ar_active_projects', true) ?: 0) + 1);
    
    wp_send_json_success([
        'message' => '–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É',
        'project_id' => $project_created
    ]);
}


/* ========================= –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–ê–ö–ï–¢–û–í ========================= */

add_action('woocommerce_checkout_update_order_meta', 'ar_handle_designer_package_purchase', 10, 2);
function ar_handle_designer_package_purchase($order_id, $data) {
    $order = wc_get_order($order_id);
    $package_product_id = 1634;
    $has_package = false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –∑–∞–∫–∞–∑–µ —Ç–æ–≤–∞—Ä —Å ID 1634
    foreach ($order->get_items() as $item) {
        if ($item->get_product_id() == $package_product_id || 
            $item->get_variation_id() == $package_product_id) {
            $has_package = true;
            break;
        }
    }
    
    if ($has_package) {
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        $user_id = $order->get_customer_id();
        
        if ($user_id) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–∞–∫–µ—Ç–∞ (30 –¥–Ω–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            $expiry_date = date('Y-m-d H:i:s', strtotime('+30 days'));
            $order->update_meta_data('_designer_package_expiry', $expiry_date);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –∑–∞—è–≤–æ–∫ (10 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            $order->update_meta_data('_designer_package_orders_limit', 10);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
            $order->update_meta_data('_designer_package_orders_used', 0);
            
            $order->save();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ –ø–∞–∫–µ—Ç–∞
            ar_send_package_purchase_notification($user_id, $order_id);
        }
    }
}

function ar_send_package_purchase_notification($user_id, $order_id) {
    $user = get_userdata($user_id);
    if (!$user) return;
    
    $order = wc_get_order($order_id);
    if (!$order) return;
    
    $expiry_date = $order->get_meta('_designer_package_expiry');
    $orders_limit = $order->get_meta('_designer_package_orders_limit');
    
    $subject = '–ü–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω - Art Rocket';
    
    $message = "
    <h2>–í–∞—à –ø–∞–∫–µ—Ç –¥–∏–∑–∞–π–Ω–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</h2>
    <p>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏–µ–º –ø–∞–∫–µ—Ç–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ Art Rocket!</p>
    
    <div style='background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin: 20px 0;'>
        <h3 style='margin-top: 0; color: #333;'>–î–µ—Ç–∞–ª–∏ –≤–∞—à–µ–≥–æ –ø–∞–∫–µ—Ç–∞:</h3>
        <p><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> #{$order_id}</p>
        <p><strong>–î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:</strong> " . date('d.m.Y H:i') . "</p>
        <p><strong>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> –¥–æ " . date('d.m.Y', strtotime($expiry_date)) . "</p>
        <p><strong>–õ–∏–º–∏—Ç –∑–∞—è–≤–æ–∫:</strong> {$orders_limit}</p>
    </div>
    
    <p><strong>–ß—Ç–æ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ:</strong></p>
    <ul>
        <li>‚úÖ –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–æ–∫ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</li>
        <li>‚úÖ –û–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ —á–µ—Ä–µ–∑ —á–∞—Ç</li>
        <li>‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ CRM —Å–∏—Å—Ç–µ–º–µ</li>
        <li>‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞</li>
    </ul>
    
    <p>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –≤ <a href='" . home_url('/designer-panel/') . "'>–ø–∞–Ω–µ–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞</a> –∏ –Ω–∞—á–∞—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞—è–≤–∫–∏!</p>
    
    <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>–ö–æ–º–∞–Ω–¥–∞ Art Rocket</p>
    ";
    
    $headers = ['Content-Type: text/html; charset=UTF-8'];
    wp_mail($user->user_email, $subject, $message, $headers);
}


// –û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –∑–∞—è–≤–∫–∏
add_action('wp_ajax_ar_release_order', 'ar_ajax_release_order');
function ar_ajax_release_order() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_designer_order_nonce')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    $user_id = get_current_user_id();
    
    if (!isset($_POST['order_id']) || empty($_POST['order_id'])) {
        wp_send_json_error('ID –∑–∞—è–≤–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω');
    }
    
    $order_id = intval($_POST['order_id']);
    
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    $crm_table = $wpdb->prefix . 'crm_projects'; // –¢–∞–±–ª–∏—Ü–∞ CRM –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞—è–≤–æ–∫
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
        wp_send_json_error('–¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞—è–≤–∫–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ª–∏ –æ–Ω–∞ —Ç–µ–∫—É—â–µ–º—É –¥–∏–∑–∞–π–Ω–µ—Ä—É
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $orders_table WHERE id = %d AND selected_designer_id = %d",
        $order_id, $user_id
    ));
    
    if (!$order) {
        wp_send_json_error('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –≤–∞–º');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –≤ CRM –Ω–∞ 'abandoned'
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $crm_table)) == $crm_table) {
        $wpdb->update(
            $crm_table,
            [
                'status' => 'abandoned',
                'designer_id' => NULL,
                'updated_at' => current_time('mysql')
            ],
            ['order_id' => $order_id]
        );
    }
    
    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∑–∞—è–≤–∫—É
    $result = $wpdb->update(
        $orders_table,
        [
            'selected_designer_id' => NULL,
            'selected_designer_name' => NULL,
            'selected_designer_specialty' => NULL,
            'selected_designer_price' => NULL,
            'status' => 'pending',
            'updated_at' => current_time('mysql')
        ],
        ['id' => $order_id]
    );
    
    if ($result === false) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' . $wpdb->last_error);
    }
    
    wp_send_json_success('–í—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç –∑–∞—è–≤–∫–∏');
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
// –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
function ar_send_designer_assigned_notification($order_id, $designer_id) {
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $orders_table WHERE id = %d",
        $order_id
    ));
    
    if (!$order) return;
    
    $designer = get_userdata($designer_id);
    if (!$designer) return;
    
    $designer_name = $designer->display_name;
    $designer_specialty = get_user_meta($designer_id, 'ar_designer_specialty', true) ?: '–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞';
    
    $subject = '–î–∏–∑–∞–π–Ω–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –≤–∞—à –ø—Ä–æ–µ–∫—Ç - Art Rocket';
    
    $message = "
    <h2>–î–∏–∑–∞–π–Ω–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –≤–∞—à –ø—Ä–æ–µ–∫—Ç!</h2>
    <p>–ú—ã —Ä–∞–¥—ã —Å–æ–æ–±—â–∏—Ç—å, —á—Ç–æ –Ω–∞ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–∏–∑–∞–π–Ω–µ—Ä.</p>
    
    <div style='background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin: 20px 0;'>
        <h3 style='margin-top: 0; color: #333;'>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–∑–∞–π–Ω–µ—Ä–µ:</h3>
        <p><strong>–ò–º—è:</strong> {$designer_name}</p>
        <p><strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</strong> {$designer_specialty}</p>
        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π email:</strong> {$designer->user_email}</p>
    </div>
    
    <p><strong>–í–∞—à –ø—Ä–æ–µ–∫—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–±–æ—Ç–µ!</strong></p>
    
    <p><strong>–î–µ—Ç–∞–ª–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:</strong></p>
    <ul>
        <li><strong>–ü—Ä–æ–µ–∫—Ç:</strong> {$order->project_name}</li>
        <li><strong>–£—Å–ª—É–≥–∞:</strong> " . ucfirst(str_replace('_', ' ', $order->service_type)) . "</li>
        <li><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {$order->city}, {$order->country}</li>
        <li><strong>–ü–ª–æ—â–∞–¥—å:</strong> {$order->area} –º¬≤</li>
    </ul>
    
    <p>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —á–∞—Ç–∞ –≤ –≤–∞—à–µ–º –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ!</p>
    
    <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>–ö–æ–º–∞–Ω–¥–∞ Art Rocket</p>
    ";
    
    $headers = ['Content-Type: text/html; charset=UTF-8'];
    wp_mail($order->client_email, $subject, $message, $headers);
    
    // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–∏–∑–∞–π–Ω–µ—Ä—É
    $designer_subject = '–í—ã –≤–∑—è–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤ —Ä–∞–±–æ—Ç—É - Art Rocket';
    $designer_message = "
    <h2>–í—ã —É—Å–ø–µ—à–Ω–æ –≤–∑—è–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤ —Ä–∞–±–æ—Ç—É!</h2>
    <p>–ü—Ä–æ–µ–∫—Ç <strong>{$order->project_name}</strong> –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É CRM —Å–∏—Å—Ç–µ–º—É.</p>
    
    <div style='background: #f0f7ff; padding: 20px; border-radius: 8px; margin: 20px 0;'>
        <h3 style='margin-top: 0; color: #333;'>–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞:</h3>
        <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> {$order->client_name}</p>
        <p><strong>Email:</strong> {$order->client_email}</p>
        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {$order->client_phone}</p>
        <p><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {$order->city}, {$order->country}</p>
        <p><strong>–ü–ª–æ—â–∞–¥—å:</strong> {$order->area} –º¬≤</p>
        <p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br>{$order->additional_info}</p>
    </div>
    
    <p>–ü—Ä–æ–µ–∫—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É CRM —Å–∏—Å—Ç–µ–º—É –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–∞–∑–¥–µ–ª–µ <strong>\"–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã\"</strong>.</p>
    <p>–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º –∏ –æ–±—â–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —á–∞—Ç.</p>
    
    <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>–ö–æ–º–∞–Ω–¥–∞ Art Rocket</p>
    ";
    
    wp_mail($designer->user_email, $designer_subject, $designer_message, $headers);
}

/* ========================= –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê ========================= */

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —á–∞—Ç–∞
function ar_create_chat_table() {
    global $wpdb;
    
    $charset_collate = $wpdb->get_charset_collate();
    $chat_table = $wpdb->prefix . 'designer_chat_messages';
    
    $sql = "CREATE TABLE $chat_table (
        id bigint(20) NOT NULL AUTO_INCREMENT,
        order_id bigint(20) NOT NULL,
        sender_id bigint(20) NOT NULL,
        receiver_id bigint(20) NOT NULL,
        message text NOT NULL,
        attachment varchar(255) DEFAULT NULL,
        is_read tinyint(1) DEFAULT 0,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        KEY order_id (order_id),
        KEY sender_id (sender_id),
        KEY receiver_id (receiver_id),
        KEY is_read (is_read)
    ) $charset_collate;";
    
    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —á–∞—Ç–∞
function ar_check_chat_table() {
    global $wpdb;
    $chat_table = $wpdb->prefix . 'designer_chat_messages';
    
    $table_exists = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $chat_table)) === $chat_table;
    
    if (!$table_exists) {
        ar_create_chat_table();
    }
    
    return true;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
function ar_get_unread_messages_count($user_id = null) {
    if (!$user_id) {
        $user_id = get_current_user_id();
    }
    
    if (!$user_id) return 0;
    
    global $wpdb;
    $chat_table = $wpdb->prefix . 'designer_chat_messages';
    $orders_table = $wpdb->prefix . 'client_orders';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $chat_table)) != $chat_table) {
        return 0;
    }
    
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
        return 0;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏, –≥–¥–µ –¥–∏–∑–∞–π–Ω–µ—Ä —è–≤–ª—è–µ—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º
    $designer_orders = $wpdb->get_col($wpdb->prepare(
        "SELECT id FROM $orders_table WHERE selected_designer_id = %d",
        $user_id
    ));
    
    if (empty($designer_orders) || !is_array($designer_orders)) {
        return 0;
    }
    
    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –≤—Å–µ ID –∑–∞–∫–∞–∑–æ–≤ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Ü–µ–ª—ã–º–∏ —á–∏—Å–ª–∞–º–∏
    $designer_orders = array_filter(array_map('intval', $designer_orders), function($id) {
        return $id > 0;
    });
    
    if (empty($designer_orders)) {
        return 0;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º placeholders –¥–ª—è SQL –∑–∞–ø—Ä–æ—Å–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    $placeholders = implode(',', array_fill(0, count($designer_orders), '%d'));
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
    $params = array_merge([$user_id], $designer_orders);
    
    // –°—á–∏—Ç–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∑ –∑–∞—è–≤–æ–∫ –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    $query = $wpdb->prepare(
        "SELECT COUNT(*) FROM $chat_table 
         WHERE receiver_id = %d 
         AND is_read = 0 
         AND order_id IN ($placeholders)",
        ...$params
    );
    
    $count = $wpdb->get_var($query);
    
    if ($count === null) {
        error_log('AR_CHAT: Failed to get unread messages count for user ' . $user_id);
        return 0;
    }
    
    return intval($count);
}

/* ========================= AJAX –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ß–ê–¢–ê ========================= */

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
add_action('wp_ajax_ar_send_chat_message', 'ar_ajax_send_chat_message');
function ar_ajax_send_chat_message() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_chat_nonce')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    $user_id = get_current_user_id();
    
    // Rate limiting: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $last_message_time = get_transient('ar_chat_last_message_' . $user_id);
    if ($last_message_time && (time() - $last_message_time) < 2) {
        wp_send_json_error('–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.');
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (!isset($_POST['order_id']) || !isset($_POST['receiver_id']) || !isset($_POST['message'])) {
        wp_send_json_error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö');
    }
    
    $order_id = intval($_POST['order_id']);
    $receiver_id = intval($_POST['receiver_id']);
    $message = trim(sanitize_textarea_field($_POST['message']));
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    if ($order_id <= 0 || $receiver_id <= 0) {
        wp_send_json_error('–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã');
    }
    
    if ($user_id === $receiver_id) {
        wp_send_json_error('–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ');
    }
    
    if (empty($message)) {
        wp_send_json_error('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
    }
    
    if (strlen($message) > 1000) {
        wp_send_json_error('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ');
    }
    
    global $wpdb;
    $chat_table = $wpdb->prefix . 'designer_chat_messages';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $chat_table)) != $chat_table) {
        wp_send_json_error('–¢–∞–±–ª–∏—Ü–∞ —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É —á–∞—Ç—É
    if (!ar_has_chat_access($user_id, $order_id, $receiver_id)) {
        wp_send_json_error('–î–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É –∑–∞–ø—Ä–µ—â–µ–Ω');
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    $result = $wpdb->insert($chat_table, [
        'order_id' => $order_id,
        'sender_id' => $user_id,
        'receiver_id' => $receiver_id,
        'message' => $message,
        'is_read' => 0,
        'created_at' => current_time('mysql')
    ], ['%d', '%d', '%d', '%s', '%d', '%s']);
    
    if ($result === false) {
        error_log('AR_CHAT: Failed to insert message. Error: ' . $wpdb->last_error);
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
    
    $message_id = $wpdb->insert_id;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º transient –¥–ª—è rate limiting
    set_transient('ar_chat_last_message_' . $user_id, time(), 60);
    
    $current_timestamp = current_time('timestamp');
    
    wp_send_json_success([
        'message_id' => $message_id,
        'timestamp' => current_time('mysql'),
        'formatted_time' => date('H:i', $current_timestamp)
    ]);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
add_action('wp_ajax_ar_get_chat_messages', 'ar_ajax_get_chat_messages');
function ar_ajax_get_chat_messages() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_chat_nonce')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    $user_id = get_current_user_id();
    
    if (!isset($_POST['order_id']) || !isset($_POST['other_user_id'])) {
        wp_send_json_error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö');
    }
    
    $order_id = intval($_POST['order_id']);
    $other_user_id = intval($_POST['other_user_id']);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if ($order_id <= 0 || $other_user_id <= 0) {
        wp_send_json_error('–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã');
    }
    
    if ($user_id === $other_user_id) {
        wp_send_json_error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É
    if (!ar_has_chat_access($user_id, $order_id, $other_user_id)) {
        wp_send_json_error('–î–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É –∑–∞–ø—Ä–µ—â–µ–Ω');
    }
    
    global $wpdb;
    $chat_table = $wpdb->prefix . 'designer_chat_messages';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $chat_table)) != $chat_table) {
        wp_send_json_error('–¢–∞–±–ª–∏—Ü–∞ —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º prepared statement
    $messages = $wpdb->get_results($wpdb->prepare(
        "SELECT * FROM $chat_table 
         WHERE order_id = %d 
         AND ((sender_id = %d AND receiver_id = %d) OR (sender_id = %d AND receiver_id = %d))
         ORDER BY created_at ASC",
        $order_id, $user_id, $other_user_id, $other_user_id, $user_id
    ));
    
    if ($messages === null) {
        error_log('AR_CHAT: Failed to get messages. Error: ' . $wpdb->last_error);
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
    }
    
    // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    $update_result = $wpdb->update(
        $chat_table,
        ['is_read' => 1],
        [
            'order_id' => $order_id,
            'receiver_id' => $user_id,
            'is_read' => 0
        ],
        ['%d'],
        ['%d', '%d', '%d']
    );
    
    if ($update_result === false) {
        error_log('AR_CHAT: Failed to mark messages as read. Error: ' . $wpdb->last_error);
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞
    $formatted_messages = [];
    foreach ($messages as $message) {
        $formatted_messages[] = [
            'id' => intval($message->id),
            'sender_id' => intval($message->sender_id),
            'receiver_id' => intval($message->receiver_id),
            'message' => esc_html($message->message),
            'timestamp' => $message->created_at,
            'formatted_time' => date('H:i', strtotime($message->created_at)),
            'is_sent' => (intval($message->sender_id) === $user_id),
            'is_read' => (intval($message->is_read) === 1)
        ];
    }
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
    $other_user = get_userdata($other_user_id);
    
    if (!$other_user) {
        wp_send_json_error('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    $other_user_info = [
        'name' => $other_user->display_name,
        'is_online' => ar_is_user_online($other_user_id)
    ];
    
    wp_send_json_success([
        'messages' => $formatted_messages,
        'other_user' => $other_user_info,
        'current_user_id' => $user_id
    ]);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
add_action('wp_ajax_ar_check_new_messages', 'ar_ajax_check_new_messages');
function ar_ajax_check_new_messages() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'ar_chat_nonce')) {
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    }
    
    if (!is_user_logged_in()) {
        wp_send_json_error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
    
    $user_id = get_current_user_id();
    
    global $wpdb;
    $chat_table = $wpdb->prefix . 'designer_chat_messages';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $chat_table)) != $chat_table) {
        wp_send_json_success(['unread_count' => 0]);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    $unread_count = $wpdb->get_var($wpdb->prepare(
        "SELECT COUNT(*) FROM $chat_table WHERE receiver_id = %d AND is_read = 0",
        $user_id
    ));
    
    if ($unread_count === null) {
        error_log('AR_CHAT: Failed to check new messages. Error: ' . $wpdb->last_error);
        wp_send_json_error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    update_user_meta($user_id, 'ar_last_activity', current_time('mysql'));
    
    wp_send_json_success([
        'unread_count' => intval($unread_count)
    ]);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É
function ar_has_chat_access($user_id, $order_id, $other_user_id) {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if (!$user_id || !$order_id || !$other_user_id) {
        error_log('AR_CHAT: Invalid parameters in ar_has_chat_access');
        return false;
    }
    
    if ($user_id === $other_user_id) {
        error_log('AR_CHAT: User trying to chat with themselves');
        return false;
    }
    
    global $wpdb;
    $orders_table = $wpdb->prefix . 'client_orders';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $orders_table)) != $orders_table) {
        error_log('AR_CHAT: Orders table does not exist');
        return false;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT client_id, selected_designer_id, status FROM $orders_table WHERE id = %d",
        $order_id
    ));
    
    if (!$order) {
        error_log('AR_CHAT: Order not found: ' . $order_id);
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∏–∑–∞–π–Ω–µ—Ä –≤—ã–±—Ä–∞–Ω
    if (empty($order->selected_designer_id) || intval($order->selected_designer_id) <= 0) {
        error_log('AR_CHAT: No designer selected for order: ' . $order_id);
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞—è–≤–∫–∞ –Ω–µ —É–¥–∞–ª–µ–Ω–∞ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞
    $forbidden_statuses = ['deleted', 'cancelled', 'rejected'];
    if (in_array($order->status, $forbidden_statuses)) {
        error_log('AR_CHAT: Order has forbidden status: ' . $order->status);
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–µ–Ω—Ç–æ–º –∏–ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º —ç—Ç–æ–π –∑–∞—è–≤–∫–∏
    $is_client = (intval($user_id) === intval($order->client_id));
    $is_designer = (intval($user_id) === intval($order->selected_designer_id));
    $is_other_party = (intval($other_user_id) === intval($order->client_id)) || (intval($other_user_id) === intval($order->selected_designer_id));
    
    $has_access = ($is_client || $is_designer) && $is_other_party;
    
    if (!$has_access) {
        error_log(sprintf(
            'AR_CHAT: Access denied. User: %d, Order: %d, Other: %d, Client: %d, Designer: %d',
            $user_id, $order_id, $other_user_id, $order->client_id, $order->selected_designer_id
        ));
    }
    
    return $has_access;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
function ar_is_user_online($user_id) {
    if (!$user_id) {
        return false;
    }
    
    $last_activity = get_user_meta($user_id, 'ar_last_activity', true);
    
    if (!$last_activity) {
        return false;
    }
    
    // –°—á–∏—Ç–∞–µ–º –æ–Ω–ª–∞–π–Ω, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–∏–Ω—É—Ç—ã
    $online_threshold = 3 * 60; // 3 –º–∏–Ω—É—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    $time_diff = time() - strtotime($last_activity);
    
    return $time_diff < $online_threshold;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
function ar_get_last_seen_time($user_id) {
    if (!$user_id) {
        return '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
    
    $last_activity = get_user_meta($user_id, 'ar_last_activity', true);
    
    if (!$last_activity) {
        return '–¥–∞–≤–Ω–æ';
    }
    
    $time_diff = time() - strtotime($last_activity);
    
    if ($time_diff < 60) {
        return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    } elseif ($time_diff < 3600) {
        $minutes = floor($time_diff / 60);
        return $minutes . ' ' . ar_get_noun_plural($minutes, '–º–∏–Ω—É—Ç—É', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç') . ' –Ω–∞–∑–∞–¥';
    } elseif ($time_diff < 86400) {
        $hours = floor($time_diff / 3600);
        return $hours . ' ' . ar_get_noun_plural($hours, '—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤') . ' –Ω–∞–∑–∞–¥';
    } else {
        $days = floor($time_diff / 86400);
        return $days . ' ' . ar_get_noun_plural($days, '–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π') . ' –Ω–∞–∑–∞–¥';
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö
function ar_get_noun_plural($number, $one, $two, $five) {
    $number = abs($number);
    $number %= 100;
    
    if ($number >= 5 && $number <= 20) {
        return $five;
    }
    
    $number %= 10;
    
    if ($number == 1) {
        return $one;
    }
    
    if ($number >= 2 && $number <= 4) {
        return $two;
    }
    
    return $five;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å AJAX –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
function ar_update_user_activity() {
    if (is_user_logged_in()) {
        $user_id = get_current_user_id();
        update_user_meta($user_id, 'ar_last_activity', current_time('mysql'));
    }
}

// –í–µ—à–∞–µ–º –Ω–∞ –±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö—É–∫–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
add_action('wp_head', 'ar_update_user_activity');
add_action('wp_footer', 'ar_update_user_activity');
add_action('admin_head', 'ar_update_user_activity');
add_action('admin_footer', 'ar_update_user_activity');

// AJAX endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
add_action('wp_ajax_ar_update_activity', 'ar_ajax_update_activity');
add_action('wp_ajax_nopriv_ar_update_activity', 'ar_ajax_update_activity');
function ar_ajax_update_activity() {
    if (is_user_logged_in()) {
        $user_id = get_current_user_id();
        update_user_meta($user_id, 'ar_last_activity', current_time('mysql'));
        wp_send_json_success();
    }
    wp_send_json_error();
}
add_action('wp_head', 'ar_update_user_activity');

/* ========================= –°–û–ó–î–ê–ù–ò–ï –°–¢–†–ê–ù–ò–¶–´ –î–õ–Ø –î–ò–ó–ê–ô–ù–ï–†–û–í ========================= */

// –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤
function ar_create_designer_orders_page() {
    $page_title = '–ü–∞–Ω–µ–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞';
    $page_content = '[ar_designer_orders]';
    
    $page = get_page_by_title($page_title);
    
    if (!$page) {
        $page_data = array(
            'post_title'    => $page_title,
            'post_content'  => $page_content,
            'post_status'   => 'publish',
            'post_type'     => 'page',
            'post_author'   => 1,
            'post_name'     => 'designer-panel'
        );
        
        $page_id = wp_insert_post($page_data);
        
        if ($page_id && !is_wp_error($page_id)) {
            update_post_meta($page_id, '_ar_designer_orders_page', 'true');
        }
    } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        $page_data = array(
            'ID'           => $page->ID,
            'post_content' => $page_content,
            'post_status'  => 'publish'
        );
        wp_update_post($page_data);
    }
}

// –°–æ–∑–¥–∞–µ–º —Ä–æ–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞
function ar_create_designer_role() {
    if (!get_role('designer')) {
        add_role('designer', 'Designer', [
            'read' => true,
            'edit_posts' => true,
            'delete_posts' => false,
            'upload_files' => true
        ]);
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∞–∫—Ç–∏–≤–∞—Ü–∏—é
add_action('init', 'ar_check_designer_system');
function ar_check_designer_system() {
    // –°–æ–∑–¥–∞–µ–º —Ä–æ–ª—å –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    ar_create_designer_role();
    
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —á–∞—Ç–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    ar_check_chat_table();
    
    // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if (is_admin() && current_user_can('activate_plugins')) {
        ar_create_designer_orders_page();
    }
}





/* ========================= –°–û–ó–î–ê–ù–ò–ï –°–¢–†–ê–ù–ò–¶–´ –î–õ–Ø –î–ò–ó–ê–ô–ù–ï–†–û–í END========================= */






















/* ========= DESIGNER TASK CABINET SYSTEM START ========= */



/* ========= DESIGNER TASKS KANBAN SYSTEM START ========= */

/* ========= DESIGNER TASKS KANBAN SYSTEM START ========= */

/**
 * –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞–¥–∞—á –¥–∏–∑–∞–π–Ω–µ—Ä–∞
 */
function art_create_tasks_table() {
    global $wpdb;

    $charset_collate = $wpdb->get_charset_collate();
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    // –í–∞–∂–Ω–æ: –¥–ª—è TEXT –Ω–µ–ª—å–∑—è –∑–∞–¥–∞–≤–∞—Ç—å DEFAULT. –£–±—Ä–∞–Ω–æ.
    $sql_tasks = "CREATE TABLE $tasks_table (
        id bigint(20) NOT NULL AUTO_INCREMENT,
        task_id varchar(100) NOT NULL,
        user_id bigint(20) NOT NULL,
        project_id varchar(100) DEFAULT NULL,
        title text NOT NULL,
        description text NULL,
        status varchar(50) DEFAULT 'next_week',
        priority varchar(20) DEFAULT 'medium',
        deadline date DEFAULT NULL,
        completed_at datetime DEFAULT NULL,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        metadata text NULL,
        PRIMARY KEY (id),
        UNIQUE KEY task_id (task_id),
        KEY user_id (user_id),
        KEY project_id (project_id),
        KEY status (status),
        KEY deadline (deadline),
        KEY priority (priority),
        KEY completed_at (completed_at)
    ) $charset_collate;";

    require_once ABSPATH . 'wp-admin/includes/upgrade.php';
    dbDelta($sql_tasks);

    error_log("ARTROCKET TASKS: Tasks table created/updated successfully");
}

add_action('init', 'art_check_tasks_table_structure');
function art_check_tasks_table_structure() {
    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    // 1) –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≥–æ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É —á–µ—Ä–µ–∑ dbDelta (–æ–Ω–∞ idempotent –∏ –¥–æ–≥–æ–Ω–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è/–∏–Ω–¥–µ–∫—Å—ã)
    require_once ABSPATH . 'wp-admin/includes/upgrade.php';

    $charset_collate = $wpdb->get_charset_collate();
    $sql_tasks = "CREATE TABLE $tasks_table (
        id bigint(20) NOT NULL AUTO_INCREMENT,
        task_id varchar(100) NOT NULL,
        user_id bigint(20) NOT NULL,
        project_id varchar(100) DEFAULT NULL,
        title text NOT NULL,
        description text NULL,
        status varchar(50) DEFAULT 'next_week',
        priority varchar(20) DEFAULT 'medium',
        deadline date DEFAULT NULL,
        completed_at datetime DEFAULT NULL,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        metadata text NULL,
        PRIMARY KEY (id),
        UNIQUE KEY task_id (task_id),
        KEY user_id (user_id),
        KEY project_id (project_id),
        KEY status (status),
        KEY deadline (deadline),
        KEY priority (priority),
        KEY completed_at (completed_at)
    ) $charset_collate;";

    dbDelta($sql_tasks);

    // 2) –ü–µ—Ä–µ—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –≤–¥—Ä—É–≥ dbDelta –Ω–µ –¥–æ–±–∞–≤–∏–ª completed_at (–±—ã–≤–∞–µ—Ç –Ω–∞ —Å—Ç–∞—Ä—ã—Ö MySQL)
    $has_completed = $wpdb->get_var( $wpdb->prepare(
        "SELECT COUNT(*) FROM information_schema.COLUMNS 
         WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = %s AND COLUMN_NAME = 'completed_at'",
        $tasks_table
    ) );

    if (!$has_completed) {
        $wpdb->query("ALTER TABLE $tasks_table ADD COLUMN completed_at DATETIME NULL DEFAULT NULL AFTER deadline");
        // –∏–Ω–¥–µ–∫—Å ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–ø–æ–¥–∞–≤–∏–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å)
        @$wpdb->query("ALTER TABLE $tasks_table ADD INDEX completed_at (completed_at)");
    }
}

/**
 * –®–æ—Ä—Ç–∫–æ–¥ –¥–ª—è –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏ –∑–∞–¥–∞—á
 */
add_shortcode('art_tasks_kanban', 'art_render_tasks_kanban');
function art_render_tasks_kanban() {
    if (!is_user_logged_in()) {
        return '<p>–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á.</p>';
    }

    $user_id = get_current_user_id();
    $user = wp_get_current_user();
    $tasks = art_get_user_tasks($user_id);
    $projects = (class_exists('AR_Project_Cache') && method_exists('AR_Project_Cache', 'get_user_projects'))
        ? AR_Project_Cache::get_user_projects($user_id)
        : [];

    error_log("ART TASKS: Found " . count($tasks) . " tasks for user $user_id");

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    $grouped_tasks = [
        'overdue'    => ['title' => '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ',         'icon' => 'üö®', 'tasks' => []],
        'today'      => ['title' => '–°–µ–≥–æ–¥–Ω—è',             'icon' => 'üî¥', 'tasks' => []],
        'this_week'  => ['title' => '–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ',  'icon' => 'üü°', 'tasks' => []],
        'next_week'  => ['title' => '–ù–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ', 'icon' => 'üü¢', 'tasks' => []],
        'completed'  => ['title' => '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ',         'icon' => '‚úÖ', 'tasks' => []],
    ];

    foreach ($tasks as $task) {
        $status = $task['status'] ?? 'next_week';
        if (isset($grouped_tasks[$status])) {
            $grouped_tasks[$status]['tasks'][] = $task;
            error_log("ART TASKS: Task '{$task['title']}' added to status: $status");
        } else {
            error_log("ART TASKS: Task '{$task['title']}' has unknown status: $status");
        }
    }

    // –ù–æ–Ω—Å—ã –¥–ª—è AJAX
    $nonce_update_status = wp_create_nonce('art_update_task_status');
    $nonce_get_task      = wp_create_nonce('art_get_task');
    $nonce_save_task     = wp_create_nonce('art_save_task');
    $nonce_delete_task   = wp_create_nonce('art_delete_task');
    $nonce_update_dead   = wp_create_nonce('art_update_task_deadline');

    ob_start();
    ?>
    <div class="art-tasks-container">
        <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="ar-account-header">
            <div class="ar-header-top">
                <div class="ar-user-info">
                    <div class="ar-user-avatar">
                        <?php
                        $avatar_url = get_user_meta($user_id, 'ar_profile_avatar', true);
                        if (!$avatar_url) {
                            $avatar_url = get_avatar_url($user_id, ['size' => 40]);
                        }
                        ?>
                        <img src="<?php echo esc_url($avatar_url); ?>" alt="<?php echo esc_attr($user->display_name); ?>" class="ar-avatar">
                    </div>
                    <div class="ar-user-details">
                        <div class="ar-user-name"><?php echo esc_html($user->display_name); ?></div>
                        <div class="ar-user-role">–ü–∞—Ä—Ç–Ω–µ—Ä-–¥–∏–∑–∞–π–Ω–µ—Ä Art Rocket</div>
                    </div>
                </div>

                <div class="ar-header-actions">
                    <nav class="ar-main-nav">
                        <ul class="ar-nav-list">
                            <li class="ar-nav-item">
                                <a href="https://art-rocket.ru/proiectele/" target="_blank" class="ar-nav-link">
                                    <span class="ar-nav-icon">üìÅ</span>
                                    –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã
                                </a>
                            </li>
                            <li class="ar-nav-item is-active">
                                <a href="https://art-rocket.ru/designer-tascuri/" class="ar-nav-link">
                                    <span class="ar-nav-icon">üìã</span>
                                    –ó–∞–¥–∞—á–∏
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <div class="ar-action-buttons">
                        <button class="ar-btn-refresh" onclick="artRefreshTasks()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                                <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                            </svg>
                            –û–±–Ω–æ–≤–∏—Ç—å
                        </button>

                        <button class="ar-logout-btn" onclick="artOpenCreateTaskModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M12 5v14M5 12h14"></path>
                            </svg>
                            –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                        </button>
                    </div>
                </div>
            </div>

            <div class="ar-header-bottom">
                <div class="ar-stats-overview">
                    <div class="ar-stat-item">
                        <span class="ar-stat-number"><?php echo (int) count($tasks); ?></span>
                        <span class="ar-stat-label">–í–°–ï–ì–û –ó–ê–î–ê–ß</span>
                    </div>
                    <div class="ar-stat-item">
                        <span class="ar-stat-number"><?php echo (int) count($grouped_tasks['overdue']['tasks']); ?></span>
                        <span class="ar-stat-label">–ü–†–û–°–†–û–ß–ï–ù–ù–´–ï</span>
                    </div>
                    <div class="ar-stat-item">
                        <span class="ar-stat-number"><?php echo (int) count($grouped_tasks['today']['tasks']); ?></span>
                        <span class="ar-stat-label">–°–ï–ì–û–î–ù–Ø</span>
                    </div>
                    <div class="ar-stat-item">
                        <span class="ar-stat-number"><?php echo (int) count($grouped_tasks['completed']['tasks']); ?></span>
                        <span class="ar-stat-label">–ó–ê–í–ï–†–®–ï–ù–ù–´–ï</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–∞–Ω–±–∞–Ω -->
        <div class="art-tasks-kanban">
            <?php foreach ($grouped_tasks as $status => $group): ?>
                <div class="art-tasks-column" data-status="<?php echo esc_attr($status); ?>">
                    <div class="art-tasks-column-header">
                        <span class="art-column-icon"><?php echo $group['icon']; ?></span>
                        <h3><?php echo esc_html($group['title']); ?></h3>
                        <span class="art-column-count"><?php echo (int) count($group['tasks']); ?></span>
                    </div>

                    <div class="art-tasks-list" id="art-tasks-<?php echo esc_attr($status); ?>" data-status="<?php echo esc_attr($status); ?>">
                        <?php
                        if (!empty($group['tasks'])):
                            foreach ($group['tasks'] as $task):
                                $project_title = art_get_project_title($task['project_id'] ?? '', $projects);
                                $is_overdue = art_is_task_overdue($task);
                                $priority_class = art_get_priority_class($task['priority'] ?? 'medium');

                                $deadline_str = '';
                                if (!empty($task['deadline']) && $task['deadline'] !== '0000-00-00') {
                                    $ts = strtotime($task['deadline']);
                                    if ($ts) $deadline_str = date('d.m.Y', $ts);
                                }
                        ?>
                        <div class="art-task-card <?php echo $is_overdue ? 'overdue' : ''; ?> <?php echo ($status === 'completed') ? 'completed' : ''; ?>"
                             draggable="<?php echo ($status === 'completed') ? 'false' : 'true'; ?>"
                             data-task-id="<?php echo esc_attr($task['task_id']); ?>">
                            <div class="art-task-header">
                                <h4 class="art-task-title"><?php echo esc_html($task['title']); ?></h4>
                                <div class="art-task-actions">
                                    <button class="art-task-btn" onclick="artEditTask('<?php echo esc_js($task['task_id']); ?>')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="art-task-btn" onclick="artDeleteTask('<?php echo esc_js($task['task_id']); ?>')" title="–£–¥–∞–ª–∏—Ç—å">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <?php if (!empty($task['description'])): ?>
                                <div class="art-task-description"><?php echo esc_html($task['description']); ?></div>
                            <?php endif; ?>

                            <div class="art-task-meta">
                                <?php if ($project_title): ?>
                                    <div class="art-task-project-badge" onclick="artShowProject('<?php echo esc_js($task['project_id']); ?>')">
                                        <?php echo esc_html($project_title); ?>
                                    </div>
                                <?php endif; ?>

                                <div class="art-task-info">
                                    <span class="art-task-deadline <?php echo $is_overdue ? 'overdue' : ''; ?>">
                                        <?php echo $deadline_str ? esc_html($deadline_str) : '‚Äî'; ?>
                                        <?php if ($is_overdue && $status !== 'completed'): ?>
                                            <span class="art-task-overdue-badge">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!</span>
                                        <?php endif; ?>
                                    </span>
                                    <span class="art-priority-badge <?php echo esc_attr($priority_class); ?>">
                                        <?php echo esc_html(art_get_priority_label($task['priority'] ?? 'medium')); ?>
                                    </span>
                                </div>
                            </div>

                            <div class="art-task-footer">
                                <?php if ($status !== 'completed'): ?>
                                    <button class="art-task-complete-btn" onclick="artCompleteTask('<?php echo esc_js($task['task_id']); ?>')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        –ó–∞–≤–µ—Ä—à–∏—Ç—å
                                    </button>
                                <?php else: ?>
                                    <button class="art-task-resume-btn" onclick="artResumeTask('<?php echo esc_js($task['task_id']); ?>')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                            <path d="M3 3v5h5"></path>
                                        </svg>
                                        –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                <?php endif; ?>
                            </div>
                        </div>
                        <?php
                            endforeach;
                        else:
                            echo '<div class="art-empty-column">
                                    <div class="art-empty-icon">üìù</div>
                                    <p>–ù–µ—Ç –∑–∞–¥–∞—á</p>
                                  </div>';
                        endif;
                        ?>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="artTaskModal" class="art-modal" aria-hidden="true">
        <div class="art-modal-content" role="dialog" aria-modal="true" aria-labelledby="artTaskModalTitle">
            <div class="art-modal-header">
                <h2 id="artTaskModalTitle">‚ûï –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
                <button class="art-modal-close" onclick="artCloseTaskModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            </div>

            <div class="art-modal-body">
                <form id="artTaskForm">
                    <input type="hidden" id="artTaskId" name="task_id">

                    <div class="art-form-group">
                        <label class="art-form-label" for="artTaskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                        <input type="text" class="art-form-input" id="artTaskTitle" name="title" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
                    </div>

                    <div class="art-form-group">
                        <label class="art-form-label" for="artTaskDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="art-form-input" id="artTaskDescription" name="description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"></textarea>
                    </div>

                    <div class="art-form-grid">
                        <div class="art-form-group">
                            <label class="art-form-label" for="artTaskProject">–ü—Ä–æ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <select class="art-form-input" id="artTaskProject" name="project_id">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                                <?php foreach ($projects as $project): ?>
                                    <option value="<?php echo esc_attr($project['project_id']); ?>">
                                        <?php echo esc_html($project['title']); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>

                        <div class="art-form-group">
                            <label class="art-form-label" for="artTaskPriority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                            <select class="art-form-input" id="artTaskPriority" name="priority">
                                <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                                <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                                <option value="urgent">üî¥ –°—Ä–æ—á–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>

                    <div class="art-form-group">
                        <label class="art-form-label" for="artTaskDeadline">–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ *</label>
                        <input type="date" class="art-form-input" id="artTaskDeadline" name="deadline" required>
                    </div>
                </form>
            </div>

            <div class="art-modal-footer">
                <button class="art-btn art-btn-secondary" type="button" onclick="artCloseTaskModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="art-btn art-btn-primary" type="button" onclick="artSaveTask()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª —Å–º–µ–Ω—ã –¥–µ–¥–ª–∞–π–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) -->
    <div id="artDeadlineModal" class="art-modal" aria-hidden="true">
        <div class="art-modal-content" role="dialog" aria-modal="true">
            <div class="art-modal-header">
                <h2>üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫</h2>
                <button class="art-modal-close" onclick="artCloseDeadlineModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            </div>

            <div class="art-modal-body">
                <p id="artDeadlineMessage">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏:</p>
                <div class="art-form-group">
                    <label class="art-form-label" for="artNewDeadline">–ù–æ–≤—ã–π –∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ *</label>
                    <input type="date" class="art-form-input" id="artNewDeadline" required>
                </div>
            </div>

            <div class="art-modal-footer">
                <button class="art-btn art-btn-secondary" type="button" onclick="artCloseDeadlineModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="art-btn art-btn-primary" type="button" onclick="artConfirmDeadlineChange()">üíæ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        
        
    // 0) –≤–≤–µ—Ä—Ö—É —Å–∫—Ä–∏–ø—Ç–∞ (—Ä—è–¥–æ–º —Å ART_AJAX)
function artBuster(url){ return url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(); }
const ART_FETCH_OPTS = {
  method: 'POST',
  cache: 'no-store',
  headers: { 'Cache-Control':'no-cache, no-store, must-revalidate', 'Pragma':'no-cache' }
};

// 1) —É–Ω–∏–≤–µ—Ä—Å–∞–ª–∫–∞: –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö
function artUpdateCounts() {
  document.querySelectorAll('.art-tasks-list').forEach(list => {
    const status = list.dataset.status;
    const count = list.querySelectorAll('.art-task-card').length;
    const column = list.closest('.art-tasks-column');
    if (!column) return;
    const badge = column.querySelector('.art-column-count');
    if (badge) badge.textContent = String(count);
  });
}

// 2) —É–Ω–∏–≤–µ—Ä—Å–∞–ª–∫–∞: –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é/–∞–∫—Ç–∏–≤–Ω—É—é
function artMarkCompleted(card, isCompleted){
  if (!card) return;
  card.classList.toggle('completed', !!isCompleted);
  card.setAttribute('draggable', isCompleted ? 'false' : 'true');
  const footer = card.querySelector('.art-task-footer');
  if (footer){
    footer.innerHTML = isCompleted
      ? `<button class="art-task-resume-btn" onclick="artResumeTask('${card.dataset.taskId}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
              <path d="M3 3v5h5"></path>
            </svg>
            Reia
         </button>`
      : `<button class="art-task-complete-btn" onclick="artCompleteTask('${card.dataset.taskId}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            FinalizeazƒÉ
         </button>`;
  }
}    
        
        
        
    // ==== –ö–æ–Ω—Ñ–∏–≥ AJAX –∏ –Ω–æ–Ω—Å—ã ====
    const ART_AJAX = {
        url: '<?php echo esc_js(admin_url("admin-ajax.php")); ?>',
        nonce_update_status: '<?php echo esc_js($nonce_update_status); ?>',
        nonce_get_task: '<?php echo esc_js($nonce_get_task); ?>',
        nonce_save_task: '<?php echo esc_js($nonce_save_task); ?>',
        nonce_delete_task: '<?php echo esc_js($nonce_delete_task); ?>',
        nonce_update_deadline: '<?php echo esc_js($nonce_update_dead); ?>'
    };

    // ==== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====
    let artCurrentDraggedTask = null;

    document.addEventListener('DOMContentLoaded', function() {
        // –ú–∏–Ω. –¥–∞—Ç–∞ ‚Äî —Å–µ–≥–æ–¥–Ω—è
        const today = new Date().toISOString().split('T')[0];
        const deadlineField = document.getElementById('artTaskDeadline');
        const newDeadlineField = document.getElementById('artNewDeadline');

        if (deadlineField) deadlineField.min = today;
        if (newDeadlineField) newDeadlineField.min = today;

        // –î–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é +7 –¥–Ω–µ–π
        if (deadlineField && !deadlineField.value) {
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            deadlineField.value = nextWeek.toISOString().split('T')[0];
        }

        artInitializeDragAndDrop();
    });

    // ==== Drag & Drop ====
    function artInitializeDragAndDrop() {
        // –ö–∞—Ä—Ç–æ—á–∫–∏ (–∫—Ä–æ–º–µ completed)
        const taskCards = document.querySelectorAll('.art-task-card:not(.completed)');
        // –ó–æ–Ω—ã –¥—Ä–æ–ø–∞ ‚Äî —Å–ø–∏—Å–∫–∏
        const dropZones = document.querySelectorAll('.art-tasks-list');

        taskCards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                artCurrentDraggedTask = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.dataset.taskId || '');
                this.classList.add('dragging');
            });

            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                artCurrentDraggedTask = null;
                dropZones.forEach(z => z.classList.remove('drag-over'));
            });
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', function(e) {
                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É, –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä —É—à—ë–ª –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∑–æ–Ω—ã
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over');
                }
            });

            zone.addEventListener('drop', function(e) {
  e.preventDefault();
  this.classList.remove('drag-over');

  const newStatus = this.getAttribute('data-status');
  if (!artCurrentDraggedTask || !newStatus) return;

  const prevList = artCurrentDraggedTask.closest('.art-tasks-list');
  const prevStatus = prevList ? prevList.dataset.status : null;

  // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∫–∞—Ä—Ç–æ—á–∫—É
  this.appendChild(artCurrentDraggedTask);
  artUpdateCounts();

  const taskId = artCurrentDraggedTask.dataset.taskId;
  artUpdateTaskStatus(taskId, newStatus, { prevList, prevStatus, newList: this });
});
        });
    }
// AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–±–µ–∑ reload)
function artUpdateTaskStatus(taskId, newStatus, ctx = {}) {
  if (!taskId || !newStatus) return;

  const data = new FormData();
  data.append('action', 'art_update_task_status');
  data.append('task_id', taskId);
  data.append('status', newStatus);
  data.append('nonce', ART_AJAX.nonce_update_status);

  fetch(artBuster(ART_AJAX.url), { ...ART_FETCH_OPTS, body: data })
    .then(r => r.json())
    .then(resp => {
      if (resp && resp.success) {
        artShowNotification('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞!', 'success');
      } else {
        // –æ—Ç–∫–∞—Ç –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—Ö–µ
        if (ctx.prevList && artCurrentDraggedTask) ctx.prevList.appendChild(artCurrentDraggedTask);
        artUpdateCounts();
        artShowNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (resp && resp.data ? resp.data : ''), 'error');
      }
    })
    .catch(() => {
      if (ctx.prevList && artCurrentDraggedTask) ctx.prevList.appendChild(artCurrentDraggedTask);
      artUpdateCounts();
      artShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
    });
}

    // ==== –ú–æ–¥–∞–ª–∫–∏: —Å–æ–∑–¥–∞—Ç—å / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ====
    function artOpenCreateTaskModal() {
        const form = document.getElementById('artTaskForm');
        form.reset();
        document.getElementById('artTaskId').value = '';
        document.getElementById('artTaskModalTitle').textContent = '‚ûï –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';

        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById('artTaskDeadline').value = nextWeek.toISOString().split('T')[0];

        document.getElementById('artTaskModal').style.display = 'flex';
    }

    function artOpenEditTaskModal(taskId) {
        const data = new FormData();
        data.append('action', 'art_get_task');
        data.append('task_id', taskId);
        data.append('nonce', ART_AJAX.nonce_get_task);

        fetch(ART_AJAX.url, { method: 'POST', body: data })
            .then(r => r.json())
            .then(resp => {
                if (resp && resp.success && resp.data) {
                    const t = resp.data;
                    document.getElementById('artTaskModalTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
                    document.getElementById('artTaskId').value = t.task_id || '';
                    document.getElementById('artTaskTitle').value = t.title || '';
                    document.getElementById('artTaskDescription').value = t.description || '';
                    document.getElementById('artTaskProject').value = t.project_id || '';
                    document.getElementById('artTaskPriority').value = t.priority || 'medium';
                    document.getElementById('artTaskDeadline').value = t.deadline || '';

                    document.getElementById('artTaskModal').style.display = 'flex';
                } else {
                    artShowNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á–∏: ' + (resp && resp.data ? resp.data : ''), 'error');
                }
            })
            .catch(() => artShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error'));
    }

    function artEditTask(taskId) { artOpenEditTaskModal(taskId); }
    function artCloseTaskModal() { document.getElementById('artTaskModal').style.display = 'none'; }

    // ==== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ ====
    function artSaveTask() {
        const form = document.getElementById('artTaskForm');
        const formData = new FormData(form);

        const title = (formData.get('title') || '').trim();
        const deadline = formData.get('deadline');

        if (!title) { artShowNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏', 'error'); return; }
        if (!deadline) { artShowNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫', 'error'); return; }

        formData.append('action', 'art_save_task');
        formData.append('nonce', ART_AJAX.nonce_save_task);

        const btn = document.querySelector('#artTaskModal .art-btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...';
        btn.disabled = true;

        fetch(ART_AJAX.url, { method: 'POST', body: formData })
            .then(r => r.json())
            .then(resp => {
                if (resp && resp.success) {
                    artShowNotification('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'success');
                    artCloseTaskModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    artShowNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (resp && resp.data ? resp.data : ''), 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(() => {
                artShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    // ==== –£–¥–∞–ª–µ–Ω–∏–µ ====
    function artDeleteTask(taskId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;

        const data = new FormData();
        data.append('action', 'art_delete_task');
        data.append('task_id', taskId);
        data.append('nonce', ART_AJAX.nonce_delete_task);

        fetch(ART_AJAX.url, { method: 'POST', body: data })
            .then(r => r.json())
            .then(resp => {
                if (resp && resp.success) {
                    artShowNotification('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    artShowNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (resp && resp.data ? resp.data : ''), 'error');
                }
            })
            .catch(() => artShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error'));
    }

    // ==== –ó–∞–≤–µ—Ä—à–∏—Ç—å / –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å ====
    function artCompleteTask(taskId) {
        const data = new FormData();
        data.append('action', 'art_update_task_status');
        data.append('task_id', taskId);
        data.append('status', 'completed');
        data.append('nonce', ART_AJAX.nonce_update_status);

        fetch(ART_AJAX.url, { method: 'POST', body: data })
            .then(r => r.json())
            .then(resp => {
                if (resp && resp.success) {
                    artShowNotification('–ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è!', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    artShowNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (resp && resp.data ? resp.data : ''), 'error');
                }
            })
            .catch(() => artShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error'));
    }

    function artResumeTask(taskId) {
        const data = new FormData();
        data.append('action', 'art_update_task_status');
        data.append('task_id', taskId);
        data.append('status', 'today');
        data.append('nonce', ART_AJAX.nonce_update_status);

        fetch(ART_AJAX.url, { method: 'POST', body: data })
            .then(r => r.json())
            .then(resp => {
                if (resp && resp.success) {
                    artShowNotification('–ó–∞–¥–∞—á–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    artShowNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (resp && resp.data ? resp.data : ''), 'error');
                }
            })
            .catch(() => artShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error'));
    }

    // ==== –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ====
    function artRefreshTasks() {
        const btn = document.querySelector('.ar-btn-refresh');
        if (btn) {
            const t = btn.innerHTML;
            btn.innerHTML = 'üîÑ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...';
            btn.disabled = true;
            setTimeout(() => location.reload(), 700);
        } else {
            location.reload();
        }
    }

    function artShowProject(projectId) {
        artShowNotification('–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è', 'info');
    }

    // ==== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (fallback) ====
    function artShowNotification(message, type = 'info') {
        if (typeof window.arShowNotification === 'function') {
            window.arShowNotification(message, type);
            return;
        }
        const notification = document.createElement('div');
        notification.className = `art-notification art-notification-${type}`;
        notification.innerHTML = `
            <div class="art-notification-content">
                <span class="art-notification-message">${message}</span>
                <button class="art-notification-close" onclick="this.closest('.art-notification').remove()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            </div>
        `;
        if (!document.querySelector('#art-notification-styles')) {
            const styles = document.createElement('style');
            styles.id = 'art-notification-styles';
            styles.textContent = `
                .art-notification{position:fixed;top:20px;right:20px;z-index:10001;min-width:300px;max-width:500px;animation:artSlideIn .3s ease}
                .art-notification-success{background:#22c55e;color:#fff}
                .art-notification-error{background:#dc3545;color:#fff}
                .art-notification-info{background:#3b82f6;color:#fff}
                .art-notification-content{padding:15px 20px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 12px rgba(0,0,0,.3)}
                .art-notification-close{background:none;border:none;color:#fff;font-size:18px;cursor:pointer;margin-left:15px}
                @keyframes artSlideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
            `;
            document.head.appendChild(styles);
        }
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –∫–ª–∏–∫–æ–º –ø–æ —Ñ–æ–Ω—É
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.art-modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    if (this.id === 'artTaskModal') artCloseTaskModal();
                    if (this.id === 'artDeadlineModal') artCloseDeadlineModal();
                }
            });
        });
    });

    // –ú–æ–¥–∞–ª –¥–µ–¥–ª–∞–π–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞ –±—É–¥—É—â–µ–µ)
    function artOpenDeadlineModal(taskId, newStatus) {
        // –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî —Ä–µ–∞–ª–∏–∑—É–π –ø—Ä–∏–≤—è–∑–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–µ–¥–ª–∞–π–Ω–∞ –∫ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞
        document.getElementById('artDeadlineModal').style.display = 'flex';
        document.getElementById('artDeadlineMessage').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏:';
        const d = new Date();
        document.getElementById('artNewDeadline').value = d.toISOString().split('T')[0];
        window.__artDeadlineCtx = { taskId, newStatus };
    }
    function artCloseDeadlineModal() {
        document.getElementById('artDeadlineModal').style.display = 'none';
        window.__artDeadlineCtx = null;
    }
    function artConfirmDeadlineChange() {
        const ctx = window.__artDeadlineCtx;
        if (!ctx) return artCloseDeadlineModal();
        const newDeadline = document.getElementById('artNewDeadline').value;
        if (!newDeadline) return;

        const data = new FormData();
        data.append('action', 'art_update_task_deadline');
        data.append('task_id', ctx.taskId);
        data.append('deadline', newDeadline);
        data.append('nonce', ART_AJAX.nonce_update_deadline);

        fetch(ART_AJAX.url, { method: 'POST', body: data })
            .then(r => r.json())
            .then(resp => {
                if (resp && resp.success) {
                    artShowNotification('–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    artCloseDeadlineModal();
                    setTimeout(() => location.reload(), 700);
                } else {
                    artShowNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—Ä–∞–π–Ω–µ–≥–æ —Å—Ä–æ–∫–∞: ' + (resp && resp.data ? resp.data : ''), 'error');
                }
            })
            .catch(() => artShowNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error'));
    }
    </script>

    <style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .ar-account-header {
        background: #ffffff;
        border-radius: 16px;
        padding: 0;
        margin-bottom: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
        overflow: hidden;
    }

    .ar-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid #f1f5f9;
        background: #ffffff;
        border-radius: 25px !important;
    }

    .ar-header-bottom {
        padding: 20px 30px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        border-radius: 25px;
    }

    .ar-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }

    .ar-user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
    }

    .ar-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ar-user-details {
        display: flex;
        flex-direction: column;
    }

    .ar-user-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 16px;
        line-height: 1.2;
    }

    .ar-user-role {
        color: #64748b;
        font-size: 12px;
        font-weight: 500;
        margin-top: 2px;
    }

    .ar-header-actions {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-shrink: 0;
    }

    .ar-action-buttons {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .ar-main-nav {
        margin-right: 0;
    }

    .ar-nav-list {
        display: flex;
        gap: 8px;
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .ar-nav-item {
        margin: 0;
    }

    .ar-nav-link {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #64748b;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .ar-nav-link:hover {
        background: #ffffff;
        border-color: #e65c00;
        color: #e65c00;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.1);
    }

    .ar-nav-item.is-active .ar-nav-link {
        background: #e65c00;
        border-color: #e65c00;
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.2);
    }

    .ar-nav-icon {
        font-size: 16px;
        opacity: 0.8;
    }

    .ar-nav-item.is-active .ar-nav-icon {
        opacity: 1;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    .ar-stats-overview {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        align-items: center;
    }

    .ar-stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .ar-stat-number {
        font-size: 18px;
        font-weight: 700;
        color: #e65c00;
        line-height: 1;
    }

    .ar-stat-label {
        font-size: 11px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
    .ar-btn-refresh {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f8f9fa;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        white-space: nowrap;
        text-decoration: none;
    }

    .ar-btn-refresh:hover {
        background: #ffffff;
        border-color: #e65c00;
        color: #e65c00;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.1);
    }

    .ar-logout-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: transparent;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 10px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        white-space: nowrap;
        cursor: pointer;
    }

    .ar-logout-btn:hover {
        background: #f8fafc;
        color: #e65c00;
        border-color: #e65c00;
    }

    .ar-logout-btn svg {
        width: 16px;
        height: 16px;
    }

    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞–¥–∞—á */
    .art-tasks-container {
        max-width: 100%;
        margin: 0 auto;
        min-height: 100vh;
        color: #334155;
        font-family: 'Montserrat', sans-serif;
        background: transparent;
    }

    /* –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ */
    .art-tasks-kanban {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        align-items: start;
        min-width: 0;
    }

    .art-tasks-column {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        min-height: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        scrollbar-gutter: stable;
    }

    .art-tasks-column-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 20px;
        border-bottom: 1px solid #f1f5f9;
        position: sticky;
        top: 0;
        background: #ffffff;
        z-index: 1;
        border-radius: 16px 16px 0 0;
    }

    .art-column-icon {
        font-size: 18px;
    }

    .art-tasks-column-header h3 {
        margin: 0;
        color: #1e293b;
        font-size: 16px;
        font-weight: 600;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .art-column-count {
        background: #e65c00;
        color: #fff;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        min-width: 24px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.3);
    }

    .art-tasks-list {
        padding: 16px;
        min-height: 500px;
        transition: all 0.3s ease;
        padding-right: 8px;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ */
    .art-task-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: move;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        position: relative;
        overflow: hidden;
    }

    .art-task-card:hover {
        border-color: #e65c00;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(230, 92, 0, 0.1);
    }

    .art-task-card.dragging {
        opacity: 0.6;
        transform: rotate(5deg);
        box-shadow: 0 8px 25px rgba(230, 92, 0, 0.15);
    }

    .art-task-card.overdue {
        border-left: 4px solid #dc2626;
        background: rgba(220, 38, 38, 0.02);
    }

    .art-task-card.completed {
        opacity: 0.7;
        background: #f0fdf4;
        border-left: 4px solid #16a34a;
    }

    .art-task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .art-task-title {
        margin: 0;
        color: #1e293b;
        font-size: 14px;
        font-weight: 600;
        flex: 1;
        line-height: 1.3;
    }

    .art-task-actions {
        display: flex;
        gap: 4px;
        flex-shrink: 0;
    }

    .art-task-btn {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        color: #64748b;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .art-task-btn:hover {
        background: #ffffff;
        border-color: #e65c00;
        color: #e65c00;
        transform: scale(1.05);
    }

    .art-task-btn svg {
        width: 12px;
        height: 12px;
    }

    .art-task-description {
        font-size: 13px;
        color: #64748b;
        line-height: 1.4;
        margin-bottom: 12px;
    }

    .art-task-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
    }

    .art-task-project-badge {
        background: #e0f2fe;
        color: #0369a1;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        cursor: pointer;
        transition: background 0.2s ease;
        align-self: flex-start;
    }

    .art-task-project-badge:hover {
        background: #bae6fd;
    }

    .art-task-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
    }

    .art-task-deadline {
        color: #64748b;
    }

    .art-task-deadline.overdue {
        color: #dc2626;
        font-weight: 600;
    }

    .art-task-overdue-badge {
        background: #fef2f2;
        color: #dc2626;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 8px;
    }

    /* –°—Ç–∏–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ */
    .art-priority-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
    }

    .art-priority-badge.low {
        background: #f0fdf4;
        color: #16a34a;
    }

    .art-priority-badge.medium {
        background: #fefce8;
        color: #ca8a04;
    }

    .art-priority-badge.high {
        background: #fef2f2;
        color: #dc2626;
    }

    .art-priority-badge.urgent {
        background: #fef2f2;
        color: #dc2626;
        animation: artPulse 2s infinite;
    }

    @keyframes artPulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    .art-task-footer {
        text-align: center;
        padding-top: 12px;
        border-top: 1px solid #f8fafc;
    }

    .art-task-complete-btn, .art-task-resume-btn {
        background: #f8f9fa;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        white-space: nowrap;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .art-task-complete-btn:hover, .art-task-resume-btn:hover {
        background: #ffffff;
        border-color: #e65c00;
        color: #e65c00;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.1);
    }

    .art-empty-column {
        text-align: center;
        padding: 40px 20px;
        color: #94a3b8;
    }

    .art-empty-icon {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .art-empty-column p {
        margin: 0;
        font-size: 14px;
        color: #64748b;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .art-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(8px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        animation: artModalFadeIn 0.3s ease;
    }

    .art-modal-content {
        background: #ffffff;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        border: 1px solid #e2e8f0;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        animation: artModalSlideIn 0.3s ease;
    }

    .art-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid #f1f5f9;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 20px 20px 0 0;
    }

    .art-modal-header h2 {
        margin: 0;
        color: #1e293b;
        font-size: 20px;
        font-weight: 700;
    }

    .art-modal-close {
        background: #f1f5f9;
        border: none;
        color: #64748b;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .art-modal-close:hover {
        background: #e2e8f0;
        color: #475569;
    }

    .art-modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .art-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 24px;
        border-top: 1px solid #f1f5f9;
        background: #f8fafc;
        border-radius: 0 0 20px 20px;
    }

    .art-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .art-btn-primary {
        background: #e65c00;
        color: #fff;
        box-shadow: 0 2px 8px rgba(230, 92, 0, 0.3);
    }

    .art-btn-primary:hover {
        background: #cc4c00;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(230, 92, 0, 0.4);
    }

    .art-btn-secondary {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    .art-btn-secondary:hover {
        background: #e2e8f0;
        color: #374151;
    }

    .art-form-group {
        margin-bottom: 20px;
    }

    .art-form-label {
        display: block;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .art-form-input {
        width: 100%;
        background: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 12px 16px;
        color: #1f2937;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .art-form-input:focus {
        outline: none;
        border-color: #e65c00;
        box-shadow: 0 0 0 3px rgba(230, 92, 0, 0.1);
        background: #fafbfc;
    }

    .art-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    @keyframes artModalFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes artModalSlideIn {
        from { 
            transform: scale(0.9) translateY(-20px);
            opacity: 0;
        }
        to { 
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è drag & drop */
    .art-tasks-column.drag-over {
        background: rgba(230, 92, 0, 0.1);
        border: 2px dashed #e65c00;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–æ–≤ */
    .art-tasks-column::-webkit-scrollbar {
        width: 6px;
    }

    .art-tasks-column::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .art-tasks-column::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
        transition: all 0.3s ease;
    }

    .art-tasks-column::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .art-tasks-column {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .art-modal-body::-webkit-scrollbar {
        width: 6px;
    }

    .art-modal-body::-webkit-scrollbar-track {
        background: #f8fafc;
        border-radius: 3px;
    }

    .art-modal-body::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .art-modal-body {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f8fafc;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1400px) {
        .art-tasks-kanban {
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
        }
    }

    @media (max-width: 1200px) {
        .art-tasks-kanban {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .ar-stats-overview {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .ar-header-top {
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }
        
        .ar-user-info {
            justify-content: center;
        }
        
        .ar-header-actions {
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
    }

    @media (max-width: 1024px) {
        .art-tasks-kanban {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .ar-stats-overview {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .art-tasks-kanban {
            grid-template-columns: 1fr;
        }
        
        .ar-header-top,
        .ar-header-bottom {
            padding: 15px 20px;
        }
        
        .ar-nav-list {
            flex-direction: column;
            width: 100%;
        }
        
        .ar-nav-link {
            justify-content: center;
            padding: 12px 16px;
        }
        
        .ar-action-buttons {
            flex-direction: column;
            width: 100%;
        }
        
        .ar-btn-refresh,
        .ar-logout-btn {
            width: 100%;
            justify-content: center;
        }
        
        .ar-stats-overview {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .art-form-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .ar-header-top,
        .ar-header-bottom {
            padding: 12px 15px;
        }
        
        .ar-nav-link {
            font-size: 13px;
            padding: 10px 12px;
        }
        
        .ar-nav-icon {
            font-size: 14px;
        }
        
        .ar-stat-number {
            font-size: 16px;
        }
        
        .ar-stat-label {
            font-size: 10px;
        }
        
        .ar-user-name {
            font-size: 14px;
        }
        
        .ar-user-role {
            font-size: 11px;
        }
        
        .art-modal-content {
            width: 95%;
            margin: 20px;
        }
        
        .art-modal-footer {
            flex-direction: column;
        }
        
        .art-btn {
            width: 100%;
        }
    }
    </style>
    <?php
    return ob_get_clean();
}

/**
 * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
 */
function art_get_user_tasks($user_id) {
    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    $tasks = $wpdb->get_results(
        $wpdb->prepare("SELECT * FROM $tasks_table WHERE user_id = %d ORDER BY deadline IS NULL, deadline ASC, created_at DESC", $user_id),
        ARRAY_A
    );

    if (empty($tasks)) return [];

    foreach ($tasks as &$task) {
        $task['status'] = art_calculate_task_status($task);
    }

    return $tasks;
}

function art_calculate_task_status($task) {
    if (($task['status'] ?? '') === 'completed' || !empty($task['completed_at'])) {
        return 'completed';
    }

    if (empty($task['deadline']) || $task['deadline'] === '0000-00-00') {
        // –ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞ ‚Äî –≤–µ–¥—ë–º –∫–∞–∫ next_week
        return 'next_week';
    }

    $deadline = strtotime($task['deadline']);
    $today = strtotime('today');
    $tomorrow = strtotime('tomorrow');
    $end_of_week = strtotime('next sunday');
    $end_of_next_week = strtotime('next sunday +7 days');

    if ($deadline < $today)            return 'overdue';
    if ($deadline < $tomorrow)         return 'today';
    if ($deadline <= $end_of_week)     return 'this_week';
    if ($deadline <= $end_of_next_week)return 'next_week';
    return 'next_week';
}

function art_get_project_title($project_id, $projects) {
    if (!$project_id) return '';
    foreach ($projects as $project) {
        if (($project['project_id'] ?? null) === $project_id) return $project['title'] ?? '';
    }
    return '';
}

function art_is_task_overdue($task) {
    if (($task['status'] ?? '') === 'completed') return false;
    if (empty($task['deadline']) || $task['deadline'] === '0000-00-00') return false;
    $deadline = strtotime($task['deadline']);
    $today = strtotime('today');
    return $deadline < $today;
}

function art_get_priority_class($priority) {
    switch ($priority) {
        case 'low': return 'low';
        case 'medium': return 'medium';
        case 'high': return 'high';
        case 'urgent': return 'urgent';
        default: return 'medium';
    }
}

function art_get_priority_label($priority) {
    switch ($priority) {
        case 'low': return 'MicƒÉ';
        case 'medium': return 'Medie';
        case 'high': return 'Mare';
        case 'urgent': return 'UrgentƒÉ';
        default: return 'Medie';
    }
}

/**
 * –û—Ç–ª–∞–¥–∫–∞
 */
function art_debug_tasks_table() {
    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    error_log("ART TASKS DEBUG: Checking tasks table structure");

    $structure = $wpdb->get_results("DESCRIBE $tasks_table", ARRAY_A);
    error_log("ART TASKS DEBUG: Table structure: " . print_r($structure, true));

    $tasks = $wpdb->get_results("SELECT * FROM $tasks_table", ARRAY_A);
    error_log("ART TASKS DEBUG: Total tasks in database: " . count($tasks));

    foreach ($tasks as $task) {
        error_log("ART TASKS DEBUG: Task - ID: {$task['id']}, Task ID: {$task['task_id']}, User ID: {$task['user_id']}, Title: {$task['title']}");
    }
}

/**
 * AJAX
 */
add_action('wp_ajax_art_save_task', 'art_ajax_save_task');
function art_ajax_save_task() {
    error_log("ART TASKS: art_save_task called");
    art_debug_tasks_table();

    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'art_save_task')) {
        wp_send_json_error('Eroare de securitate');
    }
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }

    $user_id    = get_current_user_id();
    $task_id    = isset($_POST['task_id']) ? sanitize_text_field($_POST['task_id']) : '';
    $title      = isset($_POST['title']) ? sanitize_text_field($_POST['title']) : '';
    $description= isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $project_id = isset($_POST['project_id']) ? sanitize_text_field($_POST['project_id']) : '';
    $priority   = isset($_POST['priority']) ? sanitize_text_field($_POST['priority']) : 'medium';
    $deadline   = isset($_POST['deadline']) ? sanitize_text_field($_POST['deadline']) : '';

    if (empty($title) || empty($deadline)) {
        wp_send_json_error('Titlul »ôi data limitƒÉ sunt obligatorii');
    }

    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    $status = art_calculate_task_status(['deadline' => $deadline, 'status' => '', 'completed_at' => null]);

    $task_data = [
        'user_id'     => $user_id,
        'title'       => $title,
        'description' => $description,
        'project_id'  => $project_id,
        'priority'    => $priority,
        'deadline'    => $deadline,
        'status'      => $status,
        'updated_at'  => current_time('mysql'),
    ];

    if (empty($task_id)) {
        $task_data['task_id']    = 'task_' . $user_id . '_' . time() . '_' . wp_generate_password(6, false);
        $task_data['created_at'] = current_time('mysql');

        $result = $wpdb->insert($tasks_table, $task_data);
        if ($result === false) {
            $error = $wpdb->last_error ?: 'Unknown database error';
            wp_send_json_error('Eroare la crearea sarcinii √Æn baza de date: ' . $error);
        }
    } else {
        $existing_task = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $tasks_table WHERE task_id = %s AND user_id = %d",
            $task_id, $user_id
        ), ARRAY_A);

        if (!$existing_task) {
            wp_send_json_error('Sarcina nu a fost gƒÉsitƒÉ sau nu ave»õi acces la ea');
        }

        $result = $wpdb->update($tasks_table, $task_data, ['task_id' => $task_id, 'user_id' => $user_id]);
        if ($result === false) {
            $error = $wpdb->last_error ?: 'Unknown database error';
            wp_send_json_error('Eroare la actualizarea sarcinii √Æn baza de date: ' . $error);
        }
    }

    wp_send_json_success('Sarcina a fost salvatƒÉ cu succes');
}

add_action('wp_ajax_art_get_task', 'art_ajax_get_task');
function art_ajax_get_task() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'art_get_task')) {
        wp_send_json_error('Eroare de securitate');
    }
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }

    $user_id = get_current_user_id();
    $task_id = isset($_POST['task_id']) ? sanitize_text_field($_POST['task_id']) : '';
    if (empty($task_id)) {
        wp_send_json_error('ID-ul sarcinii este necesar');
    }

    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    $task = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $tasks_table WHERE task_id = %s AND user_id = %d",
        $task_id, $user_id
    ), ARRAY_A);

    if (!$task) {
        wp_send_json_error('Sarcina nu a fost gƒÉsitƒÉ');
    }

    wp_send_json_success($task);
}

add_action('wp_ajax_art_delete_task', 'art_ajax_delete_task');
function art_ajax_delete_task() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'art_delete_task')) {
        wp_send_json_error('Eroare de securitate');
    }
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }

    $user_id = get_current_user_id();
    $task_id = isset($_POST['task_id']) ? sanitize_text_field($_POST['task_id']) : '';
    if (empty($task_id)) {
        wp_send_json_error('ID-ul sarcinii este necesar');
    }

    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    $existing_task = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $tasks_table WHERE task_id = %s AND user_id = %d",
        $task_id, $user_id
    ), ARRAY_A);

    if (!$existing_task) {
        wp_send_json_error('Sarcina nu a fost gƒÉsitƒÉ sau nu ave»õi acces la ea');
    }

    $result = $wpdb->delete($tasks_table, ['task_id' => $task_id, 'user_id' => $user_id]);
    if ($result === false) {
        $error = $wpdb->last_error ?: 'Unknown database error';
        wp_send_json_error('Eroare la »ôtergerea sarcinii: ' . $error);
    }

    wp_send_json_success('Sarcina a fost »ôtearsƒÉ cu succes');
}

add_action('wp_ajax_art_update_task_status', 'art_ajax_update_task_status');
function art_ajax_update_task_status() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'art_update_task_status')) {
        wp_send_json_error('Eroare de securitate');
    }
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }

    $user_id = get_current_user_id();
    $task_id = isset($_POST['task_id']) ? sanitize_text_field($_POST['task_id']) : '';
    $status  = isset($_POST['status']) ? sanitize_text_field($_POST['status']) : '';

    if (empty($task_id) || empty($status)) {
        wp_send_json_error('ID-ul sarcinii »ôi statusul sunt necesare');
    }

    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    $existing_task = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $tasks_table WHERE task_id = %s AND user_id = %d",
        $task_id, $user_id
    ), ARRAY_A);

    if (!$existing_task) {
        wp_send_json_error('Sarcina nu a fost gƒÉsitƒÉ sau nu ave»õi acces la ea');
    }

    $completed_at = ($status === 'completed') ? current_time('mysql') : null;

    $result = $wpdb->update(
        $tasks_table,
        [
            'status' => $status,
            'completed_at' => $completed_at,
            'updated_at' => current_time('mysql')
        ],
        ['task_id' => $task_id, 'user_id' => $user_id]
    );

    if ($result === false) {
        $error = $wpdb->last_error ?: 'Unknown database error';
        wp_send_json_error('Eroare la actualizarea statusului: ' . $error);
    }

    wp_send_json_success(['message' => 'Status actualizat cu succes']);
}

add_action('wp_ajax_art_update_task_deadline', 'art_ajax_update_task_deadline');
function art_ajax_update_task_deadline() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'art_update_task_deadline')) {
        wp_send_json_error('Eroare de securitate');
    }
    if (!is_user_logged_in()) {
        wp_send_json_error('Utilizatorul nu este autentificat');
    }

    $user_id = get_current_user_id();
    $task_id = isset($_POST['task_id']) ? sanitize_text_field($_POST['task_id']) : '';
    $deadline= isset($_POST['deadline']) ? sanitize_text_field($_POST['deadline']) : '';

    if (empty($task_id) || empty($deadline)) {
        wp_send_json_error('ID-ul sarcinii »ôi data limitƒÉ sunt necesare');
    }

    global $wpdb;
    $tasks_table = $wpdb->prefix . 'designer_tasks';

    $existing_task = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $tasks_table WHERE task_id = %s AND user_id = %d",
        $task_id, $user_id
    ), ARRAY_A);

    if (!$existing_task) {
        wp_send_json_error('Sarcina nu a fost gƒÉsitƒÉ sau nu ave»õi acces la ea');
    }

    $status = art_calculate_task_status(['deadline' => $deadline, 'status' => '', 'completed_at' => null]);

    $result = $wpdb->update(
        $tasks_table,
        [
            'deadline' => $deadline,
            'status' => $status,
            'completed_at' => null,
            'updated_at' => current_time('mysql')
        ],
        ['task_id' => $task_id, 'user_id' => $user_id]
    );

    if ($result === false) {
        $error = $wpdb->last_error ?: 'Unknown database error';
        wp_send_json_error('Eroare la actualizarea datei limitƒÉ: ' . $error);
    }

    wp_send_json_success('Data limitƒÉ a fost actualizatƒÉ cu succes');
}

/* ========= DESIGNER TASKS KANBAN SYSTEM END ========= */

/* ========= DESIGNER TASKS KANBAN SYSTEM END ========= */



/* ========= DESIGNER TASK CABINET SYSTEM END ========= */














/* ==========   SOFTWARE RELEASES START ========== */

/* ==========   SOFTWARE RELEASES START ========== */

// –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–µ—à–µ–º —Ä–µ–ª–∏–∑–æ–≤
class SoftwareReleaseCache {
    public static function clear_releases_cache($version = null) {
        if ($version) {
            delete_transient('software_current_releases_' . $version);
            delete_transient('software_backups_list_' . $version);
            delete_transient('software_updates_list_' . $version);
            wp_cache_delete('software_releases_data_' . $version, 'software_releases');
            wp_cache_delete('software_backups_data_' . $version, 'software_releases');
            wp_cache_delete('software_updates_data_' . $version, 'software_releases');
        } else {
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –≤–µ—Ä—Å–∏–∏
            $versions = ['interior', 'furniture', 'trial'];
            foreach ($versions as $version) {
                delete_transient('software_current_releases_' . $version);
                delete_transient('software_backups_list_' . $version);
                delete_transient('software_updates_list_' . $version);
                
                wp_cache_delete('software_releases_data_' . $version, 'software_releases');
                wp_cache_delete('software_backups_data_' . $version, 'software_releases');
                wp_cache_delete('software_updates_data_' . $version, 'software_releases');
            }
        }
        
        update_option('software_last_cache_refresh', time());
        error_log("SOFTWARE RELEASES: Cache cleared at " . date('Y-m-d H:i:s'));
    }
    
    public static function get_releases_data($version_type) {
        $cache_key = 'software_releases_data_' . $version_type;
        $data = wp_cache_get($cache_key, 'software_releases');
        
        if ($data === false) {
            $data = self::fetch_releases_data($version_type);
            wp_cache_set($cache_key, $data, 'software_releases', 5 * MINUTE_IN_SECONDS);
        }
        
        return $data;
    }
    
    private static function fetch_releases_data($version_type) {
        return [
            'current_version' => get_option('software_current_version_' . $version_type, []),
            'current_update' => get_option('software_current_update_' . $version_type, []),
            'prerelease_info' => get_option('software_prerelease_info_' . $version_type, []),
            'timestamp' => time()
        ];
    }
    
    public static function get_backups_list($version_type) {
        $cache_key = 'software_backups_data_' . $version_type;
        $data = wp_cache_get($cache_key, 'software_releases');
        
        if ($data === false) {
            $data = self::fetch_backups_data($version_type);
            wp_cache_set($cache_key, $data, 'software_releases', 5 * MINUTE_IN_SECONDS);
        }
        
        return $data;
    }
    
    private static function fetch_backups_data($version_type) {
        $upload_dir = wp_upload_dir();
        $backup_dir = $upload_dir['basedir'] . '/software-releases/backups/' . $version_type;
        
        if (!file_exists($backup_dir)) {
            return [];
        }
        
        $backups = glob($backup_dir . '/software-*');
        
        $backup_data = [];
        foreach ($backups as $backup) {
            $backup_data[] = [
                'name' => basename($backup),
                'path' => $backup,
                'size' => filesize($backup),
                'time' => filemtime($backup)
            ];
        }
        
        usort($backup_data, function($a, $b) {
            return $b['time'] - $a['time'];
        });
        
        return $backup_data;
    }
    
    public static function get_updates_list($version_type) {
        $cache_key = 'software_updates_data_' . $version_type;
        $data = wp_cache_get($cache_key, 'software_releases');
        
        if ($data === false) {
            $data = self::fetch_updates_data($version_type);
            wp_cache_set($cache_key, $data, 'software_releases', 5 * MINUTE_IN_SECONDS);
        }
        
        return $data;
    }
    
    private static function fetch_updates_data($version_type) {
        $upload_dir = wp_upload_dir();
        $backup_dir = $upload_dir['basedir'] . '/software-releases/backups/' . $version_type;
        
        if (!file_exists($backup_dir)) {
            return [];
        }
        
        $updates = glob($backup_dir . '/update-*');
        
        $update_data = [];
        foreach ($updates as $update) {
            $update_data[] = [
                'name' => basename($update),
                'path' => $update,
                'size' => filesize($update),
                'time' => filemtime($update)
            ];
        }
        
        usort($update_data, function($a, $b) {
            return $b['time'] - $a['time'];
        });
        
        return $update_data;
    }
    
    public static function get_last_cache_time() {
        $cache_time = get_option('software_last_cache_refresh', 0);
        if ($cache_time) {
            return date('H:i', $cache_time);
        }
        return date('H:i');
    }
}

// Software Release Manager Pro - Complete Version with Prerelease and Rollback
class SoftwareReleaseManagerPro {
    
    private $upload_dir;
    private $backup_dir_interior;
    private $backup_dir_furniture;
    private $backup_dir_trial;
    private $current_dir_interior;
    private $current_dir_furniture;
    private $current_dir_trial;
    private $update_dir_interior;
    private $update_dir_furniture;
    private $update_dir_trial;
    private $prerelease_dir_interior;
    private $prerelease_dir_furniture;
    private $prerelease_dir_trial;
    private $password;
    private $api_url;
    private $auth_cookie_key = 'software_panel_auth';
    
    public function __construct() {
    $upload_dir = wp_upload_dir();
    $this->upload_dir = $upload_dir['basedir'] . '/software-releases';
    
    // Interior Designer directories (product 1633)
    $this->backup_dir_interior = $this->upload_dir . '/backups/interior';
    $this->current_dir_interior = $this->upload_dir . '/current/interior';
    $this->update_dir_interior = $this->upload_dir . '/updates/interior';
    $this->prerelease_dir_interior = $this->upload_dir . '/prerelease/interior';
    
    // Furniture Designer directories (product 1634)
    $this->backup_dir_furniture = $this->upload_dir . '/backups/furniture';
    $this->current_dir_furniture = $this->upload_dir . '/current/furniture';
    $this->update_dir_furniture = $this->upload_dir . '/updates/furniture';
    $this->prerelease_dir_furniture = $this->upload_dir . '/prerelease/furniture';
    
    // Trial version directories (product 2385) - –î–û–ë–ê–í–¨–¢–ï –≠–¢–û!
    $this->backup_dir_trial = $this->upload_dir . '/backups/trial';
    $this->current_dir_trial = $this->upload_dir . '/current/trial';
    $this->update_dir_trial = $this->upload_dir . '/updates/trial';
    $this->prerelease_dir_trial = $this->upload_dir . '/prerelease/trial';
    
    $this->password = 'Y4r!mQ9#sV2@kL8^cN6';
    $this->api_url = 'https://license.artrocket.eu/';
    
    $this->init_directories();
    $this->add_hooks();
    add_action('init', array($this, 'start_session'), 1);
    }
    
    public function start_session() {
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
}
    
    private function init_directories() {
    $dirs = [
        $this->upload_dir,
        $this->backup_dir_interior,
        $this->backup_dir_furniture,
        $this->backup_dir_trial, // –î–æ–±–∞–≤–ª–µ–Ω–æ
        $this->current_dir_interior,
        $this->current_dir_furniture,
        $this->current_dir_trial, // –î–æ–±–∞–≤–ª–µ–Ω–æ
        $this->update_dir_interior,
        $this->update_dir_furniture,
        $this->update_dir_trial, // –î–æ–±–∞–≤–ª–µ–Ω–æ
        $this->prerelease_dir_interior,
        $this->prerelease_dir_furniture,
        $this->prerelease_dir_trial // –î–æ–±–∞–≤–ª–µ–Ω–æ
    ];
    
    foreach ($dirs as $dir) {
        if (!file_exists($dir)) {
            wp_mkdir_p($dir);
            // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª-–∑–∞–≥–ª—É—à–∫—É –¥–ª—è Trial
            if (strpos($dir, '/trial') !== false && !file_exists($dir . '/README.txt')) {
                file_put_contents($dir . '/README.txt', 
                    "This is placeholder directory for Trial version.\n" .
                    "Please upload the actual software files using the upload panel.\n" .
                    date('Y-m-d H:i:s')
                );
            }
        }
    }
    
    $htaccess_content = "Order Deny,Allow\nDeny from all";
    if (!file_exists($this->upload_dir . '/.htaccess')) {
        file_put_contents($this->upload_dir . '/.htaccess', $htaccess_content);
    }
    
    // –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞–µ–º .htaccess –≤ –∫–∞–∂–¥–æ–π –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã
    $subdirs = [$this->current_dir_interior, $this->current_dir_furniture, $this->current_dir_trial,
                $this->update_dir_interior, $this->update_dir_furniture, $this->update_dir_trial,
                $this->prerelease_dir_interior, $this->prerelease_dir_furniture, $this->prerelease_dir_trial];
    
    foreach ($subdirs as $subdir) {
        if (file_exists($subdir) && !file_exists($subdir . '/.htaccess')) {
            file_put_contents($subdir . '/.htaccess', $htaccess_content);
        }
    }
}
    
    private function add_hooks() {
        add_shortcode('software_upload_panel', array($this, 'upload_panel_shortcode'));
        add_action('wp_ajax_handle_software_upload', array($this, 'handle_ajax_upload'));
        add_action('wp_ajax_nopriv_handle_software_upload', array($this, 'handle_ajax_upload_nopriv'));
        add_action('wp_ajax_restore_backup', array($this, 'handle_restore_backup'));
        add_action('wp_ajax_nopriv_restore_backup', array($this, 'handle_ajax_auth_fail'));
        add_action('wp_ajax_download_backup', array($this, 'handle_download_backup'));
        add_action('wp_ajax_nopriv_download_backup', array($this, 'handle_ajax_auth_fail'));
        add_action('wp_ajax_download_update', array($this, 'handle_download_update'));
        add_action('wp_ajax_nopriv_download_update', array($this, 'handle_ajax_auth_fail'));
        add_action('wp_ajax_restore_update', array($this, 'handle_restore_update'));
        add_action('wp_ajax_nopriv_restore_update', array($this, 'handle_ajax_auth_fail'));
        add_action('wp_ajax_promote_prerelease', array($this, 'handle_promote_prerelease'));
        add_action('wp_ajax_nopriv_promote_prerelease', array($this, 'handle_ajax_auth_fail'));
        add_action('wp_ajax_rollback_update', array($this, 'handle_rollback_update'));
        add_action('wp_ajax_nopriv_rollback_update', array($this, 'handle_ajax_auth_fail'));
        add_action('wp_ajax_delete_prerelease', array($this, 'handle_delete_prerelease'));
        add_action('wp_ajax_nopriv_delete_prerelease', array($this, 'handle_ajax_auth_fail'));
        add_action('wp_ajax_software_refresh_cache', array($this, 'handle_refresh_cache'));
        add_action('wp_ajax_nopriv_software_refresh_cache', array($this, 'handle_ajax_auth_fail'));
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è nopriv –∑–∞–ø—Ä–æ—Å–æ–≤ - –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    public function handle_ajax_auth_fail() {
    $this->send_no_cache_headers();
    wp_send_json_error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 403);
}
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è nopriv upload - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ
    public function handle_ajax_upload_nopriv() {
        $this->handle_ajax_upload();
    }
    
    private function clear_cache($version_type = null) {
        SoftwareReleaseCache::clear_releases_cache($version_type);
    }
    
    private function send_no_cache_headers() {
        if (!headers_sent()) {
            if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
                header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
                header('Access-Control-Allow-Headers: Content-Type, X-Requested-With');
                header('Access-Control-Max-Age: 86400');
                exit(0);
            }

            header('Cache-Control: no-cache, no-store, must-revalidate, max-age=0');
                        header('Pragma: no-cache');
            header('Expires: ' . gmdate('D, d M Y H:i:s \G\M\T', time() - 3600));
            header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∞–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —Ö–µ—à –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ cookie.
     */
    private function get_auth_hash() {
        return hash_hmac('sha256', $this->password, wp_salt('auth'));
    }

    /**
     * –î–æ–º–µ–Ω –¥–ª—è cookie (–Ω–∞ –æ—Å–Ω–æ–≤–µ site_url()).
     */
    private function get_cookie_domain() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å.
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ cookie –±—É–¥–µ—Ç –≤–∏–¥–Ω–∞ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –∏ admin-ajax.php,
        // –µ—Å–ª–∏ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ.
        if (!empty($_SERVER['HTTP_HOST'])) {
            return $_SERVER['HTTP_HOST'];
        }

        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî —Ö–æ—Å—Ç –∏–∑ site_url()
        $host = parse_url(site_url(), PHP_URL_HOST);
        return $host ?: '';
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω–∞—è cookie –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.
     */
    private function is_authenticated_request() {
        return !empty($_SESSION['software_panel_authenticated'])
            && $_SESSION['software_panel_authenticated'] === true;
    }

    /**
     * –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cookie –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
     */
    private function set_auth_cookie() {
    $value    = $this->get_auth_hash();
    $expire   = time() + (8 * 3600);
    $secure   = is_ssl();
    $httponly = true;
    $domain   = $this->get_cookie_domain();

    if (PHP_VERSION_ID >= 70300) {
        setcookie($this->auth_cookie_key, $value, [
            'expires'  => $expire,
            'path'     => '/',
            'domain'   => $domain,
            'secure'   => $secure,
            'httponly' => $httponly,
            'samesite' => 'Lax',
        ]);
    } else {
        setcookie($this->auth_cookie_key, $value, $expire, '/; samesite=Lax', $domain, $secure, $httponly);
    }

    $_COOKIE[$this->auth_cookie_key] = $value;
}

    /**
     * –û—á–∏—Å—Ç–∫–∞ cookie –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
     */
    private function clear_auth_cookie() {
        $domain   = $this->get_cookie_domain();
        $secure   = is_ssl();
        $httponly = true;
        if (PHP_VERSION_ID >= 70300) {
            setcookie($this->auth_cookie_key, '', [
                'expires'  => time() - 3600,
                'path'     => '/',
                'domain'   => $domain,
                'secure'   => $secure,
                'httponly' => $httponly,
                'samesite' => 'Lax',
            ]);
        } else {
            setcookie($this->auth_cookie_key, '', time() - 3600, '/; samesite=Lax', $domain, $secure, $httponly);
        }

        unset($_COOKIE[$this->auth_cookie_key]);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ (–Ω–µ AJAX) –∑–∞–ø—Ä–æ—Å–∞.
     * –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞–Ω –∏ –≤–µ—Ä–µ–Ω ‚Äî —Å—Ç–∞–≤–∏—Ç cookie.
     */
private function check_auth() {
        // –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if ($this->is_authenticated_request()) {
            return true;
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –ª–æ–≥–∏–Ω–∞ –ø–æ –ø–∞—Ä–æ–ª—é
        if (isset($_POST['software_panel_password'])) {
            $input = (string) $_POST['software_panel_password'];

            if (hash_equals($this->password, $input)) {
                // –ø–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º
                $_SESSION['software_panel_authenticated'] = true;
                return true;
            }
        }

        return false;
    }

    /**
     * –í—ã—Ö–æ–¥ –∏–∑ –ø–∞–Ω–µ–ª–∏.
     */
    private function logout() {
        if (isset($_SESSION['software_panel_authenticated'])) {
            unset($_SESSION['software_panel_authenticated']);
        }
    }
    
    public function upload_panel_shortcode($atts) {
    if (isset($_POST['software_panel_logout'])) {
        $this->logout();
        echo '<script>location.href = location.href.split("?")[0];</script>';
        return '';
    }
    
    if (!$this->check_auth()) {
        return $this->render_login_form();
    }
    
    return $this->render_upload_panel();
}
    
    private function render_login_form() {
        ob_start();
        ?>
        <div class="software-login-overlay">
            <div class="software-login-form">
                <div class="login-header">
                    <div class="login-icon">üì¶</div>
                    <h3>–î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ —Ä–µ–ª–∏–∑–æ–≤</h3>
                    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏</p>
                </div>
                
                <form method="post" class="login-form">
                    <div class="input-group">
                        <input type="password" name="software_panel_password" required 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞" class="password-input">
                    </div>
                    <button type="submit" class="login-button">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
                </form>
                
                <p class="login-footer">–¢–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞</p>
            </div>
        </div>

        <style>
        .software-login-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
            z-index: 999999;
            backdrop-filter: blur(10px);
        }
        
        .software-login-form {
            width: min(400px, 90vw);
            padding: 40px 30px;
            background: #1a1a1a;
            border-radius: 20px;
            border: 1px solid #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            text-align: center;
        }
        
        .login-header {
            margin-bottom: 30px;
        }
        
        .login-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .login-header h3 {
            color: white;
            margin: 0 0 10px;
            font-size: 22px;
            font-weight: 600;
        }
        
        .login-header p {
            color: #888;
            margin: 0;
            font-size: 14px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px 20px;
            border: 1px solid #333;
            border-radius: 12px;
            background: #2a2a2a;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .password-input:focus {
            border-color: #667eea;
            background: #2f2f2f;
            outline: none;
        }
        
        .login-button {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .login-footer {
            color: #666;
            font-size: 12px;
            margin: 20px 0 0;
        }
        </style>
        
        <script>document.body.style.overflow = 'hidden';</script>
        <?php
        return ob_get_clean();
    }
    
    private function render_upload_panel() {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –≤–µ—Ä—Å–∏–∏
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –≤–µ—Ä—Å–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é interior)
$current_version_type = isset($_COOKIE['software_current_version_type']) ? 
                        sanitize_text_field($_COOKIE['software_current_version_type']) : 'interior';

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã —Ç–∏–ø–∞ –≤–µ—Ä—Å–∏–∏ (–ø—Ä–∏–Ω–∏–º–∞–µ–º –∏ GET, –∏ POST)
if (isset($_REQUEST['switch_version_type']) && !empty($_REQUEST['version_type'])) {
    $current_version_type = sanitize_text_field($_REQUEST['version_type']);
    setcookie('software_current_version_type', $current_version_type, time() + 86400, '/');
    $_COOKIE['software_current_version_type'] = $current_version_type;
}
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–∫—É –≤–µ—Ä—Å–∏–∏
        $version_labels = [
            'interior' => '–î–∏–∑–∞–π–Ω–µ—Ä –ò–Ω—Ç–µ—Ä—å–µ—Ä–∞ (—Ç–æ–≤–∞—Ä 1633)',
            'furniture' => '–î–∏–∑–∞–π–Ω–µ—Ä –ú–µ–±–µ–ª–∏ (—Ç–æ–≤–∞—Ä 1634)',
            'trial' => 'Trial –≤–µ—Ä—Å–∏—è (—Ç–æ–≤–∞—Ä 2385)'
        ];
        
        $version_label = $version_labels[$current_version_type] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è';
        
        $cache_data = SoftwareReleaseCache::get_releases_data($current_version_type);
        $backups_data = SoftwareReleaseCache::get_backups_list($current_version_type);
        $updates_data = SoftwareReleaseCache::get_updates_list($current_version_type);
        
        $current_file = $this->get_current_file($current_version_type);
        $current_update = $this->get_current_update($current_version_type);
        $prerelease_update = $this->get_prerelease_update($current_version_type);
        $version_info = $cache_data['current_version'];
        $update_info = $cache_data['current_update'];
        $prerelease_info = $cache_data['prerelease_info'];
        
        ob_start();
        ?>
        <div class="software-upload-panel">
            <!-- Version Type Switcher -->
            <div class="version-type-switcher">
                <form method="get" class="version-switch-form">
                    <div class="version-toggles">
                        <label class="version-toggle <?php echo $current_version_type === 'interior' ? 'active' : ''; ?>">
                            <input type="radio" name="version_type" value="interior" 
                                   <?php checked($current_version_type, 'interior'); ?> 
                                   onchange="this.form.submit()">
                            <span class="toggle-content">
                                <span class="toggle-icon">üè†</span>
                                <span class="toggle-text">–î–∏–∑–∞–π–Ω–µ—Ä –ò–Ω—Ç–µ—Ä—å–µ—Ä–∞</span>
                                <span class="toggle-subtext">–¢–æ–≤–∞—Ä 1633</span>
                            </span>
                        </label>
                        
                        <label class="version-toggle <?php echo $current_version_type === 'furniture' ? 'active' : ''; ?>">
                            <input type="radio" name="version_type" value="furniture" 
                                   <?php checked($current_version_type, 'furniture'); ?>
                                   onchange="this.form.submit()">
                            <span class="toggle-content">
                                <span class="toggle-icon">ü™ë</span>
                                <span class="toggle-text">–î–∏–∑–∞–π–Ω–µ—Ä –ú–µ–±–µ–ª–∏</span>
                                <span class="toggle-subtext">–¢–æ–≤–∞—Ä 1634</span>
                            </span>
                        </label>
                        
                        <label class="version-toggle <?php echo $current_version_type === 'trial' ? 'active' : ''; ?>">
                            <input type="radio" name="version_type" value="trial" 
                                   <?php checked($current_version_type, 'trial'); ?>
                                   onchange="this.form.submit()">
                            <span class="toggle-content">
                                <span class="toggle-icon">üî¨</span>
                                <span class="toggle-text">Trial –≤–µ—Ä—Å–∏—è</span>
                                <span class="toggle-subtext">–¢–æ–≤–∞—Ä 2385</span>
                            </span>
                        </label>
                    </div>
                    <input type="hidden" name="switch_version_type" value="1">
                </form>
            </div>
            
            <!-- Header -->
            <div class="panel-header">
                <div class="header-content">
                    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ª–∏–∑–∞–º–∏</h1>
                    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è: <strong><?php echo $version_label; ?></strong></p>
                    <div class="cache-info">
                        üìÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: <?php echo SoftwareReleaseCache::get_last_cache_time(); ?>
                        <button type="button" onclick="softwareRefreshCache()" class="refresh-cache-btn">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>
                <form method="post" class="logout-form">
                    <input type="hidden" name="software_panel_logout" value="1">
                    <button type="submit" class="logout-button">üîí Ie»ôire</button>
                </form>
            </div>
            
            <!-- Current Software Version -->
            <?php if ($current_file): ?>
            <div class="current-version-card">
                <div class="version-content">
                    <div class="version-icon">üì¶</div>
                    <div class="version-details">
                        <h3>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ü–û</h3>
                        <div class="version-stats">
                            <div class="stat">
                                <div class="stat-label">–§–∞–π–ª</div>
                                <div class="stat-value"><?php echo esc_html($current_file['name']); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–í–µ—Ä—Å–∏—è</div>
                                <div class="stat-value"><?php echo esc_html($version_info['version_number'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–∞'); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–†–∞–∑–º–µ—Ä</div>
                                <div class="stat-value"><?php echo size_format($current_file['size']); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–û–±–Ω–æ–≤–ª–µ–Ω</div>
                                <div class="stat-value"><?php echo date('d.m.Y –≤ H:i', $current_file['time'] + 3 * 3600); ?></div>
                            </div>
                        </div>
                        <?php if (!empty($version_info['version_notes'])): ?>
                        <div class="version-notes">
                            <div class="notes-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:</div>
                            <div class="notes-content"><?php echo nl2br(esc_html($version_info['version_notes'])); ?></div>
                        </div>
                        <?php else: ?>
                        <div class="no-notes">
                            <div class="no-notes-text">‚ÑπÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            <?php else: ?>
            <div class="no-version-card">
                <div class="no-version-icon">üì§</div>
                <h3>–§–∞–π–ª –ü–û –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—É—é –≤–µ—Ä—Å–∏—é –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è</p>
            </div>
            <?php endif; ?>
            
            <!-- Current Update Version -->
            <?php if ($current_update): ?>
            <div class="current-version-card update-card">
                <div class="version-content">
                    <div class="version-icon">üîÑ</div>
                    <div class="version-details">
                        <h3>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
                        <div class="version-stats">
                            <div class="stat">
                                <div class="stat-label">–§–∞–π–ª</div>
                                <div class="stat-value"><?php echo esc_html($current_update['name']); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–í–µ—Ä—Å–∏—è</div>
                                <div class="stat-value"><?php echo esc_html($update_info['version_number'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–∞'); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–†–∞–∑–º–µ—Ä</div>
                                <div class="stat-value"><?php echo size_format($current_update['size']); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–û–±–Ω–æ–≤–ª–µ–Ω</div>
                                <div class="stat-value"><?php echo date('d.m.Y –≤ H:i', $current_update['time'] + 3 * 3600); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–°—Ç–∞—Ç—É—Å</div>
                                <div class="stat-value"><span style="color: #28a745;">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span></div>
                            </div>
                        </div>
                        <?php if (!empty($update_info['version_notes'])): ?>
                        <div class="version-notes">
                            <div class="notes-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:</div>
                            <div class="notes-content"><?php echo nl2br(esc_html($update_info['version_notes'])); ?></div>
                        </div>
                        <?php else: ?>
                        <div class="no-notes">
                            <div class="no-notes-text">‚ÑπÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            <?php else: ?>
            <div class="no-version-card">
                <div class="no-version-icon">üîÑ</div>
                <h3>–§–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—É—é –≤–µ—Ä—Å–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</p>
            </div>
            <?php endif; ?>
            
            <!-- Prerelease Update Version -->
            <?php if ($prerelease_update): ?>
            <div class="current-version-card prerelease-card">
                <div class="version-content">
                    <div class="version-icon">üß™</div>
                    <div class="version-details">
                        <h3>–ü—Ä–µ—Ä–µ–ª–∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
                        <div class="version-stats">
                            <div class="stat">
                                <div class="stat-label">–§–∞–π–ª</div>
                                <div class="stat-value"><?php echo esc_html($prerelease_update['name']); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–í–µ—Ä—Å–∏—è</div>
                                <div class="stat-value"><?php echo esc_html($prerelease_info['version_number'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–∞'); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–†–∞–∑–º–µ—Ä</div>
                                <div class="stat-value"><?php echo size_format($prerelease_update['size']); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–ó–∞–≥—Ä—É–∂–µ–Ω</div>
                                <div class="stat-value"><?php echo date('d.m.Y –≤ H:i', $prerelease_update['time'] + 3 * 3600); ?></div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">–°—Ç–∞—Ç—É—Å</div>
                                <div class="stat-value"><span style="color: #ffc107;">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span></div>
                            </div>
                        </div>
                        <?php if (!empty($prerelease_info['version_notes'])): ?>
                        <div class="version-notes">
                            <div class="notes-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:</div>
                            <div class="notes-content"><?php echo nl2br(esc_html($prerelease_info['version_notes'])); ?></div>
                        </div>
                        <?php else: ?>
                        <div class="no-notes">
                            <div class="no-notes-text">‚ÑπÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div>
                        </div>
                        <?php endif; ?>
                        
                        <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
                        <div class="prerelease-links">
                            <div class="dev-link-section">
                                <label>üîó –°—Å—ã–ª–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:</label>
                                <div class="link-container">
                                    <input type="text" id="prereleaseDevLink" 
                                           value="<?php echo esc_url(home_url('/sketchup-prerelease.php?license=DEV&version=' . urlencode($prerelease_info['version_number'] ?? '') . '&type=' . $current_version_type)); ?>" 
                                           readonly>
                                    <button type="button" class="copy-link-btn" data-target="prereleaseDevLink">
                                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                </div>
                                <p class="link-notice">–≠—Ç–∞ —Å—Å—ã–ª–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –∏ –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ API</p>
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ—Ä–µ–ª–∏–∑–æ–º -->
                            <div class="prerelease-actions">
                                <button type="button" class="promote-prerelease-btn" 
                                        data-filename="<?php echo esc_attr($prerelease_update['name']); ?>"
                                        data-version="<?php echo esc_attr($prerelease_info['version_number'] ?? ''); ?>"
                                        data-version-type="<?php echo $current_version_type; ?>">
                                    ‚úÖ –í—ã–ø—É—Å—Ç–∏—Ç—å –≤ –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø
                                </button>
                                <button type="button" class="delete-prerelease-btn"
                                        data-filename="<?php echo esc_attr($prerelease_update['name']); ?>"
                                        data-version-type="<?php echo $current_version_type; ?>">
                                    ‚ùå –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ—Ä–µ–ª–∏–∑
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php else: ?>
            <div class="no-version-card">
                <div class="no-version-icon">üß™</div>
                <h3>–ü—Ä–µ—Ä–µ–ª–∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–µ—Ä—Å–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            </div>
            <?php endif; ?>
            
            <!-- Upload Tabs -->
            <div class="upload-tabs">
                <button class="tab-button active" data-tab="software">üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –ü–û</button>
                <button class="tab-button" data-tab="update">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
                <button class="tab-button" data-tab="prerelease">üß™ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–µ–ª–∏–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
            </div>
            
            <!-- Software Upload Tab -->
            <div class="tab-content active" id="software-tab">
                <div class="upload-section">
                    <h3 class="section-title">üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –ü–û</h3>
                    
                    <div class="version-type-notice">
                        <div class="notice-icon">‚ÑπÔ∏è</div>
                        <div class="notice-content">
                            –ó–∞–≥—Ä—É–∂–∞–µ—Ç–µ –¥–ª—è: <strong><?php echo $version_label; ?></strong>
                            <input type="hidden" id="currentVersionType" value="<?php echo $current_version_type; ?>">
                        </div>
                    </div>
                    
                    <div class="upload-zone software-upload-zone" id="softwareUploadZone">
                        <div class="upload-icon">‚¨ÜÔ∏è</div>
                        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –ü–û (.rbz)</h3>
                        <p>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                        
                        <div class="upload-button">
                            üìé –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </div>
                        
                        <input type="file" id="softwareFileInput" accept=".rbz" style="display: none;">
                        
                        <div class="upload-info">
                            üí° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: RBZ ‚Ä¢ –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä: 500MB
                        </div>
                    </div>
                    
                    <!-- Version Info -->
                    <div class="version-inputs">
                        <div class="version-input-group">
                            <label>üî¢ –ù–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏:</label>
                            <input type="text" id="softwareVersion" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.0.0">
                        </div>
                        <div class="version-input-group">
                            <label>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:</label>
                            <textarea id="softwareVersionNotes" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è –≤ —ç—Ç–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Upload Button -->
                    <button id="softwareUploadButton" disabled class="upload-submit-button">
                        ‚è≥ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                    </button>
                    
                    <!-- Progress Bar -->
                    <div id="softwareUploadProgress" class="upload-progress">
                        <div class="progress-icon">üîÑ</div>
                        <div class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –ü–û...</div>
                        <div class="progress-bar">
                            <div id="softwareProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div id="softwareProgressText" class="progress-percent">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- Update Upload Tab -->
            <div class="tab-content" id="update-tab">
                <div class="upload-section">
                    <h3 class="section-title">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
                    
                    <div class="version-type-notice">
                        <div class="notice-icon">‚ÑπÔ∏è</div>
                        <div class="notice-content">
                            –ó–∞–≥—Ä—É–∂–∞–µ—Ç–µ –¥–ª—è: <strong><?php echo $version_label; ?></strong>
                            <input type="hidden" id="currentVersionType" value="<?php echo $current_version_type; ?>">
                        </div>
                    </div>
                    
                    <div class="upload-zone update-upload-zone" id="updateUploadZone">
                        <div class="upload-icon">‚¨ÜÔ∏è</div>
                        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (.tar.gz)</h3>
                        <p>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                        
                        <div class="upload-button">
                            üìé –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </div>
                        
                        <input type="file" id="updateFileInput" accept=".tar.gz,.gz" style="display: none;">
                        
                        <div class="upload-info">
                            üí° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: TAR.GZ ‚Ä¢ –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä: 500MB
                        </div>
                    </div>
                    
                    <!-- Version Info -->
                    <div class="version-inputs">
                        <div class="version-input-group">
                            <label>üî¢ –ù–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏:</label>
                            <input type="text" id="updateVersion" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 2.3.7">
                        </div>
                        <div class="version-input-group">
                            <label>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:</label>
                            <textarea id="updateVersionNotes" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è –≤ —ç—Ç–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Upload Button -->
                    <button id="updateUploadButton" disabled class="upload-submit-button">
                        ‚è≥ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                    </button>
                    
                    <!-- Progress Bar -->
                    <div id="updateUploadProgress" class="upload-progress">
                        <div class="progress-icon">üîÑ</div>
                        <div class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...</div>
                        <div class="progress-bar">
                            <div id="updateProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div id="updateProgressText" class="progress-percent">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- Prerelease Upload Tab -->
            <div class="tab-content" id="prerelease-tab">
                <div class="upload-section">
                    <h3 class="section-title">üß™ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–µ–ª–∏–∑–∞</h3>
                    
                    <div class="version-type-notice">
                        <div class="notice-icon">‚ÑπÔ∏è</div>
                        <div class="notice-content">
                            –ó–∞–≥—Ä—É–∂–∞–µ—Ç–µ –¥–ª—è: <strong><?php echo $version_label; ?></strong>
                            <input type="hidden" id="currentVersionType" value="<?php echo $current_version_type; ?>">
                        </div>
                    </div>
                    
                    <div class="prerelease-notice">
                        <div class="notice-icon">‚ö†Ô∏è</div>
                        <div class="notice-content">
                            <h4>–í–Ω–∏–º–∞–Ω–∏–µ: –ü—Ä–µ—Ä–µ–ª–∏–∑ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                            <p>–≠—Ç–∞ –≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –Ω–µ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –≤ –ø—É–±–ª–∏—á–Ω–æ–º API –¥–æ —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
                        </div>
                    </div>
                    
                    <div class="upload-zone prerelease-upload-zone" id="prereleaseUploadZone">
                        <div class="upload-icon">üß™</div>
                        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –ø—Ä–µ—Ä–µ–ª–∏–∑–∞ (.tar.gz)</h3>
                        <p>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                        
                        <div class="upload-button">
                            üìé –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                        </div>
                        
                        <input type="file" id="prereleaseFileInput" accept=".tar.gz,.gz" style="display: none;">
                        
                        <div class="upload-info">
                            üí° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: TAR.GZ ‚Ä¢ –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä: 500MB
                        </div>
                    </div>
                    
                    <!-- Version Info -->
                    <div class="version-inputs">
                        <div class="version-input-group">
                            <label>üî¢ –ù–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏:</label>
                            <input type="text" id="prereleaseVersion" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 2.3.7-rc1">
                        </div>
                        <div class="version-input-group">
                            <label>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:</label>
                            <textarea id="prereleaseVersionNotes" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Upload Button -->
                    <button id="prereleaseUploadButton" disabled class="upload-submit-button prerelease-upload-button">
                        ‚è≥ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                    </button>
                    
                    <!-- Progress Bar -->
                    <div id="prereleaseUploadProgress" class="upload-progress">
                        <div class="progress-icon">üîÑ</div>
                        <div class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –ø—Ä–µ—Ä–µ–ª–∏–∑–∞...</div>
                        <div class="progress-bar">
                            <div id="prereleaseProgressBar" class="progress-bar-fill"></div>
                        </div>
                        <div id="prereleaseProgressText" class="progress-percent">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- Backups History -->
            <?php $this->render_backups_list($backups_data, $current_version_type); ?>
            
            <!-- Updates History -->
            <?php $this->render_updates_list($updates_data, $current_version_type); ?>
        </div>

        <?php $this->enqueue_styles_scripts(); ?>
        <?php
        return ob_get_clean();
    }

    private function get_prerelease_update($version_type) {
        $file_path = $this->get_prerelease_dir($version_type) . '/artrocket.tar.gz';
        
        if (!file_exists($file_path)) {
            return null;
        }
        
        return array(
            'name' => basename($file_path),
            'path' => $file_path,
            'size' => filesize($file_path),
            'time' => filemtime($file_path)
        );
    }
    
    private function get_prerelease_dir($version_type) {
    switch ($version_type) {
        case 'interior':
            return $this->prerelease_dir_interior;
        case 'furniture':
            return $this->prerelease_dir_furniture;
        case 'trial':
            return $this->prerelease_dir_trial;
        default:
            return $this->prerelease_dir_interior;
    }
}
    
    
    private function get_backup_dir($version_type) {
    switch ($version_type) {
        case 'interior':
            return $this->backup_dir_interior;
        case 'furniture':
            return $this->backup_dir_furniture;
        case 'trial':
            return $this->backup_dir_trial;
        default:
            return $this->backup_dir_interior;
    }
}
    private function get_prerelease_info($version_type) {
        return get_option('software_prerelease_info_' . $version_type, array(
            'filename' => '',
            'size' => 0,
            'upload_time' => 0,
            'version_notes' => '',
            'version_number' => '',
            'uploaded_by' => 'manager',
            'status' => 'testing'
        ));
    }
    
    private function save_prerelease_info($version_type, $filename, $size, $notes, $version_number) {
        $info = array(
            'filename' => $filename,
            'size' => $size,
            'upload_time' => time(),
            'version_notes' => $notes,
            'version_number' => $version_number,
            'uploaded_by' => 'manager',
            'status' => 'testing'
        );
        
        update_option('software_prerelease_info_' . $version_type, $info);
    }

    public function handle_ajax_upload() {
    $this->send_no_cache_headers();
    
    error_log('=== AJAX UPLOAD HANDLER ===');
    error_log('POST data: ' . print_r($_POST, true));
    error_log('COOKIE data: ' . print_r($_COOKIE, true));
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'software_upload_nonce')) {
        error_log('CSRF check failed: invalid nonce');
        wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω', 403);
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–µ—Å—Å–∏–∏
    if (!$this->check_ajax_auth()) {
        error_log('Authentication FAILED in handle_ajax_upload');
        wp_send_json_error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 403);
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
    if (empty($_FILES['software_file'])) {
        wp_send_json_error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
    }
        
        $file_type = sanitize_text_field($_POST['file_type']);
    $version_type = sanitize_text_field($_POST['version_type']);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º API resource –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤–µ—Ä—Å–∏–∏
    if ($version_type === 'interior') {
        $api_resource = $file_type === 'software' ? 'plugin' : 'plugin_update';
    } elseif ($version_type === 'furniture') {
        $api_resource = $file_type === 'software' ? 'plugin_furniture' : 'plugin_update_furniture';
    } elseif ($version_type === 'trial') {
        // –î–ª—è Trial –≤–µ—Ä—Å–∏–∏
        $api_resource = $file_type === 'software' ? 'plugin_trial' : 'plugin_update_trial';
    } else {
        wp_send_json_error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –≤–µ—Ä—Å–∏–∏');
    }
        $file = $_FILES['software_file'];
        $version_number = sanitize_text_field($_POST['version_number']);
        $version_notes = sanitize_textarea_field($_POST['version_notes']);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if ($file_type === 'software') {
            $file_ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
            if ($file_ext !== 'rbz') {
                wp_send_json_error('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç RBZ.');
            }
            $new_filename = 'software.rbz';
            $new_filepath = $this->get_current_dir($version_type) . '/' . $new_filename;
            $api_resource = $version_type === 'interior' ? 'plugin' : 'plugin_furniture';
            $this->create_backup('software', $version_type);
            
        } elseif ($file_type === 'update') {
            $file_ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
            $allowed_extensions = ['gz', 'tar.gz'];
            $is_valid_extension = in_array($file_ext, $allowed_extensions);
            
            if (!$is_valid_extension) {
                foreach ($allowed_extensions as $ext) {
                    if (strpos($file['name'], $ext) !== false) {
                        $is_valid_extension = true;
                        break;
                    }
                }
            }
            
            if (!$is_valid_extension) {
                wp_send_json_error('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç TAR.GZ.');
            }
            $new_filename = 'artrocket.tar.gz';
            $new_filepath = $this->get_update_dir($version_type) . '/' . $new_filename;
            $api_resource = $version_type === 'interior' ? 'plugin_update' : 'plugin_update_furniture';
            $this->create_backup('update', $version_type);
            
        } elseif ($file_type === 'prerelease') {
            $file_ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
            $allowed_extensions = ['gz', 'tar.gz'];
            $is_valid_extension = in_array($file_ext, $allowed_extensions);
            
            if (!$is_valid_extension) {
                foreach ($allowed_extensions as $ext) {
                    if (strpos($file['name'], $ext) !== false) {
                        $is_valid_extension = true;
                        break;
                    }
                }
            }
            
            if (!$is_valid_extension) {
                wp_send_json_error('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç TAR.GZ.');
            }
            $new_filename = 'artrocket.tar.gz';
            $new_filepath = $this->get_prerelease_dir($version_type) . '/' . $new_filename;
            $api_resource = $version_type === 'interior' ? 'prerelease' : 'prerelease_furniture';
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–µ—Ä–µ–ª–∏–∑ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (file_exists($new_filepath)) {
                unlink($new_filepath);
            }
        } else {
            wp_send_json_error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞');
        }
        
        if ($file['size'] > 500 * 1024 * 1024) {
            wp_send_json_error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 500MB');
        }
        
        if (move_uploaded_file($file['tmp_name'], $new_filepath)) {
            // –û—á–∏—â–∞–µ–º –∫–µ—à –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            $this->clear_cache($version_type);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏
            if ($file_type === 'software') {
                $this->save_version_info($version_type, $new_filename, $file['size'], $version_notes, $version_number);
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ API
                $this->send_version_notification($api_resource, $version_number);
                
            } elseif ($file_type === 'update') {
                $this->save_update_info($version_type, $new_filename, $file['size'], $version_notes, $version_number);
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ API
                $this->send_version_notification($api_resource, $version_number);
                
            } elseif ($file_type === 'prerelease') {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ—Ä–µ–ª–∏–∑–µ
                $this->save_prerelease_info($version_type, $new_filename, $file['size'], $version_notes, $version_number);
                // –î–ª—è –ø—Ä–µ—Ä–µ–ª–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å isdev=yes
                $this->send_prerelease_notification($version_type, $version_number);
            }
            
            wp_send_json_success('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
        } else {
            wp_send_json_error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –ø–∞–ø–∫—É.');
        }
        
         error_log('=== AJAX UPLOAD SUCCESS ===');
    }

    private function send_prerelease_notification($version_type, $version) {
        if (empty($version)) {
            return false;
        }
        
        $resource = $version_type === 'interior' ? 'prerelease' : 'prerelease_furniture';
        
        $data = array(
            'res' => $resource,
            'isdev' => 'yes',
            'version' => $version
        );
        
        $args = array(
            'body' => $data,
            'timeout' => 30,
            'redirection' => 5,
            'httpversion' => '1.0',
            'blocking' => true,
            'headers' => array(
                'Content-Type' => 'application/x-www-form-urlencoded',
            ),
        );
        
        $response = wp_remote_post($this->api_url . 'version', $args);
        
        if (is_wp_error($response)) {
            error_log('Prerelease API notification failed: ' . $response->get_error_message());
            return false;
        } else {
            error_log('Prerelease API notification sent: ' . $resource . ' isdev=yes, version=' . $version . ' - Response: ' . $response['body']);
            return true;
        }
    }

    public function handle_promote_prerelease() {
        $this->send_no_cache_headers();
        
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'promote_prerelease_nonce')) {
            wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π nonce');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (!$this->check_ajax_auth()) {
            wp_send_json_error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
        }
        
        $version_type = sanitize_text_field($_POST['version_type']);
        $prerelease_info = $this->get_prerelease_info($version_type);
        $prerelease_file = $this->get_prerelease_dir($version_type) . '/artrocket.tar.gz';
        
        if (!file_exists($prerelease_file) || empty($prerelease_info['version_number'])) {
            wp_send_json_error('–ü—Ä–µ—Ä–µ–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        
        // –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        $this->create_backup('update', $version_type);
        
        // –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–µ—Ä–µ–ª–∏–∑ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        $update_file = $this->get_update_dir($version_type) . '/artrocket.tar.gz';
        
        if (copy($prerelease_file, $update_file)) {
            // –û—á–∏—â–∞–µ–º –∫–µ—à –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            $this->clear_cache($version_type);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
            $this->save_update_info(
                $version_type,
                'artrocket.tar.gz',
                filesize($update_file),
                $prerelease_info['version_notes'],
                $prerelease_info['version_number']
            );
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
            $api_resource = $version_type === 'interior' ? 'plugin_update' : 'plugin_update_furniture';
            $this->send_version_notification($api_resource, $prerelease_info['version_number']);
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ—Ä–µ–ª–∏–∑
            unlink($prerelease_file);
            delete_option('software_prerelease_info_' . $version_type);
            
            wp_send_json_success('–ü—Ä–µ—Ä–µ–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø—É—â–µ–Ω –≤ –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø');
        } else {
            wp_send_json_error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞');
        }
    }
    
    public function handle_rollback_update() {
        $this->send_no_cache_headers();
        
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'rollback_update_nonce')) {
            wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π nonce');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (!$this->check_ajax_auth()) {
            wp_send_json_error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
        }
        
        $version_type = sanitize_text_field($_POST['version_type']);
        $version = sanitize_text_field($_POST['version']);
        
        if (empty($version)) {
            wp_send_json_error('–í–µ—Ä—Å–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞');
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º API –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–∫–∞—Ç –≤–µ—Ä—Å–∏–∏
        $result = $this->send_rollback_notification($version_type, $version);
        
        if ($result) {
            wp_send_json_success('–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–∫–∞—Ç –≤–µ—Ä—Å–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        } else {
            wp_send_json_error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–∫–∞—Ç');
        }
    }
    
    public function handle_delete_prerelease() {
        $this->send_no_cache_headers();
        
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'delete_prerelease_nonce')) {
            wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π nonce');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (!$this->check_ajax_auth()) {
            wp_send_json_error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
        }
        
        $version_type = sanitize_text_field($_POST['version_type']);
        $prerelease_file = $this->get_prerelease_dir($version_type) . '/artrocket.tar.gz';
        
        if (file_exists($prerelease_file)) {
            unlink($prerelease_file);
        }
        
        delete_option('software_prerelease_info_' . $version_type);
        $this->clear_cache($version_type);
        
        wp_send_json_success('–ü—Ä–µ—Ä–µ–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
    }
    
    public function handle_refresh_cache() {
        $this->send_no_cache_headers();
        
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'software_refresh_cache')) {
            wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π nonce');
        }
        
        if (!$this->check_ajax_auth()) {
            wp_send_json_error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
        }
        
        $version_type = isset($_POST['version_type']) ? sanitize_text_field($_POST['version_type']) : null;
        $this->clear_cache($version_type);
        
        wp_send_json_success('–ö–µ—à —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
    }
    
    private function send_rollback_notification($version_type, $version) {
        $resource = $version_type === 'interior' ? 'plugin_update' : 'plugin_update_furniture';
        
        $data = array(
            'res' => $resource,
            'version' => $version
        );
        
        $args = array(
            'body' => $data,
            'timeout' => 30,
            'redirection' => 5,
            'httpversion' => '1.0',
            'blocking' => true,
            'headers' => array(
                'Content-Type' => 'application/x-www-form-urlencoded',
            ),
        );
        
        $response = wp_remote_post($this->api_url . 'deversion', $args);
        
        if (is_wp_error($response)) {
            error_log('Rollback API notification failed: ' . $response->get_error_message());
            return false;
        } else {
            error_log('Rollback API notification sent: ' . $resource . ' v' . $version . ' - Response: ' . $response['body']);
            return true;
        }
    }

    private function create_backup($type = 'software', $version_type = 'interior') {
    if ($type === 'software') {
        $current_file = $this->get_current_file_path($version_type);
        $prefix = 'software-';
        $extension = '.rbz';
        $info_method = 'get_version_info';
    } else {
        $current_file = $this->get_current_update_path($version_type);
        $prefix = 'update-';
        $extension = '.tar.gz';
        $info_method = 'get_update_info';
    }
    if ($current_file && file_exists($current_file)) {
            if ($version_type === 'interior') {
                $backup_dir = $this->backup_dir_interior;
            } elseif ($version_type === 'furniture') {
                $backup_dir = $this->backup_dir_furniture;
            } elseif ($version_type === 'trial') {
                $backup_dir = $this->backup_dir_trial;
            } else {
                $backup_dir = $this->backup_dir_interior;
            }
        $backup_filename = $prefix . date('Y-m-d-H-i-s') . $extension;
        $backup_path = $backup_dir . '/' . $backup_filename;
            
            if (copy($current_file, $backup_path)) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—ç–∫–∞–ø–µ
                $current_info = $this->$info_method($version_type);
                if ($type === 'software') {
                    $this->save_backup_info($version_type, $backup_filename, $current_info['version_notes'] ?? '', $current_info['version_number'] ?? '');
                } else {
                    $this->save_update_backup_info($version_type, $backup_filename, $current_info['version_notes'] ?? '', $current_info['version_number'] ?? '');
                }
                
                $this->cleanup_old_backups($type, $version_type, 10);
                return true;
            }
        }
        return false;
    }
    
   private function cleanup_old_backups($type = 'software', $version_type = 'interior', $keep_count = 10) {
        if ($version_type === 'interior') {
            $backup_dir = $this->backup_dir_interior;
        } elseif ($version_type === 'furniture') {
            $backup_dir = $this->backup_dir_furniture;
        } elseif ($version_type === 'trial') {
            $backup_dir = $this->backup_dir_trial;
        } else {
            $backup_dir = $this->backup_dir_interior;
        }
        $prefix = $type === 'software' ? 'software-*' : 'update-*';
        $backups = glob($backup_dir . '/' . $prefix);
        
        if (count($backups) > $keep_count) {
            usort($backups, function($a, $b) {
                return filemtime($a) - filemtime($b);
            });
            
            $to_delete = count($backups) - $keep_count;
            for ($i = 0; $i < $to_delete; $i++) {
                unlink($backups[$i]);
            }
        }
    }
    
    private function get_current_dir($version_type) {
    switch ($version_type) {
        case 'interior':
            return $this->current_dir_interior;
        case 'furniture':
            return $this->current_dir_furniture;
        case 'trial':
            return $this->current_dir_trial;
        default:
            return $this->current_dir_interior;
    }
}
    
    private function get_update_dir($version_type) {
    switch ($version_type) {
        case 'interior':
            return $this->update_dir_interior;
        case 'furniture':
            return $this->update_dir_furniture;
        case 'trial':
            return $this->update_dir_trial;
        default:
            return $this->update_dir_interior;
    }
}
    
    private function get_current_file_path($version_type) {
        $dir = $this->get_current_dir($version_type);
        $files = glob($dir . '/software.*');
        return empty($files) ? null : $files[0];
    }
    
    private function get_current_update_path($version_type) {
        $dir = $this->get_update_dir($version_type);
        $files = glob($dir . '/artrocket.*');
        return empty($files) ? null : $files[0];
    }
    
    private function get_current_file($version_type) {
        $file_path = $this->get_current_file_path($version_type);
        
        if (!$file_path || !file_exists($file_path)) {
            return null;
        }
        
        return array(
            'name' => basename($file_path),
            'path' => $file_path,
            'size' => filesize($file_path),
            'time' => filemtime($file_path)
        );
    }
    
    private function get_current_update($version_type) {
        $file_path = $this->get_current_update_path($version_type);
        
        if (!$file_path || !file_exists($file_path)) {
            return null;
        }
        
        return array(
            'name' => basename($file_path),
            'path' => $file_path,
            'size' => filesize($file_path),
            'time' => filemtime($file_path)
        );
    }
    
    private function get_version_info($version_type) {
        return get_option('software_current_version_' . $version_type, array(
            'filename' => '',
            'size' => 0,
            'upload_time' => 0,
            'version_notes' => '',
            'version_number' => '',
            'uploaded_by' => 'manager'
        ));
    }
    
    private function get_update_info($version_type) {
        return get_option('software_current_update_' . $version_type, array(
            'filename' => '',
            'size' => 0,
            'upload_time' => 0,
            'version_notes' => '',
            'version_number' => '',
            'uploaded_by' => 'manager'
        ));
    }
    
    private function save_version_info($version_type, $filename, $size, $notes, $version_number) {
        $info = array(
            'filename' => $filename,
            'size' => $size,
            'upload_time' => time(),
            'version_notes' => $notes,
            'version_number' => $version_number,
            'uploaded_by' => 'manager'
        );
        
        update_option('software_current_version_' . $version_type, $info);
        
        // Save to version logs
        $backup_filename = 'software-' . date('Y-m-d-H-i-s') . '.rbz';
        $this->save_backup_info($version_type, $backup_filename, $notes, $version_number);
    }
    
    private function save_update_info($version_type, $filename, $size, $notes, $version_number) {
        $info = array(
            'filename' => $filename,
            'size' => $size,
            'upload_time' => time(),
            'version_notes' => $notes,
            'version_number' => $version_number,
            'uploaded_by' => 'manager'
        );
        
        update_option('software_current_update_' . $version_type, $info);
        
        // Save to update logs
        $backup_filename = 'update-' . date('Y-m-d-H-i-s') . '.tar.gz';
        $this->save_update_backup_info($version_type, $backup_filename, $notes, $version_number);
    }
    
    private function save_backup_info($version_type, $filename, $description, $version) {
        $version_logs = get_option('software_version_logs_' . $version_type, array());
        
        $version_logs[] = array(
            'backup_file' => $filename,
            'description' => $description,
            'version' => $version,
            'timestamp' => time()
        );
        
        if (count($version_logs) > 50) {
            $version_logs = array_slice($version_logs, -50);
        }
        
        update_option('software_version_logs_' . $version_type, $version_logs);
    }
    
    private function save_update_backup_info($version_type, $filename, $description, $version) {
        $update_logs = get_option('software_update_logs_' . $version_type, array());
        
        $update_logs[] = array(
            'backup_file' => $filename,
            'description' => $description,
            'version' => $version,
            'timestamp' => time()
        );
        
        if (count($update_logs) > 50) {
            $update_logs = array_slice($update_logs, -50);
        }
        
        update_option('software_update_logs_' . $version_type, $update_logs);
    }
    
    private function get_backup_description($version_type, $filename) {
        $version_logs = get_option('software_version_logs_' . $version_type, array());
        
        foreach (array_reverse($version_logs) as $log) {
            if (isset($log['backup_file']) && $log['backup_file'] === $filename) {
                return $log['description'] ?? '';
            }
        }
        
        return '';
    }
    
    private function get_backup_version($version_type, $filename) {
        $version_logs = get_option('software_version_logs_' . $version_type, array());
        
        foreach (array_reverse($version_logs) as $log) {
            if (isset($log['backup_file']) && $log['backup_file'] === $filename) {
                return $log['version'] ?? '';
            }
        }
        
        return '';
    }
    
    private function get_update_description($version_type, $filename) {
        $update_logs = get_option('software_update_logs_' . $version_type, array());
        
        foreach (array_reverse($update_logs) as $log) {
            if (isset($log['backup_file']) && $log['backup_file'] === $filename) {
                return $log['description'] ?? '';
            }
        }
        
        return '';
    }
    
    private function get_update_version($version_type, $filename) {
        $update_logs = get_option('software_update_logs_' . $version_type, array());
        
        foreach (array_reverse($update_logs) as $log) {
            if (isset($log['backup_file']) && $log['backup_file'] === $filename) {
                return $log['version'] ?? '';
            }
        }
        
        return '';
    }
    
    private function send_version_notification($resource, $version) {
    if (empty($resource) || empty($version)) {
        return false;
    }
    
    $data = array(
        'res' => $resource,
        'version' => $version
    );
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é –ø–æ resource (–µ—Å–ª–∏ –≤ resource —É–∂–µ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
    // –ù–∞–ø—Ä–∏–º–µ—Ä: 'plugin_interior', 'plugin_update_furniture', 'plugin_trial'
    // –ï—Å–ª–∏ —É –≤–∞—Å —Ç–∞–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
    
    $args = array(
        'body' => $data,
        'timeout' => 30,
        'redirection' => 5,
        'httpversion' => '1.0',
        'blocking' => true,
        'headers' => array(
            'Content-Type' => 'application/x-www-form-urlencoded',
        ),
    );
    
    $response = wp_remote_post($this->api_url . 'version', $args);
    
    if (is_wp_error($response)) {
        error_log('API notification failed: ' . $response->get_error_message());
        return false;
    } else {
        error_log('API notification sent: ' . $resource . ' v' . $version . ' - Response: ' . $response['body']);
        return true;
    }
}

    private function render_backups_list($backups_data, $version_type) {
        if (empty($backups_data)) {
            echo '<div class="no-backups">üì≠ –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ü–û –ø—É—Å—Ç–∞</div>';
            return;
        }
        ?>
        <div class="backups-section">
            <h3 class="section-title">üìÅ –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ü–û</h3>
            <div class="backups-list">
                <?php foreach ($backups_data as $backup): 
                    $backup_filename = $backup['name'];
                    $backup_date = date('d.m.Y –≤ H:i', $backup['time'] + 3 * 3600);
                    $backup_size = size_format($backup['size']);
                    $backup_description = $this->get_backup_description($version_type, $backup_filename);
                    $backup_version = $this->get_backup_version($version_type, $backup_filename);
                ?>
                <div class="backup-item">
                    <div class="backup-icon">üóÇÔ∏è</div>
                    <div class="backup-info">
                        <div class="backup-header">
                            <div class="backup-name" title="<?php echo esc_attr($backup_filename); ?>">
                                <?php echo esc_html($backup_filename); ?>
                            </div>
                            <div class="backup-meta">
                                <?php if ($backup_version): ?>
                                <span class="backup-version">üî¢ <?php echo esc_html($backup_version); ?></span>
                                <span class="backup-separator">‚Ä¢</span>
                                <?php endif; ?>
                                <span class="backup-date">üìÖ <?php echo esc_html($backup_date); ?></span>
                                <span class="backup-separator">‚Ä¢</span>
                                <span class="backup-size">üíæ <?php echo esc_html($backup_size); ?></span>
                            </div>
                        </div>
                        <?php if (!empty($backup_description)): ?>
                        <div class="backup-description">
                            <div class="description-text"><?php echo nl2br(esc_html($backup_description)); ?></div>
                        </div>
                        <?php else: ?>
                        <div class="no-description">
                            <em>‚ÑπÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</em>
                        </div>
                        <?php endif; ?>
                    </div>
                    <div class="backup-actions">
                        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin-ajax.php?action=download_backup&file=' . $backup_filename . '&version_type=' . $version_type), 'download_backup_' . $backup_filename)); ?>" 
                           class="backup-download-btn" title="–°–∫–∞—á–∞—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é">
                            ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å
                        </a>
                        <button type="button" class="backup-restore-btn" 
                                data-filename="<?php echo esc_attr($backup_filename); ?>"
                                data-description="<?php echo esc_attr($backup_description); ?>"
                                data-version="<?php echo esc_attr($backup_version); ?>"
                                data-version-type="<?php echo $version_type; ?>"
                                title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é">
                            üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
                <?php endforeach; ?>
            </div>
        </div>
        <?php
    }
    
    private function render_updates_list($updates_data, $version_type) {
        if (empty($updates_data)) {
            echo '<div class="no-backups">üì≠ –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞</div>';
            return;
        }
        ?>
        <div class="backups-section">
            <h3 class="section-title">üîÑ –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</h3>
            <div class="backups-list">
                <?php foreach ($updates_data as $update): 
                    $update_filename = $update['name'];
                    $update_date = date('d.m.Y –≤ H:i', $update['time'] + 3 * 3600);
                    $update_size = size_format($update['size']);
                    $update_description = $this->get_update_description($version_type, $update_filename);
                    $update_version = $this->get_update_version($version_type, $update_filename);
                ?>
                <div class="backup-item">
                    <div class="backup-icon">üîÑ</div>
                    <div class="backup-info">
                        <div class="backup-header">
                            <div class="backup-name" title="<?php echo esc_attr($update_filename); ?>">
                                <?php echo esc_html($update_filename); ?>
                            </div>
                            <div class="backup-meta">
                                <?php if ($update_version): ?>
                                <span class="backup-version">üî¢ <?php echo esc_html($update_version); ?></span>
                                <span class="backup-separator">‚Ä¢</span>
                                <?php endif; ?>
                                <span class="backup-date">üìÖ <?php echo esc_html($update_date); ?></span>
                                <span class="backup-separator">‚Ä¢</span>
                                <span class="backup-size">üíæ <?php echo esc_html($update_size); ?></span>
                            </div>
                        </div>
                        <?php if (!empty($update_description)): ?>
                        <div class="backup-description">
                            <div class="description-text"><?php echo nl2br(esc_html($update_description)); ?></div>
                        </div>
                        <?php else: ?>
                        <div class="no-description">
                            <em>‚ÑπÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</em>
                        </div>
                        <?php endif; ?>
                    </div>
                    <div class="backup-actions">
                        <a href="<?php echo esc_url(wp_nonce_url(admin_url('admin-ajax.php?action=download_backup&file=' . $update_filename . '&version_type=' . $version_type), 'download_backup_' . $update_filename)); ?>" 
                           class="backup-download-btn" title="–°–∫–∞—á–∞—Ç—å —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ">
                            ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å
                        </a>
                        <button type="button" class="update-restore-btn" 
                                data-filename="<?php echo esc_attr($update_filename); ?>"
                                data-description="<?php echo esc_attr($update_description); ?>"
                                data-version="<?php echo esc_attr($update_version); ?>"
                                data-version-type="<?php echo $version_type; ?>"
                                title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ">
                            üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
                <?php endforeach; ?>
            </div>
        </div>

        <!-- Restore Modals -->
        <div id="restoreModal" class="restore-modal">
            <div class="restore-modal-content">
                <h3>üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –ü–û?</h3>
                <p id="restoreModalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é?</p>
                <div id="restoreDescription" class="restore-description"></div>
                <div class="modal-actions">
                    <button id="confirmRestore" class="modal-confirm">‚úÖ –î–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button id="cancelRestore" class="modal-cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <div id="restoreUpdateModal" class="restore-modal">
            <div class="restore-modal-content">
                <h3>üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ?</h3>
                <p id="restoreUpdateModalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ?</p>
                <div id="restoreUpdateDescription" class="restore-description"></div>
                <div class="modal-actions">
                    <button id="confirmUpdateRestore" class="modal-confirm">‚úÖ –î–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button id="cancelUpdateRestore" class="modal-cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        <?php
    }

    private function enqueue_styles_scripts() {
        ?>
        <style>
        .software-upload-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        
        /* Version Type Switcher */
        .version-type-switcher {
            margin-bottom: 30px;
        }
        
        .version-toggles {
            display: flex;
            gap: 15px;
            background: #1a1a1a;
            border-radius: 15px;
            padding: 10px;
            border: 1px solid #333;
        }
        
        .version-toggle {
            flex: 1;
            position: relative;
            cursor: pointer;
        }
        
        .version-toggle input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px;
            border-radius: 12px;
            background: #2a2a2a;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .version-toggle.active .toggle-content {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }
        
        .version-toggle:not(.active):hover .toggle-content {
            background: #333;
            border-color: #444;
        }
        
        .toggle-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .toggle-text {
            font-weight: 600;
            font-size: 16px;
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        .toggle-subtext {
            font-size: 12px;
            color: #888;
        }
        
        .version-type-notice {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .version-type-notice .notice-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .version-type-notice .notice-content {
            flex: 1;
            color: #cccccc;
            font-size: 14px;
        }
        
        .version-type-notice .notice-content strong {
            color: #ffffff;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            gap: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .header-content h1 {
            color: #ffffff;
            margin: 0 0 8px;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-content p {
            color: #a0a0a0;
            margin: 0;
            font-size: 16px;
        }
        
        .header-content p strong {
            color: #667eea;
        }
        
        .cache-info {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refresh-cache-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-cache-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .logout-button {
            padding: 12px 24px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .logout-button:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
         .software-upload-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            gap: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .header-content h1 {
            color: #ffffff;
            margin: 0 0 8px;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-content p {
            color: #a0a0a0;
            margin: 0;
            font-size: 16px;
        }
        
        .cache-info {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refresh-cache-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-cache-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .logout-button {
            padding: 12px 24px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .logout-button:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .software-upload-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            gap: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333);
        }
        
        .header-content h1 {
            color: #ffffff;
            margin: 0 0 8px;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-content p {
            color: #a0a0a0;
            margin: 0;
            font-size: 16px;
        }
        
        .logout-button {
            padding: 12px 24px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .logout-button:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .current-version-card {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid #333;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .update-card {
            border-left: 5px solid #28a745;
        }
        
        .prerelease-card {
            border-left: 5px solid #ffc107;
        }
        
        .version-content {
            display: flex;
            align-items: flex-start;
            gap: 25px;
        }
        
        .version-icon {
            font-size: 48px;
            opacity: 0.9;
        }
        
        .version-details {
            flex: 1;
        }
        
        .version-details h3 {
            margin: 0 0 20px;
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .version-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #a0a0a0;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .stat-value {
            font-weight: 600;
            font-size: 16px;
            color: #ffffff;
        }
        
        .version-notes {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .notes-label {
            font-size: 13px;
            color: #a0a0a0;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .notes-content {
            font-weight: 500;
            font-size: 14px;
            line-height: 1.5;
            color: #e0e0e0;
        }
        
        .no-notes {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px dashed #444;
        }
        
        .no-notes-text {
            font-size: 14px;
            color: #888;
        }
        
        .no-version-card {
            background: #1a1a1a;
            border: 2px dashed #444;
            padding: 50px 40px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .no-version-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .no-version-card h3 {
            color: #cccccc;
            margin: 0 0 15px;
            font-size: 22px;
        }
        
        .no-version-card p {
            color: #888;
            margin: 0;
        }
        
        .upload-tabs {
            display: flex;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .tab-button {
            flex: 1;
            margin-left: 10px !important;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: #667eea;
            color: white;
        }
        
        .tab-button:hover:not(.active) {
            background: #2a2a2a;
            color: #cccccc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            margin-bottom: 50px;
        }
        
        .section-title {
            color: #ffffff;
            margin: 0 0 20px;
            font-size: 22px;
            font-weight: 600;
        }
        
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            margin-bottom: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .update-upload-zone {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }
        
        .prerelease-upload-zone {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.05);
        }
        
        .upload-zone:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
            transform: translateY(-2px);
        }
        
        .update-upload-zone:hover {
            background: rgba(40, 167, 69, 0.1);
            border-color: #218838;
        }
        
        .prerelease-upload-zone:hover {
            background: rgba(255, 193, 7, 0.1);
            border-color: #e0a800;
        }
        
        .upload-zone.dragover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #2196f3;
            transform: scale(1.02);
        }
        
        .update-upload-zone.dragover {
            background: rgba(40, 167, 69, 0.15);
            border-color: #1e7e34;
        }
        
        .prerelease-upload-zone.dragover {
            background: rgba(255, 193, 7, 0.15);
            border-color: #d39e00;
        }
        
        .upload-icon {
            font-size: 72px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .upload-zone h3 {
            color: #ffffff;
            margin: 0 0 15px;
            font-size: 26px;
            font-weight: 600;
        }
        
        .upload-zone p {
            color: #a0a0a0;
            margin: 0 0 30px;
            font-size: 16px;
        }
        
        .upload-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .update-upload-zone .upload-button {
            background: #28a745;
        }
        
        .prerelease-upload-zone .upload-button {
            background: #ffc107;
            color: #212529;
        }
        
        .upload-button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .update-upload-zone .upload-button:hover {
            background: #218838;
        }
        
        .prerelease-upload-zone .upload-button:hover {
            background: #e0a800;
        }
        
        .upload-info {
            margin-top: 25px;
            font-size: 14px;
            color: #888;
        }
        
        .prerelease-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .notice-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notice-content h4 {
            margin: 0 0 8px;
            color: #ffc107;
            font-size: 16px;
        }
        
        .notice-content p {
            margin: 0;
            color: #cccccc;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .version-inputs {
            margin-bottom: 25px;
        }
        
        .version-input-group {
            margin-bottom: 20px;
        }
        
        .version-input-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #ffffff;
            font-size: 16px;
        }
        
        .version-input-group input,
        .version-input-group textarea {
            width: 100%;
            padding: 18px;
            border: 2px solid #333;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .version-input-group textarea {
            min-height: 100px;
        }
        
        .version-input-group input:focus,
        .version-input-group textarea:focus {
            border-color: #667eea;
            outline: none;
            background: #1f1f1f;
        }
        
        .upload-submit-button {
            width: 100%;
            padding: 20px;
            background: #2d2d2d;
            color: #888;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-submit-button:enabled {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .update-tab .upload-submit-button:enabled {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .prerelease-upload-button:enabled {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }
        
        .upload-submit-button:enabled:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .update-tab .upload-submit-button:enabled:hover {
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
        }
        
        .prerelease-upload-button:enabled:hover {
            box-shadow: 0 10px 30px rgba(255, 193, 7, 0.4);
        }
        
        .upload-submit-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .upload-progress {
            display: none;
            margin-top: 25px;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 1px solid #333;
        }
        
        .progress-icon {
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .progress-text {
            font-weight: 600;
            margin-bottom: 15px;
            color: #ffffff;
            font-size: 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 5px;
        }
        
        .update-progress .progress-bar-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
        }
        
        .prerelease-progress .progress-bar-fill {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }
        
        .progress-percent {
            font-size: 14px;
            color: #a0a0a0;
        }
        
        .rollback-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 8px;
            border-left: 3px solid #dc3545;
        }
        
        .rollback-button {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rollback-button:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .rollback-notice {
            font-size: 12px;
            color: #888;
            margin: 8px 0 0;
        }
        
        .prerelease-links {
            margin-top: 20px;
        }
        
        .dev-link-section {
            margin-bottom: 20px;
        }
        
        .dev-link-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .link-container input {
            flex: 1;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        .copy-link-btn {
            padding: 12px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .copy-link-btn:hover {
            background: #5a6268;
        }
        
        .link-notice {
            font-size: 12px;
            color: #888;
            margin: 0;
        }
        
        .prerelease-actions {
            display: flex;
            gap: 10px;
        }
        
        .promote-prerelease-btn {
            flex: 1;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .promote-prerelease-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .delete-prerelease-btn {
            flex: 1;
            padding: 12px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .delete-prerelease-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .backups-section {
            margin-top: 50px;
        }
        
        .no-backups {
            text-align: center;
            padding: 40px;
            background: #1a1a1a;
            border-radius: 12px;
            color: #888;
            font-size: 16px;
            border: 1px dashed #333;
        }
        
        .backups-list {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .backup-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #2d2d2d;
            transition: background 0.3s ease;
            gap: 20px;
        }
        
        .backup-item:hover {
            background: #222;
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }
        
        .backup-icon {
            font-size: 24px;
            opacity: 0.8;
        }
        
        .backup-info {
            flex: 1;
            min-width: 0;
        }
        
        .backup-header {
            margin-bottom: 8px;
        }
        
        .backup-name {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
            font-size: 14px;
            word-break: break-all;
        }
        
        .backup-meta {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .backup-version {
            color: #667eea;
            font-weight: 500;
        }
        
        .backup-separator {
            opacity: 0.5;
        }
        
        .backup-description {
            margin-top: 10px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .description-text {
            font-size: 13px;
            color: #cccccc;
            line-height: 1.4;
        }
        
        .no-description {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .backup-download-btn {
            padding: 10px 16px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .backup-download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .backup-restore-btn,
        .update-restore-btn {
            padding: 10px 16px;
            background: #ffc107;
            color: #212529;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .backup-restore-btn:hover,
        .update-restore-btn:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }
        
        .restore-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .restore-modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .restore-modal-content h3 {
            margin: 0 0 15px;
            color: #ffffff;
            font-size: 20px;
        }
        
        .restore-modal-content p {
            color: #a0a0a0;
            margin-bottom: 15px;
        }
        
        .restore-description {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
            border-left: 3px solid #667eea;
        }
        
        .restore-description .description-text {
            font-size: 14px;
            color: #cccccc;
            line-height: 1.4;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .modal-confirm {
            padding: 12px 24px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .modal-confirm:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .modal-cancel {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .modal-cancel:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .software-upload-panel {
                padding: 20px;
                margin: 10px;
            }
            
            .panel-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .version-content {
                flex-direction: column;
                text-align: center;
            }
            
            .version-stats {
                grid-template-columns: 1fr;
            }
            
            .backup-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .backup-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .backup-download-btn,
            .backup-restore-btn,
            .update-restore-btn {
                flex: 1;
                text-align: center;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .upload-tabs {
                flex-direction: column;
            }
            
            .prerelease-actions {
                flex-direction: column;
            }
        }
        </style>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø—Ä–æ—Ç–∏–≤ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
            function addCacheBuster(url) {
                const timestamp = new Date().getTime();
                return url + (url.indexOf('?') === -1 ? '?' : '&') + '_=' + timestamp;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –≤–µ—Ä—Å–∏–∏
            const currentVersionType = document.getElementById('currentVersionType') ? 
                                      document.getElementById('currentVersionType').value : 'interior';
            
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    
                    // Update buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update contents
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabName + '-tab') {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Software upload functionality
            initUploadFunctionality('software');
            
            // Update upload functionality
            initUploadFunctionality('update');
            
            // Prerelease upload functionality
            initUploadFunctionality('prerelease');
            
            function initUploadFunctionality(type) {
                const uploadZone = document.getElementById(type + 'UploadZone');
                const fileInput = document.getElementById(type + 'FileInput');
                const uploadButton = document.getElementById(type + 'UploadButton');
                const progressContainer = document.getElementById(type + 'UploadProgress');
                const progressBar = document.getElementById(type + 'ProgressBar');
                const progressText = document.getElementById(type + 'ProgressText');
                const versionInput = document.getElementById(type + 'Version');
                const versionNotes = document.getElementById(type + 'VersionNotes');
                
                let selectedFile = null;
                
                // Drag & Drop
                uploadZone.addEventListener('click', () => fileInput.click());
                
                ['dragover', 'dragenter'].forEach(event => {
                    uploadZone.addEventListener(event, (e) => {
                        e.preventDefault();
                        uploadZone.classList.add('dragover');
                    });
                });
                
                ['dragleave', 'dragend', 'drop'].forEach(event => {
                    uploadZone.addEventListener(event, (e) => {
                        e.preventDefault();
                        uploadZone.classList.remove('dragover');
                    });
                });
                
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer.files.length) {
                        handleFileSelect(e.dataTransfer.files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        handleFileSelect(e.target.files[0]);
                    }
                });
                
                function handleFileSelect(file) {
                    const maxSize = 500 * 1024 * 1024;
                    const allowedExtensions = type === 'software' ? ['.rbz'] : ['.tar.gz', '.gz'];
                    
                    if (file.size > maxSize) {
                        alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 500MB');
                        return;
                    }
                    
                    // Check for tar.gz first, then other extensions
                    const fileName = file.name.toLowerCase();
                    let isValid = false;
                    if (type === 'software') {
                        isValid = fileName.endsWith('.rbz');
                    } else {
                        isValid = fileName.endsWith('.tar.gz') || fileName.endsWith('.gz');
                    }
                    
                    if (!isValid) {
                        alert('‚ùå –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç: ' + allowedExtensions.join(', '));
                        return;
                    }
                    
                    selectedFile = file;
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å ' + (
                        type === 'software' ? '–Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –ü–û' : 
                        type === 'update' ? '–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ' : '–Ω–æ–≤—ã–π –ø—Ä–µ—Ä–µ–ª–∏–∑'
                    );
                    
                    uploadZone.innerHTML = `
                        <div class="upload-icon">‚úÖ</div>
                        <h3>–§–∞–π–ª –≤—ã–±—Ä–∞–Ω</h3>
                        <p><strong>${file.name}</strong></p>
                        <p>${(file.size / (1024*1024)).toFixed(1)} MB</p>
                        <div class="upload-info" style="color: #667eea; cursor: pointer; margin-top: 15px;" 
                             onclick="event.stopPropagation(); resetUploadZone('${type}');">
                             ‚úèÔ∏è –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª
                        </div>
                    `;
                }
                
                window['resetUploadZone' + type] = function() {
                    fileInput.value = '';
                    selectedFile = null;
                    location.reload();
                };
                
                uploadButton.addEventListener('click', () => {
        if (!selectedFile) return;
        
        if (!versionInput.value.trim()) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏');
            return;
        }
        
        uploadButton.disabled = true;
        uploadButton.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
        progressContainer.style.display = 'block';
        
        const formData = new FormData();
        formData.append('action', 'handle_software_upload');
        formData.append('file_type', type);
        formData.append('version_type', currentVersionType);
        formData.append('software_file', selectedFile);
        formData.append('version_number', versionInput.value);
        formData.append('version_notes', versionNotes.value);
        formData.append('nonce', '<?php echo wp_create_nonce("software_upload_nonce"); ?>'); // –í–ê–ñ–ù–û!
        
        // –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ timestamp –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        formData.append('_t', new Date().getTime());
        
        const xhr = new XMLHttpRequest();
        
        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
        xhr.open('POST', '<?php echo admin_url("admin-ajax.php"); ?>');
        
        // –í–∞–∂–Ω–æ: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ withCredentials –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ cookies
        xhr.withCredentials = true;
        
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = Math.round(percentComplete) + '%';
            }
        });
        
        xhr.addEventListener('load', () => {
            console.log('Response status:', xhr.status);
            console.log('Response text:', xhr.responseText);
            
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        progressBar.style.background = '#28a745';
                        progressText.innerHTML = '‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + response.data);
                        location.reload();
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                    alert('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    location.reload();
                }
            } else if (xhr.status === 403) {
                alert('‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                location.reload();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + xhr.status);
                location.reload();
            }
        });
        
        xhr.addEventListener('error', () => {
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
            location.reload();
        });
        
        xhr.send(formData);
    });
            }
            
            // Restore backup functionality
const restoreModal = document.getElementById('restoreModal');
const confirmRestore = document.getElementById('confirmRestore');
const cancelRestore = document.getElementById('cancelRestore');
const restoreModalText = document.getElementById('restoreModalText');
const restoreDescription = document.getElementById('restoreDescription');

if (restoreModal && confirmRestore && cancelRestore) {
    let currentBackupFile = '';
    let currentBackupVersionType = '';
    
    const restoreButtons = document.querySelectorAll('.backup-restore-btn');
    
    restoreButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            currentBackupFile = this.getAttribute('data-filename');
            currentBackupVersionType = this.getAttribute('data-version-type');
            const description = this.getAttribute('data-description');
            const version = this.getAttribute('data-version');
            
            if (restoreModalText) {
                restoreModalText.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –ü–û "${currentBackupFile}"? –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±—ç–∫–∞–ø—ã.`;
            }
            
            if (restoreDescription) {
                let descriptionHTML = '';
                if (version) {
                    descriptionHTML += `<div class="description-label">–í–µ—Ä—Å–∏—è: ${version}</div>`;
                }
                if (description) {
                    descriptionHTML += `<div class="description-label">–û–ø–∏—Å–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏:</div><div class="description-text">${description}</div>`;
                }
                
                if (descriptionHTML) {
                    restoreDescription.innerHTML = descriptionHTML;
                    restoreDescription.style.display = 'block';
                } else {
                    restoreDescription.style.display = 'none';
                }
            }
            
            if (restoreModal) {
                restoreModal.style.display = 'flex';
            }
        });
    });
    
    if (confirmRestore) {
        confirmRestore.addEventListener('click', function() {
            if (!currentBackupFile || !currentBackupVersionType) return;
            
            confirmRestore.disabled = true;
            confirmRestore.textContent = 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            confirmRestore.style.background = '#6c757d';
            
            const formData = new FormData();
            formData.append('action', 'restore_backup');
            formData.append('filename', currentBackupFile);
            formData.append('file_type', 'software');
            formData.append('version_type', currentBackupVersionType);
            formData.append('nonce', '<?php echo wp_create_nonce('restore_backup_nonce'); ?>');
            formData.append('timestamp', new Date().getTime());
            
            fetch(addCacheBuster('<?php echo admin_url('admin-ajax.php'); ?>'), {
                method: 'POST',
                body: formData,
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –í–µ—Ä—Å–∏—è –ü–û —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
                    location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.data);
                    location.reload();
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
                location.reload();
            });
        });
    }
    
    if (cancelRestore) {
        cancelRestore.addEventListener('click', function() {
            if (restoreModal) {
                restoreModal.style.display = 'none';
            }
            currentBackupFile = '';
            currentBackupVersionType = '';
        });
    }
    
    if (restoreModal) {
        restoreModal.addEventListener('click', function(e) {
            if (e.target === restoreModal) {
                restoreModal.style.display = 'none';
                currentBackupFile = '';
                currentBackupVersionType = '';
            }
        });
    }
}

// Restore update functionality
const restoreUpdateModal = document.getElementById('restoreUpdateModal');
const confirmUpdateRestore = document.getElementById('confirmUpdateRestore');
const cancelUpdateRestore = document.getElementById('cancelUpdateRestore');
const restoreUpdateModalText = document.getElementById('restoreUpdateModalText');
const restoreUpdateDescription = document.getElementById('restoreUpdateDescription');

if (restoreUpdateModal && confirmUpdateRestore && cancelUpdateRestore) {
    let currentUpdateFile = '';
    let currentUpdateVersionType = '';
    
    const updateRestoreButtons = document.querySelectorAll('.update-restore-btn');
    
    updateRestoreButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            currentUpdateFile = this.getAttribute('data-filename');
            currentUpdateVersionType = this.getAttribute('data-version-type');
            const description = this.getAttribute('data-description');
            const version = this.getAttribute('data-version');
            
            if (restoreUpdateModalText) {
                restoreUpdateModalText.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ "${currentUpdateFile}"? –¢–µ–∫—É—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±—ç–∫–∞–ø—ã.`;
            }
            
            if (restoreUpdateDescription) {
                let descriptionHTML = '';
                if (version) {
                    descriptionHTML += `<div class="description-label">–í–µ—Ä—Å–∏—è: ${version}</div>`;
                }
                if (description) {
                    descriptionHTML += `<div class="description-label">–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</div><div class="description-text">${description}</div>`;
                }
                
                if (descriptionHTML) {
                    restoreUpdateDescription.innerHTML = descriptionHTML;
                    restoreUpdateDescription.style.display = 'block';
                } else {
                    restoreUpdateDescription.style.display = 'none';
                }
            }
            
            if (restoreUpdateModal) {
                restoreUpdateModal.style.display = 'flex';
            }
        });
    });
    
    if (confirmUpdateRestore) {
        confirmUpdateRestore.addEventListener('click', function() {
            if (!currentUpdateFile || !currentUpdateVersionType) return;
            
            confirmUpdateRestore.disabled = true;
            confirmUpdateRestore.textContent = 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            confirmUpdateRestore.style.background = '#6c757d';
            
            const formData = new FormData();
            formData.append('action', 'restore_update');
            formData.append('filename', currentUpdateFile);
            formData.append('version_type', currentUpdateVersionType);
            formData.append('nonce', '<?php echo wp_create_nonce('restore_update_nonce'); ?>');
            formData.append('timestamp', new Date().getTime());
            
            fetch(addCacheBuster('<?php echo admin_url('admin-ajax.php'); ?>'), {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                    location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.data);
                    location.reload();
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
                location.reload();
            });
        });
    }
    
    if (cancelUpdateRestore) {
        cancelUpdateRestore.addEventListener('click', function() {
            if (restoreUpdateModal) {
                restoreUpdateModal.style.display = 'none';
            }
            currentUpdateFile = '';
            currentUpdateVersionType = '';
        });
    }
    
    if (restoreUpdateModal) {
        restoreUpdateModal.addEventListener('click', function(e) {
            if (e.target === restoreUpdateModal) {
                restoreUpdateModal.style.display = 'none';
                currentUpdateFile = '';
                currentUpdateVersionType = '';
            }
        });
    }
}

// Promote prerelease functionality
const promoteButtons = document.querySelectorAll('.promote-prerelease-btn');

if (promoteButtons.length > 0) {
    promoteButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const filename = this.getAttribute('data-filename');
            const version = this.getAttribute('data-version');
            const versionType = this.getAttribute('data-version-type');
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø—É—Å—Ç–∏—Ç—å –ø—Ä–µ—Ä–µ–ª–∏–∑ ${version} –≤ –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø? –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.`)) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ –í—ã–ø—É—Å–∫...';
            
            const formData = new FormData();
            formData.append('action', 'promote_prerelease');
            formData.append('filename', filename);
            formData.append('version', version);
            formData.append('version_type', versionType);
            formData.append('nonce', '<?php echo wp_create_nonce('promote_prerelease_nonce'); ?>');
            formData.append('timestamp', new Date().getTime());
            
            fetch(addCacheBuster('<?php echo admin_url('admin-ajax.php'); ?>'), {
                method: 'POST',
                body: formData,
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –ü—Ä–µ—Ä–µ–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø—É—â–µ–Ω –≤ –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.data);
                }
                location.reload();
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
                location.reload();
            });
        });
    });
}

// Delete prerelease functionality
const deleteButtons = document.querySelectorAll('.delete-prerelease-btn');

if (deleteButtons.length > 0) {
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const filename = this.getAttribute('data-filename');
            const versionType = this.getAttribute('data-version-type');
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ—Ä–µ–ª–∏–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ –£–¥–∞–ª–µ–Ω–∏–µ...';
            
            const formData = new FormData();
            formData.append('action', 'delete_prerelease');
            formData.append('filename', filename);
            formData.append('version_type', versionType);
            formData.append('nonce', '<?php echo wp_create_nonce('delete_prerelease_nonce'); ?>');
            formData.append('timestamp', new Date().getTime());
            
            fetch(addCacheBuster('<?php echo admin_url('admin-ajax.php'); ?>'), {
                method: 'POST',
                body: formData,
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –ü—Ä–µ—Ä–µ–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.data);
                }
                location.reload();
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
                location.reload();
            });
        });
    });
}

// Copy link functionality
const copyButtons = document.querySelectorAll('.copy-link-btn');

if (copyButtons.length > 0) {
    copyButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            
            if (!input) return;
            
            input.select();
            input.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(input.value).then(() => {
                const originalText = this.textContent;
                this.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err);
            });
        });
    });
}

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞
        function softwareRefreshCache() {
            const btn = document.querySelector('.refresh-cache-btn');
            if (!btn) return;
            
            const originalText = btn.innerHTML;
            const currentVersionType = document.getElementById('currentVersionType') ? 
                                      document.getElementById('currentVersionType').value : 'interior';
            
            btn.innerHTML = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            btn.disabled = true;
            
            const formData = new FormData();
            formData.append('action', 'software_refresh_cache');
            formData.append('version_type', currentVersionType);
            formData.append('nonce', '<?php echo wp_create_nonce("software_refresh_cache"); ?>');
            formData.append('timestamp', new Date().getTime());
            
            fetch('<?php echo admin_url("admin-ajax.php"); ?>?_=' + new Date().getTime(), {
                method: 'POST',
                body: formData,
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + data.data);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Cache refresh error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
        window.softwareRefreshCache = softwareRefreshCache;
    });
    </script>
    <?php
}

    public function handle_restore_backup() {
        $this->send_no_cache_headers();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)
        if (!$this->check_ajax_auth()) {
            wp_send_json_error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 403);
        }
        
        if (!wp_verify_nonce($_POST['nonce'], 'restore_backup_nonce')) {
            wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
        }
        
        if (empty($_POST['filename']) || empty($_POST['version_type'])) {
            wp_send_json_error('–§–∞–π–ª –∏–ª–∏ —Ç–∏–ø –≤–µ—Ä—Å–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω');
        }
        
        $filename = sanitize_file_name($_POST['filename']);
        $version_type = sanitize_text_field($_POST['version_type']);
        $file_type = sanitize_text_field($_POST['file_type'] ?? 'software');
        
        if ($version_type === 'interior') {
            $backup_dir = $this->backup_dir_interior;
        } elseif ($version_type === 'furniture') {
            $backup_dir = $this->backup_dir_furniture;
        } elseif ($version_type === 'trial') {
            $backup_dir = $this->backup_dir_trial;
        } else {
            wp_send_json_error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –≤–µ—Ä—Å–∏–∏');
        }
        $backup_path = $backup_dir . '/' . $filename;
        
        if (!file_exists($backup_path) || 
            ($file_type === 'software' && strpos($filename, 'software-') !== 0) ||
            ($file_type === 'update' && strpos($filename, 'update-') !== 0)) {
            wp_send_json_error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        
        if ($file_type === 'software') {
            $backup_description = $this->get_backup_description($version_type, $filename);
            $backup_version = $this->get_backup_version($version_type, $filename);
            
            $this->create_backup('software', $version_type);
            
            $current_dir = $this->get_current_dir($version_type);
            $current_file_path = $current_dir . '/software.rbz';
            
            if (copy($backup_path, $current_file_path)) {
                // –û—á–∏—â–∞–µ–º –∫–µ—à –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                $this->clear_cache($version_type);
                
                $version_info = $this->get_version_info($version_type);
                $version_info['filename'] = 'software.rbz';
                $version_info['size'] = filesize($current_file_path);
                $version_info['upload_time'] = time();
                $version_info['version_notes'] = !empty($backup_description) ? 
                    '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –±—ç–∫–∞–ø–∞: ' . $filename . '. ' . $backup_description : 
                    '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –±—ç–∫–∞–ø–∞: ' . $filename;
                $version_info['version_number'] = $backup_version;
                update_option('software_current_version_' . $version_type, $version_info);
                
                // Send API notification
                if ($backup_version) {
                    $api_resource = $version_type === 'interior' ? 'plugin' : 'plugin_furniture';
                    $this->send_version_notification($api_resource, $backup_version);
                }
                
                wp_send_json_success('–í–µ—Ä—Å–∏—è –ü–û —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            } else {
                wp_send_json_error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            }
        }
    }
    
    public function handle_restore_update() {
        $this->send_no_cache_headers();
        
         // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)
        if (!$this->check_ajax_auth()) {
            wp_send_json_error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 403);
        }
        
        if (!wp_verify_nonce($_POST['nonce'], 'restore_update_nonce')) {
            wp_send_json_error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
        }
        
        if (empty($_POST['filename']) || empty($_POST['version_type'])) {
            wp_send_json_error('–§–∞–π–ª –∏–ª–∏ —Ç–∏–ø –≤–µ—Ä—Å–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω');
        }
        
        $filename = sanitize_file_name($_POST['filename']);
        $version_type = sanitize_text_field($_POST['version_type']);
        
        if ($version_type === 'interior') {
            $backup_dir = $this->backup_dir_interior;
        } elseif ($version_type === 'furniture') {
            $backup_dir = $this->backup_dir_furniture;
        } elseif ($version_type === 'trial') {
            $backup_dir = $this->backup_dir_trial;
        } else {
            wp_send_json_error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –≤–µ—Ä—Å–∏–∏');
        }
        $backup_path = $backup_dir . '/' . $filename;
        
        if (!file_exists($backup_path) || strpos($filename, 'update-') !== 0) {
            wp_send_json_error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        
        $backup_description = $this->get_update_description($version_type, $filename);
        $backup_version = $this->get_update_version($version_type, $filename);
        
        // –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        $this->create_backup('update', $version_type);
        
        $update_dir = $this->get_update_dir($version_type);
        $current_file_path = $update_dir . '/artrocket.tar.gz';
        
        if (copy($backup_path, $current_file_path)) {
            // –û—á–∏—â–∞–µ–º –∫–µ—à –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            $this->clear_cache($version_type);
            
            $update_info = $this->get_update_info($version_type);
            $update_info['filename'] = 'artrocket.tar.gz';
            $update_info['size'] = filesize($current_file_path);
            $update_info['upload_time'] = time();
            $update_info['version_notes'] = !empty($backup_description) ? 
                '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –±—ç–∫–∞–ø–∞: ' . $filename . '. ' . $backup_description : 
                '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –±—ç–∫–∞–ø–∞: ' . $filename;
            $update_info['version_number'] = $backup_version;
            update_option('software_current_update_' . $version_type, $update_info);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º version API –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
            if ($backup_version) {
                $api_resource = $version_type === 'interior' ? 'plugin_update' : 'plugin_update_furniture';
                $this->send_version_notification($api_resource, $backup_version);
            }
            
            wp_send_json_success('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        } else {
            wp_send_json_error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
        }
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ AJAX
    private function check_ajax_auth() {
        return $this->is_authenticated_request();
   }

    
    public function handle_download_backup() {
        $this->send_no_cache_headers();
        
        $filename = sanitize_file_name($_GET['file']);
        $version_type = sanitize_text_field($_GET['version_type']);
        
        if (!wp_verify_nonce($_GET['_wpnonce'], 'download_backup_' . $filename)) {
            wp_die('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (!$this->check_ajax_auth()) {
            wp_die('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
        }
        
        $backup_dir = $version_type === 'interior' ? $this->backup_dir_interior : $this->backup_dir_furniture;
        $backup_path = $backup_dir . '/' . $filename;
        
        if (!file_exists($backup_path) || 
            (strpos($filename, 'software-') !== 0 && strpos($filename, 'update-') !== 0)) {
            wp_die('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . $filename . '"');
        header('Content-Length: ' . filesize($backup_path));
        header('Cache-Control: no-cache, no-store, must-revalidate');
        header('Pragma: no-cache');
        header('Expires: 0');
        readfile($backup_path);
        exit;
    }
    
    public function handle_download_update() {
        $this->send_no_cache_headers();
        
        $filename = sanitize_file_name($_GET['file']);
        $version_type = sanitize_text_field($_GET['version_type']);
        
        if (!wp_verify_nonce($_GET['_wpnonce'], 'download_update_' . $filename)) {
            wp_die('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (!$this->check_ajax_auth()) {
            wp_die('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
        }
        
        $backup_dir = $version_type === 'interior' ? $this->backup_dir_interior : $this->backup_dir_furniture;
        $update_path = $backup_dir . '/' . $filename;
        
        if (!file_exists($update_path) || strpos($filename, 'update-') !== 0) {
            wp_die('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . $filename . '"');
        header('Content-Length: ' . filesize($update_path));
        header('Cache-Control: no-cache, no-store, must-revalidate');
        header('Pragma: no-cache');
        header('Expires: 0');
        readfile($update_path);
        exit;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
new SoftwareReleaseManagerPro();

/* ==========   SOFTWARE RELEASES END ========== */








function translate_woocommerce_menu_items_v2($block_content, $block) {
if ($block['blockName'] === 'core/navigation') {
// –ï—Å–ª–∏ –≤ –±–ª–æ–∫–µ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ /my-account/, —Ç–æ –¥–µ–ª–∞–µ–º –∑–∞–º–µ–Ω—ã
if (strpos($block_content, '/my-account/') !== false) {
$replacements = array(
'–ö–æ—Ä–∑–∏–Ω–∞' => 'Co»ô',
'–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç' => 'Contul Meu',
'–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞' => 'Finalizare comandƒÉ',
'/my-account/' => '/cont/'
);
$block_content = str_replace(array_keys($replacements), array_values($replacements), $block_content);
}
}
return $block_content;
}
add_filter('render_block', 'translate_woocommerce_menu_items_v2', 10, 2);










// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∑–∞–∫–∞–∑—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –ø–æ 0 ‚Ç¨
// –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ —Å –ù–£–õ–Å–í–´–ú –∏—Ç–æ–≥–æ–º (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å Blocks)
/**
 * Autocomplete for FREE (0.00‚Ç¨) orders ‚Äî classic + Blocks
 * - –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ª—é–±–æ–º —Å–ø–æ—Å–æ–±–µ –æ–ø–ª–∞—Ç—ã –∏ —Å –∫—É–ø–æ–Ω–∞–º–∏ (—Å–º–æ—Ç—Ä–∏–º get_total()).
 * - –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç thankyou –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤.
 */

function ar_maybe_autocomplete_free_order($order_id){
    $order = wc_get_order($order_id);
    if ( ! $order ) return;

    // –¢–æ–ª—å–∫–æ –¥–ª—è –Ω—É–ª–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    if ( (float) $order->get_total() > 0 ) return;

    // –ï—Å–ª–∏ —É–∂–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å ‚Äî –≤—ã—Ö–æ–¥–∏–º
    if ( $order->has_status( ['completed','cancelled','refunded','failed'] ) ) return;

    // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ "–æ–ø–ª–∞—á–µ–Ω–æ" (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–ª–∞–≥–∏–Ω—ã –∂–¥—É—Ç —ç—Ç–æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä)
    if ( ! $order->is_paid() ) {
        // –≤—ã–∑–æ–≤–µ—Ç reduce stock –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã –æ–ø–ª–∞—Ç—ã
        $order->payment_complete(); 
    }

    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º completed
    if ( ! $order->has_status('completed') ) {
        $order->update_status('completed', '‚úÖ Automat: comandƒÉ 0‚Ç¨ ‚Äî Finalizat.', true);
    }
}

/* --- –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (–ø–æ–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏) --- */

// –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–ª–æ—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
add_action('woocommerce_checkout_order_processed', function($order_id){ 
    ar_maybe_autocomplete_free_order($order_id);
}, 20);

// Blocks (Store API) –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞
add_action('woocommerce_store_api_checkout_order_processed', function($order){ 
    if ( $order instanceof WC_Order ) {
        ar_maybe_autocomplete_free_order($order->get_id());
    }
}, 20);

// –ö–æ–≥–¥–∞ —à–ª—é–∑ –ø–æ–º–µ—á–∞–µ—Ç ¬´–æ–ø–ª–∞—á–µ–Ω–æ¬ª
add_action('woocommerce_payment_complete', function($order_id){
    ar_maybe_autocomplete_free_order($order_id);
}, 20);

// –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ –Ω–∞ —Å–º–µ–Ω—É —Å—Ç–∞—Ç—É—Å–∞
add_action('woocommerce_order_status_pending_to_processing', function($order_id){
    ar_maybe_autocomplete_free_order($order_id);
}, 20);
add_action('woocommerce_order_status_on-hold_to_processing', function($order_id){
    ar_maybe_autocomplete_free_order($order_id);
}, 20);

// –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–µ—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ –ø–ª–∞–≥–∏–Ω –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª —Å—Ç–∞—Ç—É—Å –ø–æ–∑–∂–µ)
add_action('woocommerce_checkout_order_processed', function($order_id){
    if ( ! wp_next_scheduled('ar_autocomplete_free_delayed', [$order_id]) ) {
        wp_schedule_single_event(time()+10, 'ar_autocomplete_free_delayed', [$order_id]);
    }
}, 30);
add_action('ar_autocomplete_free_delayed', function($order_id){
    ar_maybe_autocomplete_free_order($order_id);
});

// –¢–æ–≤–∞—Ä 2385 –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º
add_action('woocommerce_add_to_cart_validation', function($passed, $product_id, $quantity) {

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à —Ç–æ–≤–∞—Ä
    if ($product_id != 2385) {
        return $passed;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º
    if (!is_user_logged_in()) {
        wc_add_notice(
    __('Trebuie sƒÉ fii autentificat pentru a activa licen»õe. ', 'woocommerce') . 
    '<a href="https://art-rocket.ru/my-account">AutentificƒÉ-te aici</a>',
    'error'
);

        return false;
    }

    $user_id = get_current_user_id();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $orders = wc_get_orders([
        'customer_id' => $user_id,
        'status'      => ['completed', 'processing'],
        'limit'       => -1,
    ]);

    foreach ($orders as $order) {
        foreach ($order->get_items() as $item) {
            if ($item->get_product_id() == 2385) {
                wc_add_notice(__('Ai activat deja licen»õa Trial. Po»õi beneficia de ea o singurƒÉ datƒÉ.', 'woocommerce'), 'error');
                return false;
            }
        }
    }

    return $passed;
}, 10, 3);

// –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–æ–∫—É–ø–∫—É –ª—é–±—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ–∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
add_action('woocommerce_add_to_cart_validation', function($passed, $product_id, $quantity) {
    if (!is_user_logged_in()) {
        wc_add_notice(
    __('Trebuie sƒÉ fii autentificat pentru a activa licen»õe. ', 'woocommerce') . 
    '<a href="https://art-rocket.ru/my-account">AutentificƒÉ-te aici</a>',
    'error'
);

        return false;
    }
    return $passed;
}, 10, 3);


// –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º –≤—ã–≤–æ–¥ –∫–Ω–æ–ø–∫–∏ wishlist
add_action('init', function() {
    remove_shortcode('yith_wcwl_add_to_wishlist');
});


// // –ó–∞–º–µ–Ω—è–µ–º HTML —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–Ω–æ–ø–∫–∏ NSL (Google)
// add_filter('nsl_render_button', function ($html, $provider) {
//     if ($provider === 'google') {
//         // URL –¥–ª—è –ª–æ–≥–∏–Ω–∞ —á–µ—Ä–µ–∑ Google
//         $redirect = home_url('/my-account/'); // –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
//         $login_url = wp_login_url() . '?loginSocial=google&redirect=' . urlencode($redirect);

//         // –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π HTML –∫–Ω–æ–ø–∫–∏
//         $html = '<a href="' . esc_url($login_url) . '" class="ar-mobile-menu-btn">Ob»õine Access</a>';
//     }
//     return $html;
// }, 10, 2);
// –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–æ—Ä—Ç–∫–æ–¥ NSL
remove_shortcode('account_or_google');

// –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π —à–æ—Ä—Ç–∫–æ–¥
add_shortcode('account_or_google', function () {
    if (is_user_logged_in()) {
        $user = wp_get_current_user();
        // –ò–º—è ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç first_name, –±–µ—Ä—ë–º display_name –∏–ª–∏ –ª–æ–≥–∏–Ω
        $name = $user->first_name ?: $user->display_name ?: $user->user_login;
        $account_url = wc_get_page_permalink('myaccount');

        return '<a href="' . esc_url($account_url) . '" class="ar-mobile-menu-btn custom-google-btn">–ü—Ä–∏–≤–µ—Ç, ' . esc_html($name) . ' ‚Äì –í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç</a>';
    } else {
        $redirect  = wc_get_page_permalink('myaccount');
        $login_url = wp_login_url() . '?loginSocial=google&redirect=' . urlencode($redirect);

        return '<a href="' . esc_url($login_url) . '" class="ar-mobile-menu-btn custom-google-btn" rel="nofollow">–ü–æ–ª—É—á–∏—Ç–µ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –î–æ—Å—Ç—É–ø</a>';
    }
});

// –û—Ç–∫–ª—é—á–∞–µ–º —à—Ç–∞—Ç–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä NSL-–∫–Ω–æ–ø–æ–∫
add_filter('nsl_render_button', '__return_empty_string');




// –ö–Ω–æ–ø–∫–∞ "Ob»õine acces gratuit" —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
add_shortcode('hero_access_button', function () {
    if (is_user_logged_in()) {
        return '<a href="https://art-rocket.ru/shop/trial-license" class="hero-button">–ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø</a>';
    }
    return ''; // –≥–æ—Å—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–∏–¥—è—Ç
});


add_action('woocommerce_after_cart', function() {
    if (WC()->cart->is_empty()) return;

    echo '<div class="my-account-products">';
    echo '<ul class="products">';

    foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
        $product = $cart_item['data'];
        if (!$product || !$product->exists()) continue;

        $link = get_permalink($product->get_id());
        $img  = $product->get_image('woocommerce_thumbnail');
        $name = $product->get_name();
        $price = $product->get_price_html();

        echo '<li class="product">';
        echo '<a href="' . esc_url($link) . '">' . $img . '<h3>' . esc_html($name) . '</h3><span class="price">' . $price . '</span></a>';
        echo '<a href="' . esc_url(wc_get_cart_remove_url($cart_item_key)) . '" class="button">»òterge</a>';
        echo '</li>';
    }

    echo '</ul></div>';
});


add_action('wp', function () {
    if (function_exists('is_cart') && is_cart()) {
        if (WC()->cart && WC()->cart->is_empty()) {
            wp_safe_redirect(get_permalink(wc_get_page_id('shop')));
            exit;
        }
    }
});



/**
 * Plugin Name: ArtRocket ‚Äî Bitrix Sync (Clean)
 * Description: –ü–µ—Ä–µ–¥–∞—á–∞ –∑–∞–∫–∞–∑–æ–≤ WooCommerce –≤ Bitrix –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π.
 * Author: You
 * Version: 1.0.1
 */

if ( ! defined('ABSPATH') ) exit;

/** ====================== –ù–ê–°–¢–†–û–ô–ö–ò –ë–ò–¢–†–ò–ö–° ====================== */
const AR_BITRIX_CONTACT_LIST  = 'https://www.bitrix.amatto.md/rest/2333/fs5np1d4j2jxkpy2/crm.contact.list.json';
const AR_BITRIX_CONTACT_ADD   = 'https://www.bitrix.amatto.md/rest/2333/qsnmi9n9llud72p2/crm.contact.add.json';
const AR_BITRIX_DEAL_LIST     = 'https://www.bitrix.amatto.md/rest/2333/e6bp6lqmxlz0yff3/crm.deal.list.json';
const AR_BITRIX_DEAL_ADD      = 'https://www.bitrix.amatto.md/rest/2333/orejz9p3v863t69k/crm.deal.add.json';
const AR_BITRIX_DEAL_UPDATE   = 'https://www.bitrix.amatto.md/rest/2333/hlrg81trhamt37ez/crm.deal.update.json';

const AR_BITRIX_CATEGORY_ID   = 33;  // –í–æ—Ä–æ–Ω–∫–∞
const AR_BITRIX_ASSIGNED_ID   = 24;  // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
const AR_BITRIX_HTTP_TIMEOUT  = 7;   // –¢–∞–π–º–∞—É—Ç HTTP, —Å–µ–∫

// UF-–ø–æ–ª–µ —Å–æ —Å–≤–æ–¥–Ω—ã–º JSON (–æ–±–Ω–æ–≤–∏ –Ω–∞ —Å–≤–æ–π –∫–æ–¥ UF):
const AR_BITRIX_UF_ALLDATA    = 'UF_CRM_1756996060195';

/** product_id => STAGE_ID */
global $AR_PRODUCT_STAGE_MAP;
$AR_PRODUCT_STAGE_MAP = [
	2385 => 'C33:UC_0VRFAU', // Trial
	1634 => 'C33:UC_0YPYB3', // Business
	1633 => 'C33:UC_7FISFL', // Pro
	1629 => 'C33:UC_CPWJ28', // Start
];
const AR_BITRIX_FALLBACK_STAGE = 'C33:NEW';




/** ====================== –ù–ê–°–¢–†–û–ô–ö–ò –ù–ê–ó–í–ê–ù–ò–ô –°–î–ï–õ–û–ö ====================== */
global $AR_PRODUCT_DEAL_TITLE_MAP;
$AR_PRODUCT_DEAL_TITLE_MAP = [
	2385 => 'Trial License',              // Trial
	1634 => 'Start License 1 LunƒÉ',       // Business (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é)
	1633 => 'Pro License 6 Luni',         // Pro
	1629 => 'Business License 12 Luni',   // Start (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é)
];









/** ====================== –•–µ–ª–ø–µ—Ä: –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ ====================== */
function ar_pick_deal_title_for_order( WC_Order $order ) : string {
	global $AR_PRODUCT_DEAL_TITLE_MAP;
	
	// –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –∑–∞–∫–∞–∑–∞
	$product_titles = [];
	
	foreach ( $order->get_items() as $item ) {
		/** @var WC_Order_Item_Product $item */
		$product_id = (int) $item->get_product_id();
		$quantity = (int) $item->get_quantity();
		
		if ( isset( $AR_PRODUCT_DEAL_TITLE_MAP[ $product_id ] ) ) {
			$product_titles[] = $AR_PRODUCT_DEAL_TITLE_MAP[ $product_id ] . " √ó " . $quantity;
		} else {
			// Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
			$product_titles[] = $item->get_name() . " √ó " . $quantity;
		}
	}
	
	if ( empty( $product_titles ) ) {
		return 'ComandƒÉ WooCommerce #' . $order->get_order_number();
	}
	
	// –ï—Å–ª–∏ –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
	if ( count( $product_titles ) === 1 ) {
		return $product_titles[0];
	}
	
	// –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ - –æ–±—ä–µ–¥–∏–Ω—è–µ–º —á–µ—Ä–µ–∑ " + "
	return implode( ' + ', $product_titles );
}





/** ====================== Bitrix: HTTP ====================== */
function ar_bitrix_post( string $url, array $body ) {
	$args = [
		'headers' => [ 'Content-Type' => 'application/json; charset=utf-8' ],
		'body'    => wp_json_encode( $body ),
		'timeout' => AR_BITRIX_HTTP_TIMEOUT,
	];
	$res = wp_remote_post( $url, $args );
	if ( is_wp_error( $res ) ) return $res;
	$code = wp_remote_retrieve_response_code( $res );
	$body = json_decode( wp_remote_retrieve_body( $res ), true );
	if ( $code !== 200 ) return new WP_Error( 'bitrix_http', 'HTTP '.$code, $body );
	return $body;
}

/** ====================== –•–µ–ª–ø–µ—Ä—ã: —Å—Ç–∞–¥–∏—è –∏ —Ç–µ–∫—Å—Ç ====================== */
function ar_pick_stage_for_order( WC_Order $order ) : string {
	global $AR_PRODUCT_STAGE_MAP;
	$stage = AR_BITRIX_FALLBACK_STAGE;

	foreach ( $order->get_items() as $item ) {
		/** @var WC_Order_Item_Product $item */
		$product_id = (int) $item->get_product_id();
		if ( isset( $AR_PRODUCT_STAGE_MAP[ $product_id ] ) ) {
			return $AR_PRODUCT_STAGE_MAP[ $product_id ];
		}
		$name = mb_strtolower( $item->get_name() );
		if ( strpos( $name, 'trial' ) !== false )    return 'C33:UC_0VRFAU';
		if ( strpos( $name, 'business' ) !== false ) return 'C33:UC_0YPYB3';
		if ( strpos( $name, 'pro' ) !== false )      return 'C33:UC_7FISFL';
		if ( strpos( $name, 'start' ) !== false )    return 'C33:UC_CPWJ28';
	}
	return $stage;
}

function ar_build_plain_text_from_order( WC_Order $order ) : string {
	$total    = (float) $order->get_total();
	$currency = $order->get_currency();
	$symbol   = get_woocommerce_currency_symbol( $currency );
	$decimals = wc_get_price_decimals();
	$thou_sep = wc_get_price_thousand_separator();
	$dec_sep  = wc_get_price_decimal_separator();
	$total_str = $symbol . ' ' . number_format( $total, $decimals, $dec_sep, $thou_sep );

	$lines   = [];
	$lines[] = 'Order: #' . $order->get_order_number();
	$lines[] = 'Total: ' . $total_str;
	$lines[] = 'Nume: ' . trim( $order->get_billing_first_name() . ' ' . $order->get_billing_last_name() );
	$lines[] = 'Email: ' . $order->get_billing_email();
	$lines[] = 'Telefon: ' . $order->get_billing_phone();

	$item_str = [];
	foreach ( $order->get_items() as $item ) {
		$item_str[] = $item->get_name() . ' √ó ' . $item->get_quantity();
	}
	if ( $item_str ) $lines[] = 'Items: ' . implode(', ', $item_str);

	return implode(' | ', array_filter( $lines ) );
}

/** ====================== –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞ –≤ Bitrix ====================== */
function ar_bitrix_find_or_create_contact( $name, $last_name, $phone, $email, $company ) {
	$filter = [];
	if ( $phone ) $filter['PHONE'] = $phone;
	if ( $email ) $filter['EMAIL'] = $email;

	$list = ar_bitrix_post( AR_BITRIX_CONTACT_LIST, [ 'filter' => $filter, 'select' => [ 'ID' ], 'start' => 0 ] );
	if ( is_wp_error( $list ) ) return $list;
	if ( ! empty( $list['result'][0]['ID'] ) ) return (int) $list['result'][0]['ID'];

	$fields = [
		'NAME'              => $name ?: '',
		'LAST_NAME'         => $last_name ?: '',
		'COMPANY_TITLE'     => $company ?: '',
		'PHONE'             => $phone ? [ [ 'VALUE' => $phone, 'VALUE_TYPE' => 'WORK' ] ] : [],
		'EMAIL'             => $email ? [ [ 'VALUE' => $email, 'VALUE_TYPE' => 'WORK' ] ] : [],
		'SOURCE_DESCRIPTION'=> 'WooCommerce checkout',
	];
	$add = ar_bitrix_post( AR_BITRIX_CONTACT_ADD, [ 'fields' => $fields, 'params' => [ 'REGISTER_SONET_EVENT' => 'Y' ] ] );
	if ( is_wp_error( $add ) ) return $add;
	if ( ! empty( $add['result'] ) ) return (int) $add['result'];
	return new WP_Error( 'bitrix_contact', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç', $add );
}

function ar_bitrix_find_deal_id( int $contact_id ) {
	$list = ar_bitrix_post( AR_BITRIX_DEAL_LIST, [
		'filter' => [ 'CONTACT_ID' => $contact_id, 'CATEGORY_ID' => AR_BITRIX_CATEGORY_ID ],
		'select' => [ 'ID' ],
		'start'  => 0,
	] );
	if ( is_wp_error( $list ) ) return $list;
	return ! empty( $list['result'][0]['ID'] ) ? (int) $list['result'][0]['ID'] : 0;
}

function ar_bitrix_update_deal( int $deal_id, array $fields ) {
	return ar_bitrix_post( AR_BITRIX_DEAL_UPDATE, [
		'id'     => $deal_id,
		'fields' => $fields,
		'params' => [ 'REGISTER_SONET_EVENT' => 'Y' ],
	] );
}

function ar_bitrix_create_deal( int $contact_id, array $fields ) {
	return ar_bitrix_post( AR_BITRIX_DEAL_ADD, [
		'fields' => array_merge( [
			'CONTACT_ID'     => $contact_id,
			'CATEGORY_ID'    => AR_BITRIX_CATEGORY_ID,
			'ASSIGNED_BY_ID' => AR_BITRIX_ASSIGNED_ID,
		], $fields ),
		'params' => [ 'REGISTER_SONET_EVENT' => 'Y' ],
	] );
}

/** ====================== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ====================== */
function ar_sync_order_to_bitrix( WC_Order $order ) {
	if ( ! $order instanceof WC_Order ) return;
	if ( $order->get_meta('_ar_bitrix_synced') ) return;

	$name      = $order->get_billing_first_name();
	$last_name = $order->get_billing_last_name();
	$email     = $order->get_billing_email();
	$phone     = $order->get_billing_phone();
	$company   = $order->get_billing_company();

	$stage_id  = ar_pick_stage_for_order( $order );
	$title     = ar_pick_deal_title_for_order( $order ); // ‚Üê –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨

	$plain     = ar_build_plain_text_from_order( $order );

	// –∫–æ–Ω—Ç–∞–∫—Ç
	$contact_id = ar_bitrix_find_or_create_contact( $name, $last_name, $phone, $email, $company );
	if ( is_wp_error( $contact_id ) ) { 
		error_log( 'Bitrix contact error: '.$contact_id->get_error_message() ); 
		return; 
	}

	// –ø–æ–ª—è —Å–¥–µ–ª–∫–∏
	$deal_fields = [
		'TITLE'    => $title, // ‚Üê –¢–µ–ø–µ—Ä—å –∑–¥–µ—Å—å –∫—Ä–∞—Å–∏–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
		'STAGE_ID' => $stage_id,
		'COMMENTS' => $plain,
	];

	// UF JSON (–æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
	if ( AR_BITRIX_UF_ALLDATA ) {
		$items = [];
		foreach ( $order->get_items() as $item ) {
			/** @var WC_Order_Item_Product $item */
			$items[] = [
				'name'       => $item->get_name(),
				'quantity'   => (int) $item->get_quantity(),
				'product_id' => (int) $item->get_product_id(),
			];
		}
		$uf_payload = [
			'order' => [
				'id'           => (int) $order->get_id(),
				'number'       => (string) $order->get_order_number(),
				'total_value'  => (float) $order->get_total(),
				'currency'     => (string) $order->get_currency(),
			],
			'customer' => [
				'first_name' => (string) $order->get_billing_first_name(),
				'last_name'  => (string) $order->get_billing_last_name(),
				'email'      => (string) $order->get_billing_email(),
				'phone'      => (string) $order->get_billing_phone(),
				'company'    => (string) $order->get_billing_company(),
			],
			'items' => $items,
		];
		$deal_fields[ AR_BITRIX_UF_ALLDATA ] = wp_json_encode( $uf_payload, JSON_UNESCAPED_UNICODE );
	}

	// —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å–¥–µ–ª–∫—É
	$deal_id = ar_bitrix_find_deal_id( (int) $contact_id );
	if ( is_wp_error( $deal_id ) ) { 
		error_log( 'Bitrix deal list error: '.$deal_id->get_error_message() ); 
		return; 
	}

	if ( $deal_id ) {
		// –£–±–∏—Ä–∞–µ–º "(update)" –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
		$upd = ar_bitrix_update_deal( $deal_id, $deal_fields );
		if ( is_wp_error( $upd ) ) {
			error_log( 'Bitrix deal update error: '.$upd->get_error_message() );
		} else {
			$order->update_meta_data('_ar_bitrix_synced', time());
			$order->save();
		}
	} else {
		$create = ar_bitrix_create_deal( (int) $contact_id, $deal_fields );
		if ( is_wp_error( $create ) ) {
			error_log( 'Bitrix deal create error: ' . $create->get_error_message() );
		} elseif ( ! empty( $create['result'] ) ) {
			$order->update_meta_data('_ar_bitrix_synced', time());
			$order->save();
		}
	}
}

/** –¢–æ—á–∫–∏ –∑–∞–ø—É—Å–∫–∞ —Å–∏–Ω–∫–∞ */
add_action( 'woocommerce_store_api_checkout_order_processed', function( $order ) {
	if ( $order instanceof WC_Order ) ar_sync_order_to_bitrix( $order );
}, 999, 1 );

add_action( 'woocommerce_checkout_order_processed', function( $order_id ) {
	$order = wc_get_order( $order_id );
	if ( $order ) ar_sync_order_to_bitrix( $order );
}, 20, 1 );

add_action( 'woocommerce_thankyou', function( $order_id ) {
	$order = wc_get_order( $order_id );
	if ( $order ) ar_sync_order_to_bitrix( $order );
}, 20, 1 );


/** ====================== –ù–ê–°–¢–†–û–ô–ö–ò –ë–ò–¢–†–ò–ö–° END ====================== */



















/**
 * My Account: —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google (—Å–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—ã WC)
 * URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º ?classic=1 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏).
 */
add_action('wp', function () {
	if (
		function_exists('is_account_page') &&
		is_account_page() &&
		! is_user_logged_in() &&
		empty($_GET['classic'])
	) {
		// 1) –†–µ–Ω–¥–µ—Ä–∏–º –Ω–∞—à –±–ª–æ–∫ –ü–ï–†–ï–î —Ñ–æ—Ä–º–∞–º–∏ (–∏ –ø–æ—Ç–æ–º –∏—Ö —É–±—å—ë–º CSS/JS)
		add_action('woocommerce_before_customer_login_form', 'ar_myaccount_google_block', 1);

		// 2) –ü–æ–¥–∫–ª—é—á–∞–µ–º CSS/JS, –∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä—ã–≤–∞—é—Ç —Ñ–æ—Ä–º—ã –∏ —á–∏—Å—Ç—è—Ç DOM
		add_action('wp_enqueue_scripts', function () {
			$css = <<<CSS
/* ---- –ü—Ä—è—á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ ---- */
.woocommerce .u-columns,
.woocommerce .woocommerce-notices-wrapper,
.woocommerce h2 + form.woocommerce-form,
.woocommerce .u-columns h2 { display:none !important; }

/* –ò–Ω–æ–≥–¥–∞ —Ç–µ–º—ã –¥–æ–±–∞–≤–ª—è—é—Ç extra-–æ–±—ë—Ä—Ç–∫–∏ ‚Äî —Å—Ç—Ä–∞—Ö—É–µ–º—Å—è */
#customer_login, .woocommerce form.login, .woocommerce form.register { display:none !important; }

/* ---- –ù–∞—à –±–ª–æ–∫ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ my-account ---- */
.woocommerce .ar-glogin-wrap{
  width:100%;
  box-sizing:border-box;
  margin:30px 0;
  padding:40px 20px;
  border-radius:12px;
  background:#161616;
  color:#fff;
  text-align:center;
  box-shadow:0 6px 20px rgba(0,0,0,.35);
}

.woocommerce .ar-glogin-wrap .nsl-button.nsl-button-google {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;

  background: transparent !important;
  border: 2px solid #ffa033 !important;
  color: #ffa033 !important;
  border-radius: 999px;
  padding: .9rem 1.2rem;
  font-size: 16px;
  font-weight: 600;
  transition: all .25s ease-in-out;
}

/* –•–æ–≤–µ—Ä ‚Äî –∑–∞–ª–∏–≤–∞–µ–º –æ—Ä–∞–Ω–∂–µ–≤—ã–º */
.woocommerce .ar-glogin-wrap .nsl-button.nsl-button-google:hover {
  background: #ffa033 !important;
  color: #161616 !important;
}

/* –ö–Ω–æ–ø–∫–∞ NSL (Nextend Social Login) ‚Äì —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
.woocommerce .ar-glogin-wrap .nsl-button{
  border-radius:999px;
  padding:.9rem 1.2rem;
}

/* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Woo, –µ—Å–ª–∏ —Ç–µ–º–∞ –µ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç */
body.woocommerce-account .woocommerce{
  max-width:100% !important;
  padding:0 !important;
}

/* –ú—è–≥–∫–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
.ar-glogin-wrap h2{ font-size:28px; margin:0 0 10px; color:#fff; }
.ar-glogin-wrap p { font-size:16px; color:#d6d6d6; margin:0 0 18px; }

/* –°—Å—ã–ª–æ—á–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ ¬´–∫–ª–∞—Å—Å–∏–∫–∏¬ª */
.ar-glogin-toggle a{ color:#ffa033; text-decoration:underline; }
CSS;

			wp_register_style('ar-glogin-inline', false);
			wp_enqueue_style('ar-glogin-inline');
			wp_add_inline_style('ar-glogin-inline', $css);

			// JS –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ç–µ–º–∞ –≤—Å—ë-—Ç–∞–∫–∏ –≤—Ç—ã–∫–∞–µ—Ç —Ñ–æ—Ä–º—ã –≤ DOM –ø–æ–∑–∂–µ ‚Äî —É–¥–∞–ª–∏–º —É–∑–µ–ª.
			$js = <<<JS
document.addEventListener('DOMContentLoaded', function(){
  var kill = function(){
    var n = document.getElementById('customer_login');
    if(n && !/classic=1/.test(location.search)) n.remove();
  };
  kill();
  // –ü–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤—Å—Ç–∞–≤–∫–∏
  var mo = new MutationObserver(kill);
  mo.observe(document.body, {childList:true, subtree:true});
});
JS;
			wp_register_script('ar-glogin-inline', false, [], null, true);
			wp_enqueue_script('ar-glogin-inline');
			wp_add_inline_script('ar-glogin-inline', $js, 'after');
		}, 99);
	}
});

/** –í—ã–≤–æ–¥–∏—Ç –∫–∞—Ä—Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google */
function ar_myaccount_google_block(){
	$redirect = esc_url( home_url('/cont') ); // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ /cont
	$google_url = wp_login_url();
	$google_url = add_query_arg( array(
		'loginSocial' => 'google',
		'redirect'    => rawurlencode( $redirect ),
	), wp_login_url() );

	echo '
	<div class="ar-glogin-wrap">
		<h2>IntrƒÉ rapid cu Google</h2>
		<p>Nu este nevoie de parolƒÉ. Te conectezi √Æn siguran»õƒÉ cu contul tƒÉu Google.</p>

		<div class="ar-glogin-actions">
			<div class="nsl-container nsl-container-block" data-align="center">
				<div class="nsl-container-buttons">
					<a class="nsl-button nsl-button-default nsl-button-google"
					   href="'.esc_url($google_url).'"
					   rel="nofollow"
					   data-plugin="nsl"
					   data-action="connect"
					   data-provider="google"
					   data-popupwidth="600"
					   data-popupheight="600">
						<span class="nsl-button-label-container">Ob»õine acces prin <b>accountul tƒÉu Google</b></span>
					</a>
				</div>
			</div>
		</div>

		<p class="ar-glogin-toggle" style="margin-top:14px;font-size:13px;opacity:.9">
		Pentru a achizi»õiona o licen»õƒÉ, trebuie sƒÉ fii autentificat √Æn contul tƒÉu personal folosind Google Account.
ApasƒÉ pe butonul ‚ÄûIntrƒÉ rapid cu Google‚Äù din sec»õiunea Contul meu »ôi conecteazƒÉ-te √Æn siguran»õƒÉ.
			
		</p>
	</div>';
}

/**
 * My Account ‚Üí –≤—Å–µ–≥–¥–∞ –≤–µ—Å—Ç–∏ –Ω–∞ /cont/
 * - –ë–µ–∑ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
 * - –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ query (?nsl_bypass_cache=... –∏ —Ç.–ø.)
 * - –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –≤—Ö–æ–¥–µ (WP/Woo/Nextend) –∏ –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ –∫–æ—Ä–µ–Ω—å /my-account/
 * - –û–±—Ö–æ–¥–∏—Ç –∞–¥–º–∏–Ω–∫—É, AJAX, REST, –ª–æ–≥–∞—É—Ç –∏ lost-password
 */

if ( ! function_exists('ar_myacct_target_url') ) {
	function ar_myacct_target_url() : string {
		// –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã /cont
		return home_url('/cont');
	}
}
if ( ! function_exists('ar_myacct_root_path') ) {
	function ar_myacct_root_path() : string {
		// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Ç—å /cont
		return '/cont';
	}
}
if ( ! function_exists('ar_path_of') ) {
	function ar_path_of( $url ) : string {
		$p = wp_parse_url( $url, PHP_URL_PATH );
		return rtrim( $p ?: '/', '/' );
	}
}

/**
 * –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –∫–æ—Ä–Ω—è /my-account ‚Üí /cont
 * –î–µ–ª–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ template_redirect, –±–µ–∑ –∑–∞–≤—è–∑–∫–∏ –Ω–∞ is_account_page()
 */
add_action('template_redirect', function () {
	// –ù–µ —Ç—Ä–æ–≥–∞–µ–º –∞–¥–º–∏–Ω–∫—É/AJAX/REST/CLI
	if ( is_admin() || ( function_exists('wp_doing_ajax') && wp_doing_ajax() ) || defined('REST_REQUEST') || ( defined('WP_CLI') && WP_CLI ) ) return;

	// –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø—É—Å—Ç—å Woo –ø–æ–∫–∞–∂–µ—Ç –ª–æ–≥–∏–Ω
	if ( ! is_user_logged_in() ) return;

	// –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç: ?ar_skip_myacct_redirect=1
	if ( ! empty($_GET['ar_skip_myacct_redirect']) ) return;

	$current_path = ar_path_of( $_SERVER['REQUEST_URI'] ?? '/' );
	$root_path    = '/my-account'; // –°—Ç–∞—Ä—ã–π –ø—É—Ç—å, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º
	$target_path  = ar_path_of( ar_myacct_target_url() ); // "/cont"

	// –£–∂–µ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Üí –≤—ã—Ö–æ–¥–∏–º
	if ( $current_path === $target_path ) return;

	// –ù–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º —Å–ø–µ—Ü-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–∫–∫–∞—É–Ω—Ç–∞
	// (logout, lost-password –∏ —Ç.–ø.) ‚Äî –æ–Ω–∏ —á–∞—Å—Ç–æ –Ω–µ endpoint-—ã, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
	$uri = $_SERVER['REQUEST_URI'] ?? '';
	if ( stripos($uri, 'lost-password') !== false || stripos($uri, 'reset-password') !== false || stripos($uri, 'customer-logout') !== false ) {
		return;
	}

	// –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –º—ã —Ä–æ–≤–Ω–æ –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º /my-account (—Å –ª—é–±—ã–º–∏ query)
	if ( $current_path === $root_path ) {
		$to = ar_myacct_target_url();

		// –£–±–µ—Ä—ë–º "—Å–ª—É–∂–µ–±–Ω—ã–µ" –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç —Å–æ—Ü.–ª–æ–≥–∏–Ω–∞/–∫—ç—à–∞, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å —Ü–µ–ø–æ—á–∫–∏
		$strip = ['nsl_bypass_cache','_wpnonce','_wp_http_referer','redirect','redirect_to'];
		foreach ($strip as $q) { $to = remove_query_arg($q, $to); }

		if ( ! headers_sent() ) {
			wp_safe_redirect( $to, 303 ); // 303: "See Other" ‚Äî –±—Ä–∞—É–∑–µ—Ä—ã –æ—Ö–æ—Ç–Ω–µ–µ —É–≤–∞–∂–∞—é—Ç
			exit;
		}
	}
}, 8);

/**
 * –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –≤—Å–µ–≥–¥–∞ –≤ "/cont"
 * (–ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë: Woo, core WP –∏ Nextend Social Login).
 */
add_filter('woocommerce_login_redirect', function( $redirect, $user ) {
	return ar_myacct_target_url();
}, 999, 2);

add_filter('login_redirect', function( $redirect_to, $requested, $user ) {
	return ar_myacct_target_url();
}, 999, 3);

// Nextend Social Login: Google –∏ –¥—Ä.
add_filter('nsl_login_redirect', function( $redirect_to, $provider ) {
	return ar_myacct_target_url();
}, 999, 2);
add_filter('nsl_register_redirect', function( $redirect_to, $provider ) {
	return ar_myacct_target_url();
}, 999, 2);

/**
 * –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –¥–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
 * –ü–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /cont –≤–º–µ—Å—Ç–æ /my-account
 */
add_filter('woocommerce_logout_redirect', function($redirect) {
	return home_url('/cont');
}, 999);

add_filter('logout_redirect', function($redirect_to, $requested_redirect_to, $user) {
	return home_url('/cont');
}, 999, 3);

/**
 * –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Ä–∞–Ω–Ω–µ–º init: –µ—Å–ª–∏ –º—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∏ —Å—Ç–æ–∏–º –Ω–∞ /my-account —Å –∏—Ö query
 * (–Ω–∞–ø—Ä–∏–º–µ—Ä, ?nsl_bypass_cache=...), —É–≤–æ–¥–∏–º –Ω–∞ —Ü–µ–ª–µ–≤–æ–π URL –¥–æ –≤—ã–≤–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
 */
add_action('init', function () {
	if ( is_admin() || ( function_exists('wp_doing_ajax') && wp_doing_ajax() ) || defined('REST_REQUEST') ) return;
	if ( ! is_user_logged_in() ) return;

	$current_path = ar_path_of( $_SERVER['REQUEST_URI'] ?? '/' );
	$root_path    = '/my-account'; // –°—Ç–∞—Ä—ã–π –ø—É—Ç—å
	$target_path  = ar_path_of( ar_myacct_target_url() ); // "/cont"

	if ( $current_path === $root_path && $current_path !== $target_path ) {
		$to = ar_myacct_target_url();
		$to = remove_query_arg( ['nsl_bypass_cache','_wpnonce','_wp_http_referer','redirect','redirect_to'], $to );
		if ( ! headers_sent() ) {
			wp_safe_redirect( $to, 302 );
			exit;
		}
	}
}, 1);

/* ========== RENEW: endpoint /ar-renew/<reg>/<pid> ========== */
add_action('init', function () {
    add_rewrite_rule('^ar-renew/([^/]+)/([0-9]+)/?$', 'index.php?ar_renew_reg=$matches[1]&ar_renew_pid=$matches[2]', 'top');
});
add_filter('query_vars', function($vars){
    $vars[] = 'ar_renew_reg';
    $vars[] = 'ar_renew_pid';
    return $vars;
});

/* –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –∫–ª–∞–¥—ë–º —Ç–æ–≤–∞—Ä –∏ —É—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–∑–∏–Ω—É */
add_action('template_redirect', function () {
    $reg = get_query_var('ar_renew_reg');
    $pid = (int) get_query_var('ar_renew_pid');
    if (!$reg || !$pid) return;

    // –ø—Ä–æ–≤–µ—Ä–∏–º nonce (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω)
    $nonce_ok = true;
    if (isset($_GET['_arn'])) {
        $nonce_ok = wp_verify_nonce($_GET['_arn'], 'ar_renew_'.$reg);
    }

    if (!is_user_logged_in()) {
        wc_add_notice(__('Trebuie sƒÉ fii autentificat pentru a prelungi licen»õa.'), 'error');
        wp_safe_redirect( wc_get_page_permalink('myaccount') );
        exit;
    }
    if (!$nonce_ok) {
        wc_add_notice(__('Sesiunea a expirat. Te rugƒÉm sƒÉ re√Æncerci.'), 'error');
        wp_safe_redirect( wc_get_page_permalink('myaccount') );
        exit;
    }

    $product = wc_get_product($pid);
    if (!$product || !$product->is_purchasable()) {
        wc_add_notice(__('Produsul de prelungire este indisponibil.'), 'error');
        wp_safe_redirect( wc_get_page_permalink('shop') );
        exit;
    }

    // –¥–æ–±–∞–≤–ª—è–µ–º 1 —à—Ç —Å –º–µ—Ç–æ–π —Ä–µ–≥-–∫–æ–¥–∞
    $key = WC()->cart->add_to_cart($pid, 1, 0, [], ['ar_renew_reg_code' => sanitize_text_field($reg)]);
    if ($key) {
        wc_add_notice(__('Produsul de prelungire a fost adƒÉugat √Æn co»ô.'), 'success');
    } else {
        wc_add_notice(__('Nu s-a putut adƒÉuga √Æn co»ô.'), 'error');
    }

    wp_safe_redirect( wc_get_cart_url() );
    exit;
});







/**
 * WooCommerce: –¥–ª—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É.
 * –†–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ –∞—Ä—Ö–∏–≤–µ (–∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞), –∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞.
 */
add_filter('woocommerce_get_price_html',           'ar_wc_variable_min_price_only', 10, 2);
add_filter('woocommerce_variable_price_html',      'ar_wc_variable_min_price_only', 10, 2);
add_filter('woocommerce_variable_sale_price_html', 'ar_wc_variable_min_price_only', 10, 2);

function ar_wc_variable_min_price_only( $price_html, $product ) {
	if ( ! $product instanceof WC_Product ) return $price_html;

	if ( $product->is_type('variable') ) {
		// –¶–µ–Ω—ã —Å —É—á—ë—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–∫–∞–∑–∞ (–≤–∫–ª—é—á–∞—è –Ω–∞–ª–æ–≥–∏)
		$min_sale = $product->get_variation_price('min', true);               // –º–∏–Ω. –∞–∫—Ü–∏–æ–Ω–Ω–∞—è
		$min_reg  = $product->get_variation_regular_price('min', true);       // –º–∏–Ω. –æ–±—ã—á–Ω–∞—è

	

		if ( $product->is_on_sale() && $min_sale < $min_reg ) {
			$price_html = sprintf(
				'%s<del class="strike">%s</del> <ins class="highlight">%s</ins>',
				$prefix,
				wc_price( $min_reg ),
				wc_price( $min_sale )
			);
		} else {
			$price_html = $prefix . wc_price( $min_reg );
		}

		// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–º–µ—á–∞–µ–º –∫–ª–∞—Å—Å–æ–º, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å
		$price_html = '<span class="price ar-min-price">' . $price_html . '</span>';
	}

	return $price_html;
}





/**
 * =============== Terms (Blocks + Classic) ‚Äî RO only ===============
 * 1) Classic checkout: –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —á–µ–∫–±–æ–∫—Å–∞.
 * 2) Blocks: JS ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç—ã, —Å–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω—ã–π —á–µ–∫–±–æ–∫—Å –∏ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏.
 */

add_filter('woocommerce_get_terms_and_conditions_checkbox_text', function ($text) {
    $terms_url   = wc_get_page_permalink('terms');
    $label_text  = sprintf(
        'Accept <a href="%s" class="woocommerce-terms-and-conditions-link" target="_blank" rel="noopener">Termenii »ôi Condi»õiile</a> *',
        esc_url($terms_url ?: '#')
    );
    return $label_text;
}, 999);

/* –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ç–µ–º–∞/–ø–µ—Ä–µ–≤–æ–¥—ã –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–≤–æ—é —Å—Ç—Ä–æ–∫—É ‚Äî –ø–æ–¥–º–µ–Ω—è–µ–º RU/EN –Ω–∞ RO */
add_filter('gettext', function ($translated, $text, $domain) {
    if ($domain === 'woocommerce' || $domain === 'default' || $domain === 'woo-gutenberg-products-block' || $domain === 'messages') {
        $map = [
            // –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π
            'I have read and agree to the website terms and conditions' => 'Accept Termenii »ôi Condi»õiile *',
            // –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (RU/EN):
            '–Ø –ø—Ä–∏–Ω–∏–º–∞—é –ü—Ä–∞–≤–∏–ª–∞ –∏ —É—Å–ª–æ–≤–∏—è' => 'Accept Termenii »ôi Condi»õiile',
            'I accept the Terms and Conditions' => 'Accept Termenii »ôi Condi»õiile',
        ];
        if (isset($map[$text])) {
            return $map[$text];
        }
    }
    return $translated;
}, 999, 3);

/* Blocks: –Ω–∞–¥–ø–∏—Å—å —Å–≤–µ—Ä—Ö—É + —á–µ–∫–±–æ–∫—Å ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ RO, –±–µ–∑ –¥—É–±–ª–µ–π */
add_action('wp_enqueue_scripts', function () {
    if (!function_exists('is_checkout') || !is_checkout()) return;

    $terms_url   = wc_get_page_permalink('terms');
    $privacy_url = function_exists('get_privacy_policy_url') ? get_privacy_policy_url() : '';

    $top_text = sprintf(
        'DacƒÉ continui cumpƒÉrarea, e»ôti de acord cu <a href="%s" target="_blank" rel="noopener">Termeni »ôi condi»õii</a>%s',
        esc_url($terms_url ?: '#'),
        $privacy_url ? sprintf(' »ôi <a href="%s" target="_blank" rel="noopener">PoliticƒÉ de confiden»õialitate</a>', esc_url($privacy_url)) : ''
    );

    $label_text = sprintf(
        'Accept <a href="%s" target="_blank" rel="noopener">Termenii »ôi Condi»õiile</a> *',
        esc_url($terms_url ?: '#')
    );

    $top_js   = wp_json_encode($top_text);
    $label_js = wp_json_encode($label_text);

    $js = <<<JS
(function(){
  // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  if (window.__arTermsInit) return; 
  window.__arTermsInit = true;

  function applyTerms(){
    var box = document.querySelector('.wc-block-checkout__terms');
    if (!box) return;

    // 1) –í–µ—Ä—Ö–Ω–∏–π —Ç–µ–∫—Å—Ç (–æ–ø–∏—Å–∞–Ω–∏–µ)
    // –í —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Blocks —Ä–∞–∑–º–µ—Ç–∫–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è: –∏—â–µ–º –ª—é–±—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
    var info = box.querySelector('.wc-block-components-checkbox__label, .wc-block-checkout__terms-description, p, .wc-block-components-checkout-step__description');
    if (!info) {
      info = document.createElement('div');
      info.className = 'ar-terms-info';
      box.prepend(info);
    }
    info.innerHTML = {$top_js};

    // 2) –ï–¥–∏–Ω—ã–π —á–µ–∫–±–æ–∫—Å —Å–æ–≥–ª–∞—Å–∏—è (—É–¥–∞–ª—è–µ–º –≤—Å–µ —á—É–∂–∏–µ label/checkbox –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞)
    box.querySelectorAll('label:not(.ar-terms-label), .wc-block-components-checkbox:not(.ar-terms-label)').forEach(function(el){
      // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∏–Ω—Ñ–æ-—Å—Ç—Ä–æ–∫—É
      if (!el.closest('.ar-terms-info')) el.remove();
    });

    var label = box.querySelector('label.ar-terms-label');
    if (!label) {
      label = document.createElement('label');
      label.className = 'ar-terms-label';
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.gap = '10px';
      box.appendChild(label);
    }

    var cb = label.querySelector('input[type="checkbox"]');
    if (!cb) {
      cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.name = 'terms';
      cb.id = 'ar_terms_cb';
      cb.required = true;
      cb.style.margin = '0';
      label.prepend(cb);
    } else {
      cb.name = 'terms';
      cb.required = true;
    }

    var span = label.querySelector('span.ar-terms-text');
    if (!span) {
      span = document.createElement('span');
      span.className = 'ar-terms-text';
      label.appendChild(span);
    }
    span.innerHTML = {$label_js};
  }

  // –ü–µ—Ä–≤–∏—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
  applyTerms();

  // –ù–∞–¥–∑–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞–º–∏ React (Blocks)
  var mo = new MutationObserver(function(mutations){
    // –ù–µ–±–æ–ª—å—à–æ–π –¥–µ–±–∞—É–Ω—Å: Block —á–∞—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è –ø–∞—á–∫–∞–º–∏
    if (window.__arTermsTick) cancelAnimationFrame(window.__arTermsTick);
    window.__arTermsTick = requestAnimationFrame(applyTerms);
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // –ù–∞ —Å–ª—É—á–∞–π –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
  document.addEventListener('DOMContentLoaded', applyTerms);
})();
JS;

    wp_register_script('ar-terms-ro-blocks', false, [], null, true);
    wp_enqueue_script('ar-terms-ro-blocks');
    wp_add_inline_script('ar-terms-ro-blocks', $js);

    // –ú–∏–Ω–∏-—Å—Ç–∏–ª—å: —á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–∏ —á—É–∂–∏–µ –ª–µ–π–±–ª—ã –¥–æ –ø–æ–¥—á–∏—Å—Ç–∫–∏
    $css = '
    .wc-block-checkout__terms label:not(.ar-terms-label){display:none!important;}
    ';
    wp_register_style('ar-terms-ro-blocks-css', false, [], null);
    wp_enqueue_style('ar-terms-ro-blocks-css');
    wp_add_inline_style('ar-terms-ro-blocks-css', $css);
}, 99);




/**
 * –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ https://artrocket.ro/cont/
 * –†–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è Checkout Blocks: —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã "order-received".
 */
add_action('template_redirect', function () {
    if (!function_exists('is_order_received_page') || !is_order_received_page()) {
        return;
    }

    // –ù–∞ thank-you —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ—Å—Ç—å query_var 'order-received'
    $order_id = absint(get_query_var('order-received'));
    if ($order_id <= 0) return;

    $order = wc_get_order($order_id);
    if (!$order) return;

    // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–¥–∞—á–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ:
    // $ok = in_array($order->get_status(), ['processing','completed','on-hold'], true);
    // if (!$ok) return;

    // –ù–æ–≤—ã–π URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
    $redirect_url = 'https://art-rocket.ru/cont/';

    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∏—Å–∫–ª—é—á–∏–º ajax/json-–∑–∞–ø—Ä–æ—Å—ã
    if (wp_doing_ajax() || wp_is_json_request()) return;

    wp_safe_redirect($redirect_url);
    exit;
}, 1);

/**
 * –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
 * (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–º–∞ —á—Ç–æ-—Ç–æ –≤—ã–≤–µ–ª–∞ –¥–æ header), –¥–æ–±–∏–≤–∞–µ–º—Å—è JS'–æ–º.
 */
add_action('woocommerce_thankyou', function ($order_id) {
    if (!$order_id) return;
    
    $order = wc_get_order($order_id);
    if (!$order) return;

    $redirect_url = esc_url_raw('https://art-rocket.ru/cont/');
    echo '<script>location.replace(' . wp_json_encode($redirect_url) . ');</script>';
}, 1);

// –ù–∞ —á–µ–∫–∞—É—Ç–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏
add_filter('woocommerce_cart_needs_shipping', '__return_false');
add_filter('woocommerce_cart_needs_shipping_address', '__return_false');


/**
 * Telefon ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤ Checkout Blocks –∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —á–µ–∫–∞—É—Ç–µ.
 * –£–±–∏—Ä–∞–µ–º –ø–æ–º–µ—Ç–∫—É "(op»õional)" –∏ –º–µ–Ω—è–µ–º –ª–µ–π–±–ª –Ω–∞ "Telefon".
 */

/* 1) –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π checkout: –ø–æ–º–µ—á–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –∫–∞–∫ required */
add_filter('woocommerce_billing_fields', function ($fields) {
    if (isset($fields['billing_phone'])) {
        $fields['billing_phone']['required']    = true;
        $fields['billing_phone']['label']       = 'Telefon';
        $fields['billing_phone']['placeholder'] = 'Telefon';
        $fields['billing_phone']['priority']    = 80;
    }
    return $fields;
}, 999);

add_filter('woocommerce_checkout_fields', function ($fields) {
    if (isset($fields['billing']['billing_phone'])) {
        $fields['billing']['billing_phone']['required'] = true;
    }
    return $fields;
}, 999);

/* 2) –°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è Blocks */
add_action('woocommerce_after_checkout_validation', function ($data, $errors) {
    if (empty($data['billing_phone'])) {
        $errors->add('billing_phone_required', __('Introduce»õi numƒÉrul de telefon.', 'woocommerce'));
    }
}, 10, 2);

/* 3) Checkout Blocks: –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç "Telefon (op»õional)" –Ω–∞ "Telefon"
      (–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∞–Ω–≥–ª. –≤–∞—Ä–∏–∞–Ω—Ç—ã, –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –ø–æ–¥—Ç—è–Ω–µ—Ç—Å—è –∏–Ω–æ–π) */
add_filter('gettext', function ($translated, $text, $domain) {
    // –¥–æ–º–µ–Ω—ã —Å—Ç—Ä–æ–∫ –¥–ª—è Woo/Blocks
    if (in_array($domain, ['woocommerce', 'woo-gutenberg-products-block', 'messages'], true)) {
        $map = [
            'Telefon (op»õional)' => 'Telefon',
            'Telefon (optional)' => 'Telefon',
            'Phone (optional)'   => 'Telefon',
        ];
        if (isset($map[$text])) {
            return $map[$text];
        }
    }
    return $translated;
}, 999, 3);

/* 4) –ù–µ–º–Ω–æ–≥–æ CSS: —Å–∫—Ä—ã—Ç—å span.optional —É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤–µ–∑–¥–æ—á–∫—É */
add_action('wp_enqueue_scripts', function () {
    if (!function_exists('is_checkout') || !is_checkout()) return;

    $css = '
    /* —Å–∫—Ä—ã—Ç—å "(op»õional)" —É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ Blocks –∏ –≤ –∫–ª–∞—Å—Å–∏–∫–µ */
    label[for="billing-phone"] .optional,
    label[for="billing_phone"] .optional,
    .wc-block-components-address-form__phone label .optional { display:none !important; }

    /* –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±–æ–∑–Ω–∞—á–∏—Ç—å, —á—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ */
    label[for="billing-phone"]:after,
    label[for="billing_phone"]:after {
        content:" *";
        color:#ff6a00;
        font-weight:700;
    }';

    wp_register_style('ar-phone-required-inline', false, [], null);
    wp_enqueue_style('ar-phone-required-inline');
    wp_add_inline_style('ar-phone-required-inline', $css);
});



















/**
 * –ù–ê–ß–ê–õ–û –ü–û–õ–ò–¢–ò–ö–ò –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û–°–¢–ò
 */

// –î–æ–±–∞–≤–ª—è–µ–º –±–∞–Ω–Ω–µ—Ä —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ cookies –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å GDPR
function add_cookie_consent_banner() {
    if (!isset($_COOKIE['cookie_consent'])) {
        ?>
        <div id="cookie-consent-banner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #2c3e50; color: white; padding: 20px; z-index: 9999; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);">
    <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
        <div style="flex: 1; min-width: 300px;">
            <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª—ã cookie –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –æ–ø—ã—Ç–∞, –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ —Å–∞–π—Ç–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. 
                –ü—Ä–æ–¥–æ–ª–∂–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–∞–π—Ç, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤ cookie. 
                –£–∑–Ω–∞–π—Ç–µ –±–æ–ª—å—à–µ –≤ –Ω–∞—à–µ–π <a href="https://art-rocket.ru/privacy-policy" style="color: #3498db; text-decoration: underline;">–ü–æ–ª–∏—Ç–∏–∫–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.
            </p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="button" id="accept-all-cookies" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s;">
                –ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ
            </button>
            <button type="button" id="accept-necessary-cookies" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s;">
                –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ
            </button>
            <button type="button" id="open-cookie-settings" style="background: #34495e; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s;">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ cookies -->
<div id="cookie-settings-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: #333; padding: 30px; border-radius: 10px; z-index: 10000; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-width: 500px; width: 90%;">
    <h3 style="margin-top: 0; color: #2c3e50;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∞–π–ª–æ–≤ cookie</h3>
    
    <div style="margin-bottom: 20px;">
        <label style="display: block; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px; cursor: not-allowed; opacity: 0.7;">
            <input type="checkbox" id="necessary-cookies" checked disabled style="margin-right: 10px;">
            <strong>–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ cookies</strong>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">–≠—Ç–∏ —Ñ–∞–π–ª—ã cookie –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞ –∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω—ã.</p>
        </label>
        
        <label style="display: block; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; cursor: pointer;">
            <input type="checkbox" id="analytics-cookies" style="margin-right: 10px;">
            <strong>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ cookies</strong>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">–ü–æ–∑–≤–æ–ª—è—é—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.</p>
        </label>
        
        <label style="display: block; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; cursor: pointer;">
            <input type="checkbox" id="marketing-cookies" style="margin-right: 10px;">
            <strong>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ cookies</strong>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –∏ –ø–æ–∫–∞–∑–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã.</p>
        </label>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" id="save-cookie-settings" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
        <button type="button" id="close-cookie-settings" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            –û—Ç–º–µ–Ω–∞
        </button>
    </div>
</div>

        <div id="cookie-consent-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998;"></div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var banner = document.getElementById('cookie-consent-banner');
            var modal = document.getElementById('cookie-settings-modal');
            var overlay = document.getElementById('cookie-consent-overlay');
            
            // Show banner with delay
            setTimeout(function() {
                banner.style.display = 'block';
            }, 1000);
            
            // Accept all cookies
            document.getElementById('accept-all-cookies').addEventListener('click', function() {
                setCookie('cookie_consent', 'all', 365);
                setCookie('analytics_consent', 'true', 365);
                setCookie('marketing_consent', 'true', 365);
                banner.style.display = 'none';
                loadAcceptedScripts('all');
            });
            
            // Accept necessary only
            document.getElementById('accept-necessary-cookies').addEventListener('click', function() {
                setCookie('cookie_consent', 'necessary', 365);
                setCookie('analytics_consent', 'false', 365);
                setCookie('marketing_consent', 'false', 365);
                banner.style.display = 'none';
                loadAcceptedScripts('necessary');
            });
            
            // Open settings
            document.getElementById('open-cookie-settings').addEventListener('click', function() {
                modal.style.display = 'block';
                overlay.style.display = 'block';
            });
            
            // Close settings
            document.getElementById('close-cookie-settings').addEventListener('click', function() {
                modal.style.display = 'none';
                overlay.style.display = 'none';
            });
            
            // Save settings
            document.getElementById('save-cookie-settings').addEventListener('click', function() {
                var analyticsChecked = document.getElementById('analytics-cookies').checked;
                var marketingChecked = document.getElementById('marketing-cookies').checked;
                
                setCookie('cookie_consent', 'custom', 365);
                setCookie('analytics_consent', analyticsChecked ? 'true' : 'false', 365);
                setCookie('marketing_consent', marketingChecked ? 'true' : 'false', 365);
                
                banner.style.display = 'none';
                modal.style.display = 'none';
                overlay.style.display = 'none';
                
                loadAcceptedScripts('custom');
            });
            
            // Cookie setting function
            function setCookie(name, value, days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                var expires = "expires=" + date.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/;SameSite=Lax";
            }
            
            // Load scripts based on consent
            function loadAcceptedScripts(consentType) {
                if (consentType === 'all') {
                    loadAnalyticsScripts();
                    loadMarketingScripts();
                } else if (consentType === 'custom') {
                    var analyticsConsent = getCookie('analytics_consent');
                    var marketingConsent = getCookie('marketing_consent');
                    
                    if (analyticsConsent === 'true') loadAnalyticsScripts();
                    if (marketingConsent === 'true') loadMarketingScripts();
                }
                // For 'necessary' nothing additional is loaded
            }
            
            // Get cookie function
            function getCookie(name) {
                var nameEQ = name + "=";
                var ca = document.cookie.split(';');
                for(var i=0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0)==' ') c = c.substring(1,c.length);
                    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
                }
                return null;
            }
            
            // Load analytics scripts (replace with your actual scripts)
            function loadAnalyticsScripts() {
                console.log('Loading analytics scripts...');
                // Example: Google Analytics
                // window.dataLayer = window.dataLayer || [];
                // function gtag(){dataLayer.push(arguments);}
                // gtag('js', new Date());
                // gtag('config', 'GA_MEASUREMENT_ID');
                
                // Example: Google Analytics 4
                // (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                // new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                // j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                // 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                // })(window,document,'script','dataLayer','GTM-XXXXXXX');
            }
            
            // Load marketing scripts (replace with your actual scripts)
            function loadMarketingScripts() {
                console.log('Loading marketing scripts...');
                // Example: Facebook Pixel
                // !function(f,b,e,v,n,t,s)
                // {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                // n.callMethod.apply(n,arguments):n.queue.push(arguments)};
                // if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
                // n.queue=[];t=b.createElement(e);t.async=!0;
                // t.src=v;s=b.getElementsByTagName(e)[0];
                // s.parentNode.insertBefore(t,s)}(window, document,'script',
                // 'https://connect.facebook.net/en_US/fbevents.js');
                // fbq('init', 'FB_PIXEL_ID');
                // fbq('track', 'PageView');
            }
            
            // Check existing consent on page load
            var existingConsent = getCookie('cookie_consent');
            if (existingConsent) {
                loadAcceptedScripts(existingConsent);
            }
        });
        </script>
        <?php
    }
}
add_action('wp_footer', 'add_cookie_consent_banner');

// Add styles for the cookie banner
function add_cookie_consent_styles() {
    if (!isset($_COOKIE['cookie_consent'])) {
        ?>
        <style>
            #cookie-consent-banner button:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }
            #cookie-settings-modal label:hover {
                background: #f1f2f6;
            }
            #cookie-consent-banner a:hover {
                opacity: 0.8;
            }
            @media (max-width: 768px) {
                #cookie-consent-banner > div {
                    flex-direction: column;
                    text-align: center;
                }
                #cookie-consent-banner > div > div:first-child {
                    min-width: auto;
                    margin-bottom: 15px;
                }
            }
        </style>
        <?php
    }
}
add_action('wp_head', 'add_cookie_consent_styles');

 
 
 

// Conditional script loading based on cookie consent
function conditional_script_loading() {
    // Check analytics consent
    $analytics_consent = isset($_COOKIE['analytics_consent']) && $_COOKIE['analytics_consent'] === 'true';
    
    if (!$analytics_consent) {
        // Disable analytics scripts
        wp_deregister_script('google-analytics');
        remove_action('wp_head', 'google_analytics_tracking_code');
        // Add other analytics scripts to block
    }
    
    // Check marketing consent
    $marketing_consent = isset($_COOKIE['marketing_consent']) && $_COOKIE['marketing_consent'] === 'true';
    
    if (!$marketing_consent) {
        // Disable marketing scripts
        wp_deregister_script('facebook-pixel');
        remove_action('wp_head', 'facebook_pixel_code');
        // Add other marketing scripts to block
    }
}
add_action('wp_enqueue_scripts', 'conditional_script_loading', 9999);

// Shortcode for cookie acceptance button
function cookie_accept_shortcode() {
    return '<button onclick="acceptAllCookies()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0;">Accept Cookies</button>
    <script>
    function acceptAllCookies() {
        document.cookie = "cookie_consent=all; path=/; max-age=31536000; SameSite=Lax";
        document.cookie = "analytics_consent=true; path=/; max-age=31536000; SameSite=Lax";
        document.cookie = "marketing_consent=true; path=/; max-age=31536000; SameSite=Lax";
        location.reload();
    }
    </script>';
}
add_shortcode('cookie_accept', 'cookie_accept_shortcode');

// Add cookie consent check for AJAX requests
function check_cookie_consent_ajax() {
    ?>
    <script>
    function hasCookieConsent(type) {
        if (type === 'analytics') {
            return document.cookie.includes('analytics_consent=true');
        }
        if (type === 'marketing') {
            return document.cookie.includes('marketing_consent=true');
        }
        return document.cookie.includes('cookie_consent=');
    }
    </script>
    <?php
}
add_action('wp_head', 'check_cookie_consent_ajax');

 
 /**
 * PRIVACY POLICY END
 */
































/**
 * –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ WhatsApp (+40 750 750 004) —Å –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–π –∏–∫–æ–Ω–∫–æ–π Bootstrap Icons
 */

/* –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap Icons (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) */
add_action('wp_enqueue_scripts', function () {
    // –µ—Å–ª–∏ —É–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç–µ —É —Å–µ–±—è ‚Äî —ç—Ç—É —Å—Ç—Ä–æ–∫—É –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å
    wp_enqueue_style(
        'bootstrap-icons',
        'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css',
        [],
        '1.11.3'
    );
});

/* –†–∏—Å—É–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ñ—É—Ç–µ—Ä–µ */
// –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É WhatsApp –≤ —Ñ—É—Ç–µ—Ä
add_action('wp_footer', function () {
  if (is_admin() || wp_doing_ajax()) return;

  $phone_display = '+40 750 750 004';
  $phone_wa      = preg_replace('/\D+/', '', $phone_display);
  $site_name     = get_bloginfo('name');
  $current_url   = home_url(add_query_arg([], $_SERVER['REQUEST_URI']));

  $base = 'https://wa.me/' . $phone_wa . '?text=';

  $buttons = [
    'üìò –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é' => "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω(–∞) –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏.",
    'üí∞ –£–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã' => "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—Ç–µ–ª(–∞) –±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ü–µ–Ω–∞—Ö.",
    '‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å' => "–ü—Ä–∏–≤–µ—Ç! –£ –º–µ–Ω—è –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º.",
  ];
  ?>

  <div class="ar-wa-panel">
    <div class="ar-wa-toggle" onmouseenter="showTooltip()" onclick="toggleWAButtons()">
      <span class="ar-wa-tooltip" id="wa-tooltip">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</span>
      <i class="bi bi-whatsapp"></i>
    </div>

    <div class="ar-wa-buttons">
      <?php foreach ($buttons as $label => $msg): ?>
        <a href="<?= esc_url($base . rawurlencode($msg)) ?>"
           target="_blank"
           class="ar-wa-btn"
           rel="noopener">
          <?= esc_html($label) ?>
        </a>
      <?php endforeach; ?>
    </div>
  </div>

  <style>
    .ar-wa-panel {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }

    .ar-wa-toggle {
      position: relative;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #25D366;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      transition: background 0.3s ease;
    }

    .ar-wa-toggle:hover {
      background-color: #22c35e;
    }

    .ar-wa-toggle i {
      color: #fff;
      font-size: 28px;
    }

    .ar-wa-tooltip {
      position: absolute;
      top: -14px;
      left: -120px; /* —Å–¥–≤–∏–≥ –≤–ª–µ–≤–æ */
      background: #111;
      color: #fff;
      font: 600 12px 'Montserrat', sans-serif;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
    }

    .ar-wa-toggle:hover .ar-wa-tooltip,
    .ar-wa-tooltip.active {
      opacity: 1;
    }

    .ar-wa-buttons {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .ar-wa-panel.open .ar-wa-buttons {
      display: flex;
    }

    .ar-wa-btn {
      background: #25D366;
      color: #fff;
      padding: 10px 16px;
      border-radius: 28px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      white-space: nowrap;
      transition: background 0.2s ease;
    }

    .ar-wa-btn:hover {
      background: #1da851;
    }

    @media (max-width: 768px) {
      .ar-wa-panel {
        right: 16px;
        bottom: 16px;
      }

      .ar-wa-toggle {
        width: 54px;
        height: 54px;
      }

      .ar-wa-btn {
        font-size: 13px;
        padding: 10px 14px;
      }

      .ar-wa-tooltip {
        display: none; /* tooltip –Ω–µ –Ω—É–∂–µ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      }
    }
  </style>

  <script>
    function toggleWAButtons() {
      document.querySelector('.ar-wa-panel').classList.toggle('open');
    }

    function showTooltip() {
      const tooltip = document.getElementById('wa-tooltip');
      tooltip.classList.add('active');
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      const tooltip = document.getElementById('wa-tooltip');
      if (tooltip) tooltip.classList.add('active');

      // –£–±–∏—Ä–∞–µ–º tooltip —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–≤—ë–ª)
      setTimeout(() => {
        if (tooltip && !tooltip.matches(':hover')) {
          tooltip.classList.remove('active');
        }
      }, 10000);
    }, 5000);
  </script>
  
  


<?php });
?>
